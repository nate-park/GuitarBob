/*!
 * alphaTab v1.8.1 (, build 30)
 *
 * Copyright © 2026, Daniel Kuschny and Contributors, All rights reserved.
 *
 * This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at http://mozilla.org/MPL/2.0/.
 *
 * Integrated Libraries:
 *
 * Library: TinySoundFont
 * License: MIT
 * Copyright: Copyright (C) 2017, 2018 Bernhard Schelling
 * URL: https://github.com/schellingb/TinySoundFont
 * Purpose: SoundFont loading and Audio Synthesis
 *
 * Library: SFZero
 * License: MIT
 * Copyright: Copyright (C) 2012 Steve Folta ()
 * URL: https://github.com/stevefolta/SFZero
 * Purpose: TinySoundFont is based on SFZEro
 *
 * Library: Haxe Standard Library
 * License: MIT
 * Copyright: Copyright (C)2005-2025 Haxe Foundation
 * URL: https://github.com/HaxeFoundation/haxe/tree/development/std
 * Purpose: XML Parser & Zip Inflate Algorithm
 *
 * Library: SharpZipLib
 * License: MIT
 * Copyright: Copyright © 2000-2018 SharpZipLib Contributors
 * URL: https://github.com/icsharpcode/SharpZipLib
 * Purpose: Zip Deflate Algorithm for writing compressed Zips
 *
 * Library: NVorbis
 * License: MIT
 * Copyright: Copyright (c) 2020 Andrew Ward
 * URL: https://github.com/NVorbis/NVorbis
 * Purpose: Vorbis Stream Decoding
 *
 * Library: libvorbis
 * License: BSD-3-Clause
 * Copyright: Copyright (c) 2002-2020 Xiph.org Foundation
 * URL: https://github.com/xiph/vorbis
 * Purpose: NVorbis adopted some code from libvorbis.
 *
 * @preserve
 * @license
 */
class t{t;i=new Set;constructor(t){this.t=t,window.addEventListener("resize",this.o.bind(this),!1)}observe(t){this.i.add(t)}unobserve(t){this.i.delete(t)}disconnect(){this.i.clear()}o(){const t=[];for(const e of this.i)t.push({target:e,contentRect:void 0,borderBoxSize:void 0,contentBoxSize:[],devicePixelContentBoxSize:[]});this.t(t,this)}}class e{t;l=[];u=null;constructor(t){this.t=t,window.addEventListener("resize",()=>this.p,!0),document.addEventListener("scroll",()=>this.p,!0)}p(){this.u||(this.u=setTimeout(()=>{this.m(),this.u=null},100))}observe(t){this.l.indexOf(t)>=0||(this.l.push(t),this.p())}unobserve(t){this.l=this.l.filter(e=>e!==t)}m(){const t=[];for(const e of this.l){const s=e.getBoundingClientRect();s.top+s.height>=0&&s.top<=window.innerHeight&&s.left+s.width>=0&&s.left<=window.innerWidth&&t.push({target:e,isIntersecting:!0})}t.length&&this.t(t,this)}}var s,i,n,r,a,h,o,c,l,u,d,f,p,b,m,g,w,y,k,S,B,_,T,x,M,v,N,P,C,E,F,A,D,L,W,O,R;void 0===Symbol.dispose&&(Symbol.dispose=Symbol("Symbol.dispose")),"undefined"!=typeof window&&("ResizeObserver"in globalThis||(globalThis.ResizeObserver=t),"IntersectionObserver"in globalThis||(globalThis.IntersectionObserver=e),"replaceChildren"in Element.prototype||(Element.prototype.replaceChildren=function(...t){this.innerHTML="",this.append(...t)},Document.prototype.replaceChildren=Element.prototype.replaceChildren,DocumentFragment.prototype.replaceChildren=Element.prototype.replaceChildren)),"replaceAll"in String.prototype||(String.prototype.replaceAll=function(t,e){return this.replace(new RegExp(t,"g"),e)}),function(t){t[t.General=0]="General",t[t.Format=1]="Format",t[t.AlphaTex=2]="AlphaTex"}(s||(s={}));class I extends Error{type;constructor(t,e="",s){super(e??"",{cause:s}),this.type=t}}class G{static version="1.8.1";static date="2026-02-01T19:53:46.853Z";static commit="8a2102fe7ee7dcf4b50c3a4198fbb8c0d5c0fda3";static print(t){t(`alphaTab ${G.version}`),t(`commit: ${G.commit}`),t(`build date: ${G.date}`)}}!function(t){t[t.PPP=0]="PPP",t[t.PP=1]="PP",t[t.P=2]="P",t[t.MP=3]="MP",t[t.MF=4]="MF",t[t.F=5]="F",t[t.FF=6]="FF",t[t.FFF=7]="FFF",t[t.PPPP=8]="PPPP",t[t.PPPPP=9]="PPPPP",t[t.PPPPPP=10]="PPPPPP",t[t.FFFF=11]="FFFF",t[t.FFFFF=12]="FFFFF",t[t.FFFFFF=13]="FFFFFF",t[t.SF=14]="SF",t[t.SFP=15]="SFP",t[t.SFPP=16]="SFPP",t[t.FP=17]="FP",t[t.RF=18]="RF",t[t.RFZ=19]="RFZ",t[t.SFZ=20]="SFZ",t[t.SFFZ=21]="SFFZ",t[t.FZ=22]="FZ",t[t.N=23]="N",t[t.PF=24]="PF",t[t.SFZP=25]="SFZP"}(i||(i={}));class H{static QuarterTime=960;static k=15;static VelocityIncrement=16;static ticksToMillis(t,e){return t*(6e4/(e*H.QuarterTime))|0}static millisToTicks(t,e){return t/(6e4/(e*H.QuarterTime))|0}static toTicks(t){return H.valueToTicks(t)}static valueToTicks(t){let e=t;return e<0&&(e=1/-e),H.QuarterTime*(4/e)|0}static applyDot(t,e){return e?t+3*(t/4|0):t+(t/2|0)}static applyTuplet(t,e,s){return t*s/e|0}static removeTuplet(t,e,s){return t*e/s|0}static dynamicToVelocity(t,e=0){let s=1;switch(t){case i.PPP:s=H.k+0*H.VelocityIncrement;break;case i.PP:s=H.k+1*H.VelocityIncrement;break;case i.P:s=H.k+2*H.VelocityIncrement;break;case i.MP:s=H.k+3*H.VelocityIncrement;break;case i.MF:s=H.k+4*H.VelocityIncrement;break;case i.F:s=H.k+5*H.VelocityIncrement;break;case i.FF:s=H.k+6*H.VelocityIncrement;break;case i.FFF:s=H.k+7*H.VelocityIncrement;break;case i.PPPP:s=10;break;case i.PPPPP:s=5;break;case i.PPPPPP:s=3;break;case i.FFFF:s=H.k+8*H.VelocityIncrement;break;case i.FFFFF:s=H.k+9*H.VelocityIncrement;break;case i.FFFFFF:s=H.k+10*H.VelocityIncrement;break;case i.SF:case i.SFP:case i.SFZP:case i.SFPP:case i.SFZ:case i.FZ:s=H.k+6*H.VelocityIncrement;break;case i.FP:case i.RF:case i.RFZ:case i.SFFZ:s=H.k+5*H.VelocityIncrement;break;case i.N:s=1;break;case i.PF:s=H.k+(4.5*H.VelocityIncrement|0)}return s+=e*H.VelocityIncrement,Math.min(Math.max(s,1),127)}}!function(t){t[t.Tempo=0]="Tempo",t[t.Volume=1]="Volume",t[t.Instrument=2]="Instrument",t[t.Balance=3]="Balance",t[t.SyncPoint=4]="SyncPoint",t[t.Bank=4]="Bank"}(n||(n={}));class V{barOccurence=0;millisecondOffset=0}class ${isLinear=!1;type=n.Tempo;value=0;syncPointValue;ratioPosition=0;text="";isVisible=!0;static buildTempoAutomation(t,e,s,i,r=!0){(i<1||i>5)&&(i=2);const a=new Float32Array([1,.5,1,1.5,2,3]),h=new $;return h.type=n.Tempo,h.isLinear=t,h.ratioPosition=e,h.value=s*a[i],h.isVisible=r,h}static buildInstrumentAutomation(t,e,s){const i=new $;return i.type=n.Instrument,i.isLinear=t,i.ratioPosition=e,i.value=s,i}}class U{static MaxPosition=60;static MaxValue=12;offset;value;constructor(t=0,e=0){this.offset=t,this.value=e}}!function(t){t[t.Default=0]="Default",t[t.Gradual=1]="Gradual",t[t.Fast=2]="Fast"}(r||(r={})),function(t){t[t.None=0]="None",t[t.Custom=1]="Custom",t[t.Bend=2]="Bend",t[t.Release=3]="Release",t[t.BendRelease=4]="BendRelease",t[t.Hold=5]="Hold",t[t.Prebend=6]="Prebend",t[t.PrebendBend=7]="PrebendBend",t[t.PrebendRelease=8]="PrebendRelease"}(a||(a={})),function(t){t[t.None=0]="None",t[t.BrushUp=1]="BrushUp",t[t.BrushDown=2]="BrushDown",t[t.ArpeggioUp=3]="ArpeggioUp",t[t.ArpeggioDown=4]="ArpeggioDown"}(h||(h={})),function(t){t[t.None=0]="None",t[t.Crescendo=1]="Crescendo",t[t.Decrescendo=2]="Decrescendo"}(o||(o={})),function(t){t[t.QuadrupleWhole=-4]="QuadrupleWhole",t[t.DoubleWhole=-2]="DoubleWhole",t[t.Whole=1]="Whole",t[t.Half=2]="Half",t[t.Quarter=4]="Quarter",t[t.Eighth=8]="Eighth",t[t.Sixteenth=16]="Sixteenth",t[t.ThirtySecond=32]="ThirtySecond",t[t.SixtyFourth=64]="SixtyFourth",t[t.OneHundredTwentyEighth=128]="OneHundredTwentyEighth",t[t.TwoHundredFiftySixth=256]="TwoHundredFiftySixth"}(c||(c={})),function(t){t[t.None=0]="None",t[t.OnBeat=1]="OnBeat",t[t.BeforeBeat=2]="BeforeBeat",t[t.BendGrace=3]="BendGrace"}(l||(l={})),function(t){t[t.None=0]="None",t[t.Normal=1]="Normal",t[t.Heavy=2]="Heavy",t[t.Tenuto=3]="Tenuto"}(u||(u={})),function(t){t[t.Unknown=-2]="Unknown",t[t.NoOrDead=-1]="NoOrDead",t[t.Thumb=0]="Thumb",t[t.IndexFinger=1]="IndexFinger",t[t.MiddleFinger=2]="MiddleFinger",t[t.AnnularFinger=3]="AnnularFinger",t[t.LittleFinger=4]="LittleFinger"}(d||(d={})),function(t){t[t.None=0]="None",t[t.Natural=1]="Natural",t[t.Artificial=2]="Artificial",t[t.Pinch=3]="Pinch",t[t.Tap=4]="Tap",t[t.Semi=5]="Semi",t[t.Feedback=6]="Feedback"}(f||(f={})),function(t){t[t.Default=0]="Default",t[t.ForceNone=1]="ForceNone",t[t.ForceNatural=2]="ForceNatural",t[t.ForceSharp=3]="ForceSharp",t[t.ForceDoubleSharp=4]="ForceDoubleSharp",t[t.ForceFlat=5]="ForceFlat",t[t.ForceDoubleFlat=6]="ForceDoubleFlat"}(p||(p={})),function(t){t[t.S=0]="_15ma",t[t._=1]="_8va",t[t.Regular=2]="Regular",t[t.T=3]="_8vb",t[t.M=4]="_15mb"}(b||(b={})),function(t){t[t.None=0]="None",t[t.IntoFromBelow=1]="IntoFromBelow",t[t.IntoFromAbove=2]="IntoFromAbove"}(m||(m={})),function(t){t[t.None=0]="None",t[t.Shift=1]="Shift",t[t.Legato=2]="Legato",t[t.OutUp=3]="OutUp",t[t.OutDown=4]="OutDown",t[t.PickSlideDown=5]="PickSlideDown",t[t.PickSlideUp=6]="PickSlideUp"}(g||(g={})),function(t){t[t.None=0]="None",t[t.Slight=1]="Slight",t[t.Wide=2]="Wide"}(w||(w={})),function(t){t[t.Hidden=0]="Hidden",t[t.ShowWithBeams=1]="ShowWithBeams",t[t.ShowWithBars=2]="ShowWithBars",t[t.Automatic=3]="Automatic"}(y||(y={})),function(t){t[t.ScoreDefault=0]="ScoreDefault",t[t.ScoreForcePiano=1]="ScoreForcePiano",t[t.SingleNoteEffectBand=2]="SingleNoteEffectBand",t[t.SingleNoteEffectBandForcePiano=3]="SingleNoteEffectBandForcePiano"}(k||(k={})),function(t){t[t.GuitarPro=0]="GuitarPro",t[t.SongBook=1]="SongBook"}(S||(S={})),function(t){t[t.ScoreTitle=0]="ScoreTitle",t[t.ScoreSubTitle=1]="ScoreSubTitle",t[t.ScoreArtist=2]="ScoreArtist",t[t.ScoreAlbum=3]="ScoreAlbum",t[t.ScoreWords=4]="ScoreWords",t[t.ScoreMusic=5]="ScoreMusic",t[t.ScoreWordsAndMusic=6]="ScoreWordsAndMusic",t[t.ScoreCopyright=7]="ScoreCopyright",t[t.GuitarTuning=8]="GuitarTuning",t[t.TrackNames=9]="TrackNames",t[t.ChordDiagrams=10]="ChordDiagrams",t[t.ParenthesisOnTiedBends=11]="ParenthesisOnTiedBends",t[t.TabNotesOnTiedBends=12]="TabNotesOnTiedBends",t[t.ZerosOnDiveWhammys=13]="ZerosOnDiveWhammys",t[t.EffectAlternateEndings=14]="EffectAlternateEndings",t[t.EffectCapo=15]="EffectCapo",t[t.EffectChordNames=16]="EffectChordNames",t[t.EffectCrescendo=17]="EffectCrescendo",t[t.EffectDynamics=18]="EffectDynamics",t[t.EffectFadeIn=19]="EffectFadeIn",t[t.EffectFermata=20]="EffectFermata",t[t.EffectFingering=21]="EffectFingering",t[t.EffectHarmonics=22]="EffectHarmonics",t[t.EffectLetRing=23]="EffectLetRing",t[t.EffectLyrics=24]="EffectLyrics",t[t.EffectMarker=25]="EffectMarker",t[t.EffectOttavia=26]="EffectOttavia",t[t.EffectPalmMute=27]="EffectPalmMute",t[t.EffectPickSlide=28]="EffectPickSlide",t[t.EffectPickStroke=29]="EffectPickStroke",t[t.EffectSlightBeatVibrato=30]="EffectSlightBeatVibrato",t[t.EffectSlightNoteVibrato=31]="EffectSlightNoteVibrato",t[t.EffectTap=32]="EffectTap",t[t.EffectTempo=33]="EffectTempo",t[t.EffectText=34]="EffectText",t[t.EffectTrill=35]="EffectTrill",t[t.EffectTripletFeel=36]="EffectTripletFeel",t[t.EffectWhammyBar=37]="EffectWhammyBar",t[t.EffectWideBeatVibrato=38]="EffectWideBeatVibrato",t[t.EffectWideNoteVibrato=39]="EffectWideNoteVibrato",t[t.EffectLeftHandTap=40]="EffectLeftHandTap",t[t.EffectFreeTime=41]="EffectFreeTime",t[t.EffectSustainPedal=42]="EffectSustainPedal",t[t.EffectGolpe=43]="EffectGolpe",t[t.EffectWahPedal=44]="EffectWahPedal",t[t.EffectBeatBarre=45]="EffectBeatBarre",t[t.EffectNoteOrnament=46]="EffectNoteOrnament",t[t.EffectRasgueado=47]="EffectRasgueado",t[t.EffectDirections=48]="EffectDirections",t[t.EffectBeatTimer=49]="EffectBeatTimer",t[t.EffectWhammyBarLine=50]="EffectWhammyBarLine",t[t.EffectNumberedNotationKeySignature=51]="EffectNumberedNotationKeySignature",t[t.ChordDiagramFretboardNumbers=52]="ChordDiagramFretboardNumbers",t[t.BarNumber=53]="BarNumber",t[t.RepeatCount=54]="RepeatCount",t[t.ScoreBendSlur=55]="ScoreBendSlur"}(B||(B={}));class z{notationMode=S.GuitarPro;fingeringMode=k.ScoreDefault;elements=new Map;static defaultElements=new Map([[B.ZerosOnDiveWhammys,!1]]);rhythmMode=y.Automatic;rhythmHeight=25;transpositionPitches=[];displayTranspositionPitches=[];smallGraceTabNotes=!0;extendBendArrowsOnTiedNotes=!0;extendLineEffectsToBeatEnd=!1;slurHeight=5;isNotationElementVisible(t){return this.elements.has(t)?this.elements.get(t):!z.defaultElements.has(t)||z.defaultElements.get(t)}}class X{v;L=void 0;get hasValue(){return void 0!==this.L}constructor(t){this.v=t}get value(){return void 0===this.L&&(this.L=this.v()),this.L}reset(){this.L=void 0}}!function(t){t[t.None=0]="None",t[t.Debug=1]="Debug",t[t.Info=2]="Info",t[t.Warning=3]="Warning",t[t.Error=4]="Error"}(_||(_={}));class j{static logLevel=_.Info;static W(t,e){return`[AlphaTab][${t}] ${e}`}debug(t,e,...s){console.debug(j.W(t,e),...s)}warning(t,e,...s){console.warn(j.W(t,e),...s)}info(t,e,...s){console.info(j.W(t,e),...s)}error(t,e,...s){console.error(j.W(t,e),...s)}}class J{static logLevel=_.Info;static log=new j;static O(t){return J.logLevel!==_.None&&t>=J.logLevel}static debug(t,e,...s){J.O(_.Debug)&&J.log.debug(t,e,...s)}static warning(t,e,...s){J.O(_.Warning)&&J.log.warning(t,e,...s)}static info(t,e,...s){J.O(_.Info)&&J.log.info(t,e,...s)}static error(t,e,...s){J.O(_.Error)&&J.log.error(t,e,...s)}}!function(t){t[t.None=0]="None",t[t.Natural=1]="Natural",t[t.Sharp=2]="Sharp",t[t.Flat=3]="Flat",t[t.NaturalQuarterNoteUp=4]="NaturalQuarterNoteUp",t[t.SharpQuarterNoteUp=5]="SharpQuarterNoteUp",t[t.FlatQuarterNoteUp=6]="FlatQuarterNoteUp",t[t.DoubleSharp=7]="DoubleSharp",t[t.DoubleFlat=8]="DoubleFlat"}(T||(T={})),function(t){t[t.Neutral=0]="Neutral",t[t.C3=1]="C3",t[t.C4=2]="C4",t[t.F4=3]="F4",t[t.G2=4]="G2"}(x||(x={})),function(t){t[t.None=0]="None",t[t.Simple=1]="Simple",t[t.FirstOfDouble=2]="FirstOfDouble",t[t.SecondOfDouble=3]="SecondOfDouble"}(M||(M={}));class q{colors=new Map}!function(t){t[t.Cb=-7]="Cb",t[t.Gb=-6]="Gb",t[t.Db=-5]="Db",t[t.Ab=-4]="Ab",t[t.Eb=-3]="Eb",t[t.Bb=-2]="Bb",t[t.F=-1]="F",t[t.C=0]="C",t[t.G=1]="G",t[t.D=2]="D",t[t.A=3]="A",t[t.E=4]="E",t[t.B=5]="B",t[t.FSharp=6]="FSharp",t[t.CSharp=7]="CSharp"}(v||(v={})),function(t){t[t.Major=0]="Major",t[t.Minor=1]="Minor"}(N||(N={})),function(t){t[t.Down=0]="Down",t[t.Hold=1]="Hold",t[t.Up=2]="Up"}(P||(P={}));class Y{ratioPosition=0;pedalType=P.Down;bar;nextPedalMarker=null;previousPedalMarker=null}!function(t){t[t.StandardNotationRepeats=0]="StandardNotationRepeats",t[t.GuitarTabsRepeats=1]="GuitarTabsRepeats",t[t.SlashRepeats=2]="SlashRepeats",t[t.NumberedRepeats=3]="NumberedRepeats",t[t.StandardNotationBarNumber=4]="StandardNotationBarNumber",t[t.GuitarTabsBarNumber=5]="GuitarTabsBarNumber",t[t.SlashBarNumber=6]="SlashBarNumber",t[t.NumberedBarNumber=7]="NumberedBarNumber",t[t.StandardNotationBarLines=8]="StandardNotationBarLines",t[t.GuitarTabsBarLines=9]="GuitarTabsBarLines",t[t.SlashBarLines=10]="SlashBarLines",t[t.NumberedBarLines=11]="NumberedBarLines",t[t.StandardNotationClef=12]="StandardNotationClef",t[t.GuitarTabsClef=13]="GuitarTabsClef",t[t.StandardNotationKeySignature=14]="StandardNotationKeySignature",t[t.NumberedKeySignature=15]="NumberedKeySignature",t[t.StandardNotationTimeSignature=16]="StandardNotationTimeSignature",t[t.GuitarTabsTimeSignature=17]="GuitarTabsTimeSignature",t[t.SlashTimeSignature=18]="SlashTimeSignature",t[t.NumberedTimeSignature=19]="NumberedTimeSignature",t[t.StandardNotationStaffLine=20]="StandardNotationStaffLine",t[t.GuitarTabsStaffLine=21]="GuitarTabsStaffLine",t[t.SlashStaffLine=22]="SlashStaffLine",t[t.NumberedStaffLine=23]="NumberedStaffLine"}(C||(C={}));class K extends q{}!function(t){t[t.Automatic=0]="Automatic",t[t.Dashed=1]="Dashed",t[t.Dotted=2]="Dotted",t[t.Heavy=3]="Heavy",t[t.HeavyHeavy=4]="HeavyHeavy",t[t.HeavyLight=5]="HeavyLight",t[t.LightHeavy=6]="LightHeavy",t[t.LightLight=7]="LightLight",t[t.None=8]="None",t[t.Regular=9]="Regular",t[t.Short=10]="Short",t[t.Tick=11]="Tick"}(E||(E={}));class Q{static R=0;static resetIds(){Q.R=0}id=Q.R++;index=0;nextBar=null;previousBar=null;clef=x.G2;clefOttava=b.Regular;staff;voices=[];simileMark=M.None;I=new Set([0]);get isMultiVoice(){return this.I.size>1}get filledVoices(){return this.I}displayScale=1;displayWidth=-1;sustainPedals=[];get masterBar(){return this.staff.track.score.masterBars[this.index]}H=!0;V=!0;get isEmpty(){return this.H}get hasChanges(){if(0===this.index)return!0;return!(this.keySignature===this.previousBar.keySignature&&this.keySignatureType===this.previousBar.keySignatureType&&this.clef===this.previousBar.clef&&this.clefOttava===this.previousBar.clefOttava)||(this.simileMark!==M.None||this.sustainPedals.length>0||this.barLineLeft!==E.Automatic||this.barLineRight!==E.Automatic)}get isRestOnly(){return this.V}barLineLeft=E.Automatic;barLineRight=E.Automatic;keySignature=v.C;keySignatureType=N.Major;barNumberDisplay;shortestDuration=c.DoubleWhole;getActualBarLineLeft(t){return Q.$(this,!1,t)}getActualBarLineRight(){return Q.$(this,!0,!1)}static U(t,e,s){let i;return i=e?t.isRepeatEnd?E.LightHeavy:t.nextMasterBar?t.isFreeTime?E.Dashed:t.isDoubleBar?E.LightLight:E.Regular:E.LightHeavy:t.isRepeatStart?E.HeavyLight:s?E.Regular:E.None,i}static $(t,e,s){const i=t.masterBar,n=e?t.barLineRight:t.barLineLeft;let r;return r=n===E.Automatic?Q.U(i,e,s):n,r}style;addVoice(t){t.bar=this,t.index=this.voices.length,this.voices.push(t)}finish(t,e=null){this.I.clear(),this.I.add(0),this.H=!0,this.V=!0,this.shortestDuration=c.DoubleWhole;for(let s=0,i=this.voices.length;s<i;s++){const i=this.voices[s];i.finish(t,e),i.isEmpty||(this.H=!1,this.I.add(s),i.shortestDuration>this.shortestDuration&&(this.shortestDuration=i.shortestDuration)),i.isRestOnly||(this.V=!1)}const s=this.sustainPedals;if(s.length>0){let t=null;this.sustainPedals=[],this.previousBar&&this.previousBar.sustainPedals.length>0&&(t=this.previousBar.sustainPedals[this.previousBar.sustainPedals.length-1],t.pedalType===P.Up&&(t=null));const e=null!==t&&t.pedalType!==P.Up;for(const i of s){if(t&&t.pedalType!==P.Up){if(t.bar===this&&i.ratioPosition<=t.ratioPosition)continue;t.nextPedalMarker=i,i.previousPedalMarker=t}e&&i.pedalType===P.Down&&(i.pedalType=P.Hold),i.bar=this,this.sustainPedals.push(i),t=i}}else if(this.previousBar&&this.previousBar.sustainPedals.length>0){const t=this.previousBar.sustainPedals[this.previousBar.sustainPedals.length-1];if(t.pedalType!==P.Up){const e=new Y;e.ratioPosition=0,e.bar=this,e.pedalType=P.Hold,this.sustainPedals.push(e),t.nextPedalMarker=e,e.previousPedalMarker=t}}}calculateDuration(){let t=0;for(const e of this.voices){const s=e.calculateDuration();s>t&&(t=s)}return t}}!function(t){t[t.NoTripletFeel=0]="NoTripletFeel",t[t.Triplet16th=1]="Triplet16th",t[t.Triplet8th=2]="Triplet8th",t[t.Dotted16th=3]="Dotted16th",t[t.Dotted8th=4]="Dotted8th",t[t.Scottish16th=5]="Scottish16th",t[t.Scottish8th=6]="Scottish8th"}(F||(F={}));class Z{X;groups=new Map;uniqueId="";timeSignatureNumerator=0;timeSignatureDenominator=0;static createSimple(t,e,s,i){const n=new Z;return n.timeSignatureNumerator=t,n.timeSignatureDenominator=e,n.groups.set(s,i),n.finish(),n}findRule(t){const e=this.X;if(e)return[e,this.groups.get(e)];if(t<c.Quarter)return[t,[]];let s=t;do{const t=s;if(this.groups.has(t))return[t,this.groups.get(t)];s*=2}while(s<=c.TwoHundredFiftySixth);s=t/2;do{const t=s;if(this.groups.has(t))return[t,this.groups.get(t)];s/=2}while(s>c.Half);return[t,[]]}finish(){let t=`${this.timeSignatureNumerator}_${this.timeSignatureDenominator}`;for(const[e,s]of this.groups){t+=`__${e}`;let i=s.length;for(let t=s.length-1;t>=0&&0===s[t];t--)i=t;i<s.length&&s.splice(i,s.length-i),t+=`_${s.join("_")}`,1===this.groups.size&&(this.X=e)}this.uniqueId=t}}class tt{static MaxAlternateEndings=8;alternateEndings=0;nextMasterBar=null;previousMasterBar=null;index=0;get hasChanges(){if(0===this.index)return!1;return!(this.timeSignatureCommon===this.previousMasterBar.timeSignatureCommon&&this.timeSignatureNumerator===this.previousMasterBar.timeSignatureNumerator&&this.timeSignatureDenominator===this.previousMasterBar.timeSignatureDenominator&&this.tripletFeel===this.previousMasterBar.tripletFeel)||(0!==this.alternateEndings||this.isRepeatStart||this.isRepeatEnd||this.isFreeTime||this.isSectionStart||this.tempoAutomations.length>0||this.syncPoints&&this.syncPoints.length>0||null!==this.fermata&&this.fermata.size>0||null!==this.directions&&this.directions.size>0||this.isAnacrusis)}get keySignature(){return this.score.tracks[0].staves[0].bars[this.index].keySignature}set keySignature(t){this.score.tracks[0].staves[0].bars[this.index].keySignature=t}get keySignatureType(){return this.score.tracks[0].staves[0].bars[this.index].keySignatureType}set keySignatureType(t){this.score.tracks[0].staves[0].bars[this.index].keySignatureType=t}isDoubleBar=!1;isRepeatStart=!1;get isRepeatEnd(){return this.repeatCount>0}repeatCount=0;repeatGroup;timeSignatureNumerator=4;timeSignatureDenominator=4;timeSignatureCommon=!1;beamingRules;actualBeamingRules;isFreeTime=!1;tripletFeel=F.NoTripletFeel;section=null;get isSectionStart(){return!!this.section}get tempoAutomation(){return this.tempoAutomations.length>0?this.tempoAutomations[0]:null}tempoAutomations=[];syncPoints;score;fermata=null;start=0;isAnacrusis=!1;displayScale=1;displayWidth=-1;directions=null;calculateDuration(t=!0){if(this.isAnacrusis&&t){let t=0;for(const e of this.score.tracks)for(const s of e.staves){const e=this.index<s.bars.length?s.bars[this.index].calculateDuration():0;e>t&&(t=e)}return t}return this.timeSignatureNumerator*H.valueToTicks(this.timeSignatureDenominator)}addFermata(t,e){let s=this.fermata;null===s&&(s=new Map,this.fermata=s),s.set(t,e)}addDirection(t){null==this.directions&&(this.directions=new Set),this.directions.add(t)}getFermata(t){const e=this.fermata;return null===e?null:e.has(t.playbackStart)?e.get(t.playbackStart):0===t.index&&e.has(0)?e.get(0):null}addSyncPoint(t){this.syncPoints||(this.syncPoints=[]),this.syncPoints.push(t)}finish(t){let e=this.beamingRules;if(e&&(e.timeSignatureNumerator=this.timeSignatureNumerator,e.timeSignatureDenominator=this.timeSignatureDenominator,e.finish()),this.index>0){this.start=this.previousMasterBar.start+this.previousMasterBar.calculateDuration();const s=t.has("beamingRules")?t.get("beamingRules"):void 0;s&&s.uniqueId===e?.uniqueId?(this.beamingRules=void 0,e=s):e||(e=s)}this.actualBeamingRules=e,this.beamingRules&&t.set("beamingRules",e)}}!function(t){t[t.NoBrackets=0]="NoBrackets",t[t.GroupStaves=1]="GroupStaves",t[t.GroupSimilarInstruments=2]="GroupSimilarInstruments"}(A||(A={})),function(t){t[t.Hidden=0]="Hidden",t[t.FirstSystem=1]="FirstSystem",t[t.AllSystems=2]="AllSystems"}(D||(D={})),function(t){t[t.FullName=0]="FullName",t[t.ShortName=1]="ShortName"}(L||(L={})),function(t){t[t.Horizontal=0]="Horizontal",t[t.Vertical=1]="Vertical"}(W||(W={})),function(t){t[t.AllBars=0]="AllBars",t[t.FirstOfSystem=1]="FirstOfSystem",t[t.Hide=2]="Hide"}(O||(O={}));class et{hideDynamics=!1;bracketExtendMode=A.GroupStaves;useSystemSignSeparator=!1;globalDisplayTuning=!0;perTrackDisplayTuning=null;globalDisplayChordDiagramsOnTop=!0;perTrackChordDiagramsOnTop=null;globalDisplayChordDiagramsInScore=!1;singleTrackTrackNamePolicy=D.FirstSystem;multiTrackTrackNamePolicy=D.FirstSystem;firstSystemTrackNameMode=L.ShortName;otherSystemsTrackNameMode=L.ShortName;firstSystemTrackNameOrientation=W.Vertical;otherSystemsTrackNameOrientation=W.Vertical;multiTrackMultiBarRest=!1;perTrackMultiBarRest=null;extendBarLines=!1;hideEmptyStaves=!1;hideEmptyStavesInFirstSystem=!1;showSingleStaffBrackets=!1;barNumberDisplay=O.AllBars}class st{masterBars=[];opening=null;get openings(){const t=this.opening;return t?[t]:[]}closings=[];get isOpened(){return!0===this.opening?.isRepeatStart}isClosed=!1;addMasterBar(t){null===this.opening&&(this.opening=t),this.masterBars.push(t),t.repeatGroup=this,t.isRepeatEnd&&(this.closings.push(t),this.isClosed=!0)}}class it{beats=[];id="empty";isComplete=!1;addBeat(t){t.graceIndex=this.beats.length,t.graceGroup=this,this.beats.push(t)}finish(){this.beats.length>0&&(this.id=`${this.beats[0].absoluteDisplayStart}_${this.beats[0].voice.index}`)}}!function(t){t[t.Glyphs=0]="Glyphs"}(R||(R={}));class nt extends q{}let rt=class t{j;H=!0;V=!0;static J=0;static resetIds(){t.J=0}id=t.J++;index=0;bar;beats=[];get isEmpty(){return this.H}style;forceNonEmpty(){this.H=!1}get isRestOnly(){return this.V}shortestDuration=c.DoubleWhole;insertBeat(t,e){e.nextBeat=t.nextBeat,e.nextBeat&&(e.nextBeat.previousBeat=e),e.previousBeat=t,e.voice=this,t.nextBeat=e,this.beats.splice(t.index+1,0,e)}addBeat(t){t.voice=this,t.index=this.beats.length,this.beats.push(t),t.isEmpty||(this.H=!1),t.isRest||(this.V=!1)}q(t,e=null){if(this.bar){if(t.index<this.beats.length-1)t.nextBeat=this.beats[t.index+1],t.nextBeat.previousBeat=t;else if(t.isLastOfVoice&&t.voice.bar.nextBar){const e=this.bar.nextBar.voices[this.index];e.beats.length>0?(t.nextBeat=e.beats[0],t.nextBeat.previousBeat=t):t.nextBeat.previousBeat=t}t.chain(e)}}addGraceBeat(t){if(0===this.beats.length)return void this.addBeat(t);const e=this.beats[this.beats.length-1];this.beats.splice(this.beats.length-1,1),this.addBeat(t),this.addBeat(e),this.H=!1,this.V=!1}getBeatAtPlaybackStart(t){return this.j.has(t)?this.j.get(t):null}finish(t,e=null){this.H=!0,this.V=!0,this.j=new Map;let s=null;for(let t=0;t<this.beats.length;t++){const i=this.beats[t];i.index=t,this.q(i,e),i.graceType===l.None?(i.graceGroup=s,s&&(s.isComplete=!0),s=null):(s||(s=new it),s.addBeat(i)),i.isEmpty||(this.H=!1),i.isRest||(this.V=!1)}let i=0,n=0;this.shortestDuration=c.DoubleWhole;for(let s=0;s<this.beats.length;s++){const r=this.beats[s];if(r.index=s,r.finish(t,e),r.graceType===l.None){if(r.duration>this.shortestDuration&&(this.shortestDuration=r.duration),r.graceGroup){const t=r.graceGroup.beats[0],e=r.graceGroup.beats[r.graceGroup.beats.length-1];if(t.graceType!==l.BendGrace){const s=e.playbackStart+e.playbackDuration-t.playbackStart;switch(t.graceType){case l.BeforeBeat:t.previousBeat?(t.previousBeat.playbackDuration-=s,n=t.previousBeat.voice===this?t.previousBeat.playbackStart+t.previousBeat.playbackDuration:-s):n=-s;for(const t of r.graceGroup.beats)this.j.delete(t.playbackStart),t.playbackStart=n,this.j.set(t.playbackStart,r),n+=t.playbackDuration;break;case l.OnBeat:r.playbackDuration-=s,n=e.voice===this?e.playbackStart+e.playbackDuration:-s}}}r.displayStart=i,r.playbackStart=n,this.j.set(r.playbackStart,r)}else r.displayStart=i,r.playbackStart=n;r.fermata?this.bar.masterBar.addFermata(r.playbackStart,r.fermata):r.fermata=this.bar.masterBar.getFermata(r),r.finishTuplet(),r.graceGroup&&r.graceGroup.finish(),i+=r.displayDuration,n+=r.playbackDuration}}calculateDuration(){if(this.isEmpty||0===this.beats.length)return 0;const t=this.beats[this.beats.length-1],e=this.beats[0];return t.playbackStart+t.playbackDuration-e.playbackStart}};var at,ht,ot,ct,lt,ut,dt,ft,pt,bt,mt,gt,wt,yt,kt,St,Bt,_t,Tt,xt,Mt,vt,Nt,Pt,Ct,Et,Ft,At,Dt,Lt,Wt;!function(t){t[t.Left=0]="Left",t[t.Center=1]="Center",t[t.Right=2]="Right"}(at||(at={})),function(t){t[t.Top=0]="Top",t[t.Middle=1]="Middle",t[t.Bottom=2]="Bottom",t[t.Alphabetic=3]="Alphabetic"}(ht||(ht={}));class Ot{width;height;constructor(t,e){this.width=t,this.height=e}}class Rt{static fillMusicFontSymbolSafe(t,e,s,i,n,r){t.settings.display.resources.engravingSettings.hasSymbol(n)&&t.fillMusicFontSymbol(e,s,i,n,r)}static fillMusicFontSymbolsSafe(t,e,s,i,n,r){const a=n.filter(e=>t.settings.display.resources.engravingSettings.hasSymbol(e));0!==a.length&&t.fillMusicFontSymbols(e,s,i,a,r)}}!function(t){t[t.Title=0]="Title",t[t.SubTitle=1]="SubTitle",t[t.Artist=2]="Artist",t[t.Album=3]="Album",t[t.Words=4]="Words",t[t.Music=5]="Music",t[t.WordsAndMusic=6]="WordsAndMusic",t[t.Transcriber=7]="Transcriber",t[t.Copyright=8]="Copyright",t[t.CopyrightSecondLine=9]="CopyrightSecondLine",t[t.ChordDiagramList=10]="ChordDiagramList"}(ot||(ot={}));class It{template;isVisible;textAlign;constructor(t="",e=void 0,s=at.Left){this.template=t,this.isVisible=e,this.textAlign=s}static equals(t,e){return(void 0===t.isVisible||t.isVisible)===(void 0===e.isVisible||e.isVisible)&&(t.template===e.template&&t.textAlign===e.textAlign)}buildText(t){let e=!1,s=!1;const i=this.template.replace(It.Y,(i,n)=>{s=!0;let r="";switch(n){case"TITLE":r=t.title;break;case"SUBTITLE":r=t.subTitle;break;case"ARTIST":r=t.artist;break;case"ALBUM":r=t.album;break;case"WORDS":case"WORDSMUSIC":r=t.words;break;case"MUSIC":r=t.music;break;case"TABBER":r=t.tab;break;case"COPYRIGHT":r=t.copyright;break;default:r=""}return r&&(e=!0),r});return s&&!e?"":i}static Y=/%([^%]+)%/g}class Gt extends q{headerAndFooter=new Map;static defaultHeaderAndFooter=new Map([[ot.Title,new It("%TITLE%",void 0,at.Center)],[ot.SubTitle,new It("%SUBTITLE%",void 0,at.Center)],[ot.Artist,new It("%ARTIST%",void 0,at.Center)],[ot.Album,new It("%ALBUM%",void 0,at.Center)],[ot.Words,new It("Words by %WORDS%",void 0,at.Left)],[ot.Music,new It("Music by %MUSIC%",void 0,at.Right)],[ot.WordsAndMusic,new It("Words & Music by %MUSIC%",void 0,at.Right)],[ot.Transcriber,new It("Tabbed by %TABBER%",!1,at.Right)],[ot.Copyright,new It("%COPYRIGHT%",void 0,at.Center)],[ot.CopyrightSecondLine,new It("All Rights Reserved - International Copyright Secured",!0,at.Center)]])}class Ht{K=null;Z=[];tt=0;static resetIds(){Q.resetIds(),ee.resetIds(),rt.resetIds(),Kt.resetIds()}album="";artist="";copyright="";instructions="";music="";notices="";subTitle="";title="";words="";tab="";get tempo(){return this.masterBars.length&&this.masterBars[0].tempoAutomations.length>0?this.masterBars[0].tempoAutomations[0].value:120}get tempoLabel(){return this.masterBars.length&&this.masterBars[0].tempoAutomations.length>0?this.masterBars[0].tempoAutomations[0].text:""}masterBars=[];tracks=[];defaultSystemsLayout=3;systemsLayout=[];stylesheet=new et;backingTrack;style;rebuildRepeatGroups(){this.K=null,this.Z=[],this.tt=0;for(const t of this.masterBars)this.et(t)}addMasterBar(t){t.score=this,t.index=this.masterBars.length,0!==this.masterBars.length&&(t.previousMasterBar=this.masterBars[this.masterBars.length-1],t.previousMasterBar.nextMasterBar=t,t.start=t.previousMasterBar.start+(t.previousMasterBar.isAnacrusis?0:t.previousMasterBar.calculateDuration())),this.et(t),this.masterBars.push(t)}et(t){t.isRepeatStart?(this.K?.isClosed&&(this.Z.pop(),this.tt--),this.K=new st,this.Z.push(this.K),this.tt++):this.K||(this.K=new st,this.Z.push(this.K)),this.K.addMasterBar(t),t.isRepeatEnd&&this.tt>1&&(this.Z.pop(),this.tt--,this.K=this.Z.length>0?this.Z[this.Z.length-1]:null)}addTrack(t){t.score=this,t.index=this.tracks.length,this.tracks.push(t)}finish(t){const e=new Map;for(let s=0,i=this.tracks.length;s<i;s++)this.tracks[s].finish(t,e);for(const t of this.masterBars)t.finish(e)}applyFlatSyncPoints(t){for(const t of this.masterBars)t.syncPoints=void 0;for(const e of t){const t=new $;t.ratioPosition=Math.min(1,Math.max(0,e.barPosition)),t.type=n.SyncPoint,t.syncPointValue=new V,t.syncPointValue.millisecondOffset=e.millisecondOffset,t.syncPointValue.barOccurence=e.barOccurence,e.barIndex<this.masterBars.length&&this.masterBars[e.barIndex].addSyncPoint(t)}for(const t of this.masterBars)t.syncPoints&&t.syncPoints.sort((t,e)=>{const s=t.syncPointValue.barOccurence-e.syncPointValue.barOccurence;return 0!==s?s:t.ratioPosition-e.ratioPosition})}exportFlatSyncPoints(){const t=[];for(const e of this.masterBars){const s=e.syncPoints;if(s)for(const i of s)t.push({barIndex:e.index,barOccurence:i.syncPointValue.barOccurence,barPosition:i.ratioPosition,millisecondOffset:i.syncPointValue.millisecondOffset})}return t}}class Vt{static DefaultChannelCount=17;static MetronomeChannel=Vt.DefaultChannelCount-1;static MetronomeKey=33;static AudioChannels=2;static MinVolume=0;static MinProgram=0;static MaxProgram=127;static MinPlaybackSpeed=.125;static MaxPlaybackSpeed=8;static PercussionChannel=9;static PercussionBank=128;static MaxPitchWheel=16384;static MaxPitchWheel20=4294967296;static DefaultPitchWheel=Vt.MaxPitchWheel/2;static MicroBufferCount=32;static MicroBufferSize=64}class $t{note=null;tone=new Ut;octave=0;get realValue(){return 12*this.octave+this.tone.noteValue}}class Ut{noteValue;accidentalMode;constructor(t=0,e=p.Default){this.noteValue=t,this.accidentalMode=e}}class zt{static st=zt.it();static it(){return new Map(Object.values(c).filter(t=>"number"==typeof t).map(t=>[t,t<0?0:0|Math.log2(t)]))}static getIndex(t){return zt.st.get(t)}static keySignatureIsFlat(t){return t<0}static keySignatureIsNatural(t){return 0===t}static keySignatureIsSharp(t){return t>0}static applyPitchOffsets(t,e){for(let s=0;s<e.tracks.length;s++){if(s<t.notation.displayTranspositionPitches.length)for(const i of e.tracks[s].staves)i.displayTranspositionPitch=-t.notation.displayTranspositionPitches[s];if(s<t.notation.transpositionPitches.length)for(const i of e.tracks[s].staves)i.transpositionPitch=-t.notation.transpositionPitches[s]}}static isTuning(t){return!!zt.parseTuning(t)}static tuningLetters=new Set([67,68,69,70,71,65,66,99,100,101,102,103,97,98,35]);static parseTuning(t){let e="",s="";for(let i=0;i<t.length;i++){const n=t.charCodeAt(i);if(n>=48&&n<=57){if(!e)return null;s+=String.fromCharCode(n)}else if(0===e.length){if(!zt.tuningLetters.has(n))return null;e+=String.fromCharCode(n)}else e+=String.fromCharCode(n)}if(!s||!e)return null;const i=new $t;i.octave=Number.parseInt(s,10)+1,i.note=e.toLowerCase();const n=zt.getToneForText(i.note);return null===n?null:(i.tone=n,i.tone.noteValue<0&&(i.octave--,i.tone.noteValue+=12),i)}static getTuningForText(t){const e=zt.parseTuning(t);return e?e.realValue:-1}static getToneForText(t){const e=t.substring(0,1),s=t.substring(1);let i,n;switch(e.toLowerCase()){case"c":i=0;break;case"d":i=2;break;case"e":i=4;break;case"f":i=5;break;case"g":i=7;break;case"a":i=9;break;case"b":i=11;break;default:return null}if(!zt.accidentalModeMapping.has(s))return null;switch(n=zt.parseAccidentalMode(s),n){case p.Default:case p.ForceNone:case p.ForceNatural:break;case p.ForceSharp:i++;break;case p.ForceDoubleSharp:i+=2;break;case p.ForceFlat:i--;break;case p.ForceDoubleFlat:i-=2}return new Ut(i,n)}static reverseAccidentalModeMapping=new Map([[p.Default,"d"],[p.ForceNone,"forcenone"],[p.ForceNatural,"forcenatural"],[p.ForceSharp,"#"],[p.ForceDoubleSharp,"x"],[p.ForceFlat,"b"],[p.ForceDoubleFlat,"bb"]]);static accidentalModeMapping=new Map([["default",p.Default],["d",p.Default],["",p.Default],["forcenone",p.ForceNone],["-",p.ForceNone],["forcenatural",p.ForceNatural],["n",p.ForceNatural],["forcesharp",p.ForceSharp],["#",p.ForceSharp],["forcedoublesharp",p.ForceDoubleSharp],["##",p.ForceDoubleSharp],["x",p.ForceDoubleSharp],["forceflat",p.ForceFlat],["b",p.ForceFlat],["forcedoubleflat",p.ForceDoubleFlat],["bb",p.ForceDoubleFlat]]);static parseAccidentalMode(t){const e=t.toLowerCase();return zt.accidentalModeMapping.has(e)?zt.accidentalModeMapping.get(e):p.Default}static newGuid(){return`${Math.floor(65536*(1+Math.random())).toString(16).substring(1)+Math.floor(65536*(1+Math.random())).toString(16).substring(1)}-${Math.floor(65536*(1+Math.random())).toString(16).substring(1)}-${Math.floor(65536*(1+Math.random())).toString(16).substring(1)}-${Math.floor(65536*(1+Math.random())).toString(16).substring(1)}-${Math.floor(65536*(1+Math.random())).toString(16).substring(1)}${Math.floor(65536*(1+Math.random())).toString(16).substring(1)}${Math.floor(65536*(1+Math.random())).toString(16).substring(1)}`}static isAlmostEqualTo(t,e){return Math.abs(t-e)<1e-5}static toHexString(t,e=0){let s="";do{s=String.fromCharCode("0123456789ABCDEF".charCodeAt(15&t))+s,t>>=4}while(t>0);for(;s.length<e;)s=`0${s}`;return s}static getAlternateEndingsList(t){const e=[];for(let s=0;s<tt.MaxAlternateEndings;s++)t&1<<s&&e.push(s);return e}static deltaFretToHarmonicValue(t){switch(t){case 2:return 2.4;case 3:return 3.2;case 4:case 5:case 7:case 9:case 12:case 16:case 17:case 19:case 24:return t;case 8:return 8.2;case 10:return 9.6;case 14:case 15:return 14.7;case 21:case 22:return 21.7;default:return 12}}static clamp(t,e,s){return t<=e?e:t>=s?s:t}static buildMultiBarRestInfo(t,e,s){if(!t)return null;const i=t[0].score.stylesheet;if(!(t.length>1?i.multiTrackMultiBarRest:!0===i.perTrackMultiBarRest?.has(t[0].index)))return null;const n=new Map,r=t[0].score;let a=e,h=r.tempo;for(;a<=s;){const i=a;let o=null;for(;a<=s;){const s=r.masterBars[a];let n=!1;for(const t of s.tempoAutomations)t.value!==h&&(n=!0),h=t.value;if(s.alternateEndings||s.isRepeatStart&&s.index!==i||s.isFreeTime||s.isAnacrusis||null!==s.section||s.index!==i&&n||null!==s.fermata&&s.fermata.size>0||null!==s.directions&&s.directions.size>0)break;if(i>e&&s.previousMasterBar&&(s.timeSignatureCommon!==s.previousMasterBar.timeSignatureCommon||s.timeSignatureNumerator!==s.previousMasterBar.timeSignatureNumerator||s.timeSignatureDenominator!==s.previousMasterBar.timeSignatureDenominator||s.tripletFeel!==s.previousMasterBar.tripletFeel))break;let c=!0;for(const e of t){for(const t of e.staves){const e=t.bars[s.index];if(!e.isRestOnly){c=!1;break}if(e.index>0&&(e.keySignature!==e.previousBar.keySignature||e.keySignatureType!==e.previousBar.keySignatureType)){c=!1;break}}if(!c)break}if(!c)break;if(a++,s.index>i&&(null===o?o=[s.index]:o.push(s.index)),s.isRepeatEnd)break}o?n.set(i,o):a++}return n}static computeFirstDisplayedBarIndex(t,e){let s=e.display.startBar;return s--,s=Math.min(t.masterBars.length-1,Math.max(0,s)),s}static computeLastDisplayedBarIndex(t,e,s){let i=e.display.barCount;return i<0&&(i=t.masterBars.length),i=s+i-1,i=Math.min(t.masterBars.length-1,Math.max(0,i)),i}static getOrCreateHeaderFooterStyle(t,e){let s,i=t.style;if(t.style||(i=new Gt,t.style=i),i.headerAndFooter.has(e))s=i.headerAndFooter.get(e);else{if(s=new It,Gt.defaultHeaderAndFooter.has(e)){const t=Gt.defaultHeaderAndFooter.get(e);s.template=t.template,s.textAlign=t.textAlign}i.headerAndFooter.set(e,s)}return s}static consolidate(t){if(0===t.masterBars.length){const e=new tt;t.addMasterBar(e);const s=new $;s.isLinear=!1,s.type=n.Tempo,s.value=t.tempo,e.tempoAutomations.push(s);const i=new Q;t.tracks[0].staves[0].addBar(i);const r=new rt;i.addVoice(r);const a=new ee;return a.isEmpty=!0,void r.addBeat(a)}const e=new Set([Vt.PercussionChannel]);for(const s of t.tracks){if(1===s.staves.length&&s.staves[0].isPercussion)s.playbackInfo.primaryChannel=Vt.PercussionChannel,s.playbackInfo.secondaryChannel=Vt.PercussionChannel;else{if(s.playbackInfo.primaryChannel!==Vt.PercussionChannel)for(;e.has(s.playbackInfo.primaryChannel);)s.playbackInfo.primaryChannel++;if(e.add(s.playbackInfo.primaryChannel),s.playbackInfo.secondaryChannel!==Vt.PercussionChannel)for(;e.has(s.playbackInfo.secondaryChannel);)s.playbackInfo.secondaryChannel++;e.add(s.playbackInfo.secondaryChannel)}for(const e of s.staves){for(const t of e.bars)for(const e of t.voices)if(e.isEmpty&&0===e.beats.length){const t=new ee;t.isEmpty=!0,e.addBeat(t)}const s=0===e.bars.length?1:e.bars[0].voices.length;for(;e.bars.length<t.masterBars.length;){const t=new Q;e.addBar(t);const i=t.previousBar;i&&(t.clef=i.clef,t.clefOttava=i.clefOttava,t.keySignature=t.previousBar.keySignature,t.keySignatureType=t.previousBar.keySignatureType);for(let e=0;e<s;e++){const e=new rt;t.addVoice(e);const s=new ee;s.isEmpty=!0,e.addBeat(s)}}}}if(t.masterBars.length>0){if(!t.masterBars[0].tempoAutomations.find(t=>t.type===n.Tempo&&0===t.ratioPosition)){const e=new $;e.isLinear=!1,e.type=n.Tempo,e.value=t.tempo,e.text=t.tempoLabel,e.isVisible=!1,t.masterBars[0].tempoAutomations.push(e)}}}static trimEmptyBarsAtEnd(t){for(;t.masterBars.length>1;){const e=t.masterBars.length-1,s=t.masterBars[e];if(s.hasChanges)return;for(const s of t.tracks)for(const t of s.staves)if(e<t.bars.length){const s=t.bars[e];if(!s.isEmpty||s.hasChanges)return}for(const s of t.tracks)for(const t of s.staves)if(e<t.bars.length){const s=t.bars[e];t.bars.pop(),s.previousBar.nextBar=null}t.masterBars.pop(),s.previousMasterBar.nextMasterBar=null}}static displayTranspositionPitches=new Map([[24,-12],[25,-12],[26,-12],[27,-12],[28,-12],[29,-12],[30,-12],[31,-12],[32,-12],[33,-12],[34,-12],[35,-12],[36,-12],[37,-12],[38,-12],[39,-12],[43,-12]]);static flooredDivision(t,e){return t-e*Math.floor(t/e)}static nt(t){const e=[];for(const s of t){const t=[];e.push(t);for(const e of s){const s=Number.parseInt(e.charAt(0),10)*("b"===e.charAt(1)?-1:1);t.push(s)}}return e}static rt=zt.nt([["7b","6b","5b","4b","3b","2b","1b","0#","1#","2#","3#","4#","5#","6#","7#"],["2b","1b","0#","1#","2#","3#","4#","5#","6#","7#","4b","3b","2b","1b","0#"],["3#","4#","7b","6b","5b","4b","3b","2b","1b","0#","1#","2#","3#","4#","5#"],["4b","3b","2b","1b","0#","1#","2#","3#","4#","5#","6#","7#","4b","3b","2b"],["1#","2#","3#","4#","7b","6b","5b","4b","3b","2b","1b","0#","1#","2#","3#"],["6b","5b","4b","3b","2b","1b","0#","1#","2#","3#","4#","5#","6#","7#","4b"],["1b","0#","1#","2#","3#","4#","7b","6#","7#","4b","3b","2b","1b","0#","1#"],["4#","7b","6b","5b","4b","3b","2b","1b","0#","1#","2#","3#","4#","5#","6#"],["3b","2b","1b","0#","1#","2#","3#","4#","5#","6#","7#","4b","3b","2b","1b"],["2#","3#","4#","7b","6b","5b","4b","3b","2b","1b","0#","1#","2#","3#","4#"],["5b","4b","3b","2b","1b","0#","1#","2#","3#","4#","5#","6#","7#","4b","3b"],["0#","1#","2#","3#","4#","7b","6b","6#","4b","3b","2b","1b","0#","1#","2#"]]);static transposeKey(t,e){if(0===e)return t;if(e<0){const s=zt.rt[-e].indexOf(t);return-1===s?t:s-7}return zt.rt[e][t+7]}static toArticulationId(t){return t.replace(/[^a-zA-Z0-9]/g,"").toLowerCase()}static minBoundingBox(t,e){return Number.isNaN(t)?e:Number.isNaN(e)||t<e?t:e}static maxBoundingBox(t,e){return Number.isNaN(t)?e:Number.isNaN(e)||t>e?t:e}static getSystemLayout(t,e,s){let i,n;return 1===s.length?(i=s[0].defaultSystemsLayout,n=s[0].systemsLayout):(i=t.defaultSystemsLayout,n=t.systemsLayout),e<n.length?n[e]:i}static ht=[0,2,4,5,7,9,11];static ot=[{degree:0,accidentalOffset:0},{degree:0,accidentalOffset:1},{degree:1,accidentalOffset:0},{degree:1,accidentalOffset:1},{degree:2,accidentalOffset:0},{degree:3,accidentalOffset:0},{degree:3,accidentalOffset:1},{degree:4,accidentalOffset:0},{degree:4,accidentalOffset:1},{degree:5,accidentalOffset:0},{degree:5,accidentalOffset:1},{degree:6,accidentalOffset:0}];static ct=[{degree:0,accidentalOffset:0},{degree:1,accidentalOffset:-1},{degree:1,accidentalOffset:0},{degree:2,accidentalOffset:-1},{degree:2,accidentalOffset:0},{degree:3,accidentalOffset:0},{degree:4,accidentalOffset:-1},{degree:4,accidentalOffset:0},{degree:5,accidentalOffset:-1},{degree:5,accidentalOffset:0},{degree:6,accidentalOffset:-1},{degree:6,accidentalOffset:0}];static lt=[[{degree:0,accidentalOffset:0},{degree:1,accidentalOffset:-2},{degree:6,accidentalOffset:1}],[{degree:0,accidentalOffset:1},{degree:1,accidentalOffset:-1},{degree:6,accidentalOffset:2}],[{degree:1,accidentalOffset:0},{degree:0,accidentalOffset:2},{degree:2,accidentalOffset:-2}],[{degree:1,accidentalOffset:1},{degree:2,accidentalOffset:-1},{degree:3,accidentalOffset:-2}],[{degree:2,accidentalOffset:0},{degree:1,accidentalOffset:2},{degree:3,accidentalOffset:-1}],[{degree:3,accidentalOffset:0},{degree:2,accidentalOffset:1},{degree:4,accidentalOffset:-2}],[{degree:3,accidentalOffset:1},{degree:4,accidentalOffset:-1},{degree:2,accidentalOffset:2}],[{degree:4,accidentalOffset:0},{degree:3,accidentalOffset:2},{degree:5,accidentalOffset:-2}],[{degree:4,accidentalOffset:1},{degree:5,accidentalOffset:-1}],[{degree:5,accidentalOffset:0},{degree:4,accidentalOffset:2},{degree:6,accidentalOffset:-2}],[{degree:5,accidentalOffset:1},{degree:6,accidentalOffset:-1},{degree:0,accidentalOffset:-2}],[{degree:6,accidentalOffset:0},{degree:5,accidentalOffset:2},{degree:0,accidentalOffset:-1}]];static ut=[3,0,4,1,5,2,6];static dt=[6,2,5,1,4,0,3];static ft=zt.bt();static gt=new Map([[-2,T.DoubleFlat],[-1,T.Flat],[0,T.Natural],[1,T.Sharp],[2,T.DoubleSharp]]);static wt=new Map([[p.ForceSharp,1],[p.ForceDoubleSharp,2],[p.ForceFlat,-1],[p.ForceDoubleFlat,-2],[p.ForceNatural,0],[p.ForceNone,0],[p.Default,Number.NaN]]);static bt(){const t=[];for(let e=-7;e<=7;e++){const s=[0,0,0,0,0,0,0];if(e>0)for(let t=0;t<e;t++)s[zt.ut[t]]=1;else if(e<0)for(let t=0;t<-e;t++)s[zt.dt[t]]=-1;t.push(s)}return t}static getKeySignatureAccidentalOffset(t,e){return zt.ft[t+7][e]}static resolveSpelling(t,e,s){const i=zt.flooredDivision(e,12),n=zt.yt(t,i),r=zt.wt.has(s)?zt.wt.get(s):Number.NaN;let a=n;if(!Number.isNaN(r)){const t=zt.lt[i].find(t=>t.accidentalOffset===r);t&&(a=t)}const h=zt.ht[a.degree]+a.accidentalOffset,o=Math.floor((e-h)/12)-1;return{degree:a.degree,accidentalOffset:a.accidentalOffset,chroma:i,octave:o}}static computeAccidental(t,e,s,i,n=null){const r=zt.resolveSpelling(t,s,e);return zt.computeAccidentalForSpelling(t,e,r,i,n)}static computeAccidentalForSpelling(t,e,s,i,n=null){if(e===p.ForceNone)return T.None;if(i)return s.accidentalOffset>0?T.SharpQuarterNoteUp:s.accidentalOffset<0?T.FlatQuarterNoteUp:T.NaturalQuarterNoteUp;const r=s.accidentalOffset,a=zt.getKeySignatureAccidentalOffset(t,s.degree);return n===r||null==n&&r===a?T.None:zt.accidentalOffsetToType(r)}static accidentalOffsetToType(t){return zt.gt.has(t)?zt.gt.get(t):T.None}static yt(t,e){const s=zt.lt[e].find(e=>zt.getKeySignatureAccidentalOffset(t,e.degree)===e.accidentalOffset);if(s)return s;return zt.keySignatureIsFlat(t)?zt.ct[e]:zt.ot[e]}static kt=[0,4,1,5,2,6,3,0,4,1,5,2,6,3,0];static St=[5,2,6,3,0,4,1,5,2,6,3,0,4,1,5];static getKeySignatureTonicDegree(t,e){const s=t+7;return e===N.Minor?zt.St[s]:zt.kt[s]}}!function(t){t[t.None=0]="None",t[t.Up=1]="Up",t[t.Down=2]="Down"}(ct||(ct={})),function(t){t[t.None=-1]="None",t[t.Space=32]="Space",t[t.Brace=57344]="Brace",t[t.BracketTop=57347]="BracketTop",t[t.BracketBottom=57348]="BracketBottom",t[t.SystemDivider=57351]="SystemDivider",t[t.GClef=57424]="GClef",t[t.GClef15mb=57425]="GClef15mb",t[t.GClef8vb=57426]="GClef8vb",t[t.GClef8va=57427]="GClef8va",t[t.GClef15ma=57428]="GClef15ma",t[t.CClef=57436]="CClef",t[t.CClef8vb=57437]="CClef8vb",t[t.FClef=57442]="FClef",t[t.FClef15mb=57443]="FClef15mb",t[t.FClef8vb=57444]="FClef8vb",t[t.FClef8va=57445]="FClef8va",t[t.FClef15ma=57446]="FClef15ma",t[t.UnpitchedPercussionClef1=57449]="UnpitchedPercussionClef1",t[t.SixStringTabClef=57453]="SixStringTabClef",t[t.FourStringTabClef=57454]="FourStringTabClef",t[t.Clef8=57469]="Clef8",t[t.Clef15=57470]="Clef15",t[t.TimeSig0=57472]="TimeSig0",t[t.TimeSig1=57473]="TimeSig1",t[t.TimeSig2=57474]="TimeSig2",t[t.TimeSig3=57475]="TimeSig3",t[t.TimeSig4=57476]="TimeSig4",t[t.TimeSig5=57477]="TimeSig5",t[t.TimeSig6=57478]="TimeSig6",t[t.TimeSig7=57479]="TimeSig7",t[t.TimeSig8=57480]="TimeSig8",t[t.TimeSig9=57481]="TimeSig9",t[t.TimeSigCommon=57482]="TimeSigCommon",t[t.TimeSigCutCommon=57483]="TimeSigCutCommon",t[t.NoteheadDoubleWholeSquare=57505]="NoteheadDoubleWholeSquare",t[t.NoteheadDoubleWhole=57504]="NoteheadDoubleWhole",t[t.NoteheadWhole=57506]="NoteheadWhole",t[t.NoteheadHalf=57507]="NoteheadHalf",t[t.NoteheadBlack=57508]="NoteheadBlack",t[t.NoteheadNull=57509]="NoteheadNull",t[t.NoteheadXOrnate=57514]="NoteheadXOrnate",t[t.NoteheadPlusDoubleWhole=57516]="NoteheadPlusDoubleWhole",t[t.NoteheadPlusWhole=57517]="NoteheadPlusWhole",t[t.NoteheadPlusHalf=57518]="NoteheadPlusHalf",t[t.NoteheadPlusBlack=57519]="NoteheadPlusBlack",t[t.NoteheadSquareWhite=57528]="NoteheadSquareWhite",t[t.NoteheadSquareBlack=57529]="NoteheadSquareBlack",t[t.NoteheadTriangleUpDoubleWhole=57530]="NoteheadTriangleUpDoubleWhole",t[t.NoteheadTriangleUpWhole=57531]="NoteheadTriangleUpWhole",t[t.NoteheadTriangleUpHalf=57532]="NoteheadTriangleUpHalf",t[t.NoteheadTriangleUpBlack=57534]="NoteheadTriangleUpBlack",t[t.NoteheadTriangleRightWhite=57537]="NoteheadTriangleRightWhite",t[t.NoteheadTriangleRightBlack=57538]="NoteheadTriangleRightBlack",t[t.NoteheadTriangleDownDoubleWhole=57548]="NoteheadTriangleDownDoubleWhole",t[t.NoteheadTriangleDownWhole=57540]="NoteheadTriangleDownWhole",t[t.NoteheadTriangleDownHalf=57541]="NoteheadTriangleDownHalf",t[t.NoteheadTriangleDownBlack=57543]="NoteheadTriangleDownBlack",t[t.NoteheadDiamondDoubleWhole=57559]="NoteheadDiamondDoubleWhole",t[t.NoteheadDiamondWhole=57560]="NoteheadDiamondWhole",t[t.NoteheadDiamondHalf=57561]="NoteheadDiamondHalf",t[t.NoteheadDiamondBlack=57563]="NoteheadDiamondBlack",t[t.NoteheadDiamondBlackWide=57564]="NoteheadDiamondBlackWide",t[t.NoteheadDiamondWhite=57565]="NoteheadDiamondWhite",t[t.NoteheadDiamondWhiteWide=57566]="NoteheadDiamondWhiteWide",t[t.NoteheadCircleXDoubleWhole=57520]="NoteheadCircleXDoubleWhole",t[t.NoteheadCircleXWhole=57521]="NoteheadCircleXWhole",t[t.NoteheadCircleXHalf=57522]="NoteheadCircleXHalf",t[t.NoteheadCircleX=57523]="NoteheadCircleX",t[t.NoteheadXDoubleWhole=57510]="NoteheadXDoubleWhole",t[t.NoteheadXWhole=57511]="NoteheadXWhole",t[t.NoteheadXHalf=57512]="NoteheadXHalf",t[t.NoteheadXBlack=57513]="NoteheadXBlack",t[t.NoteheadParenthesis=57550]="NoteheadParenthesis",t[t.NoteheadSlashedBlack1=57551]="NoteheadSlashedBlack1",t[t.NoteheadSlashedBlack2=57552]="NoteheadSlashedBlack2",t[t.NoteheadSlashedHalf1=57553]="NoteheadSlashedHalf1",t[t.NoteheadSlashedHalf2=57554]="NoteheadSlashedHalf2",t[t.NoteheadSlashedWhole1=57555]="NoteheadSlashedWhole1",t[t.NoteheadSlashedWhole2=57556]="NoteheadSlashedWhole2",t[t.NoteheadSlashedDoubleWhole1=57557]="NoteheadSlashedDoubleWhole1",t[t.NoteheadSlashedDoubleWhole2=57558]="NoteheadSlashedDoubleWhole2",t[t.NoteheadCircledBlack=57572]="NoteheadCircledBlack",t[t.NoteheadCircledHalf=57573]="NoteheadCircledHalf",t[t.NoteheadCircledWhole=57574]="NoteheadCircledWhole",t[t.NoteheadCircledDoubleWhole=57575]="NoteheadCircledDoubleWhole",t[t.NoteheadCircleSlash=57591]="NoteheadCircleSlash",t[t.NoteheadHeavyX=57592]="NoteheadHeavyX",t[t.NoteheadHeavyXHat=57593]="NoteheadHeavyXHat",t[t.NoteheadSlashHorizontalEnds=57601]="NoteheadSlashHorizontalEnds",t[t.NoteheadSlashWhiteWhole=57602]="NoteheadSlashWhiteWhole",t[t.NoteheadSlashWhiteHalf=57603]="NoteheadSlashWhiteHalf",t[t.NoteheadRoundWhiteWithDot=57621]="NoteheadRoundWhiteWithDot",t[t.NoteheadSquareBlackLarge=57626]="NoteheadSquareBlackLarge",t[t.NoteheadSquareBlackWhite=57627]="NoteheadSquareBlackWhite",t[t.NoteheadClusterDoubleWhole3rd=57640]="NoteheadClusterDoubleWhole3rd",t[t.NoteheadClusterWhole3rd=57641]="NoteheadClusterWhole3rd",t[t.NoteheadClusterHalf3rd=57642]="NoteheadClusterHalf3rd",t[t.NoteheadClusterQuarter3rd=57643]="NoteheadClusterQuarter3rd",t[t.NoteShapeRoundWhite=57776]="NoteShapeRoundWhite",t[t.NoteShapeRoundBlack=57777]="NoteShapeRoundBlack",t[t.NoteShapeSquareWhite=57778]="NoteShapeSquareWhite",t[t.NoteShapeSquareBlack=57779]="NoteShapeSquareBlack",t[t.NoteShapeTriangleRightWhite=57780]="NoteShapeTriangleRightWhite",t[t.NoteShapeTriangleRightBlack=57781]="NoteShapeTriangleRightBlack",t[t.NoteShapeTriangleLeftWhite=57782]="NoteShapeTriangleLeftWhite",t[t.NoteShapeTriangleLeftBlack=57783]="NoteShapeTriangleLeftBlack",t[t.NoteShapeDiamondWhite=57784]="NoteShapeDiamondWhite",t[t.NoteShapeDiamondBlack=57785]="NoteShapeDiamondBlack",t[t.NoteShapeTriangleUpWhite=57786]="NoteShapeTriangleUpWhite",t[t.NoteShapeTriangleUpBlack=57787]="NoteShapeTriangleUpBlack",t[t.NoteShapeMoonWhite=57788]="NoteShapeMoonWhite",t[t.NoteShapeMoonBlack=57789]="NoteShapeMoonBlack",t[t.NoteShapeTriangleRoundWhite=57790]="NoteShapeTriangleRoundWhite",t[t.NoteShapeTriangleRoundBlack=57791]="NoteShapeTriangleRoundBlack",t[t.NoteQuarterUp=57813]="NoteQuarterUp",t[t.Note8thUp=57815]="Note8thUp",t[t.MetNoteQuarterUp=60581]="MetNoteQuarterUp",t[t.MetNote8thUp=60583]="MetNote8thUp",t[t.MetAugmentationDot=60599]="MetAugmentationDot",t[t.ArrowheadBlackUp=60280]="ArrowheadBlackUp",t[t.ArrowheadBlackDown=60284]="ArrowheadBlackDown",t[t.AugmentationDot=57831]="AugmentationDot",t[t.TextBlackNoteLongStem=57841]="TextBlackNoteLongStem",t[t.TextBlackNoteFrac8thLongStem=57843]="TextBlackNoteFrac8thLongStem",t[t.TextBlackNoteFrac16thLongStem=57845]="TextBlackNoteFrac16thLongStem",t[t.TextBlackNoteFrac32ndLongStem=57846]="TextBlackNoteFrac32ndLongStem",t[t.TextCont8thBeamLongStem=57848]="TextCont8thBeamLongStem",t[t.TextCont16thBeamLongStem=57850]="TextCont16thBeamLongStem",t[t.TextCont32ndBeamLongStem=57851]="TextCont32ndBeamLongStem",t[t.TextAugmentationDot=57852]="TextAugmentationDot",t[t.TextTupletBracketStartLongStem=57857]="TextTupletBracketStartLongStem",t[t.TextTuplet3LongStem=57858]="TextTuplet3LongStem",t[t.TextTupletBracketEndLongStem=57859]="TextTupletBracketEndLongStem",t[t.Tremolo1=57888]="Tremolo1",t[t.Tremolo2=57889]="Tremolo2",t[t.Tremolo3=57890]="Tremolo3",t[t.Tremolo4=57891]="Tremolo4",t[t.Tremolo5=57892]="Tremolo5",t[t.BuzzRoll=57898]="BuzzRoll",t[t.Flag8thUp=57920]="Flag8thUp",t[t.Flag8thDown=57921]="Flag8thDown",t[t.Flag16thUp=57922]="Flag16thUp",t[t.Flag16thDown=57923]="Flag16thDown",t[t.Flag32ndUp=57924]="Flag32ndUp",t[t.Flag32ndDown=57925]="Flag32ndDown",t[t.Flag64thUp=57926]="Flag64thUp",t[t.Flag64thDown=57927]="Flag64thDown",t[t.Flag128thUp=57928]="Flag128thUp",t[t.Flag128thDown=57929]="Flag128thDown",t[t.Flag256thUp=57930]="Flag256thUp",t[t.Flag256thDown=57931]="Flag256thDown",t[t.AccidentalFlat=57952]="AccidentalFlat",t[t.AccidentalNatural=57953]="AccidentalNatural",t[t.AccidentalSharp=57954]="AccidentalSharp",t[t.AccidentalDoubleSharp=57955]="AccidentalDoubleSharp",t[t.AccidentalDoubleFlat=57956]="AccidentalDoubleFlat",t[t.AccidentalQuarterToneFlatArrowUp=57968]="AccidentalQuarterToneFlatArrowUp",t[t.AccidentalQuarterToneSharpNaturalArrowUp=57970]="AccidentalQuarterToneSharpNaturalArrowUp",t[t.AccidentalThreeQuarterTonesSharpArrowUp=57972]="AccidentalThreeQuarterTonesSharpArrowUp",t[t.RepeatDot=57412]="RepeatDot",t[t.Segno=57415]="Segno",t[t.Coda=57416]="Coda",t[t.ArticAccentAbove=58528]="ArticAccentAbove",t[t.ArticAccentBelow=58529]="ArticAccentBelow",t[t.ArticStaccatoAbove=58530]="ArticStaccatoAbove",t[t.ArticStaccatoBelow=58531]="ArticStaccatoBelow",t[t.ArticTenutoAbove=58532]="ArticTenutoAbove",t[t.ArticTenutoBelow=58533]="ArticTenutoBelow",t[t.ArticMarcatoAbove=58540]="ArticMarcatoAbove",t[t.ArticMarcatoBelow=58541]="ArticMarcatoBelow",t[t.FermataAbove=58560]="FermataAbove",t[t.FermataShortAbove=58564]="FermataShortAbove",t[t.FermataLongAbove=58566]="FermataLongAbove",t[t.RestLonga=58593]="RestLonga",t[t.RestDoubleWhole=58594]="RestDoubleWhole",t[t.RestWhole=58595]="RestWhole",t[t.RestHalf=58596]="RestHalf",t[t.RestQuarter=58597]="RestQuarter",t[t.Rest8th=58598]="Rest8th",t[t.Rest16th=58599]="Rest16th",t[t.Rest32nd=58600]="Rest32nd",t[t.Rest64th=58601]="Rest64th",t[t.Rest128th=58602]="Rest128th",t[t.Rest256th=58603]="Rest256th",t[t.RestHBarLeft=58607]="RestHBarLeft",t[t.RestHBarMiddle=58608]="RestHBarMiddle",t[t.RestHBarRight=58609]="RestHBarRight",t[t.Repeat1Bar=58624]="Repeat1Bar",t[t.Repeat2Bars=58625]="Repeat2Bars",t[t.Ottava=58640]="Ottava",t[t.OttavaAlta=58641]="OttavaAlta",t[t.OttavaBassaVb=58652]="OttavaBassaVb",t[t.Quindicesima=58644]="Quindicesima",t[t.QuindicesimaAlta=58645]="QuindicesimaAlta",t[t.DynamicPPPPPP=58663]="DynamicPPPPPP",t[t.DynamicPPPPP=58664]="DynamicPPPPP",t[t.DynamicPPPP=58665]="DynamicPPPP",t[t.DynamicPPP=58666]="DynamicPPP",t[t.DynamicPP=58667]="DynamicPP",t[t.DynamicPiano=58656]="DynamicPiano",t[t.DynamicMP=58668]="DynamicMP",t[t.DynamicMF=58669]="DynamicMF",t[t.DynamicPF=58670]="DynamicPF",t[t.DynamicForte=58658]="DynamicForte",t[t.DynamicFF=58671]="DynamicFF",t[t.DynamicFFF=58672]="DynamicFFF",t[t.DynamicFFFF=58673]="DynamicFFFF",t[t.DynamicFFFFF=58674]="DynamicFFFFF",t[t.DynamicFFFFFF=58675]="DynamicFFFFFF",t[t.DynamicFortePiano=58676]="DynamicFortePiano",t[t.DynamicNiente=58662]="DynamicNiente",t[t.DynamicSforzando1=58678]="DynamicSforzando1",t[t.DynamicSforzandoPiano=58679]="DynamicSforzandoPiano",t[t.DynamicSforzandoPianissimo=58680]="DynamicSforzandoPianissimo",t[t.DynamicSforzato=58681]="DynamicSforzato",t[t.DynamicSforzatoPiano=58682]="DynamicSforzatoPiano",t[t.DynamicSforzatoFF=58683]="DynamicSforzatoFF",t[t.DynamicRinforzando1=58684]="DynamicRinforzando1",t[t.DynamicRinforzando2=58685]="DynamicRinforzando2",t[t.DynamicForzando=58677]="DynamicForzando",t[t.DynamicCrescendoHairpin=58686]="DynamicCrescendoHairpin",t[t.GraceNoteSlashStemUp=58724]="GraceNoteSlashStemUp",t[t.GraceNoteSlashStemDown=58725]="GraceNoteSlashStemDown",t[t.OrnamentTrill=58726]="OrnamentTrill",t[t.OrnamentTurn=58727]="OrnamentTurn",t[t.OrnamentTurnInverted=58728]="OrnamentTurnInverted",t[t.OrnamentShortTrill=58732]="OrnamentShortTrill",t[t.OrnamentMordent=58733]="OrnamentMordent",t[t.StringsDownBow=58896]="StringsDownBow",t[t.StringsUpBow=58898]="StringsUpBow",t[t.KeyboardPedalPed=58960]="KeyboardPedalPed",t[t.KeyboardPedalUp=58965]="KeyboardPedalUp",t[t.PictEdgeOfCymbal=59177]="PictEdgeOfCymbal",t[t.GuitarString0=59443]="GuitarString0",t[t.GuitarString1=59444]="GuitarString1",t[t.GuitarString2=59445]="GuitarString2",t[t.GuitarString3=59446]="GuitarString3",t[t.GuitarString4=59447]="GuitarString4",t[t.GuitarString5=59448]="GuitarString5",t[t.GuitarString6=59449]="GuitarString6",t[t.GuitarString7=59450]="GuitarString7",t[t.GuitarString8=59451]="GuitarString8",t[t.GuitarString9=59452]="GuitarString9",t[t.GuitarOpenPedal=59453]="GuitarOpenPedal",t[t.GuitarClosePedal=59455]="GuitarClosePedal",t[t.GuitarGolpe=59458]="GuitarGolpe",t[t.GuitarFadeIn=59459]="GuitarFadeIn",t[t.GuitarFadeOut=59460]="GuitarFadeOut",t[t.GuitarVolumeSwell=59461]="GuitarVolumeSwell",t[t.FretboardFilledCircle=59480]="FretboardFilledCircle",t[t.FretboardX=59481]="FretboardX",t[t.FretboardO=59482]="FretboardO",t[t.Tuplet0=59520]="Tuplet0",t[t.Tuplet1=59521]="Tuplet1",t[t.Tuplet2=59522]="Tuplet2",t[t.Tuplet3=59523]="Tuplet3",t[t.Tuplet4=59524]="Tuplet4",t[t.Tuplet5=59525]="Tuplet5",t[t.Tuplet6=59526]="Tuplet6",t[t.Tuplet7=59527]="Tuplet7",t[t.Tuplet8=59528]="Tuplet8",t[t.Tuplet9=59529]="Tuplet9",t[t.TupletColon=59530]="TupletColon",t[t.WiggleTrill=60068]="WiggleTrill",t[t.GuitarVibratoStroke=60082]="GuitarVibratoStroke",t[t.GuitarWideVibratoStroke=60083]="GuitarWideVibratoStroke",t[t.WiggleVibratoMediumFast=60126]="WiggleVibratoMediumFast",t[t.WiggleSawtoothNarrow=60090]="WiggleSawtoothNarrow",t[t.WiggleSawtooth=60091]="WiggleSawtooth",t[t.OctaveBaselineM=60565]="OctaveBaselineM",t[t.OctaveBaselineB=60563]="OctaveBaselineB",t[t.GuitarLeftHandTapping=59456]="GuitarLeftHandTapping",t[t.Fingering0=60688]="Fingering0",t[t.Fingering1=60689]="Fingering1",t[t.Fingering2=60690]="Fingering2",t[t.Fingering3=60691]="Fingering3",t[t.Fingering4=60692]="Fingering4",t[t.Fingering5=60693]="Fingering5",t[t.FingeringPLower=60695]="FingeringPLower",t[t.FingeringTLower=60696]="FingeringTLower",t[t.FingeringILower=60697]="FingeringILower",t[t.FingeringMLower=60698]="FingeringMLower",t[t.FingeringALower=60699]="FingeringALower",t[t.FingeringCLower=60700]="FingeringCLower"}(lt||(lt={}));class Xt{static Bt=[];static _t=new Set;static Tt(){const t=Xt.Bt;if(0===t.length)for(const e of Object.values(lt).filter(t=>"number"==typeof t)){const s=e;t.push(s);lt[s].toLowerCase().endsWith("black")&&Xt._t.add(s)}}static getAllMusicFontSymbols(){return Xt.Tt(),Xt.Bt}static isBlackNoteHead(t){return Xt.Tt(),Xt._t.has(t)}}!function(t){t[t.Above=0]="Above",t[t.Inside=1]="Inside",t[t.Below=2]="Below",t[t.Outside=3]="Outside"}(ut||(ut={}));class jt{id=0;get uniqueId(){return`${this.elementType}.${this.id}`}elementType;staffLine;noteHeadDefault;noteHeadHalf;noteHeadWhole;techniqueSymbol;techniqueSymbolPlacement;outputMidiNumber;constructor(t="",e=0,s=0,i=lt.None,n=lt.None,r=lt.None,a=lt.None,h=ut.Inside,o=0){this.id=o,this.elementType=t,this.outputMidiNumber=s,this.staffLine=e,this.noteHeadDefault=i,this.noteHeadHalf=n!==lt.None?n:i,this.noteHeadWhole=r!==lt.None?r:i,this.techniqueSymbol=a,this.techniqueSymbolPlacement=h}static create(t=0,e="",s=0,i=0,n=lt.None,r=lt.None,a=lt.None,h=lt.None,o=ut.Inside){return new jt(e,s,i,n,r,a,h,o,t)}getSymbol(t){switch(t){case c.Whole:return this.noteHeadWhole;case c.Half:return this.noteHeadHalf;default:return this.noteHeadDefault}}}class Jt{static instrumentArticulations=new Map([jt.create(38,"Snare",3,38,lt.NoteheadBlack,lt.NoteheadHalf,lt.NoteheadWhole),jt.create(37,"Snare",3,37,lt.NoteheadXBlack,lt.NoteheadXBlack,lt.NoteheadXBlack),jt.create(91,"Snare",3,38,lt.NoteheadDiamondWhite,lt.NoteheadDiamondWhite,lt.NoteheadDiamondWhite),jt.create(42,"Charley",-1,42,lt.NoteheadXBlack,lt.NoteheadXBlack,lt.NoteheadXBlack),jt.create(92,"Charley",-1,46,lt.NoteheadCircleSlash,lt.NoteheadCircleSlash,lt.NoteheadCircleSlash),jt.create(46,"Charley",-1,46,lt.NoteheadCircleX,lt.NoteheadCircleX,lt.NoteheadCircleX),jt.create(44,"Charley",9,44,lt.NoteheadXBlack,lt.NoteheadXBlack,lt.NoteheadXBlack),jt.create(35,"Acoustic Kick Drum",8,35,lt.NoteheadBlack,lt.NoteheadHalf,lt.NoteheadWhole),jt.create(36,"Kick Drum",7,36,lt.NoteheadBlack,lt.NoteheadHalf,lt.NoteheadWhole),jt.create(50,"Tom Very High",1,50,lt.NoteheadBlack,lt.NoteheadHalf,lt.NoteheadWhole),jt.create(48,"Tom High",2,48,lt.NoteheadBlack,lt.NoteheadHalf,lt.NoteheadWhole),jt.create(47,"Tom Medium",4,47,lt.NoteheadBlack,lt.NoteheadHalf,lt.NoteheadWhole),jt.create(45,"Tom Low",5,45,lt.NoteheadBlack,lt.NoteheadHalf,lt.NoteheadWhole),jt.create(43,"Tom Very Low",6,43,lt.NoteheadBlack,lt.NoteheadHalf,lt.NoteheadWhole),jt.create(93,"Ride",0,51,lt.NoteheadXBlack,lt.NoteheadXBlack,lt.NoteheadXBlack,lt.PictEdgeOfCymbal,ut.Above),jt.create(51,"Ride",0,51,lt.NoteheadXBlack,lt.NoteheadXBlack,lt.NoteheadXBlack),jt.create(53,"Ride",0,53,lt.NoteheadDiamondWhite,lt.NoteheadDiamondWhite,lt.NoteheadDiamondWhite),jt.create(94,"Ride",0,51,lt.NoteheadXBlack,lt.NoteheadXBlack,lt.NoteheadXBlack,lt.ArticStaccatoAbove,ut.Outside),jt.create(55,"Splash",-2,55,lt.NoteheadXBlack,lt.NoteheadXBlack,lt.NoteheadXBlack),jt.create(95,"Splash",-2,55,lt.NoteheadXBlack,lt.NoteheadXBlack,lt.NoteheadXBlack,lt.ArticStaccatoAbove,ut.Outside),jt.create(52,"China",-3,52,lt.NoteheadHeavyXHat,lt.NoteheadHeavyXHat,lt.NoteheadHeavyXHat),jt.create(96,"China",-3,52,lt.NoteheadHeavyXHat,lt.NoteheadHeavyXHat,lt.NoteheadHeavyXHat),jt.create(49,"Crash High",-2,49,lt.NoteheadHeavyX,lt.NoteheadHeavyX,lt.NoteheadHeavyX),jt.create(97,"Crash High",-2,49,lt.NoteheadHeavyX,lt.NoteheadHeavyX,lt.NoteheadHeavyX,lt.ArticStaccatoAbove,ut.Outside),jt.create(57,"Crash Medium",-1,57,lt.NoteheadHeavyX,lt.NoteheadHeavyX,lt.NoteheadHeavyX),jt.create(98,"Crash Medium",-1,57,lt.NoteheadHeavyX,lt.NoteheadHeavyX,lt.NoteheadHeavyX,lt.ArticStaccatoAbove,ut.Outside),jt.create(99,"Cowbell Low",1,56,lt.NoteheadTriangleUpBlack,lt.NoteheadTriangleUpHalf,lt.NoteheadTriangleUpWhole),jt.create(100,"Cowbell Low",1,56,lt.NoteheadXBlack,lt.NoteheadXHalf,lt.NoteheadXWhole),jt.create(56,"Cowbell Medium",0,56,lt.NoteheadTriangleUpBlack,lt.NoteheadTriangleUpHalf,lt.NoteheadTriangleUpWhole),jt.create(101,"Cowbell Medium",0,56,lt.NoteheadXBlack,lt.NoteheadXHalf,lt.NoteheadXWhole),jt.create(102,"Cowbell High",-1,56,lt.NoteheadTriangleUpBlack,lt.NoteheadTriangleUpHalf,lt.NoteheadTriangleUpWhole),jt.create(103,"Cowbell High",-1,56,lt.NoteheadXBlack,lt.NoteheadXHalf,lt.NoteheadXWhole),jt.create(77,"Woodblock Low",-9,77,lt.NoteheadTriangleUpBlack,lt.NoteheadTriangleUpBlack,lt.NoteheadTriangleUpBlack),jt.create(76,"Woodblock High",-10,76,lt.NoteheadTriangleUpBlack,lt.NoteheadTriangleUpBlack,lt.NoteheadTriangleUpBlack),jt.create(60,"Bongo High",-4,60,lt.NoteheadBlack,lt.NoteheadHalf,lt.NoteheadWhole),jt.create(104,"Bongo High",-5,60,lt.NoteheadBlack,lt.NoteheadHalf,lt.NoteheadWhole,lt.NoteheadParenthesis,ut.Inside),jt.create(105,"Bongo High",-6,60,lt.NoteheadXBlack,lt.NoteheadXBlack,lt.NoteheadXBlack),jt.create(61,"Bongo Low",-7,61,lt.NoteheadBlack,lt.NoteheadHalf,lt.NoteheadWhole),jt.create(106,"Bongo Low",-8,61,lt.NoteheadBlack,lt.NoteheadHalf,lt.NoteheadWhole,lt.NoteheadParenthesis,ut.Inside),jt.create(107,"Bongo Low",-16,61,lt.NoteheadXBlack,lt.NoteheadXBlack,lt.NoteheadXBlack),jt.create(66,"Timbale Low",10,66,lt.NoteheadBlack,lt.NoteheadHalf,lt.NoteheadWhole),jt.create(65,"Timbale High",9,65,lt.NoteheadBlack,lt.NoteheadHalf,lt.NoteheadWhole),jt.create(68,"Agogo Low",12,68,lt.NoteheadBlack,lt.NoteheadHalf,lt.NoteheadWhole),jt.create(67,"Agogo High",11,67,lt.NoteheadBlack,lt.NoteheadHalf,lt.NoteheadWhole),jt.create(64,"Conga Low",17,64,lt.NoteheadBlack,lt.NoteheadHalf,lt.NoteheadWhole),jt.create(108,"Conga Low",16,64,lt.NoteheadXBlack,lt.NoteheadXBlack,lt.NoteheadXBlack),jt.create(109,"Conga Low",15,64,lt.NoteheadBlack,lt.NoteheadHalf,lt.NoteheadWhole,lt.NoteheadParenthesis,ut.Inside),jt.create(63,"Conga High",14,63,lt.NoteheadBlack,lt.NoteheadHalf,lt.NoteheadWhole),jt.create(110,"Conga High",13,63,lt.NoteheadXBlack,lt.NoteheadXBlack,lt.NoteheadXBlack),jt.create(62,"Conga High",19,62,lt.NoteheadBlack,lt.NoteheadHalf,lt.NoteheadWhole,lt.NoteheadParenthesis,ut.Inside),jt.create(72,"Whistle Low",-11,72,lt.NoteheadBlack,lt.NoteheadHalf,lt.NoteheadWhole),jt.create(71,"Whistle High",-17,71,lt.NoteheadBlack,lt.NoteheadHalf,lt.NoteheadWhole),jt.create(73,"Guiro",38,73,lt.NoteheadBlack,lt.NoteheadHalf,lt.NoteheadWhole),jt.create(74,"Guiro",37,74,lt.NoteheadBlack,lt.NoteheadHalf,lt.NoteheadWhole),jt.create(86,"Surdo",36,86,lt.NoteheadBlack,lt.NoteheadHalf,lt.NoteheadWhole),jt.create(87,"Surdo",35,87,lt.NoteheadXBlack,lt.NoteheadXBlack,lt.NoteheadXBlack,lt.NoteheadParenthesis,ut.Inside),jt.create(54,"Tambourine",3,54,lt.NoteheadTriangleUpBlack,lt.NoteheadTriangleUpBlack,lt.NoteheadTriangleUpBlack),jt.create(111,"Tambourine",2,54,lt.NoteheadTriangleUpBlack,lt.NoteheadTriangleUpBlack,lt.NoteheadTriangleUpBlack,lt.StringsUpBow,ut.Above),jt.create(112,"Tambourine",1,54,lt.NoteheadTriangleUpBlack,lt.NoteheadTriangleUpBlack,lt.NoteheadTriangleUpBlack,lt.StringsDownBow,ut.Above),jt.create(113,"Tambourine",-7,54,lt.NoteheadXBlack,lt.NoteheadXBlack,lt.NoteheadXBlack),jt.create(79,"Cuica",30,79,lt.NoteheadBlack,lt.NoteheadHalf,lt.NoteheadWhole),jt.create(78,"Cuica",29,78,lt.NoteheadXBlack,lt.NoteheadXBlack,lt.NoteheadXBlack),jt.create(58,"Vibraslap",28,58,lt.NoteheadBlack,lt.NoteheadHalf,lt.NoteheadWhole),jt.create(81,"Triangle",27,81,lt.NoteheadBlack,lt.NoteheadHalf,lt.NoteheadWhole),jt.create(80,"Triangle",26,80,lt.NoteheadXBlack,lt.NoteheadXBlack,lt.NoteheadXBlack,lt.NoteheadParenthesis,ut.Inside),jt.create(114,"Grancassa",25,43,lt.NoteheadBlack,lt.NoteheadHalf,lt.NoteheadWhole),jt.create(115,"Piatti",18,49,lt.NoteheadBlack,lt.NoteheadHalf,lt.NoteheadWhole),jt.create(116,"Piatti",24,49,lt.NoteheadXBlack,lt.NoteheadXBlack,lt.NoteheadXBlack),jt.create(69,"Cabasa",23,69,lt.NoteheadBlack,lt.NoteheadHalf,lt.NoteheadWhole),jt.create(117,"Cabasa",22,69,lt.NoteheadBlack,lt.NoteheadHalf,lt.NoteheadWhole,lt.StringsUpBow,ut.Outside),jt.create(85,"Castanets",21,85,lt.NoteheadBlack,lt.NoteheadHalf,lt.NoteheadWhole),jt.create(75,"Claves",20,75,lt.NoteheadBlack,lt.NoteheadHalf,lt.NoteheadWhole),jt.create(70,"Left Maraca",-12,70,lt.NoteheadBlack,lt.NoteheadHalf,lt.NoteheadWhole),jt.create(118,"Left Maraca",-13,70,lt.NoteheadBlack,lt.NoteheadHalf,lt.NoteheadWhole,lt.StringsUpBow,ut.Outside),jt.create(119,"Right Maraca",-14,70,lt.NoteheadBlack,lt.NoteheadHalf,lt.NoteheadWhole),jt.create(120,"Right Maraca",-15,70,lt.NoteheadBlack,lt.NoteheadHalf,lt.NoteheadWhole,lt.StringsUpBow,ut.Outside),jt.create(82,"Shaker",-23,82,lt.NoteheadBlack,lt.NoteheadHalf,lt.NoteheadWhole),jt.create(122,"Shaker",-24,82,lt.NoteheadBlack,lt.NoteheadHalf,lt.NoteheadWhole,lt.StringsUpBow,ut.Outside),jt.create(84,"Bell Tree",-18,53,lt.NoteheadBlack,lt.NoteheadHalf,lt.NoteheadWhole),jt.create(123,"Bell Tree",-19,53,lt.NoteheadBlack,lt.NoteheadHalf,lt.NoteheadWhole,lt.StringsUpBow,ut.Outside),jt.create(83,"Jingle Bell",-20,53,lt.NoteheadBlack,lt.NoteheadHalf,lt.NoteheadWhole),jt.create(83,"Tinkle Bell",-20,53,lt.NoteheadBlack,lt.NoteheadHalf,lt.NoteheadWhole),jt.create(124,"Golpe",-21,62,lt.NoteheadNull,lt.NoteheadNull,lt.NoteheadNull,lt.GuitarGolpe,ut.Below),jt.create(125,"Golpe",-22,62,lt.NoteheadNull,lt.NoteheadNull,lt.NoteheadNull,lt.GuitarGolpe,ut.Above),jt.create(39,"Hand Clap",3,39,lt.NoteheadBlack,lt.NoteheadHalf,lt.NoteheadWhole),jt.create(40,"Electric Snare",3,40,lt.NoteheadBlack,lt.NoteheadHalf,lt.NoteheadWhole),jt.create(31,"Sticks",3,40,lt.NoteheadSlashedBlack2,lt.NoteheadSlashedBlack2,lt.NoteheadSlashedBlack2),jt.create(41,"Very Low Floor Tom",5,41,lt.NoteheadBlack,lt.NoteheadHalf,lt.NoteheadWhole),jt.create(59,"Ride Cymbal 2",2,59,lt.NoteheadXBlack,lt.NoteheadXBlack,lt.NoteheadXBlack,lt.PictEdgeOfCymbal,ut.Above),jt.create(126,"Ride Cymbal 2",2,59,lt.NoteheadXBlack,lt.NoteheadXBlack,lt.NoteheadXBlack),jt.create(127,"Ride Cymbal 2",2,59,lt.NoteheadDiamondWhite,lt.NoteheadDiamondWhite,lt.NoteheadDiamondWhite),jt.create(29,"Ride Cymbal 2",2,59,lt.NoteheadXBlack,lt.NoteheadXBlack,lt.NoteheadXBlack,lt.ArticStaccatoAbove,ut.Outside),jt.create(30,"Reverse Cymbal",-3,49,lt.NoteheadXBlack,lt.NoteheadXBlack,lt.NoteheadXBlack),jt.create(33,"Metronome",3,37,lt.NoteheadXBlack,lt.NoteheadXBlack,lt.NoteheadXBlack),jt.create(34,"Metronome",3,38,lt.NoteheadBlack,lt.NoteheadBlack,lt.NoteheadBlack)].map(t=>[t.uniqueId,t]));static xt=new Map([["Snare (hit)","Snare.38"],["Snare (side stick)","Snare.37"],["Snare (rim shot)","Snare.91"],["Hi-Hat (closed)","Charley.42"],["Hi-Hat (half)","Charley.92"],["Hi-Hat (open)","Charley.46"],["Pedal Hi-Hat (hit)","Charley.44"],["Kick (hit)","Acoustic Kick Drum.35"],["Kick (hit) 2","Kick Drum.36"],["High Floor Tom (hit)","Tom Very High.50"],["High Tom (hit)","Tom High.48"],["Mid Tom (hit)","Tom Medium.47"],["Low Tom (hit)","Tom Low.45"],["Very Low Tom (hit)","Tom Very Low.43"],["Ride (edge)","Ride.93"],["Ride (middle)","Ride.51"],["Ride (bell)","Ride.53"],["Ride (choke)","Ride.94"],["Splash (hit)","Splash.55"],["Splash (choke)","Splash.95"],["China (hit)","China.52"],["China (choke)","China.96"],["Crash high (hit)","Crash High.49"],["Crash high (choke)","Crash High.97"],["Crash medium (hit)","Crash Medium.57"],["Crash medium (choke)","Crash Medium.98"],["Cowbell low (hit)","Cowbell Low.99"],["Cowbell low (tip)","Cowbell Low.100"],["Cowbell medium (hit)","Cowbell Medium.56"],["Cowbell medium (tip)","Cowbell Medium.101"],["Cowbell high (hit)","Cowbell High.102"],["Cowbell high (tip)","Cowbell High.103"],["Woodblock low (hit)","Woodblock Low.77"],["Woodblock high (hit)","Woodblock High.76"],["Bongo High (hit)","Bongo High.60"],["Bongo High (mute)","Bongo High.104"],["Bongo High (slap)","Bongo High.105"],["Bongo Low (hit)","Bongo Low.61"],["Bongo Low (mute)","Bongo Low.106"],["Bongo Low (slap)","Bongo Low.107"],["Timbale low (hit)","Timbale Low.66"],["Timbale high (hit)","Timbale High.65"],["Agogo low (hit)","Agogo Low.68"],["Agogo high (hit)","Agogo High.67"],["Conga low (hit)","Conga Low.64"],["Conga low (slap)","Conga Low.108"],["Conga low (mute)","Conga Low.109"],["Conga high (hit)","Conga High.63"],["Conga high (slap)","Conga High.110"],["Conga high (mute)","Conga High.62"],["Whistle low (hit)","Whistle Low.72"],["Whistle high (hit)","Whistle High.71"],["Guiro (hit)","Guiro.73"],["Guiro (scrap-return)","Guiro.74"],["Surdo (hit)","Surdo.86"],["Surdo (mute)","Surdo.87"],["Tambourine (hit)","Tambourine.54"],["Tambourine (return)","Tambourine.111"],["Tambourine (roll)","Tambourine.112"],["Tambourine (hand)","Tambourine.113"],["Cuica (open)","Cuica.79"],["Cuica (mute)","Cuica.78"],["Vibraslap (hit)","Vibraslap.58"],["Triangle (hit)","Triangle.81"],["Triangle (mute)","Triangle.80"],["Grancassa (hit)","Grancassa.114"],["Piatti (hit)","Piatti.115"],["Piatti (hand)","Piatti.116"],["Cabasa (hit)","Cabasa.69"],["Cabasa (return)","Cabasa.117"],["Castanets (hit)","Castanets.85"],["Claves (hit)","Claves.75"],["Left Maraca (hit)","Left Maraca.70"],["Left Maraca (return)","Left Maraca.118"],["Right Maraca (hit)","Right Maraca.119"],["Right Maraca (return)","Right Maraca.120"],["Shaker (hit)","Shaker.82"],["Shaker (return)","Shaker.122"],["Bell Tree (hit)","Bell Tree.84"],["Bell Tree (return)","Bell Tree.123"],["Jingle Bell (hit)","Jingle Bell.83"],["Tinkle Bell (hit)","Tinkle Bell.83"],["Golpe (thumb)","Golpe.124"],["Golpe (finger)","Golpe.125"],["Hand Clap (hit)","Hand Clap.39"],["Electric Snare (hit)","Electric Snare.40"],["Snare (side stick) 2","Sticks.31"],["Low Floor Tom (hit)","Very Low Floor Tom.41"],["Ride (edge) 2","Ride Cymbal 2.59"],["Ride (middle) 2","Ride Cymbal 2.126"],["Ride (bell) 2","Ride Cymbal 2.127"],["Ride (choke) 2","Ride Cymbal 2.29"],["Reverse Cymbal (hit)","Reverse Cymbal.30"],["Metronome (hit)","Metronome.33"],["Metronome (bell)","Metronome.34"]]);static Mt=[[35,35,35],[38,91,37],[99,100,99],[56,100,56],[102,103,102],[43,43,43],[45,45,45],[47,47,47],[48,48,48],[50,50,50],[42,92,46],[44,44,44],[57,98,57],[49,97,49],[55,95,55],[51,93,127],[52,96,52]];static articulationFromElementVariation(t,e){return t<Jt.Mt.length?(e>=Jt.Mt.length&&(e=0),Jt.Mt[t][e]):38}static getArticulationName(t){const e=Jt.getArticulation(t);if(e){const t=e.uniqueId;for(const[e,s]of Jt.instrumentArticulationNames)if(s===t)return e}else{const e=`.${t.percussionArticulation}`;for(const[t,s]of Jt.instrumentArticulationNames)if(s.endsWith(e))return t}return"Snare (hit)"}static getArticulation(t){const e=t.percussionArticulation;if(e<0)return null;const s=t.beat.voice.bar.staff.track.percussionArticulations;return e<s.length?s[e]:Jt.getArticulationById(e)}static vt;static Nt(){let t=Jt.vt;if(!t){t=new Map;for(const e of Jt.instrumentArticulations.values())t.set(e.id,e);Jt.vt=t}return t}static instrumentArticulationIds(){return Jt.Nt().keys()}static getArticulationById(t){const e=Jt.Nt();return e.has(t)?e.get(t):null}static getElementAndVariation(t){const e=Jt.getArticulation(t);if(!e)return[-1,-1];for(let t=0;t<Jt.Mt.length;t++){const s=Jt.Mt[t];for(let i=0;i<s.length;i++){const n=Jt.getArticulationById(s[i]);if(n?.outputMidiNumber===e.outputMidiNumber)return[t,i]}}return[-1,-1]}static instrumentArticulationNames=Jt.Pt([new Map([["Hand (hit)","Bongo Low.61"],["Tinkle Bell (hat)","Tingle Bell.83"],["Cymbal (hit)","Reverse Cymbal.30"],["Snare (side stick) 3","Snare.37"],["Snare (hit) 2","Snare.38"],["Snare (hit) 3","Snare.40"],["Agogo tow (hit)","Agogo Low.68"],["Triangle (rnute)","Triangle.80"],["Hand (mute)","Bongo High.104"],["Hand (slap)","Bongo High.105"],["Hand (mute) 2","Bongo Low.106"],["Hand (slap) 2","Bongo Low.107"],["Piatti (hat)","Piatti.115"],["Bell Tee (return)","Bell Tree.123"]]),Jt.xt]);static Pt(t){const e=new Map(t[0]);for(let s=1;s<t.length;s++)for(const[i,n]of t[s])e.set(i,n);return e}static Ct;static tryMatchKnownArticulation(t){let e=Jt.Ct;if(!e){e=new Map;for(const t of Jt.instrumentArticulations.values())e.has(t.outputMidiNumber)||e.set(t.outputMidiNumber,t);Jt.Ct=e}return e.has(t.outputMidiNumber)?e.get(t.outputMidiNumber).id:-1}static Et;static getInstrumentArticulationByUniqueId(t){let e=Jt.Et;if(!e){e=new Map;for(const t of Jt.instrumentArticulations.values())e.set(t.uniqueId,t);Jt.Et=e}return e.has(t)?e.get(t):void 0}}!function(t){t[t.None=0]="None",t[t.InvertedTurn=1]="InvertedTurn",t[t.Turn=2]="Turn",t[t.UpperMordent=3]="UpperMordent",t[t.LowerMordent=4]="LowerMordent"}(dt||(dt={}));class qt{tieDestinationNoteId=-1;tieOriginNoteId=-1;slurDestinationNoteId=-1;slurOriginNoteId=-1;hammerPullDestinationNoteId=-1;hammerPullOriginNoteId=-1;slideTargetNoteId=-1;slideOriginNoteId=-1}!function(t){t[t.Effects=0]="Effects",t[t.StandardNotationNoteHead=1]="StandardNotationNoteHead",t[t.StandardNotationAccidentals=2]="StandardNotationAccidentals",t[t.StandardNotationEffects=3]="StandardNotationEffects",t[t.GuitarTabFretNumber=4]="GuitarTabFretNumber",t[t.GuitarTabEffects=5]="GuitarTabEffects",t[t.SlashNoteHead=6]="SlashNoteHead",t[t.SlashEffects=7]="SlashEffects",t[t.NumberedNumber=8]="NumberedNumber",t[t.NumberedAccidentals=9]="NumberedAccidentals",t[t.NumberedEffects=10]="NumberedEffects"}(ft||(ft={}));class Yt extends q{noteHead;noteHeadCenterOnStem}class Kt{static globalNoteId=0;static resetIds(){Kt.globalNoteId=0}id=Kt.globalNoteId++;index=0;accentuated=u.None;bendType=a.None;bendStyle=r.Default;bendOrigin=null;isContinuedBend=!1;bendPoints=null;maxBendPoint=null;get hasBend(){return null!==this.bendPoints&&this.bendType!==a.None}get isStringed(){return this.string>=0}fret=-1;string=-1;showStringNumber=!1;get isPiano(){return!this.isStringed&&this.octave>=0&&this.tone>=0}octave=-1;tone=-1;get isPercussion(){return!this.isStringed&&this.percussionArticulation>=0}get element(){return this.isPercussion?Jt.getElementAndVariation(this)[0]:-1}get variation(){return this.isPercussion?Jt.getElementAndVariation(this)[1]:-1}percussionArticulation=-1;isVisible=!0;isLeftHandTapped=!1;isHammerPullOrigin=!1;get isHammerPullDestination(){return!!this.hammerPullOrigin}hammerPullOrigin=null;hammerPullDestination=null;get isSlurOrigin(){return!!this.slurDestination}isSlurDestination=!1;slurOrigin=null;slurDestination=null;get isHarmonic(){return this.harmonicType!==f.None}harmonicType=f.None;harmonicValue=0;isGhost=!1;isLetRing=!1;letRingDestination=null;isPalmMute=!1;palmMuteDestination=null;isDead=!1;isStaccato=!1;slideInType=m.None;slideOutType=g.None;slideTarget=null;slideOrigin=null;vibrato=w.None;tieOrigin=null;tieDestination=null;isTieDestination=!1;get isTieOrigin(){return null!==this.tieDestination}leftHandFinger=d.Unknown;rightHandFinger=d.Unknown;get isFingering(){return this.leftHandFinger!==d.Unknown||this.rightHandFinger!==d.Unknown}trillValue=-1;get trillFret(){return this.trillValue-this.stringTuning}get isTrill(){return this.trillValue>=0}trillSpeed=c.ThirtySecond;durationPercent=1;accidentalMode=p.Default;beat;dynamics=i.F;isEffectSlurOrigin=!1;hasEffectSlur=!1;get isEffectSlurDestination(){return!!this.effectSlurOrigin}effectSlurOrigin=null;effectSlurDestination=null;ornament=dt.None;style;get stringTuning(){return this.beat.voice.bar.staff.capo+Kt.getStringTuning(this.beat.voice.bar.staff,this.string)}static getStringTuning(t,e){return t.tuning.length>0?t.tuning[t.tuning.length-(e-1)-1]:0}get realValue(){return this.calculateRealValue(!0,!0)}get realValueWithoutHarmonic(){return this.calculateRealValue(!0,!1)}calculateRealValue(t,e){const s=t?this.beat.voice.bar.staff.transpositionPitch:0;if(e){let e=this.calculateRealValue(t,!1);return this.isStringed&&(this.harmonicType===f.Natural?e=this.harmonicPitch+this.stringTuning-s:e+=this.harmonicPitch),e}return this.isPercussion?this.percussionArticulation:this.isStringed?this.fret+this.stringTuning-s:this.isPiano?12*this.octave+this.tone-s:0}get harmonicPitch(){if(this.harmonicType===f.None||!this.isStringed)return 0;const t=this.harmonicValue;return zt.isAlmostEqualTo(t,2.4)?36:zt.isAlmostEqualTo(t,2.7)?34:t<3?0:t<=3.5?31:t<=4?28:t<=5?24:t<=6?34:t<=7?19:t<=8.5?36:t<=9?28:t<=10?34:t<=11?0:t<=12?12:t<14?0:t<=15?34:t<=16?28:t<=17?36:t<=18?0:t<=19?19:t<=21?0:t<=22?36:t<=24?24:0}get initialBendValue(){return this.hasBend?Math.floor(this.bendPoints[0].value/2):this.bendOrigin?Math.floor(this.bendOrigin.bendPoints[this.bendOrigin.bendPoints.length-1].value/2):this.isTieDestination&&this.tieOrigin.bendOrigin?Math.floor(this.tieOrigin.bendOrigin.bendPoints[this.tieOrigin.bendOrigin.bendPoints.length-1].value/2):this.beat.hasWhammyBar?Math.floor(this.beat.whammyBarPoints[0].value/2):this.beat.isContinuedWhammy?Math.floor(this.beat.previousBeat.whammyBarPoints[this.beat.previousBeat.whammyBarPoints.length-1].value/2):0}get displayValue(){return this.displayValueWithoutBend+this.initialBendValue}get displayValueWithoutBend(){let t=this.realValue;switch(this.harmonicType!==f.Natural&&this.harmonicType!==f.None&&(t-=this.harmonicPitch),this.beat.ottava){case b.S:t-=24;break;case b._:t-=12;break;case b.Regular:break;case b.T:t+=12;break;case b.M:t+=24}switch(this.beat.voice.bar.clefOttava){case b.S:t-=24;break;case b._:t-=12;break;case b.Regular:break;case b.T:t+=12;break;case b.M:t+=24}return t-this.beat.voice.bar.staff.displayTranspositionPitch}get hasQuarterToneOffset(){return this.hasBend?this.bendPoints[0].value%2!=0:this.bendOrigin?this.bendOrigin.bendPoints[this.bendOrigin.bendPoints.length-1].value%2!=0:this.beat.hasWhammyBar?this.beat.whammyBarPoints[0].value%2!=0:!!this.beat.isContinuedWhammy&&this.beat.previousBeat.whammyBarPoints[this.beat.previousBeat.whammyBarPoints.length-1].value%2!=0}addBendPoint(t){let e=this.bendPoints;null===e&&(e=[],this.bendPoints=e),e.push(t),(!this.maxBendPoint||t.value>this.maxBendPoint.value)&&(this.maxBendPoint=t),this.bendType===a.None&&(this.bendType=a.Custom)}finish(t,e=null){const s=new X(()=>Kt.nextNoteOnSameLine(this)),i=t&&t.notation.notationMode===S.SongBook;if(this.isTieDestination&&(this.chain(e),i&&this.tieOrigin&&this.tieOrigin.isLetRing&&(this.isLetRing=!0)),this.isLetRing&&(s.value&&s.value.isLetRing?this.letRingDestination=s.value:this.letRingDestination=this,i&&this.isTieDestination&&!this.tieOrigin.hasBend&&(this.isVisible=!1)),this.isPalmMute&&(s.value&&s.value.isPalmMute?this.palmMuteDestination=s.value:this.palmMuteDestination=this),this.isHammerPullOrigin){const t=Kt.findHammerPullDestination(this);t?(this.hammerPullDestination=t,t.hammerPullOrigin=this):this.isHammerPullOrigin=!1}switch(this.slideOutType){case g.Shift:case g.Legato:this.slideTarget||(this.slideTarget=s.value),this.slideTarget?this.slideTarget.slideOrigin=this:this.slideOutType=g.None}let n=null;this.isHammerPullOrigin&&this.hammerPullDestination?n=this.hammerPullDestination:this.slideOutType===g.Legato&&this.slideTarget&&(n=this.slideTarget),n&&(this.hasEffectSlur=!0,this.effectSlurOrigin&&this.beat.pickStroke===ct.None?(this.effectSlurOrigin.effectSlurDestination=n,this.effectSlurOrigin.effectSlurDestination.effectSlurOrigin=this.effectSlurOrigin,this.effectSlurOrigin=null):(this.isEffectSlurOrigin=!0,this.effectSlurDestination=n,this.effectSlurDestination.effectSlurOrigin=this));const r=this.bendPoints,h=null!=r&&r.length>0;if(h){const t=this.isTieDestination&&this.tieOrigin.hasBend;this.isContinuedBend=t}else this.bendType=a.None;if(h&&this.bendType===a.Custom)if(4===r.length){const t=r[0],e=r[1],s=r[2],i=r[3];e.value===s.value?i.value>t.value?e.value>i.value?this.bendType=a.BendRelease:!this.isContinuedBend&&t.value>0?(this.bendType=a.PrebendBend,r.splice(2,1),r.splice(1,1)):(this.bendType=a.Bend,r.splice(2,1),r.splice(1,1)):i.value<t.value?this.isContinuedBend?(this.bendType=a.Release,r.splice(2,1),r.splice(1,1)):(this.bendType=a.PrebendRelease,r.splice(2,1),r.splice(1,1)):e.value>t.value?this.bendType=a.BendRelease:t.value>0&&!this.isContinuedBend?(this.bendType=a.Prebend,r.splice(2,1),r.splice(1,1)):(this.bendType=a.Hold,r.splice(2,1),r.splice(1,1)):J.warning("Model","Unsupported bend type detected, fallback to custom",null)}else if(3===r.length){const t=r[0],e=r[1],s=r[2];s.value>t.value?e.value>s.value?(this.bendType=a.BendRelease,r.splice(1,0,new U(e.offset,e.value))):!this.isContinuedBend&&t.value>0?(this.bendType=a.PrebendBend,r.splice(1,1)):(this.bendType=a.Bend,r.splice(1,1)):s.value<t.value?this.isContinuedBend?(this.bendType=a.Release,r.splice(1,1)):(this.bendType=a.PrebendRelease,r.splice(1,1)):e.value>t.value?(this.bendType=a.BendRelease,r.splice(1,0,new U(e.offset,e.value))):t.value>0&&!this.isContinuedBend?(this.bendType=a.Prebend,r.splice(1,1)):(this.bendType=a.Hold,r.splice(1,1))}else if(2===r.length){const t=r[0],e=r[1];e.value>t.value?!this.isContinuedBend&&t.value>0?this.bendType=a.PrebendBend:this.bendType=a.Bend:e.value<t.value?this.isContinuedBend?this.bendType=a.Release:this.bendType=a.PrebendRelease:t.value>0&&!this.isContinuedBend?this.bendType=a.Prebend:this.bendType=a.Hold}this.initialBendValue>0&&(this.accidentalMode=p.Default)}static Ft=3;static nextNoteOnSameLine(t){let e=t.beat.nextBeat;for(;e&&e.voice.bar.index<=t.beat.voice.bar.index+Kt.Ft;){const s=e.getNoteOnString(t.string);if(s)return s;e=e.nextBeat}return null}static findHammerPullDestination(t){let e=t.beat.nextBeat;for(;e&&e.voice.bar.index<=t.beat.voice.bar.index+Kt.Ft;){let s=e.getNoteOnString(t.string);if(s)return s;for(let i=t.string;i>0;i--)if(s=e.getNoteOnString(i),s){if(s.isLeftHandTapped)return s;break}for(let i=t.string;i<=t.beat.voice.bar.staff.tuning.length;i++)if(s=e.getNoteOnString(i),s){if(s.isLeftHandTapped)return s;break}e=e.nextBeat}return null}static findTieOrigin(t){let e=t.beat.previousBeat;for(;e&&e.voice.bar.index>=t.beat.voice.bar.index-Kt.Ft;){if(t.isStringed){const s=e.getNoteOnString(t.string);if(s)return s}else if(-1===t.octave&&-1===t.tone){if(t.index<e.notes.length)return e.notes[t.index]}else{const s=e.getNoteWithRealValue(t.realValue);if(s)return s}e=e.previousBeat}return null}static At="NoteIdLookup";Dt=null;chain(t=null){if(null!==t)if(null!==this.Dt){let e;t.has(Kt.At)?e=t.get(Kt.At):(e=new Map,t.set(Kt.At,e)),-1===this.Dt.hammerPullDestinationNoteId&&-1===this.Dt.tieDestinationNoteId&&-1===this.Dt.slurDestinationNoteId&&-1===this.Dt.slideTargetNoteId||e.set(this.id,this),-1!==this.Dt.hammerPullOriginNoteId&&(this.hammerPullOrigin=e.get(this.Dt.hammerPullOriginNoteId),this.hammerPullOrigin.hammerPullDestination=this),-1!==this.Dt.tieOriginNoteId&&(this.tieOrigin=e.get(this.Dt.tieOriginNoteId),this.tieOrigin.tieDestination=this),-1!==this.Dt.slurOriginNoteId&&(this.slurOrigin=e.get(this.Dt.slurOriginNoteId),this.slurOrigin.slurDestination=this),-1!==this.Dt.slideOriginNoteId&&(this.slideOrigin=e.get(this.Dt.slideOriginNoteId),this.slideOrigin.slideTarget=this),this.Dt=null}else{if(!this.isTieDestination&&null===this.tieOrigin)return;const t=this.tieOrigin??Kt.findTieOrigin(this);t?(t.tieDestination=this,this.tieOrigin=t,this.fret=t.fret,this.octave=t.octave,this.tone=t.tone,t.hasBend&&(this.bendOrigin=this.tieOrigin)):this.isTieDestination=!1}}toJson(t){null!==this.tieDestination&&t.set("tiedestinationnoteid",this.tieDestination.id),null!==this.tieOrigin&&t.set("tieoriginnoteid",this.tieOrigin.id),null!==this.slurDestination&&t.set("slurdestinationnoteid",this.slurDestination.id),null!==this.slurOrigin&&t.set("sluroriginnoteid",this.slurOrigin.id),null!==this.hammerPullOrigin&&t.set("hammerpulloriginnoteid",this.hammerPullOrigin.id),null!==this.hammerPullDestination&&t.set("hammerpulldestinationnoteid",this.hammerPullDestination.id),null!==this.slideTarget&&t.set("slidetargetnoteid",this.slideTarget.id),null!==this.slideOrigin&&t.set("slideoriginnoteid",this.slideOrigin.id)}setProperty(t,e){switch(t){case"tiedestinationnoteid":return null==this.Dt&&(this.Dt=new qt),this.Dt.tieDestinationNoteId=e,!0;case"tieoriginnoteid":return null==this.Dt&&(this.Dt=new qt),this.Dt.tieOriginNoteId=e,!0;case"slurdestinationnoteid":return null==this.Dt&&(this.Dt=new qt),this.Dt.slurDestinationNoteId=e,!0;case"sluroriginnoteid":return null==this.Dt&&(this.Dt=new qt),this.Dt.slurOriginNoteId=e,!0;case"hammerpulloriginnoteid":return null==this.Dt&&(this.Dt=new qt),this.Dt.hammerPullOriginNoteId=e,!0;case"hammerpulldestinationnoteid":return null==this.Dt&&(this.Dt=new qt),this.Dt.hammerPullDestinationNoteId=e,!0;case"slidetargetnoteid":return null==this.Dt&&(this.Dt=new qt),this.Dt.slideTargetNoteId=e,!0;case"slideoriginnoteid":return null==this.Dt&&(this.Dt=new qt),this.Dt.slideOriginNoteId=e,!0}return!1}}class Qt{static Lt=1920;static Wt=960;static Ot=480;static Rt=240;static It=120;static Gt=60;static Ht=30;static Vt=15;static $t=[Qt.Lt,Qt.Wt,Qt.Ot,Qt.Rt,Qt.It,Qt.Gt,Qt.Ht,Qt.Vt];Ut=!0;totalDuration=0;beats=[];voice;isFull=!1;constructor(t){this.voice=t}check(t){if(0===this.beats.length)return this.beats.push(t),this.totalDuration+=t.playbackDuration,!0;if(t.graceType!==l.None)return!0;if(t.voice!==this.voice||this.isFull||t.tupletNumerator!==this.beats[0].tupletNumerator||t.tupletDenominator!==this.beats[0].tupletDenominator)return!1;if(t.displayDuration!==this.beats[0].displayDuration&&(this.Ut=!1),this.beats.push(t),this.totalDuration+=t.displayDuration,this.Ut)this.beats.length===this.beats[0].tupletNumerator&&(this.isFull=!0);else{const t=this.beats[0].tupletNumerator/this.beats[0].tupletDenominator|0;for(const e of Qt.$t)if(this.totalDuration===e*t){this.isFull=!0;break}}return!0}}!function(t){t[t.None=0]="None",t[t.Custom=1]="Custom",t[t.Dive=2]="Dive",t[t.Dip=3]="Dip",t[t.Hold=4]="Hold",t[t.Predive=5]="Predive",t[t.PrediveDive=6]="PrediveDive"}(pt||(pt={})),function(t){t[t.None=0]="None",t[t.Thumb=1]="Thumb",t[t.Finger=2]="Finger"}(bt||(bt={})),function(t){t[t.None=0]="None",t[t.FadeIn=1]="FadeIn",t[t.FadeOut=2]="FadeOut",t[t.VolumeSwell=3]="VolumeSwell"}(mt||(mt={})),function(t){t[t.None=0]="None",t[t.Open=1]="Open",t[t.Closed=2]="Closed"}(gt||(gt={})),function(t){t[t.None=0]="None",t[t.Full=1]="Full",t[t.Half=2]="Half"}(wt||(wt={})),function(t){t[t.None=0]="None",t[t.Ii=1]="Ii",t[t.Mi=2]="Mi",t[t.MiiTriplet=3]="MiiTriplet",t[t.MiiAnapaest=4]="MiiAnapaest",t[t.PmpTriplet=5]="PmpTriplet",t[t.PmpAnapaest=6]="PmpAnapaest",t[t.PeiTriplet=7]="PeiTriplet",t[t.PeiAnapaest=8]="PeiAnapaest",t[t.PaiTriplet=9]="PaiTriplet",t[t.PaiAnapaest=10]="PaiAnapaest",t[t.AmiTriplet=11]="AmiTriplet",t[t.AmiAnapaest=12]="AmiAnapaest",t[t.Ppp=13]="Ppp",t[t.Amii=14]="Amii",t[t.Amip=15]="Amip",t[t.Eami=16]="Eami",t[t.Eamii=17]="Eamii",t[t.Peami=18]="Peami"}(yt||(yt={})),function(t){t[t.Default=0]="Default",t[t.BuzzRoll=1]="BuzzRoll"}(kt||(kt={}));class Zt{static minMarks=0;static maxMarks=5;marks=0;style=kt.Default;getDuration(t){let e=this.marks;e<1&&(e=1);const s=t*Math.pow(2,e);return s<=c.TwoHundredFiftySixth?s:c.TwoHundredFiftySixth}getDurationAsTicks(t){let e=this.marks;e<1&&(e=1);const s=t*Math.pow(2,e);return H.valueToTicks(s)}}!function(t){t[t.Auto=0]="Auto",t[t.ForceSplitToNext=1]="ForceSplitToNext",t[t.ForceMergeWithNext=2]="ForceMergeWithNext",t[t.ForceSplitOnSecondaryToNext=3]="ForceSplitOnSecondaryToNext"}(St||(St={})),function(t){t[t.Effects=0]="Effects",t[t.StandardNotationStem=1]="StandardNotationStem",t[t.StandardNotationFlags=2]="StandardNotationFlags",t[t.StandardNotationBeams=3]="StandardNotationBeams",t[t.StandardNotationTuplet=4]="StandardNotationTuplet",t[t.StandardNotationEffects=5]="StandardNotationEffects",t[t.StandardNotationRests=6]="StandardNotationRests",t[t.GuitarTabStem=7]="GuitarTabStem",t[t.GuitarTabFlags=8]="GuitarTabFlags",t[t.GuitarTabBeams=9]="GuitarTabBeams",t[t.GuitarTabTuplet=10]="GuitarTabTuplet",t[t.GuitarTabEffects=11]="GuitarTabEffects",t[t.GuitarTabRests=12]="GuitarTabRests",t[t.SlashStem=13]="SlashStem",t[t.SlashFlags=14]="SlashFlags",t[t.SlashBeams=15]="SlashBeams",t[t.SlashTuplet=16]="SlashTuplet",t[t.SlashRests=17]="SlashRests",t[t.SlashEffects=18]="SlashEffects",t[t.NumberedDuration=19]="NumberedDuration",t[t.NumberedEffects=20]="NumberedEffects",t[t.NumberedRests=21]="NumberedRests",t[t.NumberedTuplet=22]="NumberedTuplet"}(Bt||(Bt={}));class te extends q{}class ee{static zt=0;static resetIds(){ee.zt=0}id=ee.zt++;index=0;previousBeat=null;nextBeat=null;get isLastOfVoice(){return this.index===this.voice.beats.length-1}voice;notes=[];noteStringLookup=new Map;noteValueLookup=new Map;isEmpty=!1;whammyStyle=r.Default;ottava=b.Regular;fermata=null;isLegatoOrigin=!1;get isLegatoDestination(){return!!this.previousBeat&&this.previousBeat.isLegatoOrigin}minNote=null;maxNote=null;maxStringNote=null;minStringNote=null;duration=c.Quarter;get isRest(){return this.isEmpty||!this.deadSlapped&&0===this.notes.length}get isFullBarRest(){return this.isRest&&1===this.voice.beats.length&&this.duration===c.Whole}isLetRing=!1;isPalmMute=!1;automations=[];dots=0;get fadeIn(){return this.fade===mt.FadeIn}set fadeIn(t){this.fade=t?mt.FadeIn:mt.None}fade=mt.None;lyrics=null;get hasRasgueado(){return this.rasgueado!==yt.None}pop=!1;slap=!1;tap=!1;text=null;slashed=!1;deadSlapped=!1;brushType=h.None;brushDuration=0;tupletDenominator=-1;tupletNumerator=-1;get hasTuplet(){return!(-1===this.tupletDenominator&&-1===this.tupletNumerator||1===this.tupletDenominator&&1===this.tupletNumerator)}tupletGroup=null;isContinuedWhammy=!1;whammyBarType=pt.None;whammyBarPoints=null;maxWhammyPoint=null;minWhammyPoint=null;get hasWhammyBar(){return null!==this.whammyBarPoints&&this.whammyBarType!==pt.None}vibrato=w.None;chordId=null;get hasChord(){return!!this.chordId}get chord(){return this.chordId?this.voice.bar.staff.getChord(this.chordId):null}graceType=l.None;graceGroup=null;graceIndex=-1;pickStroke=ct.None;get isTremolo(){return void 0!==this.tremoloPicking}tremoloPicking;get tremoloSpeed(){const t=this.tremoloPicking;return t?t.getDuration(this.duration):null}set tremoloSpeed(t){if(null===t)return void(this.tremoloPicking=void 0);let e=this.tremoloPicking;switch(void 0===e&&(e=new Zt,this.tremoloPicking=e),t){case c.Eighth:e.marks=1;break;case c.Sixteenth:e.marks=2;break;case c.ThirtySecond:e.marks=3;break;case c.SixtyFourth:e.marks=4;break;case c.OneHundredTwentyEighth:e.marks=5}}crescendo=o.None;displayStart=0;get displayEnd(){return this.displayStart+this.displayDuration}playbackStart=0;displayDuration=0;playbackDuration=0;overrideDisplayDuration;golpe=bt.None;get absoluteDisplayStart(){return this.voice.bar.masterBar.start+this.displayStart}get absolutePlaybackStart(){return this.voice.bar.masterBar.start+this.playbackStart}dynamics=i.F;invertBeamDirection=!1;preferredBeamDirection=null;isEffectSlurOrigin=!1;get isEffectSlurDestination(){return!!this.effectSlurOrigin}effectSlurOrigin=null;effectSlurDestination=null;beamingMode=St.Auto;wahPedal=gt.None;barreFret=-1;barreShape=wt.None;get isBarre(){return this.barreShape!==wt.None&&this.barreFret>=0}rasgueado=yt.None;showTimer=!1;timer=null;style;addWhammyBarPoint(t){let e=this.whammyBarPoints;null===e&&(e=[],this.whammyBarPoints=e),e.push(t),(!this.maxWhammyPoint||t.value>this.maxWhammyPoint.value)&&(this.maxWhammyPoint=t),(!this.minWhammyPoint||t.value<this.minWhammyPoint.value)&&(this.minWhammyPoint=t),this.whammyBarType===pt.None&&(this.whammyBarType=pt.Custom)}removeWhammyBarPoint(t){const e=this.whammyBarPoints;if(null===e||t<0||t>=e.length)return;e.splice(t,1);const s=e[t];if(s===this.maxWhammyPoint){this.maxWhammyPoint=null;for(const t of e)(!this.maxWhammyPoint||t.value>this.maxWhammyPoint.value)&&(this.maxWhammyPoint=t)}if(s===this.minWhammyPoint){this.minWhammyPoint=null;for(const t of e)(!this.minWhammyPoint||t.value<this.minWhammyPoint.value)&&(this.minWhammyPoint=t)}}addNote(t){t.beat=this,t.index=this.notes.length,this.notes.push(t),t.isStringed&&this.noteStringLookup.set(t.string,t)}removeNote(t){const e=this.notes.indexOf(t);e>=0&&(this.notes.splice(e,1),t.isStringed&&this.noteStringLookup.delete(t.string))}getAutomation(t){for(let e=0,s=this.automations.length;e<s;e++){const s=this.automations[e];if(s.type===t)return s}return null}getNoteOnString(t){return this.noteStringLookup.has(t)?this.noteStringLookup.get(t):null}Xt(){if(void 0!==this.overrideDisplayDuration)return this.overrideDisplayDuration;if(this.isFullBarRest)return this.voice.bar.masterBar.calculateDuration();let t=H.toTicks(this.duration);return 2===this.dots?t=H.applyDot(t,!0):1===this.dots&&(t=H.applyDot(t,!1)),this.tupletDenominator>0&&this.tupletNumerator>=0&&(t=H.applyTuplet(t,this.tupletNumerator,this.tupletDenominator)),t}updateDurations(){const t=this.Xt();switch(this.playbackDuration=t,this.graceType){case l.BeforeBeat:case l.OnBeat:switch(this.duration){case c.Sixteenth:this.playbackDuration=H.toTicks(c.SixtyFourth);break;case c.ThirtySecond:this.playbackDuration=H.toTicks(c.OneHundredTwentyEighth);break;default:this.playbackDuration=H.toTicks(c.ThirtySecond)}this.displayDuration=0;break;case l.BendGrace:this.playbackDuration/=2,this.displayDuration=0;break;default:this.displayDuration=t;const e=this.previousBeat;e&&e.graceType===l.BendGrace&&(this.playbackDuration=e.playbackDuration)}}finishTuplet(){const t=this.previousBeat;let e=t?t.tupletGroup:null;(this.hasTuplet||this.graceType!==l.None&&e)&&(t&&e&&e.check(this)||(e=new Qt(this.voice),e.check(this)),this.tupletGroup=e);const s=this.voice.bar.masterBar.calculateDuration(!1),i=[];for(const t of this.automations)0===t.ratioPosition&&(t.ratioPosition=this.playbackStart/s),t.type!==n.Tempo&&i.push(t);this.automations=i}finish(t,e=null){switch(null===this.getAutomation(n.Instrument)&&0===this.index&&0===this.voice.index&&0===this.voice.bar.index&&0===this.voice.bar.staff.index&&this.automations.push($.buildInstrumentAutomation(!1,0,this.voice.bar.staff.track.playbackInfo.program)),this.graceType){case l.OnBeat:case l.BeforeBeat:const t=this.graceGroup.beats.length;this.duration=1===t?c.Eighth:2===t?c.Sixteenth:c.ThirtySecond}this.brushType===h.None&&(this.brushDuration=0);const s=this.tremoloPicking;void 0!==s&&(s.marks<Zt.minMarks||s.marks>Zt.maxMarks)&&(this.tremoloPicking=void 0);const i=t?t.notation.notationMode:S.GuitarPro;let o="grad"===this.text||"grad."===this.text;o&&i===S.SongBook&&(this.text="");let u=!1;this.minNote=null,this.maxNote=null,this.minStringNote=null,this.maxStringNote=null;let d=0,f=!1;for(let s=0,n=this.notes.length;s<n;s++){const n=this.notes[s];if(n.dynamics=this.dynamics,n.finish(t,e),n.isLetRing&&(this.isLetRing=!0),n.isPalmMute&&(this.isPalmMute=!0),i===S.SongBook&&n.hasBend&&this.graceType!==l.BendGrace){if(!n.isTieOrigin)switch(n.bendType){case a.Bend:case a.PrebendRelease:case a.PrebendBend:u=!0}o||n.bendStyle===r.Gradual?(o=!0,n.bendStyle=r.Gradual,u=!1):n.bendStyle=r.Fast}n.isVisible&&(d++,(!this.minNote||n.realValue<this.minNote.realValue)&&(this.minNote=n),(!this.maxNote||n.realValue>this.maxNote.realValue)&&(this.maxNote=n),(!this.minStringNote||n.string<this.minStringNote.string)&&(this.minStringNote=n),(!this.maxStringNote||n.string>this.maxStringNote.string)&&(this.maxStringNote=n),n.hasEffectSlur&&(f=!0))}if(f&&(this.effectSlurOrigin?(this.effectSlurOrigin.effectSlurDestination=this.nextBeat,this.effectSlurOrigin.effectSlurDestination&&(this.effectSlurOrigin.effectSlurDestination.effectSlurOrigin=this.effectSlurOrigin),this.effectSlurOrigin=null):(this.isEffectSlurOrigin=!0,this.effectSlurDestination=this.nextBeat,this.effectSlurDestination&&(this.effectSlurDestination.effectSlurOrigin=this))),this.notes.length>0&&0===d&&(this.isEmpty=!0),this.isRest||this.isLetRing&&this.isPalmMute)this.isRest&&this.previousBeat&&t&&t.notation.notationMode===S.GuitarPro&&(this.previousBeat.isLetRing&&(this.isLetRing=!0),this.previousBeat.isPalmMute&&(this.isPalmMute=!0));else{let t=this.previousBeat;for(;t&&t.isRest;)this.isLetRing||(t.isLetRing=!1),this.isPalmMute||(t.isPalmMute=!1),t=t.previousBeat}const p=this.whammyBarPoints,b=null!==p&&p.length>0;if(b){const t=!!this.previousBeat&&this.previousBeat.hasWhammyBar;this.isContinuedWhammy=t}else this.whammyBarType=pt.None;if(b&&this.whammyBarType===pt.Custom)if(i===S.SongBook&&(this.whammyStyle=o?r.Gradual:r.Fast),4===p.length){const t=p[0],e=p[1],s=p[2],n=p[3];e.value===s.value&&(t.value<e.value&&e.value<n.value||t.value>e.value&&e.value>n.value?(0===t.value||this.isContinuedWhammy?this.whammyBarType=pt.Dive:this.whammyBarType=pt.PrediveDive,p.splice(2,1),p.splice(1,1)):t.value>e.value&&e.value<n.value||t.value<e.value&&e.value>n.value?(this.whammyBarType=pt.Dip,e.offset!==s.offset&&i!==S.SongBook||p.splice(2,1)):t.value===e.value&&e.value===n.value&&(0===t.value||this.isContinuedWhammy?this.whammyBarType=pt.Hold:this.whammyBarType=pt.Predive,p.splice(2,1),p.splice(1,1)))}else if(3===p.length){const t=p[0],e=p[1],s=p[2];t.value<e.value&&e.value<s.value||t.value>e.value&&e.value>s.value?(0===t.value||this.isContinuedWhammy?this.whammyBarType=pt.Dive:this.whammyBarType=pt.PrediveDive,p.splice(1,1)):t.value>e.value&&e.value<s.value||t.value<e.value&&e.value>s.value?this.whammyBarType=pt.Dip:t.value===e.value&&e.value===s.value&&(0===t.value||this.isContinuedWhammy?this.whammyBarType=pt.Hold:this.whammyBarType=pt.Predive,p.splice(1,1))}else if(2===p.length){const t=p[0],e=p[1];t.value<e.value||t.value>e.value?0===t.value||this.isContinuedWhammy?this.whammyBarType=pt.Dive:this.whammyBarType=pt.PrediveDive:t.value===e.value&&(0===t.value||this.isContinuedWhammy?this.whammyBarType=pt.Hold:this.whammyBarType=pt.Predive)}if(this.updateDurations(),u){const t=he.clone(this);t.id=ee.zt++,t.pickStroke=ct.None;for(let e=0,s=t.notes.length;e<s;e++){const s=t.notes[e],i=this.notes[e];if(s.bendType=a.None,s.maxBendPoint=null,s.bendPoints=null,s.bendStyle=r.Default,s.id=Kt.globalNoteId++,i.isTieOrigin&&(s.tieDestination=i.tieDestination,i.tieDestination.tieOrigin=s),i.isTieDestination&&(s.tieOrigin=i.tieOrigin?i.tieOrigin:null,i.tieOrigin.tieDestination=s),i.hasBend&&i.isTieOrigin){const t=Kt.findTieOrigin(i);if(t&&t.hasBend){s.bendType=a.Hold;const t=i.bendPoints[i.bendPoints.length-1];s.addBendPoint(new U(0,t.value)),s.addBendPoint(new U(U.MaxPosition,t.value))}}s.isTieDestination=!0}this.graceType=l.BendGrace,this.graceGroup=new it,this.graceGroup.addBeat(this),this.graceGroup.isComplete=!0,this.graceGroup.finish(),this.updateDurations(),this.voice.insertBeat(this,t),t.graceGroup=new it,t.graceGroup.addBeat(this),t.graceGroup.isComplete=!0,t.graceGroup.finish()}}isBefore(t){return this.voice.bar.index<t.voice.bar.index||t.voice.bar.index===this.voice.bar.index&&this.index<t.index}isAfter(t){return this.voice.bar.index>t.voice.bar.index||t.voice.bar.index===this.voice.bar.index&&this.index>t.index}hasNoteOnString(t){return this.noteStringLookup.has(t)}getNoteWithRealValue(t){return this.noteValueLookup.has(t)?this.noteValueLookup.get(t):null}chain(t=null){for(const e of this.notes)this.noteValueLookup.set(e.realValue,e),e.chain(t)}}class se{static clone(t){const e=new U;return e.offset=t.offset,e.value=t.value,e}}class ie{static clone(t){const e=new Kt;if(e.index=t.index,e.accentuated=t.accentuated,e.bendType=t.bendType,e.bendStyle=t.bendStyle,e.isContinuedBend=t.isContinuedBend,t.bendPoints){e.bendPoints=[];for(const s of t.bendPoints)e.addBendPoint(se.clone(s))}return e.fret=t.fret,e.string=t.string,e.showStringNumber=t.showStringNumber,e.octave=t.octave,e.tone=t.tone,e.percussionArticulation=t.percussionArticulation,e.isVisible=t.isVisible,e.isLeftHandTapped=t.isLeftHandTapped,e.isHammerPullOrigin=t.isHammerPullOrigin,e.isSlurDestination=t.isSlurDestination,e.harmonicType=t.harmonicType,e.harmonicValue=t.harmonicValue,e.isGhost=t.isGhost,e.isLetRing=t.isLetRing,e.isPalmMute=t.isPalmMute,e.isDead=t.isDead,e.isStaccato=t.isStaccato,e.slideInType=t.slideInType,e.slideOutType=t.slideOutType,e.vibrato=t.vibrato,e.isTieDestination=t.isTieDestination,e.leftHandFinger=t.leftHandFinger,e.rightHandFinger=t.rightHandFinger,e.trillValue=t.trillValue,e.trillSpeed=t.trillSpeed,e.durationPercent=t.durationPercent,e.accidentalMode=t.accidentalMode,e.dynamics=t.dynamics,e.ornament=t.ornament,e}}class ne{static clone(t){const e=new V;return e.barOccurence=t.barOccurence,e.millisecondOffset=t.millisecondOffset,e}}class re{static clone(t){const e=new $;return e.isLinear=t.isLinear,e.type=t.type,e.value=t.value,e.syncPointValue=t.syncPointValue?ne.clone(t.syncPointValue):void 0,e.ratioPosition=t.ratioPosition,e.text=t.text,e.isVisible=t.isVisible,e}}class ae{static clone(t){const e=new Zt;return e.marks=t.marks,e.style=t.style,e}}class he{static clone(t){const e=new ee;e.index=t.index,e.notes=[];for(const s of t.notes)e.addNote(ie.clone(s));e.isEmpty=t.isEmpty,e.whammyStyle=t.whammyStyle,e.ottava=t.ottava,e.isLegatoOrigin=t.isLegatoOrigin,e.duration=t.duration,e.isLetRing=t.isLetRing,e.isPalmMute=t.isPalmMute,e.automations=[];for(const s of t.automations)e.automations.push(re.clone(s));if(e.dots=t.dots,e.fade=t.fade,e.lyrics=t.lyrics?t.lyrics.slice():null,e.pop=t.pop,e.slap=t.slap,e.tap=t.tap,e.text=t.text,e.slashed=t.slashed,e.deadSlapped=t.deadSlapped,e.brushType=t.brushType,e.brushDuration=t.brushDuration,e.tupletDenominator=t.tupletDenominator,e.tupletNumerator=t.tupletNumerator,e.isContinuedWhammy=t.isContinuedWhammy,e.whammyBarType=t.whammyBarType,t.whammyBarPoints){e.whammyBarPoints=[];for(const s of t.whammyBarPoints)e.addWhammyBarPoint(se.clone(s))}return e.vibrato=t.vibrato,e.chordId=t.chordId,e.graceType=t.graceType,e.pickStroke=t.pickStroke,e.tremoloPicking=t.tremoloPicking?ae.clone(t.tremoloPicking):void 0,e.crescendo=t.crescendo,e.displayStart=t.displayStart,e.playbackStart=t.playbackStart,e.displayDuration=t.displayDuration,e.playbackDuration=t.playbackDuration,e.overrideDisplayDuration=t.overrideDisplayDuration,e.golpe=t.golpe,e.dynamics=t.dynamics,e.invertBeamDirection=t.invertBeamDirection,e.preferredBeamDirection=t.preferredBeamDirection,e.isEffectSlurOrigin=t.isEffectSlurOrigin,e.beamingMode=t.beamingMode,e.wahPedal=t.wahPedal,e.barreFret=t.barreFret,e.barreShape=t.barreShape,e.rasgueado=t.rasgueado,e.showTimer=t.showTimer,e.timer=t.timer,e}}class oe{static jt(t){const e=new Map;for(const[s,i]of t)e.has(i)||e.set(i,s);return e}static whammyType=new Map([["custom",1],["dive",2],["dip",3],["hold",4],["predive",5],["predivedive",6]]);static whammyTypeReversed=oe.jt(oe.whammyType);static bendStyle=new Map([["default",0],["gradual",1],["fast",2]]);static bendStyleReversed=oe.jt(oe.bendStyle);static graceType=new Map([["onbeat",1],["beforebeat",2],["bendgrace",3],["ob",1],["bb",2],["b",3]]);static graceTypeReversed=oe.jt(oe.graceType);static fermataType=new Map([["short",0],["medium",1],["long",2]]);static fermataTypeReversed=oe.jt(oe.fermataType);static alphaTexAccidentalMode=new Map([["auto",0],["explicit",1]]);static alphaTexAccidentalModeReversed=oe.jt(oe.alphaTexAccidentalMode);static alphaTexVoiceMode=new Map([["staffwise",0],["barwise",1]]);static alphaTexVoiceModeReversed=oe.jt(oe.alphaTexVoiceMode);static noteAccidentalMode=new Map([["default",0],["forcenone",1],["forcenatural",2],["forcesharp",3],["forcedoublesharp",4],["forceflat",5],["forcedoubleflat",6],["d",0],["-",1],["n",2],["#",3],["##",4],["x",4],["b",5],["bb",6]]);static noteAccidentalModeReversed=oe.jt(oe.noteAccidentalMode);static barreShape=new Map([["full",1],["half",2]]);static barreShapeReversed=oe.jt(oe.barreShape);static ottavia=new Map([["15ma",0],["8va",1],["regular",2],["8vb",3],["15mb",4],["15ma",0],["8va",1],["8vb",3],["15mb",4]]);static ottaviaReversed=oe.jt(oe.ottavia);static rasgueado=new Map([["ii",1],["mi",2],["miitriplet",3],["miianapaest",4],["pmptriplet",5],["pmpanapaest",6],["peitriplet",7],["peianapaest",8],["paitriplet",9],["paianapaest",10],["amitriplet",11],["amianapaest",12],["ppp",13],["amii",14],["amip",15],["eami",16],["eamii",17],["peami",18]]);static rasgueadoReversed=oe.jt(oe.rasgueado);static dynamicValue=new Map([["ppp",0],["pp",1],["p",2],["mp",3],["mf",4],["f",5],["ff",6],["fff",7],["pppp",8],["ppppp",9],["pppppp",10],["ffff",11],["fffff",12],["ffffff",13],["sf",14],["sfp",15],["sfpp",16],["fp",17],["rf",18],["rfz",19],["sfz",20],["sffz",21],["fz",22],["n",23],["pf",24],["sfzp",25]]);static dynamicValueReversed=oe.jt(oe.dynamicValue);static bracketExtendMode=new Map([["nobrackets",0],["groupstaves",1],["groupsimilarinstruments",2]]);static bracketExtendModeReversed=oe.jt(oe.bracketExtendMode);static trackNamePolicy=new Map([["hidden",0],["firstsystem",1],["allsystems",2]]);static trackNamePolicyReversed=oe.jt(oe.trackNamePolicy);static trackNameOrientation=new Map([["horizontal",0],["vertical",1]]);static trackNameOrientationReversed=oe.jt(oe.trackNameOrientation);static trackNameMode=new Map([["fullname",0],["shortname",1]]);static trackNameModeReversed=oe.jt(oe.trackNameMode);static textAlign=new Map([["left",0],["center",1],["right",2]]);static textAlignReversed=oe.jt(oe.textAlign);static bendType=new Map([["custom",1],["bend",2],["release",3],["bendrelease",4],["hold",5],["prebend",6],["prebendbend",7],["prebendrelease",8]]);static bendTypeReversed=oe.jt(oe.bendType);static keySignature=new Map([["cb",-7],["gb",-6],["db",-5],["ab",-4],["eb",-3],["bb",-2],["f",-1],["c",0],["g",1],["d",2],["a",3],["e",4],["b",5],["f#",6],["c#",7],["cbmajor",-7],["abminor",-7],["gbmajor",-6],["ebminor",-6],["dbmajor",-5],["bbminor",-5],["abmajor",-4],["fminor",-4],["ebmajor",-3],["cminor",-3],["bbmajor",-2],["gminor",-2],["fmajor",-1],["dminor",-1],["cmajor",0],["aminor",0],["gmajor",1],["eminor",1],["dmajor",2],["bminor",2],["amajor",3],["f#minor",3],["emajor",4],["c#minor",4],["bmajor",5],["g#minor",5],["f#major",6],["d#minor",6],["f#",6],["c#major",7],["a#minor",7],["c#",7]]);static keySignatureReversed=oe.jt(oe.keySignature);static keySignatureType=new Map([["major",0],["minor",1],["cb",0],["cbmajor",0],["gb",0],["gbmajor",0],["db",0],["dbmajor",0],["ab",0],["abmajor",0],["eb",0],["ebmajor",0],["bb",0],["bbmajor",0],["f",0],["fmajor",0],["c",0],["cmajor",0],["g",0],["gmajor",0],["d",0],["dmajor",0],["a",0],["amajor",0],["e",0],["emajor",0],["b",0],["bmajor",0],["f#",0],["f#major",0],["c#",0],["c#major",0],["abminor",1],["ebminor",1],["bbminor",1],["fminor",1],["cminor",1],["gminor",1],["dminor",1],["aminor",1],["eminor",1],["bminor",1],["f#minor",1],["c#minor",1],["g#minor",1],["d#minor",1],["a#minor",1]]);static keySignatureTypeReversed=oe.jt(oe.keySignatureType);static clef=new Map([["neutral",0],["c3",1],["c4",2],["f4",3],["g2",4],["n",0],["alto",1],["tenor",2],["bass",3],["treble",4]]);static clefReversed=oe.jt(oe.clef);static tripletFeel=new Map([["none",0],["triplet16th",1],["triplet8th",2],["dotted16th",3],["dotted8th",4],["scottish16th",5],["scottish8th",6],["none",0],["no",0],["notripletfeel",0],["t16",1],["triplet-16th",1],["t8",2],["triplet-8th",2],["d16",3],["dotted-16th",3],["d8",4],["dotted-8th",4],["s16",5],["scottish-16th",5],["s8",6],["scottish-8th",6]]);static tripletFeelReversed=oe.jt(oe.tripletFeel);static barLineStyle=new Map([["automatic",0],["dashed",1],["dotted",2],["heavy",3],["heavyheavy",4],["heavylight",5],["lightheavy",6],["lightlight",7],["none",8],["regular",9],["short",10],["tick",11]]);static barLineStyleReversed=oe.jt(oe.barLineStyle);static simileMark=new Map([["none",0],["simple",1],["firstofdouble",2],["secondofdouble",3]]);static simileMarkReversed=oe.jt(oe.simileMark);static direction=new Map([["fine",0],["segno",1],["segnosegno",2],["coda",3],["doublecoda",4],["dacapo",5],["dacapoalcoda",6],["dacapoaldoublecoda",7],["dacapoalfine",8],["dalsegno",9],["dalsegnoalcoda",10],["dalsegnoaldoublecoda",11],["dalsegnoalfine",12],["dalsegnosegno",13],["dalsegnosegnoalcoda",14],["dalsegnosegnoaldoublecoda",15],["dalsegnosegnoalfine",16],["dacoda",17],["dadoublecoda",18]]);static directionReversed=oe.jt(oe.direction);static tremoloPickingStyle=new Map([["default",0],["buzzroll",1]]);static tremoloPickingStyleReversed=oe.jt(oe.tremoloPickingStyle);static barNumberDisplay=new Map([["allbars",0],["firstofsystem",1],["hide",2]]);static barNumberDisplayReversed=oe.jt(oe.barNumberDisplay);static keySignaturesMinorReversed=new Map([[-7,"abminor"],[-6,"ebminor"],[-5,"bbminor"],[-4,"fminor"],[-3,"cminor"],[-2,"gminor"],[-1,"dminor"],[0,"aminor"],[1,"eminor"],[2,"bminor"],[3,"f#minor"],[4,"c#minor"],[5,"g#minor"],[6,"d#minor"],[7,"a#minor"]]);static keySignaturesMajorReversed=new Map([[-7,"cb"],[-6,"gb"],[-5,"db"],[-4,"ab"],[-3,"eb"],[-2,"bb"],[-1,"f"],[0,"c"],[1,"g"],[2,"d"],[3,"a"],[4,"e"],[5,"b"],[6,"f#"],[7,"c#"]])}class ce{static Jt(t){return t?{expectedTypes:new Set(t[0]),parseMode:t[1],allowedValues:t.length>2&&t[2]&&t[2].length>0?new Set(t[2]):void 0,reservedIdentifiers:t.length>3&&t[3]&&t[3].length>0?new Set(t[3]):void 0}:null}static qt(t){return null==t?null:t.map(t=>({isStrict:t.length>0&&null===t[0],parameters:t.map(ce.Jt).filter(t=>null!==t)}))}static Yt(t){return new Map(t.map(t=>[t[0],null===t[1]?null:new Map(t[1].map(t=>[t[0],ce.qt(t[1])]))]))}static Kt(t){return new Map(t.map(t=>[t[0],ce.qt(t[1])]))}static Qt(t){return new Map(t.map(t=>[t[0],ce.qt(t[1])]))}static scoreMetaDataSignatures=ce.Qt([["title",[[[[17,10],0],[[17],1],[[10,17],1,["left","center","right"]]]]],["subtitle",[[[[17,10],0],[[17],1],[[10,17],1,["left","center","right"]]]]],["artist",[[[[17,10],0],[[17],1],[[10,17],1,["left","center","right"]]]]],["album",[[[[17,10],0],[[17],1],[[10,17],1,["left","center","right"]]]]],["words",[[[[17,10],0],[[17],1],[[10,17],1,["left","center","right"]]]]],["music",[[[[17,10],0],[[17],1],[[10,17],1,["left","center","right"]]]]],["wordsandmusic",[[[[17],0],[[10,17],1,["left","center","right"]]]]],["copyright",[[[[17,10],0],[[17],1],[[10,17],1,["left","center","right"]]]]],["copyright2",[[[[17],0],[[10,17],1,["left","center","right"]]]]],["instructions",[[[[17,10],0]]]],["notices",[[[[17,10],0]]]],["tab",[[[[17,10],0],[[17],1],[[10,17],1,["left","center","right"]]]]],["systemslayout",[[[[16],5]]]],["defaultsystemslayout",[[[[16],0]]]],["showdynamics",null],["hidedynamics",null],["usesystemsignseparator",null],["multibarrest",null],["bracketextendmode",[[[[10,17],0,["nobrackets","groupstaves","groupsimilarinstruments"]]]]],["singletracktracknamepolicy",[[[[10,17],0,["hidden","firstsystem","allsystems"]]]]],["multitracktracknamepolicy",[[[[10,17],0,["hidden","firstsystem","allsystems"]]]]],["firstsystemtracknamemode",[[[[10,17],0,["fullname","shortname"]]]]],["othersystemstracknamemode",[[[[10,17],0,["fullname","shortname"]]]]],["firstsystemtracknameorientation",[[[[10,17],0,["horizontal","vertical"]]]]],["othersystemstracknameorientation",[[[[10,17],0,["horizontal","vertical"]]]]],["extendbarlines",null],["chorddiagramsinscore",[[[[10],1,["true","false"]]]]],["hideemptystaves",null],["hideemptystavesinfirstsystem",null],["showsinglestaffbrackets",null],["defaultbarnumberdisplay",[[[[10,17],0,["allbars","firstofsystem","hide"]]]]]]);static staffMetaDataSignatures=ce.Qt([["tuning",[[[[10,17],0,["piano","none","voice"]]],[[[10,17],5]]]],["chord",[[[[17,10],0],[[10,17,16],5]]]],["capo",[[[[16],0]]]],["lyrics",[[[[17],0]],[[[16],0],[[17],0]]]],["articulation",[[[[10],0,["defaults"]]],[[[17,10],0],[[16],0]]]],["displaytranspose",[[[[16],0]]]],["transpose",[[[[16],0]]]],["instrument",[[[[16],0]],[[[17,10],0]],[[[10],0,["percussion"]]]]]]);static structuralMetaDataSignatures=ce.Qt([["track",[[[[17],1],[[17],1]]]],["staff",null],["voice",null]]);static barMetaDataSignatures=ce.Qt([["ts",[[[[10,17],0,["common"]]],[[[16],0],[[16],0]]]],["ro",null],["rc",[[[[16],0]]]],["ae",[[[[16,13],4]]]],["ks",[[[[10,17],0,["cb","gb","db","ab","eb","bb","f","c","g","d","a","e","b","f#","c#","cbmajor","abminor","gbmajor","ebminor","dbmajor","bbminor","abmajor","fminor","ebmajor","cminor","bbmajor","gminor","fmajor","dminor","cmajor","aminor","gmajor","eminor","dmajor","bminor","amajor","f#minor","emajor","c#minor","bmajor","g#minor","f#major","d#minor","f#","c#major","a#minor","c#"]]]]],["clef",[[[[10,16,17],0,["neutral","c3","c4","f4","g2","n","alto","tenor","bass","treble"]]]]],["ottava",[[[[10,17],0,["15ma","8va","regular","8vb","15mb","15ma","8va","8vb","15mb"]]]]],["tempo",[[[[16],2],[[17],1]],[null,[[16],2],[[17],0],[[16],1],[[10],1,["hide"]]]]],["tf",[[[[10,16,17],0,["none","triplet16th","triplet8th","dotted16th","dotted8th","scottish16th","scottish8th","none","no","notripletfeel","t16","triplet-16th","t8","triplet-8th","d16","dotted-16th","d8","dotted-8th","s16","scottish-16th","s8","scottish-8th"]]]]],["ac",null],["section",[[[[17,10],0]],[[[17,10],0],[[17,10],0,null,["x","-","r"]]]]],["jump",[[[[10,17],0,["fine","segno","segnosegno","coda","doublecoda","dacapo","dacapoalcoda","dacapoaldoublecoda","dacapoalfine","dalsegno","dalsegnoalcoda","dalsegnoaldoublecoda","dalsegnoalfine","dalsegnosegno","dalsegnosegnoalcoda","dalsegnosegnoaldoublecoda","dalsegnosegnoalfine","dacoda","dadoublecoda"]]]]],["ft",null],["simile",[[[[10,17],0,["none","simple","firstofdouble","secondofdouble"]]]]],["barlineleft",[[[[10,17],0,["automatic","dashed","dotted","heavy","heavyheavy","heavylight","lightheavy","lightlight","none","regular","short","tick"]]]]],["barlineright",[[[[10,17],0,["automatic","dashed","dotted","heavy","heavyheavy","heavylight","lightheavy","lightlight","none","regular","short","tick"]]]]],["scale",[[[[16],2]]]],["width",[[[[16],2]]]],["sync",[[[[16],0],[[16],0],[[16],0],[[16],3]]]],["accidentals",[[[[10,17],0,["auto","explicit"]]]]],["spd",[[[[16],2]]]],["sph",[[[[16],2]]]],["spu",[[[[16],2]]]],["db",null],["voicemode",[[[[10,17],0,["staffwise","barwise"]]]]],["barnumberdisplay",[[[[10,17],0,["allbars","firstofsystem","hide"]]]]],["beaming",[[[[16],0],[[16],5]]]]]);static metaDataProperties=ce.Yt([["track",[["color",[[[[17],0]]]],["systemslayout",[[[[16],5]]]],["defaultsystemslayout",[[[[16],0]]]],["solo",null],["mute",null],["volume",[[[[16],0]]]],["balance",[[[[16],0]]]],["instrument",[[[[16],0]],[[[17,10],0]],[[[10],0,["percussion"]]]]],["bank",[[[[16],0]]]],["multibarrest",null]]],["staff",[["score",[[[[16],1]]]],["tabs",null],["slash",null],["numbered",null]]],["voice",null],["title",null],["subtitle",null],["artist",null],["album",null],["words",null],["music",null],["wordsandmusic",null],["copyright",null],["copyright2",null],["instructions",null],["notices",null],["tab",null],["systemslayout",null],["defaultsystemslayout",null],["showdynamics",null],["hidedynamics",null],["usesystemsignseparator",null],["multibarrest",null],["bracketextendmode",null],["singletracktracknamepolicy",null],["multitracktracknamepolicy",null],["firstsystemtracknamemode",null],["othersystemstracknamemode",null],["firstsystemtracknameorientation",null],["othersystemstracknameorientation",null],["extendbarlines",null],["chorddiagramsinscore",null],["hideemptystaves",null],["hideemptystavesinfirstsystem",null],["showsinglestaffbrackets",null],["defaultbarnumberdisplay",null],["tuning",[["hide",null],["label",[[[[17],0]]]]]],["chord",[["firstfret",[[[[16],0]]]],["barre",[[[[16],5]]]],["showdiagram",[[],[[[17],0,["true","false"]]],[[[10],0,["true","false"]]],[[[16],0,["1","0"]]]]],["showfingering",[[],[[[17],0,["true","false"]]],[[[10],0,["true","false"]]],[[[16],0,["1","0"]]]]],["showname",[[],[[[17],0,["true","false"]]],[[[10],0,["true","false"]]],[[[16],0,["1","0"]]]]]]],["capo",null],["lyrics",null],["articulation",null],["displaytranspose",null],["transpose",null],["instrument",null],["ts",null],["ro",null],["rc",null],["ae",null],["ks",null],["clef",null],["ottava",null],["tempo",null],["tf",null],["ac",null],["section",null],["jump",null],["ft",null],["simile",null],["barlineleft",null],["barlineright",null],["scale",null],["width",null],["sync",null],["accidentals",null],["spd",null],["sph",null],["spu",null],["db",null],["voicemode",null],["barnumberdisplay",null],["beaming",null]]);static metaDataSignatures=[ce.scoreMetaDataSignatures,ce.staffMetaDataSignatures,ce.structuralMetaDataSignatures,ce.barMetaDataSignatures];static durationChangeProperties=ce.Kt([["tu",[[[[16],0,["3","5","6","7","9","10","12"]]],[[[16],0],[[16],0]]]]]);static beatProperties=ce.Kt([["f",null],["fo",null],["vs",null],["v",null],["vw",null],["s",null],["p",null],["tt",null],["d",null],["dd",null],["su",null],["sd",null],["cre",null],["dec",null],["spd",null],["sph",null],["spu",null],["spe",null],["slashed",null],["ds",null],["glpf",null],["glpt",null],["waho",null],["wahc",null],["legatoorigin",null],["timer",null],["tu",[[[[16],0,["3","5","6","7","9","10","12"]]],[[[16],0],[[16],0]]]],["txt",[[[[17,10],0]]]],["lyrics",[[[[17],0]],[[[16],0],[[17],0]]]],["tb",[[[[16],5]],[[[10,17],0,["custom","dive","dip","hold","predive","predivedive"]],[[16],5]],[[[10,17],0,["default","gradual","fast"]],[[16],5]],[[[10,17],0,["custom","dive","dip","hold","predive","predivedive"]],[[10,17],0,["default","gradual","fast"]],[[16],5]]]],["tbe",[[[[16],5]],[[[10,17],0,["custom","dive","dip","hold","predive","predivedive"]],[[16],5]],[[[10,17],0,["default","gradual","fast"]],[[16],5]],[[[10,17],0,["custom","dive","dip","hold","predive","predivedive"]],[[10,17],0,["default","gradual","fast"]],[[16],5]]]],["bu",[[[[16],1]]]],["bd",[[[[16],1]]]],["au",[[[[16],1]]]],["ad",[[[[16],1]]]],["ch",[[[[17,10],0]]]],["gr",[[[[10,17],1,["onbeat","beforebeat","bendgrace","ob","bb","b"]]]]],["dy",[[[[10,17],0,["ppp","pp","p","mp","mf","f","ff","fff","pppp","ppppp","pppppp","ffff","fffff","ffffff","sf","sfp","sfpp","fp","rf","rfz","sfz","sffz","fz","n","pf","sfzp"]]]]],["tempo",[[[[16],0],[[10],1,["hide"]]],[[[16],0],[[17],0],[[10],1,["hide"]]]]],["volume",[[[[16],0]]]],["balance",[[[[16],0]]]],["tp",[[[[16],0],[[10,17],1,["default","buzzroll"]]]]],["barre",[[[[16],0],[[10,17],1,["full","half"]]]]],["rasg",[[[[10,17],0,["ii","mi","miitriplet","miianapaest","pmptriplet","pmpanapaest","peitriplet","peianapaest","paitriplet","paianapaest","amitriplet","amianapaest","ppp","amii","amip","eami","eamii","peami"]]]]],["ot",[[[[10,17],0,["15ma","8va","regular","8vb","15mb","15ma","8va","8vb","15mb"]]]]],["instrument",[[[[16],0]],[[[17,10],0]],[[[10],0,["percussion"]]]]],["bank",[[[[16],0]]]],["fermata",[[[[10,17],0,["short","medium","long"]],[[16],3]]]],["beam",[[[[10,17],0,["invert","up","down","auto","split","merge","splitsecondary"]]]]]]);static noteProperties=ce.Kt([["nh",null],["ah",[[[[16],1]]]],["th",[[[[16],1]]]],["ph",[[[[16],1]]]],["sh",[[[[16],1]]]],["fh",[[[[16],1]]]],["v",null],["vw",null],["sl",null],["ss",null],["sib",null],["sia",null],["sou",null],["sod",null],["psu",null],["psd",null],["h",null],["lht",null],["g",null],["ac",null],["hac",null],["ten",null],["tr",[[[[16],0],[[16],1,["16","32","64"]]]]],["pm",null],["st",null],["lr",null],["x",null],["t",null],["turn",null],["iturn",null],["umordent",null],["lmordent",null],["string",null],["hide",null],["b",[[[[16],5]],[[[10,17],0,["custom","bend","release","bendrelease","hold","prebend","prebendbend","prebendrelease"]],[[16],5]],[[[10,17],0,["default","gradual","fast"]],[[16],5]],[[[10,17],0,["custom","bend","release","bendrelease","hold","prebend","prebendbend","prebendrelease"]],[[10,17],0,["default","gradual","fast"]],[[16],5]]]],["be",[[[[16],5]],[[[10,17],0,["custom","bend","release","bendrelease","hold","prebend","prebendbend","prebendrelease"]],[[16],5]],[[[10,17],0,["default","gradual","fast"]],[[16],5]],[[[10,17],0,["custom","bend","release","bendrelease","hold","prebend","prebendbend","prebendrelease"]],[[10,17],0,["default","gradual","fast"]],[[16],5]]]],["lf",[[[[16],0,["1","2","3","4","5"]]]]],["rf",[[[[16],0,["1","2","3","4","5"]]]]],["acc",[[[[10,17],0,["default","forcenone","forcenatural","forcesharp","forcedoublesharp","forceflat","forcedoubleflat","d","-","n","#","##","x","b","bb"]]]]],["slur",[[[[17],0]],[[[10],0]]]],["-",null]])}!function(t){t[t.Dot=0]="Dot",t[t.Backslash=1]="Backslash",t[t.DoubleBackslash=2]="DoubleBackslash",t[t.Pipe=3]="Pipe",t[t.LBrace=4]="LBrace",t[t.RBrace=5]="RBrace",t[t.LParen=6]="LParen",t[t.RParen=7]="RParen",t[t.Colon=8]="Colon",t[t.Asterisk=9]="Asterisk",t[t.Ident=10]="Ident",t[t.Tag=11]="Tag",t[t.Meta=12]="Meta",t[t.Arguments=13]="Arguments",t[t.Props=14]="Props",t[t.Prop=15]="Prop",t[t.Number=16]="Number",t[t.String=17]="String",t[t.Score=18]="Score",t[t.Bar=19]="Bar",t[t.Beat=20]="Beat",t[t.Duration=21]="Duration",t[t.NoteList=22]="NoteList",t[t.Note=23]="Note"}(_t||(_t={})),function(t){t[t.Hint=0]="Hint",t[t.Warning=1]="Warning",t[t.Error=2]="Error"}(Tt||(Tt={})),function(t){t[t.AT001=1]="AT001",t[t.AT002=2]="AT002",t[t.AT003=3]="AT003",t[t.AT004=4]="AT004",t[t.AT005=5]="AT005",t[t.AT006=6]="AT006",t[t.AT200=200]="AT200",t[t.AT201=201]="AT201",t[t.AT202=202]="AT202",t[t.AT203=203]="AT203",t[t.AT204=204]="AT204",t[t.AT205=205]="AT205",t[t.AT206=206]="AT206",t[t.AT207=207]="AT207",t[t.AT208=208]="AT208",t[t.AT209=209]="AT209",t[t.AT210=210]="AT210",t[t.AT211=211]="AT211",t[t.AT212=212]="AT212",t[t.AT213=213]="AT213",t[t.AT214=214]="AT214",t[t.AT215=215]="AT215",t[t.AT216=216]="AT216",t[t.AT217=217]="AT217",t[t.AT218=218]="AT218",t[t.AT219=219]="AT219",t[t.AT220=220]="AT220",t[t.AT300=300]="AT300",t[t.AT301=301]="AT301",t[t.AT302=302]="AT302",t[t.AT303=303]="AT303",t[t.AT304=304]="AT304",t[t.AT305=305]="AT305",t[t.AT306=306]="AT306",t[t.AT400=400]="AT400"}(xt||(xt={}));class le{Zt=!1;items=[];get errors(){return this.items.filter(t=>t.severity===Tt.Error)}get hasErrors(){return this.Zt}push(t){this.items.push(t),t.severity===Tt.Error&&(this.Zt=!0)}[Symbol.iterator](){return this.items[Symbol.iterator]()}}!function(t){t[t.Auto=0]="Auto",t[t.Explicit=1]="Explicit"}(Mt||(Mt={})),function(t){t[t.StaffWise=0]="StaffWise",t[t.BarWise=1]="BarWise"}(vt||(vt={})),function(t){t[t.Pitched=0]="Pitched",t[t.Fretted=1]="Fretted",t[t.Articulation=2]="Articulation"}(Nt||(Nt={})),function(t){t[t.Required=0]="Required",t[t.Optional=1]="Optional",t[t.RequiredAsFloat=2]="RequiredAsFloat",t[t.OptionalAsFloat=3]="OptionalAsFloat",t[t.RequiredAsValueList=4]="RequiredAsValueList",t[t.ValueListWithoutParenthesis=5]="ValueListWithoutParenthesis"}(Pt||(Pt={}));class ue{static te=new ArrayBuffer(8);static ee=new Uint8Array(ue.te);static se=new DataView(ue.te);static float64ToBytes(t){return ue.se.setFloat64(0,t,!0),ue.ee}static bytesToInt64LE(t){ue.ee.set(t,0);const e=ue.se.getBigInt64(0,!0);return e<=Number.MAX_SAFE_INTEGER&&e>=Number.MIN_SAFE_INTEGER?Number(e):Number.MAX_SAFE_INTEGER}static bytesToFloat64LE(t){return ue.ee.set(t,0),ue.se.getFloat64(0,!0)}static bytesToFloat32LE(t){return ue.ee.set(t,0),ue.se.getFloat32(0,!0)}static float32BEToBytes(t){return ue.se.setFloat32(0,t,!1),ue.ee.slice(0,4)}static uint16ToInt16(t){return ue.se.setUint16(0,t,!0),ue.se.getInt16(0,!0)}static int16ToUint32(t){return ue.se.setInt16(0,t,!0),ue.se.getUint32(0,!0)}static int32ToUint16(t){return ue.se.setInt32(0,t,!0),ue.se.getUint16(0,!0)}static int32ToInt16(t){return ue.se.setInt32(0,t,!0),ue.se.getInt16(0,!0)}static int32ToUint32(t){return ue.se.setInt32(0,t,!0),ue.se.getUint32(0,!0)}static uint8ToInt8(t){return ue.se.setUint8(0,t),ue.se.getInt8(0)}}class de{static readInt32BE(t){return t.readByte()<<24|t.readByte()<<16|t.readByte()<<8|t.readByte()}static readFloat32BE(t){const e=new Uint8Array(4);return t.read(e,0,e.length),e.reverse(),ue.bytesToFloat32LE(e)}static readFloat64BE(t){const e=new Uint8Array(8);return t.read(e,0,e.length),e.reverse(),ue.bytesToFloat64LE(e)}static readInt32LE(t){const e=t.readByte(),s=t.readByte(),i=t.readByte();return t.readByte()<<24|i<<16|s<<8|e}static readInt64LE(t){const e=new Uint8Array(8);return t.read(e,0,e.length),ue.bytesToInt64LE(e)}static readUInt32LE(t){const e=t.readByte(),s=t.readByte(),i=t.readByte();return t.readByte()<<24|i<<16|s<<8|e}static decodeUInt32LE(t,e){const s=t[e],i=t[e+1],n=t[e+2];return t[e+3]<<24|n<<16|i<<8|s}static readUInt16LE(t){const e=t.readByte(),s=t.readByte();return ue.int32ToUint16(s<<8|e)}static readInt16LE(t){const e=t.readByte(),s=t.readByte();return ue.int32ToInt16(s<<8|e)}static readUInt32BE(t){const e=t.readByte(),s=t.readByte(),i=t.readByte(),n=t.readByte();return ue.int32ToUint32(e<<24|s<<16|i<<8|n)}static readUInt16BE(t){const e=t.readByte(),s=t.readByte();return ue.int32ToInt16(e<<8|s)}static readInt16BE(t){const e=t.readByte(),s=t.readByte();return ue.int32ToInt16(e<<8|s)}static readByteArray(t,e){const s=new Uint8Array(e);return t.read(s,0,e),s}static read8BitChars(t,e){const s=new Uint8Array(e);return t.read(s,0,s.length),de.toString(s,"utf-8")}static read8BitString(t){let e="",s=t.readByte();for(;0!==s;)e+=String.fromCharCode(s),s=t.readByte();return e}static read8BitStringLength(t,e){let s="",i=-1;for(let n=0;n<e;n++){const e=t.readByte();0===e&&-1===i&&(i=n),s+=String.fromCharCode(e)}const n=s;return i>=0?n.substr(0,i):n}static readSInt8(t){const e=t.readByte();return-256*((255&e)>>7)+(255&e)}static readInt24(t,e){let s=t[e]|t[e+1]<<8|t[e+2]<<16;return 8388608&~s||(s|=255<<24),s}static readInt16(t,e){return ue.int32ToInt16(t[e]|t[e+1]<<8)}static toString(t,e){const s=de.ie(t);s&&(e=s),e||(e="utf-8");return new TextDecoder(e).decode(t.buffer)}static ie(t){return t.length>2&&254===t[0]&&255===t[1]?"utf-16be":t.length>2&&255===t[0]&&254===t[1]?"utf-16le":t.length>4&&0===t[0]&&0===t[1]&&254===t[2]&&255===t[3]?"utf-32be":t.length>4&&255===t[0]&&254===t[1]&&0===t[2]&&0===t[3]?"utf-32le":null}static stringToBytes(t){return(new TextEncoder).encode(t)}static writeInt32BE(t,e){t.writeByte(e>>24&255),t.writeByte(e>>16&255),t.writeByte(e>>8&255),t.writeByte(255&e)}static writeInt32LE(t,e){t.writeByte(255&e),t.writeByte(e>>8&255),t.writeByte(e>>16&255),t.writeByte(e>>24&255)}static writeUInt16LE(t,e){t.writeByte(255&e),t.writeByte(e>>8&255)}static writeInt16LE(t,e){t.writeByte(255&e),t.writeByte(e>>8&255)}static writeInt16BE(t,e){t.writeByte(e>>8&255),t.writeByte(255&e)}static writeFloat32BE(t,e){const s=ue.float32BEToBytes(e);t.write(s,0,s.length)}static*iterateCodepoints(t){let e=0;for(;e<t.length;){let s=t.charCodeAt(e);de.isLeadingSurrogate(s)&&e+1<t.length&&(e++,s=1024*(s-55296)+(t.charCodeAt(e)-56320)+65536),e++,yield s}}static isLeadingSurrogate(t){return t>=55296&&t<=56319}static isTrailingSurrogate(t){return t>=56320&&t<=57343}}class fe{static ne=0;re;ae=fe.ne;he=0;oe=1;ce=1;fatalError=!1;le={line:0,col:0,offset:0};ue;de;fe;pe;lexerDiagnostics=new le;constructor(t){this.re=[...de.iterateCodepoints(t)],this.he=0,this.oe=1,this.ce=1,this.ae=this.re.length>0?this.re[0]:fe.ne}peekToken(){if(this.fatalError)return;let t=this.pe;return t||(t=this.be(),this.pe=t,t)}extendToFloat(t){if(46!==this.ae||this.he+1>=this.re.length||!fe.me(this.re[this.he+1]))return t;let e=this.he+2;for(;e<this.re.length&&fe.me(this.re[e]);)e++;if(e<this.re.length&&fe.ge(this.re[e]))return t;const s=e-this.he-1;return this.he+=s,this.ce+=s,this.we(),t.end=this.ye(),t.value=Number.parseFloat(String.fromCodePoint(...this.re.slice(t.start.offset,t.end.offset))),t}advance(){this.fe=this.pe,this.pe=void 0}we(){const t=this.re;let e=this.he;if(e<t.length-1){10===t[e]?(this.de=void 0,++this.oe,this.ce=1):++this.ce,++e;const s=t[e];return this.ae=s,this.he=e,s}return this.ae!==fe.ne&&(this.ae=fe.ne,++this.ce,this.he=t.length),fe.ne}previousTokenEndLocation(){return this.fe?.end??this.ye()}currentTokenLocation(){return this.pe?.start??this.ye()}ye(){return{line:this.oe,col:this.ce,offset:this.he}}be(){for(this.ue=void 0;this.ae!==fe.ne&&!this.fatalError;)if(this.le=this.ye(),fe.ke.has(this.ae)){const t=fe.ke.get(this.ae)(this);if(t)return this.de=t,t}else{if(fe.ge(this.ae)){const t=this.Se();return this.de=t,t}this.ae=this.we()}}Be(){this.ae=this.we(),47===this.ae?this._e():42===this.ae?this.Te():(this.lexerDiagnostics.push({code:xt.AT001,message:`Unexpected character at comment start, expected '//' or '/*' but found '/${String.fromCodePoint(this.ae)}'`,severity:Tt.Error,start:this.le,end:this.ye()}),this.fatalError=!0)}static ke=new Map([[47,t=>t.Be()],[34,t=>t.xe()],[39,t=>t.xe()],[45,t=>t.Se()],[46,t=>t.Me({nodeType:_t.Dot})],[58,t=>t.Me({nodeType:_t.Colon})],[40,t=>t.Me({nodeType:_t.LParen})],[41,t=>t.Me({nodeType:_t.RParen})],[123,t=>t.Me({nodeType:_t.LBrace})],[125,t=>t.Me({nodeType:_t.RBrace})],[124,t=>t.Me({nodeType:_t.Pipe})],[42,t=>t.Me({nodeType:_t.Asterisk})],[92,t=>t.ve()],[9,t=>t.Ne()],[10,t=>t.Ne()],[11,t=>t.Ne()],[13,t=>t.Ne()],[32,t=>t.Ne()]]);ve(){const t=this.ye();let e,s;this.ae=this.we(),92===this.ae?(this.ae=this.we(),s=this.ye(),e={nodeType:_t.DoubleBackslash,start:t,end:s}):(s=this.ye(),e={nodeType:_t.Backslash,start:t,end:s});let i="";for(;fe.ge(this.ae);)i+=String.fromCodePoint(this.ae),this.ae=this.we();if(0===i.length)return void this.lexerDiagnostics.push({code:xt.AT002,message:"Missing identifier after meta data start",severity:Tt.Error,start:this.le,end:this.ye()});return{nodeType:_t.Tag,leadingComments:this.ue,start:this.le,end:this.ye(),prefix:e,tag:{nodeType:_t.Ident,text:i,start:s,end:this.ye()}}}Me(t){return t.leadingComments=this.ue,t.start=this.le,this.ae=this.we(),t.end=this.ye(),t}xe(){const t=this.ae;this.ae=this.we();let e="",s=-1;for(;this.ae!==t&&this.ae!==fe.ne;){let i=-1;if(92===this.ae)if(this.ae=this.we(),92===this.ae)i=92;else if(this.ae===t)i=t;else if(82===this.ae||114===this.ae)i=13;else if(78===this.ae||110===this.ae)i=10;else if(84===this.ae||116===this.ae)i=9;else{if(117!==this.ae)return this.lexerDiagnostics.push({code:xt.AT005,message:`Unsupported escape sequence. Expected '\\n', '\\r', '\\t', or '\\uXXXX' but found '\\${String.fromCodePoint(this.ae)}'.`,severity:Tt.Error,start:this.le,end:this.ye()}),void(this.fatalError=!0);{let t="";for(let e=0;e<4;e++){if(this.ae=this.we(),this.ae===fe.ne)return this.lexerDiagnostics.push({code:xt.AT003,message:"Unexpected end of file. Need 4 hex characters on a \\uXXXX escape sequence",severity:Tt.Error,start:this.le,end:this.ye()}),void(this.fatalError=!0);t+=String.fromCodePoint(this.ae)}if(i=Number.parseInt(t,16),Number.isNaN(i))return this.lexerDiagnostics.push({code:xt.AT004,message:"Invalid unicode value. Need 4 hex characters on a \\uXXXX escape sequence.",severity:Tt.Error,start:this.le,end:this.ye()}),void(this.fatalError=!0)}}else i=this.ae;de.isLeadingSurrogate(s)&&de.isTrailingSurrogate(i)?(i=1024*(s-55296)+(i-56320)+65536,e+=String.fromCodePoint(i)):de.isLeadingSurrogate(i)||(de.isLeadingSurrogate(s)&&(e+=String.fromCodePoint(s)),i>0&&(e+=String.fromCodePoint(i))),s=i,this.ae=this.we()}if(this.ae===fe.ne)return this.lexerDiagnostics.push({code:xt.AT006,message:"Unexpected end of file. String not closed.",severity:Tt.Error,start:this.le,end:this.ye()}),void(this.fatalError=!0);const i={nodeType:_t.String,text:e,leadingComments:this.ue,start:this.le,end:this.ye()};return this.ae=this.we(),i}Te(){const t=this.de,e={start:this.le,end:this.ye(),text:"",multiLine:!0};for(;this.ae!==fe.ne;)if(42===this.ae){if(this.ae=this.we(),47===this.ae){this.ae=this.we();break}e.text+=`*${String.fromCodePoint(this.ae)}`,e.end.line=this.oe,e.end.col=this.ce,e.end.offset=this.he}else this.ae=this.we(),e.text+=String.fromCodePoint(this.ae),e.end.line=this.oe,e.end.col=this.ce,e.end.offset=this.he;t?(t.trailingComments??=[],t.trailingComments.push(e)):(this.ue??=[],this.ue.push(e))}Se(){let t="",e=!0,s=this.ae;45===s&&(t+=String.fromCodePoint(s),s=this.we(),fe.me(s)||(e=!1));let i=!0;do{e?fe.me(s)?(t+=String.fromCodePoint(s),s=this.we(),i=!0):fe.ge(s)?(e=!1,t+=String.fromCodePoint(s),s=this.we(),i=!0):i=!1:fe.ge(s)?(t+=String.fromCodePoint(s),s=this.we(),i=!0):i=!1}while(i);if(e){return{nodeType:_t.Number,leadingComments:this.ue,start:this.le,end:this.ye(),value:Number.parseInt(t,10)}}return{nodeType:_t.Ident,leadingComments:this.ue,start:this.le,end:this.ye(),text:t}}_e(){const t=this.de,e={start:this.le,end:this.ye(),text:"",multiLine:!1};let s=this.ae;for(;s!==fe.ne&&(s=this.we(),10!==s&&s!==fe.ne);)e.text+=String.fromCodePoint(s),e.end.line=this.oe,e.end.col=this.ce,e.end.offset=this.he;t?(t.trailingComments??=[],t.trailingComments.push(e)):(this.ue??=[],this.ue.push(e))}Ne(){let t=this.ae;for(;fe.Pe(t);)10===t&&(this.de=void 0),t=this.we()}static me(t){return t>=48&&t<=57}static Ce(){const t=new Set;for(const e of fe.ke.keys())t.add(e);return t.delete(45),t.add(fe.ne),t}static Ee=fe.Ce();static ge(t){return!fe.Ee.has(t)}static Pe(t){return 32===t||10===t||13===t||9===t||11===t}}!function(t){t[t.ForModelImport=0]="ForModelImport",t[t.Full=1]="Full"}(Ct||(Ct={}));class pe{lexer;Fe;Ae=me.instance;mode=Ct.ForModelImport;get lexerDiagnostics(){return this.lexer.lexerDiagnostics}parserDiagnostics=new le;addParserDiagnostic(t){this.parserDiagnostics.push(t)}unexpectedToken(t,e,s){t?this.addParserDiagnostic({code:xt.AT202,message:`Unexpected '${_t[t.nodeType]}' token. Expected one of following: ${e.map(t=>_t[t]).join(",")}`,severity:Tt.Error,start:t.start,end:t.end}):this.addParserDiagnostic({code:xt.AT203,start:this.lexer.currentTokenLocation(),end:this.lexer.currentTokenLocation(),severity:Tt.Error,message:"Unexpected end of file."}),s&&(this.lexer.fatalError=!0)}constructor(t){this.lexer=new fe(t)}read(){return this.De(),this.Fe}De(){this.Fe={nodeType:_t.Score,bars:[],start:this.lexer.currentTokenLocation()};try{this.Le()}finally{this.Fe.end=this.lexer.previousTokenEndLocation()}}Le(){let t=this.lexer.peekToken();for(;t;)this.We(),t=this.lexer.peekToken()}We(){const t={nodeType:_t.Bar,metaData:[],beats:[],pipe:void 0,start:this.lexer.currentTokenLocation()};this.Fe.bars.push(t);try{this.Oe(t),this.Re(t);const e=this.lexer.peekToken();e?.nodeType===_t.Pipe&&(t.pipe=e,this.lexer.advance()),(t.metaData.length>0||t.beats.length>0||t.pipe)&&(t.end=this.lexer.previousTokenEndLocation())}finally{t.end=this.lexer.previousTokenEndLocation()}}Oe(t){let e=this.lexer.peekToken();for(;e&&(e.nodeType===_t.Tag||e.nodeType===_t.Dot);)e.nodeType===_t.Dot?(this.lexer.advance(),this.addParserDiagnostic({code:xt.AT400,message:"The dots separating score metadata, score contents and the sync points can be removed.",severity:Tt.Hint,start:e.start,end:e.end})):this.Ie(t.metaData),e=this.lexer.peekToken()}Re(t){let e=this.lexer.peekToken();for(;e&&e.nodeType!==_t.Pipe&&e.nodeType!==_t.Dot&&e.nodeType!==_t.Tag;){const s=this.Ge();s&&t.beats.push(s),e=this.lexer.peekToken()}}Ge(){const t={nodeType:_t.Beat,durationChange:void 0,notes:void 0,rest:void 0,beatEffects:void 0,beatMultiplier:void 0,beatMultiplierValue:void 0,start:this.lexer.peekToken()?.start};try{if(this.He(t),this.Ve(t),!t.notes&&!t.rest)return t;this.$e(t),this.Ue(t),t.beatEffects=this.ze(t=>this.Ae.readBeatPropertyArguments(this,t)),void 0!==t.beatMultiplierValue&&t.beatEffects?.openBrace&&this.addParserDiagnostic({code:xt.AT304,message:"The beat multiplier should be specified after the beat effects.",severity:Tt.Warning,start:t.beatMultiplier.start,end:t.beatMultiplierValue.end}),this.Ue(t)}finally{t.end=this.lexer.previousTokenEndLocation()}return t}$e(t){const e=this.lexer.peekToken();if(e?.nodeType!==_t.Dot)return;t.durationDot=e,this.lexer.advance();const s=this.lexer.peekToken();if(s?.nodeType===_t.Number)return t.durationValue=s,void this.lexer.advance();s?.nodeType!==_t.Tag?s&&this.unexpectedToken(s,[_t.Number],!0):t.durationDot=void 0}He(t){const e=this.lexer.peekToken();if(e?.nodeType!==_t.Colon)return;this.lexer.advance();const s={nodeType:_t.Duration,colon:e,value:void 0,properties:void 0,start:e.start};t.durationChange=s;try{const t=this.lexer.peekToken();if(!t||t.nodeType!==_t.Number)return void this.addParserDiagnostic({code:xt.AT201,message:"Missing duration value after ':'.",severity:Tt.Error,start:e.start,end:e.end});this.lexer.advance(),s.value=t,s.properties=this.ze(t=>this.Ae.readDurationChangePropertyArguments(this,t))}finally{s.end=this.lexer.previousTokenEndLocation()}}Ve(t){const e=this.lexer.peekToken();if(e)if(e.nodeType===_t.Ident&&"r"===e.text)t.rest=e,this.lexer.advance();else if(e.nodeType===_t.LParen)t.notes=this.Xe(e);else{const s=this.je(e);s&&(t.notes={nodeType:_t.NoteList,openParenthesis:void 0,notes:[s],closeParenthesis:void 0,start:s.start,end:s.end})}}Ue(t){const e=this.lexer.peekToken();if(!e||e.nodeType!==_t.Asterisk)return;this.lexer.advance(),t.beatMultiplier=e;const s=this.lexer.peekToken();s&&s.nodeType===_t.Number?(t.beatMultiplierValue=s,this.lexer.advance()):this.addParserDiagnostic({code:xt.AT200,message:"Missing beat multiplier value after '*'.",severity:Tt.Error,start:t.beatMultiplier.start,end:t.beatMultiplier.end})}Xe(t){const e={nodeType:_t.NoteList,openParenthesis:void 0,notes:[],closeParenthesis:void 0,start:this.lexer.currentTokenLocation()};try{e.openParenthesis=t,this.lexer.advance();let s=this.lexer.peekToken();for(;s&&s.nodeType!==_t.RParen;){const t=this.je(s);if(!t)break;e.notes.push(t),s=this.lexer.peekToken()}const i=this.lexer.peekToken();i?.nodeType===_t.RParen?(e.closeParenthesis=i,this.lexer.advance()):this.addParserDiagnostic({code:xt.AT206,message:"Unexpected end of file. Group not closed.",severity:Tt.Error,start:i?.start??this.lexer.currentTokenLocation(),end:i?.end??this.lexer.currentTokenLocation()})}finally{e.end=this.lexer.previousTokenEndLocation()}return e}je(t){const e={nodeType:_t.Note,noteValue:{nodeType:_t.Ident,text:""},start:t.start};try{let s=!1;switch(t.nodeType){case _t.Number:e.noteValue=t,this.lexer.advance(),s=!0;break;case _t.String:case _t.Ident:switch(e.noteValue=t,this.lexer.advance(),e.noteValue.text){case"x":case"-":s=!0}break;default:return void this.unexpectedToken(t,[_t.Number,_t.String,_t.Ident],!0)}if(s){const t=this.lexer.peekToken();if(t?.nodeType===_t.Dot){const s=t;this.lexer.advance();const i=this.lexer.peekToken();if(!i)return void this.unexpectedToken(i,[_t.Number],!0);if(i.nodeType===_t.Tag)return e;if(i.nodeType!==_t.Number)return void this.unexpectedToken(i,[_t.Number],!0);e.noteStringDot=s,e.noteString=i,this.lexer.advance()}}e.noteEffects=this.ze(t=>this.Ae.readNotePropertyArguments(this,t))}finally{e.end=this.lexer.previousTokenEndLocation()}return e}static Je=new Set(["chord"]);Ie(t){const e=this.lexer.peekToken();if(!e||e.nodeType!==_t.Tag)return;const s={nodeType:_t.Meta,tag:e,start:e.start,properties:void 0,propertiesBeforeArguments:!1};this.lexer.advance(),t.push(s);try{const t=pe.Je.has(s.tag.tag.text),e=this.lexer.peekToken();t&&e?.nodeType===_t.LBrace?(s.propertiesBeforeArguments=!0,s.properties=this.ze(t=>this.Ae.readMetaDataPropertyArguments(this,s.tag,t)),s.arguments=this.argumentList(),s.arguments||(s.arguments=this.Ae.readMetaDataArguments(this,s.tag),s.arguments&&s.arguments.arguments.length>1&&(this.addParserDiagnostic({code:xt.AT301,message:"Metadata arguments should be wrapped into parenthesis.",severity:Tt.Warning,start:s.arguments?.start??s.start,end:s.arguments?.end??s.end}),this.addParserDiagnostic({code:xt.AT302,message:"Metadata arguments should be placed before metadata properties.",severity:Tt.Warning,start:s.arguments?.start??s.start,end:s.arguments?.end??s.end})))):(this.Ae.hasMetaDataArguments(s.tag)&&(s.arguments=this.argumentList(),s.arguments||(s.arguments=this.Ae.readMetaDataArguments(this,s.tag),s.arguments&&s.arguments.arguments.length>1&&this.addParserDiagnostic({code:xt.AT301,message:"Metadata arguments should be wrapped into parenthesis.",severity:Tt.Warning,start:s.arguments?.start??s.start,end:s.arguments?.end??s.end}))),s.properties=this.ze(t=>this.Ae.readMetaDataPropertyArguments(this,s.tag,t)))}finally{s.end=this.lexer.previousTokenEndLocation()}return s}ze(t){const e=this.lexer.peekToken();if(!e||e.nodeType!==_t.LBrace)return;const s={nodeType:_t.Props,openBrace:e,properties:[],closeBrace:void 0,start:e.start};this.lexer.advance();try{let e=this.lexer.peekToken();for(;e?.nodeType===_t.Ident;)s.properties.push(this.qe(e,t)),e=this.lexer.peekToken();const i=this.lexer.peekToken();i?.nodeType===_t.RBrace?(s.closeBrace=i,this.lexer.advance()):this.addParserDiagnostic({code:xt.AT206,message:"Unexpected end of file. Group not closed.",severity:Tt.Error,start:this.lexer.currentTokenLocation(),end:this.lexer.currentTokenLocation()})}finally{s.end=this.lexer.previousTokenEndLocation()}return s}qe(t,e){const s={nodeType:_t.Prop,property:t,arguments:void 0};this.lexer.advance(),s.start=s.property.start;try{s.arguments=this.argumentList(),s.arguments||(s.arguments=e(s),s.arguments&&s.arguments.arguments.length>1&&this.addParserDiagnostic({code:xt.AT303,message:"Property args should be wrapped into parenthesis.",severity:Tt.Warning,start:s.arguments.start,end:s.arguments.end}))}finally{s.end=this.lexer.previousTokenEndLocation()}return s}argumentList(){const t=this.lexer.peekToken();if(t?.nodeType!==_t.LParen)return;const e={nodeType:_t.Arguments,openParenthesis:t,arguments:[],closeParenthesis:void 0,start:t.start};this.lexer.advance();try{let t=this.lexer.peekToken();for(;t&&t?.nodeType!==_t.RParen;){switch(t.nodeType){case _t.Ident:case _t.String:e.arguments.push(t),this.lexer.advance();break;case _t.Number:e.arguments.push(this.lexer.extendToFloat(t)),this.lexer.advance();break;default:this.unexpectedToken(t,[_t.Ident,_t.String,_t.Number],!1),this.lexer.advance()}t=this.lexer.peekToken()}const s=this.lexer.peekToken();s?.nodeType===_t.RParen?(e.closeParenthesis=s,this.lexer.advance()):this.addParserDiagnostic({code:xt.AT206,message:"Unexpected end of file. Group not closed.",severity:Tt.Error,start:this.lexer.currentTokenLocation(),end:this.lexer.currentTokenLocation()})}finally{e.end=this.lexer.previousTokenEndLocation()}return e}}class be{static ident(t){return{nodeType:_t.Ident,text:t}}static string(t){return{nodeType:_t.String,text:t}}static number(t){return{nodeType:_t.Number,value:t}}static meta(t,e,s){return{nodeType:_t.Meta,tag:{nodeType:_t.Tag,prefix:{nodeType:_t.Backslash},tag:{nodeType:_t.Ident,text:t}},arguments:e,properties:s,propertiesBeforeArguments:!1}}static identMeta(t,e){return be.meta(t,be.identValue(e))}static numberMeta(t,e){return be.meta(t,be.numberValue(e))}static args(t,e=void 0){const s={nodeType:_t.Arguments,arguments:t.filter(t=>void 0!==t)};if((void 0===e?s.arguments.length>1:e)&&(s.openParenthesis={nodeType:_t.LParen},s.closeParenthesis={nodeType:_t.RParen}),0!==s.arguments.length)return s}static stringValue(t){return be.args([be.string(t)])}static identValue(t){return be.args([be.ident(t)])}static numberValue(t){return be.args([be.number(t)])}static props(t){const e={nodeType:_t.Props,properties:[],openBrace:{nodeType:_t.LBrace},closeBrace:{nodeType:_t.RBrace}};for(const s of t)s&&e.properties.push({nodeType:_t.Prop,property:be.ident(s[0]),arguments:s[1]});return e}static prop(t,e,s){t.push({nodeType:_t.Prop,property:be.ident(e),arguments:s})}}class me{static instance=new me;static Ye=new Set([_t.LParen,_t.String,_t.Ident,_t.Number]);hasMetaDataArguments(t){const e=t.tag.text.toLowerCase();for(const t of ce.metaDataSignatures)if(t.has(e)){return null!==t.get(e)}return!0}readMetaDataArguments(t,e){const s=e.tag.text.toLowerCase();for(const e of ce.metaDataSignatures)if(e.has(s)){const i=e.get(s);return i?this.Ke(t,i):void 0}t.addParserDiagnostic({code:xt.AT204,message:`Unrecognized metadata '${e.tag.text}'.`,severity:Tt.Error,start:e.start,end:e.end}),t.lexer.fatalError=!0}readMetaDataPropertyArguments(t,e,s){const i=e.tag.text.toLowerCase();if(!ce.metaDataProperties.has(i))return;const n=ce.metaDataProperties.get(i);return n?this.Qe(t,[n],s):this.Qe(t,[],s)}readBeatPropertyArguments(t,e){return this.Qe(t,[ce.beatProperties],e)}readDurationChangePropertyArguments(t,e){return this.Qe(t,[ce.durationChangeProperties],e)}readNotePropertyArguments(t,e){return this.Qe(t,[ce.noteProperties,ce.beatProperties],e)}Qe(t,e,s){const i=s.property.text.toLowerCase(),n=new Set([_t.Ident,_t.RBrace]);for(const s of e)if(s.has(i)){const e=s.get(i);return e?this.Ke(t,e,n):void this.Ze(t,[],n)}let r=t.lexer.peekToken();for(;r&&r.nodeType!==_t.Ident&&r.nodeType!==_t.RBrace;)t.lexer.advance(),r=t.lexer.peekToken();t.addParserDiagnostic({code:xt.AT205,message:`Unrecognized property '${s.property.text}'.`,severity:Tt.Error,start:s.property.start,end:r?.start??t.lexer.currentTokenLocation()})}Ke(t,e,s){if(1===e.length&&0===e[0].parameters.length)return;const i=[],n=t.lexer.peekToken()?.start,r=void 0!==s,a=new Map(e.map((t,e)=>[e,{signature:t,parameterIndex:0,parameterHasValues:!1,parameterValueMatches:0}])),h=this.ts(t,a,i,s),o=this.es(t,a,i,s,e,n);return r&&this.Ze(t,e,s),this.ss(i,n,t.lexer.previousTokenEndLocation(),o,h)}es(t,e,s,i,n,r){const a=t.lexer.peekToken();let h=!1;return 1!==e.size&&void 0===a?(t.addParserDiagnostic({code:xt.AT203,start:t.lexer.currentTokenLocation(),end:t.lexer.currentTokenLocation(),severity:Tt.Error,message:"Unexpected end of file."}),h=!0):0===e.size&&(void 0!==a&&0===s.length&&i&&!i.has(a.nodeType)&&(s.push(t.lexer.peekToken()),t.lexer.advance()),t.addParserDiagnostic({code:xt.AT219,message:`Error parsing arguments: no overload matched arguments ${me.generateSignaturesFromArguments(s)}. Signatures:\n${me.generateSignatures(n)}`,severity:Tt.Error,start:r,end:t.lexer.previousTokenEndLocation()}),h=!0),h}ss(t,e,s,i,n){if(0===t.length)return;const r=be.args(t,!1);return r.start=e,r.end=s,r.validated=!i,n&&(n.length>1&&me.sortCandidates(n),r.signatureCandidateIndices=n.map(t=>t[0])),r}ts(t,e,s,i){const n=t.mode===Ct.Full,r=(i,r)=>{const a=e.get(r);if(i.nodeType===_t.LParen){const e=t.argumentList();if(e)for(const t of e.arguments)n&&(t.parameterIndices||(t.parameterIndices=new Map),t.parameterIndices.set(r,a.parameterIndex)),s.push(t)}else{const e=i;n&&(e.parameterIndices||(e.parameterIndices=new Map),e.parameterIndices.set(r,a.parameterIndex)),0!==s.length&&s[s.length-1]===e||(s.push(e),t.lexer.advance())}},a=e=>{t.lexer.extendToFloat(e)},h=me.Ye;for(;e.size>1||e.size>0&&!me.ns(e);){const s=t.lexer.peekToken();if(!s||!h.has(s.nodeType))break;if(!me.filterSignatureCandidates(e,s,void 0!==i&&i.has(s.nodeType),r,a))break}const o=t.mode===Ct.Full?Array.from(e.entries()):void 0;return me.filterIncompleteCandidates(e),o}static sortCandidates(t){t.length<2||t.sort((t,e)=>{const s=Math.abs(t[1].parameterIndex-t[1].signature.parameters.length),i=Math.abs(e[1].parameterIndex-e[1].signature.parameters.length);if(s===i){const s=t[1].parameterValueMatches;return e[1].parameterValueMatches-s}return s-i})}Ze(t,e,s){const i=t.lexer.currentTokenLocation();let n=t.lexer.peekToken(),r=!1;const a=me.Ye;for(;n&&!s.has(n.nodeType);)a.has(n.nodeType)?(t.lexer.advance(),r=!0,n=t.lexer.peekToken()):n=void 0;r&&t.addParserDiagnostic({code:xt.AT220,message:`Error parsing arguments: unexpected additional arguments. Signatures:\n${me.generateSignatures(e)}`,severity:Tt.Error,start:i,end:t.lexer.previousTokenEndLocation()})}static ns(t){for(const e of t.values())if(e.parameterIndex===e.signature.parameters.length)return!0;return!1}static filterIncompleteCandidates(t){const e=new Set;for(const[s,i]of t)for(let t=i.parameterIndex;t<i.signature.parameters.length;t++){switch(i.signature.parameters[t].parseMode){case Pt.Required:case Pt.RequiredAsFloat:e.add(s)}}for(const s of e)t.delete(s)}static generateSignaturesFromArguments(t){return t?`(${t.map(t=>_t[t.nodeType]).join(", ")})`:"()"}static generateSignatures(t,e){return 0===t.length?"()":t.map((t,s)=>me.rs(t,void 0!==e&&e.size>1&&e.has(s))).join("\n")}static rs(t,e){const s=e?" ~":"";return`(${t.parameters.map(me.hs).join(", ")})${s}`}static hs(t,e){const s=Array.from(t.expectedTypes);let i=`v${e}`;switch(t.parseMode){case Pt.Optional:case Pt.OptionalAsFloat:i+="?"}if(t.allowedValues&&t.allowedValues.size<5){const e=Array.from(t.allowedValues);if(s[0]===_t.String)i=e.map(t=>`"${t}"`).join("|");else i=e.join("|")}else i=Array.from(t.expectedTypes).map(t=>_t[t]).join("|");switch(t.parseMode){case Pt.RequiredAsValueList:case Pt.ValueListWithoutParenthesis:i+="[]"}return i}static filterSignatureCandidates(t,e,s,i,n){const r=new Set;let a=!1;for(const[h,o]of t){let t=!1;for(;!t;){const c=o.parameterIndex<o.signature.parameters.length?o.signature.parameters[o.parameterIndex]:void 0;if(c)if(o.signature.isStrict&&o.parameterIndex>0)r.add(h),t=!0;else if((c.expectedTypes.has(e.nodeType)||me.cs(e,c))&&me.ls(e,c,n))switch(t=!0,a=!0,i(e,h),c.allowedValues&&o.parameterValueMatches++,c.parseMode){case Pt.ValueListWithoutParenthesis:o.parameterHasValues=!0;break;case Pt.RequiredAsValueList:default:o.parameterIndex++,o.parameterHasValues=!1}else switch(c.parseMode){case Pt.ValueListWithoutParenthesis:o.parameterIndex++,o.parameterHasValues=!1;break;case Pt.Required:case Pt.RequiredAsFloat:r.add(h),t=!0;break;case Pt.Optional:case Pt.OptionalAsFloat:case Pt.RequiredAsValueList:o.parameterIndex++,o.parameterHasValues=!1}else s||r.add(h),t=!0}}if(a)for(const e of r)t.delete(e);return a}static ls(t,e,s){switch(t.nodeType){case _t.Ident:const i=t;return e?.allowedValues?e.allowedValues.has(i.text.toLowerCase()):!e?.reservedIdentifiers||!e.reservedIdentifiers.has(i.text.toLowerCase());case _t.String:const n=t;return!e?.allowedValues||e.allowedValues.has(n.text.toLowerCase());case _t.Number:switch(e?.parseMode??Pt.Optional){case Pt.RequiredAsFloat:case Pt.OptionalAsFloat:return s?.(t),!0;default:return!0}case _t.LParen:return!0}return!1}static cs(t,e){return t.nodeType===_t.LParen&&(e.expectedTypes.has(_t.Arguments)||e.parseMode===Pt.ValueListWithoutParenthesis||e.parseMode===Pt.RequiredAsValueList)}}!function(t){t[t.Applied=0]="Applied",t[t.NotAppliedSemanticError=1]="NotAppliedSemanticError",t[t.NotAppliedUnrecognizedMarker=2]="NotAppliedUnrecognizedMarker"}(Et||(Et={})),function(t){t[t.AppliedNewTrack=0]="AppliedNewTrack",t[t.AppliedNewStaff=1]="AppliedNewStaff",t[t.AppliedNewVoice=2]="AppliedNewVoice",t[t.NotAppliedSemanticError=3]="NotAppliedSemanticError",t[t.NotAppliedUnrecognizedMarker=4]="NotAppliedUnrecognizedMarker"}(Ft||(Ft={}));class ge{static us=new Map([["acousticgrandpiano",0],["brightacousticpiano",1],["electricgrandpiano",2],["honkytonkpiano",3],["electricpiano1",4],["electricpiano2",5],["harpsichord",6],["clavinet",7],["celesta",8],["glockenspiel",9],["musicbox",10],["vibraphone",11],["marimba",12],["xylophone",13],["tubularbells",14],["dulcimer",15],["drawbarorgan",16],["percussiveorgan",17],["rockorgan",18],["churchorgan",19],["reedorgan",20],["accordion",21],["harmonica",22],["tangoaccordion",23],["acousticguitarnylon",24],["acousticguitarsteel",25],["electricguitarjazz",26],["electricguitarclean",27],["electricguitarmuted",28],["overdrivenguitar",29],["distortionguitar",30],["guitarharmonics",31],["acousticbass",32],["electricbassfinger",33],["electricbasspick",34],["fretlessbass",35],["slapbass1",36],["slapbass2",37],["synthbass1",38],["synthbass2",39],["violin",40],["viola",41],["cello",42],["contrabass",43],["tremolostrings",44],["pizzicatostrings",45],["orchestralharp",46],["timpani",47],["stringensemble1",48],["stringensemble2",49],["synthstrings1",50],["synthstrings2",51],["choiraahs",52],["voiceoohs",53],["synthvoice",54],["orchestrahit",55],["trumpet",56],["trombone",57],["tuba",58],["mutedtrumpet",59],["frenchhorn",60],["brasssection",61],["synthbrass1",62],["synthbrass2",63],["sopranosax",64],["altosax",65],["tenorsax",66],["baritonesax",67],["oboe",68],["englishhorn",69],["bassoon",70],["clarinet",71],["piccolo",72],["flute",73],["recorder",74],["panflute",75],["blownbottle",76],["shakuhachi",77],["whistle",78],["ocarina",79],["lead1square",80],["lead2sawtooth",81],["lead3calliope",82],["lead4chiff",83],["lead5charang",84],["lead6voice",85],["lead7fifths",86],["lead8bassandlead",87],["pad1newage",88],["pad2warm",89],["pad3polysynth",90],["pad4choir",91],["pad5bowed",92],["pad6metallic",93],["pad7halo",94],["pad8sweep",95],["fx1rain",96],["fx2soundtrack",97],["fx3crystal",98],["fx4atmosphere",99],["fx5brightness",100],["fx6goblins",101],["fx7echoes",102],["fx8scifi",103],["sitar",104],["banjo",105],["shamisen",106],["koto",107],["kalimba",108],["bagpipe",109],["fiddle",110],["shanai",111],["tinklebell",112],["agogo",113],["steeldrums",114],["woodblock",115],["taikodrum",116],["melodictom",117],["synthdrum",118],["reversecymbal",119],["guitarfretnoise",120],["breathnoise",121],["seashore",122],["birdtweet",123],["telephonering",124],["helicopter",125],["applause",126],["gunshot",127]]);static getValue(t){return ge.us||(ge.us=new Map),t=t.toLowerCase().replaceAll(" ",""),ge.us.has(t)?ge.us.get(t):0}static getName(t){for(const[e,s]of ge.us)if(s===t)return e;return t.toString()}static isPiano(t){return t<=7||t>=16&&t<=23}static isGuitar(t){return t>=24&&t<=39||105===t||43===t}static isBass(t){return t>=32&&t<=39}static bankToLsbMsb(t){return[127&t,t>>7&127]}}class we{name="";firstFret=1;strings=[];barreFrets=[];staff;showName=!0;showDiagram=!0;showFingering=!0;get uniqueId(){return[this.name,this.firstFret.toString(),this.strings.join(","),this.barreFrets.join(","),this.showDiagram.toString(),this.showFingering.toString(),this.showName.toString()].join("|")}}class ye extends I{constructor(t){super(s.Format,t)}}class ke{static BlackRgb="#000000";constructor(t,e,s,i=255){this.raw=(255&i)<<24|(255&t)<<16|(255&e)<<8|255&s,this.updateRgba()}updateRgba(){255===this.a?this.rgba=`#${zt.toHexString(this.r,2)}${zt.toHexString(this.g,2)}${zt.toHexString(this.b,2)}`:this.rgba=`rgba(${this.r},${this.g},${this.b},${this.a/255})`}raw=0;get a(){return this.raw>>24&255}get r(){return this.raw>>16&255}get g(){return this.raw>>8&255}get b(){return 255&this.raw}rgba;static random(t=100){return new ke(255*Math.random()|0,255*Math.random()|0,255*Math.random()|0,t)}static fromJson(t){if(t instanceof ke)return t;switch(typeof t){case"number":{const e=new ke(0,0,0,0);return e.raw=t,e.updateRgba(),e}case"string":{const e=t;if(e.startsWith("#")){if(4===e.length)return new ke(17*Number.parseInt(e[1],16),17*Number.parseInt(e[2],16),17*Number.parseInt(e[3],16));if(5===e.length)return new ke(17*Number.parseInt(e[1],16),17*Number.parseInt(e[2],16),17*Number.parseInt(e[3],16),17*Number.parseInt(e[4],16));if(7===e.length)return new ke(Number.parseInt(e.substring(1,3),16),Number.parseInt(e.substring(3,5),16),Number.parseInt(e.substring(5,7),16));if(9===e.length)return new ke(Number.parseInt(e.substring(1,3),16),Number.parseInt(e.substring(3,5),16),Number.parseInt(e.substring(5,7),16),Number.parseInt(e.substring(7,9),16))}else if(e.startsWith("rgba")||e.startsWith("rgb")){const t=e.indexOf("("),s=e.lastIndexOf(")");if(-1===t||-1===s)throw new ye("No values specified for rgb/rgba function");const i=e.substring(t+1,s).split(",");if(3===i.length)return new ke(Number.parseInt(i[0],10),Number.parseInt(i[1],10),Number.parseInt(i[2],10));if(4===i.length)return new ke(Number.parseInt(i[0],10),Number.parseInt(i[1],10),Number.parseInt(i[2],10),255*Number.parseFloat(i[3]))}return null}}throw new ye("Unsupported format for color")}static toJson(t){return null===t?null:t.raw}}!function(t){t[t.Short=0]="Short",t[t.Medium=1]="Medium",t[t.Long=2]="Long"}(At||(At={}));class Se{type=At.Short;length=0}!function(t){t[t.IgnoreSpaces=0]="IgnoreSpaces",t[t.Begin=1]="Begin",t[t.Text=2]="Text",t[t.Comment=3]="Comment",t[t.Dash=4]="Dash"}(Dt||(Dt={}));class Be{static ds=10;static fs=9;static ps=13;static bs=32;static gs=93;static ws=91;static ys=45;startBar=0;text="";chunks;finish(t=!1){this.chunks=[],this.ks(this.text,0,this.chunks,t)}ks(t,e,s,i){if(!t)return;let n=Dt.Begin,r=Dt.Begin,a=!1,h=0;for(;e<t.length;){const s=t.charCodeAt(e);switch(n){case Dt.IgnoreSpaces:switch(s){case Be.ds:case Be.ps:case Be.fs:break;case Be.bs:if(!a){n=r;continue}break;default:a=!1,n=r;continue}break;case Dt.Begin:if(s!==Be.ws){h=e,n=Dt.Text;continue}n=Dt.Comment;break;case Dt.Comment:if(s===Be.gs)n=Dt.Begin;break;case Dt.Text:switch(s){case Be.ys:n=Dt.Dash;break;case Be.ps:case Be.ds:case Be.bs:const s=t.substr(h,e-h);this.Ss(s,i),n=Dt.IgnoreSpaces,r=Dt.Begin}break;case Dt.Dash:if(s!==Be.ys){const s=t.substr(h,e-h);this.Ss(s,i),a=!0,n=Dt.IgnoreSpaces,r=Dt.Begin;continue}}e+=1}n===Dt.Text&&e!==h&&this.Ss(t.substr(h,e-h),i)}Ss(t,e){t=this.Bs(t),(!e||t.length>0&&"-"!==t)&&this.chunks.push(t)}Bs(t){const e=t.split("+").join(" ");let s=e.length;for(;s>0&&"_"===e.charAt(s-1);)s--;return s!==e.length?e.substr(0,s):e}}class _e{marker="";text=""}class Te{static _s=[];static Ts=[];static xs=[];static Ms=[];static vs=new Map;static noteNames=["C","Db","D","Eb","E","F","Gb","G","Ab","A","Bb","B"];static getTextForTuning(t,e){const s=Te.getTextPartsForTuning(t);return e?s.join(""):s[0]}static getTextPartsForTuning(t,e=-1){const s=t/12|0,i=t%12;return[Te.noteNames[i],(s+e).toString()]}static getDefaultTuningFor(t){if(Te.vs.has(t)){const e=Te.vs.get(t);return new Te(e.name,e.tunings,e.isStandard)}return null}static getPresetsFor(t){switch(t){case 7:return Te._s;case 6:return Te.Ts;case 5:return Te.xs;case 4:return Te.Ms}return[]}static initialize(){Te.vs.set(7,new Te("Guitar 7 strings",[64,59,55,50,45,40,35],!0)),Te._s.push(Te.vs.get(7)),Te.vs.set(6,new Te("Guitar Standard Tuning",[64,59,55,50,45,40],!0)),Te.Ts.push(Te.vs.get(6)),Te.Ts.push(new Te("Guitar Tune down ½ step",[63,58,54,49,44,39],!1)),Te.Ts.push(new Te("Guitar Tune down 1 step",[62,57,53,48,43,38],!1)),Te.Ts.push(new Te("Guitar Tune down 2 step",[60,55,51,46,41,36],!1)),Te.Ts.push(new Te("Guitar Dropped D Tuning",[64,59,55,50,45,38],!1)),Te.Ts.push(new Te("Guitar Dropped D Tuning variant",[64,57,55,50,45,38],!1)),Te.Ts.push(new Te("Guitar Double Dropped D Tuning",[62,59,55,50,45,38],!1)),Te.Ts.push(new Te("Guitar Dropped E Tuning",[66,61,57,52,47,40],!1)),Te.Ts.push(new Te("Guitar Dropped C Tuning",[62,57,53,48,43,36],!1)),Te.Ts.push(new Te("Guitar Open C Tuning",[64,60,55,48,43,36],!1)),Te.Ts.push(new Te("Guitar Open Cm Tuning",[63,60,55,48,43,36],!1)),Te.Ts.push(new Te("Guitar Open C6 Tuning",[64,57,55,48,43,36],!1)),Te.Ts.push(new Te("Guitar Open Cmaj7 Tuning",[64,59,55,52,43,36],!1)),Te.Ts.push(new Te("Guitar Open D Tuning",[62,57,54,50,45,38],!1)),Te.Ts.push(new Te("Guitar Open Dm Tuning",[62,57,53,50,45,38],!1)),Te.Ts.push(new Te("Guitar Open D5 Tuning",[62,57,50,50,45,38],!1)),Te.Ts.push(new Te("Guitar Open D6 Tuning",[62,59,54,50,45,38],!1)),Te.Ts.push(new Te("Guitar Open Dsus4 Tuning",[62,57,55,50,45,38],!1)),Te.Ts.push(new Te("Guitar Open E Tuning",[64,59,56,52,47,40],!1)),Te.Ts.push(new Te("Guitar Open Em Tuning",[64,59,55,52,47,40],!1)),Te.Ts.push(new Te("Guitar Open Esus11 Tuning",[64,59,55,52,45,40],!1)),Te.Ts.push(new Te("Guitar Open F Tuning",[65,60,53,48,45,41],!1)),Te.Ts.push(new Te("Guitar Open G Tuning",[62,59,55,50,43,38],!1)),Te.Ts.push(new Te("Guitar Open Gm Tuning",[62,58,55,50,43,38],!1)),Te.Ts.push(new Te("Guitar Open G6 Tuning",[64,59,55,50,43,38],!1)),Te.Ts.push(new Te("Guitar Open Gsus4 Tuning",[62,60,55,50,43,38],!1)),Te.Ts.push(new Te("Guitar Open A Tuning",[64,61,57,52,45,40],!1)),Te.Ts.push(new Te("Guitar Open Am Tuning",[64,60,57,52,45,40],!1)),Te.Ts.push(new Te("Guitar Nashville Tuning",[64,59,67,62,57,52],!1)),Te.Ts.push(new Te("Bass 6 Strings Tuning",[48,43,38,33,28,23],!1)),Te.Ts.push(new Te("Lute or Vihuela Tuning",[64,59,54,50,45,40],!1)),Te.vs.set(5,new Te("Bass 5 Strings Tuning",[43,38,33,28,23],!0)),Te.xs.push(Te.vs.get(5)),Te.xs.push(new Te("Banjo Dropped C Tuning",[62,59,55,48,67],!1)),Te.xs.push(new Te("Banjo Open D Tuning",[62,57,54,50,69],!1)),Te.xs.push(new Te("Banjo Open G Tuning",[62,59,55,50,67],!1)),Te.xs.push(new Te("Banjo G Minor Tuning",[62,58,55,50,67],!1)),Te.xs.push(new Te("Banjo G Modal Tuning",[62,57,55,50,67],!1)),Te.vs.set(4,new Te("Bass Standard Tuning",[43,38,33,28],!0)),Te.Ms.push(Te.vs.get(4)),Te.Ms.push(new Te("Bass Tune down ½ step",[42,37,32,27],!1)),Te.Ms.push(new Te("Bass Tune down 1 step",[41,36,31,26],!1)),Te.Ms.push(new Te("Bass Tune down 2 step",[39,34,29,24],!1)),Te.Ms.push(new Te("Bass Dropped D Tuning",[43,38,33,26],!1)),Te.Ms.push(new Te("Ukulele C Tuning",[45,40,36,43],!1)),Te.Ms.push(new Te("Ukulele G Tuning",[52,47,43,38],!1)),Te.Ms.push(new Te("Mandolin Standard Tuning",[64,57,50,43],!1)),Te.Ms.push(new Te("Mandolin or Violin Tuning",[76,69,62,55],!1)),Te.Ms.push(new Te("Viola Tuning",[69,62,55,48],!1)),Te.Ms.push(new Te("Cello Tuning",[57,50,43,36],!1))}static findTuning(t){const e=Te.getPresetsFor(t.length);for(let s=0,i=e.length;s<i;s++){const i=e[s];let n=!0;for(let e=0,s=t.length;e<s;e++)if(t[e]!==i.tunings[e]){n=!1;break}if(n)return new Te(i.name,i.tunings,i.isStandard)}return null}isStandard;name;tunings;constructor(t="",e=null,s=!1){this.isStandard=s,this.name=t,this.tunings=e??[]}reset(){this.isStandard=!1,this.name="",this.tunings=[]}finish(){const t=Te.findTuning(this.tunings);t&&(0===this.name.length&&(this.name=t.name),this.isStandard=t.isStandard)}}Te.initialize();class xe{static DefaultStandardNotationLineCount=5;index=0;track;bars=[];chords=null;capo=0;transpositionPitch=0;displayTranspositionPitch=0;stringTuning=new Te("",[],!1);get tuning(){return this.stringTuning.tunings}get tuningName(){return this.stringTuning.name}get isStringed(){return this.stringTuning.tunings.length>0}showSlash=!1;showNumbered=!1;showTablature=!0;showStandardNotation=!0;isPercussion=!1;standardNotationLineCount=xe.DefaultStandardNotationLineCount;I=new Set([0]);get filledVoices(){return this.I}finish(t,e=null){this.isPercussion&&(this.stringTuning.tunings=[],this.showTablature=!1,this.displayTranspositionPitch=0),this.stringTuning.finish(),0===this.stringTuning.tunings.length&&(this.showTablature=!1);for(let s=0,i=this.bars.length;s<i;s++){this.bars[s].finish(t,e);for(const t of this.bars[s].filledVoices)this.I.add(t)}}addChord(t,e){e.staff=this;let s=this.chords;null===s&&(s=new Map,this.chords=s),s.set(t,e)}hasChord(t){return this.chords?.has(t)??!1}getChord(t){return this.chords?.get(t)??null}addBar(t){const e=this.bars;t.staff=this,t.index=e.length,e.length>0&&(t.previousBar=e[e.length-1],t.previousBar.nextBar=t),e.push(t)}}class Me{volume=15;balance=8;port=1;program=0;bank=0;primaryChannel=0;secondaryChannel=0;isMute=!1;isSolo=!1}!function(t){t[t.TrackName=0]="TrackName",t[t.BracesAndBrackets=1]="BracesAndBrackets",t[t.SystemSeparator=2]="SystemSeparator",t[t.StringTuning=3]="StringTuning"}(Lt||(Lt={}));class ve extends q{}class Ne{static Ns=10;index=0;score;staves=[];playbackInfo=new Me;color=new ke(200,0,0,255);name="";isVisibleOnMultiTrack=!0;shortName="";defaultSystemsLayout=3;systemsLayout=[];lineBreaks;get isPercussion(){return this.staves.some(t=>t.isPercussion)}addLineBreaks(t){this.lineBreaks||(this.lineBreaks=new Set),this.lineBreaks.add(t)}percussionArticulations=[];style;ensureStaveCount(t){for(;this.staves.length<t;)this.addStaff(new xe)}addStaff(t){t.index=this.staves.length,t.track=this,this.staves.push(t)}finish(t,e=null){this.shortName||(this.shortName=this.name,this.shortName.length>Ne.Ns&&(this.shortName=this.shortName.substr(0,Ne.Ns)));for(const s of this.staves)s.finish(t,e),s.isPercussion&&(this.playbackInfo.program=0)}applyLyrics(t){for(const e of t)e.finish();const e=this.staves[0];for(let s=0;s<t.length;s++){const i=t[s];if(i.startBar>=0&&i.startBar<e.bars.length){let n=e.bars[i.startBar].voices[0].beats[0];for(let e=0;e<i.chunks.length&&n;e++){for(;n&&(n.isEmpty||n.isRest);)n=n.nextBeat;n&&(n.lyrics||(n.lyrics=new Array(t.length),n.lyrics.fill("")),n.lyrics[s]=i.chunks[e],n=n.nextBeat)}}}}}!function(t){t[t.Up=0]="Up",t[t.Down=1]="Down"}(Wt||(Wt={}));class Pe{static instance=new Pe;static Ps=new Set([1,2,4,8,16,32,64,128]);applyScoreMetaData(t,e,s){const i=this.Cs(t,[ce.scoreMetaDataSignatures],s,s.tag.tag.text.toLowerCase(),s.arguments);if(void 0!==i)return i;switch(s.tag.tag.text.toLowerCase()){case"title":return e.title=s.arguments.arguments[0].text,this.Es(t,e,ot.Title,s),Et.Applied;case"subtitle":return e.subTitle=s.arguments.arguments[0].text,this.Es(t,e,ot.SubTitle,s),Et.Applied;case"artist":return e.artist=s.arguments.arguments[0].text,this.Es(t,e,ot.Artist,s),Et.Applied;case"album":return e.album=s.arguments.arguments[0].text,this.Es(t,e,ot.Album,s),Et.Applied;case"words":return e.words=s.arguments.arguments[0].text,this.Es(t,e,ot.Words,s),Et.Applied;case"music":return e.music=s.arguments.arguments[0].text,this.Es(t,e,ot.Music,s),Et.Applied;case"copyright":return e.copyright=s.arguments.arguments[0].text,this.Es(t,e,ot.Copyright,s),Et.Applied;case"instructions":return e.instructions=s.arguments.arguments[0].text,Et.Applied;case"notices":return e.notices=s.arguments.arguments[0].text,Et.Applied;case"tab":return e.tab=s.arguments.arguments[0].text,this.Es(t,e,ot.Transcriber,s),Et.Applied;case"copyright2":return this.Es(t,e,ot.CopyrightSecondLine,s,0),Et.Applied;case"wordsandmusic":return this.Es(t,e,ot.WordsAndMusic,s,0),Et.Applied;case"defaultsystemslayout":return e.defaultSystemsLayout=s.arguments.arguments[0].value,Et.Applied;case"systemslayout":for(const t of s.arguments.arguments)e.systemsLayout.push(t.value);return Et.Applied;case"hidedynamics":return e.stylesheet.hideDynamics=!0,Et.Applied;case"showdynamics":return e.stylesheet.hideDynamics=!1,Et.Applied;case"extendbarlines":return e.stylesheet.extendBarLines=!0,Et.Applied;case"bracketextendmode":const i=Pe.Fs(t,s.arguments,"bracket extend mode",oe.bracketExtendMode);return void 0===i?Et.NotAppliedSemanticError:(e.stylesheet.bracketExtendMode=i,Et.Applied);case"usesystemsignseparator":return e.stylesheet.useSystemSignSeparator=!0,Et.Applied;case"multibarrest":return e.stylesheet.multiTrackMultiBarRest=!0,Et.Applied;case"singletracktracknamepolicy":const n=Pe.Fs(t,s.arguments,"track name policy",oe.trackNamePolicy);return void 0===n?Et.NotAppliedSemanticError:(e.stylesheet.singleTrackTrackNamePolicy=n,Et.Applied);case"multitracktracknamepolicy":const r=Pe.Fs(t,s.arguments,"track name policy",oe.trackNamePolicy);return void 0===r?Et.NotAppliedSemanticError:(e.stylesheet.multiTrackTrackNamePolicy=r,Et.Applied);case"firstsystemtracknamemode":const a=Pe.Fs(t,s.arguments,"track name mode",oe.trackNameMode);return void 0===a?Et.NotAppliedSemanticError:(e.stylesheet.firstSystemTrackNameMode=a,Et.Applied);case"othersystemstracknamemode":const h=Pe.Fs(t,s.arguments,"track name mode",oe.trackNameMode);return void 0===h?Et.NotAppliedSemanticError:(e.stylesheet.otherSystemsTrackNameMode=h,Et.Applied);case"firstsystemtracknameorientation":const o=Pe.Fs(t,s.arguments,"track name orientation",oe.trackNameOrientation);return void 0===o?Et.NotAppliedSemanticError:(e.stylesheet.firstSystemTrackNameOrientation=o,Et.Applied);case"othersystemstracknameorientation":const c=Pe.Fs(t,s.arguments,"track name orientation",oe.trackNameOrientation);return void 0===c?Et.NotAppliedSemanticError:(e.stylesheet.otherSystemsTrackNameOrientation=c,Et.Applied);case"chorddiagramsinscore":return e.stylesheet.globalDisplayChordDiagramsInScore=!s.arguments||Pe.As(s.arguments.arguments,0),Et.Applied;case"hideemptystaves":return e.stylesheet.hideEmptyStaves=!0,Et.Applied;case"hideemptystavesinfirstsystem":return e.stylesheet.hideEmptyStavesInFirstSystem=!0,Et.Applied;case"showsinglestaffbrackets":return e.stylesheet.showSingleStaffBrackets=!0,Et.Applied;case"defaultbarnumberdisplay":const l=Pe.Fs(t,s.arguments,"bar number display",oe.barNumberDisplay);return void 0===l?Et.NotAppliedSemanticError:(e.stylesheet.barNumberDisplay=l,Et.Applied);default:return Et.NotAppliedUnrecognizedMarker}}Cs(t,e,s,i,n){const r=e.find(t=>t.has(i));if(!r)return Et.NotAppliedUnrecognizedMarker;const a=r.get(i);if(a)return this.Ds(t,a,s,n)?void 0:Et.NotAppliedSemanticError;n&&n.arguments.length>0&&t.addSemanticDiagnostic({code:xt.AT300,message:"Expected no arguments, but found some.",start:n.start,end:n.end,severity:Tt.Warning})}applyStaffMetaData(t,e,s){const i=this.Cs(t,[ce.staffMetaDataSignatures],s,s.tag.tag.text.toLowerCase(),s.arguments);if(void 0!==i)return i;switch(s.tag.tag.text.toLowerCase()){case"capo":return e.capo=s.arguments.arguments[0].value,Et.Applied;case"tuning":const i=[];let n=!1,r="";for(let a=0;a<s.arguments.arguments.length;a++){const h=s.arguments.arguments[a],o=h.text;switch(o){case"piano":case"none":case"voice":t.applyStaffNoteKind(e,Nt.Pitched),a=s.arguments.arguments.length;break;case"hide":n=!0,t.addSemanticDiagnostic({code:xt.AT305,message:"This value should be rather specified via the properties.",start:h.start,end:h.end,severity:Tt.Warning});break;default:const c=zt.parseTuning(o);if(c)i.push(c.realValue);else if(a===s.arguments.arguments.length-1&&i.length>0)r=o,t.addSemanticDiagnostic({code:xt.AT305,message:"This value should be rather specified via the properties.",start:h.start,end:h.end,severity:Tt.Warning});else{const e=Array.from(zt.tuningLetters).join(","),s=Array.from(zt.accidentalModeMapping.keys()).join(",");t.addSemanticDiagnostic({code:xt.AT209,message:`Unexpected tuning value '${o}', expected: <note><accidental><octave> where <note>=oneOf(${e}) <accidental>=oneOf(${s}), <octave>=number`,start:h.start,end:h.end,severity:Tt.Error})}}}return t.state.staffHasExplicitTuning.add(e),t.state.staffTuningApplied.delete(e),e.stringTuning=new Te,e.stringTuning.tunings=i,e.stringTuning.name=r,this.Ls(t,e,e.stringTuning,s),n&&(e.track.score.stylesheet.perTrackDisplayTuning||(e.track.score.stylesheet.perTrackDisplayTuning=new Map),e.track.score.stylesheet.perTrackDisplayTuning.set(e.track.index,!1)),Et.Applied;case"instrument":return t.state.staffTuningApplied.delete(e),this.Ws(t,e.track,s.arguments),Et.Applied;case"bank":return e.track.playbackInfo.bank=s.arguments.arguments[0].value,Et.Applied;case"lyrics":const a=new Be;return a.startBar=0,a.text="",2===s.arguments.arguments.length?(a.startBar=s.arguments.arguments[0].value,a.text=s.arguments.arguments[1].text):a.text=s.arguments.arguments[0].text,t.state.lyrics.get(e.track.index).push(a),Et.Applied;case"chord":const h=new we;this.Os(t,h,s),h.name=s.arguments.arguments[0].text;for(let e=1;e<s.arguments.arguments.length;e++){const i=s.arguments.arguments[e];if(i.nodeType===_t.Number)h.strings.push(i.value);else if(i.nodeType===_t.Ident){const e=i.text;"x"===e?h.strings.push(-1):t.addSemanticDiagnostic({code:xt.AT209,message:`Unexpected chord value '${e}', expected: 'x'`,severity:Tt.Error,start:i.start,end:i.end})}}return e.addChord(Pe.Rs(e,h.name),h),Et.Applied;case"articulation":const o=t.state.percussionArticulationNames,c=s.arguments.arguments[0].text;if("defaults"===c){for(const[t,e]of Jt.instrumentArticulationNames)o.set(t.toLowerCase(),e),o.set(zt.toArticulationId(t),e);return Et.Applied}if(2===s.arguments.arguments.length){const e=s.arguments.arguments[1].value,i=Jt.getArticulationById(e);if(i)return o.set(c.toLowerCase(),i.uniqueId),Et.Applied;{const i=Array.from(Jt.instrumentArticulationIds()).map(t=>`${t}`).join(",");return t.addSemanticDiagnostic({code:xt.AT209,message:`Unexpected articulation value '${e}', expected: ${i}`,start:s.arguments.arguments[1].start,end:s.arguments.arguments[1].end,severity:Tt.Error}),Et.NotAppliedSemanticError}}return Et.Applied;case"accidentals":return Pe.Is(t,s.arguments);case"displaytranspose":return e.displayTranspositionPitch=-1*s.arguments.arguments[0].value,t.state.staffHasExplicitDisplayTransposition.add(e),Et.Applied;case"transpose":return e.transpositionPitch=-1*s.arguments.arguments[0].value,Et.Applied;default:return Et.NotAppliedUnrecognizedMarker}}applyBarMetaData(t,e,s){const i=this.Cs(t,[ce.barMetaDataSignatures],s,s.tag.tag.text.toLowerCase(),s.arguments);if(void 0!==i)return i;switch(s.tag.tag.text.toLowerCase()){case"sync":const i=this.Gs(s);return t.state.syncPoints.push(i),Et.Applied;case"tempo":let r=0;const a=s.arguments.arguments[r++].value;let h="",o=!0,c=0;for(;r<s.arguments.arguments.length;){switch(s.arguments.arguments[r].nodeType){case _t.Ident:case _t.String:const t=s.arguments.arguments[r].text;"hide"===t?o=!1:h=t;break;case _t.Number:c=s.arguments.arguments[r].value}r++}let l=e.masterBar.tempoAutomations.find(t=>t.ratioPosition===c);return l||(l=new $,e.masterBar.tempoAutomations.push(l)),l.isLinear=!1,l.type=n.Tempo,l.value=a,l.text=h,l.ratioPosition=c,l.isVisible=o,Et.Applied;case"rc":return e.masterBar.repeatCount=s.arguments.arguments[0].value,Et.Applied;case"ae":for(const i of s.arguments.arguments)if(i.nodeType===_t.Number){const s=i.value;if(s<1||s>31)return t.addSemanticDiagnostic({code:xt.AT211,message:"Value is out of valid range. Allowed range: %s, Actual Value: %s",severity:Tt.Error,start:i.start,end:i.end}),Et.NotAppliedSemanticError;e.masterBar.alternateEndings|=1<<s-1}else t.addSemanticDiagnostic({code:xt.AT202,message:`Unexpected '${_t[i.nodeType]}' token. Expected one of following: ${_t[_t.Number]}`,severity:Tt.Error,start:i.start,end:i.end});return Et.Applied;case"ts":switch(s.arguments.arguments[0].nodeType){case _t.Number:if(e.masterBar.timeSignatureNumerator=0|s.arguments.arguments[0].value,(e.masterBar.timeSignatureNumerator<1||e.masterBar.timeSignatureNumerator>32)&&t.addSemanticDiagnostic({code:xt.AT211,message:`Value is out of valid range. Allowed range: 1-32, Actual Value: ${e.masterBar.timeSignatureNumerator}`,start:s.arguments.arguments[0].start,end:s.arguments.arguments[0].end,severity:Tt.Error}),e.masterBar.timeSignatureDenominator=0|s.arguments.arguments[1].value,!Pe.Ps.has(e.masterBar.timeSignatureDenominator)){const i=Array.from(Pe.Ps).join(", ");t.addSemanticDiagnostic({code:xt.AT211,message:`Value is out of valid range. Allowed range: ${i}, Actual Value: ${e.masterBar.timeSignatureDenominator}`,start:s.arguments.arguments[0].start,end:s.arguments.arguments[0].end,severity:Tt.Error})}break;case _t.Ident:case _t.String:const i=s.arguments.arguments[0].text;if("common"!==i.toLowerCase())return t.addSemanticDiagnostic({code:xt.AT209,message:`Unexpected time signature value '${i}', expected: common or two numbers`,severity:Tt.Error,start:s.arguments.arguments[0].start,end:s.arguments.arguments[0].end}),Et.NotAppliedSemanticError;e.masterBar.timeSignatureCommon=!0,e.masterBar.timeSignatureNumerator=4,e.masterBar.timeSignatureDenominator=4}return Et.Applied;case"beaming":return this.Hs(t,s,e.masterBar);case"ks":const u=Pe.Fs(t,s.arguments,"key signature",oe.keySignature);if(void 0===u)return Et.NotAppliedSemanticError;const d=Pe.Fs(t,s.arguments,"key signature type",oe.keySignatureType);return void 0===d?Et.NotAppliedSemanticError:(e.keySignature=u,e.keySignatureType=d,Et.Applied);case"clef":switch(s.arguments.arguments[0].nodeType){case _t.Ident:case _t.String:const i=Pe.Fs(t,s.arguments,"clef",oe.clef);if(void 0===i)return Et.NotAppliedSemanticError;e.clef=i;break;case _t.Number:const n=s.arguments.arguments[0].value;switch(n){case 0:e.clef=x.Neutral;break;case 43:e.clef=x.G2;break;case 65:e.clef=x.F4;break;case 48:e.clef=x.C3;break;case 60:e.clef=x.C4;break;default:return t.addSemanticDiagnostic({code:xt.AT209,message:`Unexpected clef value '${n}', expected: ${Array.from(oe.clef.keys()).join(",")}`,severity:Tt.Error,start:s.arguments.arguments[0].start,end:s.arguments.arguments[0].end}),Et.NotAppliedSemanticError}}return Et.Applied;case"section":const f=new _e;return 1===s.arguments.arguments.length?f.text=s.arguments.arguments[0].text:(f.marker=s.arguments.arguments[0].text,f.text=s.arguments.arguments[1].text),e.masterBar.section=f,Et.Applied;case"tf":switch(s.arguments.arguments[0].nodeType){case _t.Ident:case _t.String:const i=Pe.Fs(t,s.arguments,"triplet feel",oe.tripletFeel);if(void 0===i)return Et.NotAppliedSemanticError;e.masterBar.tripletFeel=i;break;case _t.Number:const n=s.arguments.arguments[0].value;switch(n){case 0:e.masterBar.tripletFeel=F.NoTripletFeel;break;case 1:e.masterBar.tripletFeel=F.Triplet16th;break;case 2:e.masterBar.tripletFeel=F.Triplet8th;break;case 3:e.masterBar.tripletFeel=F.Dotted16th;break;case 4:e.masterBar.tripletFeel=F.Dotted8th;break;case 5:e.masterBar.tripletFeel=F.Scottish16th;break;case 6:e.masterBar.tripletFeel=F.Scottish8th;break;default:return t.addSemanticDiagnostic({code:xt.AT209,message:`Unexpected triplet feel value '${n}', expected: ${Array.from(oe.tripletFeel.keys()).join(",")}`,severity:Tt.Error,start:s.arguments.arguments[0].start,end:s.arguments.arguments[0].end}),Et.NotAppliedSemanticError}}return Et.Applied;case"barlineleft":const p=Pe.Fs(t,s.arguments,"bar line",oe.barLineStyle);return void 0===p?Et.NotAppliedSemanticError:(e.barLineLeft=p,Et.Applied);case"barlineright":const b=Pe.Fs(t,s.arguments,"bar line",oe.barLineStyle);return void 0===b?Et.NotAppliedSemanticError:(e.barLineRight=b,Et.Applied);case"accidentals":return Pe.Is(t,s.arguments);case"voicemode":return Pe.Vs(t,s.arguments);case"jump":const m=Pe.Fs(t,s.arguments,"direction",oe.direction);return void 0===m?Et.NotAppliedSemanticError:(e.masterBar.addDirection(m),Et.Applied);case"ottava":const g=Pe.Fs(t,s.arguments,"clef ottava",oe.ottavia);return void 0===g?Et.NotAppliedSemanticError:(e.clefOttava=g,Et.Applied);case"simile":const w=Pe.Fs(t,s.arguments,"simile mark",oe.simileMark);return void 0===w?Et.NotAppliedSemanticError:(e.simileMark=w,Et.Applied);case"width":return e.masterBar.displayWidth=s.arguments.arguments[0].value,e.displayWidth=e.masterBar.displayWidth,Et.Applied;case"scale":return e.masterBar.displayScale=s.arguments.arguments[0].value,e.displayScale=e.masterBar.displayScale,Et.Applied;case"spd":const y=new Y;return y.pedalType=P.Down,y.ratioPosition=s.arguments.arguments[0].value,e.sustainPedals.push(y),Et.Applied;case"spu":const k=new Y;return k.pedalType=P.Up,k.ratioPosition=s.arguments.arguments[0].value,e.sustainPedals.push(k),Et.Applied;case"sph":const S=new Y;return S.pedalType=P.Hold,S.ratioPosition=s.arguments.arguments[0].value,e.sustainPedals.push(S),Et.Applied;case"ft":return e.masterBar.isFreeTime=!0,Et.Applied;case"ro":return e.masterBar.isRepeatStart=!0,Et.Applied;case"ac":return e.masterBar.isAnacrusis=!0,Et.Applied;case"db":return e.masterBar.isDoubleBar=!0,e.barLineRight=E.LightLight,Et.Applied;case"barnumberdisplay":const B=Pe.Fs(t,s.arguments,"bar number display",oe.barNumberDisplay);return void 0===B?Et.NotAppliedSemanticError:(e.barNumberDisplay=B,Et.Applied);default:return Et.NotAppliedUnrecognizedMarker}}Hs(t,e,s){let i=c.Eighth;const n=[],r=e.arguments.arguments[0].value;switch(r){case 4:i=c.QuadrupleWhole;break;case 8:i=c.Eighth;break;case 16:i=c.Sixteenth;break;case 32:i=c.ThirtySecond;break;default:return t.addSemanticDiagnostic({code:xt.AT209,message:`Value is out of valid range. Allowed range: 4,8,16 or 32, Actual Value: ${r}`,severity:Tt.Error,start:e.arguments.arguments[0].start,end:e.arguments.arguments[0].end}),Et.NotAppliedSemanticError}for(let s=1;s<e.arguments.arguments.length;s++){if(e.arguments.arguments[s].value<1)return t.addSemanticDiagnostic({code:xt.AT209,message:`Value is out of valid range. Allowed range: >0, Actual Value: ${r}`,severity:Tt.Error,start:e.arguments.arguments[s].start,end:e.arguments.arguments[s].end}),Et.NotAppliedSemanticError;n.push(e.arguments.arguments[s].value)}return s.beamingRules||(s.beamingRules=new Z),s.beamingRules.groups.set(i,n),Et.Applied}static Is(t,e){const s=Pe.Fs(t,e,"accidental mode",oe.alphaTexAccidentalMode);return void 0===s?Et.NotAppliedSemanticError:(t.state.accidentalMode=s,Et.Applied)}static Vs(t,e){const s=Pe.Fs(t,e,"voice mode",oe.alphaTexVoiceMode);return void 0===s?Et.NotAppliedSemanticError:(t.state.voiceMode=s,Et.Applied)}static Rs(t,e){return e.toLowerCase()+t.index+t.track.index}Gs(t){const e=t.arguments.arguments[0].value,s=t.arguments.arguments[1].value,i=t.arguments.arguments[2].value;let n=0;return t.arguments.arguments.length>3&&(n=t.arguments.arguments[3].value),{barIndex:e,barOccurence:s,barPosition:n,millisecondOffset:i}}Ds(t,e,s,i){if(!i){return!!e.some(t=>0===t.parameters.length||!t.parameters.some(t=>t.parseMode===Pt.Required||t.parseMode===Pt.RequiredAsFloat||t.parseMode===Pt.RequiredAsValueList))||(t.addSemanticDiagnostic({code:xt.AT219,message:`Error parsing arguments: no overload matched arguments ${me.generateSignaturesFromArguments(void 0)}. Signatures: ${me.generateSignatures(e)}`,severity:Tt.Error,start:s.start,end:s.end}),!1)}if(i.validated)return!0;let n=!1;const r=new Map(e.map((t,e)=>[e,{signature:t,parameterIndex:0,parameterValueMatches:0,parameterHasValues:!1}])),a=t.parseMode===Ct.Full,h=a?(t,e)=>{const s=r.get(e),i=t;i.parameterIndices||(i.parameterIndices=new Map),i.parameterIndices.set(e,s.parameterIndex)}:(t,e)=>{};for(const t of i.arguments)if(me.filterSignatureCandidates(r,t,!1,h),0===r.size)break;const o=a?Array.from(r.entries()):void 0;return me.filterIncompleteCandidates(r),0===r.size&&(t.addSemanticDiagnostic({code:xt.AT219,message:`Error parsing arguments: no overload matched arguments ${me.generateSignaturesFromArguments(i.arguments)}. Signatures:\n${me.generateSignatures(e)}`,severity:Tt.Error,start:i.start,end:i.end}),n=!0),o&&(me.sortCandidates(o),i.signatureCandidateIndices=o.map(t=>t[0])),!n}Es(t,e,s,i,n=1){const r=i.arguments.arguments.length-n;if(r<1)return;const a=zt.getOrCreateHeaderFooterStyle(e,s);void 0===a.isVisible&&(a.isVisible=!0);const h=i.arguments.arguments[n].text;if(h?a.template=h:a.isVisible=!1,r<2)return;const o=Pe.Fs(t,i.arguments,"textAlign",oe.textAlign,n+1);void 0!==o&&(a.textAlign=o)}Ws(t,e,s){switch(s.arguments[0].nodeType){case _t.Number:const i=s.arguments[0].value;i>=0&&i<=127?e.playbackInfo.program=i:t.addSemanticDiagnostic({code:xt.AT211,message:`Value is out of valid range. Allowed range: 0-127, Actual Value: ${i}`,start:s.arguments[0].start,end:s.arguments[0].end,severity:Tt.Error});break;case _t.Ident:case _t.String:const n=s.arguments[0].text.toLowerCase();if("percussion"===n){for(const s of e.staves)t.applyStaffNoteKind(s,Nt.Articulation);e.playbackInfo.primaryChannel=Vt.PercussionChannel,e.playbackInfo.secondaryChannel=Vt.PercussionChannel}else e.playbackInfo.program=ge.getValue(n)}}Os(t,e,s){if(s.properties)for(const i of s.properties.properties)if(this.$s(t,[ce.metaDataProperties.get("chord")],i))switch(i.property.text.toLowerCase()){case"firstfret":e.firstFret=i.arguments.arguments[0].value;break;case"showdiagram":e.showDiagram=Pe.As(i.arguments.arguments,0);break;case"showfingering":e.showFingering=Pe.As(i.arguments.arguments,0);break;case"showname":e.showName=Pe.As(i.arguments.arguments,0);break;case"barre":e.barreFrets=i.arguments.arguments.map(t=>t.value)}}Ls(t,e,s,i){if(i.properties)for(const n of i.properties.properties)if(this.$s(t,[ce.metaDataProperties.get("tuning")],n))switch(n.property.text.toLowerCase()){case"hide":e.track.score.stylesheet.perTrackDisplayTuning||(e.track.score.stylesheet.perTrackDisplayTuning=new Map),e.track.score.stylesheet.perTrackDisplayTuning.set(e.track.index,!1);break;case"label":s.name=n.arguments.arguments[0].text}}static As(t,e){if(e>=t.length)return!0;const s=t[e];switch(s.nodeType){case _t.String:case _t.Ident:return"false"!==s.text;case _t.Number:return 0!==s.value;default:return!1}}applyStructuralMetaData(t,e){const s=this.Cs(t,[ce.structuralMetaDataSignatures],e,e.tag.tag.text.toLowerCase(),e.arguments);if(void 0!==s)switch(s){case Et.NotAppliedSemanticError:return Ft.NotAppliedSemanticError;case Et.NotAppliedUnrecognizedMarker:return Ft.NotAppliedUnrecognizedMarker}switch(e.tag.tag.text.toLowerCase()){case"staff":const s=t.startNewStaff();return this.Us(t,s,e),Ft.AppliedNewStaff;case"track":const i=t.startNewTrack();return e.arguments&&e.arguments.arguments.length>0&&(i.name=e.arguments.arguments[0].text,e.arguments.arguments.length>1&&(i.shortName=e.arguments.arguments[1].text)),this.zs(t,i,e),Ft.AppliedNewTrack;case"voice":return t.startNewVoice(),Ft.AppliedNewVoice;default:return Ft.NotAppliedUnrecognizedMarker}}$s(t,e,s){const i=this.Cs(t,e,s,s.property.text.toLowerCase(),s.arguments);if(void 0!==i)switch(i){case Et.Applied:case Et.NotAppliedSemanticError:return!1;case Et.NotAppliedUnrecognizedMarker:const i=e.flatMap(t=>Array.from(t.keys()));return t.addSemanticDiagnostic({code:xt.AT212,message:`Unrecogized property '${s.property.text}', expected one of ${i}`,severity:Tt.Error,start:s.start,end:s.end}),!1}return!0}Us(t,e,s){if(!s.properties)return;let i=!1,n=!1,r=!1,a=!1;for(const h of s.properties.properties)if(this.$s(t,[ce.metaDataProperties.get("staff")],h))switch(h.property.text.toLowerCase()){case"score":i=!0,h.arguments&&h.arguments.arguments.length>0&&(e.standardNotationLineCount=h.arguments.arguments[0].value);break;case"tabs":n=!0;break;case"slash":r=!0;break;case"numbered":a=!0}(i||n||r||a)&&(e.showStandardNotation=i,e.showTablature=n,e.showSlash=r,e.showNumbered=a)}zs(t,e,s){if(s.properties)for(const i of s.properties.properties)if(this.$s(t,[ce.metaDataProperties.get("track")],i))switch(i.property.text.toLowerCase()){case"color":try{e.color=ke.fromJson(i.arguments.arguments[0].text)}catch{t.addSemanticDiagnostic({code:xt.AT213,message:"Invalid format for color",severity:Tt.Error,start:i.arguments.arguments[0].start,end:i.arguments.arguments[0].end})}break;case"defaultsystemslayout":e.defaultSystemsLayout=i.arguments.arguments[0].value;break;case"systemslayout":e.systemsLayout=i.arguments.arguments.map(t=>t.value);break;case"volume":e.playbackInfo.volume=i.arguments.arguments[0].value;break;case"balance":e.playbackInfo.balance=i.arguments.arguments[0].value;break;case"mute":e.playbackInfo.isMute=!0;break;case"solo":e.playbackInfo.isSolo=!0;break;case"multibarrest":e.score.stylesheet.perTrackMultiBarRest||(e.score.stylesheet.perTrackMultiBarRest=new Set),e.score.stylesheet.perTrackMultiBarRest.add(e.index);break;case"instrument":this.Ws(t,e,i.arguments);break;case"bank":e.playbackInfo.bank=i.arguments.arguments[0].value}}applyBeatDurationProperty(t,e){const s=this.Cs(t,[ce.durationChangeProperties],e,e.property.text.toLowerCase(),e.arguments);if(void 0!==s)return s;if("tu"===e.property.text.toLowerCase()){if(2===e.arguments.arguments.length)t.state.currentTupletNumerator=e.arguments.arguments[0].value,t.state.currentTupletDenominator=e.arguments.arguments[1].value;else{const s=e.arguments.arguments[0].value;t.state.currentTupletNumerator=s;const i=Pe.Xs(s);i<0?(t.addSemanticDiagnostic({code:xt.AT209,message:`Unexpected default tuplet value '${s}', expected: 3, 5, 6, 7, 9, 10, 11 or 12`,severity:Tt.Error,start:e.arguments.arguments[0].start,end:e.arguments.arguments[0].end}),t.state.currentTupletNumerator=-1,t.state.currentTupletDenominator=-1):t.state.currentTupletDenominator=i}return Et.Applied}return Et.NotAppliedUnrecognizedMarker}static Xs(t){switch(t){case 3:return 2;case 5:case 6:case 7:return 4;case 9:case 10:case 11:case 12:return 8;default:return-1}}js=void 0;get allKnownMetaDataTags(){if(!this.js){this.js=new Set;const t=[ce.scoreMetaDataSignatures.keys(),ce.structuralMetaDataSignatures.keys(),ce.staffMetaDataSignatures.keys(),ce.barMetaDataSignatures.keys()];for(const e of t)for(const t of e)this.js.add(t)}return this.js}Js=void 0;get knownScoreMetaDataTags(){return this.Js||(this.Js=new Set(ce.scoreMetaDataSignatures.keys())),this.Js}qs=void 0;get knownStructuralMetaDataTags(){return this.qs||(this.qs=new Set(ce.structuralMetaDataSignatures.keys())),this.qs}Ys=void 0;get knownBarMetaDataTags(){return this.Ys||(this.Ys=new Set(ce.barMetaDataSignatures.keys())),this.Ys}Ks=void 0;get knownStaffMetaDataTags(){return this.Ks||(this.Ks=new Set(ce.staffMetaDataSignatures.keys())),this.Ks}Qs=void 0;get knownBeatDurationProperties(){return this.Qs||(this.Qs=new Set(ce.durationChangeProperties.keys())),this.Qs}Zs=void 0;get knownBeatProperties(){return this.Zs||(this.Zs=new Set(ce.beatProperties.keys())),this.Zs}ti=void 0;get knownNoteProperties(){return this.ti||(this.ti=new Set(ce.noteProperties.keys())),this.ti}applyBeatProperty(t,e,s){const i=s.property.text.toLowerCase(),r=this.Cs(t,[ce.beatProperties],s,i,s.arguments);if(void 0!==r)return r;switch(i){case"f":return e.fade=mt.FadeIn,Et.Applied;case"fo":return e.fade=mt.FadeOut,Et.Applied;case"vs":return e.fade=mt.VolumeSwell,Et.Applied;case"v":return e.vibrato=w.Slight,Et.Applied;case"vw":return e.vibrato=w.Wide,Et.Applied;case"s":return e.slap=!0,Et.Applied;case"p":return e.pop=!0,Et.Applied;case"tt":return e.tap=!0,Et.Applied;case"txt":return e.text=s.arguments.arguments[0].text,Et.Applied;case"lyrics":let r=0,a="";for(2===s.arguments.arguments.length?(r=s.arguments.arguments[0].value,a=s.arguments.arguments[1].text):a=s.arguments.arguments[0].text,e.lyrics||(e.lyrics=[]);e.lyrics.length<=r;)e.lyrics.push("");return e.lyrics[r]=a,Et.Applied;case"dd":return e.dots=2,Et.Applied;case"d":return e.dots=1,Et.Applied;case"su":return e.pickStroke=ct.Up,Et.Applied;case"sd":return e.pickStroke=ct.Down,Et.Applied;case"tu":if(2===s.arguments.arguments.length)e.tupletNumerator=s.arguments.arguments[0].value,e.tupletDenominator=s.arguments.arguments[1].value;else{const i=s.arguments.arguments[0].value;e.tupletNumerator=i;const n=Pe.Xs(i);if(n<0)return t.addSemanticDiagnostic({code:xt.AT209,message:`Unexpected default tuplet value '${i}', expected: 3, 5, 6, 7, 9, 10, 11 or 12`,severity:Tt.Error,start:s.arguments.arguments[0].start,end:s.arguments.arguments[0].end}),e.tupletNumerator=-1,e.tupletDenominator=-1,Et.NotAppliedSemanticError;e.tupletDenominator=n}return Et.Applied;case"tb":case"tbe":let c=0,u=!0,d=!1;for(;u;)switch(s.arguments.arguments[c].nodeType){case _t.Ident:case _t.String:const i=s.arguments.arguments[c].text.toLowerCase();if(oe.whammyType.has(i))e.whammyBarType=oe.whammyType.get(i),d=!0,c++;else{if(!oe.bendStyle.has(i))return d?Pe.Fs(t,s.arguments,"whammy style",oe.bendStyle,c):Pe.Fs(t,s.arguments,"whammy type",oe.whammyType,c),Et.NotAppliedSemanticError;e.whammyStyle=oe.bendStyle.get(i),c++}break;default:u=!1}const f=this.ei(t,s,c,"tbe"===i);if(f)for(const t of f)e.addWhammyBarPoint(t);return Et.Applied;case"bu":return Pe.si(e,s,h.BrushUp,.25),Et.Applied;case"bd":return Pe.si(e,s,h.BrushDown,.25),Et.Applied;case"au":return Pe.si(e,s,h.ArpeggioUp,1),Et.Applied;case"ad":return Pe.si(e,s,h.ArpeggioDown,1),Et.Applied;case"ch":const p=s.arguments.arguments[0].text,b=Pe.Rs(e.voice.bar.staff,p);if(!e.voice.bar.staff.hasChord(b)){const t=new we;t.showDiagram=!1,t.name=p,e.voice.bar.staff.addChord(b,t)}return e.chordId=b,Et.Applied;case"gr":if(s.arguments&&s.arguments.arguments.length>0){const i=Pe.Fs(t,s.arguments,"whammy style",oe.graceType);if(void 0===i)return Et.NotAppliedSemanticError;e.graceType=i}else e.graceType=l.BeforeBeat;return Et.Applied;case"dy":const m=Pe.Fs(t,s.arguments,"dynamic",oe.dynamicValue);return void 0===m?Et.NotAppliedSemanticError:(e.dynamics=m,t.state.currentDynamics=m,Et.Applied);case"cre":return e.crescendo=o.Crescendo,Et.Applied;case"dec":return e.crescendo=o.Decrescendo,Et.Applied;case"tempo":const g=s.arguments.arguments[0].value;let y="",k=!0;if(s.arguments.arguments.length>2){y=s.arguments.arguments[1].text;const e=s.arguments.arguments[2].text;if("hide"!==e)return t.addSemanticDiagnostic({code:xt.AT209,message:`Unexpected third tempo property value '${e}', expected: 'hide'`,severity:Tt.Error,start:s.arguments.arguments[2].start,end:s.arguments.arguments[2].end}),Et.NotAppliedSemanticError;k=!1}else s.arguments.arguments.length>1&&(y=s.arguments.arguments[1].text,"hide"===y&&(k=!1,y=""));const S=new $;return S.isLinear=!1,S.type=n.Tempo,S.value=g,S.text=y,S.isVisible=k,e.automations.push(S),e.voice.bar.masterBar.tempoAutomations.push(S),Et.Applied;case"volume":const B=new $;return B.isLinear=!0,B.type=n.Volume,B.value=s.arguments.arguments[0].value,e.automations.push(B),Et.Applied;case"balance":const _=new $;return _.isLinear=!0,_.type=n.Balance,_.value=zt.clamp(s.arguments.arguments[0].value,0,16),e.automations.push(_),Et.Applied;case"tp":const T=new Zt;if(e.tremoloPicking=T,s.arguments&&s.arguments.arguments.length>0){if(s.arguments.arguments.length>0){const e=s.arguments.arguments[0].value;if(e>=Zt.minMarks&&e<=Zt.maxMarks)T.marks=e;else switch(e){case 8:T.marks=1;break;case 16:T.marks=2;break;case 32:T.marks=3;break;default:return t.addSemanticDiagnostic({code:xt.AT209,message:`Unexpected tremolo marks value '${e}, expected: ${Zt.minMarks}-${Zt.maxMarks}, or legacy: 8, 16 or 32`,severity:Tt.Error,start:s.arguments.arguments[0].start,end:s.arguments.arguments[0].end}),Et.NotAppliedSemanticError}}if(s.arguments.arguments.length>1){const e=Pe.Fs(t,s.arguments,"tremolo picking style",oe.tremoloPickingStyle,1);if(void 0===e)return Et.NotAppliedSemanticError;T.style=e}}return Et.Applied;case"spd":return Pe.ii(t,e,P.Down),Et.Applied;case"sph":return Pe.ii(t,e,P.Hold),Et.Applied;case"spu":return Pe.ii(t,e,P.Up),Et.Applied;case"spe":return Pe.ii(t,e,P.Up,!0),Et.Applied;case"slashed":return e.slashed=!0,Et.Applied;case"ds":return e.deadSlapped=!0,1===e.notes.length&&e.notes[0].isDead&&e.removeNote(e.notes[0]),Et.Applied;case"glpf":return e.golpe=bt.Finger,Et.Applied;case"glpt":return e.golpe=bt.Thumb,Et.Applied;case"waho":return e.wahPedal=gt.Open,Et.Applied;case"wahc":return e.wahPedal=gt.Closed,Et.Applied;case"barre":if(e.barreFret=s.arguments.arguments[0].value,e.barreShape=wt.Full,s.arguments.arguments.length>1){const i=Pe.Fs(t,s.arguments,"barre shape",oe.barreShape,1);if(void 0===i)return Et.NotAppliedSemanticError;e.barreShape=i}return Et.Applied;case"rasg":const x=Pe.Fs(t,s.arguments,"rasgueado pattern",oe.rasgueado);return void 0===x?Et.NotAppliedSemanticError:(e.rasgueado=x,Et.Applied);case"ot":const M=Pe.Fs(t,s.arguments,"ottava",oe.ottavia);return void 0===M?Et.NotAppliedSemanticError:(e.ottava=M,Et.Applied);case"legatoorigin":return e.isLegatoOrigin=!0,Et.Applied;case"instrument":let v=0;switch(s.arguments.arguments[0].nodeType){case _t.Ident:case _t.String:v=ge.getValue(s.arguments.arguments[0].text);break;case _t.Number:v=s.arguments.arguments[0].value}const N=new $;return N.isLinear=!1,N.type=n.Instrument,N.value=v,e.automations.push(N),Et.Applied;case"bank":const C=new $;return C.isLinear=!1,C.type=n.Bank,C.value=s.arguments.arguments[0].value,e.automations.push(C),Et.Applied;case"fermata":const E=Pe.Fs(t,s.arguments,"fermata",oe.fermataType);if(void 0===E)return Et.NotAppliedSemanticError;const F=new Se;return F.type=E,s.arguments.arguments.length>1&&(F.length=s.arguments.arguments[1].value),e.fermata=F,Et.Applied;case"beam":const A=s.arguments.arguments[0].text;switch(A.toLowerCase()){case"invert":e.invertBeamDirection=!0;break;case"up":e.preferredBeamDirection=Wt.Up;break;case"down":e.preferredBeamDirection=Wt.Down;break;case"auto":e.beamingMode=St.Auto;break;case"split":e.beamingMode=St.ForceSplitToNext;break;case"merge":e.beamingMode=St.ForceMergeWithNext;break;case"splitsecondary":e.beamingMode=St.ForceSplitOnSecondaryToNext;break;default:const i=["invert","up","down","auto","split","merge","splitsecondary"];return t.addSemanticDiagnostic({code:xt.AT209,message:`Unexpected beam value '${A}', expected: ${i.join(",")}`,severity:Tt.Error,start:s.arguments.arguments[0].start,end:s.arguments.arguments[0].end}),Et.NotAppliedSemanticError}return Et.Applied;case"timer":return e.showTimer=!0,Et.Applied}return Et.NotAppliedUnrecognizedMarker}static ii(t,e,s,i=!1){const n=new Y;n.pedalType=s,n.ratioPosition=i?1:.001*e.voice.bar.sustainPedals.length,t.state.sustainPedalToBeat.set(n,e),e.voice.bar.sustainPedals.push(n)}static si(t,e,s,i){t.brushType=s,e.arguments&&e.arguments.arguments.length>0?t.brushDuration=e.arguments.arguments[0].value:(t.updateDurations(),t.brushDuration=t.playbackDuration*i/t.notes.length)}applyNoteProperty(t,e,s){const i=s.property.text.toLowerCase(),n=this.Cs(t,[ce.noteProperties],s,i,s.arguments);if(void 0!==n)return n;switch(i){case"b":case"be":let n=0,r=!0,a=!1;for(;r;)switch(s.arguments.arguments[n].nodeType){case _t.Ident:case _t.String:const i=s.arguments.arguments[n].text.toLowerCase();if(oe.bendType.has(i))e.bendType=oe.bendType.get(i),a=!0,n++;else{if(!oe.bendStyle.has(i))return a?Pe.Fs(t,s.arguments,"bend style",oe.bendStyle,n):Pe.Fs(t,s.arguments,"bend type",oe.bendType,n),Et.NotAppliedSemanticError;e.bendStyle=oe.bendStyle.get(i),n++}break;default:r=!1}const h=this.ei(t,s,n,"be"===i);if(h)for(const t of h)e.addBendPoint(t);return Et.Applied;case"nh":return e.harmonicType=f.Natural,e.harmonicValue=zt.deltaFretToHarmonicValue(e.fret),Et.Applied;case"ah":return e.harmonicType=f.Artificial,e.harmonicValue=Pe.ni(s.arguments,e.harmonicValue),Et.Applied;case"th":return e.harmonicType=f.Tap,e.harmonicValue=Pe.ni(s.arguments,e.harmonicValue),Et.Applied;case"ph":return e.harmonicType=f.Pinch,e.harmonicValue=Pe.ni(s.arguments,e.harmonicValue),Et.Applied;case"sh":return e.harmonicType=f.Semi,e.harmonicValue=Pe.ni(s.arguments,e.harmonicValue),Et.Applied;case"fh":return e.harmonicType=f.Feedback,e.harmonicValue=Pe.ni(s.arguments,e.harmonicValue),Et.Applied;case"tr":const o=s.arguments.arguments[0].value;let l=c.Sixteenth;if(s.arguments.arguments.length>1){const e=s.arguments.arguments[1].value;switch(e){case 16:l=c.Sixteenth;break;case 32:l=c.ThirtySecond;break;case 64:l=c.SixtyFourth;break;default:return t.addSemanticDiagnostic({code:xt.AT209,message:`Unexpected trill duration value '${e}', expected: 16, 32 or 64`,severity:Tt.Error,start:s.arguments.arguments[1].start,end:s.arguments.arguments[1].end}),Et.NotAppliedSemanticError}}return e.trillValue=o+e.stringTuning,e.trillSpeed=l,Et.Applied;case"v":return e.vibrato=w.Slight,Et.Applied;case"vw":return e.vibrato=w.Wide,Et.Applied;case"sl":return e.slideOutType=g.Legato,Et.Applied;case"ss":return e.slideOutType=g.Shift,Et.Applied;case"sib":return e.slideInType=m.IntoFromBelow,Et.Applied;case"sia":return e.slideInType=m.IntoFromAbove,Et.Applied;case"sou":return e.slideOutType=g.OutUp,Et.Applied;case"sod":return e.slideOutType=g.OutDown,Et.Applied;case"psd":return e.slideOutType=g.PickSlideDown,Et.Applied;case"psu":return e.slideOutType=g.PickSlideUp,Et.Applied;case"h":return e.isHammerPullOrigin=!0,Et.Applied;case"lht":return e.isLeftHandTapped=!0,Et.Applied;case"g":return e.isGhost=!0,Et.Applied;case"ac":return e.accentuated=u.Normal,Et.Applied;case"hac":return e.accentuated=u.Heavy,Et.Applied;case"ten":return e.accentuated=u.Tenuto,Et.Applied;case"pm":return e.isPalmMute=!0,Et.Applied;case"st":return e.isStaccato=!0,Et.Applied;case"lr":return e.isLetRing=!0,Et.Applied;case"x":return e.isDead=!0,Et.Applied;case"-":case"t":return e.isTieDestination=!0,Et.Applied;case"lf":let p=d.Thumb;if(s.arguments&&s.arguments.arguments.length>0){const e=Pe.ri(t,s.arguments);if(void 0===e)return Et.NotAppliedSemanticError;p=e}return e.leftHandFinger=p,Et.Applied;case"rf":let b=d.Thumb;if(s.arguments&&s.arguments.arguments.length>0){const e=Pe.ri(t,s.arguments);if(void 0===e)return Et.NotAppliedSemanticError;b=e}return e.rightHandFinger=b,Et.Applied;case"acc":return e.accidentalMode=zt.parseAccidentalMode(s.arguments.arguments[0].text),Et.Applied;case"turn":return e.ornament=dt.Turn,Et.Applied;case"iturn":return e.ornament=dt.InvertedTurn,Et.Applied;case"umordent":return e.ornament=dt.UpperMordent,Et.Applied;case"lmordent":return e.ornament=dt.LowerMordent,Et.Applied;case"string":return e.showStringNumber=!0,Et.Applied;case"hide":return e.isVisible=!1,Et.Applied;case"slur":const y=s.arguments.arguments[0].text;if(t.state.slurs.has(y)){const s=t.state.slurs.get(y);s.slurDestination=e,e.slurOrigin=s,e.isSlurDestination=!0}else t.state.slurs.set(y,e);return Et.Applied;default:return this.applyBeatProperty(t,e.beat,s)}return Et.NotAppliedUnrecognizedMarker}static ri(t,e){const s=e.arguments[0].value;switch(s){case 1:return d.Thumb;case 2:return d.IndexFinger;case 3:return d.MiddleFinger;case 4:return d.AnnularFinger;case 5:return d.LittleFinger;default:return void t.addSemanticDiagnostic({code:xt.AT211,message:`Value is out of valid range. Allowed range: 1-5, Actual Value: ${s}`,start:e.arguments[0].start,end:e.arguments[0].end,severity:Tt.Error})}}static ni(t,e){return t&&(e=t.arguments[0].value),e}ei(t,e,s,i){let n=e.arguments.arguments,r=n.length-s,a=e.arguments;r>0&&n[s].nodeType===_t.Arguments&&(n=n[s].arguments,s=0,r=n.length,a=n[s]);const h=i?2:1;if(r%h!==0){const s=Math.ceil(r/h),i=s*h;return void t.addSemanticDiagnostic({code:xt.AT214,message:`The '${e.property.text}' effect needs ${h} arguments per item. With ${s} points, ${i} arguments are needed, only ${r} arguments found.`,severity:Tt.Error,start:a.end,end:a.end})}const o=[];let c=s;for(;c<n.length;){let t=0,e=0;i?(t=n[c++].value,e=n[c++].value):(t=0,e=n[c++].value),o.push(new U(t,e))}if(o.length>0){if(o.length>60&&o.splice(60,o.length-60),i)o.sort((t,e)=>t.offset-e.offset);else{const t=o.length,e=U.MaxPosition/(t-1)|0;let s=0;for(;s<t;)o[s].offset=Math.min(U.MaxPosition,s*e),s++}return o}}static Fs(t,e,s,i,n=0){if(n>=e.arguments.length)return;const r=e.arguments[n].text;return i.has(r.toLowerCase())?i.get(r.toLowerCase()):void t.addSemanticDiagnostic({code:xt.AT209,message:`Unexpected ${s} value '${r}', expected: ${Array.from(i.keys()).join(",")}`,severity:Tt.Error,start:e.arguments[n].start,end:e.arguments[n].end})}static ai=new Ht;static hi=new Ne;buildScoreMetaDataNodes(t){const e=[];return Pe.oi(e,"album",t,t.album,ot.Album),Pe.oi(e,"artist",t,t.artist,ot.Artist),Pe.oi(e,"copyright",t,t.copyright,ot.Copyright),Pe.oi(e,"copyright2",t,void 0,ot.CopyrightSecondLine),Pe.oi(e,"wordsandmusic",t,void 0,ot.WordsAndMusic,!0),Pe.oi(e,"instructions",t,t.instructions,void 0),Pe.oi(e,"music",t,t.music,ot.Music),Pe.oi(e,"notices",t,t.notices,void 0),Pe.oi(e,"subtitle",t,t.subTitle,ot.SubTitle),Pe.oi(e,"title",t,t.title,ot.Title),Pe.oi(e,"words",t,t.words,ot.Words),Pe.oi(e,"tab",t,t.tab,ot.Transcriber),t.defaultSystemsLayout!==Pe.ai.defaultSystemsLayout&&e.push(be.numberMeta("defaultSystemsLayout",t.defaultSystemsLayout)),t.systemsLayout.length>0&&e.push(be.meta("systemsLayout",be.args(t.systemsLayout.map(t=>be.number(t))))),Pe.ci(e,t.stylesheet),e.length>0&&(e[0].leadingComments=[{text:"Score Metadata",multiLine:!1}]),e}static ci(t,e){const s=t.length;e.hideDynamics&&t.push(be.meta("hideDynamics")),e.bracketExtendMode!==Pe.ai.stylesheet.bracketExtendMode&&t.push(be.identMeta("bracketExtendMode",oe.bracketExtendModeReversed.get(e.bracketExtendMode))),e.useSystemSignSeparator&&t.push(be.meta("useSystemSignSeparator")),e.multiTrackMultiBarRest&&t.push(be.meta("multiBarRest")),e.singleTrackTrackNamePolicy!==Pe.ai.stylesheet.singleTrackTrackNamePolicy&&t.push(be.identMeta("singleTrackTrackNamePolicy",oe.trackNamePolicyReversed.get(e.singleTrackTrackNamePolicy))),e.multiTrackTrackNamePolicy!==Pe.ai.stylesheet.multiTrackTrackNamePolicy&&t.push(be.identMeta("multiTrackTrackNamePolicy",oe.trackNamePolicyReversed.get(e.multiTrackTrackNamePolicy))),e.firstSystemTrackNameMode!==Pe.ai.stylesheet.firstSystemTrackNameMode&&t.push(be.identMeta("firstSystemTrackNameMode",oe.trackNameModeReversed.get(e.firstSystemTrackNameMode))),e.otherSystemsTrackNameMode!==Pe.ai.stylesheet.otherSystemsTrackNameMode&&t.push(be.identMeta("otherSystemsTrackNameMode",oe.trackNameModeReversed.get(e.otherSystemsTrackNameMode))),e.firstSystemTrackNameOrientation!==Pe.ai.stylesheet.firstSystemTrackNameOrientation&&t.push(be.identMeta("firstSystemTrackNameOrientation",oe.trackNameOrientationReversed.get(e.firstSystemTrackNameOrientation))),e.otherSystemsTrackNameOrientation!==Pe.ai.stylesheet.otherSystemsTrackNameOrientation&&t.push(be.identMeta("otherSystemsTrackNameOrientation",oe.trackNameOrientationReversed.get(e.otherSystemsTrackNameOrientation))),e.extendBarLines&&t.push(be.meta("extendBarLines")),e.globalDisplayChordDiagramsInScore&&t.push(be.meta("chordDiagramsInScore")),e.hideEmptyStaves&&t.push(be.meta("hideEmptyStaves")),e.hideEmptyStavesInFirstSystem&&t.push(be.meta("hideEmptyStavesInFirstSystem")),e.showSingleStaffBrackets&&t.push(be.meta("showSingleStaffBrackets")),e.barNumberDisplay!==O.AllBars&&t.push(be.identMeta("defaultBarNumberDisplay",O[e.barNumberDisplay])),s<t.length&&(t[s].leadingComments=[{multiLine:!1,text:"Score Stylesheet"}])}static oi(t,e,s,i,n,r=!1){if(void 0!==i&&0===i.length&&!r)return;const a=[];if(void 0!==i&&a.push(be.string(i)),void 0!==n){const t=s.style&&s.style.headerAndFooter.has(n)?s.style.headerAndFooter.get(n):void 0,e=Gt.defaultHeaderAndFooter.has(n)?Gt.defaultHeaderAndFooter.get(n):void 0;!t||e&&It.equals(e,t)||(a.push(be.string(!1===t.isVisible?"":t.template)),a.push(be.ident(oe.textAlignReversed.get(t.textAlign))))}void 0===i&&0===a.length||void 0!==i&&0===i.length&&1===a.length||t.push(be.meta(e,be.args(a)))}buildSyncPointNodes(t){const e=[],s=t.exportFlatSyncPoints();for(const t of s)e.push(be.meta("sync",be.args([be.number(t.barIndex),be.number(t.barOccurence),be.number(t.millisecondOffset),t.barPosition>0?be.number(t.barPosition):void 0])));return e}buildBarMetaDataNodes(t,e,s,i){const n=[];if(Pe.li(e,t,n,i,s),!e)return n;0===s&&0===t.index&&0===t.track.index&&Pe.ui(n,e.masterBar);const r=n.length;0===s&&0===e.index&&0===t.index&&0===t.track.index&&n.push(be.identMeta("accidentals","auto")),0!==e.index&&e.clef===e.previousBar?.clef||n.push(be.identMeta("clef",oe.clefReversed.get(e.clef))),(0===e.index&&e.clefOttava!==b.Regular||e.clefOttava!==e.previousBar?.clefOttava)&&n.push(be.identMeta("ottava",oe.ottaviaReversed.get(e.clefOttava))),(0===e.index&&e.simileMark!==M.None||e.simileMark!==e.previousBar?.simileMark)&&n.push(be.identMeta("simile",oe.simileMarkReversed.get(e.simileMark))),1!==e.displayScale&&n.push(be.numberMeta("scale",e.displayScale)),e.displayWidth>0&&n.push(be.numberMeta("width",e.displayWidth));for(const t of e.sustainPedals){let e="";switch(t.pedalType){case P.Down:e="spd";break;case P.Hold:e="sph";break;case P.Up:e="spu"}e&&n.push(be.numberMeta(e,t.ratioPosition))}if(e.barLineLeft!==E.Automatic&&n.push(be.identMeta("barLineLeft",oe.barLineStyleReversed.get(e.barLineLeft))),e.barLineRight!==E.Automatic&&n.push(be.identMeta("barLineRight",oe.barLineStyleReversed.get(e.barLineRight))),0===e.index||e.keySignature!==e.previousBar.keySignature||e.keySignatureType!==e.previousBar.keySignatureType){let t="";t=e.keySignatureType===N.Minor?oe.keySignaturesMinorReversed.get(e.keySignature):oe.keySignaturesMajorReversed.get(e.keySignature),n.push(be.identMeta("ks",t))}return r<n.length&&(n[r].leadingComments=[{multiLine:!1,text:`Bar ${e.index+1} Metadata`}]),void 0!==e.barNumberDisplay&&n.push(be.identMeta("barNumberDisplay",O[e.barNumberDisplay])),n}static di(t,e){const s=t.length;if(0!==e.capo&&t.push(be.numberMeta("capo",e.capo)),e.isPercussion)t.push(be.identMeta("articulation","defaults"));else if(e.isStringed){const s=be.meta("tuning",be.args(e.stringTuning.tunings.map(t=>be.ident(Te.getTextForTuning(t,!0)))));t.push(s),e.track.score.stylesheet.perTrackDisplayTuning&&e.track.score.stylesheet.perTrackDisplayTuning.has(e.track.index)&&(s.properties=be.props([["hide",void 0]])),e.stringTuning.name.length>0&&(s.properties??=be.props([]),be.prop(s.properties.properties,"label",be.stringValue(e.stringTuning.name)))}0!==e.transpositionPitch&&t.push(be.numberMeta("transpose",-e.transpositionPitch));const i=zt.displayTranspositionPitches.has(e.track.playbackInfo.program)?zt.displayTranspositionPitches.get(e.track.playbackInfo.program):0;if(e.displayTranspositionPitch!==i&&t.push(be.numberMeta("displaytranspose",-e.displayTranspositionPitch)),null!=e.chords)for(const[s,i]of e.chords)t.push(Pe.fi(i));s<t.length&&(t[s].leadingComments=[{multiLine:!1,text:`Staff ${e.index+1} Metadata`}])}static fi(t){const e=be.meta("chord",be.args([be.string(t.name)],!0),be.props([t.firstFret>=0?["firstfret",be.numberValue(t.firstFret)]:void 0,["showdiagram",be.identValue(t.showDiagram?"true":"false")],["showfingering",be.identValue(t.showFingering?"true":"false")],["showname",be.identValue(t.showName?"true":"false")],t.barreFrets.length>0?["barre",be.args(t.barreFrets.map(t=>be.number(t)))]:void 0]));for(let s=0;s<t.staff.tuning.length;s++)s<t.strings.length&&t.strings[s]>=0?e.arguments.arguments.push(be.number(t.strings[s])):e.arguments.arguments.push(be.ident("x"));return e}static ui(t,e){const s=t.length;if(0!==e.alternateEndings&&t.push(be.meta("ae",be.args(zt.getAlternateEndingsList(e.alternateEndings).map(t=>be.number(t+1))))),e.isRepeatStart&&t.push(be.meta("ro")),e.isRepeatEnd&&t.push(be.numberMeta("rc",e.repeatCount)),0!==e.index&&e.timeSignatureCommon===e.previousMasterBar?.timeSignatureCommon&&e.timeSignatureNumerator===e.previousMasterBar.timeSignatureNumerator&&e.timeSignatureDenominator===e.previousMasterBar.timeSignatureDenominator||(e.timeSignatureCommon?t.push(be.identMeta("ts","common")):t.push(be.meta("ts",be.args([be.number(e.timeSignatureNumerator),be.number(e.timeSignatureDenominator)])))),e.beamingRules)for(const[s,i]of e.beamingRules.groups){const e=be.args([be.number(s)],!0);for(const t of i)e.arguments.push(be.number(t));t.push(be.meta("beaming",e))}if((e.index>0&&e.tripletFeel!==e.previousMasterBar?.tripletFeel||0===e.index&&e.tripletFeel!==F.NoTripletFeel)&&t.push(be.identMeta("tf",oe.tripletFeelReversed.get(e.tripletFeel))),e.isFreeTime&&t.push(be.meta("ft")),null!=e.section&&t.push(be.meta("section",be.args([be.string(e.section.marker),be.string(e.section.text)]))),e.isAnacrusis&&t.push(be.meta("ac")),1!==e.displayScale&&t.push(be.numberMeta("scale",e.displayScale)),e.displayWidth>0&&t.push(be.numberMeta("width",e.displayWidth)),e.directions)for(const s of e.directions)t.push(be.identMeta("jump",oe.directionReversed.get(s)));for(const s of e.tempoAutomations){const e=be.meta("tempo",be.args([be.number(s.value),s.text?be.string(s.text):void 0,s.ratioPosition>0?be.number(s.ratioPosition):void 0,s.isVisible?void 0:be.ident("hide")]));1===e.arguments.arguments.length&&(e.arguments.openParenthesis=void 0,e.arguments.closeParenthesis=void 0),t.push(e)}s<t.length&&(t[s].leadingComments=[{multiLine:!1,text:`Masterbar ${e.index+1} Metadata`}])}static li(t,e,s,i,n){if((void 0===t||0===t.index)&&(0===n&&(0===e.index&&s.push(Pe.pi(e.track)),s.push(Pe.bi(e)),Pe.di(s,e)),i)){const t=be.meta("voice");t.trailingComments=[{multiLine:!0,text:`Voice ${n+1}`}],s.push(t)}}static bi(t){const e=be.meta("staff",void 0,be.props([t.showStandardNotation?["score",be.args([t.standardNotationLineCount!==xe.DefaultStandardNotationLineCount?be.number(t.standardNotationLineCount):void 0])]:void 0,t.showTablature?["tabs",void 0]:void 0,t.showSlash?["slash",void 0]:void 0,t.showNumbered?["numbered",void 0]:void 0]));return e.properties&&e.properties.properties.length>0&&(e.properties.properties[0].leadingComments=[{multiLine:!1,text:"Staff Properties"}]),e}static pi(t){const e=be.meta("track",be.args([be.string(t.name),t.shortName.length>0?be.string(t.shortName):void 0]),be.props([t.color.rgba!==Pe.hi.color.rgba?["color",be.stringValue(t.color.rgba)]:void 0,t.defaultSystemsLayout!==Pe.hi.defaultSystemsLayout?["defaultSystemsLayout",be.numberValue(t.defaultSystemsLayout)]:void 0,t.systemsLayout.length?["systemsLayout",be.args(t.systemsLayout.map(t=>be.number(t)))]:void 0,["volume",be.numberValue(t.playbackInfo.volume)],["balance",be.numberValue(t.playbackInfo.balance)],t.playbackInfo.isMute?["mute",void 0]:void 0,t.playbackInfo.isSolo?["solo",void 0]:void 0,t.score.stylesheet.perTrackMultiBarRest&&t.score.stylesheet.perTrackMultiBarRest.has(t.index)?["multiBarRest",void 0]:void 0,["instrument",be.identValue(t.isPercussion?"percussion":ge.getName(t.playbackInfo.program))],t.playbackInfo.bank>0?["bank",be.numberValue(t.playbackInfo.bank)]:void 0]));return e.properties&&e.properties.properties.length>0&&(e.properties.properties[0].leadingComments=[{multiLine:!1,text:"Track Properties"}]),e}buildNoteEffects(t){const e=[];if(t.hasBend){const s=be.args([be.ident(oe.bendTypeReversed.get(t.bendType)),t.bendStyle!==r.Default?be.ident(oe.bendStyleReversed.get(t.bendStyle)):void 0],!0);for(const e of t.bendPoints)s.arguments.push(be.number(e.offset)),s.arguments.push(be.number(e.value));be.prop(e,"be",s)}let s="";switch(t.harmonicType){case f.Natural:be.prop(e,"nh");break;case f.Artificial:s="ah";break;case f.Pinch:s="ph";break;case f.Tap:s="th";break;case f.Semi:s="sh";break;case f.Feedback:s="fh"}switch(s&&be.prop(e,s,be.numberValue(t.harmonicValue)),t.showStringNumber&&be.prop(e,"string"),t.isTrill&&be.prop(e,"tr",be.args([be.number(t.trillFret),be.number(t.trillSpeed)])),t.vibrato){case w.Slight:be.prop(e,"v");break;case w.Wide:be.prop(e,"vw")}switch(t.slideInType){case m.IntoFromBelow:be.prop(e,"sib");break;case m.IntoFromAbove:be.prop(e,"sia")}switch(t.slideOutType){case g.Shift:be.prop(e,"ss");break;case g.Legato:be.prop(e,"sl");break;case g.OutUp:be.prop(e,"sou");break;case g.OutDown:be.prop(e,"sod");break;case g.PickSlideDown:be.prop(e,"psd");break;case g.PickSlideUp:be.prop(e,"psu")}switch(t.isHammerPullOrigin&&be.prop(e,"h"),t.isLeftHandTapped&&be.prop(e,"lht"),t.isGhost&&be.prop(e,"g"),t.accentuated){case u.Normal:be.prop(e,"ac");break;case u.Heavy:be.prop(e,"hac");break;case u.Tenuto:be.prop(e,"ten")}if(t.isPalmMute&&be.prop(e,"pm"),t.isStaccato&&be.prop(e,"st"),t.isLetRing&&be.prop(e,"lr"),t.isDead&&be.prop(e,"x"),t.isTieDestination&&be.prop(e,"t"),t.leftHandFinger>=d.Thumb&&be.prop(e,"lf",be.numberValue(t.leftHandFinger+1)),t.rightHandFinger>=d.Thumb&&be.prop(e,"rf",be.numberValue(t.rightHandFinger+1)),t.isVisible||be.prop(e,"hide"),t.isSlurOrigin){const s=`s${t.id}`;be.prop(e,"slur",be.identValue(s))}if(t.isSlurDestination){const s=`s${t.slurOrigin.id}`;be.prop(e,"slur",be.identValue(s))}switch(t.accidentalMode===p.Default||t.beat.voice.bar.keySignature===v.C&&t.accidentalMode===p.ForceNatural||be.prop(e,"acc",be.identValue(zt.reverseAccidentalModeMapping.get(t.accidentalMode))),t.ornament){case dt.InvertedTurn:be.prop(e,"iturn");break;case dt.Turn:be.prop(e,"turn");break;case dt.UpperMordent:be.prop(e,"umordent");break;case dt.LowerMordent:be.prop(e,"lmordent")}return e}buildBeatEffects(t){const e=[];switch(t.fade){case mt.FadeIn:be.prop(e,"f");break;case mt.FadeOut:be.prop(e,"fo");break;case mt.VolumeSwell:be.prop(e,"vs")}if(t.vibrato===w.Slight?be.prop(e,"v"):t.vibrato===w.Wide&&be.prop(e,"vw"),t.slap&&be.prop(e,"s"),t.pop&&be.prop(e,"p"),t.tap&&be.prop(e,"tt"),t.dots>=2?be.prop(e,"dd"):t.dots>0&&be.prop(e,"d"),t.pickStroke===ct.Up?be.prop(e,"su"):t.pickStroke===ct.Down&&be.prop(e,"sd"),t.hasTuplet&&be.prop(e,"tu",be.args([be.number(t.tupletNumerator),be.number(t.tupletDenominator)])),t.hasWhammyBar){const s=be.args([be.ident(oe.whammyTypeReversed.get(t.whammyBarType)),be.ident(oe.bendStyleReversed.get(t.whammyStyle))],!0);for(const e of t.whammyBarPoints)s.arguments.push(be.number(e.offset)),s.arguments.push(be.number(e.value));be.prop(e,"tbe",s)}let s="";switch(t.brushType){case h.BrushUp:s="bu";break;case h.BrushDown:s="bd";break;case h.ArpeggioUp:s="au";break;case h.ArpeggioDown:s="ad"}if(s&&be.prop(e,s,be.numberValue(t.brushDuration)),null!=t.chord&&be.prop(e,"ch",be.stringValue(t.chord.name)),t.ottava!==b.Regular&&be.prop(e,"ot",be.identValue(oe.ottaviaReversed.get(t.ottava))),t.hasRasgueado&&be.prop(e,"rasg",be.identValue(oe.rasgueadoReversed.get(t.rasgueado))),null!=t.text&&be.prop(e,"txt",be.stringValue(t.text)),null!=t.lyrics&&t.lyrics.length>0)if(t.lyrics.length>1)for(let s=0;s<t.lyrics.length;s++)be.prop(e,"lyrics",be.args([be.number(s),be.string(t.lyrics[s])]));else be.prop(e,"lyrics",be.stringValue(t.lyrics[0]));if(t.graceType!==l.None&&be.prop(e,"gr",t.graceType===l.BeforeBeat?void 0:be.identValue(oe.graceTypeReversed.get(t.graceType))),t.isTremolo){const s=[be.number(t.tremoloPicking.marks)];t.tremoloPicking.style!==kt.Default&&s.push(be.ident(kt[t.tremoloPicking.style])),be.prop(e,"tp",be.args(s))}switch(t.crescendo){case o.Crescendo:be.prop(e,"cre");break;case o.Decrescendo:be.prop(e,"dec")}(0===t.voice.bar.index&&0===t.index||t.dynamics!==t.previousBeat?.dynamics)&&be.prop(e,"dy",be.identValue(oe.dynamicValueReversed.get(t.dynamics)));null!=t.fermata&&be.prop(e,"fermata",be.args([be.ident(oe.fermataTypeReversed.get(t.fermata.type)),be.number(t.fermata.length)])),t.isLegatoOrigin&&be.prop(e,"legatoorigin");for(const s of t.automations)switch(s.type){case n.Tempo:be.prop(e,"tempo",be.args([be.number(s.value),0===s.text.length?void 0:be.string(s.text)]));break;case n.Volume:be.prop(e,"volume",be.numberValue(s.value));break;case n.Instrument:t.voice.bar.staff.isPercussion||be.prop(e,"instrument",be.identValue(ge.getName(s.value)));break;case n.Balance:be.prop(e,"balance",be.numberValue(s.value))}switch(t.wahPedal){case gt.Open:be.prop(e,"waho");break;case gt.Closed:be.prop(e,"wahc")}switch(t.isBarre&&be.prop(e,"barre",be.args([be.number(t.barreFret),be.ident(oe.barreShapeReversed.get(t.barreShape))])),t.slashed&&be.prop(e,"slashed"),t.deadSlapped&&be.prop(e,"ds"),t.golpe){case bt.Thumb:be.prop(e,"glpt");break;case bt.Finger:be.prop(e,"glpf")}t.invertBeamDirection?be.prop(e,"beam",be.identValue("invert")):null!==t.preferredBeamDirection&&be.prop(e,"beam",be.identValue(Wt[t.preferredBeamDirection]));let i="";switch(t.beamingMode){case St.ForceSplitToNext:i="split";break;case St.ForceMergeWithNext:i="merge";break;case St.ForceSplitOnSecondaryToNext:i="splitsecondary"}return i&&be.prop(e,"beam",be.identValue(i)),t.showTimer&&be.prop(e,"timer"),e}}class Ce{data;settings;init(t,e){this.data=t,this.settings=e,Ht.resetIds()}}class Ee extends I{constructor(t=null,e){super(s.Format,t??"Unsupported format",e)}}class Fe{mi;length=0;position=0;get bytesWritten(){return this.position}getBuffer(){return this.mi}static empty(){return Fe.withCapacity(0)}static withCapacity(t){const e=new Fe;return e.mi=new Uint8Array(t),e}static fromBuffer(t){const e=new Fe;return e.mi=t,e.length=t.length,e}static fromString(t){const e=de.stringToBytes(t);return Fe.fromBuffer(e)}reset(){this.position=0}skip(t){this.position+=t}readByte(){return this.length-this.position<=0?-1:this.mi[this.position++]}read(t,e,s){let i=this.length-this.position;return i>s&&(i=s),i<=0?0:(t.set(this.mi.subarray(this.position,this.position+i),e),this.position+=i,i)}writeByte(t){const e=this.position+1;this.gi(e),this.mi[this.position]=255&t,e>this.length&&(this.length=e),this.position=e}write(t,e,s){const i=this.position+s;this.gi(i);const n=Math.min(s,t.length-e);this.mi.set(t.subarray(e,e+n),this.position),i>this.length&&(this.length=i),this.position=i}gi(t){if(t>this.mi.length){let e=t;e<256&&(e=256),e<2*this.mi.length&&(e=2*this.mi.length);const s=new Uint8Array(e);this.length>0&&s.set(this.mi.subarray(0,0+this.length),0),this.mi=s}}readAll(){return this.toArray()}toArray(){const t=new Uint8Array(this.length);return t.set(this.mi.subarray(0,0+this.length),0),t}copyTo(t){t.write(this.mi,0,this.length)}}class Ae extends I{lexerDiagnostics;parserDiagnostics;semanticDiagnostics;*iterateDiagnostics(){if(this.lexerDiagnostics)for(const t of this.lexerDiagnostics.items)yield t;if(this.parserDiagnostics)for(const t of this.parserDiagnostics.items)yield t;if(this.semanticDiagnostics)for(const t of this.semanticDiagnostics.items)yield t}constructor(t,e,i,n){super(s.AlphaTex,t),this.lexerDiagnostics=e,this.parserDiagnostics=i,this.semanticDiagnostics=n}toString(){return[this.message,"lexer diagnostics:",Ae.wi(this.lexerDiagnostics,"  "),"parser diagnostics:",Ae.wi(this.parserDiagnostics,"  "),"semantic diagnostics:",Ae.wi(this.semanticDiagnostics,"  ")].join("\n")}static wi(t,e){return t?t.items.map(t=>`${e}${Tt[t.severity]} AT${t.code.toString().padStart(3,"0")}${Ae.yi(t)}: ${t.message}`).join("\n"):`${e}none`}static yi(t){let e="";return t.start&&(e+=`(${t.start.line},${t.start.col})`),t.end&&(e.length>0&&(e+="->"),e+=`(${t.end.line},${t.end.col})`),e}}class De{trackChannel=0;score;currentTrack;currentStaff;barIndex=0;voiceIndex=0;ignoredInitialVoice=!1;ignoredInitialStaff=!1;ignoredInitialTrack=!1;currentDuration=c.Quarter;articulationUniqueIdToIndex=new Map;hasAnyProperData=!1;percussionArticulationNames=new Map;slurs=new Map;lyrics=new Map;sustainPedalToBeat=new Map;staffTuningApplied=new Set;staffNoteKind=new Map;staffHasExplicitTuning=new Set;staffHasExplicitDisplayTransposition=new Set;staffDisplayTranspositionApplied=new Set;staffInitialClef=new Map;syncPoints=[];currentDynamics=i.F;accidentalMode=Mt.Explicit;voiceMode=vt.StaffWise;currentTupletNumerator=-1;currentTupletDenominator=-1;scoreNode}class Le extends Ce{ki;Si=Pe.instance;Bi=new De;get state(){return this.Bi}get scoreNode(){return this.Bi.scoreNode}get name(){return"AlphaTex"}get lexerDiagnostics(){return this.ki.lexerDiagnostics}get parserDiagnostics(){return this.ki.parserDiagnostics}get parser(){return this.ki}get parseMode(){return this.ki.mode}logErrors=!1;semanticDiagnostics=new le;addSemanticDiagnostic(t){this.semanticDiagnostics.push(t)}initFromString(t,e){this.data=Fe.empty(),this.ki=new pe(t),this.settings=e,Ht.resetIds()}readScore(){let t;this.Bi=new De,this._i(),this.data.length>0&&(this.ki=new pe(de.toString(this.data.readAll(),this.settings.importer.encoding)));try{t=this.ki.read(),this.Bi.scoreNode=t}catch(t){throw this.logErrors&&J.error("AlphaTex",`Error while parsing alphaTex: ${t.toString()}`),new Ee("Error parsing alphaTex, check inner error for details",t)}if(this.ki.parserDiagnostics.hasErrors||this.ki.lexer.lexerDiagnostics.hasErrors){const t=new Ae("There are errors in the parsed alphaTex, check the diagnostics for details",this.lexerDiagnostics,this.parserDiagnostics,this.semanticDiagnostics);throw this.logErrors&&J.error("AlphaTex",`Error while parsing alphaTex: ${t.toString()}`),new Ee("Error parsing alphaTex, check diagnostics on inner error for details",t)}if(this.Le(t),this.semanticDiagnostics.hasErrors){if(this.Bi.hasAnyProperData){const t=new Ae("There are errors in the parsed alphaTex, check the diagnostics for details",this.lexerDiagnostics,this.parserDiagnostics,this.semanticDiagnostics);throw this.logErrors&&J.error("AlphaTex",`Error while parsing alphaTex: ${t.toString()}`),t}throw new Ee("No alphaTex data found")}zt.consolidate(this.Bi.score),this.Bi.score.finish(this.settings),zt.trimEmptyBarsAtEnd(this.Bi.score),this.Bi.score.rebuildRepeatGroups(),this.Bi.score.applyFlatSyncPoints(this.Bi.syncPoints);for(const[t,e]of this.Bi.lyrics)this.Bi.score.tracks[t].applyLyrics(e);for(const[t,e]of this.Bi.sustainPedalToBeat)if(t.ratioPosition<1){const s=e.voice.bar.masterBar.calculateDuration();t.ratioPosition=e.playbackStart/s}return this.Bi.score}_i(){this.Bi.score=new Ht,this.Ti()}Ti(){this.Bi.currentTrack=new Ne,this.Bi.currentTrack.ensureStaveCount(1),this.Bi.currentTrack.playbackInfo.program=25,this.Bi.currentTrack.playbackInfo.primaryChannel=this.Bi.trackChannel++,this.Bi.currentTrack.playbackInfo.secondaryChannel=this.Bi.trackChannel++;const t=this.Bi.currentTrack.staves[0];t.displayTranspositionPitch=0,t.stringTuning=Te.getDefaultTuningFor(6),this.Bi.articulationUniqueIdToIndex.clear(),this.xi(t),this.Bi.score.addTrack(this.Bi.currentTrack),this.Bi.lyrics.set(this.Bi.currentTrack.index,[]),this.Bi.currentDynamics=i.F,this.Bi.currentTupletDenominator=-1,this.Bi.currentTupletNumerator=-1}xi(t){this.Bi.currentStaff&&(this.Ni(this.Bi.currentStaff),this.Pi(this.Bi.currentStaff)),this.Bi.currentStaff=t,this.Bi.slurs.clear(),this.Bi.barIndex=0,this.Bi.voiceIndex=0}Le(t){if(t.bars.length>0){let e=!1;for(const s of t.bars)switch(this.We(s,e),this.state.voiceMode){case vt.StaffWise:this.Bi.barIndex++,e=!0;break;case vt.BarWise:s.pipe&&(this.Bi.barIndex++,this.Bi.voiceIndex=0,this.Bi.ignoredInitialVoice=!1,e=!0)}}else this.Ci(this.Bi.currentStaff),this.Ni(this.Bi.currentStaff),this.Pi(this.Bi.currentStaff)}We(t,e){const s=this.Ei(t,e);this.Ni(this.Bi.currentStaff),this.Pi(this.Bi.currentStaff),0===s.index&&this.Bi.staffInitialClef.has(this.Bi.currentStaff)&&(s.clef=this.Bi.staffInitialClef.get(this.Bi.currentStaff));const i=s.voices[this.Bi.voiceIndex];for(const e of t.beats)this.Ge(i,e);if(0===i.beats.length){const t=new ee;t.isEmpty=!0,i.addBeat(t)}}Ge(t,e){if(e.durationChange&&this.$e(e.durationChange),!e.notes&&!e.rest)return;const s=new ee;if(t.addBeat(s),e.notes)for(const t of e.notes.notes)this.je(s,t);else e.rest;e.durationValue&&(this.Bi.currentDuration=this.Fi(e.durationValue)),s.duration=this.Bi.currentDuration,s.dynamics=this.Bi.currentDynamics,-1===this.Bi.currentTupletNumerator||s.hasTuplet||(s.tupletNumerator=this.Bi.currentTupletNumerator,s.tupletDenominator=this.Bi.currentTupletDenominator);let i=1;void 0!==e.beatMultiplierValue&&(i=e.beatMultiplierValue.value),e.beatEffects&&this.Ai(s,e.beatEffects);for(let e=0;e<i-1;e++)t.addBeat(he.clone(s))}Ai(t,e){for(const s of e.properties){switch(this.Si.applyBeatProperty(this,t,s)){case Et.Applied:case Et.NotAppliedSemanticError:this.Bi.hasAnyProperData=!0;break;case Et.NotAppliedUnrecognizedMarker:const t=Array.from(this.Si.knownBeatProperties).join(",");this.addSemanticDiagnostic({code:xt.AT212,message:`Unrecogized property '${s.property.text}', expected one of ${t}`,severity:Tt.Error,start:s.start,end:s.end})}}}$e(t){if(t.value&&(this.Bi.currentDuration=this.Fi(t.value)),this.Bi.currentTupletNumerator=-1,this.Bi.currentTupletDenominator=-1,t.properties)for(const e of t.properties.properties){switch(this.Si.applyBeatDurationProperty(this,e)){case Et.Applied:case Et.NotAppliedSemanticError:this.Bi.hasAnyProperData=!0;break;case Et.NotAppliedUnrecognizedMarker:const t=Array.from(this.Si.knownBeatDurationProperties).join(",");this.addSemanticDiagnostic({code:xt.AT212,message:`Unrecogized property '${e.property.text}', expected one of ${t}`,severity:Tt.Error,start:e.start,end:e.end})}}}Fi(t){switch(t.value){case-4:return c.QuadrupleWhole;case-2:return c.DoubleWhole;case 1:return c.Whole;case 2:return c.Half;case 4:return c.Quarter;case 8:return c.Eighth;case 16:return c.Sixteenth;case 32:return c.ThirtySecond;case 64:return c.SixtyFourth;case 128:return c.OneHundredTwentyEighth;case 256:return c.TwoHundredFiftySixth;default:return this.addSemanticDiagnostic({code:xt.AT209,message:`Unexpected duration value '${t.value}', expected: -4, -2, 1, 2, 4, 8, 16, 32, 64, 128 or 256`,severity:Tt.Error,start:t.start,end:t.end}),this.Bi.currentDuration}}je(t,e){let s=!1,i=!1,n=-1,r="",a=-1,h=-1,o=p.Default;const c=e.noteValue;let l,u=this.Bi.staffNoteKind.has(this.Bi.currentStaff)?this.Bi.staffNoteKind.get(this.Bi.currentStaff):void 0;switch(c.nodeType){case _t.Number:n=c.value,l=void 0!==e.noteString?Nt.Fretted:Nt.Articulation;break;case _t.String:case _t.Ident:const t=c.text;if(s="x"===t,i="-"===t,i||s)n=0,l=e.noteStringDot&&e.noteString?Nt.Fretted:void 0;else{const e=zt.parseTuning(t);if(e)l=Nt.Pitched,a=e.octave,h=e.tone.noteValue,this.Bi.accidentalMode===Mt.Explicit&&(o=e.tone.accidentalMode);else{l=Nt.Articulation;const e=t.toLowerCase(),s=this.Bi.percussionArticulationNames;if(void 0===u&&0===s.size)for(const[t,e]of Jt.instrumentArticulationNames){Jt.getInstrumentArticulationByUniqueId(e)&&(s.set(t.toLowerCase(),e),s.set(zt.toArticulationId(t),e))}if(!s.has(e))return this.addSemanticDiagnostic({code:xt.AT209,message:`Unexpected percussion articulation value '${e}', expected: oneOf(${Array.from(this.Bi.percussionArticulationNames.keys()).join(",")}).`,severity:Tt.Error,start:c.start,end:c.end}),void(r=Array.from(Jt.instrumentArticulationNames.values())[0]);r=s.get(e)}}}void 0!==l?void 0===u?(u=l,this.applyStaffNoteKind(this.Bi.currentStaff,u)):u!==l&&this.addSemanticDiagnostic({code:xt.AT218,message:`Wrong note kind '${Nt[l]}' for staff with note kind ''${Nt[u]}'. Do not mix incompatible staves and notes.`,severity:Tt.Error,start:c.start,end:c.end}):void 0!==u&&(l=u);const d=new Kt;if(d.isDead=s,(s||i)&&(d.fret=n),d.isTieDestination=i,void 0!==l&&l===u)switch(l){case Nt.Pitched:d.octave=a,d.tone=h,d.accidentalMode=o;break;case Nt.Fretted:if(!e.noteString)return void this.addSemanticDiagnostic({code:xt.AT207,message:"Missing string for fretted note.",severity:Tt.Error,start:c.end,end:c.end});const t=e.noteString.value;if(t<1||t>this.Bi.currentStaff.tuning.length)return void this.addSemanticDiagnostic({code:xt.AT208,message:`Note string is out of range. Available range: 1-${this.Bi.currentStaff.tuning.length}`,severity:Tt.Error,start:c.end,end:c.end});d.string=this.Bi.currentStaff.tuning.length-(t-1),i||(d.fret=n);break;case Nt.Articulation:let s=0;if(0===r.length&&n>0){const t=Jt.getArticulationById(n);t&&(r=t.uniqueId)}if(this.Bi.articulationUniqueIdToIndex.has(r))s=this.Bi.articulationUniqueIdToIndex.get(r);else{s=this.Bi.currentTrack.percussionArticulations.length;const t=Jt.getInstrumentArticulationByUniqueId(r);if(null===t)return void this.addSemanticDiagnostic({code:xt.AT209,message:`Unexpected articulation value '${n}', expected: oneOf(${Array.from(Jt.instrumentArticulations.keys()).join(",")}).`,severity:Tt.Error,start:c.end,end:c.end});this.Bi.currentTrack.percussionArticulations.push(t),this.Bi.articulationUniqueIdToIndex.set(r,s)}d.percussionArticulation=s}t.addNote(d),this.Bi.hasAnyProperData=!0,e.noteEffects&&this.Di(d,e.noteEffects)}getStaffNoteKind(t){return this.Bi.staffNoteKind.has(t)?this.Bi.staffNoteKind.get(t):void 0}applyStaffNoteKind(t,e){switch(this.Bi.staffNoteKind.set(t,e),e){case Nt.Pitched:t.isPercussion=!1,t.stringTuning.reset(),this.Bi.staffHasExplicitDisplayTransposition.has(t)||(t.displayTranspositionPitch=0);break;case Nt.Fretted:t.isPercussion=!1,this.Ni(t),this.Pi(t);break;case Nt.Articulation:t.isPercussion=!0,t.stringTuning.reset(),this.Bi.staffHasExplicitDisplayTransposition.has(t)||(t.displayTranspositionPitch=0)}}Di(t,e){for(const s of e.properties){let e=this.Si.applyNoteProperty(this,t,s);switch(e===Et.NotAppliedUnrecognizedMarker&&(e=this.Si.applyBeatProperty(this,t.beat,s)),e){case Et.Applied:case Et.NotAppliedSemanticError:break;case Et.NotAppliedUnrecognizedMarker:const t=Array.from(this.Si.knownNoteProperties).concat(Array.from(this.Si.knownBeatProperties)).join(",");this.addSemanticDiagnostic({code:xt.AT212,message:`Unrecogized property '${s.property.text}', expected one of ${t}`,severity:Tt.Error,start:s.start,end:s.end})}}}Pi(t){if(!this.Bi.staffDisplayTranspositionApplied.has(t)&&!this.Bi.staffHasExplicitDisplayTransposition.has(t)){const e=t.track.playbackInfo.program;zt.displayTranspositionPitches.has(e)?t.displayTranspositionPitch=zt.displayTranspositionPitches.get(e):this.Bi.currentStaff.displayTranspositionPitch=0,this.Bi.staffDisplayTranspositionApplied.add(t)}}Ni(t){const e=t.track.playbackInfo.program;this.Bi.staffTuningApplied.has(t)||this.Bi.staffHasExplicitTuning.has(t)||(t.stringTuning.reset(),15===e||e>=24&&e<=31?t.stringTuning.tunings=Te.getDefaultTuningFor(6).tunings:e>=32&&e<=39?(t.stringTuning.tunings=[43,38,33,28],this.Bi.staffInitialClef.set(t,x.F4)):40===e||44===e||45===e||48===e||49===e||50===e||51===e?t.stringTuning.tunings=[52,57,50,43]:41===e?t.stringTuning.tunings=[57,50,43,36]:42===e?t.stringTuning.tunings=[45,38,31,24]:43===e?t.stringTuning.tunings=[43,38,33,28]:105===e?t.stringTuning.tunings=[50,47,43,38,55]:106===e?t.stringTuning.tunings=[57,52,45]:107===e?t.stringTuning.tunings=[52,45,38,31]:110===e?t.stringTuning.tunings=[64,57,50,43]:this.Bi.staffNoteKind.has(t)&&this.Bi.staffNoteKind.get(t)===Nt.Fretted&&(t.stringTuning=Te.getDefaultTuningFor(6)),this.Bi.staffTuningApplied.add(t))}Ei(t,e){let i=this.Bi.score.masterBars.length>0?void 0:[],n=this.Bi.currentStaff,r=!1,a=!1,h=!1,o=!1;const c=()=>{i&&(i=void 0,n=this.Bi.currentStaff,r=!1,a=!1,h=!1,o=!1)},l=new X(()=>{h||e||this.Bi.barIndex++;const t=this.Ci(this.Bi.currentStaff);if(i){for(const e of i)this.Si.applyBarMetaData(this,t,e);c()}return t});for(const e of t.metaData){const t=e.tag.tag.text.toLowerCase();if(this.Si.knownStructuralMetaDataTags.has(t)){this.Bi.hasAnyProperData=!0;switch(this.Si.applyStructuralMetaData(this,e)){case Ft.AppliedNewTrack:a||r?o=!0:(r=!0,n=this.Bi.currentStaff),l.reset();break;case Ft.AppliedNewStaff:a?o=!0:(a=!0,n=this.Bi.currentStaff),l.reset();break;case Ft.AppliedNewVoice:h=!0}if(i&&o){if(0!==n.bars.length)throw new I(s.AlphaTex,"Unexpected internal error, didn't expect a filled staff after multiple \\track and/or \\staff tags. Please report this problem providing the input alphaTex.");{const t=new Q;n.addBar(t);const e=new rt;if(t.addVoice(e),n.bars.length>this.Bi.score.masterBars.length){const t=new tt;this.Bi.score.addMasterBar(t)}for(const e of i)this.Si.applyBarMetaData(this,t,e);c()}}}else if(this.Si.knownScoreMetaDataTags.has(e.tag.tag.text.toLowerCase()))this.Bi.hasAnyProperData=!0,this.Si.applyScoreMetaData(this,this.Bi.score,e);else if(this.Si.knownStaffMetaDataTags.has(e.tag.tag.text.toLowerCase()))this.Bi.hasAnyProperData=!0,this.Si.applyStaffMetaData(this,this.Bi.currentStaff,e);else if(this.Si.knownBarMetaDataTags.has(e.tag.tag.text.toLowerCase()))this.Bi.hasAnyProperData=!0,i?i.push(e):this.Si.applyBarMetaData(this,l.value,e);else{const t=Array.from(this.Si.allKnownMetaDataTags).join(",");this.addSemanticDiagnostic({code:xt.AT204,message:`Unrecognized metadata '${e.tag.tag.text}', expected one of: ${t}`,severity:Tt.Error,start:e.tag.start,end:e.tag.end})}}return l.value}Ci(t){if(this.Bi.barIndex<t.bars.length){return t.bars[this.Bi.barIndex]}const e=0===t.bars.length?this.Bi.voiceIndex+1:t.bars[0].voices.length,s=new Q;t.addBar(s),s.previousBar&&(s.clef=s.previousBar.clef,s.clefOttava=s.previousBar.clefOttava,s.keySignature=s.previousBar.keySignature,s.keySignatureType=s.previousBar.keySignatureType),this.Bi.barIndex=s.index,s.index>0&&(s.clef=s.previousBar.clef);for(let t=0;t<e;t++){const t=new rt;s.addVoice(t)}if(this.Bi.currentStaff.bars.length>this.Bi.score.masterBars.length){const t=new tt;this.Bi.score.addMasterBar(t),t.index>0&&(t.timeSignatureDenominator=t.previousMasterBar.timeSignatureDenominator,t.timeSignatureNumerator=t.previousMasterBar.timeSignatureNumerator,t.tripletFeel=t.previousMasterBar.tripletFeel)}return s}startNewStaff(){if(this.Bi.ignoredInitialVoice=!1,this.Bi.ignoredInitialStaff||this.Bi.currentTrack.staves[0].bars.length>0){const t=this.Bi.currentStaff.isPercussion;this.Bi.currentTrack.ensureStaveCount(this.Bi.currentTrack.staves.length+1);const e=this.Bi.currentTrack.staves[this.Bi.currentTrack.staves.length-1];this.xi(e),t&&this.applyPercussionStaff(this.Bi.currentStaff),this.Bi.currentDynamics=i.F}else this.Bi.ignoredInitialStaff=!0;return this.Bi.currentStaff}applyPercussionStaff(t){t.isPercussion=!0,t.showTablature=!1,t.track.playbackInfo.program=0}startNewTrack(){return this.Bi.ignoredInitialVoice=!1,this.Bi.ignoredInitialStaff=!1,this.Bi.ignoredInitialTrack||this.Bi.score.masterBars.length>0?this.Ti():this.Bi.ignoredInitialTrack=!0,this.Bi.currentTrack}startNewVoice(){let t=0===this.Bi.voiceIndex&&!this.Bi.ignoredInitialVoice;if(t)if(0===this.Bi.currentStaff.bars.length)t=!0;else switch(this.Bi.voiceMode){case vt.StaffWise:t=1===this.Bi.currentStaff.bars.length&&this.Bi.currentStaff.bars[0].isEmpty;break;case vt.BarWise:if(this.Bi.barIndex<this.Bi.currentStaff.bars.length){t=this.Bi.currentStaff.bars[this.Bi.barIndex].voices[0].isEmpty}else t=!0}if(t)this.Bi.ignoredInitialVoice=!0;else{switch(this.Bi.voiceMode){case vt.StaffWise:this.Bi.voiceIndex++,this.Bi.barIndex=0,this.Bi.currentTupletDenominator=-1,this.Bi.currentTupletNumerator=-1;break;case vt.BarWise:this.Bi.voiceIndex++,this.Bi.currentTupletDenominator=-1,this.Bi.currentTupletNumerator=-1}for(const t of this.Bi.currentStaff.bars)for(;t.voices.length<=this.Bi.voiceIndex;)t.addVoice(new rt)}}}let We=class{};class Oe extends We{n;constructor(t){super(),this.n=t}}class Re extends We{left;right;constructor(t,e){super(),this.left=t,this.right=e}}class Ie extends We{n;table;constructor(t,e){super(),this.n=t,this.table=e}}class Ge{static make(t,e,s,i){const n=[],r=[];if(i>32)throw new ye("Invalid huffman");for(let t=0;t<i;t++)n.push(0),r.push(0);for(let r=0;r<s;r++){const s=t[r+e];if(s>=i)throw new ye("Invalid huffman");n[s]++}let a=0;for(let t=1;t<i-1;t++)a=a+n[t]<<1,r[t]=a;const h=new Map;for(let i=0;i<s;i++){const s=t[i+e];if(0!==s){const t=r[s-1];r[s-1]=t+1,h.set(t<<5|s,i)}}return Ge.Li(new Re(Ge.Wi(h,i,0,1),Ge.Wi(h,i,1,1)))}static Wi(t,e,s,i){if(i>e)throw new ye("Invalid huffman");const n=s<<5|i;return t.has(n)?new Oe(t.get(n)):(s<<=1,i+=1,new Re(Ge.Wi(t,e,s,i),Ge.Wi(t,e,1|s,i)))}static Li(t){const e=Ge.Oi(t);if(0===e)return t;if(1===e){if(t instanceof Re)return new Re(Ge.Li(t.left),Ge.Li(t.right));throw new ye("assert")}const s=1<<e,i=[];for(let t=0;t<s;t++)i.push(new Oe(-1));return Ge.Ri(i,0,0,e,t),new Ie(e,i)}static Ri(t,e,s,i,n){n instanceof Re&&i>0?(Ge.Ri(t,e,s+1,i-1,n.left),Ge.Ri(t,e|1<<s,s+1,i-1,n.right)):t[e]=Ge.Li(n)}static Oi(t){if(t instanceof Oe)return 0;if(t instanceof Ie)throw new ye("assert");if(t instanceof Re){const e=Ge.Oi(t.left),s=Ge.Oi(t.right);return 1+(e<s?e:s)}return 0}}var He,Ve,$e,Ue,ze,Xe,je,Je,qe,Ye,Ke,Qe,Ze,ts,es,ss,is,ns,rs,as,hs,os,cs,ls,us,ds,fs,ps,bs,ms;!function(t){t[t.Head=0]="Head",t[t.Block=1]="Block",t[t.CData=2]="CData",t[t.Flat=3]="Flat",t[t.Crc=4]="Crc",t[t.Dist=5]="Dist",t[t.DistOne=6]="DistOne",t[t.Done=7]="Done"}(He||(He={}));class gs{static Gi=32768;static Hi=65536;buffer=new Uint8Array(gs.Hi);pos=0;slide(){const t=new Uint8Array(gs.Hi);this.pos-=gs.Gi,t.set(this.buffer.subarray(gs.Gi,gs.Gi+this.pos),0),this.buffer=t}addBytes(t,e,s){this.pos+s>gs.Hi&&this.slide(),this.buffer.set(t.subarray(e,e+s),this.pos),this.pos+=s}addByte(t){this.pos===gs.Hi&&this.slide(),this.buffer[this.pos]=t,this.pos++}getLastChar(){return this.buffer[this.pos-1]}available(){return this.pos}}class ws{static Vi=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,-1,-1];static $i=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258];static Ui=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,-1,-1];static zi=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577];static Xi=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];static ji=ws.Ji();static Ji(){const t=[];for(let e=0;e<288;e++)t.push(e<=143?8:e<=255?9:e<=279?7:8);return Ge.make(t,0,288,10)}qi=0;Yi=0;Bi=He.Block;Ki=!1;Qi=ws.ji;Zi=null;tn=0;en=0;sn=0;nn=null;rn=0;an;hn=[];cn=new gs;constructor(t){this.an=t;for(let t=0;t<19;t++)this.hn.push(-1)}readBytes(t,e,s){if(this.sn=s,this.rn=e,this.nn=t,s>0)for(;this.ln(););return s-this.sn}ln(){switch(this.Bi){case He.Head:const t=this.an.readByte();if(8!==(15&t))throw new ye("Invalid data");const e=this.an.readByte(),s=!!(32&e);if(((t<<8)+e)%31!=0)throw new ye("Invalid data");if(s)throw new ye("Unsupported dictionary");return this.Bi=He.Block,!0;case He.Crc:return this.Bi=He.Done,!0;case He.Done:return!1;case He.Block:switch(this.Ki=this.un(),this.dn(2)){case 0:this.tn=de.readUInt16LE(this.an);if(de.readUInt16LE(this.an)!==65535-this.tn)throw new ye("Invalid data");this.Bi=He.Flat;const t=this.ln();return this.pn(),t;case 1:return this.Qi=ws.ji,this.Zi=null,this.Bi=He.CData,!0;case 2:const e=this.dn(5)+257,s=this.dn(5)+1,i=this.dn(4)+4;for(let t=0;t<i;t++)this.hn[ws.Xi[t]]=this.dn(3);for(let t=i;t<19;t++)this.hn[ws.Xi[t]]=0;this.Qi=Ge.make(this.hn,0,19,8);const n=[];for(let t=0;t<e+s;t++)n.push(0);return this.bn(n,e+s),this.Zi=Ge.make(n,e,s,16),this.Qi=Ge.make(n,0,e,16),this.Bi=He.CData,!0;default:throw new ye("Invalid data")}case He.Flat:{const t=this.tn<this.sn?this.tn:this.sn,e=de.readByteArray(this.an,t);return this.tn-=t,this.mn(e,0,t),0===this.tn&&(this.Bi=this.Ki?He.Crc:He.Block),this.sn>0}case He.DistOne:{const t=this.tn<this.sn?this.tn:this.sn;return this.gn(t),this.tn-=t,0===this.tn&&(this.Bi=He.CData),this.sn>0}case He.Dist:for(;this.tn>0&&this.sn>0;){const t=this.tn<this.en?this.tn:this.en,e=this.sn<t?this.sn:t;this.wn(this.en,e),this.tn-=e}return 0===this.tn&&(this.Bi=He.CData),this.sn>0;case He.CData:let i=this.yn(this.Qi);if(i<256)return this.kn(i),this.sn>0;if(256===i)return this.Bi=this.Ki?He.Crc:He.Block,!0;i=i-257&255;let n=ws.Vi[i];if(-1===n)throw new ye("Invalid data");this.tn=ws.$i[i]+this.dn(n);const r=this.Zi,a=r?this.yn(r):this.Sn(5);if(n=ws.Ui[a],-1===n)throw new ye("Invalid data");if(this.en=ws.zi[a]+this.dn(n),this.en>this.cn.available())throw new ye("Invalid data");return this.Bi=1===this.en?He.DistOne:He.Dist,!0}return!1}gn(t){const e=this.cn.getLastChar();for(let s=0;s<t;s++)this.kn(e)}kn(t){this.cn.addByte(t),this.nn[this.rn]=t,this.sn--,this.rn++}wn(t,e){this.mn(this.cn.buffer,this.cn.pos-t,e)}un(){0===this.qi&&(this.qi=8,this.Yi=this.an.readByte());const t=!(1&~this.Yi);return this.qi--,this.Yi=this.Yi>>1,t}dn(t){for(;this.qi<t;)this.Yi=this.Yi|this.an.readByte()<<this.qi,this.qi+=8;const e=this.Yi&(1<<t)-1;return this.qi-=t,this.Yi=this.Yi>>t,e}Sn(t){return 0===t?0:this.un()?1<<t-1|this.Sn(t-1):this.Sn(t-1)}pn(){this.Yi=0,this.qi=0}mn(t,e,s){this.cn.addBytes(t,e,s),this.nn.set(t.subarray(e,e+s),this.rn),this.sn-=s,this.rn+=s}bn(t,e){let s=0,i=0;for(;s<e;){const n=this.yn(this.Qi);switch(n){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:case 8:case 9:case 10:case 11:case 12:case 13:case 14:case 15:i=n,t[s]=n,s++;break;case 16:const r=s+3+this.dn(2);if(r>e)throw new ye("Invalid data");for(;s<r;)t[s]=i,s++;break;case 17:if(s+=3+this.dn(3),s>e)throw new ye("Invalid data");break;case 18:if(s+=11+this.dn(7),s>e)throw new ye("Invalid data");break;default:throw new ye("Invalid data")}}}yn(t){if(t instanceof Oe)return t.n;if(t instanceof Re)return this.yn(this.un()?t.right:t.left);if(t instanceof Ie)return this.yn(t.table[this.dn(t.n)]);throw new ye("Invalid data")}}class ys{static OptionalDataDescriptorSignature=134695760;static CompressionMethodDeflate=8;static LocalFileHeaderSignature=67324752;static CentralFileHeaderSignature=33639248;static EndOfCentralDirSignature=101010256;fullName;fileName;data;constructor(t,e){this.fullName=t;const s=t.lastIndexOf("/");this.fileName=-1===s||s===t.length-1?this.fullName:t.substr(s+1),this.data=e}}class ks{Bn;constructor(t){this.Bn=t}read(){const t=[];for(;;){const e=this._n();if(!e)break;t.push(e)}return t}_n(){const t=this.Bn;if(de.readInt32LE(t)!==ys.LocalFileHeaderSignature)return null;de.readUInt16LE(t);const e=de.readUInt16LE(t),s=de.readUInt16LE(t),i=0!==s;if(i&&s!==ys.CompressionMethodDeflate)return null;de.readInt16LE(this.Bn),de.readInt16LE(this.Bn),de.readInt32LE(t),de.readInt32LE(t);const n=de.readInt32LE(t),r=de.readInt16LE(t),a=de.readInt16LE(t),h=de.toString(de.readByteArray(t,r),"utf-8");let o;if(t.skip(a),i){const t=Fe.empty(),e=new ws(this.Bn),s=new Uint8Array(65536);for(;;){const i=e.readBytes(s,0,s.length);if(t.write(s,0,i),i<s.length)break}o=t.toArray()}else o=de.readByteArray(this.Bn,n);if(8&e){de.readInt32LE(this.Bn)===ys.OptionalDataDescriptorSignature&&de.readInt32LE(this.Bn),de.readInt32LE(this.Bn),de.readInt32LE(this.Bn)}return new ys(h,o)}}!function(t){t[t.None=0]="None",t[t.Element=1]="Element",t[t.Text=2]="Text",t[t.CDATA=3]="CDATA",t[t.Document=4]="Document",t[t.DocumentType=5]="DocumentType",t[t.Comment=6]="Comment"}(Ve||(Ve={}));class Ss{nodeType=Ve.None;localName=null;value=null;childNodes=[];attributes=new Map;firstChild=null;firstElement=null;*childElements(){for(const t of this.childNodes)t.nodeType===Ve.Element&&(yield t)}addChild(t){this.childNodes.push(t),this.firstChild=t,t.nodeType!==Ve.Element&&t.nodeType!==Ve.CDATA||(this.firstElement=t)}getAttribute(t,e=""){return this.attributes.has(t)?this.attributes.get(t):e}getElementsByTagName(t,e=!1){const s=[];return this.Tn(this.childNodes,s,t,e),s}Tn(t,e,s,i=!1){for(const n of t)n&&n.nodeType===Ve.Element&&n.localName===s&&e.push(n),i&&this.Tn(n.childNodes,e,s,!0)}findChildElement(t){for(const e of this.childNodes)if(e&&e.nodeType===Ve.Element&&e.localName===t)return e;return null}addElement(t){const e=new Ss;return e.nodeType=Ve.Element,e.localName=t,this.addChild(e),e}get innerText(){if(this.nodeType===Ve.Element||this.nodeType===Ve.Document){if(this.firstElement&&this.firstElement.nodeType===Ve.CDATA)return this.firstElement.innerText;let t="";for(const e of this.childNodes)t+=e.innerText?.toString();return t.trim()}return this.value??""}set innerText(t){const e=new Ss;e.nodeType=Ve.Text,e.value=t,this.childNodes=[e]}setCData(t){const e=new Ss;e.nodeType=Ve.CDATA,e.value=t,this.childNodes=[e]}}class Bs extends I{xml;pos=0;constructor(t,e,i){super(s.Format,t),this.xml=e,this.pos=i}}!function(t){t[t.IgnoreSpaces=0]="IgnoreSpaces",t[t.Begin=1]="Begin",t[t.BeginNode=2]="BeginNode",t[t.TagName=3]="TagName",t[t.Body=4]="Body",t[t.AttribName=5]="AttribName",t[t.Equals=6]="Equals",t[t.AttvalBegin=7]="AttvalBegin",t[t.AttribVal=8]="AttribVal",t[t.Childs=9]="Childs",t[t.Close=10]="Close",t[t.WaitEnd=11]="WaitEnd",t[t.WaitEndRet=12]="WaitEndRet",t[t.Pcdata=13]="Pcdata",t[t.Header=14]="Header",t[t.Comment=15]="Comment",t[t.Doctype=16]="Doctype",t[t.Cdata=17]="Cdata",t[t.Escape=18]="Escape"}($e||($e={}));class _s{static CharCodeLF=10;static CharCodeTab=9;static CharCodeCR=13;static CharCodeSpace=32;static CharCodeLowerThan=60;static CharCodeAmp=38;static CharCodeBrackedClose=93;static CharCodeBrackedOpen=91;static CharCodeGreaterThan=62;static CharCodeExclamation=33;static CharCodeUpperD=68;static CharCodeLowerD=100;static CharCodeMinus=45;static CharCodeQuestion=63;static CharCodeSlash=47;static CharCodeEquals=61;static CharCodeDoubleQuote=34;static CharCodeSingleQuote=39;static CharCodeSharp=35;static CharCodeLowerX=120;static CharCodeLowerA=97;static CharCodeLowerZ=122;static CharCodeUpperA=65;static CharCodeUpperZ=90;static CharCode0=48;static CharCode9=57;static CharCodeColon=58;static CharCodeDot=46;static CharCodeUnderscore=95;static CharCodeSemi=59;static xn=new Map([["lt","<"],["gt",">"],["amp","&"],["quot",'"'],["apos","'"]]);static parse(t,e,s){let i=t.charCodeAt(e),n=$e.Begin,r=$e.Begin,a=0,h="",o=$e.Begin,c=null,l=null,u=0,d=0;for(;e<t.length;){switch(i=t.charCodeAt(e),n){case $e.IgnoreSpaces:switch(i){case _s.CharCodeLF:case _s.CharCodeCR:case _s.CharCodeTab:case _s.CharCodeSpace:break;default:n=r;continue}break;case $e.Begin:if(i!==_s.CharCodeLowerThan){a=e,n=$e.Pcdata;continue}n=$e.IgnoreSpaces,r=$e.BeginNode;break;case $e.Pcdata:if(i===_s.CharCodeLowerThan){h+=t.substr(a,e-a);const i=new Ss;i.nodeType=Ve.Text,i.value=h,h="",s.addChild(i),n=$e.IgnoreSpaces,r=$e.BeginNode}else i===_s.CharCodeAmp&&(h+=t.substr(a,e-a),n=$e.Escape,o=$e.Pcdata,a=e+1);break;case $e.Cdata:if(i===_s.CharCodeBrackedClose&&t.charCodeAt(e+1)===_s.CharCodeBrackedClose&&t.charCodeAt(e+2)===_s.CharCodeGreaterThan){const i=new Ss;i.nodeType=Ve.CDATA,i.value=t.substr(a,e-a),s.addChild(i),e+=2,n=$e.Begin}break;case $e.BeginNode:switch(i){case _s.CharCodeExclamation:if(t.charCodeAt(e+1)===_s.CharCodeBrackedOpen){if(e+=2,"CDATA["!==t.substr(e,6).toUpperCase())throw new Bs("Expected <![CDATA[",t,e);e+=5,n=$e.Cdata,a=e+1}else if(t.charCodeAt(e+1)===_s.CharCodeUpperD||t.charCodeAt(e+1)===_s.CharCodeLowerD){if("OCTYPE"!==t.substr(e+2,6).toUpperCase())throw new Bs("Expected <!DOCTYPE",t,e);e+=8,n=$e.Doctype,a=e+1}else{if(t.charCodeAt(e+1)!==_s.CharCodeMinus||t.charCodeAt(e+2)!==_s.CharCodeMinus)throw new Bs("Expected \x3c!--",t,e);e+=2,n=$e.Comment,a=e+1}break;case _s.CharCodeQuestion:n=$e.Header,a=e;break;case _s.CharCodeSlash:if(!s)throw new Bs("Expected node name",t,e);a=e+1,n=$e.IgnoreSpaces,r=$e.Close;break;default:n=$e.TagName,a=e;continue}break;case $e.TagName:if(!_s.Mn(i)){if(e===a)throw new Bs("Expected node name",t,e);c=new Ss,c.nodeType=Ve.Element,c.localName=t.substr(a,e-a),s.addChild(c),n=$e.IgnoreSpaces,r=$e.Body;continue}break;case $e.Body:switch(i){case _s.CharCodeSlash:n=$e.WaitEnd;break;case _s.CharCodeGreaterThan:n=$e.Childs;break;default:n=$e.AttribName,a=e;continue}break;case $e.AttribName:if(!_s.Mn(i)){if(a===e)throw new Bs("Expected attribute name",t,e);if(l=t.substr(a,e-a),c.attributes.has(l))throw new Bs(`Duplicate attribute [${l}]`,t,e);n=$e.IgnoreSpaces,r=$e.Equals;continue}break;case $e.Equals:if(i!==_s.CharCodeEquals)throw new Bs("Expected =",t,e);n=$e.IgnoreSpaces,r=$e.AttvalBegin;break;case $e.AttvalBegin:switch(i){case _s.CharCodeDoubleQuote:case _s.CharCodeSingleQuote:h="",n=$e.AttribVal,a=e+1,d=i}break;case $e.AttribVal:if(i===_s.CharCodeAmp)h+=t.substr(a,e-a),n=$e.Escape,o=$e.AttribVal,a=e+1;else if(i===d){h+=t.substr(a,e-a);const s=h;h="",c.attributes.set(l,s),n=$e.IgnoreSpaces,r=$e.Body}break;case $e.Childs:a=e=_s.parse(t,e,c),n=$e.Begin;break;case $e.WaitEnd:if(i!==_s.CharCodeGreaterThan)throw new Bs("Expected >",t,e);n=$e.Begin;break;case $e.WaitEndRet:if(i===_s.CharCodeGreaterThan)return e;throw new Bs("Expected >",t,e);case $e.Close:if(!_s.Mn(i)){if(a===e)throw new Bs("Expected node name",t,e);if(t.substr(a,e-a)!==s.localName)throw new Bs(`Expected </${s.localName}>`,t,e);n=$e.IgnoreSpaces,r=$e.WaitEndRet;continue}break;case $e.Comment:i===_s.CharCodeMinus&&t.charCodeAt(e+1)===_s.CharCodeMinus&&t.charCodeAt(e+2)===_s.CharCodeGreaterThan&&(e+=2,n=$e.Begin);break;case $e.Doctype:if(i===_s.CharCodeBrackedOpen)u++;else if(i===_s.CharCodeBrackedClose)u--;else if(i===_s.CharCodeGreaterThan&&0===u){const i=new Ss;i.nodeType=Ve.DocumentType,i.value=t.substr(a,e-a),s.addChild(i),n=$e.Begin}break;case $e.Header:i===_s.CharCodeQuestion&&t.charCodeAt(e+1)===_s.CharCodeGreaterThan&&(e++,n=$e.Begin);break;case $e.Escape:if(i===_s.CharCodeSemi){const s=t.substr(a,e-a);if(s.charCodeAt(0)===_s.CharCodeSharp){const t=s.charCodeAt(1)===_s.CharCodeLowerX?Number.parseInt(`0${s.substr(1,s.length-1)}`,10):Number.parseInt(s.substr(1,s.length-1),10);h+=String.fromCharCode(t)}else _s.xn.has(s)?h+=_s.xn.get(s):h+=`&${s};`?.toString();a=e+1,n=o}else _s.Mn(i)||i===_s.CharCodeSharp||(h+="&",h+=t.substr(a,e-a),a=--e+1,n=o)}e++}if(n===$e.Begin&&(a=e,n=$e.Pcdata),n===$e.Pcdata){if(e!==a){h+=t.substr(a,e-a);const i=new Ss;i.nodeType=Ve.Text,i.value=h,s.addChild(i)}return e}if(n===$e.Escape&&o===$e.Pcdata){h+="&",h+=t.substr(a,e-a);const i=new Ss;return i.nodeType=Ve.Text,i.value=h,s.addChild(i),e}throw new Bs("Unexpected end",t,e)}static Mn(t){return t>=_s.CharCodeLowerA&&t<=_s.CharCodeLowerZ||t>=_s.CharCodeUpperA&&t<=_s.CharCodeUpperZ||t>=_s.CharCode0&&t<=_s.CharCode9||t===_s.CharCodeColon||t===_s.CharCodeDot||t===_s.CharCodeUnderscore||t===_s.CharCodeMinus}}class Ts{vn=[];Nn;Pn;Cn;En;constructor(t,e){this.Nn=t,this.Pn=e,this.En="",this.Cn=!0}writeNode(t){switch(t.nodeType){case Ve.None:break;case Ve.Element:this.vn.length>0&&this.Fn(),this.An(`<${t.localName}`);for(const[e,s]of t.attributes)this.An(` ${e}="`),this.Dn(s),this.An('"');if(0===t.childNodes.length)this.An("/>");else{if(this.An(">"),1!==t.childNodes.length||t.firstElement){this.Ln();for(const e of t.childNodes)e.nodeType!==Ve.Element&&e.nodeType!==Ve.Comment||this.writeNode(e);this.Wn(),this.Fn()}else this.writeNode(t.childNodes[0]);this.An(`</${t.localName}>`)}break;case Ve.Text:t.value&&this.An(t.value);break;case Ve.CDATA:null!==t.value&&this.An(`<![CDATA[${t.value}]]>`);break;case Ve.Document:this.Pn&&this.An('<?xml version="1.0" encoding="utf-8"?>');for(const e of t.childNodes)this.writeNode(e);break;case Ve.DocumentType:this.An(`<!DOCTYPE ${t.value}>`);break;case Ve.Comment:this.An(`\x3c!-- ${t.value} --\x3e`)}}Wn(){this.En=this.En.substr(0,this.En.length-this.Nn.length)}Ln(){this.En+=this.Nn}Dn(t){for(let e=0;e<t.length;e++){const s=t.charAt(e);switch(s){case"<":this.vn.push("&lt;");break;case">":this.vn.push("&gt;");break;case"&":this.vn.push("&amp;");break;case"'":this.vn.push("&apos;");break;case'"':this.vn.push("&quot;");break;default:this.vn.push(s)}}}static write(t,e,s){const i=new Ts(e,s);return i.writeNode(t),i.toString()}An(t){this.Cn&&this.vn.push(this.En),this.vn.push(t),this.Cn=!1}Fn(t=null){t&&this.An(t),this.Nn.length>0&&!this.Cn&&(this.vn.push("\n"),this.Cn=!0)}toString(){return this.vn.join("").trimRight()}}class xs extends Ss{constructor(){super(),this.nodeType=Ve.Document}parse(t){_s.parse(t,0,this)}toString(){return this.toFormattedString()}toFormattedString(t="",e=!1){return Ts.write(this,t,e)}}class Ms{noteRange=1;x=0;y=0}!function(t){t[t.None=0]="None",t[t.Rectangle=1]="Rectangle",t[t.Ellipse=2]="Ellipse",t[t.Circle=3]="Circle"}(Ue||(Ue={}));class vs extends Ms{align=at.Left;frame=Ue.None;text="";fontFace="";weight=0;height=0}class Ns extends Ms{chord=new we}class Ps extends Ms{}class Cs extends Ms{}class Es extends Ms{number=0}class Fs extends Ms{decrescendo=!1}class As extends Ms{allNumbers=!1;firstNumber=0;lastNumber=0}class Ds extends Ms{octave=1}class Ls extends Ms{}class Ws{defaultClef=x.G2;description="";percussion=!1;instrument=0;volume=0;transpose=0;index=0}class Os{from=0;to=0;curly=!1}class Rs{currentBarIndex=-1;currentBarComplete=!0;currentBarDuration=0;currentPosition=0;voiceStemDir=null;repeatCount=0;repeatEnd=null}class Is{score;On=0;Rn=St.Auto;In;Gn;Hn=!0;Vn=-1;parseXml(t,e){this.In=new Map,this.$n=[],this.Un=new Map,this.Gn=new Map,this.zn=new Map,this.Xn=new Map,this.Hn=!0;const s=new xs;try{s.parse(t)}catch(t){throw new Ee("Could not parse XML",t)}this.jn(s),this.Jn(),this.score.finish(e)}Jn(){zt.consolidate(this.score),Is.qn(this.zn,(t,e)=>{e.isLegatoOrigin=!0}),Is.qn(this.Xn,(t,e)=>{e.crescendo=t.decrescendo?o.Decrescendo:o.Crescendo})}static qn(t,e){for(const[s,i]of t){const t=i.noteRange;let n=s;for(let s=0;s<t;s++)if(e(i,n),n.index+1<n.voice.beats.length)n=n.voice.beats[n.index+1];else{if(!(n.voice.bar.index+1<n.voice.bar.staff.bars.length))break;n=n.voice.bar.staff.bars[n.voice.bar.index+1].voices[n.voice.index].beats[0]}}}jn(t){const e=t.firstElement;if(!e)throw new Ee("No valid XML");if("score"!==e.localName)throw new Ee('Root node of XML was not "score"');this.score=new Ht;for(const t of e.childElements())switch(t.localName){case"info":this.Yn(t);break;case"layout":this.Kn(t);break;case"gallery":this.Qn(t);break;case"pageObjects":this.Zn(t);break;case"systems":this.tr(t)}}er=new Map;Kn(t){for(const e of t.childElements())switch(e.localName){case"staves":this.sr(e);break;case"brackets":this.ir(e)}const e=this.nr.filter(t=>!!t.curly);e.sort((t,e)=>t.from-e.from);let s=0,i=null;for(let t=0;t<this.rr.length;t++){const n=this.rr[t];for(;s<e.length&&t>e[s].to;)s++;i&&s<e.length&&t>e[s].from&&t<=e[s].to?i.ensureStaveCount(i.staves.length+1):(i=new Ne,i.ensureStaveCount(1),i.name=n.description,i.playbackInfo.volume=Math.floor(n.volume/128*16),i.playbackInfo.program=n.instrument,n.percussion?(i.playbackInfo.primaryChannel=9,i.playbackInfo.secondaryChannel=9):(i.playbackInfo.primaryChannel=this.On++,i.playbackInfo.secondaryChannel=this.On++),this.score.addTrack(i));const r=i.staves[i.staves.length-1];r.isPercussion=n.percussion,r.transpositionPitch=n.transpose,r.displayTranspositionPitch=0,r.showTablature=!1,this.er.set(n.index,r)}}nr=[];ir(t){for(const e of t.childElements())if("bracket"===e.localName)this.ar(e)}ar(t){const e=new Os;e.from=Number.parseInt(t.getAttribute("from"),10),e.to=Number.parseInt(t.getAttribute("to"),10),t.attributes.has("curly")&&(e.curly="true"===t.attributes.get("curly")),this.nr.push(e)}sr(t){for(const e of t.childElements())if("staffLayout"===e.localName)this.hr(e)}cr=new Map;rr=[];hr(t){const e=new Ws;e.description=t.getAttribute("description");for(const s of t.childElements())switch(s.localName){case"notation":s.attributes.has("defaultClef")&&(e.defaultClef=this.lr(s.attributes.get("defaultClef")));break;case"sound":s.attributes.has("percussion")&&(e.percussion="true"===s.attributes.get("percussion")),s.attributes.has("instr")&&(e.instrument=Number.parseInt(s.attributes.get("instr"),10)),s.attributes.has("volume")&&(e.volume=Number.parseInt(s.attributes.get("volume"),10)),s.attributes.has("transpose")&&(e.transpose=Number.parseInt(s.attributes.get("transpose"),10))}this.cr.set(e.description,e),e.index=this.rr.length,this.rr.push(e)}lr(t){switch(t){case"treble":return x.G2;case"bass":return x.F4;case"alto":case"tenor":return x.C4}return x.G2}ur(t){return t.endsWith("-")?b.T:t.endsWith("+")?b._:b.Regular}tr(t){for(const e of t.childElements())if("system"===e.localName)this.dr(e)}dr(t){t.attributes.has("tempo")&&0===this.score.masterBars.length&&(this.Vn=Number.parseInt(t.attributes.get("tempo"),10)),"0"===t.getAttribute("beamGrouping")&&(this.Rn=St.ForceSplitToNext);for(const e of t.childElements())if("staves"===e.localName)this.pr(t,e);this.Hn=!1}pr(t,e){const s=this.score.masterBars.length;for(const i of e.childElements())if("staff"===i.localName)this.br(t,s,i)}mr=new tt;gr;br(t,e,s){const i=s.getAttribute("layout");this.gr=this.cr.get(i),this.mr.timeSignatureNumerator=4,this.mr.timeSignatureDenominator=4,this.mr.timeSignatureCommon=!1,this.wr(s.getAttribute("defaultTime"));const n=this.er.get(this.gr.index);for(;n.bars.length<e;)this.yr(n);for(const r of s.childElements())if("voices"===r.localName)this.kr(i,n,t,e,r)}wr(t){switch(t){case"allaBreve":case"C":this.mr.timeSignatureNumerator=2,this.mr.timeSignatureDenominator=2,this.mr.timeSignatureCommon=!0;break;case"longAllaBreve":this.mr.timeSignatureNumerator=4,this.mr.timeSignatureDenominator=4,this.mr.timeSignatureCommon=!0;break;default:if(t.indexOf("/")>0){const e=t.split("/");this.mr.timeSignatureNumerator=Number.parseInt(e[0],10),this.mr.timeSignatureDenominator=Number.parseInt(e[1],10),this.mr.timeSignatureCommon=!1}}}kr(t,e,s,i,n){let r=0;for(const a of n.childElements())if("voice"===a.localName)this.Sr(t,e,s,r,i,a),r++}Br(t,e){return e<t.bars.length?t.bars[e]:this.yr(t)}yr(t){const e=new Q;if(t.bars.length>0?(e.clef=t.bars[t.bars.length-1].clef,e.clefOttava=t.bars[t.bars.length-1].clefOttava,e.keySignature=t.bars[t.bars.length-1].keySignature,e.keySignatureType=t.bars[t.bars.length-1].keySignatureType):e.clef=this.gr.defaultClef,t.addBar(e),t.bars.length>this.score.masterBars.length){const t=new tt;this.score.addMasterBar(t),t.index>0?t.tripletFeel=t.previousMasterBar.tripletFeel:this.Vn>0&&t.tempoAutomations.push($.buildTempoAutomation(!1,0,this.Vn,0)),t.timeSignatureDenominator=this.mr.timeSignatureDenominator,t.timeSignatureNumerator=this.mr.timeSignatureNumerator,t.timeSignatureCommon=this.mr.timeSignatureCommon}return e}_r=new Map;Tr;Mr;vr;Nr(t,e){this.Tr.currentBarIndex++,this.Mr=this.Br(t,this.Tr.currentBarIndex),this.Tr.currentBarDuration=this.Mr.masterBar.calculateDuration(!1),this.Tr.currentBarComplete=!1,this.Tr.currentPosition=0,this.Pr(t,e)}Sr(t,e,s,i,r,a){const h=`${t}_${i}`;if(this.Tr&&!this.Tr.currentBarComplete&&(this.Mr.masterBar.isAnacrusis=!0),this._r.has(h)?(this.Tr=this._r.get(h),this.Mr=this.Br(e,this.Tr.currentBarIndex),this.Pr(e,i)):(this.Tr=new Rs,this.Tr.currentBarIndex=r-1,this._r.set(h,this.Tr),this.Nr(e,i)),a.attributes.has("stemDir"))switch(a.attributes.get("stemDir")){case"up":this.Tr.voiceStemDir=Wt.Up;break;case"down":this.Tr.voiceStemDir=Wt.Down;break;default:this.Tr.voiceStemDir=null}else this.Tr.voiceStemDir=null;const o=a.findChildElement("noteObjects");if(s.attributes.has("tempo")){const t=new $;t.isLinear=!0,t.type=n.Tempo,t.value=Number.parseInt(s.attributes.get("tempo"),10),t.ratioPosition=this.Tr.currentPosition/this.Tr.currentBarDuration,this.Mr.masterBar.tempoAutomations.push(t)}if(o)for(const t of o.childElements())switch(this.Tr.currentBarComplete&&"barline"!==t.localName&&this.Nr(e,i),t.localName){case"clefSign":this.Mr.clef=this.lr(t.getAttribute("clef")),this.Mr.clefOttava=this.ur(t.getAttribute("clef"));break;case"keySign":this.Mr.keySignature=Number.parseInt(t.getAttribute("fifths"),10);break;case"timeSign":this.wr(t.getAttribute("time")),this.Mr.masterBar.timeSignatureDenominator=this.mr.timeSignatureDenominator,this.Mr.masterBar.timeSignatureNumerator=this.mr.timeSignatureNumerator,this.Mr.masterBar.timeSignatureCommon=this.mr.timeSignatureCommon,this.Tr.currentPosition=0,this.Tr.currentBarDuration=this.Mr.masterBar.calculateDuration(!1);break;case"barline":switch(t.getAttribute("type")){case"double":this.Mr.barLineRight=E.LightLight,this.Tr.currentBarComplete||(this.Mr.masterBar.isAnacrusis=!0),this.Tr.currentBarComplete=!0;break;case"end":this.Tr.currentBarComplete||(this.Mr.masterBar.isAnacrusis=!0);break;case"repEnd":this.Tr.repeatEnd=this.Mr.masterBar,this.Mr.masterBar.repeatCount<this.Tr.repeatCount&&(this.Mr.masterBar.repeatCount=this.Tr.repeatCount),this.Cr(t),this.Tr.currentBarComplete||(this.Mr.masterBar.isAnacrusis=!0),this.Tr.currentBarComplete=!0;break;case"repBegin":this.Nr(e,i),this.Mr.masterBar.isRepeatStart=!0,this.Tr.repeatEnd=null,this.Tr.repeatCount=0;break;case"repEndBegin":this.Tr.repeatEnd=this.Mr.masterBar,this.Mr.masterBar.repeatCount<this.Tr.repeatCount&&(this.Mr.masterBar.repeatCount=this.Tr.repeatCount),this.Cr(t),this.Nr(e,i),this.Mr.masterBar.isRepeatStart=!0;break;default:this.Tr.currentBarComplete||(this.Mr.masterBar.isAnacrusis=!0),this.Tr.currentBarComplete=!0}break;case"chord":const s=new ee;this.Er(s,this.vr),s.beamingMode=this.Rn,this.Tr.voiceStemDir&&(s.preferredBeamDirection=this.Tr.voiceStemDir),this.Fi(s,t.findChildElement("duration")),s.updateDurations(),this.Tr.currentPosition+=s.playbackDuration,this.vr.addBeat(s),this.Fr(s,t),this.Tr.currentPosition>=this.Tr.currentBarDuration&&(this.Tr.currentBarComplete=!0);break;case"rest":const n=this.Ar(t.findChildElement("duration"));n&&(this.Er(n,this.vr),n.updateDurations(),this.Tr.currentPosition+=n.playbackDuration,this.vr.addBeat(n),this.Tr.currentPosition>=this.Tr.currentBarDuration&&(this.Tr.currentBarComplete=!0))}}Er(t,e){const s=this.Dr(e);s&&(t.dynamics=s.dynamics)}Dr(t){if(t.beats.length>0)return t.beats[t.beats.length-1];if(t.bar.index>0){const e=t.bar.staff.bars[t.bar.index-1];if(t.index<e.voices.length){const s=e.voices[t.index];return this.Dr(s)}}return null}Pr(t,e){for(;this.Mr.voices.length<e+1;)this.Mr.addVoice(new rt);(!this.Gn.has(t.track.index)||this.Gn.get(t.track.index)<this.Mr.voices.length)&&this.Gn.set(t.track.index,this.Mr.voices.length),this.vr=this.Mr.voices[e]}Fr(t,e){const s=new Kt;for(const i of e.childElements())switch(i.localName){case"stem":switch(i.getAttribute("dir")){case"up":t.preferredBeamDirection=Wt.Up;break;case"down":t.preferredBeamDirection=Wt.Down}break;case"articulation":switch(i.getAttribute("type")){case"staccato":s.isStaccato=!0;break;case"normalAccent":s.accentuated=u.Normal;break;case"strongAccent":s.accentuated=u.Heavy}break;case"lyric":this.Lr(t,i);break;case"drawObjects":this.Wr(t,i);break;case"heads":this.Or(t,s,i);break;case"beam":switch(i.getAttribute("group")){case"force":t.beamingMode=St.ForceMergeWithNext;break;case"divide":t.beamingMode=St.ForceSplitToNext}}}Or(t,e,s){for(const i of s.childElements())if("head"===i.localName)this.Rr(t,e,i)}$n;Un;zn;Xn;Rr(t,e,s){const i=new Kt,n=zt.parseTuning(s.getAttribute("pitch"));i.octave=n.octave-1,i.tone=n.tone.noteValue,i.isStaccato=e.isStaccato,i.accentuated=e.accentuated,t.addNote(i);for(const t of s.childElements())switch(t.localName){case"alter":t.attributes.has("step")&&(i.tone+=Number.parseInt(t.attributes.get("step"),10));break;case"tie":t.attributes.has("begin")?this.Un.has(i.id)||(this.Un.set(i.id,!0),this.$n.push(i)):t.attributes.has("end")&&this.$n.length>0&&!i.isTieDestination&&(i.isTieDestination=!0,i.tieOrigin=this.$n[0],this.$n.splice(0,1),this.Un.delete(i.id))}}Wr(t,e){for(const s of e.childElements())if("drawObj"===s.localName){const e=this.Ir(s);if(e)if(e instanceof vs)e.fontFace.startsWith("capella")?"u"===e.text?(t.fermata=new Se,t.fermata.type=At.Medium):"f"===e.text?t.dynamics=i.F:"j"===e.text&&(t.dynamics=i.MF):this.Hn&&""===this.score.title&&e.align===at.Center&&e.height>16&&e.weight>400?this.score.title=e.text:this.Hn&&""===this.score.artist&&e.align===at.Center&&e.y<0?this.score.artist=e.text:this.Hn&&""===this.score.music&&e.align===at.Right&&e.y<0?this.score.music=e.text:e.text.startsWith("by capella")||(t.text=e.text);else if(e instanceof Ns);else if(e instanceof Cs)t.vibrato=w.Slight;else if(e instanceof Fs)t.crescendo=e.decrescendo?o.Decrescendo:o.Crescendo,e.noteRange++,this.Xn.set(t,e);else if(e instanceof Ps){const s=e;this.zn.set(t,s)}else e instanceof As&&this.Gr(e)}}Cr(t){for(const e of t.childElements())if("drawObj"===e.localName){const t=this.Ir(e);t&&t instanceof As&&this.Gr(t)}}Gr(t){if(t.lastNumber>0?(this.Tr.repeatCount=t.lastNumber,this.Tr.repeatEnd&&this.Tr.repeatEnd.repeatCount<this.Tr.repeatCount&&(this.Tr.repeatEnd.repeatCount=this.Tr.repeatCount)):t.firstNumber>0&&(this.Tr.repeatCount=t.firstNumber,this.Tr.repeatEnd&&this.Tr.repeatEnd.repeatCount<this.Tr.repeatCount&&(this.Tr.repeatEnd.repeatCount=this.Tr.repeatCount)),t.lastNumber>0&&t.firstNumber>0){let e=0;for(let s=t.firstNumber;s<=t.lastNumber;s++)e|=1<<s-1;this.Mr.masterBar.alternateEndings=e}else t.lastNumber>0?this.Mr.masterBar.alternateEndings=1<<t.lastNumber-1:t.firstNumber>0&&(this.Mr.masterBar.alternateEndings=1<<t.firstNumber-1)}Lr(t,e){for(const s of e.childElements())if("verse"===s.localName){t.lyrics||(t.lyrics=[]);let e=s.innerText;"true"===s.getAttribute("hyphen")&&(e+="-"),t.lyrics.push(e)}}Ar(t){const e=t.getAttribute("base");if(-1!==e.indexOf("/")){const e=new ee;return e.beamingMode=this.Rn,this.Fi(e,t),e}if(1===Number.parseInt(e,10)){const t=new ee;return t.beamingMode=this.Rn,t.duration=c.Whole,t}return J.warning("Importer","Multi-Bar rests are not supported"),null}Hr(t){switch(t){case"2/1":return c.DoubleWhole;case"1/1":return c.Whole;case"1/2":return c.Half;case"1/4":return c.Quarter;case"1/8":return c.Eighth;case"1/16":return c.Sixteenth;case"1/32":return c.ThirtySecond;case"1/64":return c.SixtyFourth;case"1/128":return c.OneHundredTwentyEighth;default:return J.warning("Importer","Unsupported duration"),c.Quarter}}Fi(t,e){const s=e.getAttribute("base");t.duration=this.Hr(s),e.attributes.has("dots")&&(t.dots=Number.parseInt(e.attributes.get("dots"),10));const i=e.findChildElement("tuplet");if(i){t.tupletNumerator=Number.parseInt(i.getAttribute("count"),10);const e="true"===i.getAttribute("tripartite")?3:1,s="true"===i.getAttribute("prolong")?0:1;let n=0;for(;e*Math.pow(2,n+s)<t.tupletNumerator;)n++;t.tupletDenominator=e*Math.pow(2,n)}}Zn(t){for(const e of t.childElements())if("drawObj"===e.localName){const t=this.Ir(e);if(t&&t instanceof vs)switch(t.align){case at.Center:this.score.title?this.score.subTitle||(this.score.subTitle=e.innerText):this.score.title=e.innerText;break;case at.Right:this.score.artist||(this.score.artist=e.innerText)}}}Qn(t){for(const e of t.childElements())if("drawObj"===e.localName){const t=this.Ir(e);t&&this.In.set(e.getAttribute("name"),t)}}Ir(t){let e=null,s=1;for(const i of t.childElements())switch(i.localName){case"text":e=this.Vr(i);break;case"guitar":e=this.$r(i);break;case"slur":e=this.Ur(i);break;case"wavyLine":e=this.zr(i);break;case"bracket":e=this.Xr(i);break;case"wedge":e=this.jr(i);break;case"volta":e=this.Jr(i);break;case"octaveClef":e=this.qr(i);break;case"trill":e=this.Yr(i);break;case"basic":i.attributes.has("noteRange")&&(s=Number.parseInt(i.attributes.get("noteRange"),10))}return e&&(e.noteRange=s),e}Yr(t){return new Ls}qr(t){const e=new Ds;return t.attributes.has("octave")&&(e.octave=Number.parseInt(t.attributes.get("octave"),10)),e}Jr(t){const e=new As;return e.allNumbers="true"===t.attributes.get("allNumbers"),t.attributes.has("firstNumber")&&(e.firstNumber=Number.parseInt(t.attributes.get("firstNumber"),10)),t.attributes.has("lastNumber")&&(e.lastNumber=Number.parseInt(t.attributes.get("lastNumber"),10)),e}jr(t){const e=new Fs;return e.decrescendo="true"===t.attributes.get("decrescendo"),e}Xr(t){const e=new Es;return t.attributes.has("number")&&(e.number=Number.parseInt(t.attributes.get("number"),10)),e}zr(t){return new Cs}Ur(t){return new Ps}$r(t){const e=new Ns,s=t.innerText.trim();for(let t=0;t<s.length;t++)"/"===s.charAt(t)?e.chord.strings.push(0):e.chord.strings.push(Number.parseInt(s.charAt(t),10));return e}Vr(t){const e=new vs;switch(t.attributes.has("x")&&(e.x=Number.parseFloat(t.attributes.get("x"))),t.attributes.has("x")&&(e.y=Number.parseFloat(t.attributes.get("y"))),t.getAttribute("align")){case"left":e.align=at.Left;break;case"center":e.align=at.Center;break;case"right":e.align=at.Right}switch(t.getAttribute("frame")){case"rectangle":e.frame=Ue.Rectangle;break;case"ellipse":e.frame=Ue.Ellipse;break;case"circle":e.frame=Ue.Circle;break;case"none":e.frame=Ue.None}if(t.firstElement)for(const s of t.childElements())switch(s.localName){case"font":e.fontFace=s.getAttribute("face"),s.attributes.has("weight")&&(e.weight=Number.parseInt(s.attributes.get("weight"),10)),s.attributes.has("height")&&(e.height=Number.parseInt(s.attributes.get("height"),10));break;case"content":e.text=s.innerText}else e.text=t.innerText;return e}Yn(t){for(const e of t.childElements())switch(e.localName){case"author":this.score.tab=e.firstChild.innerText;break;case"comment":this.score.notices=e.firstChild.innerText}}}class Gs extends Ce{get name(){return"Capella"}readScore(){J.debug(this.name,"Loading ZIP entries");let t,e=null;if(t=new ks(this.data).read(),J.debug(this.name,"Zip entries loaded"),t.length>0){for(const s of t)if("score.xml"===s.fileName)e=de.toString(s.data,this.settings.importer.encoding)}else this.data.reset(),e=de.toString(this.data.readAll(),this.settings.importer.encoding);if(!e)throw new Ee("No valid capella file");J.debug(this.name,"Start Parsing score.xml");try{const t=new Is;t.parseXml(e,this.settings),J.debug(this.name,"score.xml parsed");return t.score}catch(t){throw new Ee("Failed to parse CapXML",t)}}}!function(t){t[t.TargetFine=0]="TargetFine",t[t.TargetSegno=1]="TargetSegno",t[t.TargetSegnoSegno=2]="TargetSegnoSegno",t[t.TargetCoda=3]="TargetCoda",t[t.TargetDoubleCoda=4]="TargetDoubleCoda",t[t.JumpDaCapo=5]="JumpDaCapo",t[t.JumpDaCapoAlCoda=6]="JumpDaCapoAlCoda",t[t.JumpDaCapoAlDoubleCoda=7]="JumpDaCapoAlDoubleCoda",t[t.JumpDaCapoAlFine=8]="JumpDaCapoAlFine",t[t.JumpDalSegno=9]="JumpDalSegno",t[t.JumpDalSegnoAlCoda=10]="JumpDalSegnoAlCoda",t[t.JumpDalSegnoAlDoubleCoda=11]="JumpDalSegnoAlDoubleCoda",t[t.JumpDalSegnoAlFine=12]="JumpDalSegnoAlFine",t[t.JumpDalSegnoSegno=13]="JumpDalSegnoSegno",t[t.JumpDalSegnoSegnoAlCoda=14]="JumpDalSegnoSegnoAlCoda",t[t.JumpDalSegnoSegnoAlDoubleCoda=15]="JumpDalSegnoSegnoAlDoubleCoda",t[t.JumpDalSegnoSegnoAlFine=16]="JumpDalSegnoSegnoAlFine",t[t.JumpDaCoda=17]="JumpDaCoda",t[t.JumpDaDoubleCoda=18]="JumpDaDoubleCoda"}(ze||(ze={}));class Hs extends Ce{static Kr="FICHIER GUITAR PRO ";static Qr=new Map([[27,42],[28,60],[29,29],[30,30],[32,31]]);Zr=0;De;ta=F.NoTripletFeel;ea=0;sa=[];ia=0;na=0;ra=[];aa=new Set;ha=new Map;oa=new Map;ca=new Map;la=new Map;Vn;get name(){return"Guitar Pro 3-5"}readScore(){if(this.la.clear(),this.readVersion(),this.De=new Ht,this.readScoreInformation(),this.Zr<500&&(this.ta=Vs.gpReadBool(this.data)?F.Triplet8th:F.NoTripletFeel),this.Zr>=400&&this.readLyrics(),this.Zr>=510&&this.data.skip(19),this.Vn=$.buildTempoAutomation(!1,0,0,0),this.Zr>=500&&(this.readPageSetup(),this.Vn.text=Vs.gpReadStringIntByte(this.data,this.settings.importer.encoding)),this.Vn.value=de.readInt32LE(this.data),this.Zr>=510&&Vs.gpReadBool(this.data),de.readInt32LE(this.data),this.Zr>=400&&this.data.readByte(),this.readPlaybackInfos(),this.Zr>=500&&(this.ua(ze.TargetCoda),this.ua(ze.TargetDoubleCoda),this.ua(ze.TargetSegno),this.ua(ze.TargetSegnoSegno),this.ua(ze.TargetFine),this.ua(ze.JumpDaCapo),this.ua(ze.JumpDaCapoAlCoda),this.ua(ze.JumpDaCapoAlDoubleCoda),this.ua(ze.JumpDaCapoAlFine),this.ua(ze.JumpDalSegno),this.ua(ze.JumpDalSegnoAlCoda),this.ua(ze.JumpDalSegnoAlDoubleCoda),this.ua(ze.JumpDalSegnoAlFine),this.ua(ze.JumpDalSegnoSegno),this.ua(ze.JumpDalSegnoSegnoAlCoda),this.ua(ze.JumpDalSegnoSegnoAlDoubleCoda),this.ua(ze.JumpDalSegnoSegnoAlFine),this.ua(ze.JumpDaCoda),this.ua(ze.JumpDaDoubleCoda),this.data.skip(4)),this.ia=de.readInt32LE(this.data),this.na=de.readInt32LE(this.data),this.readMasterBars(),this.readTracks(),this.readBars(),this.De.masterBars.length>0){const t=$.buildTempoAutomation(!1,0,this.De.tempo,2);t.text=this.De.tempoLabel,this.De.masterBars[0].tempoAutomations.push(t)}return zt.consolidate(this.De),this.De.finish(this.settings),this.sa&&this.ea>=0&&this.De.tracks[this.ea].applyLyrics(this.sa),this.De}ua(t){let e,s=de.readInt16LE(this.data);-1!==s&&(s--,this.la.has(s)?e=this.la.get(s):(e=[],this.la.set(s,e)),e.push(t))}readVersion(){let t=Vs.gpReadStringByteLength(this.data,30,this.settings.importer.encoding);if(!t.startsWith(Hs.Kr))throw new Ee("Unsupported format");t=t.substr(Hs.Kr.length+1);const e=t.indexOf(String.fromCharCode(46));this.Zr=100*Number.parseInt(t.substr(0,e),10)+Number.parseInt(t.substr(e+1),10),J.debug(this.name,`Guitar Pro version ${t} detected`)}readScoreInformation(){this.De.title=Vs.gpReadStringIntUnused(this.data,this.settings.importer.encoding),this.De.subTitle=Vs.gpReadStringIntUnused(this.data,this.settings.importer.encoding),this.De.artist=Vs.gpReadStringIntUnused(this.data,this.settings.importer.encoding),this.De.album=Vs.gpReadStringIntUnused(this.data,this.settings.importer.encoding),this.De.words=Vs.gpReadStringIntUnused(this.data,this.settings.importer.encoding),this.De.music=this.Zr>=500?Vs.gpReadStringIntUnused(this.data,this.settings.importer.encoding):this.De.words,this.De.copyright=Vs.gpReadStringIntUnused(this.data,this.settings.importer.encoding),this.De.tab=Vs.gpReadStringIntUnused(this.data,this.settings.importer.encoding),this.De.instructions=Vs.gpReadStringIntUnused(this.data,this.settings.importer.encoding);const t=de.readInt32LE(this.data);let e="";for(let s=0;s<t;s++)s>0&&(e+="\r\n"),e+=Vs.gpReadStringIntUnused(this.data,this.settings.importer.encoding)?.toString();this.De.notices=e}readLyrics(){this.sa=[],this.ea=de.readInt32LE(this.data)-1;for(let t=0;t<5;t++){const t=new Be;t.startBar=de.readInt32LE(this.data)-1,t.text=Vs.gpReadStringInt(this.data,this.settings.importer.encoding),this.sa.push(t)}}readPageSetup(){this.data.skip(28);const t=de.readInt16LE(this.data);zt.getOrCreateHeaderFooterStyle(this.De,ot.Title).isVisible=!!(1&t),zt.getOrCreateHeaderFooterStyle(this.De,ot.Title).template=Vs.gpReadStringIntByte(this.data,this.settings.importer.encoding),zt.getOrCreateHeaderFooterStyle(this.De,ot.SubTitle).isVisible=!!(2&t),zt.getOrCreateHeaderFooterStyle(this.De,ot.SubTitle).template=Vs.gpReadStringIntByte(this.data,this.settings.importer.encoding),zt.getOrCreateHeaderFooterStyle(this.De,ot.Artist).isVisible=!!(4&t),zt.getOrCreateHeaderFooterStyle(this.De,ot.Artist).template=Vs.gpReadStringIntByte(this.data,this.settings.importer.encoding),zt.getOrCreateHeaderFooterStyle(this.De,ot.Album).isVisible=!!(8&t),zt.getOrCreateHeaderFooterStyle(this.De,ot.Album).template=Vs.gpReadStringIntByte(this.data,this.settings.importer.encoding),zt.getOrCreateHeaderFooterStyle(this.De,ot.Words).isVisible=!!(16&t),zt.getOrCreateHeaderFooterStyle(this.De,ot.Words).template=Vs.gpReadStringIntByte(this.data,this.settings.importer.encoding),zt.getOrCreateHeaderFooterStyle(this.De,ot.Music).isVisible=!!(32&t),zt.getOrCreateHeaderFooterStyle(this.De,ot.Music).template=Vs.gpReadStringIntByte(this.data,this.settings.importer.encoding),zt.getOrCreateHeaderFooterStyle(this.De,ot.WordsAndMusic).isVisible=!!(64&t),zt.getOrCreateHeaderFooterStyle(this.De,ot.WordsAndMusic).template=Vs.gpReadStringIntByte(this.data,this.settings.importer.encoding),zt.getOrCreateHeaderFooterStyle(this.De,ot.Copyright).isVisible=!!(128&t),zt.getOrCreateHeaderFooterStyle(this.De,ot.Copyright).template=Vs.gpReadStringIntByte(this.data,this.settings.importer.encoding),zt.getOrCreateHeaderFooterStyle(this.De,ot.CopyrightSecondLine).isVisible=!!(128&t),zt.getOrCreateHeaderFooterStyle(this.De,ot.CopyrightSecondLine).template=Vs.gpReadStringIntByte(this.data,this.settings.importer.encoding),Vs.gpReadStringIntByte(this.data,this.settings.importer.encoding)}readPlaybackInfos(){this.ra=[];let t=0;for(let e=0;e<64;e++){const e=new Me;e.primaryChannel=t++,e.secondaryChannel=t++,e.program=de.readInt32LE(this.data),e.volume=this.data.readByte(),e.balance=this.data.readByte(),this.data.skip(6),this.ra.push(e)}}readMasterBars(){for(let t=0;t<this.ia;t++)this.readMasterBar()}readMasterBar(){let t=null;this.De.masterBars.length>0&&(t=this.De.masterBars[this.De.masterBars.length-1]);const e=new tt;!t&&this.Vn.value>0&&e.tempoAutomations.push(this.Vn);const s=this.data.readByte();if(1&s?e.timeSignatureNumerator=this.data.readByte():t&&(e.timeSignatureNumerator=t.timeSignatureNumerator),2&s?e.timeSignatureDenominator=this.data.readByte():t&&(e.timeSignatureDenominator=t.timeSignatureDenominator),e.isRepeatStart=!!(4&s),8&s&&(e.repeatCount=this.data.readByte()+(this.Zr>=500?0:1)),16&s&&this.Zr<500){let s=t,i=0;for(;s&&(!s.isRepeatEnd||s===t)&&!s.isRepeatStart;)i|=s.alternateEndings,s=s.previousMasterBar;let n=0;const r=this.data.readByte();for(let t=0;t<8;t++){const e=1<<t;r>t&&0===(i&e)&&(n|=e)}e.alternateEndings=n}if(32&s){const t=new _e;t.text=Vs.gpReadStringIntByte(this.data,this.settings.importer.encoding),t.marker="",Vs.gpReadColor(this.data,!1),e.section=t}if(64&s&&this.oa.set(this.De.masterBars.length,[de.readSInt8(this.data),this.data.readByte()]),this.Zr>=500&&3&s&&this.data.skip(4),this.Zr>=500&&(e.alternateEndings=this.data.readByte()),this.Zr>=500){switch(this.data.readByte()){case 1:e.tripletFeel=F.Triplet8th;break;case 2:e.tripletFeel=F.Triplet16th}this.data.readByte()}else e.tripletFeel=this.ta;const i=!!(128&s);e.isDoubleBar=i;const n=this.De.masterBars.length;if(this.la.has(n))for(const t of this.la.get(n))e.addDirection(t);this.De.addMasterBar(e),i&&this.aa.add(e.index)}readTracks(){for(let t=0;t<this.na;t++)this.readTrack()}static da=zt.parseTuning("B1").realValue;readTrack(){const t=new Ne;t.ensureStaveCount(1),this.De.addTrack(t);const e=t.staves[0],s=this.data.readByte();t.name=Vs.gpReadStringByteLength(this.data,40,this.settings.importer.encoding),1&s&&(e.isPercussion=!0),this.Zr>=500&&(t.isVisibleOnMultiTrack=!!(8&s)),null===this.De.stylesheet.perTrackDisplayTuning&&(this.De.stylesheet.perTrackDisplayTuning=new Map),this.De.stylesheet.perTrackDisplayTuning.set(t.index,!!(128&s));const i=de.readInt32LE(this.data),n=[];for(let t=0;t<7;t++){const e=de.readInt32LE(this.data);i>t&&n.push(e)}e.stringTuning.tunings=n;const r=de.readInt32LE(this.data),a=de.readInt32LE(this.data)-1,h=de.readInt32LE(this.data)-1;if(this.data.skip(4),a>=0&&a<this.ra.length){const i=this.ra[a];i.port=r,i.isSolo=!!(16&s),i.isMute=!!(32&s),i.secondaryChannel=h,ge.isGuitar(i.program)&&(e.displayTranspositionPitch=-12),t.playbackInfo=i}if(e.capo=de.readInt32LE(this.data),t.color=Vs.gpReadColor(this.data,!1),this.Zr>=500){const s=this.data.readByte();e.showTablature=!!(1&s),e.showStandardNotation=!!(2&s);const i=!!(100&s);null===this.De.stylesheet.perTrackChordDiagramsOnTop&&(this.De.stylesheet.perTrackChordDiagramsOnTop=new Map),this.De.stylesheet.perTrackChordDiagramsOnTop.set(t.index,i),this.data.readByte(),this.data.readByte(),t.playbackInfo.bank=this.data.readByte(),this.data.readByte();12===de.readInt32LE(this.data)||n[n.length-1]<Hs.da?this.ha.set(t.index,x.F4):this.ha.set(t.index,x.G2),de.readInt32LE(this.data),de.readInt32LE(this.data),this.data.skip(10),this.data.readByte(),this.data.readByte(),this.fa(),this.Zr>=510&&(this.data.skip(4),Vs.gpReadStringIntByte(this.data,this.settings.importer.encoding),Vs.gpReadStringIntByte(this.data,this.settings.importer.encoding))}else n[n.length-1]<Hs.da?this.ha.set(t.index,x.F4):this.ha.set(t.index,x.G2)}readBars(){for(let t=0;t<this.ia;t++)for(let t=0;t<this.na;t++)this.readBar(this.De.tracks[t])}readBar(t){const e=new Q,s=t.staves[0];if(s.isPercussion?e.clef=x.Neutral:this.ha.has(t.index)&&(e.clef=this.ha.get(t.index)),s.addBar(e),this.oa.has(e.index)){const t=this.oa.get(e.index);e.keySignature=t[0],e.keySignatureType=t[1]}else e.index>0&&(e.keySignature=e.previousBar.keySignature,e.keySignatureType=e.previousBar.keySignatureType);this.aa.has(e.index)&&(e.barLineRight=E.LightLight);let i=1;this.Zr>=500&&(this.data.readByte(),i=2);for(let s=0;s<i;s++)this.readVoice(t,e)}readVoice(t,e){const s=de.readInt32LE(this.data);if(0===s)return;const i=new rt;e.addVoice(i);for(let n=0;n<s;n++)this.readBeat(t,e,i)}readBeat(t,e,s){const i=new ee,n=this.data.readByte();if(1&n&&(i.dots=1),64&n){const t=this.data.readByte();i.isEmpty=!(2&t)}s.addBeat(i);switch(de.readSInt8(this.data)){case-2:i.duration=c.Whole;break;case-1:i.duration=c.Half;break;case 0:i.duration=c.Quarter;break;case 1:i.duration=c.Eighth;break;case 2:i.duration=c.Sixteenth;break;case 3:i.duration=c.ThirtySecond;break;case 4:i.duration=c.SixtyFourth;break;default:i.duration=c.Quarter}if(32&n)switch(i.tupletNumerator=de.readInt32LE(this.data),i.tupletNumerator){case 1:i.tupletDenominator=1;break;case 3:i.tupletDenominator=2;break;case 5:case 6:case 7:i.tupletDenominator=4;break;case 9:case 10:case 11:case 12:case 13:i.tupletDenominator=8;break;case 2:case 4:case 8:break;default:i.tupletNumerator=1,i.tupletDenominator=1}2&n&&this.readChord(i);const r=this.settings.importer.beatTextAsLyrics&&t.index!==this.ea;if(4&n){const e=Vs.gpReadStringIntUnused(this.data,this.settings.importer.encoding);if(r){const s=new Be;s.text=e.trim(),s.finish(!0);const i=[];for(let t=s.chunks.length-1;t>=0;t--)i.push(s.chunks[t]);this.ca.set(t.index,i)}else i.text=e}let a=f.None;8&n&&(a=this.readBeatEffects(i)),16&n&&this.readMixTableChange(i);const h=this.data.readByte();for(let n=6;n>=0;n--)if(h&1<<n&&6-n<e.staff.tuning.length){const r=this.readNote(t,e,s,i,6-n);a!==f.None&&(r.harmonicType=a,r.harmonicType===f.Natural&&(r.harmonicValue=zt.deltaFretToHarmonicValue(r.fret)))}if(this.Zr>=500){const t=de.readInt16LE(this.data);if(1&t&&i.index>0&&(s.beats[i.index-1].beamingMode=St.ForceSplitToNext),2&t&&(i.preferredBeamDirection=Wt.Down),4&t&&i.index>0&&(s.beats[i.index-1].beamingMode=St.ForceMergeWithNext),8&t&&(i.preferredBeamDirection=Wt.Up),16&t&&(i.ottava=b._),32&t&&(i.ottava=b.T),64&t&&(i.ottava=b.S),256&t&&(i.ottava=b.M),2048&t){const t=0!==this.data.readByte();i.index>0&&t&&(s.beats[i.index-1].beamingMode=St.ForceSplitOnSecondaryToNext)}}r&&!i.isRest&&this.ca.has(t.index)&&this.ca.get(t.index).length>0&&(i.lyrics=[this.ca.get(t.index).pop()])}readChord(t){const e=new we,s=zt.newGuid();if(this.Zr>=500){this.data.skip(17),e.name=Vs.gpReadStringByteLength(this.data,21,this.settings.importer.encoding),this.data.skip(4),e.firstFret=de.readInt32LE(this.data);for(let s=0;s<7;s++){const i=de.readInt32LE(this.data);s<t.voice.bar.staff.tuning.length&&e.strings.push(i)}const s=this.data.readByte(),i=new Uint8Array(5);this.data.read(i,0,i.length);for(let t=0;t<s;t++)e.barreFrets.push(i[t]);this.data.skip(26)}else if(0!==this.data.readByte())if(this.Zr>=400){this.data.skip(16),e.name=Vs.gpReadStringByteLength(this.data,21,this.settings.importer.encoding),this.data.skip(4),e.firstFret=de.readInt32LE(this.data);for(let s=0;s<7;s++){const i=de.readInt32LE(this.data);s<t.voice.bar.staff.tuning.length&&e.strings.push(i)}const s=this.data.readByte(),i=new Uint8Array(5);this.data.read(i,0,i.length);for(let t=0;t<s;t++)e.barreFrets.push(i[t]);this.data.skip(26)}else{this.data.skip(25),e.name=Vs.gpReadStringByteLength(this.data,34,this.settings.importer.encoding),e.firstFret=de.readInt32LE(this.data);for(let s=0;s<6;s++){const i=de.readInt32LE(this.data);s<t.voice.bar.staff.tuning.length&&e.strings.push(i)}this.data.skip(36)}else{const s=this.Zr>=406?7:6;if(e.name=Vs.gpReadStringIntByte(this.data,this.settings.importer.encoding),e.firstFret=de.readInt32LE(this.data),e.firstFret>0)for(let i=0;i<s;i++){const s=de.readInt32LE(this.data);i<t.voice.bar.staff.tuning.length&&e.strings.push(s)}}e.name&&(t.chordId=s,t.voice.bar.staff.addChord(t.chordId,e))}readBeatEffects(t){const e=this.data.readByte();let s=0;if(this.Zr>=400&&(s=this.data.readByte()),16&e&&(t.fade=mt.FadeIn),(this.Zr<400&&1&e||2&e)&&(t.vibrato=w.Slight),1&s&&(t.rasgueado=yt.Ii),32&e&&this.Zr>=400){switch(de.readSInt8(this.data)){case 1:t.tap=!0;break;case 2:t.slap=!0;break;case 3:t.pop=!0}}else if(32&e){switch(de.readSInt8(this.data)){case 1:t.tap=!0;break;case 2:t.slap=!0;break;case 3:t.pop=!0}this.data.skip(4)}if(4&s&&this.readTremoloBarEffect(t),64&e){let e=0,s=0;this.Zr<500?(s=this.data.readByte(),e=this.data.readByte()):(e=this.data.readByte(),s=this.data.readByte()),e>0?(t.brushType=h.BrushUp,t.brushDuration=Hs.pa(e)):s>0&&(t.brushType=h.BrushDown,t.brushDuration=Hs.pa(s))}if(2&s)switch(de.readSInt8(this.data)){case 0:t.pickStroke=ct.None;break;case 1:t.pickStroke=ct.Up;break;case 2:t.pickStroke=ct.Down}if(this.Zr<400){if(4&e)return f.Natural;if(8&e)return f.Artificial}return f.None}readTremoloBarEffect(t){this.data.readByte(),de.readInt32LE(this.data);const e=de.readInt32LE(this.data);if(e>0)for(let s=0;s<e;s++){const e=new U(0,0);e.offset=de.readInt32LE(this.data),e.value=de.readInt32LE(this.data)/Hs.ba|0,Vs.gpReadBool(this.data),t.addWhammyBarPoint(e)}}static pa(t){switch(t){case 1:case 2:return 30;case 3:return 60;case 4:return 120;case 5:return 240;case 6:return 480;default:return 0}}fa(){this.data.skip(4),this.data.skip(4),this.data.skip(4),this.data.skip(4)}readMixTableChange(t){const e=new $s;e.instrument=de.readSInt8(this.data),this.Zr>=500&&this.fa(),e.volume=de.readSInt8(this.data),e.balance=de.readSInt8(this.data);const s=de.readSInt8(this.data),i=de.readSInt8(this.data),r=de.readSInt8(this.data),a=de.readSInt8(this.data);if(this.Zr>=500&&(e.tempoName=Vs.gpReadStringIntByte(this.data,this.settings.importer.encoding)),e.tempo=de.readInt32LE(this.data),e.volume>=0&&this.data.readByte(),e.balance>=0&&this.data.readByte(),s>=0&&this.data.readByte(),i>=0&&this.data.readByte(),r>=0&&this.data.readByte(),a>=0&&this.data.readByte(),e.tempo>=0&&(e.duration=de.readSInt8(this.data),this.Zr>=510&&this.data.readByte()),this.Zr>=400&&this.data.readByte(),this.Zr>=500){const e=de.readSInt8(this.data);e>=100?t.wahPedal=gt.Closed:e>=0&&(t.wahPedal=gt.Open)}if(this.Zr>=510&&(Vs.gpReadStringIntByte(this.data,this.settings.importer.encoding),Vs.gpReadStringIntByte(this.data,this.settings.importer.encoding)),e.volume>=0){const s=new $;s.isLinear=!0,s.type=n.Volume,s.value=e.volume,t.automations.push(s)}if(e.balance>=0){const s=new $;s.isLinear=!0,s.type=n.Balance,s.value=e.balance,t.automations.push(s)}if(e.instrument>=0){const s=new $;s.isLinear=!0,s.type=n.Instrument,s.value=e.instrument,t.automations.push(s)}if(e.tempo>=0){const s=new $;s.isLinear=!0,s.type=n.Tempo,s.value=e.tempo,t.automations.push(s),t.voice.bar.masterBar.tempoAutomations.some(t=>t.ratioPosition===s.ratioPosition&&t.value===s.value)||t.voice.bar.masterBar.tempoAutomations.push(s)}}readNote(t,e,s,i,n){const r=new Kt;r.string=e.staff.tuning.length-n;const a=this.data.readByte();if(2&a?r.accentuated=u.Heavy:64&a&&(r.accentuated=u.Normal),r.isGhost=!!(4&a),32&a){const t=this.data.readByte();3===t?r.isDead=!0:2===t&&(r.isTieDestination=!0)}if(1&a&&this.Zr<500&&(this.data.readByte(),this.data.readByte()),16&a){const t=de.readSInt8(this.data);r.dynamics=this.toDynamicValue(t),i.dynamics=r.dynamics}32&a&&(r.fret=de.readSInt8(this.data)),128&a&&(r.leftHandFinger=de.readSInt8(this.data),r.rightHandFinger=de.readSInt8(this.data));let h=!1;if(this.Zr>=500){1&a&&(r.durationPercent=de.readFloat64BE(this.data));h=!!(2&this.data.readByte())}if(i.addNote(r),8&a&&this.readNoteEffects(t,s,i,r),e.staff.isPercussion&&(r.percussionArticulation=Hs.Qr.has(r.fret)?Hs.Qr.get(r.fret):r.fret,r.string=-1,r.fret=-1),h){const t=zt.computeAccidental(e.keySignature,p.Default,r.realValueWithoutHarmonic,!1);t===T.Sharp?r.accidentalMode=p.ForceFlat:t===T.Flat&&(r.accidentalMode=p.ForceSharp)}return r}toDynamicValue(t){switch(t){case 1:return i.PPP;case 2:return i.PP;case 3:return i.P;case 4:return i.MP;case 5:return i.MF;case 6:default:return i.F;case 7:return i.FF;case 8:return i.FFF}}readNoteEffects(t,e,s,i){const n=this.data.readByte();let r=0;this.Zr>=400&&(r=this.data.readByte()),1&n&&this.readBend(i),16&n&&this.readGrace(e,i),4&r&&this.readTremoloPicking(s),8&r?this.readSlide(i):this.Zr<400&&4&n&&(i.slideOutType=g.Shift),16&r&&this.readArtificialHarmonic(i),32&r&&this.readTrill(i),i.isLetRing=!!(8&n),i.isHammerPullOrigin=!!(2&n),64&r&&(i.vibrato=w.Slight),i.isPalmMute=!!(2&r),i.isStaccato=!!(1&r)}static ba=25;readBend(t){this.data.readByte(),de.readInt32LE(this.data);const e=de.readInt32LE(this.data);if(e>0)for(let s=0;s<e;s++){const e=new U(0,0);e.offset=de.readInt32LE(this.data),e.value=de.readInt32LE(this.data)/Hs.ba|0,Vs.gpReadBool(this.data),t.addBendPoint(e)}}readGrace(t,e){const s=new ee,i=new Kt;i.string=e.string,i.fret=de.readSInt8(this.data),s.duration=c.ThirtySecond,s.dynamics=this.toDynamicValue(de.readSInt8(this.data));switch(de.readSInt8(this.data)){case 0:case 2:break;case 1:i.slideOutType=g.Legato,i.slideTarget=e;break;case 3:i.isHammerPullOrigin=!0}if(i.dynamics=s.dynamics,this.data.skip(1),this.Zr<500)s.graceType=l.BeforeBeat;else{const t=this.data.readByte();i.isDead=!!(1&t),s.graceType=2&t?l.OnBeat:l.BeforeBeat}t.addGraceBeat(s),s.addNote(i)}readTremoloPicking(t){const e=new Zt;t.tremoloPicking=e,e.marks=this.data.readByte()}readSlide(t){if(this.Zr>=500){const e=de.readSInt8(this.data);1&e?t.slideOutType=g.Shift:2&e?t.slideOutType=g.Legato:4&e?t.slideOutType=g.OutDown:8&e&&(t.slideOutType=g.OutUp),16&e?t.slideInType=m.IntoFromBelow:32&e&&(t.slideInType=m.IntoFromAbove)}else{switch(de.readSInt8(this.data)){case 1:t.slideOutType=g.Shift;break;case 2:t.slideOutType=g.Legato;break;case 3:t.slideOutType=g.OutDown;break;case 4:t.slideOutType=g.OutUp;break;case-1:t.slideInType=m.IntoFromBelow;break;case-2:t.slideInType=m.IntoFromAbove}}}readArtificialHarmonic(t){const e=this.data.readByte();if(this.Zr>=500)switch(e){case 1:t.harmonicType=f.Natural,t.harmonicValue=zt.deltaFretToHarmonicValue(t.fret);break;case 2:this.data.readByte(),this.data.readByte(),this.data.readByte(),t.harmonicType=f.Artificial;break;case 3:t.harmonicType=f.Tap,t.harmonicValue=zt.deltaFretToHarmonicValue(this.data.readByte());break;case 4:t.harmonicType=f.Pinch,t.harmonicValue=12;break;case 5:t.harmonicType=f.Semi,t.harmonicValue=12}else if(this.Zr>=400)switch(e){case 1:t.harmonicType=f.Natural;break;case 3:t.harmonicType=f.Tap;break;case 4:t.harmonicType=f.Pinch;break;case 5:t.harmonicType=f.Semi;break;case 15:case 17:case 22:t.harmonicType=f.Artificial}}readTrill(t){switch(t.trillValue=this.data.readByte()+t.stringTuning,this.data.readByte()){case 1:t.trillSpeed=c.Sixteenth;break;case 2:t.trillSpeed=c.ThirtySecond;break;case 3:t.trillSpeed=c.SixtyFourth}}}class Vs{static gpReadColor(t,e=!1){const s=t.readByte(),i=t.readByte(),n=t.readByte();let r=255;return e?r=t.readByte():t.skip(1),new ke(s,i,n,r)}static gpReadBool(t){return 0!==t.readByte()}static gpReadStringIntUnused(t,e){return t.skip(4),Vs.gpReadString(t,t.readByte(),e)}static gpReadStringInt(t,e){return Vs.gpReadString(t,de.readInt32LE(t),e)}static gpReadStringIntByte(t,e){const s=de.readInt32LE(t)-1;return t.readByte(),Vs.gpReadString(t,s,e)}static gpReadString(t,e,s){const i=new Uint8Array(e);return t.read(i,0,i.length),de.toString(i,s)}static gpWriteString(t,e){const s=de.stringToBytes(e);t.writeByte(e.length),t.write(s,0,s.length)}static gpReadStringByteLength(t,e,s){const i=t.readByte(),n=Vs.gpReadString(t,i,s);return i<e&&t.skip(e-i),n}}class $s{volume=-1;balance=-1;instrument=-1;tempoName="";tempo=-1;duration=-1}class Us{x;y;w;h;scaleWith(t){this.x*=t,this.y*=t,this.w*=t,this.h*=t}constructor(t=0,e=0,s=0,i=0){this.x=t,this.y=e,this.h=i,this.w=s}}!function(t){t[t.Boolean=0]="Boolean",t[t.Integer=1]="Integer",t[t.Float=2]="Float",t[t.String=3]="String",t[t.Point=4]="Point",t[t.Size=5]="Size",t[t.Rectangle=6]="Rectangle",t[t.Color=7]="Color"}(Xe||(Xe={}));class zs{ma=new Map;raw=new Map;constructor(t){t&&this.ga(t)}ga(t){const e=Fe.fromBuffer(t),s=de.readInt32BE(e);for(let t=0;t<s;t++){const t=Vs.gpReadString(e,e.readByte(),"utf-8"),s=e.readByte();switch(this.ma.set(t,s),s){case Xe.Boolean:const s=1===e.readByte();this.addValue(t,s);break;case Xe.Integer:const i=de.readInt32BE(e);this.addValue(t,i);break;case Xe.Float:const n=de.readFloat32BE(e);this.addValue(t,n);break;case Xe.String:const r=Vs.gpReadString(e,de.readInt16BE(e),"utf-8");this.addValue(t,r);break;case Xe.Point:const a=de.readInt32BE(e),h=de.readInt32BE(e);this.addValue(t,new U(a,h));break;case Xe.Size:const o=de.readInt32BE(e),c=de.readInt32BE(e);this.addValue(t,new U(o,c));break;case Xe.Rectangle:const l=new Us;l.x=de.readInt32BE(e),l.y=de.readInt32BE(e),l.w=de.readInt32BE(e),l.h=de.readInt32BE(e),this.addValue(t,l);break;case Xe.Color:const u=Vs.gpReadColor(e,!0);this.addValue(t,u)}}}apply(t){for(const[e,s]of this.raw)switch(e){case"StandardNotation/hideDynamics":t.stylesheet.hideDynamics=s;break;case"System/bracketExtendMode":t.stylesheet.bracketExtendMode=s;break;case"Global/useSystemSignSeparator":t.stylesheet.useSystemSignSeparator=s;break;case"Global/DisplayTuning":t.stylesheet.globalDisplayTuning=s;break;case"Global/DrawChords":t.stylesheet.globalDisplayChordDiagramsOnTop=s;break;case"System/drawChordInScore":t.stylesheet.globalDisplayChordDiagramsInScore=s;break;case"System/showTrackNameSingle":s||(t.stylesheet.singleTrackTrackNamePolicy=D.Hidden);break;case"System/showTrackNameMulti":s||(t.stylesheet.multiTrackTrackNamePolicy=D.Hidden);break;case"System/trackNameModeSingle":if(t.stylesheet.singleTrackTrackNamePolicy!==D.Hidden)switch(s){case 0:case 1:t.stylesheet.singleTrackTrackNamePolicy=D.FirstSystem;break;case 2:t.stylesheet.singleTrackTrackNamePolicy=D.AllSystems}break;case"System/trackNameModeMulti":if(t.stylesheet.multiTrackTrackNamePolicy!==D.Hidden)switch(s){case 0:case 1:t.stylesheet.multiTrackTrackNamePolicy=D.FirstSystem;break;case 2:t.stylesheet.multiTrackTrackNamePolicy=D.AllSystems}break;case"System/shortTrackNameOnFirstSystem":t.stylesheet.firstSystemTrackNameMode=s?L.ShortName:L.FullName;break;case"System/shortTrackNameOnOtherSystems":t.stylesheet.otherSystemsTrackNameMode=s?L.ShortName:L.FullName;break;case"System/horizontalTrackNameOnFirstSystem":t.stylesheet.firstSystemTrackNameOrientation=s?W.Horizontal:W.Vertical;break;case"System/horizontalTrackNameOnOtherSystems":t.stylesheet.otherSystemsTrackNameOrientation=s?W.Horizontal:W.Vertical;break;case"System/ExtendedBarLines":t.stylesheet.extendBarLines=s;break;case"Header/Title":zt.getOrCreateHeaderFooterStyle(t,ot.Title).template=s;break;case"Header/TitleAlignment":zt.getOrCreateHeaderFooterStyle(t,ot.Title).textAlign=this.wa(s);break;case"Header/drawTitle":zt.getOrCreateHeaderFooterStyle(t,ot.Title).isVisible=s;break;case"Header/Subtitle":zt.getOrCreateHeaderFooterStyle(t,ot.SubTitle).template=s;break;case"Header/SubtitleAlignment":zt.getOrCreateHeaderFooterStyle(t,ot.SubTitle).textAlign=this.wa(s);break;case"Header/drawSubtitle":zt.getOrCreateHeaderFooterStyle(t,ot.SubTitle).isVisible=s;break;case"Header/Artist":zt.getOrCreateHeaderFooterStyle(t,ot.Artist).template=s;break;case"Header/ArtistAlignment":zt.getOrCreateHeaderFooterStyle(t,ot.Artist).textAlign=this.wa(s);break;case"Header/drawArtist":zt.getOrCreateHeaderFooterStyle(t,ot.Artist).isVisible=s;break;case"Header/Album":zt.getOrCreateHeaderFooterStyle(t,ot.Album).template=s;break;case"Header/AlbumAlignment":zt.getOrCreateHeaderFooterStyle(t,ot.Album).textAlign=this.wa(s);break;case"Header/drawAlbum":zt.getOrCreateHeaderFooterStyle(t,ot.Album).isVisible=s;break;case"Header/Words":zt.getOrCreateHeaderFooterStyle(t,ot.Words).template=s;break;case"Header/WordsAlignment":zt.getOrCreateHeaderFooterStyle(t,ot.Words).textAlign=this.wa(s);break;case"Header/drawWords":zt.getOrCreateHeaderFooterStyle(t,ot.Words).isVisible=s;break;case"Header/Music":zt.getOrCreateHeaderFooterStyle(t,ot.Music).template=s;break;case"Header/MusicAlignment":zt.getOrCreateHeaderFooterStyle(t,ot.Music).textAlign=this.wa(s);break;case"Header/drawMusic":zt.getOrCreateHeaderFooterStyle(t,ot.Music).isVisible=s;break;case"Header/WordsAndMusic":zt.getOrCreateHeaderFooterStyle(t,ot.WordsAndMusic).template=s;break;case"Header/WordsAndMusicAlignment":zt.getOrCreateHeaderFooterStyle(t,ot.WordsAndMusic).textAlign=this.wa(s);break;case"Header/drawWordsAndMusic":zt.getOrCreateHeaderFooterStyle(t,ot.WordsAndMusic).isVisible=s;break;case"Header/Tabber":zt.getOrCreateHeaderFooterStyle(t,ot.Transcriber).template=s;break;case"Header/TabberAlignment":zt.getOrCreateHeaderFooterStyle(t,ot.Transcriber).textAlign=this.wa(s);break;case"Header/drawTabber":zt.getOrCreateHeaderFooterStyle(t,ot.Transcriber).isVisible=s;break;case"Footer/Copyright":zt.getOrCreateHeaderFooterStyle(t,ot.Copyright).template=s;break;case"Footer/CopyrightAlignment":zt.getOrCreateHeaderFooterStyle(t,ot.Copyright).textAlign=this.wa(s);break;case"Footer/drawCopyright":zt.getOrCreateHeaderFooterStyle(t,ot.Copyright).isVisible=s;break;case"Footer/Copyright2":zt.getOrCreateHeaderFooterStyle(t,ot.CopyrightSecondLine).template=s;break;case"Footer/Copyright2Alignment":zt.getOrCreateHeaderFooterStyle(t,ot.CopyrightSecondLine).textAlign=this.wa(s);break;case"Footer/drawCopyright2":zt.getOrCreateHeaderFooterStyle(t,ot.CopyrightSecondLine).isVisible=s;break;case"System/barIndexDrawType":switch(s){case 0:t.stylesheet.barNumberDisplay=O.AllBars;break;case 1:t.stylesheet.barNumberDisplay=O.FirstOfSystem;break;case 2:t.stylesheet.barNumberDisplay=O.Hide}}}wa(t){switch(t){case 0:return at.Left;case 1:return at.Center;case 2:return at.Right}return at.Left}addValue(t,e,s){this.raw.set(t,e),void 0!==s&&this.ma.set(t,s)}writeTo(t){de.writeInt32BE(t,this.raw.size);for(const[e,s]of this.raw){const i=this.ya(e,s);switch(Vs.gpWriteString(t,e),t.writeByte(i),i){case Xe.Boolean:t.writeByte(s?1:0);break;case Xe.Integer:de.writeInt32BE(t,s);break;case Xe.Float:de.writeFloat32BE(t,s);break;case Xe.String:const e=de.stringToBytes(s);de.writeInt16BE(t,e.length),t.write(e,0,e.length);break;case Xe.Point:case Xe.Size:de.writeInt32BE(t,s.offset),de.writeInt32BE(t,s.value);break;case Xe.Rectangle:de.writeInt32BE(t,s.x),de.writeInt32BE(t,s.y),de.writeInt32BE(t,s.w),de.writeInt32BE(t,s.h);break;case Xe.Color:t.writeByte(s.r),t.writeByte(s.g),t.writeByte(s.b),t.writeByte(s.a)}}}ya(t,e){if(this.ma.has(t))return this.ma.get(t);const i=typeof e;switch(typeof e){case"string":return Xe.String;case"number":return e===(0|e)?Xe.Integer:Xe.Float;case"object":if(e instanceof U)return Xe.Point;if(e instanceof Us)return Xe.Rectangle;if(e instanceof ke)return Xe.Color}throw new I(s.General,`Unknown value type in BinaryStylesheet: ${i}`)}static writeForScore(t){const e=new zs;switch(e.addValue("StandardNotation/hideDynamics",t.stylesheet.hideDynamics,Xe.Boolean),e.addValue("System/bracketExtendMode",t.stylesheet.bracketExtendMode,Xe.Integer),e.addValue("Global/useSystemSignSeparator",t.stylesheet.useSystemSignSeparator,Xe.Boolean),e.addValue("Global/DisplayTuning",t.stylesheet.globalDisplayTuning,Xe.Boolean),e.addValue("Global/DrawChords",t.stylesheet.globalDisplayChordDiagramsOnTop,Xe.Boolean),e.addValue("System/drawChordInScore",t.stylesheet.globalDisplayChordDiagramsInScore,Xe.Boolean),t.stylesheet.singleTrackTrackNamePolicy){case D.Hidden:e.addValue("System/showTrackNameSingle",!1,Xe.Boolean);break;case D.FirstSystem:e.addValue("System/trackNameModeSingle",0,Xe.Integer);break;case D.AllSystems:e.addValue("System/trackNameModeSingle",2,Xe.Integer)}switch(t.stylesheet.multiTrackTrackNamePolicy){case D.Hidden:e.addValue("System/showTrackNameMulti",!1,Xe.Boolean);break;case D.FirstSystem:e.addValue("System/trackNameModeMulti",0,Xe.Integer);break;case D.AllSystems:e.addValue("System/trackNameModeMulti",2,Xe.Integer)}switch(t.stylesheet.firstSystemTrackNameMode){case L.FullName:e.addValue("System/shortTrackNameOnFirstSystem",!1,Xe.Boolean);break;case L.ShortName:e.addValue("System/shortTrackNameOnFirstSystem",!0,Xe.Boolean)}switch(t.stylesheet.otherSystemsTrackNameMode){case L.FullName:e.addValue("System/shortTrackNameOnOtherSystems",!1,Xe.Boolean);break;case L.ShortName:e.addValue("System/shortTrackNameOnOtherSystems",!0,Xe.Boolean)}switch(t.stylesheet.firstSystemTrackNameOrientation){case W.Horizontal:e.addValue("System/horizontalTrackNameOnFirstSystem",!0,Xe.Boolean);break;case W.Vertical:e.addValue("System/horizontalTrackNameOnFirstSystem",!1,Xe.Boolean)}switch(t.stylesheet.otherSystemsTrackNameOrientation){case W.Horizontal:e.addValue("System/horizontalTrackNameOnOtherSystems",!0,Xe.Boolean);break;case W.Vertical:e.addValue("System/horizontalTrackNameOnOtherSystems",!1,Xe.Boolean)}e.addValue("System/ExtendedBarLines",t.stylesheet.extendBarLines,Xe.Boolean);const s=t.style;if(s)for(const[t,i]of s.headerAndFooter)switch(t){case ot.Title:zs.ka(e,i,"Header/","Title");break;case ot.SubTitle:zs.ka(e,i,"Header/","Subtitle");break;case ot.Artist:zs.ka(e,i,"Header/","Artist");break;case ot.Album:zs.ka(e,i,"Header/","Album");break;case ot.Words:zs.ka(e,i,"Header/","Words");break;case ot.Music:zs.ka(e,i,"Header/","Music");break;case ot.WordsAndMusic:zs.ka(e,i,"Header/","WordsAndMusic");break;case ot.Transcriber:zs.ka(e,i,"Header/","Tabber");break;case ot.Copyright:zs.ka(e,i,"Footer/","Copyright");break;case ot.CopyrightSecondLine:zs.ka(e,i,"Footer/","Copyright2")}switch(t.stylesheet.barNumberDisplay){case O.AllBars:e.addValue("System/barIndexDrawType",0,Xe.Integer);break;case O.FirstOfSystem:e.addValue("System/barIndexDrawType",1,Xe.Integer);break;case O.Hide:e.addValue("System/barIndexDrawType",2,Xe.Integer)}const i=Fe.withCapacity(128);return e.writeTo(i),i.toArray()}static ka(t,e,s,i){t.addValue(`${s}${i}`,e.template,Xe.String),t.addValue(`${s}${i}Alignment`,e.textAlign,Xe.Integer),void 0!==e.isVisible&&t.addValue(`${s}draw${i}`,e.isVisible,Xe.Boolean)}}class Xs{rawAudioFile}class js{id="";dots=0;tupletDenominator=-1;tupletNumerator=-1;value=c.Quarter}class Js{name="";path="";role="";get uniqueId(){return`${this.path};${this.name};${this.role}`}program=0;bank=0}class qs{static Sa="-1";static Ba=U.MaxPosition/100;static _a=.04;static Ta=44100;score;xa;Ma;va;Na;Pa;Ca;Ea;Fa;Aa;Da;La;Wa;Oa;Ra;Ia;Ga;Ha;Va;$a;Ua;za=!1;Xa;ja=!1;Ja=0;aa=new Set;oa=new Map;loadAsset;parseXml(t,e){this.Ma=new Map,this.va=new Map,this.Na=new Map,this.Pa=[],this.Ca=new Map,this.Ea=[],this.Fa=[],this.Da=new Map,this.Aa=new Map,this.La=new Map,this.Wa=new Map,this.Ra=new Map,this.Oa=new Map,this.Ia=new Map,this.Ha=new Map,this.Ga=new Map,this.Va=new Map,this.$a=new Map,this.Ua=new Map,this.ja=!1;const s=new xs;try{s.parse(t)}catch(t){throw new Ee("Could not parse XML",t)}if(this.jn(s),this.qa(),zt.consolidate(this.score),this.score.finish(e),!this.ja&&this.$a.size>0)for(const[t,e]of this.$a){this.Ca.get(t).applyLyrics(e)}}jn(t){const e=t.firstElement;if(e){if("GPIF"!==e.localName)throw new Ee("Root node of XML was not GPIF");this.score=new Ht;for(const t of e.childElements())switch(t.localName){case"Score":this.Ya(t);break;case"MasterTrack":this.Ka(t);break;case"BackingTrack":this.Qa(t);break;case"Tracks":this.Za(t);break;case"MasterBars":this.th(t);break;case"Bars":this.eh(t);break;case"Voices":this.kr(t);break;case"Beats":this.sh(t);break;case"Notes":this.ih(t);break;case"Rhythms":this.nh(t);break;case"Assets":this.rh(t)}}}rh(t){for(const e of t.childElements())if("Asset"===e.localName)e.getAttribute("id")===this.xa&&this.ah(e)}ah(t){let e="";for(const s of t.childElements())if("EmbeddedFilePath"===s.localName)e=s.innerText;const s=this.loadAsset;if(s){const t=s(e);t?this.score.backingTrack.rawAudioFile=t:this.score.backingTrack=void 0}}Ya(t){for(const e of t.childElements())switch(e.localName){case"Title":this.score.title=e.innerText;break;case"SubTitle":this.score.subTitle=e.innerText;break;case"Artist":this.score.artist=e.innerText;break;case"Album":this.score.album=e.innerText;break;case"Words":this.score.words=e.innerText;break;case"Music":this.score.music=e.innerText;break;case"WordsAndMusic":const t=e.innerText;""!==t&&(t&&!this.score.words&&(this.score.words=t),t&&!this.score.music&&(this.score.music=t));break;case"Copyright":this.score.copyright=e.innerText;break;case"Tabber":this.score.tab=e.innerText;break;case"Instructions":this.score.instructions=e.innerText;break;case"Notices":this.score.notices=e.innerText;break;case"ScoreSystemsDefaultLayout":this.score.defaultSystemsLayout=qs.hh(e.innerText,4);break;case"ScoreSystemsLayout":this.score.systemsLayout=qs.oh(e.innerText).map(t=>qs.hh(t,4))}}static hh(t,e){if(!t)return e;const s=Number.parseInt(t,10);return Number.isNaN(s)?e:s}static uh(t,e){if(!t)return e;const s=Number.parseFloat(t);return Number.isNaN(s)?e:s}static oh(t,e=" "){return t?t.split(e).map(t=>t.trim()).filter(t=>t.length>0):[]}Qa(t){const e=new Xs;let s=!1,i="",n="";for(const e of t.childElements())switch(e.localName){case"Enabled":s="true"===e.innerText;break;case"Source":i=e.innerText;break;case"AssetId":n=e.innerText;break;case"FramePadding":this.Ja=qs.hh(e.innerText,0)/qs.Ta*1e3}s&&"Local"===i&&(this.score.backingTrack=e,this.xa=n)}Ka(t){for(const e of t.childElements())switch(e.localName){case"Automations":this.dh(e,this.Ma,null,null);break;case"Tracks":this.Pa=qs.oh(e.innerText);break;case"Anacrusis":this.za=!0}}dh(t,e,s,i){for(const n of t.childElements())if("Automation"===n.localName)this.fh(n,e,s,i)}fh(t,e,s,i){let r,a=null,h=!1,o=-1,c=0,l=0,u=null,d=0,f=null,p=!0;for(const e of t.childElements())switch(e.localName){case"Type":a=e.innerText;break;case"Linear":h="true"===e.innerText.toLowerCase();break;case"Bar":o=qs.hh(e.innerText,0);break;case"Position":c=qs.uh(e.innerText,0);break;case"Value":if(e.firstElement&&e.firstElement.nodeType===Ve.CDATA)u=e.innerText;else if(e.firstElement&&e.firstElement.nodeType===Ve.Element&&"SyncPoint"===a){r=new V;for(const t of e.childElements())switch(t.localName){case"BarIndex":o=qs.hh(t.innerText,0);break;case"BarOccurrence":r.barOccurence=qs.hh(t.innerText,0);break;case"FrameOffset":const e=qs.uh(t.innerText,0);r.millisecondOffset=e/qs.Ta*1e3}}else{const t=qs.oh(e.innerText);1===t.length?(l=qs.uh(t[0],0),d=1):(l=qs.uh(t[0],0),d=qs.hh(t[1],0))}break;case"Text":f=e.innerText;break;case"Visible":p="true"===e.innerText.toLowerCase()}if(!a)return;const b=[];switch(a){case"Tempo":b.push($.buildTempoAutomation(h,c,l,d,p));break;case"SyncPoint":const t=new $;t.type=n.SyncPoint,t.isLinear=h,t.ratioPosition=c,t.syncPointValue=r,t.isVisible=p,b.push(t);break;case"Sound":if(u&&s&&s.has(u)){const t=new $;t.type=n.Bank,t.ratioPosition=c,t.value=s.get(u).bank,t.isVisible=p,b.push(t);const e=$.buildInstrumentAutomation(h,c,s.get(u).program);b.push(e)}break;case"SustainPedal":if(i){let t;i.has(o)?t=i.get(o):(t=[],i.set(o,t));const e=new Y;switch(e.ratioPosition=c,d){case 1:e.pedalType=P.Down;break;case 3:e.pedalType=P.Up}t.push(e)}}if(b.length){if(f)for(const t of b)t.text=f;if(o>=0){e.has(o)||e.set(o,[]);for(const t of b)e.get(o).push(t)}}}Za(t){for(const e of t.childElements())if("Track"===e.localName)this.ph(e)}ph(t){this.Xa=new Map;const e=new Ne;e.ensureStaveCount(1);e.staves[0].showStandardNotation=!0;const s=t.getAttribute("id");for(const i of t.childElements())switch(i.localName){case"Name":e.name=i.innerText;break;case"Color":const t=qs.oh(i.innerText);if(t.length>=3){const s=qs.hh(t[0],0),i=qs.hh(t[1],0),n=qs.hh(t[2],0);e.color=new ke(s,i,n,255)}break;case"Instrument":const n=i.getAttribute("ref");(n.endsWith("-gs")||n.endsWith("GrandStaff"))&&(e.ensureStaveCount(2),e.staves[1].showStandardNotation=!0);break;case"InstrumentSet":this.bh(e,i);break;case"NotationPatch":this.mh(e,i);break;case"ShortName":e.shortName=i.innerText;break;case"SystemsDefautLayout":e.defaultSystemsLayout=qs.hh(i.innerText,4);break;case"SystemsLayout":e.systemsLayout=qs.oh(i.innerText).map(t=>qs.hh(t,4));break;case"Lyrics":this.gh(s,i);break;case"Properties":this.wh(e,i);break;case"GeneralMidi":case"MidiConnection":case"MIDISettings":this.yh(e,i);break;case"Sounds":this.kh(s,e,i);break;case"PlaybackState":const r=i.innerText;e.playbackInfo.isSolo="Solo"===r,e.playbackInfo.isMute="Mute"===r;break;case"PartSounding":this.Sh(s,e,i);break;case"Staves":this.pr(e,i);break;case"Transpose":this.Bh(s,e,i);break;case"RSE":this._h(e,i);break;case"Automations":this.Th(s,i)}this.Ca.set(s,e)}Th(t,e){const s=new Map;this.va.set(t,s);const i=new Map;this.Na.set(t,i),this.dh(e,s,this.Ua.get(t),i)}mh(t,e){for(const s of e.childElements())switch(s.localName){case"LineCount":const e=qs.hh(s.innerText,5);for(const s of t.staves)s.standardNotationLineCount=e;break;case"Elements":this.xh(t,s,!1)}}bh(t,e){for(const s of e.childElements())switch(s.localName){case"Type":if("drumKit"===s.innerText)for(const e of t.staves)e.isPercussion=!0;break;case"Elements":this.xh(t,s,!0);break;case"LineCount":const e=qs.hh(s.innerText,5);for(const s of t.staves)s.standardNotationLineCount=e}}xh(t,e,s){for(const i of e.childElements())if("Element"===i.localName)this.Mh(t,i,s)}Mh(t,e,s){const i=e.findChildElement("Name")?.innerText??"";for(const n of e.childElements())switch(n.localName){case"Name":case"Articulations":this.Nh(t,n,s,i)}}Nh(t,e,s,i){for(const n of e.childElements())if("Articulation"===n.localName)this.Ph(t,n,s,i)}Ph(t,e,s,i){const n=new jt;n.outputMidiNumber=-1,n.elementType=i;let r="";for(const t of e.childElements()){const e=t.innerText;switch(t.localName){case"Name":r=t.innerText;break;case"InputMidiNumbers":n.id=qs.hh(e.split(" ")[0],0);break;case"OutputMidiNumber":n.outputMidiNumber=qs.hh(e,0);break;case"TechniqueSymbol":n.techniqueSymbol=qs.parseTechniqueSymbol(e);break;case"TechniquePlacement":n.techniqueSymbolPlacement=qs.parseTechniqueSymbolPlacement(e);break;case"Noteheads":const s=qs.oh(e);s.length>=1&&(n.noteHeadDefault=qs.parseNoteHead(s[0])),s.length>=2&&(n.noteHeadHalf=qs.parseNoteHead(s[1])),s.length>=3&&(n.noteHeadWhole=qs.parseNoteHead(s[2])),n.noteHeadHalf===lt.None&&(n.noteHeadHalf=n.noteHeadDefault),n.noteHeadWhole===lt.None&&(n.noteHeadWhole=n.noteHeadDefault);break;case"StaffLine":n.staffLine=qs.hh(e,0)}}const a=`${i}.${r}`;s?(t.percussionArticulations.push(n),this.Xa.set(a,n)):this.Xa.has(a)&&(this.Xa.get(a).staffLine=n.staffLine)}static parseTechniqueSymbol(t){switch(t){case"pictEdgeOfCymbal":return lt.PictEdgeOfCymbal;case"articStaccatoAbove":return lt.ArticStaccatoAbove;case"noteheadParenthesis":return lt.NoteheadParenthesis;case"stringsUpBow":return lt.StringsUpBow;case"stringsDownBow":return lt.StringsDownBow;case"guitarGolpe":return lt.GuitarGolpe;default:return lt.None}}static parseTechniqueSymbolPlacement(t){switch(t){case"outside":default:return ut.Outside;case"inside":return ut.Inside;case"above":return ut.Above;case"below":return ut.Below}}static parseNoteHead(t){switch(t){case"noteheadDoubleWholeSquare":return lt.NoteheadDoubleWholeSquare;case"noteheadDoubleWhole":return lt.NoteheadDoubleWhole;case"noteheadWhole":return lt.NoteheadWhole;case"noteheadHalf":return lt.NoteheadHalf;case"noteheadBlack":return lt.NoteheadBlack;case"noteheadNull":return lt.NoteheadNull;case"noteheadXOrnate":return lt.NoteheadXOrnate;case"noteheadTriangleUpWhole":return lt.NoteheadTriangleUpWhole;case"noteheadTriangleUpHalf":return lt.NoteheadTriangleUpHalf;case"noteheadTriangleUpBlack":return lt.NoteheadTriangleUpBlack;case"noteheadDiamondBlackWide":return lt.NoteheadDiamondBlackWide;case"noteheadDiamondWhite":return lt.NoteheadDiamondWhite;case"noteheadDiamondWhiteWide":return lt.NoteheadDiamondWhiteWide;case"noteheadCircleX":return lt.NoteheadCircleX;case"noteheadXWhole":return lt.NoteheadXWhole;case"noteheadXHalf":return lt.NoteheadXHalf;case"noteheadXBlack":return lt.NoteheadXBlack;case"noteheadParenthesis":return lt.NoteheadParenthesis;case"noteheadSlashedBlack2":return lt.NoteheadSlashedBlack2;case"noteheadCircleSlash":return lt.NoteheadCircleSlash;case"noteheadHeavyX":return lt.NoteheadHeavyX;case"noteheadHeavyXHat":return lt.NoteheadHeavyXHat;default:return J.warning("GPIF","Unknown notehead symbol",t),lt.None}}pr(t,e){let s=0;for(const i of e.childElements())if("Staff"===i.localName){t.ensureStaveCount(s+1);const e=t.staves[s];this.br(e,i),s++}}br(t,e){for(const s of e.childElements())if("Properties"===s.localName)this.Ch(t,s)}Ch(t,e){for(const s of e.childElements())if("Property"===s.localName)this.Eh(t,s)}Eh(t,e){switch(e.getAttribute("name")){case"Tuning":for(const s of e.childElements())switch(s.localName){case"Pitches":const i=qs.oh(e.findChildElement("Pitches")?.innerText),n=new Array(i.length);for(let t=0;t<n.length;t++)n[n.length-1-t]=qs.hh(i[t],0);t.stringTuning.tunings=n;break;case"Label":t.stringTuning.name=s.innerText}t.isPercussion||(t.showTablature=!0);break;case"DiagramCollection":case"ChordCollection":this.Fh(t,e);break;case"CapoFret":const s=qs.hh(e.findChildElement("Fret")?.innerText,0);t.capo=s}}gh(t,e){const s=[];for(const t of e.childElements())if("Line"===t.localName)s.push(this.Ah(t));this.$a.set(t,s)}Ah(t){const e=new Be;for(const s of t.childElements())switch(s.localName){case"Offset":e.startBar=qs.hh(s.innerText,0);break;case"Text":e.text=s.innerText}return e}Dh(t,e){const s=e.findChildElement("Items");if(s)for(const e of s.childElements())if("Item"===e.localName)this.Lh(t,e)}Fh(t,e){const s=e.findChildElement("Items");if(s)for(const e of s.childElements())if("Item"===e.localName)this.Wh(t,e)}Lh(t,e){const s=new we,i=e.getAttribute("id");for(const e of t.staves)e.addChord(i,s);this.Oh(s,e)}Wh(t,e){const s=new we,i=e.getAttribute("id");t.addChord(i,s),this.Oh(s,e)}Oh(t,e){t.name=e.getAttribute("name");const s=e.findChildElement("Diagram");if(!s)return t.showDiagram=!1,void(t.showFingering=!1);const i=qs.hh(s.getAttribute("stringCount"),6),n=qs.hh(s.getAttribute("baseFret"),0);t.firstFret=n+1;for(let e=0;e<i;e++)t.strings.push(-1);for(const e of s.childElements())switch(e.localName){case"Fret":const s=qs.hh(e.getAttribute("string"),0);t.strings[i-s-1]=n+qs.hh(e.getAttribute("fret"),0);break;case"Fingering":const r=new Map;for(const s of e.childElements())if("Position"===s.localName){let e=d.Unknown;const i=n+qs.hh(s.getAttribute("fret"),0);switch(s.getAttribute("finger")){case"Index":e=d.IndexFinger;break;case"Middle":e=d.MiddleFinger;break;case"Rank":e=d.AnnularFinger;break;case"Pinky":e=d.LittleFinger;break;case"Thumb":e=d.Thumb}e!==d.Unknown&&(r.has(e)?t.barreFrets.push(i):r.set(e,!0))}break;case"Property":switch(e.getAttribute("name")){case"ShowName":t.showName="true"===e.getAttribute("value");break;case"ShowDiagram":t.showDiagram="true"===e.getAttribute("value");break;case"ShowFingering":t.showFingering="true"===e.getAttribute("value")}}}wh(t,e){for(const s of e.childElements())if("Property"===s.localName)this.Rh(t,s)}Rh(t,e){switch(e.getAttribute("name")){case"Tuning":const s=qs.oh(e.findChildElement("Pitches")?.innerText),i=new Array(s.length);for(let t=0;t<i.length;t++)i[i.length-1-t]=qs.hh(s[t],0);for(const e of t.staves)e.stringTuning.tunings=i,e.showStandardNotation=!0,e.showTablature=!0;break;case"DiagramCollection":case"ChordCollection":this.Dh(t,e);break;case"CapoFret":const n=qs.hh(e.findChildElement("Fret")?.innerText,0);for(const e of t.staves)e.capo=n}}yh(t,e){for(const s of e.childElements())switch(s.localName){case"Program":t.playbackInfo.program=qs.hh(s.innerText,0);break;case"Port":t.playbackInfo.port=qs.hh(s.innerText,0);break;case"PrimaryChannel":t.playbackInfo.primaryChannel=qs.hh(s.innerText,0);break;case"SecondaryChannel":t.playbackInfo.secondaryChannel=qs.hh(s.innerText,0)}if("Percussion"===e.getAttribute("table"))for(const e of t.staves)e.isPercussion=!0}kh(t,e,s){for(const i of s.childElements())if("Sound"===i.localName)this.Ih(t,e,i)}Ih(t,e,s){const i=new Js;for(const t of s.childElements())switch(t.localName){case"Name":i.name=t.innerText;break;case"Path":i.path=t.innerText;break;case"Role":i.role=t.innerText;break;case"MIDI":this.Gh(i,t)}this.Ua.has(t)||(this.Ua.set(t,new Map),e.playbackInfo.program=i.program,e.playbackInfo.bank=i.bank),this.Ua.get(t).set(i.uniqueId,i)}Gh(t,e){let s=0,i=0;for(const n of e.childElements())switch(n.localName){case"Program":t.program=qs.hh(n.innerText,0);break;case"MSB":s=qs.hh(n.innerText,0);break;case"LSB":i=qs.hh(n.innerText,0)}t.bank=(127&s)<<7|i}Sh(t,e,s){for(const i of s.childElements())switch(i.localName){case"TranspositionPitch":for(const t of e.staves)t.displayTranspositionPitch=qs.hh(i.innerText,0);break;case"NominalKey":const s=Math.max(0,Te.noteNames.indexOf(i.innerText));this.Hh.set(t,s)}}Hh=new Map;Bh(t,e,s){let i=0,n=0;for(const t of s.childElements())switch(t.localName){case"Chromatic":n=qs.hh(t.innerText,0);break;case"Octave":i=qs.hh(t.innerText,0)}const r=12*i+n;for(const t of e.staves)t.displayTranspositionPitch=r;const a=zt.flooredDivision(r,12);this.Hh.set(t,a)}_h(t,e){for(const s of e.childElements())if("ChannelStrip"===s.localName)this.Vh(t,s)}Vh(t,e){for(const s of e.childElements())if("Parameters"===s.localName)this.$h(t,s)}$h(t,e){if(e.firstChild&&e.firstChild.value){const s=qs.oh(e.firstChild.value);s.length>=12&&(t.playbackInfo.balance=Math.floor(16*qs.uh(s[11],.5)),t.playbackInfo.volume=Math.floor(16*qs.uh(s[12],.9)))}}th(t){for(const e of t.childElements())if("MasterBar"===e.localName)this.Uh(e)}Uh(t){const e=new tt;0===this.Ea.length&&this.za&&(e.isAnacrusis=!0);for(const s of t.childElements())switch(s.localName){case"Time":const t=s.innerText.split("/");e.timeSignatureNumerator=qs.hh(t[0],4),e.timeSignatureDenominator=qs.hh(t[1],4);break;case"FreeTime":e.isFreeTime=!0;break;case"DoubleBar":e.isDoubleBar=!0,this.aa.add(e);break;case"Section":e.section=new _e,e.section.marker=s.findChildElement("Letter")?.innerText??"",e.section.text=s.findChildElement("Text")?.innerText??"";break;case"Repeat":"true"===s.getAttribute("start").toLowerCase()&&(e.isRepeatStart=!0),"true"===s.getAttribute("end").toLowerCase()&&s.getAttribute("count")&&(e.repeatCount=qs.hh(s.getAttribute("count"),1));break;case"AlternateEndings":const i=qs.oh(s.innerText);let n=0;for(let t=0;t<i.length;t++)n|=1<<-1+qs.hh(i[t],0);e.alternateEndings=n;break;case"Bars":this.Fa.push(qs.oh(s.innerText));break;case"TripletFeel":switch(s.innerText){case"NoTripletFeel":e.tripletFeel=F.NoTripletFeel;break;case"Triplet8th":e.tripletFeel=F.Triplet8th;break;case"Triplet16th":e.tripletFeel=F.Triplet16th;break;case"Dotted8th":e.tripletFeel=F.Dotted8th;break;case"Dotted16th":e.tripletFeel=F.Dotted16th;break;case"Scottish8th":e.tripletFeel=F.Scottish8th;break;case"Scottish16th":e.tripletFeel=F.Scottish16th}break;case"Key":const r=qs.hh(s.findChildElement("AccidentalCount")?.innerText,0),a=s.findChildElement("Mode");let h=N.Major;if(a)switch(a.innerText.toLowerCase()){case"major":h=N.Major;break;case"minor":h=N.Minor}this.oa.set(this.Ea.length,[r,h]);break;case"Fermatas":this.zh(e,s);break;case"XProperties":this.Xh(e,s);break;case"Directions":this.jh(e,s)}this.Ea.push(e)}jh(t,e){for(const s of e.childElements())switch(s.localName){case"Target":switch(s.innerText){case"Coda":t.addDirection(ze.TargetCoda);break;case"DoubleCoda":t.addDirection(ze.TargetDoubleCoda);break;case"Segno":t.addDirection(ze.TargetSegno);break;case"SegnoSegno":t.addDirection(ze.TargetSegnoSegno);break;case"Fine":t.addDirection(ze.TargetFine)}break;case"Jump":switch(s.innerText){case"DaCapo":t.addDirection(ze.JumpDaCapo);break;case"DaCapoAlCoda":t.addDirection(ze.JumpDaCapoAlCoda);break;case"DaCapoAlDoubleCoda":t.addDirection(ze.JumpDaCapoAlDoubleCoda);break;case"DaCapoAlFine":t.addDirection(ze.JumpDaCapoAlFine);break;case"DaSegno":t.addDirection(ze.JumpDalSegno);break;case"DaSegnoAlCoda":t.addDirection(ze.JumpDalSegnoAlCoda);break;case"DaSegnoAlDoubleCoda":t.addDirection(ze.JumpDalSegnoAlDoubleCoda);break;case"DaSegnoAlFine":t.addDirection(ze.JumpDalSegnoAlFine);break;case"DaSegnoSegno":t.addDirection(ze.JumpDalSegnoSegno);break;case"DaSegnoSegnoAlCoda":t.addDirection(ze.JumpDalSegnoSegnoAlCoda);break;case"DaSegnoSegnoAlDoubleCoda":t.addDirection(ze.JumpDalSegnoSegnoAlDoubleCoda);break;case"DaSegnoSegnoAlFine":t.addDirection(ze.JumpDalSegnoSegnoAlFine);break;case"DaCoda":t.addDirection(ze.JumpDaCoda);break;case"DaDoubleCoda":t.addDirection(ze.JumpDaDoubleCoda)}}}zh(t,e){for(const s of e.childElements())if("Fermata"===s.localName)this.Jh(t,s)}Jh(t,e){let s=0;const i=new Se;for(const t of e.childElements())switch(t.localName){case"Type":switch(t.innerText){case"Short":i.type=At.Short;break;case"Medium":i.type=At.Medium;break;case"Long":i.type=At.Long}break;case"Length":i.length=qs.uh(t.innerText,0);break;case"Offset":const e=t.innerText.split("/");if(2===e.length){s=qs.hh(e[0],4)/qs.hh(e[1],4)*H.QuarterTime|0}}t.addFermata(s,i)}eh(t){for(const e of t.childElements())if("Bar"===e.localName)this.qh(e)}qh(t){const e=new Q,s=t.getAttribute("id");for(const i of t.childElements())switch(i.localName){case"Voices":this.Da.set(s,qs.oh(i.innerText));break;case"Clef":switch(i.innerText){case"Neutral":e.clef=x.Neutral;break;case"G2":e.clef=x.G2;break;case"F4":e.clef=x.F4;break;case"C4":e.clef=x.C4;break;case"C3":e.clef=x.C3}break;case"Ottavia":switch(i.innerText){case"8va":e.clefOttava=b._;break;case"15ma":e.clefOttava=b.S;break;case"8vb":e.clefOttava=b.T;break;case"15mb":e.clefOttava=b.M}break;case"SimileMark":switch(i.innerText){case"Simple":e.simileMark=M.Simple;break;case"FirstOfDouble":e.simileMark=M.FirstOfDouble;break;case"SecondOfDouble":e.simileMark=M.SecondOfDouble}break;case"XProperties":this.Yh(i,e)}this.Aa.set(s,e)}kr(t){for(const e of t.childElements())if("Voice"===e.localName)this.Sr(e)}Sr(t){const e=new rt,s=t.getAttribute("id");for(const e of t.childElements())if("Beats"===e.localName)this.Wa.set(s,qs.oh(e.innerText));this.La.set(s,e)}sh(t){for(const e of t.childElements())if("Beat"===e.localName)this.Kh(e)}Kh(t){const e=new ee,s=t.getAttribute("id");for(const n of t.childElements())switch(n.localName){case"Notes":this.Ha.set(s,qs.oh(n.innerText));break;case"Rhythm":this.Oa.set(s,n.getAttribute("ref"));break;case"Fadding":switch(n.innerText){case"FadeIn":e.fade=mt.FadeIn;break;case"FadeOut":e.fade=mt.FadeOut;break;case"VolumeSwell":e.fade=mt.VolumeSwell}break;case"Tremolo":const t=new Zt;switch(e.tremoloPicking=t,n.innerText){case"1/2":t.marks=1;break;case"1/4":t.marks=2;break;case"1/8":t.marks=3}break;case"Chord":e.chordId=n.innerText;break;case"Hairpin":switch(n.innerText){case"Crescendo":e.crescendo=o.Crescendo;break;case"Decrescendo":e.crescendo=o.Decrescendo}break;case"Arpeggio":"Up"===n.innerText?e.brushType=h.ArpeggioUp:e.brushType=h.ArpeggioDown;break;case"Properties":this.Qh(n,e);break;case"XProperties":this.Zh(n,e);break;case"FreeText":e.text=n.innerText;break;case"TransposedPitchStemOrientation":switch(n.innerText){case"Upward":e.preferredBeamDirection=Wt.Up;break;case"Downward":e.preferredBeamDirection=Wt.Down}break;case"Dynamic":switch(n.innerText){case"PPP":e.dynamics=i.PPP;break;case"PP":e.dynamics=i.PP;break;case"P":e.dynamics=i.P;break;case"MP":e.dynamics=i.MP;break;case"MF":e.dynamics=i.MF;break;case"F":e.dynamics=i.F;break;case"FF":e.dynamics=i.FF;break;case"FFF":e.dynamics=i.FFF}break;case"GraceNotes":switch(n.innerText){case"OnBeat":e.graceType=l.OnBeat;break;case"BeforeBeat":e.graceType=l.BeforeBeat}break;case"Legato":"true"===n.getAttribute("origin")&&(e.isLegatoOrigin=!0);break;case"Whammy":const r=new U(0,0);r.value=this.eo(qs.uh(n.getAttribute("originValue"),0)),r.offset=this.so(qs.uh(n.getAttribute("originOffset"),0)),e.addWhammyBarPoint(r);const a=new U(0,0);a.value=this.eo(qs.uh(n.getAttribute("middleValue"),0)),a.offset=this.so(qs.uh(n.getAttribute("middleOffset1"),0)),e.addWhammyBarPoint(a);const c=new U(0,0);c.value=this.eo(qs.uh(n.getAttribute("middleValue"),0)),c.offset=this.so(qs.uh(n.getAttribute("middleOffset2"),0)),e.addWhammyBarPoint(c);const u=new U(0,0);u.value=this.eo(qs.uh(n.getAttribute("destinationValue"),0)),u.offset=this.so(qs.uh(n.getAttribute("destinationOffset"),0)),e.addWhammyBarPoint(u);break;case"Ottavia":switch(n.innerText){case"8va":e.ottava=b._;break;case"8vb":e.ottava=b.T;break;case"15ma":e.ottava=b.S;break;case"15mb":e.ottava=b.M}break;case"Lyrics":e.lyrics=this.io(n),this.ja=!0;break;case"Slashed":e.slashed=!0;break;case"DeadSlapped":e.deadSlapped=!0;break;case"Golpe":switch(n.innerText){case"Finger":e.golpe=bt.Finger;break;case"Thumb":e.golpe=bt.Thumb}break;case"Wah":switch(n.innerText){case"Open":e.wahPedal=gt.Open;break;case"Closed":e.wahPedal=gt.Closed}break;case"UserTransposedPitchStemOrientation":switch(n.innerText){case"Downward":e.preferredBeamDirection=Wt.Down;break;case"Upward":e.preferredBeamDirection=Wt.Up}break;case"Timer":e.showTimer=!0,e.timer=qs.hh(n.innerText,-1),e.timer<0&&(e.timer=null)}this.Ra.set(s,e)}io(t){const e=[];for(const s of t.childElements())if("Line"===s.localName)e.push(s.innerText);return e}Zh(t,e){for(const s of t.childElements())if("XProperty"===s.localName){let t=0;switch(s.getAttribute("id")){case"1124204546":switch(t=qs.hh(s.findChildElement("Int")?.innerText,0),t){case 1:e.beamingMode=St.ForceMergeWithNext;break;case 2:e.beamingMode=St.ForceSplitToNext}break;case"1124204552":if(t=qs.hh(s.findChildElement("Int")?.innerText,0),1===t)e.beamingMode!==St.ForceSplitToNext&&(e.beamingMode=St.ForceSplitOnSecondaryToNext);break;case"1124204545":t=qs.hh(s.findChildElement("Int")?.innerText,0),e.invertBeamDirection=1===t;break;case"687935489":t=qs.hh(s.findChildElement("Int")?.innerText,0),e.brushDuration=t}}}Yh(t,e){for(const s of t.childElements())if("XProperty"===s.localName){if("1124139520"===s.getAttribute("id")){const t=s.findChildElement("Double")??s.findChildElement("Float");e.displayScale=qs.uh(t?.innerText,1)}}}Xh(t,e){let s,i=Number.NaN;for(const n of e.childElements())if("XProperty"===n.localName){const e=n.getAttribute("id");switch(e){case"1124073984":t.displayScale=qs.uh(n.findChildElement("Double")?.innerText,1);break;case"1124139010":i=qs.hh(n.findChildElement("Int")?.innerText,Number.NaN);break;default:const r=qs.hh(e,0);if(r>=1124139264&&r<=1124139295){const t=r-1124139264,e=qs.hh(n.findChildElement("Int")?.innerText,Number.NaN);for(void 0===s&&(s=[]);s.length<t+1;)s.push(0);s[t]=e}}}if(!Number.isNaN(i)&&s){const e=new Z;e.groups.set(i,s),t.beamingRules=e}}Qh(t,e){let s=!1,i=null,n=null,r=null,a=null,o=null;for(const c of t.childElements())if("Property"===c.localName){switch(c.getAttribute("name")){case"Brush":"Up"===c.findChildElement("Direction")?.innerText?e.brushType=h.BrushUp:e.brushType=h.BrushDown;break;case"PickStroke":"Up"===c.findChildElement("Direction")?.innerText?e.pickStroke=ct.Up:e.pickStroke=ct.Down;break;case"Slapped":c.findChildElement("Enable")&&(e.slap=!0);break;case"Popped":c.findChildElement("Enable")&&(e.pop=!0);break;case"VibratoWTremBar":switch(c.findChildElement("Strength")?.innerText){case"Wide":e.vibrato=w.Wide;break;case"Slight":e.vibrato=w.Slight}break;case"WhammyBar":s=!0;break;case"WhammyBarExtend":break;case"WhammyBarOriginValue":i||(i=new U(0,0)),i.value=this.eo(qs.uh(c.findChildElement("Float")?.innerText,0));break;case"WhammyBarOriginOffset":i||(i=new U(0,0)),i.offset=this.so(qs.uh(c.findChildElement("Float")?.innerText,0));break;case"WhammyBarMiddleValue":n=this.eo(qs.uh(c.findChildElement("Float")?.innerText,0));break;case"WhammyBarMiddleOffset1":r=this.so(qs.uh(c.findChildElement("Float")?.innerText,0));break;case"WhammyBarMiddleOffset2":a=this.so(qs.uh(c.findChildElement("Float")?.innerText,0));break;case"WhammyBarDestinationValue":o||(o=new U(U.MaxPosition,0)),o.value=this.eo(qs.uh(c.findChildElement("Float")?.innerText,0));break;case"WhammyBarDestinationOffset":o||(o=new U(0,0)),o.offset=this.so(qs.uh(c.findChildElement("Float")?.innerText,0));break;case"BarreFret":e.barreFret=qs.hh(c.findChildElement("Fret")?.innerText,0);break;case"BarreString":switch(c.findChildElement("String")?.innerText){case"0":e.barreShape=wt.Full;break;case"1":e.barreShape=wt.Half}break;case"Rasgueado":switch(c.findChildElement("Rasgueado")?.innerText){case"ii_1":e.rasgueado=yt.Ii;break;case"mi_1":e.rasgueado=yt.Mi;break;case"mii_1":e.rasgueado=yt.MiiTriplet;break;case"mii_2":e.rasgueado=yt.MiiAnapaest;break;case"pmp_1":e.rasgueado=yt.PmpTriplet;break;case"pmp_2":e.rasgueado=yt.PmpAnapaest;break;case"pei_1":e.rasgueado=yt.PeiTriplet;break;case"pei_2":e.rasgueado=yt.PeiAnapaest;break;case"pai_1":e.rasgueado=yt.PaiTriplet;break;case"pai_2":e.rasgueado=yt.PaiAnapaest;break;case"ami_1":e.rasgueado=yt.AmiTriplet;break;case"ami_2":e.rasgueado=yt.AmiAnapaest;break;case"ppp_1":e.rasgueado=yt.Ppp;break;case"amii_1":e.rasgueado=yt.Amii;break;case"amip_1":e.rasgueado=yt.Amip;break;case"eami_1":e.rasgueado=yt.Eami;break;case"eamii_1":e.rasgueado=yt.Eamii;break;case"peami_1":e.rasgueado=yt.Peami}}}s&&(i||(i=new U(0,0)),o||(o=new U(U.MaxPosition,0)),e.addWhammyBarPoint(i),r&&n&&e.addWhammyBarPoint(new U(r,n)),a&&n&&e.addWhammyBarPoint(new U(a,n)),r||a||!n||e.addWhammyBarPoint(new U(U.MaxPosition/2|0,n)),e.addWhammyBarPoint(o))}ih(t){for(const e of t.childElements())if("Note"===e.localName)this.no(e)}no(t){const e=new Kt,s=t.getAttribute("id");for(const i of t.childElements())switch(i.localName){case"Properties":this.ro(i,e,s);break;case"AntiAccent":"normal"===i.innerText.toLowerCase()&&(e.isGhost=!0);break;case"LetRing":e.isLetRing=!0;break;case"Trill":e.trillValue=qs.hh(i.innerText,-1),e.trillSpeed=c.Sixteenth;break;case"Accent":const t=qs.hh(i.innerText,0);1&t&&(e.isStaccato=!0),4&t&&(e.accentuated=u.Heavy),8&t&&(e.accentuated=u.Normal),16&t&&(e.accentuated=u.Tenuto);break;case"Tie":"true"===i.getAttribute("destination").toLowerCase()&&(e.isTieDestination=!0);break;case"Vibrato":switch(i.innerText){case"Slight":e.vibrato=w.Slight;break;case"Wide":e.vibrato=w.Wide}break;case"LeftFingering":switch(i.innerText){case"P":e.leftHandFinger=d.Thumb;break;case"I":e.leftHandFinger=d.IndexFinger;break;case"M":e.leftHandFinger=d.MiddleFinger;break;case"A":e.leftHandFinger=d.AnnularFinger;break;case"C":e.leftHandFinger=d.LittleFinger}break;case"RightFingering":switch(i.innerText){case"P":e.rightHandFinger=d.Thumb;break;case"I":e.rightHandFinger=d.IndexFinger;break;case"M":e.rightHandFinger=d.MiddleFinger;break;case"A":e.rightHandFinger=d.AnnularFinger;break;case"C":e.rightHandFinger=d.LittleFinger}break;case"InstrumentArticulation":e.percussionArticulation=qs.hh(i.innerText,0);break;case"Ornament":switch(i.innerText){case"Turn":e.ornament=dt.Turn;break;case"InvertedTurn":e.ornament=dt.InvertedTurn;break;case"UpperMordent":e.ornament=dt.UpperMordent;break;case"LowerMordent":e.ornament=dt.LowerMordent}}this.Ga.set(s,e)}ro(t,e,s){let i=!1,n=null,r=null,a=null,h=null,o=null,c=-1,l=-1,u=!1;for(const d of t.childElements())if("Property"===d.localName){switch(d.getAttribute("name")){case"ShowStringNumber":d.findChildElement("Enable")&&(e.showStringNumber=!0);break;case"String":e.string=qs.hh(d.findChildElement("String")?.innerText,0)+1;break;case"Fret":e.fret=qs.hh(d.findChildElement("Fret")?.innerText,0);break;case"Element":c=qs.hh(d.findChildElement("Element")?.innerText,0);break;case"Variation":l=qs.hh(d.findChildElement("Variation")?.innerText,0);break;case"Tapped":this.Va.set(s,!0);break;case"HarmonicType":const t=d.findChildElement("HType");if(t)switch(t.innerText){case"NoHarmonic":e.harmonicType=f.None;break;case"Natural":e.harmonicType=f.Natural;break;case"Artificial":e.harmonicType=f.Artificial;break;case"Pinch":e.harmonicType=f.Pinch;break;case"Tap":e.harmonicType=f.Tap;break;case"Semi":e.harmonicType=f.Semi;break;case"Feedback":e.harmonicType=f.Feedback}break;case"HarmonicFret":const b=d.findChildElement("HFret");b&&(e.harmonicValue=qs.uh(b.innerText,0));break;case"Muted":d.findChildElement("Enable")&&(e.isDead=!0);break;case"PalmMuted":d.findChildElement("Enable")&&(e.isPalmMute=!0);break;case"Octave":e.octave=qs.hh(d.findChildElement("Number")?.innerText,0),-1===e.tone&&(e.tone=0);break;case"Tone":e.tone=qs.hh(d.findChildElement("Step")?.innerText,0);break;case"ConcertPitch":u||this.ao(d,e);break;case"TransposedPitch":e.accidentalMode=p.Default,this.ao(d,e),u=!0;break;case"Bended":i=!0;break;case"BendOriginValue":n||(n=new U(0,0)),n.value=this.eo(qs.uh(d.findChildElement("Float")?.innerText,0));break;case"BendOriginOffset":n||(n=new U(0,0)),n.offset=this.so(qs.uh(d.findChildElement("Float")?.innerText,0));break;case"BendMiddleValue":r=this.eo(qs.uh(d.findChildElement("Float")?.innerText,0));break;case"BendMiddleOffset1":a=this.so(qs.uh(d.findChildElement("Float")?.innerText,0));break;case"BendMiddleOffset2":h=this.so(qs.uh(d.findChildElement("Float")?.innerText,0));break;case"BendDestinationValue":o||(o=new U(U.MaxPosition,0)),o.value=this.eo(qs.uh(d.findChildElement("Float")?.innerText,0));break;case"BendDestinationOffset":o||(o=new U(0,0)),o.offset=this.so(qs.uh(d.findChildElement("Float")?.innerText,0));break;case"HopoOrigin":d.findChildElement("Enable")&&(e.isHammerPullOrigin=!0);break;case"HopoDestination":break;case"LeftHandTapped":e.isLeftHandTapped=!0;break;case"Slide":const w=qs.hh(d.findChildElement("Flags")?.innerText,0);1&w?e.slideOutType=g.Shift:2&w?e.slideOutType=g.Legato:4&w?e.slideOutType=g.OutDown:8&w&&(e.slideOutType=g.OutUp),16&w?e.slideInType=m.IntoFromBelow:32&w&&(e.slideInType=m.IntoFromAbove),64&w?e.slideOutType=g.PickSlideDown:128&w&&(e.slideOutType=g.PickSlideUp)}}i&&(n||(n=new U(0,0)),o||(o=new U(U.MaxPosition,0)),e.addBendPoint(n),a&&r&&e.addBendPoint(new U(a,r)),h&&r&&e.addBendPoint(new U(h,r)),a||h||!r||e.addBendPoint(new U(U.MaxPosition/2|0,r)),e.addBendPoint(o)),-1!==c&&-1!==l&&(e.percussionArticulation=Jt.articulationFromElementVariation(c,l))}ao(t,e){const s=t.findChildElement("Pitch");if(s)for(const t of s.childElements())if("Accidental"===t.localName)switch(t.innerText){case"":e.accidentalMode=p.ForceNatural;break;case"x":e.accidentalMode=p.ForceDoubleSharp;break;case"#":e.accidentalMode=p.ForceSharp;break;case"b":e.accidentalMode=p.ForceFlat;break;case"bb":e.accidentalMode=p.ForceDoubleFlat}}eo(t){return t*qs._a|0}so(t){return t*qs.Ba}nh(t){for(const e of t.childElements())if("Rhythm"===e.localName)this.ho(e)}ho(t){const e=new js,s=t.getAttribute("id");e.id=s;for(const s of t.childElements())switch(s.localName){case"NoteValue":switch(s.innerText){case"Long":e.value=c.QuadrupleWhole;break;case"DoubleWhole":e.value=c.DoubleWhole;break;case"Whole":e.value=c.Whole;break;case"Half":e.value=c.Half;break;case"Quarter":e.value=c.Quarter;break;case"Eighth":e.value=c.Eighth;break;case"16th":e.value=c.Sixteenth;break;case"32nd":e.value=c.ThirtySecond;break;case"64th":e.value=c.SixtyFourth;break;case"128th":e.value=c.OneHundredTwentyEighth;break;case"256th":e.value=c.TwoHundredFiftySixth}break;case"PrimaryTuplet":e.tupletNumerator=qs.hh(s.getAttribute("num"),-1),e.tupletDenominator=qs.hh(s.getAttribute("den"),-1);break;case"AugmentationDot":e.dots=qs.hh(s.getAttribute("count"),0)}this.Ia.set(s,e)}qa(){for(let t=0,e=this.Ea.length;t<e;t++){const e=this.Ea[t];this.score.addMasterBar(e)}const t=this.Ea[this.Ea.length-1];this.aa.has(t)&&(this.aa.delete(t),t.isDoubleBar=!1);const e=[];for(const t of this.Pa){if(!t)continue;const s=this.Ca.get(t);this.score.addTrack(s),e.push(t)}let s;for(const t of this.Fa){let i=0,n=0;s=[v.C,N.Major],this.Hh.has(e[0])&&(s=[zt.transposeKey(s[0],this.Hh.get(e[0])),s[1]]);for(let r=0;r<t.length&&n<this.score.tracks.length;r++){const a=t[r];if(a!==qs.Sa){const t=this.Aa.get(a),r=this.score.tracks[n],h=r.staves[i];h.addBar(t);const o=h.bars.length-1;if(this.oa.has(o)&&(s=this.oa.get(o),this.Hh.has(e[n])&&(s=[zt.transposeKey(s[0],this.Hh.get(e[n])),s[1]])),t.keySignature=s[0],t.keySignatureType=s[1],this.aa.has(t.masterBar)&&(t.barLineRight=E.LightLight),this.Da.has(a))for(const e of this.Da.get(a))if(e!==qs.Sa){const s=this.La.get(e);if(t.addVoice(s),this.Wa.has(e))for(const t of this.Wa.get(e))if(t!==qs.Sa){const e=he.clone(this.Ra.get(t));s.addBeat(e);const i=this.Oa.get(t),n=this.Ia.get(i);if(e.duration=n.value,e.dots=n.dots,e.tupletNumerator=n.tupletNumerator,e.tupletDenominator=n.tupletDenominator,this.Ha.has(t))for(const s of this.Ha.get(t))if(s!==qs.Sa){const t=ie.clone(this.Ga.get(s));h.isPercussion?(t.fret=-1,t.string=-1):t.percussionArticulation=-1,e.addNote(t),this.Va.has(s)&&(e.tap=!0)}}}else{const e=new rt;t.addVoice(e);const s=new ee;s.isEmpty=!0,s.duration=c.Quarter,e.addBeat(s)}i===r.staves.length-1?(n++,i=0):i++,s=[v.C,N.Major],n<e.length&&this.Hh.has(e[n])&&(s=[zt.transposeKey(s[0],this.Hh.get(e[n])),s[1]])}else n++}}for(const t of this.Pa){if(!t)continue;const e=this.Ca.get(t);let s=!1;for(const t of e.staves)if(t.isPercussion){s=!0;break}if(s||(e.percussionArticulations=[]),this.va.has(t)){const s=this.va.get(t);for(const[t,i]of s)if(e.staves.length>0&&t<e.staves[0].bars.length){const s=e.staves[0].bars[t];if(s.voices.length>0&&s.voices[0].beats.length>0){const t=s.voices[0].beats[0];for(const e of i){e.type===n.Bank&&0===e.value&&0===s.index||t.automations.push(e)}}}}if(this.Na.has(t)){const s=this.Na.get(t);for(const[t,i]of s)if(e.staves.length>0&&t<e.staves[0].bars.length){e.staves[0].bars[t].sustainPedals=i}}}for(const[t,e]of this.Ma){const s=this.score.masterBars[t];for(let t=0,i=e.length;t<i;t++){const i=e[t];switch(i.type){case n.Tempo:s.tempoAutomations.push(i);break;case n.SyncPoint:i.syncPointValue.millisecondOffset-=this.Ja,s.addSyncPoint(i)}}}}}class Ys{isMultiRest=!1;trackViewGroups=[]}class Ks{showNumbered=!1;showSlash=!1;showStandardNotation=!1;showTablature=!1}class Qs{scoreViews=[];apply(t){if(this.scoreViews.length>0){let e=0;t.stylesheet.multiTrackMultiBarRest=this.scoreViews[0].isMultiRest;for(const s of this.scoreViews[0].trackViewGroups){if(e<t.tracks.length){const i=t.tracks[e];for(const t of i.staves)t.isPercussion||(t.showTablature=s.showTablature),t.showStandardNotation=s.showStandardNotation,t.showSlash=s.showSlash,t.showNumbered=s.showNumbered}e++}for(let s=1;s<this.scoreViews.length;s++)this.scoreViews[s].isMultiRest&&(t.stylesheet.perTrackMultiBarRest||(t.stylesheet.perTrackMultiBarRest=new Set),e=s-1,t.stylesheet.perTrackMultiBarRest.add(e))}}constructor(t){const e=Fe.fromBuffer(t),s=de.readInt32BE(e);for(let t=0;t<s;t++){const t=new Ys;this.scoreViews.push(t),t.isMultiRest=Vs.gpReadBool(e);const s=de.readInt32BE(e);for(let i=0;i<s;i++){let s=e.readByte();0===s&&(s=1);const i=new Ks;i.showStandardNotation=!!(1&s),i.showTablature=!!(2&s),i.showSlash=!!(4&s),i.showNumbered=!!(8&s),t.trackViewGroups.push(i)}}}static writeForScore(t){const e=Fe.withCapacity(128),s=[new Ys];s[0].isMultiRest=t.stylesheet.multiTrackMultiBarRest;for(const e of t.tracks){const i=new Ks;i.showStandardNotation=e.staves[0].showStandardNotation,i.showTablature=e.staves[0].showTablature,i.showSlash=e.staves[0].showSlash,i.showNumbered=e.staves[0].showNumbered,s[0].trackViewGroups.push(i);const n=new Ys;n.isMultiRest=!0===t.stylesheet.perTrackMultiBarRest?.has(e.index),n.trackViewGroups.push(i),s.push(n)}de.writeInt32BE(e,s.length);for(const t of s){e.writeByte(t.isMultiRest?1:0),de.writeInt32BE(e,t.trackViewGroups.length);for(const s of t.trackViewGroups){let t=0;s.showStandardNotation&&(t|=1),s.showTablature&&(t|=2),s.showSlash&&(t|=4),s.showNumbered&&(t|=8),e.writeByte(t)}}return de.writeInt32BE(e,1),e.toArray()}}class Zs{trackViewGroups=[]}class ti{isVisible=!1}!function(t){t[t.PageVertical=0]="PageVertical",t[t.PageGrid=1]="PageGrid",t[t.PageParchment=2]="PageParchment",t[t.ScreenVertical=3]="ScreenVertical",t[t.ScreenHorizontal=4]="ScreenHorizontal",t[t.PageHorizontal=5]="PageHorizontal"}(je||(je={}));class ei{zoomLevel=4;view=je.PageVertical;muiltiVoiceCursor=!1;scoreViews=[];constructor(t,e){const s=Fe.fromBuffer(e);this.zoomLevel=de.readInt32BE(s),this.view=s.readByte(),this.muiltiVoiceCursor=0!==s.readByte();const i=t.scoreViews.length;for(let e=0;e<i;e++){const i=new Zs;this.scoreViews.push(i);const n=t.scoreViews[e];for(let t=0;t<n.trackViewGroups.length;t++){const t=new ti;t.isVisible=0!==s.readByte(),i.trackViewGroups.push(t)}}}apply(t){if(this.scoreViews.length>0){let e=0;for(const s of this.scoreViews[0].trackViewGroups){if(e<t.tracks.length){t.tracks[e].isVisibleOnMultiTrack=s.isVisible}e++}}}static writeForScore(t){const e=Fe.withCapacity(128);de.writeInt32BE(e,4),e.writeByte(0);const s=t.tracks.length>0&&t.tracks[0].staves[0].bars[0].isMultiVoice;e.writeByte(s?255:0);for(const s of t.tracks)e.writeByte(s.isVisibleOnMultiTrack?255:0);for(const s of t.tracks)e.writeByte(255);return e.toArray()}}class si extends Ce{get name(){return"Guitar Pro 7-8"}readScore(){J.debug(this.name,"Loading ZIP entries");const t=new ks(this.data);let e;try{e=t.read()}catch(t){throw new Ee("No Zip archive",t)}J.debug(this.name,"Zip entries loaded");let s=null,i=null,n=null,r=null;const a=new Map;for(const t of e)switch(a.set(t.fullName,t),t.fileName){case"score.gpif":s=de.toString(t.data,this.settings.importer.encoding);break;case"BinaryStylesheet":i=t.data;break;case"PartConfiguration":n=t.data;break;case"LayoutConfiguration":r=t.data}if(!s)throw new Ee("No score.gpif found in zip archive");J.debug(this.name,"Start Parsing score.gpif");const h=new qs;h.loadAsset=t=>{if(a.has(t))return a.get(t).data},h.parseXml(s,this.settings),J.debug(this.name,"score.gpif parsed");const o=h.score;if(i){J.debug(this.name,"Start Parsing BinaryStylesheet");new zs(i).apply(o),J.debug(this.name,"BinaryStylesheet parsed")}let c=null;if(n&&(J.debug(this.name,"Start Parsing Part Configuration"),c=new Qs(n),c.apply(o),J.debug(this.name,"Part Configuration parsed")),r&&null!=c){J.debug(this.name,"Start Parsing Layout Configuration");new ei(c,r).apply(o),J.debug(this.name,"Layout Configuration parsed")}return o}}class ii extends I{constructor(){super(s.Format,"Unexpected end of data within reader")}}class ni{static oo=8;co=0;lo=ni.oo;uo;constructor(t){this.uo=t}readByte(){return this.readBits(8)}readBytes(t){const e=new Uint8Array(t);for(let s=0;s<t;s++)e[s]=255&this.readByte();return e}readBits(t){let e=0,s=t-1;for(;s>=0;)e|=this.readBit()<<s,s--;return e}readBitsReversed(t){let e=0;for(let s=0;s<t;s++)e|=this.readBit()<<s;return e}readBit(){if(this.lo>=8){if(this.co=this.uo.readByte(),-1===this.co)throw new ii;this.lo=0}const t=this.co>>ni.oo-this.lo-1&1;return this.lo++,t}readAll(){const t=Fe.empty();try{for(;;)t.writeByte(255&this.readByte())}catch(t){if(!(t instanceof ii))throw t}return t.toArray()}}class ri{fileName="";fileSize=0;data=null}class ai{static HeaderBcFs="BCFS";static HeaderBcFz="BCFZ";fileFilter;files=[];constructor(){this.files=[],this.fileFilter=t=>!0}load(t){const e=new ni(t);this.do(e)}readHeader(t){return this.fo(t.readBytes(4),0,4)}decompress(t,e=!1){const s=Fe.empty();let i;const n=this.po(t.readBytes(4),0);try{for(;s.length<n;){if(1===t.readBits(1)){const e=t.readBits(4),n=t.readBitsReversed(e),r=t.readBitsReversed(e),a=s.length-n,h=Math.min(n,r);i=s.getBuffer(),s.write(i,a,h)}else{const e=t.readBitsReversed(2);for(let i=0;i<e;i++)s.writeByte(t.readByte())}}}catch(t){if(!(t instanceof ii))throw t}i=s.getBuffer();const r=e?4:0,a=s.length-r,h=new Uint8Array(a),o=a;return h.set(i.subarray(r,r+o),0),h}do(t){const e=this.readHeader(t);if("BCFZ"===e)this.bo(this.decompress(t,!0));else{if("BCFS"!==e)throw new Ee("Unsupported format");this.bo(t.readAll())}}bo(t){const e=4096;let s=e;for(;s+3<t.length;){if(2===this.po(t,s)){const i=new ri;i.fileName=this.fo(t,s+4,127),i.fileSize=this.po(t,s+140);const n=!this.fileFilter||this.fileFilter(i.fileName);n&&this.files.push(i);const r=s+148;let a=0,h=0;const o=n?Fe.withCapacity(i.fileSize):null;for(;a=this.po(t,r+4*h++),0!==a;)s=a*e,n&&o.write(t,s,e);if(n){i.data=new Uint8Array(Math.min(i.fileSize,o.length));const t=o.toArray();i.data.set(t.subarray(0,0+i.data.length),0)}}s+=e}}fo(t,e,s){let i="";for(let n=0;n<s;n++){const s=255&t[e+n];if(0===s)break;i+=String.fromCharCode(s)}return i}po(t,e){return t[e+3]<<24|t[e+2]<<16|t[e+1]<<8|t[e]}}class hi extends Ce{get name(){return"Guitar Pro 6"}readScore(){J.debug(this.name,"Loading GPX filesystem");const t=new ai;t.fileFilter=t=>t.endsWith("score.gpif")||t.endsWith("BinaryStylesheet")||t.endsWith("PartConfiguration")||t.endsWith("LayoutConfiguration"),t.load(this.data),J.debug(this.name,"GPX filesystem loaded");let e=null,s=null,i=null,n=null;for(const r of t.files)switch(r.fileName){case"score.gpif":e=de.toString(r.data,this.settings.importer.encoding);break;case"BinaryStylesheet":s=r.data;break;case"PartConfiguration":i=r.data;break;case"LayoutConfiguration":n=r.data}if(!e)throw new Ee("No score.gpif found in GPX");J.debug(this.name,"Start Parsing score.gpif");const r=new qs;r.parseXml(e,this.settings),J.debug(this.name,"score.gpif parsed");const a=r.score;if(s){J.debug(this.name,"Start Parsing BinaryStylesheet");new zs(s).apply(a),J.debug(this.name,"BinaryStylesheet parsed")}let h=null;if(i&&(J.debug(this.name,"Start Parsing Part Configuration"),h=new Qs(i),h.apply(a),J.debug(this.name,"Part Configuration parsed")),n&&null!=h){J.debug(this.name,"Start Parsing Layout Configuration");new ei(h,n).apply(a),J.debug(this.name,"Layout Configuration parsed")}return a}}class oi{maxSteps=-1e3;maxStepsNote=null;minSteps=-1e3;minStepsNote=null}class ci{We;mo;static wo=7;static yo=[38,32,30,26,38];static ko=[0,1,2,3,4,5,6];So=new Map;Bo=new Map;_o=new Map;To=new Map;xo=new Map;maxStepsBeat=null;minStepsBeat=null;maxSteps=-1e3;minSteps=-1e3;constructor(t){this.mo=t,this.We=t.bar}static getPercussionSteps(t){return Jt.getArticulation(t)?.staffLine??0}static getNoteValue(t){return t.displayValue}applyAccidental(t){const e=ci.getNoteValue(t),s=t.hasQuarterToneOffset;return this.Mo(e,s,t.beat,!1,t)}applyAccidentalForValue(t,e,s,i){return this.Mo(e,s,t,i,null)}static computeStepsWithoutAccidentals(t,e){let s=0;const i=ci.getNoteValue(e);if(e.isPercussion)s=ci.getPercussionSteps(e);else{const n=zt.resolveSpelling(t.keySignature,i,e.accidentalMode);s=ci.calculateNoteSteps(t.clef,n)}return s}Mo(t,e,s,i,n=null){let r=0,a=T.None;if(null!=n&&n.isPercussion)r=ci.getPercussionSteps(n);else{const s=n?n.accidentalMode:p.Default,i=zt.resolveSpelling(this.We.keySignature,t,s);r=ci.calculateNoteSteps(this.We.clef,i);const h=this.So.has(r)?this.So.get(r):null;a=zt.computeAccidentalForSpelling(this.We.keySignature,s,i,e,h);let o=!1;switch(a){case T.NaturalQuarterNoteUp:case T.SharpQuarterNoteUp:case T.FlatQuarterNoteUp:break;default:if(n&&n.isTieDestination&&0===n.beat.index){const t=this.mo.scoreRenderer.layout?.getRendererForBar(this.mo.staff.staffId,n.tieOrigin.beat.voice.bar);if(t&&t.staff===this.mo.staff){t.accidentalHelper.getNoteSteps(n.tieOrigin)===r&&(o=!0)}}o&&(a=T.None)}!e&&a!==T.None&&this.So.set(r,i.accidentalOffset)}return n?(this.Bo.set(n.id,r),this.To.set(t,n)):this._o.set(t,r),(-1e3===this.minSteps||this.minSteps<r)&&(this.minSteps=r,this.minStepsBeat=s),(-1e3===this.maxSteps||this.maxSteps>r)&&(this.maxSteps=r,this.maxStepsBeat=s),i||this.vo(s,r,n),a}vo(t,e,s){let i;this.xo.has(t.id)?i=this.xo.get(t.id):(i=new oi,this.xo.set(t.id,i)),(-1e3===i.minSteps||e<i.minSteps)&&(i.minSteps=e,i.minStepsNote=s),(-1e3===i.minSteps||e>i.maxSteps)&&(i.maxSteps=e,i.maxStepsNote=s)}getMaxSteps(t){return this.xo.has(t.id)?this.xo.get(t.id).maxSteps:0}getMaxStepsNote(t){return this.xo.has(t.id)?this.xo.get(t.id).maxStepsNote:null}getMinSteps(t){return this.xo.has(t.id)?this.xo.get(t.id).minSteps:0}getMinStepsNote(t){return this.xo.has(t.id)?this.xo.get(t.id).minStepsNote:null}static calculateNoteSteps(t,e){const s=t;let i=ci.yo[s];return i-=e.octave*ci.wo,i-=ci.ko[e.degree],i}getNoteSteps(t){return this.Bo.get(t.id)}getNoteStepsForValue(t,e=!1){return this._o.has(t)?this._o.get(t):e&&this.To.has(t)?this.getNoteSteps(this.To.get(t)):0}}class li{slurStarts;currentDynamics=i.F;tieStarts;tieStartIds;slideOrigins=new Map;transpose=0;isExplicitlyBeamed=!1;constructor(){this.tieStarts=new Set,this.tieStartIds=new Map,this.slideOrigins=new Map,this.slurStarts=new Map}}class ui extends jt{outputMidiChannel=-1;outputMidiProgram=-1;outputMidiBank=-1;outputVolume=-1;outputBalance=-1}class di{track;firstArticulation;instruments=new Map;No=new Map;Po=0;Co=new Map;constructor(t){this.track=t}getLyricLine(t){if(this.Co.has(t))return this.Co.get(t);const e=this.Po;return this.Co.set(t,e),this.Po++,e}static Eo=jt.create(0,"Default",0,0,lt.NoteheadBlack,lt.NoteheadHalf,lt.NoteheadWhole);getOrCreateArticulation(t,e){const s=12*e.octave+e.tone,i=`${t}_${s}`;if(this.No.has(i))return this.No.get(i);let n;n=this.instruments.has(t)?this.instruments.get(t):di.Eo;const r=this.track.percussionArticulations.length,a=e.beat.voice.bar;let h;if(0===s)h=4;else{const t=zt.resolveSpelling(a.keySignature,s,p.Default);h=ci.calculateNoteSteps(a.clef,t)}const o=h-(9-(2*e.beat.voice.bar.staff.standardNotationLineCount-1)),c=jt.create(n.id,n.elementType,o,n.outputMidiNumber,n.noteHeadDefault,n.noteHeadHalf,n.noteHeadWhole,n.techniqueSymbol,n.techniqueSymbolPlacement);return this.No.set(i,r),this.track.percussionArticulations.push(c),r}}class fi extends Ce{De;Fo=new Map;Ao=new Map;Do=new Map;Lo;Wo;Oo=1;Ro=i.F;get name(){return"MusicXML"}readScore(){const t=this.Io(),e=new xs;try{e.parse(t)}catch(t){throw new Ee("Unsupported format",t)}return this.De=new Ht,this.De.stylesheet.hideDynamics=!0,this.jn(e),zt.consolidate(this.De),this.De.finish(this.settings),this.De.rebuildRepeatGroups(),this.De}Io(){const t=new ks(this.data);let e;try{e=t.read()}catch{e=[]}if(0===e.length)return this.data.reset(),de.toString(this.data.readAll(),this.settings.importer.encoding);const s=e.find(t=>"META-INF/container.xml"===t.fullName);if(!s)throw new Ee("No compressed MusicXML");const i=new xs;try{i.parse(de.toString(s.data,this.settings.importer.encoding))}catch(t){throw new Ee("Malformed container.xml, could not parse as XML",t)}const n=i.firstElement;if(!n||"container"!==n.localName)throw new Ee("Malformed container.xml, root element not 'container'");const r=n.findChildElement("rootfiles");if(!r)throw new Ee("Malformed container.xml, 'container/rootfiles' not found");let a="";for(const t of r.childElements())if("rootfile"===t.localName){a=t.getAttribute("full-path");break}if(!a)throw new Ee("Unsupported compressed MusicXML, missing rootfile");const h=e.find(t=>t.fullName===a);if(!h)throw new Ee(`Malformed container.xml, '${a}' not contained in zip`);return de.toString(h.data,this.settings.importer.encoding)}jn(t){const e=t.firstElement;if(!e)throw new Ee("Unsupported format");switch(e.localName){case"score-partwise":this.Go(e);break;case"score-timewise":this.Ho(e);break;default:throw new Ee("Unsupported format")}}Go(t){for(const e of t.childElements())switch(e.localName){case"credit":this.Vo(e);break;case"identification":this.$o(e);break;case"movement-title":this.Uo(e);break;case"part":this.zo(e);break;case"part-list":this.Xo(e);break;case"work":this.jo(e)}}Ho(t){let e=0;for(const s of t.childElements())switch(s.localName){case"credit":this.Vo(s);break;case"identification":this.$o(s);break;case"movement-title":this.Uo(s);break;case"part-list":this.Xo(s);break;case"work":this.jo(s);break;case"measure":this.Jo(s,e),e++}}Vo(t){if("1"!==t.getAttribute("page","1"))return;const e=[];let s=null,i="";for(const n of t.childElements())switch(n.localName){case"credit-type":e.push(n.innerText);break;case"credit-words":null===s&&(s=n),i+=n.innerText}if(e.length>0)for(const t of e)switch(t){case"title":this.De.title=fi.qo(i);break;case"subtitle":this.De.subTitle=fi.qo(i);break;case"composer":case"arranger":this.De.artist=fi.qo(i);break;case"lyricist":this.De.words=fi.qo(i);break;case"rights":this.De.copyright=fi.qo(i)}else if(s){const t=s.getAttribute("font-size","0"),e=s.getAttribute("font-size","top"),n=s.getAttribute("halign","left");if("top"===e){if(i.includes("copyright")||i.includes("Copyright")||i.includes("©")||i.includes("(c)")||i.includes("(C)"))return void(this.De.copyright=fi.qo(i));if("center"===n||"center"===t){if(0===this.De.title.length)return void(this.De.title=fi.qo(i));if(0===this.De.subTitle.length)return void(this.De.subTitle=fi.qo(i));if(0===this.De.album.length)return void(this.De.album=fi.qo(i))}else if(("right"===n||"right"===t)&&0===this.De.music.length)return void(this.De.music=fi.qo(i));if(0===this.De.artist.length)return void(this.De.artist=fi.qo(i));if(0===this.De.words.length)return void(this.De.words=fi.qo(i))}}}static qo(t){return t.replaceAll("\r","").replaceAll("\n"," ").replaceAll("\t","  ").replaceAll(" "," ")}$o(t){for(const e of t.childElements())switch(e.localName){case"creator":if(e.attributes.has("type"))switch(e.attributes.get("type")){case"composer":this.De.artist=fi.qo(e.innerText);break;case"lyricist":this.De.words=fi.qo(e.innerText);break;case"arranger":this.De.music=fi.qo(e.innerText)}else this.De.artist=fi.qo(e.innerText);break;case"rights":this.De.copyright.length>0&&(this.De.copyright+=", "),this.De.copyright+=e.innerText,e.attributes.has("type")&&(this.De.copyright+=` (${e.attributes.get("type")})`);break;case"encoding":this.Yo(e)}}Yo(t){for(const e of t.childElements())switch(e.localName){case"encoder":this.De.tab.length>0&&(this.De.tab+=", "),this.De.tab+=e.innerText,e.attributes.has("type")&&(this.De.tab+=` (${e.attributes.get("type")})`);break;case"encoding-description":this.De.notices+=fi.qo(e.innerText)}}Uo(t){0===this.De.title.length?this.De.title=fi.qo(t.innerText):this.De.subTitle=fi.qo(t.innerText)}Xo(t){for(const e of t.childElements())if("score-part"===e.localName)this.Ko(e)}Ko(t){const e=new Ne;e.ensureStaveCount(1),this.De.addTrack(e);const s=t.attributes.get("id"),i=new di(e);this.Fo.set(s,i),this.Ao.set(e.index,i);for(const s of t.childElements())switch(s.localName){case"part-name":e.name=fi.qo(s.innerText);break;case"part-name-display":e.name=this.Qo(s);break;case"part-abbreviation":e.shortName=fi.qo(s.innerText);break;case"part-abbreviation-display":e.shortName=this.Qo(s);break;case"score-instrument":this.Zo(s,i);break;case"midi-device":s.attributes.has("port")&&(e.playbackInfo.port=Number.parseInt(s.attributes.get("port"),10));break;case"midi-instrument":this.tc(s,i)}i.firstArticulation&&(i.firstArticulation.outputMidiProgram>=0&&(e.playbackInfo.program=i.firstArticulation.outputMidiProgram),i.firstArticulation.outputMidiBank>=0&&(e.playbackInfo.bank=i.firstArticulation.outputMidiBank),i.firstArticulation.outputBalance>=0&&(e.playbackInfo.balance=i.firstArticulation.outputBalance),i.firstArticulation.outputVolume>=0&&(e.playbackInfo.volume=i.firstArticulation.outputVolume),i.firstArticulation.outputMidiChannel>=0&&(e.playbackInfo.primaryChannel=i.firstArticulation.outputMidiChannel,e.playbackInfo.secondaryChannel=i.firstArticulation.outputMidiChannel))}Zo(t,e){const s=new ui;e.firstArticulation||(e.firstArticulation=s),e.instruments.set(t.getAttribute("id",""),s)}tc(t,e){const s=t.getAttribute("id","");if(!e.instruments.has(s))return;const i=e.instruments.get(s);for(const e of t.childElements())switch(e.localName){case"midi-channel":i.outputMidiChannel=Number.parseInt(e.innerText,10)-1;break;case"midi-bank":i.outputMidiBank=Number.parseInt(e.innerText,10)-1;break;case"midi-program":i.outputMidiProgram=Number.parseInt(e.innerText,10)-1;break;case"midi-unpitched":i.outputMidiNumber=Number.parseInt(e.innerText,10)-1;break;case"volume":i.outputVolume=fi.ec(Number.parseFloat(e.innerText));break;case"pan":i.outputBalance=fi.sc(Number.parseFloat(e.innerText))}i.id=Jt.tryMatchKnownArticulation(i),i.id<0&&(i.id=0)}static ec(t){return 0|fi.nc(0,100,0,16,t)}static sc(t){return 0|fi.nc(-90,90,0,16,t)}static nc(t,e,s,i,n){return s+(i-s)*((n-t)/(e-t))}Qo(t){let e="";for(const s of t.childElements())switch(s.localName){case"display-text":e+=s.innerText;break;case"accidental-text":switch(s.innerText){case"sharp":e+="♯";break;case"natural":e+="♮";break;case"flat":e+="♭";break;case"double-sharp":e+="𝄪";break;case"sharp-sharp":e+="♯♯";break;case"flat-flat":e+="𝄫";break;case"natural-sharp":e+="♮♯";break;case"natural-flat":e+="♮♭";break;case"sharp-down":e+="𝄱";break;case"sharp-up":e+="𝄰";break;case"natural-down":e+="𝄯";break;case"natural-up":e+="𝄮";break;case"flat-down":e+="𝄭";break;case"flat-up":e+="𝄬";break;case"arrow-down":e+="↓";break;case"arrow-up":e+="↑";break;case"triple-sharp":e+="♯𝄪";break;case"triple-flat":e+="𝄬𝄬𝄬";break;case"sharp-1":e+="♯¹";break;case"sharp-2":e+="♯²";break;case"sharp-3":e+="♯³";break;case"sharp-4":e+="♯⁴";break;case"sharp-5":e+="♯⁵";break;case"flat-1":e+="♭¹";break;case"flat-2":e+="♭²";break;case"flat-3":e+="♭³";break;case"flat-4":e+="♭⁴";break;case"flat-5":e+="♭⁵"}}return fi.qo(e)}jo(t){for(const e of t.childElements())if("work-title"===e.localName)this.De.title=fi.qo(e.innerText)}zo(t){const e=t.attributes.get("id");if(!e||!this.Fo.has(e))return;const s=this.Fo.get(e).track;let i=0;for(const e of t.childElements())if("measure"===e.localName)this.rc(e,s,i),i++;this.Lo=void 0}rc(t,e,s){const i=this.ac(t,s),n="yes"===t.attributes.get("implicit");this.hc(t,i,e,n,!0),this.Wo=void 0}Jo(t,e){const s=this.ac(t,e),i="yes"===t.attributes.get("implicit");for(const e of t.childElements())switch(e.localName){case"part":this.oc(e,s,i),this.Lo=void 0;break;case"print":this.cc(e,s,void 0,!0)}this.Wo=void 0}ac(t,e){const s="yes"===t.attributes.get("implicit");for(;this.De.masterBars.length<=e;){const t=new tt;s&&(t.isAnacrusis=!0),this.De.addMasterBar(t),t.index>0&&(t.timeSignatureDenominator=t.previousMasterBar.timeSignatureDenominator,t.timeSignatureNumerator=t.previousMasterBar.timeSignatureNumerator,t.tripletFeel=t.previousMasterBar.tripletFeel)}return this.De.masterBars[e]}oc(t,e,s){const i=t.attributes.get("id");if(!i||!this.Fo.has(i))return;const n=this.Fo.get(i).track;this.hc(t,e,n,s,!1)}lc=0;uc=null;hc(t,e,s,i,n){this.lc=0,this.uc=null,e.alternateEndings=this.dc;const r=[];for(const i of t.childElements())switch(i.localName){case"note":this.no(i,e,s);break;case"backup":this.fc(i);break;case"forward":this.bc(i);break;case"direction":this.mc(i,e,s);break;case"attributes":this.gc(i,e,s);break;case"harmony":this.wc(i,s);break;case"print":this.cc(i,e,s,!0);break;case"sound":this.Ih(i,e,s);break;case"barline":r.push(i)}for(const t of r)this.yc(t,e,s);this.kc(e,s);const a=this.Sc(s,0),h=this.Br(a,e);h.barNumberDisplay=i?O.Hide:n?this.Wo??this.Lo:this.Lo??this.Wo,this.Bc=null}cc(t,e,s,i){let n;void 0!==s&&("yes"===t.getAttribute("new-system","no")||"yes"===t.getAttribute("new-page","no"))&&s.addLineBreaks(e.index);for(const e of t.childElements())if("measure-numbering"===e.localName)switch(e.innerText){case"none":n=O.Hide;break;case"measure":n=O.AllBars;break;case"system":n=O.FirstOfSystem}i?this.Wo=n:this.Lo=n}kc(t,e){if(null!==this._c){for(const s of e.staves){const e=this.Br(s,t);e.simileMark=this._c,e.simileMark!==M.None&&this.Tc(e)}this._c===M.FirstOfDouble?this._c=M.SecondOfDouble:this._c=null}if(null!==this.xc){const s=Array.from(this.xc.keys());for(const i of s){const s=this.Sc(e,i),n=this.Br(s,t);n.simileMark=this.xc.get(i),n.simileMark!==M.None&&this.Tc(n),n.simileMark===M.FirstOfDouble?this.xc.set(i,M.SecondOfDouble):this.xc.delete(i)}0===this.xc.size&&(this.xc=null)}}Tc(t){for(const e of t.voices){const t=new ee;t.isEmpty=!0,e.addBeat(t)}}yc(t,e,s){for(const i of t.childElements())switch(i.localName){case"bar-style":this.Mc(i,e,s,t.getAttribute("location","right"));break;case"ending":this.vc(i,e);break;case"repeat":this.Nc(i,e)}}Nc(t,e){const s=t.getAttribute("direction");let i=Number.parseInt(t.getAttribute("times"),10);(i<0||Number.isNaN(i))&&(i=2),"backward"===s?e.repeatCount=i:"forward"===s&&(e.isRepeatStart=!0)}dc=0;vc(t,e){const s=t.getAttribute("number").split(",").map(t=>Number.parseInt(t,10));let i=0;for(const t of s)i|=1<<t-1&255;switch(e.alternateEndings=i,t.getAttribute("type","")){case"start":this.dc=this.dc|i;break;case"stop":case"discontinue":this.dc=this.dc&~i}}Mc(t,e,s,i){let n=E.Automatic;switch(t.innerText){case"dashed":n=E.Dashed;break;case"dotted":n=E.Dotted;break;case"heavy":n=E.Heavy;break;case"heavy-heavy":n=E.HeavyHeavy;break;case"heavy-light":n=E.HeavyLight;break;case"light-heavy":n=E.LightHeavy;break;case"light-light":n=E.LightLight;break;case"none":n=E.None;break;case"regular":n=E.Regular;break;case"short":n=E.Short;break;case"tick":n=E.Tick}for(const t of s.staves){const s=this.Br(t,e);switch(i){case"left":s.barLineLeft=n;break;case"right":s.barLineRight=n}}}Ih(t,e,s){for(const s of t.childElements())switch(s.localName){case"midi-instrument":this.Pc(s,e);break;case"swing":this.Cc(s,e)}if(t.attributes.has("coda")&&e.addDirection(ze.TargetCoda),t.attributes.has("tocoda")&&e.addDirection(ze.JumpDaCoda),t.attributes.has("dacapo")&&e.addDirection(ze.JumpDaCapo),t.attributes.has("dalsegno")&&e.addDirection(ze.JumpDalSegno),t.attributes.has("fine")&&e.addDirection(ze.TargetFine),t.attributes.has("segno")&&e.addDirection(ze.TargetSegno),t.attributes.has("pan")){this.Ec||(this.Ec=[]);const e=new $;e.type=n.Balance,e.value=fi.sc(Number.parseFloat(t.attributes.get("pan"))),this.Ec.push(e)}if(t.attributes.has("tempo")){this.Ec||(this.Ec=[]);const e=new $;e.type=n.Tempo,e.value=fi.ec(Number.parseFloat(t.attributes.get("tempo"))),this.Ec.push(e)}}Cc(t,e){let s=0,i=0,n=null;for(const r of t.childElements())switch(r.localName){case"straight":return void(e.tripletFeel=F.NoTripletFeel);case"first":s=Number.parseInt(r.innerText,10);break;case"second":i=Number.parseInt(r.innerText,10);break;case"swing-type":n=this.Fc(r)}n||(n=c.Eighth),n===c.Eighth?2===s&&1===i?e.tripletFeel=F.Triplet8th:3===s&&1===i?e.tripletFeel=F.Dotted8th:1===s&&3===i&&(e.tripletFeel=F.Scottish8th):n===c.Sixteenth&&(2===s&&1===i?e.tripletFeel=F.Triplet16th:3===s&&1===i?e.tripletFeel=F.Dotted16th:1===s&&3===i&&(e.tripletFeel=F.Scottish16th))}Ec=null;Ac=null;Dc=null;Lc=!1;Wc=!1;Oc=null;Rc=null;Pc(t,e){let s;for(const e of t.childElements())switch(e.localName){case"midi-bank":this.Ec||(this.Ec=[]),s=new $,s.type=n.Bank,s.value=Number.parseInt(e.innerText,10)-1,this.Ec.push(s);break;case"midi-program":this.Ec||(this.Ec=[]),s=new $,s.type=n.Instrument,s.value=Number.parseInt(e.innerText,10)-1,this.Ec.push(s);break;case"volume":this.Ec||(this.Ec=[]),s=new $,s.type=n.Volume,s.value=fi.ec(Number.parseFloat(e.innerText)),this.Ec.push(s);break;case"pan":this.Ec||(this.Ec=[]),s=new $,s.type=n.Balance,s.value=fi.sc(Number.parseFloat(e.innerText)),this.Ec.push(s)}}wc(t,e){const s=new we;let i=!1,n="";for(const e of t.childElements())switch(e.localName){case"root":s.name=this.Ic(e);break;case"kind":s.name=s.name+this.Gc(e),"yes"===e.getAttribute("parentheses-degrees","no")&&(i=!0);break;case"frame":this.Hc(e,s);break;case"degree":n+=this.Vc(e)}n&&(s.name+=i?`(${n})`:n),"yes"===t.getAttribute("print-frame","no")&&(s.showDiagram=!0,this.De.stylesheet.globalDisplayChordDiagramsInScore=!0),"yes"===t.getAttribute("print-object","yes")&&(s.showDiagram=!0),null===this.Ac&&(this.Ac=s)}Vc(t){let e="",s="",i="";for(const n of t.childElements())switch(n.localName){case"degree-value":e=n.innerText;break;case"degree-alter":switch(n.innerText){case"-1":s="♭";break;case"1":s="♯"}break;case"degree-type":i+=n.getAttribute("text","")}return`${i}${s}${e}`}Ic(t){let e="",s="";for(const i of t.childElements())switch(i.localName){case"root-step":e=i.innerText;break;case"root-alter":switch(Number.parseFloat(i.innerText)){case-2:s="bb";break;case-1:s="b";break;case 0:s="";break;case 1:s="#";break;case 2:s="##"}}return e+s}Gc(t){const e=t.getAttribute("text");let s="";if(e)s=e;else{const e=t.innerText;switch(e){case"major":s="";break;case"minor":s="m";break;case"augmented":s="+";break;case"diminished":s="○";break;case"dominant":s="7";break;case"major-seventh":s="7M";break;case"minor-seventh":s="m7";break;case"diminished-seventh":s="○7";break;case"augmented-seventh":s="+7";break;case"half-diminished":s="⍉";break;case"major-minor":s="mMaj";break;case"major-sixth":s="maj6";break;case"minor-sixth":s="m6";break;case"dominant-ninth":s="9";break;case"major-ninth":s="maj9";break;case"minor-ninth":s="m9";break;case"dominant-11th":s="11";break;case"major-11th":s="maj11";break;case"minor-11th":s="m11";break;case"dominant-13th":s="13";break;case"major-13th":s="maj13";break;case"minor-13th":s="m13";break;case"suspended-second":s="sus2";break;case"suspended-fourth":s="sus4";break;case"Neapolitan":s="♭II";break;case"Italian":s="It⁺⁶";break;case"French":case"German":s="Fr⁺⁶";break;default:s=e}}return s}Hc(t,e){for(const s of t.childElements())switch(s.localName){case"frame-strings":const t=Number.parseInt(s.innerText,10);e.strings=new Array(t);for(let s=0;s<t;s++)e.strings[s]=-1;break;case"first-fret":e.firstFret=Number.parseInt(s.innerText,10);break;case"frame-note":let i=null,n=null;for(const t of s.childElements())switch(t.localName){case"string":i=Number.parseInt(t.innerText,10);break;case"fret":n=Number.parseInt(t.innerText,10),i&&n>=0&&(e.strings[i-1]=n);break;case"barre":i&&n&&"start"===t.getAttribute("type")&&e.barreFrets.push(n)}}}gc(t,e,s){let i,n,r;if(null==this.uc)for(const a of t.childElements())switch(a.localName){case"divisions":this.Oo=Number.parseFloat(a.innerText);break;case"key":this.$c(a,e,s);break;case"time":this.wr(a,e);break;case"staves":s.ensureStaveCount(Number.parseInt(a.innerText,10));break;case"clef":i=Number.parseInt(a.getAttribute("number","1"),10)-1,n=this.Sc(s,i),r=this.Br(n,e),this.lr(a,r);break;case"staff-details":i=Number.parseInt(a.getAttribute("number","1"),10)-1,n=this.Sc(s,i),this.Uc(a,n);break;case"transpose":this.Bh(a,s);break;case"measure-style":this.zc(a,s,!1)}else for(const e of t.childElements())switch(e.localName){case"divisions":this.Oo=Number.parseFloat(e.innerText);break;case"measure-style":this.zc(e,s,!0)}}_c=null;xc=null;Xc=!1;zc(t,e,s){for(const e of t.childElements())switch(e.localName){case"measure-repeat":if(!s){let s=null;switch(e.getAttribute("type")){case"start":switch(Number.parseInt(e.getAttribute("slashes","1"),10)){case 1:s=M.Simple;break;case 2:s=M.FirstOfDouble}break;case"stop":s=null}if(t.attributes.has("number")){this.xc=this.xc??new Map;const e=Number.parseInt(t.attributes.get("number"),10)-1;null==s?this.xc.delete(e):this.xc.set(e,s)}else this._c=s}break;case"slash":switch(e.getAttribute("type")){case"start":this.Xc=!0;break;case"stop":this.Xc=!1}}}Bh(t,e){let s=0;for(const e of t.childElements())switch(e.localName){case"chromatic":s+=Number.parseFloat(e.innerText);break;case"octave-change":s+=12*Number.parseFloat(e.innerText)}if(t.attributes.has("number")){const i=this.Sc(e,Number.parseInt(t.attributes.get("number"),10)-1);this.jc(i).transpose=s,i.displayTranspositionPitch=s}else for(const t of e.staves)this.jc(t).transpose=s,t.displayTranspositionPitch=s}Uc(t,e){for(const s of t.childElements())switch(s.localName){case"staff-lines":e.standardNotationLineCount=Number.parseInt(s.innerText,10);break;case"staff-tuning":this.Jc(s,e);break;case"capo":e.capo=Number.parseInt(s.innerText,10)}}Jc(t,e){0===e.stringTuning.tunings.length&&(e.showTablature=!0,e.showStandardNotation=!1,e.stringTuning.tunings=new Array(e.standardNotationLineCount).fill(0));const s=Number.parseInt(t.getAttribute("line"),10);let i="C",n="",r=0;for(const e of t.childElements())switch(e.localName){case"tuning-step":i=e.innerText;break;case"tuning-alter":r=Number.parseFloat(e.innerText);break;case"tuning-octave":n=e.innerText}const a=zt.getTuningForText(i+n)+r;e.tuning[e.tuning.length-s]=a}lr(t,e){let s="s",i=0;for(const n of t.childElements())switch(n.localName){case"sign":s=n.innerText.toLowerCase();break;case"line":i=Number.parseInt(n.innerText,10);break;case"clef-octave-change":switch(Number.parseInt(n.innerText,10)){case-2:e.clefOttava=b.M;break;case-1:e.clefOttava=b.T;break;case 1:e.clefOttava=b._;break;case 2:e.clefOttava=b.M}}switch(s){case"g":default:e.clef=x.G2;break;case"f":e.clef=x.F4;break;case"c":e.clef=3===i?x.C3:x.C4;break;case"percussion":e.clef=x.Neutral,e.staff.isPercussion=!0;break;case"tab":e.clef=x.G2,e.staff.showTablature=!0}}wr(t,e){let s=!1,i=!1;for(const n of t.childElements()){const t=n.innerText;switch(n.localName){case"beats":s||(-1===t.indexOf("+")?e.timeSignatureNumerator=Number.parseInt(t,10):e.timeSignatureNumerator=t.split("+").map(t=>Number.parseInt(t,10)).reduce((t,e)=>e+t,0),s=!0);break;case"beat-type":i||(-1===t.indexOf("+")?e.timeSignatureDenominator=Number.parseInt(t,10):e.timeSignatureDenominator=t.split("+").map(t=>Number.parseInt(t,10)).reduce((t,e)=>e+t,0),i=!0)}}switch(t.getAttribute("symbol","")){case"common":case"cut":e.timeSignatureCommon=!0}}Bc=null;$c(t,e,s){let i,n,r=-v.C,a="";for(const e of t.childElements())switch(e.localName){case"fifths":r=Number.parseInt(e.innerText,10);break;case"mode":a=e.innerText}if(i=-7<=r&&r<=7?r:v.C,n="minor"===a?N.Minor:N.Major,t.attributes.has("number")){const r=this.Sc(s,Number.parseInt(t.attributes.get("number"),10)-1),a=this.Br(r,e);a.keySignature=i,a.keySignatureType=n}else{this.Bc=[i,n];for(const t of s.staves)t.bars.length>e.index&&(t.bars[e.index].keySignature=i,t.bars[e.index].keySignatureType=n)}}mc(t,e,s){const i=[];let r=null,a=-1,h=-1;for(const e of t.childElements())switch(e.localName){case"direction-type":const t=e.firstElement;t&&i.push(t);break;case"offset":r=Number.parseFloat(e.innerText);break;case"voice":break;case"staff":a=Number.parseInt(e.innerText,10)-1;break;case"sound":e.attributes.has("tempo")&&(h=Number.parseFloat(e.attributes.get("tempo")))}let c=null;c=a>=0?this.Sc(s,a):null!==this.uc?this.uc.voice.bar.staff:this.Sc(s,0);const l=c?this.Br(c,e):null,u=()=>{let t=this.lc;null!==r&&(t+=r);return t/e.calculateDuration(!1)};if(h>0){const t=new $;t.type=n.Tempo,t.value=h,t.ratioPosition=u(),this.qc(e,t)||e.tempoAutomations.push(t)}let d="";for(const t of i)switch(t.localName){case"rehearsal":e.section=new _e,e.section.marker=t.innerText;break;case"segno":e.addDirection(ze.TargetSegno);break;case"coda":e.addDirection(ze.TargetCoda);break;case"words":d=t.innerText;break;case"wedge":switch(t.getAttribute("type")){case"crescendo":this.Dc=o.Crescendo;break;case"diminuendo":this.Dc=o.Decrescendo;break;case"stop":this.Dc=null}break;case"dynamics":const s=this.Yc(t);null!==s&&(this.Ro=s,this.De.stylesheet.hideDynamics=!1);break;case"dashes":const i=t.getAttribute("type","start");switch(d){case"LetRing":this.Lc="start"===i||"continue"===i;break;case"P.M.":this.Wc="start"===i||"continue"===i}d="";break;case"pedal":const n=this.Kc(t);if(n&&l){n.ratioPosition=u();const t=l.sustainPedals.length>0&&l.sustainPedals[l.sustainPedals.length-1].pedalType!==P.Up;(n.pedalType!==P.Up||t)&&l.sustainPedals.push(n)}break;case"metronome":this.Qc(t,e,u());break;case"octave-shift":this.Oc=this.Zc(t)}d&&(this.Rc=d)}Zc(t){const e=t.getAttribute("type");switch(Number.parseInt(t.getAttribute("size","8"),10)){case 15:switch(e){case"up":return b.M;case"down":return b.S;case"stop":return b.Regular;case"continue":return this.Oc}break;case 8:switch(e){case"up":return b.T;case"down":return b._;case"stop":return b.Regular;case"continue":return this.Oc}}return null}Qc(t,e,s){let i=null,r=-1;for(const e of t.childElements())switch(e.localName){case"beat-unit":i=this.Fc(e);break;case"per-minute":r=Number.parseFloat(e.innerText)}if(null!==i&&r>0){const t=new $;t.type=n.Tempo,t.value=r*(i/4),t.ratioPosition=s,this.qc(e,t)||e.tempoAutomations.push(t)}}qc(t,e){for(const s of t.tempoAutomations)if(e.ratioPosition===s.ratioPosition&&e.value===s.value)return!0;return!1}Kc(t){const e=new Y;switch(t.getAttribute("type")){case"start":e.pedalType=P.Down;break;case"stop":e.pedalType=P.Up;break;case"continue":e.pedalType=P.Hold;break;default:return null}return e}Yc(t){for(const e of t.childElements()){const t=e.localName.toUpperCase();switch(t){case"PPP":case"PP":case"P":case"MP":case"MF":case"F":case"FF":case"FFF":case"PPPP":case"PPPPP":case"PPPPPP":case"FFFF":case"FFFFF":case"FFFFFF":case"SF":case"SFP":case"SFPP":case"FP":case"RF":case"RFZ":case"SFZ":case"SFFZ":case"FZ":case"N":case"PF":case"SFZP":return i[t]}}return null}bc(t){for(const e of t.childElements())if("duration"===e.localName)this.lc+=this.tl(Number.parseFloat(e.innerText))}fc(t){for(const e of t.childElements())if("duration"===e.localName){if(this.uc){let t=this.lc;t-=this.tl(Number.parseFloat(e.innerText)),t<0&&(t=0),this.lc=t}}}Sc(t,e){for(;t.staves.length<=e;){const e=new xe;t.addStaff(e),this.De.masterBars.length>0&&this.Br(e,this.De.masterBars[this.De.masterBars.length-1])}return t.staves[e]}Br(t,e){const s=0===t.bars.length?1:t.bars[0].voices.length;for(;t.bars.length<=e.index;){const e=new Q;t.addBar(e),e.previousBar&&(e.clef=e.previousBar.clef,e.clefOttava=e.previousBar.clefOttava,e.keySignature=e.previousBar.keySignature,e.keySignatureType=e.previousBar.keySignatureType),null!=this.Bc&&(e.keySignature=this.Bc[0],e.keySignatureType=this.Bc[1]);for(let t=0;t<s;t++){const t=new rt;e.addVoice(t)}}return t.bars[e.index]}el(t,e){let s=!1;for(;t.voices.length<=e;)t.addVoice(new rt),s=!0;if(s)for(const s of t.staff.bars)for(;s.voices.length<=e;)s.addVoice(new rt);return t.voices[e]}no(t,e,s){let i=null,n=l.None,r=0,a=null,h=!1,o=0,u=0,d=-1,f=null,p=0,b=-1,m=-1,g=null,w=null,y=!1,k=null;const S="no"!==t.getAttribute("print-object","yes"),B=()=>{if(null!==i)return;h&&!this.uc&&(J.warning("MusicXML","Malformed MusicXML, <chord /> cannot be set on the first note of a measure"),h=!1),h&&!w&&(J.warning("MusicXML","Cannot mix <chord /> and <rest />"),h=!1);const t=this.Sc(s,o);if(h)return i=this.uc,void i.addNote(w);const B=this.Br(t,e),_=this.el(B,u),T=0===_.beats.length?0:_.beats[_.beats.length-1].displayEnd;let x=this.lc-T;if(x>0){if(this.uc&&this.uc.beamingMode===St.ForceMergeWithNext&&this.uc.voice.bar.staff.index!==o&&_.beats.length>0&&_.beats[_.beats.length-1].beamingMode===St.ForceMergeWithNext){const t=_.beats[_.beats.length-1].duration;for(;x>0;){const e=this.sl(x,t);if(null===e)break;this.il(e,_),x-=e.playbackDuration}}if(x>0){const t=new ee;t.dynamics=this.Ro,t.isEmpty=!0,t.duration=c.TwoHundredFiftySixth,t.overrideDisplayDuration=x,t.updateDurations(),this.il(t,_)}}else x<0&&J.error("MusicXML","Unsupported forward/backup detected. Cannot fill new beats into already filled area of voice");d<0&&null!==f&&(d=H.toTicks(f),p>0&&(d=H.applyDot(d,2===p)));const M=new ee;i=M,null===a?M.beamingMode=this.jc(t).isExplicitlyBeamed?St.ForceSplitToNext:St.Auto:(M.beamingMode=a,this.jc(t).isExplicitlyBeamed=!0),M.isEmpty=!1,M.dynamics=this.Ro,this.Xc&&(M.slashed=!0);const v=this.Ec;if(this.Ec=null,null!==v)for(const t of v)M.automations.push(t);const N=this.Ac;this.Ac=null,null!==N&&(M.chordId=N.uniqueId,_.bar.staff.hasChord(N.uniqueId)||_.bar.staff.addChord(M.chordId,N));const P=this.Dc;null!==P&&(M.crescendo=P);const C=this.Oc;if(null!==C&&(M.ottava=C),M.isLetRing=this.Lc,M.isPalmMute=this.Wc,this.Rc&&(M.text=this.Rc,this.Rc=null),null!==w&&M.addNote(w),this.il(M,_),null!==w){w.isVisible=S;const t=this.Ao.get(s.index);null!==k?w.percussionArticulation=t.getOrCreateArticulation(k,w):y||(w.percussionArticulation=t.getOrCreateArticulation("",w))}n!==l.None?(M.graceType=n,this.nl(M,r,null,!1)):(M.tupletNumerator=b,M.tupletDenominator=m,M.dots=p,M.preferredBeamDirection=g,this.nl(M,d,f,!0)),this.lc=M.displayEnd,this.uc=M};for(const e of t.childElements())switch(e.localName){case"grace":const t=Number.parseFloat(e.getAttribute("make-time","-1"));t>=0?(r=this.tl(t),n=l.BeforeBeat):n=l.OnBeat,"yes"===e.getAttribute("slash")&&(n=l.BeforeBeat);break;case"chord":h=!0;break;case"cue":return;case"pitch":w=this.rl(e),y=!0;break;case"unpitched":w=this.al(e,s);break;case"rest":w=null,null===f&&(f=c.Whole);break;case"duration":d=this.Fi(e);break;case"instrument":k=e.getAttribute("id","");break;case"voice":u=Number.parseInt(e.innerText,10),Number.isNaN(u)?(J.warning("MusicXML","Voices need to be specified as numbers"),u=0):u-=1;break;case"type":f=this.Fc(e);break;case"dot":p++;break;case"accidental":null===w?J.warning("MusicXML","Malformed MusicXML, missing pitch or unpitched for note"):this.hl(e,w);break;case"time-modification":for(const t of e.childElements())switch(t.localName){case"actual-notes":b=Number.parseInt(t.innerText,10);break;case"normal-notes":m=Number.parseInt(t.innerText,10)}break;case"stem":g=this.ol(e);break;case"notehead":null===w?J.warning("MusicXML","Malformed MusicXML, missing pitch or unpitched for note"):this.cl(e,w,f??c.Quarter,g??this.ll(w));break;case"staff":o=Number.parseInt(e.innerText,10)-1;break;case"beam":if("1"===e.getAttribute("number","1"))switch(e.innerText){case"begin":case"continue":a=St.ForceMergeWithNext;break;case"end":a=St.ForceSplitToNext}break;case"notations":B(),this.ul(e,w,i);break;case"lyric":B(),this.Lr(e,i,s);break;case"play":this.dl(e,w)}if(y){const t=this.Sc(s,o),e=this.jc(t).transpose;if(0!==e){const t=12*w.octave+w.tone+e;w.octave=t/12|0,w.tone=t-12*w.octave}}B()}dl(t,e){for(const s of t.childElements())if("mute"===s.localName)e&&"palm"===s.innerText&&(e.isPalmMute=!0)}static fl=71;ll(t){return t.calculateRealValue(!1,!1)<fi.fl?Wt.Down:Wt.Up}cl(t,e,s,i){"yes"===t.getAttribute("parentheses","no")&&(e.isGhost=!0);const n=t.getAttribute("filled","");let r;switch("yes"===n?r=!0:"no"===n&&(r=!1),e.style=new Yt,t.innerText){case"arrow down":e.style.noteHeadCenterOnStem=!0,this.pl(e,s,r,lt.NoteheadTriangleDownDoubleWhole,lt.NoteheadTriangleDownWhole,lt.NoteheadTriangleDownHalf,lt.NoteheadTriangleDownBlack);break;case"arrow up":e.style.noteHeadCenterOnStem=!0,this.pl(e,s,r,lt.NoteheadTriangleUpDoubleWhole,lt.NoteheadTriangleUpWhole,lt.NoteheadTriangleUpHalf,lt.NoteheadTriangleUpBlack);break;case"back slashed":this.pl(e,s,r,lt.NoteheadSlashedDoubleWhole2,lt.NoteheadSlashedWhole2,lt.NoteheadSlashedHalf2,lt.NoteheadSlashedBlack2);break;case"circle dot":e.style.noteHead=lt.NoteheadRoundWhiteWithDot;break;case"circle-x":this.pl(e,s,r,lt.NoteheadCircleXDoubleWhole,lt.NoteheadCircleXWhole,lt.NoteheadCircleXHalf,lt.NoteheadCircleX);break;case"circled":this.pl(e,s,r,lt.NoteheadCircledDoubleWhole,lt.NoteheadCircledWhole,lt.NoteheadCircledHalf,lt.NoteheadCircledBlack);break;case"cluster":this.pl(e,s,r,lt.NoteheadClusterDoubleWhole3rd,lt.NoteheadClusterWhole3rd,lt.NoteheadClusterHalf3rd,lt.NoteheadClusterQuarter3rd);break;case"cross":this.pl(e,s,r,lt.NoteheadPlusDoubleWhole,lt.NoteheadPlusWhole,lt.NoteheadPlusHalf,lt.NoteheadPlusBlack);break;case"diamond":this.pl(e,s,r,lt.NoteheadDiamondDoubleWhole,lt.NoteheadDiamondWhole,lt.NoteheadDiamondHalf,lt.NoteheadDiamondBlack);break;case"do":this.pl(e,s,r,lt.NoteShapeTriangleUpWhite,lt.NoteShapeTriangleUpWhite,lt.NoteShapeTriangleUpWhite,lt.NoteShapeTriangleUpBlack);break;case"fa":i===Wt.Up?this.pl(e,s,r,lt.NoteShapeTriangleRightWhite,lt.NoteShapeTriangleRightWhite,lt.NoteShapeTriangleRightWhite,lt.NoteShapeTriangleRightBlack):this.pl(e,s,r,lt.NoteShapeTriangleLeftWhite,lt.NoteShapeTriangleLeftWhite,lt.NoteShapeTriangleLeftWhite,lt.NoteShapeTriangleLeftBlack);break;case"fa up":this.pl(e,s,r,lt.NoteShapeTriangleLeftWhite,lt.NoteShapeTriangleLeftWhite,lt.NoteShapeTriangleLeftWhite,lt.NoteShapeTriangleLeftBlack);break;case"inverted triangle":this.pl(e,s,r,lt.NoteheadTriangleDownDoubleWhole,lt.NoteheadTriangleDownWhole,lt.NoteheadTriangleDownHalf,lt.NoteheadTriangleDownBlack);break;case"la":case"square":this.pl(e,s,r,lt.NoteShapeSquareWhite,lt.NoteShapeSquareWhite,lt.NoteShapeSquareWhite,lt.NoteShapeSquareBlack);break;case"left triangle":this.pl(e,s,r,lt.NoteheadTriangleRightWhite,lt.NoteheadTriangleRightWhite,lt.NoteheadTriangleRightWhite,lt.NoteheadTriangleRightBlack);break;case"mi":this.pl(e,s,r,lt.NoteShapeDiamondWhite,lt.NoteShapeDiamondWhite,lt.NoteShapeDiamondWhite,lt.NoteShapeDiamondBlack);break;case"none":e.style.noteHead=lt.NoteheadNull;break;case"normal":this.pl(e,s,r,lt.NoteheadDoubleWhole,lt.NoteheadWhole,lt.NoteheadHalf,lt.NoteheadBlack);break;case"re":this.pl(e,s,r,lt.NoteShapeMoonWhite,lt.NoteShapeMoonWhite,lt.NoteShapeMoonWhite,lt.NoteShapeMoonBlack);break;case"rectangle":this.pl(e,s,r,lt.NoteheadSquareWhite,lt.NoteheadSquareWhite,lt.NoteheadSquareWhite,lt.NoteheadSquareBlack);break;case"slash":this.pl(e,s,r,lt.NoteheadSlashWhiteWhole,lt.NoteheadSlashWhiteWhole,lt.NoteheadSlashWhiteHalf,lt.NoteheadSlashHorizontalEnds);break;case"slashed":this.pl(e,s,r,lt.NoteheadSlashedDoubleWhole1,lt.NoteheadSlashedWhole1,lt.NoteheadSlashedHalf1,lt.NoteheadSlashedBlack1);break;case"so":this.pl(e,s,r,lt.NoteShapeRoundWhite,lt.NoteShapeRoundWhite,lt.NoteShapeRoundWhite,lt.NoteShapeRoundBlack);break;case"ti":this.pl(e,s,r,lt.NoteShapeTriangleRoundWhite,lt.NoteShapeTriangleRoundWhite,lt.NoteShapeTriangleRoundWhite,lt.NoteShapeTriangleRoundBlack);break;case"triangle":this.pl(e,s,r,lt.NoteheadTriangleUpDoubleWhole,lt.NoteheadTriangleUpWhole,lt.NoteheadTriangleUpHalf,lt.NoteheadTriangleUpBlack);break;case"x":this.pl(e,s,r,lt.NoteheadXDoubleWhole,lt.NoteheadXWhole,lt.NoteheadXHalf,lt.NoteheadXBlack)}}sl(t,e){let s=H.toTicks(e);for(;s>t;){if(e===c.TwoHundredFiftySixth)return null;e*=2,s=H.toTicks(e)}const i=new ee;return i.dynamics=this.Ro,i.isEmpty=!1,i.duration=e,i.overrideDisplayDuration=s,i.updateDurations(),i}il(t,e){if(e.beats.length>0){const s=e.beats[e.beats.length-1];s.nextBeat=t,t.previousBeat=s;let i=s;for(;null!==i&&i.graceType!==l.None;)i=i.index>0?i.previousBeat:null;null!==i&&(t.displayStart=i.displayEnd)}e.addBeat(t)}tl(t){return t*H.QuarterTime/this.Oo}Fc(t){switch(t.innerText){case"1024th":case"512th":case"256th":return c.TwoHundredFiftySixth;case"128th":return c.OneHundredTwentyEighth;case"64th":return c.SixtyFourth;case"32nd":return c.ThirtySecond;case"16th":return c.Sixteenth;case"eighth":return c.Eighth;case"quarter":return c.Quarter;case"half":return c.Half;case"whole":return c.Whole;case"breve":return c.DoubleWhole;case"long":return c.QuadrupleWhole}return null}static bl=[c.TwoHundredFiftySixth,c.OneHundredTwentyEighth,c.SixtyFourth,c.ThirtySecond,c.Sixteenth,c.Eighth,c.Quarter,c.Half,c.Whole,c.DoubleWhole,c.QuadrupleWhole];static ml=fi.bl.map(t=>H.toTicks(t));nl(t,e,s,i){if(!s)for(let t=0;t<fi.bl.length;t++){if(!(e>=fi.ml[t]))break;s=fi.bl[t]}t.duration=s??c.Sixteenth,i&&(t.overrideDisplayDuration=e),t.updateDurations()}Lr(t,e,s){const i=this.Ao.get(s.index).getLyricLine(t.getAttribute("number",""));for(null===e.lyrics&&(e.lyrics=[]);e.lyrics.length<=i;)e.lyrics.push("");for(const s of t.childElements())switch(s.localName){case"text":e.lyrics[i]?e.lyrics[i]+=` ${s.innerText}`:e.lyrics[i]=s.innerText;break;case"elision":e.lyrics[i]+=s.innerText}}ul(t,e,s){for(const i of t.childElements())switch(i.localName){case"tied":e&&this.gl(i,e,s.voice.bar.staff);break;case"slur":e&&this.Ur(i,e);break;case"glissando":e&&this.wl(i,e);break;case"slide":e&&this.yl(i,e);break;case"ornaments":e&&this.kl(i,e);break;case"technical":this.Sl(i,e,s);break;case"articulations":e&&this.Nh(i,e);break;case"dynamics":const t=this.Yc(i);null!==t&&(s.dynamics=t,this.Ro=t);break;case"fermata":this.Jh(i,s);break;case"arpeggiate":this.Bl(i,s)}}jc(t){if(!this.Do.has(t)){const e=new li;return this.Do.set(t,e),e}return this.Do.get(t)}wl(t,e){const s=t.getAttribute("type"),i=t.getAttribute("number","1"),n=this.jc(e.beat.voice.bar.staff);switch(s){case"start":n.slideOrigins.set(i,e);break;case"stop":if(n.slideOrigins.has(i)){const t=n.slideOrigins.get(i);t.slideTarget=e,e.slideOrigin=t,t.slideOutType=g.Shift}}}Ur(t,e){const s=t.getAttribute("number","1"),i=this.jc(e.beat.voice.bar.staff);switch(t.getAttribute("type")){case"start":i.slurStarts.set(s,e);break;case"stop":if(i.slurStarts.has(s)){e.isSlurDestination=!0;const t=i.slurStarts.get(s);t.slurDestination=e,e.slurOrigin=t,i.slurStarts.delete(s)}}}Bl(t,e){switch(t.getAttribute("direction","down")){case"down":e.brushType=h.ArpeggioDown;break;case"up":e.brushType=h.ArpeggioUp}}Jh(t,e){let s;switch(t.innerText){case"normal":default:s=At.Medium;break;case"angled":s=At.Short;break;case"square":s=At.Long}e.fermata=new Se,e.fermata.type=s}Nh(t,e){for(const s of t.childElements())switch(s.localName){case"accent":e.accentuated=u.Normal;break;case"strong-accent":e.accentuated=u.Heavy;break;case"staccato":e.isStaccato=!0;break;case"tenuto":e.accentuated=u.Tenuto}}Sl(t,e,s){const i=[];for(const n of t.childElements())switch(n.localName){case"up-bow":s.pickStroke=ct.Up;break;case"down-bow":s.pickStroke=ct.Down;break;case"harmonic":break;case"fingering":e&&(e.leftHandFinger=this._l(n));break;case"pluck":e&&(e.rightHandFinger=this._l(n));break;case"fret":e&&(e.fret=Number.parseInt(n.innerText,10));break;case"string":e&&(e.string=s.voice.bar.staff.tuning.length-Number.parseInt(n.innerText,10)+1);break;case"hammer-on":case"pull-off":e&&(e.isHammerPullOrigin=!0);break;case"bend":i.push(n);break;case"tap":s.tap=!0;break;case"smear":e&&(e.vibrato=w.Slight);break;case"golpe":switch(n.getAttribute("placement","above")){case"above":s.golpe=bt.Finger;break;case"below":s.golpe=bt.Thumb}}e&&i.length>0&&this.Tl(i,e)}Tl(t,e){const s=U.MaxPosition/t.length;let i=0,n=0,r=!0;for(const a of t){const t=a.findChildElement("bend-alter");if(t){const h=Math.round(2*Math.abs(Number.parseFloat(t.innerText)));a.findChildElement("pre-bend")?r?(i+=h,e.addBendPoint(new U(n,i)),n+=s,e.addBendPoint(new U(n,i)),r=!1):n+=s:a.findChildElement("release")?(r&&(i+=h),e.addBendPoint(new U(n,i)),n+=s,i-=h,e.addBendPoint(new U(n,i)),r=!1):(e.addBendPoint(new U(n,i)),i+=h,n+=s,e.addBendPoint(new U(n,i)),r=!1)}}}_l(t){switch(t.innerText){case"0":return d.NoOrDead;case"1":case"p":case"t":return d.Thumb;case"2":case"i":return d.IndexFinger;case"3":case"m":return d.MiddleFinger;case"4":case"a":return d.AnnularFinger;case"5":case"c":return d.LittleFinger}return d.Unknown}xl=-1;kl(t,e){let s=-1;for(const i of t.childElements())switch(i.localName){case"trill-mark":s=Number.parseInt(i.getAttribute("trill-step","2"),10),e.isStringed?e.trillValue=e.stringTuning+s:e.isPercussion||(e.trillValue=e.calculateRealValue(!1,!1)+s);break;case"turn":e.ornament=dt.Turn;break;case"inverted-turn":e.ornament=dt.InvertedTurn;break;case"wavy-line":s>0?"start"===i.getAttribute("type")&&(this.xl=s):this.xl>0?"stop"===i.getAttribute("type")?this.xl=-1:e.isStringed?e.trillValue=e.stringTuning+this.xl:e.isPercussion||(e.trillValue=e.calculateRealValue(!1,!1)+this.xl):e.vibrato=w.Slight;break;case"mordent":e.ornament=dt.LowerMordent;break;case"inverted-mordent":e.ornament=dt.UpperMordent;break;case"tremolo":const t=new Zt;e.beat.tremoloPicking=t,t.marks=Number.parseInt(i.innerText,10),("unmeasured"===i.getAttribute("type","")&&0===t.marks||"buzzRoll"===i.getAttribute("smufl",""))&&(t.style=kt.BuzzRoll)}}yl(t,e){const s=t.getAttribute("type"),i=t.getAttribute("number","1"),n=this.jc(e.beat.voice.bar.staff);switch(s){case"start":n.slideOrigins.set(i,e);break;case"stop":if(n.slideOrigins.has(i)){const t=n.slideOrigins.get(i);t.slideTarget=e,e.slideOrigin=t,t.slideOutType=g.Shift}}}gl(t,e,s){const i=t.getAttribute("type"),n=t.getAttribute("number",""),r=this.jc(s);if("start"===i){if(n){if(r.tieStartIds.has(n)){const t=r.tieStartIds.get(n);r.tieStarts.delete(t)}r.tieStartIds.set(n,e)}r.tieStarts.add(e)}else if("stop"===i&&!e.isTieDestination){let t=null;if(n){if(!r.tieStartIds.has(n))return;t=r.tieStartIds.get(n),r.tieStartIds.delete(n),r.tieStarts.delete(e)}else{const s=this.Ml(e);for(const e of r.tieStarts)if(this.Ml(e)===s){t=e,r.tieStarts.delete(t);break}}if(!t)return;e.isTieDestination=!0,e.tieOrigin=t}}ol(t){switch(t.innerText){case"down":return Wt.Down;case"up":return Wt.Up;default:return null}}hl(t,e){switch(t.innerText){case"sharp":e.accidentalMode=p.ForceSharp;break;case"natural":e.accidentalMode=p.ForceNatural;break;case"flat":e.accidentalMode=p.ForceFlat;break;case"double-sharp":e.accidentalMode=p.ForceDoubleSharp;break;case"flat-flat":e.accidentalMode=p.ForceDoubleFlat}}Ml(t){return 12*t.octave+t.tone}Fi(t){return this.tl(Number.parseFloat(t.innerText))}al(t,e){let s="",i=0;for(const e of t.childElements())switch(e.localName){case"display-step":s=e.innerText;break;case"display-octave":i=Number.parseInt(e.innerText,10)+1}const n=new Kt;if(""===s)n.octave=0,n.tone=0;else{const t=12*i+(zt.getToneForText(s)?.noteValue??0);n.octave=t/12|0,n.tone=t-12*n.octave}return n}rl(t){let e="",s=0,i=0;for(const n of t.childElements())switch(n.localName){case"step":e=n.innerText;break;case"alter":s=Number.parseFloat(n.innerText),Number.isNaN(s)&&(s=0);break;case"octave":i=Number.parseInt(n.innerText,10)+1}s|=0;const n=12*i+(zt.getToneForText(e)?.noteValue??0)+s,r=new Kt;return r.octave=n/12|0,r.tone=n-12*r.octave,r}pl(t,e,s,i,n,r,a){if(void 0===s)switch(e){case c.QuadrupleWhole:case c.DoubleWhole:t.style.noteHead=i;break;case c.Whole:t.style.noteHead=n;break;case c.Half:t.style.noteHead=r;break;default:t.style.noteHead=a}else if(!0===s)t.style.noteHead=a;else switch(e){case c.QuadrupleWhole:case c.DoubleWhole:t.style.noteHead=i;break;case c.Whole:t.style.noteHead=n;break;case c.Half:default:t.style.noteHead=r}}}!function(t){t[t.Page=0]="Page",t[t.Horizontal=1]="Horizontal",t[t.Parchment=2]="Parchment"}(Je||(Je={}));class pi{mi;vl=0;Nl=0;count=0;constructor(t){this.mi=new Float32Array(t)}clear(){this.Nl=0,this.vl=0,this.count=0,this.mi=new Float32Array(this.mi.length)}write(t,e,s){let i=0;s>this.mi.length-this.count&&(s=this.mi.length-this.count);const n=Math.min(this.mi.length-this.vl,s);return this.mi.set(t.subarray(e,e+n),this.vl),this.vl+=n,this.vl%=this.mi.length,i+=n,i<s&&(this.mi.set(t.subarray(e+i,e+i+s-i),this.vl),this.vl+=s-i,i=s),this.count+=i,i}read(t,e,s){s>this.count&&(s=this.count);let i=0;const n=Math.min(this.mi.length-this.Nl,s);return t.set(this.mi.subarray(this.Nl,this.Nl+n),e),i+=n,this.Nl+=n,this.Nl%=this.mi.length,i<s&&(t.set(this.mi.subarray(this.Nl,this.Nl+s-i),e+i),this.Nl+=s-i,i=s),this.count-=i,i}}class bi{Pl=[];Cl;constructor(t=void 0){this.Cl=t}on(t){return this.Pl.push(t),this.Cl?.()&&t(),()=>{this.off(t)}}off(t){this.Pl=this.Pl.filter(e=>e!==t)}trigger(){for(const t of this.Pl)t()}}class mi{Pl=[];Cl;constructor(t=void 0){this.Cl=t}on(t){if(this.Pl.push(t),this.Cl){const e=this.Cl();null!==e&&t(e)}return()=>{this.off(t)}}off(t){this.Pl=this.Pl.filter(e=>e!==t)}trigger(t){for(const e of this.Pl)e(t)}}class gi{static CmdOutputPrefix="alphaSynth.output.";static CmdOutputAddSamples=`${gi.CmdOutputPrefix}addSamples`;static CmdOutputPlay=`${gi.CmdOutputPrefix}play`;static CmdOutputPause=`${gi.CmdOutputPrefix}pause`;static CmdOutputResetSamples=`${gi.CmdOutputPrefix}resetSamples`;static CmdOutputStop=`${gi.CmdOutputPrefix}stop`;static CmdOutputSampleRequest=`${gi.CmdOutputPrefix}sampleRequest`;static CmdOutputSamplesPlayed=`${gi.CmdOutputPrefix}samplesPlayed`;static preferredSampleRate=0;El;get sampleRate(){return gi.preferredSampleRate}open(){J.debug("AlphaSynth","Initializing synth worker"),this.El=Pu.globalThis,this.El.addEventListener("message",this.Fl.bind(this)),this.ready.trigger()}destroy(){this.El.postMessage({cmd:"alphaSynth.output.destroy"})}Fl(t){const e=t.data;switch(e.cmd){case gi.CmdOutputSampleRequest:this.sampleRequest.trigger();break;case gi.CmdOutputSamplesPlayed:this.samplesPlayed.trigger(e.samples)}}ready=new bi;samplesPlayed=new mi;sampleRequest=new bi;addSamples(t){this.El.postMessage({cmd:"alphaSynth.output.addSamples",samples:Pu.prepareForPostMessage(t)})}play(){this.El.postMessage({cmd:"alphaSynth.output.play"})}pause(){this.El.postMessage({cmd:"alphaSynth.output.pause"})}resetSamples(){this.El.postMessage({cmd:"alphaSynth.output.resetSamples"})}activate(){}async enumerateOutputDevices(){return[]}async setOutputDevice(t){}async getOutputDevice(){return null}}class wi{device;constructor(t){this.device=t}get deviceId(){return this.device.deviceId}get label(){return this.device.label}isDefault=!1}class yi{static Al=[];static findKnownDevice(t){return yi.Al.find(e=>e.deviceId===t)}static createAudioContext(){if("AudioContext"in Pu.globalThis)return new AudioContext;if("webkitAudioContext"in Pu.globalThis)return new webkitAudioContext;throw new I(s.General,"AudioContext not found")}static async checkSinkIdSupport(){return"setSinkId"in yi.createAudioContext()||(J.warning("WebAudio","Browser does not support changing the output device"),!1)}static async enumerateOutputDevices(){try{if(!await yi.checkSinkIdSupport())return[];try{await navigator.mediaDevices.getUserMedia({audio:!0})}catch(t){J.warning("WebAudio","Output device permission rejected",t)}const t=await navigator.mediaDevices.enumerateDevices();let e="",s="";const i=new Map;for(const n of t)"audiooutput"===n.kind&&(i.set(n.groupId,new wi(n)),"default"!==n.deviceId&&""!==n.deviceId||(e=n.groupId,s=n.deviceId));const n=Array.from(i.values());let r=n.find(t=>t.deviceId===s);return r||(r=n.find(t=>t.device.groupId===e)),!r&&n.length>0&&(r=n[0]),r&&(r.isDefault=!0),yi.Al=n,n}catch(t){return J.error("WebAudio","Failed to enumerate output devices",t),[]}}}class ki{static BufferSize=4096;static PreferredSampleRate=44100;context=null;buffer=null;source=null;Dl;get sampleRate(){return this.context?this.context.sampleRate:ki.PreferredSampleRate}activate(t){this.context||(this.context=yi.createAudioContext()),"suspended"!==this.context.state&&"interrupted"!==this.context.state||(J.debug("WebAudio","Audio Context is suspended, trying resume"),this.context.resume().then(()=>{J.debug("WebAudio",`Audio Context resume success: state=${this.context?.state}, sampleRate:${this.context?.sampleRate}`),t&&t()},t=>{J.warning("WebAudio",`Audio Context resume failed: state=${this.context?.state}, sampleRate:${this.context?.sampleRate}, reason=${t}`)}))}Ll(){const t=navigator.userAgent;if(-1!==t.indexOf("iPhone")||-1!==t.indexOf("iPad")){const t=yi.createAudioContext(),e=t.createBuffer(1,1,ki.PreferredSampleRate),s=t.createBufferSource();s.buffer=e,s.connect(t.destination),s.start(0),s.disconnect(0),t.close()}}open(t){this.Ll(),this.context=yi.createAudioContext();"suspended"===this.context.state&&this.Wl()}Wl(){this.Dl=(()=>{this.activate(()=>{this.Ol()})}).bind(this),document.body.addEventListener("touchend",this.Dl,!1),document.body.addEventListener("click",this.Dl,!1)}Ol(){const t=this.Dl;t&&(document.body.removeEventListener("touchend",t,!1),document.body.removeEventListener("click",t,!1))}play(){const t=this.context;this.activate(),this.buffer=t.createBuffer(2,ki.BufferSize,t.sampleRate),this.source=t.createBufferSource(),this.source.buffer=this.buffer,this.source.loop=!0}pause(){this.source&&(this.source.stop(0),this.source.disconnect()),this.source=null}destroy(){this.pause(),this.context?.close(),this.context=null,this.Ol()}ready=new bi;samplesPlayed=new mi;sampleRequest=new bi;onSamplesPlayed(t){this.samplesPlayed.trigger(t)}onSampleRequest(){this.sampleRequest.trigger()}onReady(){this.ready.trigger()}enumerateOutputDevices(){return yi.enumerateOutputDevices()}async setOutputDevice(t){await yi.checkSinkIdSupport()&&(t?await this.context.setSinkId(t.deviceId):await this.context.setSinkId(""))}async getOutputDevice(){if(!await yi.checkSinkIdSupport())return null;const t=this.context.sinkId;if("string"!=typeof t||""===t||"default"===t)return null;let e=yi.findKnownDevice(t);if(e)return e;const s=await this.enumerateOutputDevices();return e=s.find(e=>e.deviceId===t),e||(J.warning("WebAudio","Could not find output device in device list",t,s),null)}}class Si{static Rl=!1;static init(){Si.Rl||(Si.Rl=!0,registerProcessor("alphatab",class t extends AudioWorkletProcessor{static BufferSize=4096;Il=new Float32Array(0);Gl;Hl=0;Vl=0;$l=!1;constructor(e){super(e),J.debug("WebAudio","creating processor"),this.Hl=Math.floor(e.processorOptions.bufferTimeInMilliseconds*sampleRate/1e3/t.BufferSize),this.Gl=new pi(t.BufferSize*this.Hl),this.port.onmessage=this.Fl.bind(this)}Fl(t){const e=t.data;switch(e.cmd){case gi.CmdOutputAddSamples:const t=e.samples;this.Gl.write(t,0,t.length),this.Vl--;break;case gi.CmdOutputResetSamples:this.Gl.clear();break;case gi.CmdOutputStop:this.$l=!0}}process(t,e,s){if(1!==e.length&&2!==e[0].length)return!1;const i=e[0][0],n=e[0][1];if(!i||!n)return!0;const r=i.length+n.length;let a=this.Il;a.length!==r&&(a=new Float32Array(r),this.Il=a);const h=this.Gl.read(a,0,Math.min(a.length,this.Gl.count));let o=0;const c=Math.min(i.length,h);for(let t=0;t<c;t++)i[t]=a[o++],n[t]=a[o++];if(h<i.length)for(let t=h;t<i.length;t++)i[t]=0,n[t]=0;return this.port.postMessage({cmd:gi.CmdOutputSamplesPlayed,samples:h/Vt.AudioChannels}),this.Ul(),this.Gl.count>0||!this.$l}Ul(){const e=this.Hl/2|0,s=e*t.BufferSize;if(this.Gl.count+this.Vl*t.BufferSize<s){for(let t=0;t<e;t++)this.port.postMessage({cmd:gi.CmdOutputSampleRequest});this.Vl+=e}}}))}}class Bi extends ki{zl=null;Xl=0;jl;constructor(t){super(),this.jl=t}open(t){super.open(t),this.Xl=t,this.onReady()}play(){super.play();const t=this.context;Pu.createAudioWorklet(t,this.jl).then(()=>{this.zl=new AudioWorkletNode(t,"alphatab",{numberOfOutputs:1,outputChannelCount:[2],processorOptions:{bufferTimeInMilliseconds:this.Xl}}),this.zl.port.onmessage=this.Fl.bind(this),this.source.connect(this.zl),this.source.start(0),this.zl.connect(t.destination)},t=>{J.error("WebAudio",`Audio Worklet creation failed: reason=${t}`)})}Fl(t){const e=t.data;switch(e.cmd){case gi.CmdOutputSamplesPlayed:this.onSamplesPlayed(e.samples);break;case gi.CmdOutputSampleRequest:this.onSampleRequest()}}pause(){super.pause(),this.zl&&(this.zl.port.postMessage({cmd:gi.CmdOutputStop}),this.zl.port.onmessage=null,this.zl.disconnect()),this.zl=null}addSamples(t){this.zl?.port.postMessage({cmd:gi.CmdOutputAddSamples,samples:Pu.prepareForPostMessage(t)})}resetSamples(){this.zl?.port.postMessage({cmd:gi.CmdOutputResetSamples})}}!function(t){t[t.SingleTrackMultiChannel=0]="SingleTrackMultiChannel",t[t.MultiTrack=1]="MultiTrack"}(qe||(qe={}));class _i{events=[];addEvent(t){if(0===this.events.length||t.tick>=this.events[this.events.length-1].tick)this.events.push(t);else{let e=this.events.length;for(;e>0;){if(!(this.events[e-1].tick>t.tick))break;e--}this.events.splice(e,0,t)}}writeTo(t){const e=Fe.empty();let s=0;for(const t of this.events){const i=t.tick-s;Ti.writeVariableInt(e,i),t.writeTo(e),s=t.tick}const i=new Uint8Array([77,84,114,107]);t.write(i,0,i.length);const n=e.toArray();de.writeInt32BE(t,n.length),t.write(n,0,n.length)}}class Ti{format=qe.SingleTrackMultiChannel;division=H.QuarterTime;tickShift=0;get events(){if(1===this.tracks.length)return this.tracks[0].events;const t=[];for(const t of this.tracks)this.events.push(...t.events);return t.sort((t,e)=>t.tick-e.tick),t}tracks=[];Jl(t){for(;this.tracks.length<t;)this.tracks.push(new _i)}addEvent(t){this.format===qe.SingleTrackMultiChannel?(this.Jl(1),this.tracks[0].addEvent(t)):(this.Jl(t.track+1),this.tracks[t.track].addEvent(t))}toBinary(){const t=Fe.empty();return this.writeTo(t),t.toArray()}writeTo(t){const e=new Uint8Array([77,84,104,100]);t.write(e,0,e.length),de.writeInt32BE(t,6),de.writeInt16BE(t,this.format),de.writeInt16BE(t,this.tracks.length),de.writeInt16BE(t,this.division);for(const e of this.tracks)e.writeTo(t)}static writeVariableInt(t,e){const s=new Uint8Array(4);let i=0;do{s[i++]=127&e,e>>=7}while(e>0);for(;i>0;)i--,i>0?t.writeByte(128|s[i]):t.writeByte(s[i])}}!function(t){t[t.TimeSignature=88]="TimeSignature",t[t.NoteOn=128]="NoteOn",t[t.NoteOff=144]="NoteOff",t[t.ControlChange=176]="ControlChange",t[t.ProgramChange=192]="ProgramChange",t[t.TempoChange=81]="TempoChange",t[t.PitchBend=224]="PitchBend",t[t.PerNotePitchBend=96]="PerNotePitchBend",t[t.EndOfTrack=47]="EndOfTrack",t[t.AlphaTabRest=241]="AlphaTabRest",t[t.AlphaTabMetronome=242]="AlphaTabMetronome",t[t.SystemExclusive=240]="SystemExclusive",t[t.SystemExclusive2=247]="SystemExclusive2",t[t.Meta=255]="Meta"}(Ye||(Ye={}));class xi{track;tick;type;constructor(t,e,s){this.track=t,this.tick=e,this.type=s}get command(){return this.type}get message(){return 0}get data1(){return 0}get data2(){return 0}}class Mi extends xi{numerator;denominatorIndex;midiClocksPerMetronomeClick;thirtySecondNodesInQuarter;constructor(t,e,s,i,n,r){super(t,e,Ye.TimeSignature),this.track=t,this.tick=e,this.numerator=s,this.denominatorIndex=i,this.midiClocksPerMetronomeClick=n,this.thirtySecondNodesInQuarter=r}writeTo(t){t.writeByte(255),t.writeByte(88),Ti.writeVariableInt(t,4),t.writeByte(255&this.numerator),t.writeByte(255&this.denominatorIndex),t.writeByte(255&this.midiClocksPerMetronomeClick),t.writeByte(255&this.thirtySecondNodesInQuarter)}}class vi extends xi{static AlphaTabManufacturerId=125;static MetronomeEventId=0;static RestEventId=1;writeTo(t){t.writeByte(240);const e=Fe.withCapacity(16);e.writeByte(vi.AlphaTabManufacturerId),this.writeEventData(e),e.writeByte(247),Ti.writeVariableInt(t,e.length),e.copyTo(t)}}class Ni extends vi{metronomeNumerator;metronomeDurationInTicks;metronomeDurationInMilliseconds;isMetronome=!0;constructor(t,e,s,i,n){super(t,e,Ye.AlphaTabMetronome),this.metronomeNumerator=s,this.metronomeDurationInMilliseconds=n,this.metronomeDurationInTicks=i}writeEventData(t){t.writeByte(vi.MetronomeEventId),t.writeByte(this.metronomeNumerator),de.writeInt32LE(t,this.metronomeDurationInTicks),de.writeInt32LE(t,this.metronomeDurationInMilliseconds)}}class Pi extends vi{channel;constructor(t,e,s){super(t,e,Ye.AlphaTabRest),this.channel=s}writeEventData(t){t.writeByte(vi.RestEventId),t.writeByte(this.channel)}}class Ci extends xi{channel;noteKey;noteVelocity;constructor(t,e,s,i,n,r){super(t,e,s),this.channel=i,this.noteKey=n,this.noteVelocity=r}get data1(){return this.noteKey}get data2(){return this.noteVelocity}}class Ei extends Ci{constructor(t,e,s,i,n){super(t,e,Ye.NoteOn,s,i,n)}writeTo(t){t.writeByte(15&this.channel|144),t.writeByte(255&this.noteKey),t.writeByte(255&this.noteVelocity)}}class Fi extends Ci{constructor(t,e,s,i,n){super(t,e,Ye.NoteOff,s,i,n)}writeTo(t){t.writeByte(15&this.channel|128),t.writeByte(255&this.noteKey),t.writeByte(255&this.noteVelocity)}}class Ai extends xi{channel;controller;value;constructor(t,e,s,i,n){super(t,e,Ye.ControlChange),this.channel=s,this.controller=i,this.value=n}writeTo(t){t.writeByte(15&this.channel|176),t.writeByte(255&this.controller),t.writeByte(255&this.value)}get data1(){return this.controller}get data2(){return this.value}}class Di extends xi{channel;program;constructor(t,e,s,i){super(t,e,Ye.ProgramChange),this.channel=s,this.program=i}writeTo(t){t.writeByte(15&this.channel|192),t.writeByte(255&this.program)}get data1(){return this.program}}class Li extends xi{get microSecondsPerQuarterNote(){return 6e7/this.beatsPerMinute}set microSecondsPerQuarterNote(t){this.beatsPerMinute=6e7/t}beatsPerMinute=0;constructor(t,e){super(0,t,Ye.TempoChange),this.microSecondsPerQuarterNote=e}writeTo(t){t.writeByte(255),t.writeByte(81),t.writeByte(3),t.writeByte(this.microSecondsPerQuarterNote>>16&255),t.writeByte(this.microSecondsPerQuarterNote>>8&255),t.writeByte(255&this.microSecondsPerQuarterNote)}}class Wi extends xi{channel;value;constructor(t,e,s,i){super(t,e,Ye.PitchBend),this.channel=s,this.value=i}writeTo(t){t.writeByte(15&this.channel|224),t.writeByte(127&this.value),t.writeByte(this.value>>7&127)}get data1(){return 127&this.value}get data2(){return this.value>>7&127}}class Oi extends xi{channel;noteKey;value;constructor(t,e,s,i,n){super(t,e,Ye.PerNotePitchBend),this.channel=s,this.noteKey=i,this.value=n}writeTo(t){throw new I(s.General,"Note Bend (Midi2.0) events cannot be exported to SMF1.0")}}class Ri extends xi{constructor(t,e){super(t,e,Ye.EndOfTrack)}writeTo(t){t.writeByte(255),t.writeByte(47),t.writeByte(0)}}class Ii{eventIndex;event;isMetronome;time=0;constructor(t,e){this.eventIndex=t,this.event=e,this.isMetronome=this.event.type===Ye.AlphaTabMetronome}static newMetronomeEvent(t,e,s,i,n){const r=new Ni(0,e,s,i,n);return new Ii(t,r)}}class Gi{masterBarIndex=0;masterBarOccurence=0;synthBpm=0;synthTime=0;synthTick=0;syncTime=0;syncBpm=0;updateSyncBpm(t,e){const s=(t-this.synthTime)/(e-this.syncTime)*this.synthBpm;this.syncBpm=s}}class Hi{bpm;ticks;time;constructor(t,e,s){this.bpm=t,this.ticks=e,this.time=s}}class Vi{tempoChanges=[];tempoChangeIndex=0;syncPoints=[];firstProgramEventPerChannel=new Map;firstTimeSignatureNumerator=0;firstTimeSignatureDenominator=0;synthData=[];division=H.QuarterTime;eventIndex=0;currentTime=0;syncPointIndex=0;playbackRange=null;playbackRangeStartTime=0;playbackRangeEndTime=0;endTick=0;endTime=0;currentTempo=0;syncPointTempo=0}class $i{ql;Yl;Kl;Ql=null;Zl=null;get isPlayingMain(){return this.Yl===this.Kl}get isPlayingOneTimeMidi(){return this.Yl===this.Ql}get isPlayingCountIn(){return this.Yl===this.Zl}constructor(t){this.ql=t,this.Kl=new Vi,this.Yl=this.Kl}get mainPlaybackRange(){return this.Kl.playbackRange}set mainPlaybackRange(t){this.Kl.playbackRange=t,t&&(this.Kl.playbackRangeStartTime=this.tu(this.Kl,t.startTick,1),this.Kl.playbackRangeEndTime=this.tu(this.Kl,t.endTick,1))}isLooping=!1;get currentTime(){return this.Yl.currentTime/this.playbackSpeed}get currentEndTick(){return this.Yl.endTick}get currentEndTime(){return this.Yl.endTime/this.playbackSpeed}get currentTempo(){return this.Yl.currentTempo}get modifiedTempo(){return this.Yl.syncPointTempo*this.playbackSpeed}get syncPointTempo(){return this.Yl.syncPointTempo}get currentSyncPoints(){return this.Yl.syncPoints}playbackSpeed=1;mainSeek(t){if(t*=this.playbackSpeed,this.mainPlaybackRange&&(t<this.Kl.playbackRangeStartTime?t=this.Kl.playbackRangeStartTime:t>this.Kl.playbackRangeEndTime&&(t=this.Kl.playbackRangeEndTime)),t>this.Kl.currentTime)this.eu(t-this.Kl.currentTime);else if(t<this.Kl.currentTime){if(this.Kl.currentTime=0,this.Kl.eventIndex=0,this.Kl.syncPointIndex=0,this.Kl.tempoChangeIndex=0,this.Kl.currentTempo=this.Kl.tempoChanges[0].bpm,this.Kl.syncPointTempo=this.Kl.syncPoints.length>0?this.Kl.syncPoints[0].syncBpm:this.Kl.currentTempo,this.isPlayingMain){const t=this.ql.metronomeVolume;this.ql.noteOffAll(!0),this.ql.resetSoft(),this.ql.setupMetronomeChannel(t)}this.eu(t)}}eu(t){if(t<=0)return;const e=Date.now(),s=this.Kl.currentTime+t;if(this.isPlayingMain)for(;this.Kl.currentTime<s;)this.su(s-this.Kl.currentTime)&&this.ql.synthesizeSilent(Vt.MicroBufferSize);this.Kl.currentTime=s;const i=Date.now()-e;J.debug("Sequencer",`Silent seek finished in ${i}ms (main)`)}loadOneTimeMidi(t){this.Ql=this.createStateFromFile(t),this.Yl=this.Ql}instrumentPrograms=new Set;percussionKeys=new Set;loadMidi(t){this.instrumentPrograms.clear(),this.percussionKeys.clear(),this.Kl=this.createStateFromFile(t),this.Yl=this.Kl}createStateFromFile(t){const e=new Vi;this.percussionKeys.add(Vt.MetronomeKey),e.tempoChanges=[],e.division=t.division,e.eventIndex=0,e.currentTime=0,e.synthData=[];let s=120,i=0,n=0,r=0,a=0,h=0,o=t.tickShift,c=0,l=0;for(const u of t.events){const d=new Ii(e.synthData.length,u);e.synthData.push(d);const f=u.tick-l;if(i+=f,n+=f*(6e4/(s*t.division)),d.time=n,l=u.tick,a>0)for(;o<i;){const t=Ii.newMetronomeEvent(e.synthData.length,o,Math.floor(o/a)%r,a,h);e.synthData.push(t),t.time=c,o+=a,c+=h}if(u.type===Ye.TempoChange){const r=u;s=$i.iu(r.beatsPerMinute),e.tempoChanges.push(new Hi(s,i,n)),h=a*(6e4/(s*t.division))}else if(u.type===Ye.TimeSignature){const i=u,n=Math.pow(2,i.denominatorIndex);r=i.numerator,a=e.division*(4/n)|0,h=a*(6e4/(s*t.division)),0===e.firstTimeSignatureDenominator&&(e.firstTimeSignatureNumerator=i.numerator,e.firstTimeSignatureDenominator=n)}else if(u.type===Ye.ProgramChange){const t=u,s=t.channel;e.firstProgramEventPerChannel.has(s)||e.firstProgramEventPerChannel.set(s,d);s===Vt.PercussionChannel||this.instrumentPrograms.add(t.program)}else if(u.type===Ye.NoteOn){const t=u;t.channel===Vt.PercussionChannel&&this.percussionKeys.add(t.noteKey)}}return e.currentTempo=e.tempoChanges.length>0?e.tempoChanges[0].bpm:s,e.syncPointTempo=e.currentTempo,e.synthData.sort((t,e)=>t.time>e.time?1:t.time<e.time?-1:t.eventIndex-e.eventIndex),e.endTime=n,e.endTick=i,e}fillMidiEventQueue(){return this.su(-1)}fillMidiEventQueueToEndTime(t){for(;this.Kl.currentTime<t;)this.su(t-this.Kl.currentTime)&&this.ql.synthesizeSilent(Vt.MicroBufferSize);let e=!1;for(this.Yl.currentTime=t;this.Yl.eventIndex<this.Yl.synthData.length&&this.Yl.synthData[this.Yl.eventIndex].time<this.Yl.currentTime;){const t=this.Yl.synthData[this.Yl.eventIndex];this.ql.dispatchEvent(t),this.Yl.eventIndex++,e=!0}return e}su(t){let e=Vt.MicroBufferSize/this.ql.outSampleRate*1e3*this.playbackSpeed,s=this.nu;t>0&&(t<e&&(e=t),s=Math.min(this.nu,this.Yl.currentTime+t));let i=!1;for(this.Yl.currentTime+=e;this.Yl.eventIndex<this.Yl.synthData.length&&this.Yl.synthData[this.Yl.eventIndex].time<this.Yl.currentTime&&this.Yl.currentTime<s;)this.ql.dispatchEvent(this.Yl.synthData[this.Yl.eventIndex]),this.Yl.eventIndex++,i=!0;return i}mainTickPositionToTimePosition(t){return this.tu(this.Kl,t,this.playbackSpeed)}mainUpdateSyncPoints(t){const e=this.Kl;if(t.sort((t,e)=>t.synthTick-e.synthTick),e.syncPoints=[],t.length>=0){let s=120,i=0,n=0,r=0;for(let a=0;a<t.length;a++){const h=t[a];let o,c,l,u=0;if(0===a)o=s,c=0,l=0;else{const e=t[a-1];o=$i.iu(e.syncBpm),c=e.syncTime,l=e.synthTick}for(;r<e.tempoChanges.length&&e.tempoChanges[r].ticks<=h.synthTick;){if(u=e.tempoChanges[r].ticks-i,u>0){i+=u,n+=u*(6e4/(s*e.division));const t=(i-l)*((h.syncTime-c)/(h.synthTick-l))+c,r=new Gi;r.synthTick=i,r.synthBpm=s,r.synthTime=n,r.syncTime=t,r.syncBpm=o}s=$i.iu(e.tempoChanges[r].bpm),r++}u=h.synthTick-i,i+=u,n+=u*(6e4/(s*e.division)),e.syncPoints.push(h)}}e.syncPointIndex=0,e.syncPointTempo=e.syncPoints.length>0?e.syncPoints[0].syncBpm:e.currentTempo}currentTimePositionToTickPosition(t){const e=this.Yl;if(0===e.tempoChanges.length)return 0;t*=this.playbackSpeed,this.ru(e,t);const s=e.tempoChanges[e.tempoChangeIndex],i=(t-s.time)/(6e4/($i.iu(s.bpm)*e.division))|0;return s.ticks+i+1}static iu(t){return Math.max(t,1)}currentUpdateCurrentTempo(t){this.ru(this.Kl,t*this.playbackSpeed)}ru(t,e){let s=t.tempoChangeIndex;for(e<t.tempoChanges[s].time&&(s=0);s+1<t.tempoChanges.length&&t.tempoChanges[s+1].time<=e;)s++;s!==t.tempoChangeIndex&&(t.tempoChangeIndex=s,t.currentTempo=t.tempoChanges[t.tempoChangeIndex].bpm,0===t.syncPoints.length&&(t.syncPointTempo=t.currentTempo))}currentUpdateSyncPoints(t){this.au(this.Kl,t)}au(t,e){const s=t.syncPoints;if(s.length>0){let i=Math.min(t.syncPointIndex,s.length-1);for(e<s[i].syncTime&&(i=0);i+1<s.length&&s[i+1].syncTime<=e;)i++;i!==t.syncPointIndex&&(t.syncPointIndex=i,t.syncPointTempo=s[i].syncBpm)}else t.syncPointTempo=t.currentTempo}mainTimePositionFromBackingTrack(t,e){const s=this.Kl,i=s.syncPoints;if(t<0||0===i.length)return t;this.au(this.Kl,t);const n=Math.min(s.syncPointIndex,i.length-1),r=i[n],a=t-r.syncTime;let h;if(n+1<i.length){const t=i[n+1],e=a/(t.syncTime-r.syncTime);h=(t.synthTime-r.synthTime)*e}else{const t=a/(e-r.syncTime);h=(s.endTime-r.synthTime)*t}return(r.synthTime+h)/this.playbackSpeed}mainTimePositionToBackingTrack(t,e){const s=this.Kl,i=s.syncPoints;if(t<0||0===i.length)return t;t*=this.playbackSpeed;let n=Math.min(s.syncPointIndex,i.length-1);for(t<i[n].synthTime&&(n=0);n+1<i.length&&i[n+1].synthTime<=t;)n++;const r=i[n],a=t-r.synthTime;let h;if(n+1<i.length){const t=i[n+1],e=a/(t.synthTime-r.synthTime),s=t.syncTime-r.syncTime;h=r.syncTime+s*e}else{const t=a/(s.endTime-r.synthTime),i=e-r.syncTime;h=r.syncTime+i*t}return h}tu(t,e,s){let i=0,n=120,r=0;for(const s of t.tempoChanges){if(e<s.ticks)break;i=s.time,n=s.bpm,r=s.ticks}return i+=(e-=r)*(6e4/(n*t.division)),i/s}get nu(){return this.isPlayingMain&&this.mainPlaybackRange?this.Yl.playbackRangeEndTime:this.Yl.endTime}get isFinished(){return this.Yl.currentTime>=this.nu}stop(){this.isPlayingMain&&this.mainPlaybackRange?this.Yl.currentTime=this.mainPlaybackRange.startTick:this.Yl.currentTime=0,this.Yl.eventIndex=0}resetOneTimeMidi(){this.Ql=null,this.Yl=this.Kl}resetCountIn(){this.Zl=null,this.Yl=this.Kl}startCountIn(){this.generateCountInMidi(),this.Yl=this.Zl,this.stop(),this.ql.noteOffAll(!0)}generateCountInMidi(){const t=new Vi;t.division=this.Kl.division;let e=120,s=4,i=4;0===this.Kl.eventIndex?(e=this.Kl.tempoChanges[0].bpm,s=this.Kl.firstTimeSignatureNumerator,i=this.Kl.firstTimeSignatureDenominator):(e=this.ql.currentTempo,s=this.ql.timeSignatureNumerator,i=this.ql.timeSignatureDenominator),t.tempoChanges.push(new Hi(e,0,0));const n=t.division*(4/i)|0,r=n*(6e4/(e*this.Kl.division));let a=0,h=0;for(let e=0;e<s;e++){const s=Ii.newMetronomeEvent(t.synthData.length,a,e,n,r);t.synthData.push(s),s.time=h,a+=n,h+=r}t.synthData.sort((t,e)=>t.time>e.time?1:t.time<e.time?-1:t.eventIndex-e.eventIndex),t.endTime=h,t.endTick=a,t.currentTempo=e,t.syncPointTempo=e,this.Zl=t}}!function(t){t[t.Paused=0]="Paused",t[t.Playing=1]="Playing"}(Ke||(Ke={}));class Ui{state;stopped;constructor(t,e){this.state=t,this.stopped=e}}class zi{currentTime;endTime;currentTick;endTick;isSeek;originalTempo=0;modifiedTempo=0;constructor(t,e,s,i,n,r,a){this.currentTime=t,this.endTime=e,this.currentTick=s,this.endTick=i,this.isSeek=n,this.originalTempo=r,this.modifiedTempo=a}}class Xi{static HeaderSize=8;id="";size=0;static load(t,e,s){if(t&&Xi.HeaderSize>t.size)return!1;if(s.position+Xi.HeaderSize>=s.length)return!1;if(e.id=de.read8BitStringLength(s,4),e.id.charCodeAt(0)<=32||e.id.charCodeAt(0)>=122)return!1;if(e.size=de.readUInt32LE(s),t&&Xi.HeaderSize+e.size>t.size)return!1;t&&(t.size-=Xi.HeaderSize+e.size);const i="RIFF"===e.id,n="LIST"===e.id;return(!i||!t)&&(!i&&!n||(e.id=de.read8BitStringLength(s,4),!(e.id.charCodeAt(0)<=32||e.id.charCodeAt(0)>=122)&&(e.size-=4,!0)))}}class ji{packetData;isBeginningOfStream;isEndOfStream;granulePosition;constructor(t,e,s,i){this.packetData=t,this.isBeginningOfStream=e,this.isEndOfStream=s,this.granulePosition=s?i:null}addData(t){const e=this.packetData,s=new Uint8Array(e.length+t.length);s.set(e,0),s.set(t,e.length)}}!function(t){t[t.ContinuesPacket=1]="ContinuesPacket",t[t.BeginningOfStream=2]="BeginningOfStream",t[t.EndOfStream=4]="EndOfStream"}(Qe||(Qe={}));class Ji{Bn;constructor(t){this.Bn=t}read(){const t=[];for(;this.hu(t););return t}hu(t){return!!this.ou()&&this.cu(t)}ou(){for(let t=0;t<65536;t++){if(1399285583===de.readInt32LE(this.Bn))return!0;this.Bn.position-=3}return!1}cu(t){const e=this.Bn.readByte();if(-1===e||0!==e)return!1;const i=this.Bn.readByte(),n=de.readInt64LE(this.Bn);this.Bn.skip(4),this.Bn.skip(4),this.Bn.skip(4);const r=this.Bn.readByte();if(-1===r)return!1;const a=[];let h=0;for(let t=0;t<r;t++){const t=this.Bn.readByte();h===a.length&&a.push(0),a[h]+=t,t<255&&h++}for(let e=0;e<a.length;e++){const r=new Uint8Array(a[e]);if(this.Bn.read(r,0,r.length)!==r.length)return!1;if(0!==(i&Qe.ContinuesPacket)){if(0===t.length)throw new I(s.Format,"OGG: Continuation page without any previous packets");t[t.length-1].addData(r)}else{const s=new ji(r,0!==(i&Qe.BeginningOfStream)&&0===e,0!==(i&Qe.EndOfStream)&&e===a.length-1,n);t.push(s)}}return!0}}class qi{audioChannels=0;audioSampleRate=0;samples=new Float32Array(0);bitrateMaximum=0;bitrateNominal=0;bitrateMinimum=0;blocksize0=0;blocksize1=0}class Yi{value=0;bitsRead=0}class Ki{static oo=8;uo;lu=0n;uu=0n;du=0n;constructor(t){this.uo=t}readByte(){return this.readBits(Ki.oo)}readBit(){return 1===this.readBits(1)}readBytes(t){const e=new Uint8Array(t);for(let s=0;s<t;s++)e[s]=255&this.readByte();return e}readBits(t){if(0===t)return 0;const e=this.tryPeekBits(t);return this.skipBits(t),e.value}tryPeekBits(t){if(t<0||t>32)throw new I(s.General,"IO: Cannot read more than 32 bits in one go");if(0===t)return new Yi;const e=new Yi;for(;this.uu<t;){const t=BigInt(this.uo.readByte());if(-1n===t)return e.bitsRead=Number(this.uu),e.value=Number(this.lu),this.lu=0n,this.uu=0n,e;this.lu=(0xffn&t)<<this.uu|this.lu,this.uu+=8n,this.uu>32&&(this.du=t>>40n-this.uu&0xffn)}let i=this.lu;return t<64&&(i&=(1n<<BigInt(t))-1n),e.value=Number(i),e.bitsRead=t,e}skipBits(t){let e=BigInt(t);if(0===t);else if(this.uu>e){if(this.lu=t>31?0n:this.lu>>e,this.uu>32){const s=this.uu-32n;this.lu=this.lu|this.du<<this.uu-e-s,s>t&&(this.du=this.du>>e&0xffn)}this.uu-=e}else if(this.uu===e)this.lu=0n,this.uu=0n;else{for(e-=this.uu,this.uu=0n,this.lu=0n;e>8;){if(-1===this.uo.readByte()){e=0n;break}e-=8n}if(e>0){const t=BigInt(this.uo.readByte());-1n===t||(this.lu=t>>e,this.uu=8n-e)}}}}class Qi{codebooks=[];timeDomainTransforms=[];floors=[];residues=[];mappings=[];modes=[]}class Zi{static ilog(t){let e=0;for(;t>0;)++e,t>>=1;return e}static bitReverse(t,e=32){let s=BigInt(t);s=(s&BigInt(2863311530))>>1n|(s&BigInt(1431655765))<<1n,s=(s&BigInt(3435973836))>>2n|(s&BigInt(858993459))<<2n,s=(s&BigInt(4042322160))>>4n|(s&BigInt(252645135))<<4n,s=(s&BigInt(4278255360))>>8n|(s&BigInt(16711935))<<8n,s=(s>>16n|s<<16n)>>32n-BigInt(e);return Number(BigInt.asUintN(32,s))}static convertFromVorbisFloat32(t){const e=BigInt(t);let s=e&BigInt(2097151);const i=e&BigInt(2147483648),n=(e&BigInt(2145386496))>>21n;return 0n!==i&&(s=-s),Number(s)*Math.pow(2,Number(n)-788)}}class tn{fu;constructor(t){this.fu=t}get(t){return this.fu[t]}}class en{static instance=new en;get(t){return t}}class sn{hn;pu=0;bu=null;mu=null;gu=0;wu;dimensions=0;entries=0;mapType=0;constructor(t,e){if(5653314!==t.readBits(24))throw new I(s.Format,"Vorbis: Book header had invalid signature!");this.dimensions=t.readBits(16),this.entries=t.readBits(24),this.hn=new Int32Array(this.entries),this.yu(t,e),this.ku(t)}get(t,e){return this.wu[t*this.dimensions+e]}decodeScalar(t){let e=t.tryPeekBits(this.gu);if(0===e.bitsRead)return-1;let s=this.mu[e.value];if(null!=s)return t.skipBits(s.length),s.value;if(e=t.tryPeekBits(this.pu),null!==this.bu)for(let i=0;i<this.bu.length;i++){s=this.bu[i];const n=e.value&s.mask;if(s.bits===n)return t.skipBits(s.length),s.value}return-1}yu(t,e){let i,n,r=0;if(t.readBit()){let e=t.readBits(5)+1;for(let s=0;s<this.entries;){let i=t.readBits(Zi.ilog(this.entries-s));for(;--i>=0;)this.hn[s++]=e;++e}r=0,i=!1,n=e}else{n=-1,i=t.readBit();for(let e=0;e<this.entries;e++)!i||t.readBit()?(this.hn[e]=t.readBits(5)+1,++r):this.hn[e]=-1,this.hn[e]>n&&(n=this.hn[e])}if(this.pu=n,n>-1){let t,n=null;i&&r>=this.entries>>2&&(n=new Int32Array(this.entries),n.set(this.hn.subarray(0,this.entries),0),i=!1),t=i?r:0;let a=null,h=null;if(i?0!==t&&(n=new Int32Array(t),h=new Int32Array(t),a=new Int32Array(t)):h=new Int32Array(this.entries),!this.Su(i,h,n,this.hn,this.entries,a))throw new I(s.Format,"Vorbis: Failed to compute codewords");const o=null==a?en.instance:new tn(a);e.generateTable(o,n??this.hn,h),this.mu=e.prefixTree,this.gu=e.tableBits,this.bu=e.overflowList}}Su(t,e,s,i,n,r){const a=new Uint32Array(32);let h=0,o=0;for(h=0;h<n&&!(i[h]>0);++h);if(h===n)return!0;this.Bu(t,e,s,0,h,o++,i[h],r);for(let t=1;t<=i[h];++t)a[t]=1<<32-t;for(let c=h+1;c<n;++c){let n=i[c];if(n<=0)continue;for(;n>0&&0===a[n];)--n;if(0===n)return!1;const h=a[n];if(a[n]=0,this.Bu(t,e,s,Zi.bitReverse(h),c,o++,i[c],r),n!==i[c])for(let t=i[c];t>n;--t)a[t]=h+(1<<32-t)}return!0}Bu(t,e,s,i,n,r,a,h){t?(e[r]=i,s[r]=a,h[r]=n):e[n]=i}ku(t){if(this.mapType=t.readBits(4),0===this.mapType)return;const e=Zi.convertFromVorbisFloat32(t.readBits(32)),s=Zi.convertFromVorbisFloat32(t.readBits(32)),i=t.readBits(4)+1,n=t.readBit();let r=this.entries*this.dimensions;const a=new Float32Array(r);1===this.mapType&&(r=this._u());const h=new Uint32Array(r);for(let e=0;e<r;e++)h[e]=t.readBits(i);if(1===this.mapType)for(let t=0;t<this.entries;t++){let i=0,o=1;for(let c=0;c<this.dimensions;c++){const l=h[t/o%r|0]*s+e+i;a[t*this.dimensions+c]=l,n&&(i=l),o*=r}}else for(let t=0;t<this.entries;t++){let i=0,r=t*this.dimensions;for(let o=0;o<this.dimensions;o++){const c=h[r]*s+e+i;a[t*this.dimensions+o]=c,n&&(i=c),++r}}this.wu=a}_u(){let t=Math.floor(Math.exp(Math.log(this.entries)/this.dimensions));return Math.floor(Math.pow(t+1,this.dimensions))<=this.entries&&++t,t}}class nn{value=0;length=0;bits=0;mask=0}class rn{static maxTableBits=10;tableBits=0;prefixTree=[];overflowList=null;generateTable(t,e,s){const i=new Array(e.length);let n=0;for(let r=0;r<i.length;r++){const a=new nn;a.value=t.get(r),a.length=e[r]<=0?99999:e[r],a.bits=s[r],a.mask=(1<<e[r])-1,i[r]=a,e[r]>0&&n<e[r]&&(n=e[r])}i.sort((t,e)=>{const s=t.length-e.length;return 0===s?t.bits-e.bits:s});const r=n>rn.maxTableBits?rn.maxTableBits:n,a=[];let h=null;for(let t=0;t<i.length&&i[t].length<99999;t++){const e=i[t].length;if(e>r)for(h=[];t<i.length&&i[t].length<99999;t++)h.push(i[t]);else{const s=1<<r-e,n=i[t];for(let t=0;t<s;t++){const s=t<<e|n.bits;for(;a.length<=s;)a.push(null);a[s]=n}}}for(;a.length<1<<r;)a.push(null);this.tableBits=r,this.prefixTree=a,this.overflowList=h}}class an{constructor(t){t.readBits(16)}}class hn{coeff;amp=0;get executeChannel(){return(this.forceEnergy||this.amp>0)&&!this.forceNoEnergy}forceEnergy=!1;forceNoEnergy=!1;constructor(t){this.coeff=t}}class on{Tu;xu;Mu;vu;Nu;Pu;Cu;Eu;Fu;Au;constructor(t,e,i,n){if(this.Tu=t.readBits(8),this.xu=t.readBits(16),this.Mu=t.readBits(16),this.vu=t.readBits(6),this.Nu=t.readBits(8),this.Cu=new Array(t.readBits(4)+1),this.Tu<1||this.xu<1||this.Mu<1||0===this.Cu.length)throw new I(s.Format,"Vorbis: Invalid Floor0 Data");this.Pu=(1<<this.vu)-1;for(let e=0;e<this.Cu.length;e++){const i=t.readBits(8);if(i<0||i>=n.length)throw new I(s.Format,"Vorbis: Invalid Floor0 Data");const r=n[i];if(0===r.mapType||r.dimensions<1)throw new I(s.Format,"Vorbis: Invalid Floor0 Data");this.Cu[e]=r}this.Eu=Zi.ilog(this.Cu.length),this.Au=new Map([[e,this.Du(e/2)],[i,this.Du(i/2)]]),this.Fu=new Map([[e,this.Lu(e/2)],[i,this.Lu(i/2)]])}Du(t){const e=this.Mu/on.Wu(this.xu/2),s=new Int32Array(t+1);for(let i=0;i<t-1;i++)s[i]=Math.min(this.Mu-1,Math.floor(on.Wu(this.xu/2/t*i)*e));return s[t]=-1,s}static Wu(t){return 13.1*Math.atan(74e-5*t)+2.24*Math.atan(1.85e-8*t*t)+1e-4*t}Lu(t){const e=Math.PI/this.Mu,s=new Float32Array(t);for(let i=0;i<t;i++)s[i]=2*Math.cos(e*i);return s}unpack(t,e,s){const i=new hn(new Float32Array(this.Tu+1));if(i.amp=t.readBits(this.vu),i.amp>0){i.amp=i.amp/this.Pu*this.Nu;const e=t.readBits(this.Eu);if(e>=this.Cu.length)return i.amp=0,i;const s=this.Cu[e];for(let e=0;e<this.Tu;){const n=s.decodeScalar(t);if(-1===n)return i.amp=0,i;for(let t=0;e<this.Tu&&t<s.dimensions;t++,e++)i.coeff[e]=s.get(n,t)}let n=0;for(let t=0;t<this.Tu;){for(let e=0;t<this.Tu&&e<s.dimensions;t++,e++)i.coeff[t]+=n;n=i.coeff[t-1]}}return i}apply(t,e,s){const i=t,n=e/2;if(i.amp>0){const t=this.Au.get(e),r=this.Fu.get(e);let a=0;for(a=0;a<this.Tu;a++)i.coeff[a]=2*Math.cos(i.coeff[a]);for(a=0;a<n;){let e=0;const n=t[a];let h=.5,o=.5;const c=r[n];for(e=1;e<this.Tu;e+=2)o*=c-i.coeff[e-1],h*=c-i.coeff[e];for(e===this.Tu?(o*=c-i.coeff[e-1],h*=h*(4-c*c),o*=o):(h*=h*(2-c),o*=o*(2+c)),o=i.amp/Math.sqrt(h+o)-this.Nu,o=Math.exp(.11512925*o),s[a]*=o;t[++a]===n;)s[a]*=o}}else s.fill(0,0,n)}}class cn{posts=new Int32Array(64);postCount=0;get executeChannel(){return(this.forceEnergy||this.postCount>0)&&!this.forceNoEnergy}forceEnergy=!1;forceNoEnergy=!1}class ln{static Ou=[256,128,86,64];static Ru=[8,7,7,6];Iu;Gu;Hu;Vu;$u;Uu;zu;Xu;ju;Ju;qu;Yu;Ku;Qu;constructor(t,e){let i=-1;this.Iu=new Int32Array(t.readBits(5));for(let e=0;e<this.Iu.length;e++)this.Iu[e]=t.readBits(4),this.Iu[e]>i&&(i=this.Iu[e]);++i,this.Gu=new Int32Array(i),this.Hu=new Int32Array(i),this.Yu=new Array(i),this.$u=new Int32Array(i),this.Ku=new Array(i),this.Qu=new Array(i);for(let s=0;s<i;s++){this.Gu[s]=t.readBits(3)+1,this.Hu[s]=t.readBits(2),this.Hu[s]>0&&(this.$u[s]=t.readBits(8),this.Yu[s]=e[this.$u[s]]),this.Ku[s]=new Array(1<<this.Hu[s]),this.Qu[s]=new Int32Array(this.Ku[s].length);for(let i=0;i<this.Ku[s].length;i++){const n=t.readBits(8)-1;n>=0&&(this.Ku[s][i]=e[n]),this.Qu[s][i]=n}}this.ju=t.readBits(2),this.Ju=ln.Ou[this.ju],this.qu=ln.Ru[this.ju],++this.ju;const n=t.readBits(4),r=[];r.push(0),r.push(1<<n);for(let e=0;e<this.Iu.length;e++){const s=this.Iu[e];for(let e=0;e<this.Gu[s];e++)r.push(t.readBits(n))}this.Vu=new Int32Array(r),this.zu=new Int32Array(r.length),this.Uu=new Int32Array(r.length),this.Xu=new Int32Array(r.length),this.Xu[0]=0,this.Xu[1]=1;for(let t=2;t<this.zu.length;t++){this.zu[t]=0,this.Uu[t]=1,this.Xu[t]=t;for(let e=2;e<t;e++){const s=this.Vu[e];s<this.Vu[t]?s>this.Vu[this.zu[t]]&&(this.zu[t]=e):s<this.Vu[this.Uu[t]]&&(this.Uu[t]=e)}}for(let t=0;t<this.Xu.length-1;t++)for(let e=t+1;e<this.Xu.length;e++){if(this.Vu[t]===this.Vu[e])throw new I(s.Format,"Vorbis: Invalid Floor1 Data");if(this.Vu[this.Xu[t]]>this.Vu[this.Xu[e]]){const s=this.Xu[t];this.Xu[t]=this.Xu[e],this.Xu[e]=s}}}unpack(t,e,s){const i=new cn;if(t.readBit()){let e=2;i.posts[0]=t.readBits(this.qu),i.posts[1]=t.readBits(this.qu);for(let s=0;s<this.Iu.length;s++){const n=this.Iu[s],r=this.Gu[n],a=this.Hu[n],h=(1<<a)-1;let o=0;if(a>0&&(o=this.Yu[n].decodeScalar(t),-1===o)){e=0;break}for(let c=0;c<r;c++){const r=this.Ku[n][o&h];if(o>>=a,null!=r&&(i.posts[e]=r.decodeScalar(t),-1===i.posts[e])){e=0,s=this.Iu.length;break}++e}}i.postCount=e}return i}apply(t,e,s){const i=t,n=e/2;if(i.postCount>0){const t=this.Zu(i);let e=0,r=i.posts[0]*this.ju;for(let a=1;a<i.postCount;a++){const h=this.Xu[a];if(t[h]){const t=this.Vu[h],a=i.posts[h]*this.ju;e<n&&this.td(e,r,Math.min(t,n),a,s),e=t,r=a}if(e>=n)break}e<n&&this.td(e,r,n,r,s)}else s.fill(0,0,n)}Zu(t){const e=new Array(64);e.fill(!1),e[0]=!0,e[1]=!0;const s=new Int32Array(64);s[0]=t.posts[0],s[1]=t.posts[1];for(let i=2;i<t.postCount;i++){const n=this.zu[i],r=this.Uu[i],a=this.ed(this.Vu[n],s[n],this.Vu[r],s[r],this.Vu[i]),h=t.posts[i],o=this.Ju-a,c=a;let l;l=o<c?2*o:2*c,0!==h?(e[n]=!0,e[r]=!0,e[i]=!0,s[i]=h>=l?o>c?h-c+a:a-h+o-1:h%2==1?a-(h+1)/2:a+h/2):(e[i]=!1,s[i]=a)}for(let e=0;e<t.postCount;e++)t.posts[e]=s[e];return e}ed(t,e,s,i,n){const r=i-e,a=s-t,h=Math.abs(r)*(n-t)/a|0;return r<0?e-h:e+h}td(t,e,s,i,n){const r=i-e,a=s-t;let h=Math.abs(r);const o=1-2*(r>>31&1),c=r/a|0;let l=t,u=e,d=-a;for(n[t]*=ln.sd[e],h-=Math.abs(c)*a;++l<s;)u+=c,d+=h,d>=0&&(d-=a,u+=o),n[l]*=ln.sd[u]}static sd=new Float32Array([1.0649863e-7,1.1341951e-7,1.2079015e-7,1.2863978e-7,1.3699951e-7,1.4590251e-7,1.5538408e-7,1.6548181e-7,1.7623575e-7,1.8768855e-7,1.9988561e-7,2.128753e-7,2.2670913e-7,2.4144197e-7,2.5713223e-7,2.7384213e-7,2.9163793e-7,3.1059021e-7,3.3077411e-7,3.5226968e-7,3.7516214e-7,3.9954229e-7,4.255068e-7,4.5315863e-7,4.8260743e-7,5.1396998e-7,5.4737065e-7,5.8294187e-7,6.2082472e-7,6.6116941e-7,7.0413592e-7,7.4989464e-7,7.9862701e-7,8.505263e-7,9.0579828e-7,9.6466216e-7,10273513e-13,10941144e-13,11652161e-13,12409384e-13,13215816e-13,14074654e-13,14989305e-13,15963394e-13,17000785e-13,18105592e-13,19282195e-13,20535261e-13,21869758e-13,23290978e-13,24804557e-13,26416497e-13,2813319e-12,29961443e-13,31908506e-13,33982101e-13,36190449e-13,38542308e-13,41047004e-13,4371447e-12,46555282e-13,49580707e-13,5280274e-12,5623416e-12,59888572e-13,63780469e-13,67925283e-13,72339451e-13,77040476e-13,82047e-10,87378876e-13,93057248e-13,99104632e-13,10554501e-12,11240392e-12,11970856e-12,12748789e-12,13577278e-12,14459606e-12,15399272e-12,16400004e-12,17465768e-12,18600792e-12,19809576e-12,21096914e-12,22467911e-12,23928002e-12,25482978e-12,27139006e-12,28902651e-12,30780908e-12,32781225e-12,34911534e-12,37180282e-12,39596466e-12,42169667e-12,4491009e-11,47828601e-12,50936773e-12,54246931e-12,57772202e-12,61526565e-12,65524908e-12,69783085e-12,74317983e-12,79147585e-12,8429104e-11,89768747e-12,95602426e-12,.00010181521,.00010843174,.00011547824,.00012298267,.00013097477,.00013948625,.00014855085,.00015820453,.00016848555,.00017943469,.00019109536,.00020351382,.00021673929,.00023082423,.00024582449,.00026179955,.00027881276,.00029693158,.00031622787,.00033677814,.00035866388,.00038197188,.00040679456,.00043323036,.00046138411,.00049136745,.00052329927,.00055730621,.00059352311,.00063209358,.00067317058,716917e-9,.0007635063,.00081312324,.00086596457,.00092223983,.00098217216,.0010459992,.0011139742,.0011863665,.0012634633,.0013455702,.0014330129,.0015261382,.0016253153,.0017309374,.0018434235,.0019632195,.0020908006,.0022266726,.0023713743,.0025254795,.0026895994,.0028643847,.0030505286,.0032487691,.0034598925,.0036847358,.0039241906,.0041792066,.004450795,.0047400328,.0050480668,.0053761186,.0057254891,.0060975636,.0064938176,.0069158225,.0073652516,.0078438871,.0083536271,.0088964928,.009474637,.010090352,.01074608,.011444421,.012188144,.012980198,.013823725,.014722068,.015678791,.016697687,.017782797,.018938423,.020169149,.021479854,.022875735,.02436233,.025945531,.027631618,.029427276,.031339626,.033376252,.035545228,.037855157,.040315199,.042935108,.045725273,.048696758,.051861348,.055231591,.05882085,.062643361,.066714279,.071049749,.075666962,.080584227,.085821044,.091398179,.097337747,.1036633,.11039993,.11757434,.12521498,.13335215,.14201813,.15124727,.16107617,.1715438,.18269168,.19456402,.20720788,.22067342,.23501402,.25028656,.26655159,.28387361,.30232132,.32196786,.34289114,.36517414,.38890521,.41417847,.44109412,.4697589,.50028648,.53279791,.56742212,.6042964,.64356699,.68538959,.72993007,.77736504,.8278826,.88168307,.9389798,1])}class un{floor;constructor(t,e,i,n){const r=t.readBits(16);switch(r){case 0:this.floor=new on(t,e,i,n);break;case 1:this.floor=new ln(t,n);break;default:throw new I(s.Format,`Vorbis: Invalid Floor type: ${r}`)}}apply(t,e,s){this.floor.apply(t,e,s)}unpack(t,e,s){return this.floor.unpack(t,e,s)}}class dn{nd;rd;ad;hd;od;ld;Cu;ud;dd;fd;constructor(t,e,i){this.rd=t.readBits(24),this.ad=t.readBits(24),this.hd=t.readBits(24)+1,this.od=t.readBits(6)+1,this.ud=i[t.readBits(8)],this.dd=new Int32Array(this.od);let n=0;for(let e=0;e<this.od;e++){const s=t.readBits(3);t.readBit()?this.dd[e]=t.readBits(5)<<3|s:this.dd[e]=s,n+=dn.pd(this.dd[e])}const r=new Int32Array(n);for(let e=0;e<n;e++)if(r[e]=t.readBits(8),0===i[r[e]].mapType)throw new I(s.Format,"Vorbis: Invalid Residue 0");const a=this.ud.entries;let h=this.ud.dimensions,o=1;for(;h>0;){if(o*=this.od,o>a)throw new I(s.Format,"Vorbis: Invalid Residue 0");--h}this.Cu=new Array(this.od),n=0;let c,l=0;for(let t=0;t<this.od;t++)if(c=Zi.ilog(this.dd[t]),this.Cu[t]=new Array(c),c>0){l=Math.max(l,c);for(let e=0;e<c;e++)(this.dd[t]&1<<e)>0&&(this.Cu[t][e]=i[r[n++]])}this.ld=l,this.fd=new Array(o);for(let t=0;t<o;t++){let e=t,s=o/this.od|0;this.fd[t]=new Int32Array(this.ud.dimensions);for(let i=0;i<this.ud.dimensions;i++){const n=e/s|0;e-=n*s,s=s/this.od|0,this.fd[t][i]=n}}this.nd=e}static pd(t){let e=0;for(;0!==t;)e+=1&t,t>>=1;return e}decode(t,e,s,i){const n=(this.ad<s/2?this.ad:s/2)-this.rd;if(n>0&&-1!==e.indexOf(!1)){const e=n/this.hd,s=(e+this.ud.dimensions-1)/this.ud.dimensions|0,r=[];for(let t=0;t<this.nd;t++)r.push(new Array(s));for(let s=0;s<this.ld;s++)for(let n=0,a=0;n<e;a++){if(0===s)for(let i=0;i<this.nd;i++){const h=this.ud.decodeScalar(t);if(!(h>=0&&h<this.fd.length)){n=e,s=this.ld;break}r[i][a]=this.fd[h]}for(let h=0;n<e&&h<this.ud.dimensions;h++,n++){const o=this.rd+n*this.hd;for(let c=0;c<this.nd;c++){const l=r[c][a][h];if(this.dd[l]&1<<s){const r=this.Cu[l][s];if(r&&this.writeVectors(r,t,i,c,o,this.hd)){n=e,s=this.ld;break}}}}}}}writeVectors(t,e,s,i,n,r){const a=s[i],h=r/t.dimensions,o=new Int32Array(h);for(let s=0;s<h;s++)if(o[s]=t.decodeScalar(e),-1===o[s])return!0;for(let e=0;e<t.dimensions;e++)for(let s=0;s<h;s++,n++)a[n]+=t.get(o[s],e);return!1}}class fn extends dn{writeVectors(t,e,s,i,n,r){const a=s[i];for(let s=0;s<r;){const i=t.decodeScalar(e);if(-1===i)return!0;for(let e=0;e<t.dimensions;s++,e++)a[n+s]+=t.get(i,e)}return!1}}class pn extends dn{bd;constructor(t,e,s){super(t,1,s),this.bd=e}decode(t,e,s,i){super.decode(t,e,s*this.bd,i)}writeVectors(t,e,s,i,n,r){let a=0;n/=this.bd;for(let i=0;i<r;){const r=t.decodeScalar(e);if(-1===r)return!0;for(let e=0;e<t.dimensions;e++,i++)s[a][n]+=t.get(r,e),++a===this.bd&&(a=0,n++)}return!1}}class bn{residue;constructor(t,e,i){const n=t.readBits(16);switch(n){case 0:this.residue=new dn(t,e,i);break;case 1:this.residue=new fn(t,e,i);break;case 2:this.residue=new pn(t,e,i);break;default:throw new I(s.Format,`Vorbis: Invalid Residue type: ${n}`)}}decode(t,e,s,i){this.residue.decode(t,e,s,i)}}class mn{md;gd;wd;yd;kd;Sd;Bd;constructor(t,e,i,n,r){if(0!==t.readBits(16))throw new I(s.Format,"Vorbis: Invalid mapping type!");let a=1;t.readBit()&&(a+=t.readBits(4));let h=0;t.readBit()&&(h=t.readBits(8)+1);const o=Zi.ilog(e-1);this.gd=new Int32Array(h),this.wd=new Int32Array(h);for(let i=0;i<h;i++){const n=t.readBits(o),r=t.readBits(o);if(n===r||n>e-1||r>e-1)throw new I(s.Format,"Vorbis: Invalid magnitude or angle in mapping header!");this.gd[i]=r,this.wd[i]=n}if(0!==t.readBits(2))throw new I(s.Format,"Vorbis: Reserved bits not 0 in mapping header.");const c=new Int32Array(e);if(a>1)for(let i=0;i<e;i++)if(c[i]=t.readBits(4),c[i]>a)throw new I(s.Format,"Vorbis: Invalid channel mux submap index in mapping header!");this.yd=new Array(a),this.kd=new Array(a);for(let e=0;e<a;e++){t.skipBits(8);const r=t.readBits(8);if(r>=i.length)throw new I(s.Format,"Vorbis: Invalid floor number in mapping header!");const a=t.readBits(8);if(a>=n.length)throw new I(s.Format,"Vorbis: Invalid residue number in mapping header!");this.yd[e]=i[r],this.kd[e]=n[a]}this.Sd=new Array(e),this.Bd=new Array(e);for(let t=0;t<e;t++)this.Sd[t]=this.yd[c[t]],this.Bd[t]=this.kd[c[t]];this.md=r}decodePacket(t,e,s){const i=e>>1,n=new Array(this.Sd.length),r=new Array(this.Sd.length);r.fill(!1);for(let a=0;a<this.Sd.length;a++)n[a]=this.Sd[a].unpack(t,e,a),r[a]=!n[a].executeChannel,s[a].fill(0,0,i);for(let t=0;t<this.gd.length;t++)(n[this.gd[t]].executeChannel||n[this.wd[t]].executeChannel)&&(n[this.gd[t]].forceEnergy=!0,n[this.wd[t]].forceEnergy=!0);for(let i=0;i<this.yd.length;i++){for(let t=0;t<this.Sd.length;t++)this.yd[i]===this.Sd[t]&&this.kd[i]===this.Bd[t]||(n[t].forceNoEnergy=!0);this.kd[i].decode(t,r,e,s)}for(let t=this.gd.length-1;t>=0;t--)if(n[this.gd[t]].executeChannel||n[this.wd[t]].executeChannel){const e=s[this.wd[t]],n=s[this.gd[t]];for(let t=0;t<i;t++){let s,i;const r=e[t],a=n[t];r>0?a>0?(s=r,i=r-a):(i=r,s=r+a):a>0?(s=r,i=r+a):(i=r,s=r-a),e[t]=s,n[t]=i}}for(let t=0;t<this.Sd.length;t++)n[t].executeChannel?(this.Sd[t].apply(n[t],e,s[t]),this.md.reverse(s[t],e)):s[t].fill(0,i,2*i)}}class gn{packetStartIndex=0;packetTotalLength=0;packetValidLength=0}class wn{overlapInfo=new gn;windowIndex=0}class yn{samplePosition=null;constructor(t=null){this.samplePosition=t}}class kn{static _d=1.57079632695;nd;Td;xd;Md;vd;Nd=null;constructor(t,e,i,n,r){if(this.nd=e,this.Td=t.readBit(),0!==t.readBits(32))throw new I(s.Format,"Vorbis: Mode header had invalid window or transform type!");const a=t.readBits(8);if(a>=r.length)throw new I(s.Format,"Vorbis: Mode header had invalid mapping index!");this.Md=r[a],this.Td?(this.xd=n,this.vd=[kn.Pd(i,n,i),kn.Pd(n,n,i),kn.Pd(i,n,n),kn.Pd(n,n,n)],this.Nd=[kn.Cd(i,n,i),kn.Cd(n,n,i),kn.Cd(i,n,n),kn.Cd(n,n,n)]):(this.xd=i,this.vd=[kn.Pd(i,i,i)])}decode(t,e){const s=this.Ed(t);this.Md.decodePacket(t,this.xd,e);const i=this.vd[s.windowIndex];for(let t=0;t<this.xd;t++)for(let s=0;s<this.nd;s++)e[s][t]*=i[t];return s.overlapInfo}Ed(t){const e=new wn;if(this.Td){const s=t.readBit(),i=t.readBit();e.windowIndex=(s?1:0)+(i?2:0);const n=this.Nd[e.windowIndex];e.overlapInfo.packetStartIndex=n.packetStartIndex,e.overlapInfo.packetValidLength=n.packetValidLength,e.overlapInfo.packetTotalLength=n.packetTotalLength}else e.windowIndex=0,e.overlapInfo.packetStartIndex=0,e.overlapInfo.packetValidLength=this.xd/2,e.overlapInfo.packetTotalLength=this.xd;return e}static Pd(t,e,s){const i=new Float32Array(e),n=t/2,r=s/2,a=e/4-n/2,h=e-e/4-r/2;for(let t=0;t<n;t++){let e=Math.sin((t+.5)/n*kn._d);e*=e,i[a+t]=Math.sin(e*kn._d)}for(let t=a+n;t<h;t++)i[t]=1;for(let t=0;t<r;t++){let e=Math.sin((r-t-.5)/r*kn._d);e*=e,i[h+t]=Math.sin(e*kn._d)}return i}static Cd(t,e,s){const i=s/4,n=e/4-t/4,r=e/4*3+i,a=r-2*i,h=new gn;return h.packetStartIndex=n,h.packetValidLength=a,h.packetTotalLength=r,h}}class Sn{static Fd=3.141592653589793;Ad;Dd;Ld;Wd;Od;Rd;Id;Gd;Hd;constructor(t){this.Ad=t,this.Dd=t>>1,this.Ld=this.Dd>>1,this.Wd=this.Ld>>1,this.Od=Zi.ilog(t)-1,this.Rd=new Float32Array(this.Dd),this.Id=new Float32Array(this.Dd),this.Gd=new Float32Array(this.Ld);let e=0,s=0;for(;e<this.Ld;++e,s+=2)this.Rd[s]=Math.cos(4*e*Sn.Fd/t),this.Rd[s+1]=-Math.sin(4*e*Sn.Fd/t),this.Id[s]=.5*Math.cos((s+1)*Sn.Fd/t/2),this.Id[s+1]=.5*Math.sin((s+1)*Sn.Fd/t/2);for(e=0,s=0;e<this.Wd;++e,s+=2)this.Gd[s]=Math.cos(2*(s+1)*Sn.Fd/t),this.Gd[s+1]=-Math.sin(2*(s+1)*Sn.Fd/t);this.Hd=new Uint16Array(this.Wd);for(let t=0;t<this.Wd;++t)this.Hd[t]=ue.int32ToUint16(Zi.bitReverse(t,this.Od-3)<<2)}calcReverse(t){let e,s;const i=new Float32Array(this.Dd);{let e=this.Dd-2,s=0,n=0;const r=this.Dd;for(;n!==r;)i[e+1]=t[n]*this.Rd[s]-t[n+2]*this.Rd[s+1],i[e]=t[n]*this.Rd[s+1]+t[n+2]*this.Rd[s],e-=2,s+=2,n+=4;for(n=this.Dd-3;e>=0;)i[e+1]=-t[n+2]*this.Rd[s]- -t[n]*this.Rd[s+1],i[e]=-t[n+2]*this.Rd[s+1]+-t[n]*this.Rd[s],e-=2,s+=2,n-=4}e=t,s=i;{let t=this.Dd-8,i=this.Ld,n=0,r=this.Ld,a=0;for(;t>=0;){let h,o;o=s[i+1]-s[n+1],h=s[i]-s[n],e[r+1]=s[i+1]+s[n+1],e[r]=s[i]+s[n],e[a+1]=o*this.Rd[t+4]-h*this.Rd[t+5],e[a]=h*this.Rd[t+4]+o*this.Rd[t+5],o=s[i+3]-s[n+3],h=s[i+2]-s[n+2],e[r+3]=s[i+3]+s[n+3],e[r+2]=s[i+2]+s[n+2],e[a+3]=o*this.Rd[t]-h*this.Rd[t+1],e[a+2]=h*this.Rd[t]+o*this.Rd[t+1],t-=8,r+=4,a+=4,i+=4,n+=4}}this.Vd(this.Ad>>4,e,this.Dd-1-0*this.Ld,-this.Wd),this.Vd(this.Ad>>4,e,this.Dd-1-1*this.Ld,-this.Wd),this.$d(this.Ad>>5,e,this.Dd-1-0*this.Wd,-(this.Ad>>4),16),this.$d(this.Ad>>5,e,this.Dd-1-1*this.Wd,-(this.Ad>>4),16),this.$d(this.Ad>>5,e,this.Dd-1-2*this.Wd,-(this.Ad>>4),16),this.$d(this.Ad>>5,e,this.Dd-1-3*this.Wd,-(this.Ad>>4),16);let n=2;for(;n<this.Od-3>>1;++n){const t=this.Ad>>n+2,s=t>>1,i=1<<n+1;for(let r=0;r<i;++r)this.$d(this.Ad>>n+4,e,this.Dd-1-t*r,-s,1<<n+3)}for(;n<this.Od-6;++n){const t=this.Ad>>n+2,s=1<<n+3,i=t>>1,r=this.Ad>>n+6,a=1<<n+1;let h=this.Dd-1,o=0;for(let n=r;n>0;--n)this.Ud(a,e,h,-i,o,s,t),o+=4*s,h-=8}this.zd(this.Ad>>5,e,this.Dd-1,this.Ad);{let t=0,i=this.Ld-4,n=this.Dd-4;for(;i>=0;){let r;r=this.Hd[t],s[n+3]=e[r],s[n+2]=e[r+1],s[i+3]=e[r+2],s[i+2]=e[r+3],r=this.Hd[t+1],s[n+1]=e[r],s[n]=e[r+1],s[i+1]=e[r+2],s[i]=e[r+3],i-=4,n-=4,t+=2}}{let t=0,e=0,i=this.Dd-4;for(;e<i;){let n,r,a,h,o,c;n=s[e]-s[i+2],r=s[e+1]+s[i+3],a=this.Gd[t+1]*n+this.Gd[t]*r,h=this.Gd[t+1]*r-this.Gd[t]*n,o=s[e]+s[i+2],c=s[e+1]-s[i+3],s[e]=o+a,s[e+1]=c+h,s[i+2]=o-a,s[i+3]=h-c,n=s[e+2]-s[i],r=s[e+3]+s[i+1],a=this.Gd[t+3]*n+this.Gd[t+2]*r,h=this.Gd[t+3]*r-this.Gd[t+2]*n,o=s[e+2]+s[i],c=s[e+3]-s[i+1],s[e+2]=o+a,s[e+3]=c+h,s[i]=o-a,s[i+1]=h-c,t+=4,e+=4,i-=4}}{let e=this.Dd-8,s=this.Dd-8,n=0,r=this.Dd-4,a=this.Dd,h=this.Ad-4;for(;s>=0;){let o,c,l,u;u=i[s+6]*this.Id[e+7]-i[s+7]*this.Id[e+6],l=-i[s+6]*this.Id[e+6]-i[s+7]*this.Id[e+7],t[n]=u,t[r+3]=-u,t[a]=l,t[h+3]=l,c=i[s+4]*this.Id[e+5]-i[s+5]*this.Id[e+4],o=-i[s+4]*this.Id[e+4]-i[s+5]*this.Id[e+5],t[n+1]=c,t[r+2]=-c,t[a+1]=o,t[h+2]=o,u=i[s+2]*this.Id[e+3]-i[s+3]*this.Id[e+2],l=-i[s+2]*this.Id[e+2]-i[s+3]*this.Id[e+3],t[n+2]=u,t[r+1]=-u,t[a+2]=l,t[h+1]=l,c=i[s]*this.Id[e+1]-i[s+1]*this.Id[e],o=-i[s]*this.Id[e]-i[s+1]*this.Id[e+1],t[n+3]=c,t[r]=-c,t[a+3]=o,t[h]=o,e-=8,s-=8,n+=4,a+=4,r-=4,h-=4}}}$d(t,e,s,i,n){let r,a,h=s,o=h+i,c=0;for(let s=t>>2;s>0;--s)r=e[h]-e[o],a=e[h-1]-e[o-1],e[h]+=e[o],e[h-1]+=e[o-1],e[o]=r*this.Rd[c]-a*this.Rd[c+1],e[o-1]=a*this.Rd[c]+r*this.Rd[c+1],c+=n,r=e[h-2]-e[o-2],a=e[h-3]-e[o-3],e[h-2]+=e[o-2],e[h-3]+=e[o-3],e[o-2]=r*this.Rd[c]-a*this.Rd[c+1],e[o-3]=a*this.Rd[c]+r*this.Rd[c+1],c+=n,r=e[h-4]-e[o-4],a=e[h-5]-e[o-5],e[h-4]+=e[o-4],e[h-5]+=e[o-5],e[o-4]=r*this.Rd[c]-a*this.Rd[c+1],e[o-5]=a*this.Rd[c]+r*this.Rd[c+1],c+=n,r=e[h-6]-e[o-6],a=e[h-7]-e[o-7],e[h-6]+=e[o-6],e[h-7]+=e[o-7],e[o-6]=r*this.Rd[c]-a*this.Rd[c+1],e[o-7]=a*this.Rd[c]+r*this.Rd[c+1],c+=n,h-=8,o-=8}Vd(t,e,s,i){let n=s,r=n+i,a=0;for(let s=t>>2;s>0;--s){let t,s;t=e[n]-e[r],s=e[n-1]-e[r-1],e[n]+=e[r],e[n-1]+=e[r-1],e[r]=t*this.Rd[a]-s*this.Rd[a+1],e[r-1]=s*this.Rd[a]+t*this.Rd[a+1],a+=8,t=e[n-2]-e[r-2],s=e[n-3]-e[r-3],e[n-2]+=e[r-2],e[n-3]+=e[r-3],e[r-2]=t*this.Rd[a]-s*this.Rd[a+1],e[r-3]=s*this.Rd[a]+t*this.Rd[a+1],a+=8,t=e[n-4]-e[r-4],s=e[n-5]-e[r-5],e[n-4]+=e[r-4],e[n-5]+=e[r-5],e[r-4]=t*this.Rd[a]-s*this.Rd[a+1],e[r-5]=s*this.Rd[a]+t*this.Rd[a+1],a+=8,t=e[n-6]-e[r-6],s=e[n-7]-e[r-7],e[n-6]+=e[r-6],e[n-7]+=e[r-7],e[r-6]=t*this.Rd[a]-s*this.Rd[a+1],e[r-7]=s*this.Rd[a]+t*this.Rd[a+1],a+=8,n-=8,r-=8}}Ud(t,e,s,i,n,r,a){const h=this.Rd[n],o=this.Rd[n+1],c=this.Rd[n+r],l=this.Rd[n+r+1],u=this.Rd[n+2*r],d=this.Rd[n+2*r+1],f=this.Rd[n+3*r],p=this.Rd[n+3*r+1];let b,m,g=s,w=g+i;for(let s=t;s>0;--s)b=e[g]-e[w],m=e[g-1]-e[w-1],e[g]+=e[w],e[g-1]+=e[w-1],e[w]=b*h-m*o,e[w-1]=m*h+b*o,b=e[g-2]-e[w-2],m=e[g-3]-e[w-3],e[g-2]+=e[w-2],e[g-3]+=e[w-3],e[w-2]=b*c-m*l,e[w-3]=m*c+b*l,b=e[g-4]-e[w-4],m=e[g-5]-e[w-5],e[g-4]+=e[w-4],e[g-5]+=e[w-5],e[w-4]=b*u-m*d,e[w-5]=m*u+b*d,b=e[g-6]-e[w-6],m=e[g-7]-e[w-7],e[g-6]+=e[w-6],e[g-7]+=e[w-7],e[w-6]=b*f-m*p,e[w-7]=m*f+b*p,g-=a,w-=a}zd(t,e,s,i){const n=i>>3,r=this.Rd[n];let a=s;const h=a-16*t;for(;a>h;){let t,s;t=e[a]-e[a-8],s=e[a-1]-e[a-9],e[a]+=e[a-8],e[a-1]+=e[a-9],e[a-8]=t,e[a-9]=s,t=e[a-2]-e[a-10],s=e[a-3]-e[a-11],e[a-2]+=e[a-10],e[a-3]+=e[a-11],e[a-10]=(t+s)*r,e[a-11]=(s-t)*r,t=e[a-12]-e[a-4],s=e[a-5]-e[a-13],e[a-4]+=e[a-12],e[a-5]+=e[a-13],e[a-12]=s,e[a-13]=t,t=e[a-14]-e[a-6],s=e[a-7]-e[a-15],e[a-6]+=e[a-14],e[a-7]+=e[a-15],e[a-14]=(t+s)*r,e[a-15]=(t-s)*r,this.Xd(e,a),this.Xd(e,a-8),a-=16}}Xd(t,e){const s=t[e]-t[e-4],i=t[e]+t[e-4],n=t[e-2]+t[e-6],r=t[e-2]-t[e-6];t[e]=i+n,t[e-2]=i-n;const a=t[e-3]-t[e-7];t[e-4]=s+a,t[e-6]=s-a;const h=t[e-1]-t[e-5],o=t[e-1]+t[e-5],c=t[e-3]+t[e-7];t[e-1]=o+c,t[e-3]=o-c,t[e-5]=h-r,t[e-7]=h+r}}class Bn{jd=new Map;reverse(t,e){let s;this.jd.has(e)?s=this.jd.get(e):(s=new Sn(e),this.jd.set(e,s)),s.calcReverse(t)}}class _n{Jd;qd;Yd;Kd=0;Qd;Zd;tf;ef;sf;if;nf;rf;af;constructor(t,e,s){this.Jd=t,this.qd=e,this.Yd=s,this.if=0,this.Zd=null,this.tf=0,this.ef=0,this.sf=0,this.Qd=null,this.rf=!1,this.nf=!1,this.af=Zi.ilog(e.modes.length-1)}decode(){let t=new Float32Array(this.Yd[this.Yd.length-1].granulePosition*this.Jd.audioChannels);const e=new Float32Array(.2*this.Jd.audioSampleRate*this.Jd.audioChannels);let s=0,i=0;for(;s=this.read(e,0,e.length),0!==s;){if(i+s>=t.length){const s=new Float32Array(t.length+e.length);s.set(t,0),t=s}t.set(e.subarray(0,s),i),i+=s}return t.subarray(0,i)}read(t,e,s){if(0===s)return 0;let i=e;const n=e+s;for(;i<n;){if(this.tf===this.ef){if(this.rf){this.Qd=null,this.Zd=null;break}const t=this.hf((i-e)/this.Jd.audioChannels);null===t&&(this.ef=this.sf),null===t||null===t.samplePosition||this.nf||(this.nf=!0,this.if=t.samplePosition-(this.ef-this.tf)-(i-e)/this.Jd.audioChannels)}const s=Math.min((n-i)/this.Jd.audioChannels,this.ef-this.tf);s>0&&(i+=this.cf(t,i,s))}return s=i-e,this.if+=s/this.Jd.audioChannels,s}cf(t,e,s){let i=e;for(;s>0;this.tf++,s--)for(let e=0;e<this.Jd.audioChannels;e++)t[i++]=this.Zd[e][this.tf];return i-e}hf(t){const e=this.lf();if(this.rf=this.rf||e.isEndOfStream,null==e.curPacket)return null;if(null!==e.samplePosition&&e.isEndOfStream){const s=this.if+t+e.validLen-e.startIndex,i=e.samplePosition-s;i<0&&(e.validLen+=i,e.validLen<0&&(e.validLen=0))}return this.ef>0?(_n.uf(this.Zd,e.curPacket,this.tf,this.sf,e.startIndex,this.Jd.audioChannels),this.tf=e.startIndex):null==this.Zd&&(this.tf=e.validLen),this.Qd=this.Zd,this.ef=e.validLen,this.sf=e.totalLen,this.Zd=e.curPacket,new yn(e.samplePosition)}static uf(t,e,s,i,n,r){for(;s<i;s++,n++)for(let i=0;i<r;i++)e[i][n]+=t[i][s]}lf(){const t=new Tn;let e=null;if(this.Kd>=this.Yd.length)t.isEndOfStream=!0;else{e=this.Yd[this.Kd++];const s=new Ki(Fe.fromBuffer(e.packetData));if(t.isEndOfStream=e.isEndOfStream,!s.readBit()){const i=this.qd.modes[s.readBits(this.af)];if(null==this.Qd){this.Qd=new Array(this.Jd.audioChannels);for(let t=0;t<this.Jd.audioChannels;t++)this.Qd[t]=new Float32Array(this.Jd.blocksize1)}const n=i.decode(s,this.Qd);return t.startIndex=n.packetStartIndex,t.validLen=n.packetValidLength,t.totalLen=n.packetTotalLength,t.samplePosition=e.granulePosition,t.curPacket=this.Qd,t}}return t}}class Tn{curPacket=null;startIndex=0;validLen=0;totalLen=0;isEndOfStream=!1;samplePosition=null}!function(t){t[t.IdentificationHeader=1]="IdentificationHeader",t[t.Comment=3]="Comment",t[t.SetupHeader=5]="SetupHeader"}(Ze||(Ze={}));class xn{static vorbisHeaderMarker=new Uint8Array(["v".charCodeAt(0),"o".charCodeAt(0),"r".charCodeAt(0),"b".charCodeAt(0),"i".charCodeAt(0),"s".charCodeAt(0)]);Yd;Kd;constructor(t){this.Kd=-1,this.Yd=t}read(){let t;for(;;){if(t=this.df(),null==t)return null;if(t.isBeginningOfStream){const e=this.ff(t);if(null!=e)return e}}}df(){return this.Kd++,this.Kd<this.Yd.length?this.Yd[this.Kd]:null}ff(t){const e=new qi;if(!this.pf(e,t))return null;if(!this.bf(this.df()))return null;const s=new Qi;if(!this.mf(e,s,this.df()))return null;const i=[];let n;for(;n=this.df(),null!=n&&(i.push(n),!n.isEndOfStream););const r=new _n(e,s,i);return e.samples=r.decode(),e}gf(t,e){const s=new Uint8Array(7);if(e.read(s,0,s.length),s[0]!==t)return!1;for(let t=0;t<xn.vorbisHeaderMarker.length;t++)if(s[1+t]!==xn.vorbisHeaderMarker[t])return!1;return!0}wf(t,e){const s=e.readBytes(7);if(s[0]!==t)return!1;for(let t=0;t<xn.vorbisHeaderMarker.length;t++)if(s[1+t]!==xn.vorbisHeaderMarker[t])return!1;return!0}pf(t,e){const s=Fe.fromBuffer(e.packetData);if(!this.gf(Ze.IdentificationHeader,s))return!1;if(0!==de.readUInt32LE(s))return!1;if(t.audioChannels=s.readByte(),t.audioSampleRate=de.readUInt32LE(s),t.audioChannels<=0||t.audioSampleRate<=0)return!1;t.bitrateMaximum=de.readInt32LE(s),t.bitrateNominal=de.readInt32LE(s),t.bitrateMinimum=de.readInt32LE(s);const i=s.readByte();if(t.blocksize0=1<<(15&i),t.blocksize1=1<<(i>>4),t.blocksize0>t.blocksize1||!xn.yf(t.blocksize0)||!xn.yf(t.blocksize0))return!1;return 0!==s.readByte()}static yf(t){switch(t){case 64:case 128:case 256:case 512:case 1024:case 2048:case 4096:case 8192:return!0;default:return!1}}bf(t){if(null==t)return!1;const e=Fe.fromBuffer(t.packetData);if(!this.gf(Ze.Comment,e))return!1;const s=de.readUInt32LE(e);e.skip(s);const i=de.readUInt32LE(e);for(let t=0;t<i;t++){const t=de.readUInt32LE(e);e.skip(t)}return 0!==e.readByte()}mf(t,e,s){if(null==s)return!1;const i=new Ki(Fe.fromBuffer(s.packetData)),n=new Bn,r=new rn;if(!this.wf(Ze.SetupHeader,i))return!1;let a=i.readByte()+1;for(let t=0;t<a;t++)e.codebooks.push(new sn(i,r));a=i.readBits(6)+1;for(let t=0;t<a;t++)e.timeDomainTransforms.push(new an(i));a=i.readBits(6)+1;for(let s=0;s<a;s++)e.floors.push(new un(i,t.blocksize0,t.blocksize1,e.codebooks));a=i.readBits(6)+1;for(let s=0;s<a;s++)e.residues.push(new bn(i,t.audioChannels,e.codebooks));a=i.readBits(6)+1;for(let s=0;s<a;s++)e.mappings.push(new mn(i,t.audioChannels,e.floors,e.residues,n));a=i.readBits(6)+1;for(let s=0;s<a;s++)e.modes.push(new kn(i,t.audioChannels,t.blocksize0,t.blocksize1,e.mappings));return!!i.readBit()}}class Mn{streams=[];constructor(t){const e=new Ji(t).read(),s=new xn(e);for(;;){const t=s.read();if(null==t)break;this.streams.push(t)}}}class vn{phdrs=[];pbags=[];pmods=[];pgens=[];insts=[];ibags=[];imods=[];igens=[];sHdrs=[];sampleData=new Uint8Array(0);kf=new Map;decodeSamples(t,e,s){const i=`${t}_${e}_${s}`;if(!this.kf.has(i)){let n;const r=this.sampleData.slice(t,e);if(s){n=new Mn(Fe.fromBuffer(r)).streams[0].samples}else{const t=new DataView(r.buffer,r.byteOffset,r.length);n=new Float32Array(r.length/2);for(let e=0;e<n.length;e++)n[e]=t.getInt16(2*e,!0)/32767}return this.kf.set(i,n),n}return this.kf.get(i)}load(t){const e=new Xi,s=new Xi;if(!Xi.load(null,e,t)||"sfbk"!==e.id)throw new ye("Soundfont is not a valid Soundfont2 file");for(;Xi.load(e,s,t);){const e=new Xi;if("pdta"===s.id)for(;Xi.load(s,e,t);)switch(e.id){case"phdr":for(let s=0,i=e.size/Dn.SizeInFile|0;s<i;s++)this.phdrs.push(new Dn(t));break;case"pbag":for(let s=0,i=e.size/Fn.SizeInFile|0;s<i;s++)this.pbags.push(new Fn(t));break;case"pmod":for(let s=0,i=e.size/Ln.SizeInFile|0;s<i;s++)this.pmods.push(new Ln(t));break;case"pgen":for(let s=0,i=e.size/An.SizeInFile|0;s<i;s++)this.pgens.push(new An(t));break;case"inst":for(let s=0,i=e.size/En.SizeInFile|0;s<i;s++)this.insts.push(new En(t));break;case"ibag":for(let s=0,i=e.size/Nn.SizeInFile|0;s<i;s++)this.ibags.push(new Nn(t));break;case"imod":for(let s=0,i=e.size/Pn.SizeInFile|0;s<i;s++)this.imods.push(new Pn(t));break;case"igen":for(let s=0,i=e.size/Cn.SizeInFile|0;s<i;s++)this.igens.push(new Cn(t));break;case"shdr":for(let s=0,i=e.size/Wn.SizeInFile|0;s<i;s++)this.sHdrs.push(new Wn(t));break;default:t.position+=e.size}else if("sdta"===s.id)for(;Xi.load(s,e,t);)if("smpl"===e.id)this.sampleData=new Uint8Array(e.size),t.read(this.sampleData,0,e.size);else t.position+=e.size;else t.position+=s.size}}}class Nn{static SizeInFile=4;instGenNdx;instModNdx;constructor(t){this.instGenNdx=de.readUInt16LE(t),this.instModNdx=de.readUInt16LE(t)}}class Pn{static SizeInFile=10;modSrcOper;modDestOper;modAmount;modAmtSrcOper;modTransOper;constructor(t){this.modSrcOper=de.readUInt16LE(t),this.modDestOper=de.readUInt16LE(t),this.modAmount=de.readInt16LE(t),this.modAmtSrcOper=de.readUInt16LE(t),this.modTransOper=de.readUInt16LE(t)}}class Cn{static SizeInFile=4;genOper;genAmount;constructor(t){this.genOper=de.readUInt16LE(t),this.genAmount=new On(t)}}class En{static SizeInFile=22;instName;instBagNdx;constructor(t){this.instName=de.read8BitStringLength(t,20),this.instBagNdx=de.readUInt16LE(t)}}class Fn{static SizeInFile=4;genNdx;modNdx;constructor(t){this.genNdx=de.readUInt16LE(t),this.modNdx=de.readUInt16LE(t)}}class An{static SizeInFile=4;static GenInstrument=41;static GenKeyRange=43;static GenVelRange=44;static GenSampleId=53;genOper;genAmount;constructor(t){this.genOper=de.readUInt16LE(t),this.genAmount=new On(t)}}class Dn{static SizeInFile=38;presetName;preset;bank;presetBagNdx;library;genre;morphology;constructor(t){this.presetName=de.read8BitStringLength(t,20),this.preset=de.readUInt16LE(t),this.bank=de.readUInt16LE(t),this.presetBagNdx=de.readUInt16LE(t),this.library=de.readUInt32LE(t),this.genre=de.readUInt32LE(t),this.morphology=de.readUInt32LE(t)}}class Ln{static SizeInFile=10;modSrcOper;modDestOper;modAmount;modAmtSrcOper;modTransOper;constructor(t){this.modSrcOper=de.readUInt16LE(t),this.modDestOper=de.readUInt16LE(t),this.modAmount=de.readUInt16LE(t),this.modAmtSrcOper=de.readUInt16LE(t),this.modTransOper=de.readUInt16LE(t)}}class Wn{static SizeInFile=46;sampleName;start;end;startLoop;endLoop;sampleRate;originalPitch;pitchCorrection;sampleLink;sampleType;constructor(t){this.sampleName=de.read8BitStringLength(t,20),this.start=de.readUInt32LE(t),this.end=de.readUInt32LE(t),this.startLoop=de.readUInt32LE(t),this.endLoop=de.readUInt32LE(t),this.sampleRate=de.readUInt32LE(t),this.originalPitch=t.readByte(),this.pitchCorrection=de.readSInt8(t),this.sampleLink=de.readUInt16LE(t),this.sampleType=de.readUInt16LE(t)}}class On{wordAmount;get shortAmount(){return ue.uint16ToInt16(this.wordAmount)}get lowByteAmount(){return 255&this.wordAmount}get highByteAmount(){return(65280&this.wordAmount)>>8&255}constructor(t){this.wordAmount=de.readUInt16LE(t)}}class Rn{presetIndex=0;bank=0;pitchWheel=0;perNotePitchWheel=new Map;midiPan=0;midiVolume=0;midiExpression=0;midiRpn=0;midiData=0;panOffset=0;gainDb=0;pitchRange=0;tuning=0;mixVolume=0;mute=!1;solo=!1}class In{activeChannel=0;channelList=[];setupVoice(t,e){const s=this.channelList[this.activeChannel],i=e.region.pan+s.panOffset;e.playingChannel=this.activeChannel,e.mixVolume=s.mixVolume,e.noteGainDb+=s.gainDb,e.updatePitchRatio(s,t.outSampleRate),i<=-.5?(e.panFactorLeft=1,e.panFactorRight=0):i>=.5?(e.panFactorLeft=0,e.panFactorRight=1):(e.panFactorLeft=Math.sqrt(.5-i),e.panFactorRight=Math.sqrt(.5+i))}}!function(t){t[t.None=0]="None",t[t.Continuous=1]="Continuous",t[t.Sustain=2]="Sustain"}(ts||(ts={})),function(t){t[t.StereoInterleaved=0]="StereoInterleaved",t[t.StereoUnweaved=1]="StereoUnweaved",t[t.Mono=2]="Mono"}(es||(es={}));class Gn{name="";presetNumber=0;bank=0;regions=null}class Hn{static timecents2Secs(t){return Math.pow(2,t/1200)}static decibelsToGain(t){return t>-100?Math.pow(10,.05*t):0}static gainToDecibels(t){return t<=1e-5?-100:20*Math.log10(t)}static cents2Hertz(t){return 8.176*Math.pow(2,t/1200)}}class Vn{delay=0;attack=0;hold=0;decay=0;sustain=0;release=0;keynumToHold=0;keynumToDecay=0;constructor(t){t&&(this.delay=t.delay,this.attack=t.attack,this.hold=t.hold,this.decay=t.decay,this.sustain=t.sustain,this.release=t.release,this.keynumToHold=t.keynumToHold,this.keynumToDecay=t.keynumToDecay)}clear(){this.delay=0,this.attack=0,this.hold=0,this.decay=0,this.sustain=0,this.release=0,this.keynumToHold=0,this.keynumToDecay=0}envToSecs(t){this.delay=this.delay<-11950?0:Hn.timecents2Secs(this.delay),this.attack=this.attack<-11950?0:Hn.timecents2Secs(this.attack),this.release=this.release<-11950?0:Hn.timecents2Secs(this.release),0===this.keynumToHold&&(this.hold=this.hold<-11950?0:Hn.timecents2Secs(this.hold)),0===this.keynumToDecay&&(this.decay=this.decay<-11950?0:Hn.timecents2Secs(this.decay)),this.sustain<0?this.sustain=0:this.sustain=t?Hn.decibelsToGain(-this.sustain/10):1-this.sustain/1e3}}!function(t){t[t.StartAddrsOffset=0]="StartAddrsOffset",t[t.EndAddrsOffset=1]="EndAddrsOffset",t[t.StartloopAddrsOffset=2]="StartloopAddrsOffset",t[t.EndloopAddrsOffset=3]="EndloopAddrsOffset",t[t.StartAddrsCoarseOffset=4]="StartAddrsCoarseOffset",t[t.ModLfoToPitch=5]="ModLfoToPitch",t[t.VibLfoToPitch=6]="VibLfoToPitch",t[t.ModEnvToPitch=7]="ModEnvToPitch",t[t.InitialFilterFc=8]="InitialFilterFc",t[t.InitialFilterQ=9]="InitialFilterQ",t[t.ModLfoToFilterFc=10]="ModLfoToFilterFc",t[t.ModEnvToFilterFc=11]="ModEnvToFilterFc",t[t.EndAddrsCoarseOffset=12]="EndAddrsCoarseOffset",t[t.ModLfoToVolume=13]="ModLfoToVolume",t[t.Unused1=14]="Unused1",t[t.ChorusEffectsSend=15]="ChorusEffectsSend",t[t.ReverbEffectsSend=16]="ReverbEffectsSend",t[t.Pan=17]="Pan",t[t.Unused2=18]="Unused2",t[t.Unused3=19]="Unused3",t[t.Unused4=20]="Unused4",t[t.DelayModLFO=21]="DelayModLFO",t[t.FreqModLFO=22]="FreqModLFO",t[t.DelayVibLFO=23]="DelayVibLFO",t[t.FreqVibLFO=24]="FreqVibLFO",t[t.DelayModEnv=25]="DelayModEnv",t[t.AttackModEnv=26]="AttackModEnv",t[t.HoldModEnv=27]="HoldModEnv",t[t.DecayModEnv=28]="DecayModEnv",t[t.SustainModEnv=29]="SustainModEnv",t[t.ReleaseModEnv=30]="ReleaseModEnv",t[t.KeynumToModEnvHold=31]="KeynumToModEnvHold",t[t.KeynumToModEnvDecay=32]="KeynumToModEnvDecay",t[t.DelayVolEnv=33]="DelayVolEnv",t[t.AttackVolEnv=34]="AttackVolEnv",t[t.HoldVolEnv=35]="HoldVolEnv",t[t.DecayVolEnv=36]="DecayVolEnv",t[t.SustainVolEnv=37]="SustainVolEnv",t[t.ReleaseVolEnv=38]="ReleaseVolEnv",t[t.KeynumToVolEnvHold=39]="KeynumToVolEnvHold",t[t.KeynumToVolEnvDecay=40]="KeynumToVolEnvDecay",t[t.Instrument=41]="Instrument",t[t.Reserved1=42]="Reserved1",t[t.KeyRange=43]="KeyRange",t[t.VelRange=44]="VelRange",t[t.StartloopAddrsCoarseOffset=45]="StartloopAddrsCoarseOffset",t[t.Keynum=46]="Keynum",t[t.Velocity=47]="Velocity",t[t.InitialAttenuation=48]="InitialAttenuation",t[t.Reserved2=49]="Reserved2",t[t.EndloopAddrsCoarseOffset=50]="EndloopAddrsCoarseOffset",t[t.CoarseTune=51]="CoarseTune",t[t.FineTune=52]="FineTune",t[t.SampleID=53]="SampleID",t[t.SampleModes=54]="SampleModes",t[t.Reserved3=55]="Reserved3",t[t.ScaleTuning=56]="ScaleTuning",t[t.ExclusiveClass=57]="ExclusiveClass",t[t.OverridingRootKey=58]="OverridingRootKey",t[t.Unused5=59]="Unused5",t[t.EndOper=60]="EndOper"}(ss||(ss={}));class $n{static Sf=new Float32Array(0);loopMode=ts.None;samples=$n.Sf;sampleRate=0;loKey=0;hiKey=0;loVel=0;hiVel=0;group=0;offset=0;end=0;loopStart=0;loopEnd=0;transpose=0;tune=0;pitchKeyCenter=0;pitchKeyTrack=0;attenuation=0;pan=0;ampEnv=new Vn;modEnv=new Vn;initialFilterQ=0;initialFilterFc=0;modEnvToPitch=0;modEnvToFilterFc=0;modLfoToFilterFc=0;modLfoToVolume=0;delayModLFO=0;freqModLFO=0;modLfoToPitch=0;delayVibLFO=0;freqVibLFO=0;vibLfoToPitch=0;constructor(t){t&&(this.loopMode=t.loopMode,this.samples=t.samples,this.sampleRate=t.sampleRate,this.loKey=t.loKey,this.hiKey=t.hiKey,this.loVel=t.loVel,this.hiVel=t.hiVel,this.group=t.group,this.offset=t.offset,this.end=t.end,this.loopStart=t.loopStart,this.loopEnd=t.loopEnd,this.transpose=t.transpose,this.tune=t.tune,this.pitchKeyCenter=t.pitchKeyCenter,this.pitchKeyTrack=t.pitchKeyTrack,this.attenuation=t.attenuation,this.pan=t.pan,this.ampEnv=new Vn(t.ampEnv),this.modEnv=new Vn(t.modEnv),this.initialFilterQ=t.initialFilterQ,this.initialFilterFc=t.initialFilterFc,this.modEnvToPitch=t.modEnvToPitch,this.modEnvToFilterFc=t.modEnvToFilterFc,this.modLfoToFilterFc=t.modLfoToFilterFc,this.modLfoToVolume=t.modLfoToVolume,this.delayModLFO=t.delayModLFO,this.freqModLFO=t.freqModLFO,this.modLfoToPitch=t.modLfoToPitch,this.delayVibLFO=t.delayVibLFO,this.freqVibLFO=t.freqVibLFO,this.vibLfoToPitch=t.vibLfoToPitch)}clear(t){this.loopMode=ts.None,this.samples=$n.Sf,this.sampleRate=0,this.loKey=0,this.hiKey=0,this.loVel=0,this.hiVel=0,this.group=0,this.offset=0,this.end=0,this.loopStart=0,this.loopEnd=0,this.transpose=0,this.tune=0,this.pitchKeyCenter=0,this.pitchKeyTrack=0,this.attenuation=0,this.pan=0,this.ampEnv.clear(),this.modEnv.clear(),this.initialFilterQ=0,this.initialFilterFc=0,this.modEnvToPitch=0,this.modEnvToFilterFc=0,this.modLfoToFilterFc=0,this.modLfoToVolume=0,this.delayModLFO=0,this.freqModLFO=0,this.modLfoToPitch=0,this.delayVibLFO=0,this.freqVibLFO=0,this.vibLfoToPitch=0,this.hiKey=127,this.hiVel=127,this.pitchKeyCenter=60,t||(this.pitchKeyTrack=100,this.pitchKeyCenter=-1,this.ampEnv.delay=-12e3,this.ampEnv.attack=-12e3,this.ampEnv.hold=-12e3,this.ampEnv.decay=-12e3,this.ampEnv.release=-12e3,this.modEnv.delay=-12e3,this.modEnv.attack=-12e3,this.modEnv.hold=-12e3,this.modEnv.decay=-12e3,this.modEnv.release=-12e3,this.initialFilterFc=13500,this.delayModLFO=-12e3,this.delayVibLFO=-12e3)}operator(t,e){switch(t){case ss.StartAddrsOffset:this.offset+=ue.int16ToUint32(e.shortAmount);break;case ss.EndAddrsOffset:this.end+=ue.int16ToUint32(e.shortAmount);break;case ss.StartloopAddrsOffset:this.loopStart+=ue.int16ToUint32(e.shortAmount);break;case ss.EndloopAddrsOffset:this.loopEnd+=ue.int16ToUint32(e.shortAmount);break;case ss.StartAddrsCoarseOffset:this.offset+=32768*ue.int16ToUint32(e.shortAmount);break;case ss.ModLfoToPitch:this.modLfoToPitch=e.shortAmount;break;case ss.VibLfoToPitch:this.vibLfoToPitch=e.shortAmount;break;case ss.ModEnvToPitch:this.modEnvToPitch=e.shortAmount;break;case ss.InitialFilterFc:this.initialFilterFc=e.shortAmount;break;case ss.InitialFilterQ:this.initialFilterQ=e.shortAmount;break;case ss.ModLfoToFilterFc:this.modLfoToFilterFc=e.shortAmount;break;case ss.ModEnvToFilterFc:this.modEnvToFilterFc=e.shortAmount;break;case ss.EndAddrsCoarseOffset:this.end+=32768*ue.int16ToUint32(e.shortAmount);break;case ss.ModLfoToVolume:this.modLfoToVolume=e.shortAmount;break;case ss.Pan:this.pan=e.shortAmount/1e3;break;case ss.DelayModLFO:this.delayModLFO=e.shortAmount;break;case ss.FreqModLFO:this.freqModLFO=e.shortAmount;break;case ss.DelayVibLFO:this.delayVibLFO=e.shortAmount;break;case ss.FreqVibLFO:this.freqVibLFO=e.shortAmount;break;case ss.DelayModEnv:this.modEnv.delay=e.shortAmount;break;case ss.AttackModEnv:this.modEnv.attack=e.shortAmount;break;case ss.HoldModEnv:this.modEnv.hold=e.shortAmount;break;case ss.DecayModEnv:this.modEnv.decay=e.shortAmount;break;case ss.SustainModEnv:this.modEnv.sustain=e.shortAmount;break;case ss.ReleaseModEnv:this.modEnv.release=e.shortAmount;break;case ss.KeynumToModEnvHold:this.modEnv.keynumToHold=e.shortAmount;break;case ss.KeynumToModEnvDecay:this.modEnv.keynumToDecay=e.shortAmount;break;case ss.DelayVolEnv:this.ampEnv.delay=e.shortAmount;break;case ss.AttackVolEnv:this.ampEnv.attack=e.shortAmount;break;case ss.HoldVolEnv:this.ampEnv.hold=e.shortAmount;break;case ss.DecayVolEnv:this.ampEnv.decay=e.shortAmount;break;case ss.SustainVolEnv:this.ampEnv.sustain=e.shortAmount;break;case ss.ReleaseVolEnv:this.ampEnv.release=e.shortAmount;break;case ss.KeynumToVolEnvHold:this.ampEnv.keynumToHold=e.shortAmount;break;case ss.KeynumToVolEnvDecay:this.ampEnv.keynumToDecay=e.shortAmount;break;case ss.KeyRange:this.loKey=e.lowByteAmount,this.hiKey=e.highByteAmount;break;case ss.VelRange:this.loVel=e.lowByteAmount,this.hiVel=e.highByteAmount;break;case ss.StartloopAddrsCoarseOffset:this.loopStart+=32768*ue.int16ToUint32(e.shortAmount);break;case ss.InitialAttenuation:this.attenuation+=.1*e.shortAmount;break;case ss.EndloopAddrsCoarseOffset:this.loopEnd+=32768*ue.int16ToUint32(e.shortAmount);break;case ss.CoarseTune:this.transpose+=e.shortAmount;break;case ss.FineTune:this.tune+=e.shortAmount;break;case ss.SampleModes:this.loopMode=3&~e.wordAmount?1==(3&e.wordAmount)?ts.Continuous:ts.None:ts.Sustain;break;case ss.ScaleTuning:this.pitchKeyTrack=e.shortAmount;break;case ss.ExclusiveClass:this.group=e.wordAmount;break;case ss.OverridingRootKey:this.pitchKeyCenter=e.shortAmount}}}!function(t){t[t.None=0]="None",t[t.Delay=1]="Delay",t[t.Attack=2]="Attack",t[t.Hold=3]="Hold",t[t.Decay=4]="Decay",t[t.Sustain=5]="Sustain",t[t.Release=6]="Release",t[t.Done=7]="Done"}(is||(is={}));class Un{static Bf=.01;level=0;slope=0;samplesUntilNextSegment=0;segment=is.None;midiVelocity=0;parameters=null;segmentIsExponential=!1;isAmpEnv=!1;nextSegment(t,e){if(this.parameters)for(;;)switch(t){case is.None:if(this.samplesUntilNextSegment=this.parameters.delay*e|0,this.samplesUntilNextSegment>0)return this.segment=is.Delay,this.segmentIsExponential=!1,this.level=0,void(this.slope=0);t=is.Delay;break;case is.Delay:if(this.samplesUntilNextSegment=this.parameters.attack*e|0,this.samplesUntilNextSegment>0)return this.isAmpEnv||(this.samplesUntilNextSegment=this.parameters.attack*((145-this.midiVelocity)/144)*e|0),this.segment=is.Attack,this.segmentIsExponential=!1,this.level=0,void(this.slope=1/this.samplesUntilNextSegment);t=is.Attack;break;case is.Attack:if(this.samplesUntilNextSegment=this.parameters.hold*e|0,this.samplesUntilNextSegment>0)return this.segment=is.Hold,this.segmentIsExponential=!1,this.level=1,void(this.slope=0);t=is.Hold;break;case is.Hold:if(this.samplesUntilNextSegment=this.parameters.decay*e|0,this.samplesUntilNextSegment>0){if(this.segment=is.Decay,this.level=1,this.isAmpEnv){const t=-9.226/this.samplesUntilNextSegment;this.slope=Math.exp(t),this.segmentIsExponential=!0,this.parameters.sustain>0&&(this.samplesUntilNextSegment=Math.log(this.parameters.sustain)/t|0)}else this.slope=-1/this.samplesUntilNextSegment,this.samplesUntilNextSegment=this.parameters.decay*(1-this.parameters.sustain)*e|0,this.segmentIsExponential=!1;return}t=is.Decay;break;case is.Decay:return this.segment=is.Sustain,this.level=this.parameters.sustain,this.slope=0,this.samplesUntilNextSegment=2147483647,void(this.segmentIsExponential=!1);case is.Sustain:if(this.segment=is.Release,this.samplesUntilNextSegment=(this.parameters.release<=0?Un.Bf:this.parameters.release)*e|0,this.isAmpEnv){const t=-9.226/this.samplesUntilNextSegment;this.slope=Math.exp(t),this.segmentIsExponential=!0}else this.slope=-this.level/this.samplesUntilNextSegment,this.segmentIsExponential=!1;return;default:return this.segment=is.Done,this.segmentIsExponential=!1,this.level=0,this.slope=0,void(this.samplesUntilNextSegment=134217727)}}setup(t,e,s,i,n){this.parameters=new Vn(t),this.parameters.keynumToHold>0&&(this.parameters.hold+=this.parameters.keynumToHold*(60-e),this.parameters.hold=this.parameters.hold<-1e4?0:Hn.timecents2Secs(this.parameters.hold)),this.parameters.keynumToDecay>0&&(this.parameters.decay+=this.parameters.keynumToDecay*(60-e),this.parameters.decay=this.parameters.decay<-1e4?0:Hn.timecents2Secs(this.parameters.decay)),this.midiVelocity=0|s,this.isAmpEnv=i,this.nextSegment(is.None,n)}process(t,e){this.slope>0&&(this.segmentIsExponential?this.level*=Math.pow(this.slope,t):this.level+=this.slope*t),this.samplesUntilNextSegment-=t,this.samplesUntilNextSegment<=0&&this.nextSegment(this.segment,e)}}class zn{samplesUntil=0;level=0;delta=0;setup(t,e,s){this.samplesUntil=t*s|0,this.delta=4*Hn.cents2Hertz(e)/s,this.level=0}process(t){this.samplesUntil>t?this.samplesUntil-=t:(this.level+=this.delta*t,this.level>1?(this.delta=-this.delta,this.level=2-this.level):this.level<-1&&(this.delta=-this.delta,this.level=-2-this.level))}}class Xn{qInv=0;a0=0;a1=0;b1=0;b2=0;z1=0;z2=0;active=!1;constructor(t){t&&(this.qInv=t.qInv,this.a0=t.a0,this.a1=t.a1,this.b1=t.b1,this.b2=t.b2,this.z1=t.z1,this.z2=t.z2,this.active=t.active)}setup(t){const e=Math.tan(Math.PI*t),s=e*e,i=1/(1+e*this.qInv+s);this.a0=s*i,this.a1=2*this.a0,this.b1=2*(s-1)*i,this.b2=(1-e*this.qInv+s)*i}process(t){const e=t*this.a0+this.z1;return this.z1=t*this.a1+this.z2-this.b1*e,this.z2=t*this.a0-this.b2*e,e}}class jn{static renderEffectSampleBlock=Vt.MicroBufferSize;playingPreset=0;playingKey=0;playingChannel=0;region=null;pitchInputTimecents=0;pitchOutputFactor=0;sourceSamplePosition=0;noteGainDb=0;panFactorLeft=0;panFactorRight=0;playIndex=0;loopStart=0;loopEnd=0;ampEnv=new Un;modEnv=new Un;lowPass=new Xn;modLfo=new zn;vibLfo=new zn;mixVolume=0;mute=!1;updatePitchRatio(t,e){let s=t.pitchWheel;t.perNotePitchWheel.has(this.playingKey)&&(s+=t.perNotePitchWheel.get(this.playingKey)-8192);const i=8192===s?t.tuning:s/16383*t.pitchRange*2-t.pitchRange+t.tuning;this.calcPitchRatio(i,e)}calcPitchRatio(t,e){if(!this.region)return;const s=this.playingKey+this.region.transpose+this.region.tune/100;let i=this.region.pitchKeyCenter+(s-this.region.pitchKeyCenter)*(this.region.pitchKeyTrack/100);0!==t&&(i+=t),this.pitchInputTimecents=100*i,this.pitchOutputFactor=this.region.sampleRate/(Hn.timecents2Secs(100*this.region.pitchKeyCenter)*e)}end(t){this.region&&(this.ampEnv.nextSegment(is.Sustain,t),this.modEnv.nextSegment(is.Sustain,t),this.region.loopMode===ts.Sustain&&(this.loopEnd=this.loopStart))}endQuick(t){this.ampEnv.parameters.release=0,this.ampEnv.nextSegment(is.Sustain,t),this.modEnv.parameters.release=0,this.modEnv.nextSegment(is.Sustain,t)}render(t,e,s,i,n){if(!this.region)return;const r=this.region,a=r.samples;let h=0,o=t.outputMode===es.StereoUnweaved?i:-1;const c=0!==r.modEnvToPitch||0!==r.modEnvToFilterFc,l=this.modLfo.delta>0&&(0!==r.modLfoToPitch||0!==r.modLfoToFilterFc||0!==r.modLfoToVolume),u=this.vibLfo.delta>0&&0!==r.vibLfoToPitch,d=this.loopStart<this.loopEnd,f=this.loopStart,p=this.loopEnd,b=r.end,m=p+1;let g=this.sourceSamplePosition;const w=new Xn(this.lowPass),y=0!==r.modLfoToFilterFc||0!==r.modEnvToFilterFc;let k=0,S=0,B=0,_=0;const T=0!==r.modLfoToPitch||0!==r.modEnvToPitch||0!==r.vibLfoToPitch;let x=0,M=0,v=0,N=0;const P=0!==r.modLfoToVolume;let C=0,E=0;for(y?(k=t.outSampleRate,S=r.initialFilterFc,B=r.modLfoToFilterFc,_=r.modEnvToFilterFc):(k=0,S=0,B=0,_=0),T?(x=0,M=r.modLfoToPitch,v=r.vibLfoToPitch,N=r.modEnvToPitch):(x=Hn.timecents2Secs(this.pitchInputTimecents)*this.pitchOutputFactor,M=0,v=0,N=0),P?E=.1*r.modLfoToVolume:(C=Hn.decibelsToGain(this.noteGainDb),E=0);i>0;){let r,F,A=0,D=i>jn.renderEffectSampleBlock?jn.renderEffectSampleBlock:i;if(i-=D,y){const t=S+this.modLfo.level*B+this.modEnv.level*_;w.active=t<=13500,w.active&&w.setup(Hn.cents2Hertz(t)/k)}switch(T&&(x=Hn.timecents2Secs(this.pitchInputTimecents+(this.modLfo.level*M+this.vibLfo.level*v+this.modEnv.level*N))*this.pitchOutputFactor),P&&(C=Hn.decibelsToGain(this.noteGainDb+this.modLfo.level*E)),r=C*this.ampEnv.level,n?r=0:r*=this.mixVolume,this.ampEnv.process(D,t.outSampleRate),c&&this.modEnv.process(D,t.outSampleRate),l&&this.modLfo.process(D),u&&this.vibLfo.process(D),t.outputMode){case es.StereoInterleaved:for(F=r*this.panFactorLeft,A=r*this.panFactorRight;D-- >0&&g<b;){const t=0|g,i=t>=p&&d?f:t+1,n=g-t;let r=a[t]*(1-n)+a[i]*n;w.active&&(r=w.process(r)),e[s+h]+=r*F,h++,e[s+h]+=r*A,h++,g+=x,g>=m&&d&&(g-=p-f+1)}break;case es.StereoUnweaved:for(F=r*this.panFactorLeft,A=r*this.panFactorRight;D-- >0&&g<b;){const t=0|g,i=t>=p&&d?f:t+1,n=g-t;let r=a[t]*(1-n)+a[i]*n;w.active&&(r=w.process(r)),e[s+h]+=r*F,h++,e[s+o]+=r*A,o++,g+=x,g>=m&&d&&(g-=p-f+1)}break;case es.Mono:for(;D-- >0&&g<b;){const t=0|g,i=t>=p&&d?f:t+1,n=g-t;let o=a[t]*(1-n)+a[i]*n;w.active&&(o=w.process(o)),e[s+h]=o*r,h++,g+=x,g>=m&&d&&(g-=p-f+1)}}if(g>=b||this.ampEnv.segment===is.Done)return void this.kill()}this.sourceSamplePosition=g,(w.active||y)&&(this.lowPass=w)}kill(){this.playingPreset=-1}}class Jn{value;next;constructor(t){this.value=t}}class qn{_f;Tf;get isEmpty(){return void 0===this._f}clear(){this._f=void 0,this.Tf=void 0}enqueue(t){const e=new Jn(t);this.Tf?(this.Tf.next=e,this.Tf=e):(this._f=e,this.Tf=e)}enqueueFront(t){const e=new Jn(t);e.next=this._f,this._f?this._f=e:(this._f=e,this.Tf=e)}peek(){const t=this._f;if(t)return t.value}dequeue(){const t=this._f;if(!t)return;const e=t.next;return this._f=e,e||(this.Tf=void 0),t.value}}!function(t){t[t.BankSelectCoarse=0]="BankSelectCoarse",t[t.ModulationCoarse=1]="ModulationCoarse",t[t.DataEntryCoarse=6]="DataEntryCoarse",t[t.VolumeCoarse=7]="VolumeCoarse",t[t.PanCoarse=10]="PanCoarse",t[t.ExpressionControllerCoarse=11]="ExpressionControllerCoarse",t[t.BankSelectFine=32]="BankSelectFine",t[t.ModulationFine=33]="ModulationFine",t[t.DataEntryFine=38]="DataEntryFine",t[t.VolumeFine=39]="VolumeFine",t[t.PanFine=42]="PanFine",t[t.ExpressionControllerFine=43]="ExpressionControllerFine",t[t.HoldPedal=64]="HoldPedal",t[t.LegatoPedal=68]="LegatoPedal",t[t.NonRegisteredParameterFine=98]="NonRegisteredParameterFine",t[t.NonRegisteredParameterCourse=99]="NonRegisteredParameterCourse",t[t.RegisteredParameterFine=100]="RegisteredParameterFine",t[t.RegisteredParameterCourse=101]="RegisteredParameterCourse",t[t.AllSoundOff=120]="AllSoundOff",t[t.ResetControllers=121]="ResetControllers",t[t.AllNotesOff=123]="AllNotesOff"}(ns||(ns={}));class Yn{xf=new qn;Mf=new Map;vf=new Map;Nf=!1;Pf=new Map;Cf=new Map;currentTempo=0;timeSignatureNumerator=0;timeSignatureDenominator=0;constructor(t){this.outSampleRate=t}synthesize(t,e,s){return this.Ef(t,e,s)}synthesizeSilent(t){this.Ef(null,0,t)}channelGetMixVolume(t){return this.nd&&t<this.nd.channelList.length?this.nd.channelList[t].mixVolume:1}channelSetMixVolume(t,e){const s=this.Ff(t);for(const s of this.Af)s.playingChannel===t&&-1!==s.playingPreset&&(s.mixVolume=e);s.mixVolume=e}channelSetMute(t,e){e?this.Mf.set(t,!0):this.Mf.delete(t)}channelSetSolo(t,e){e?this.vf.set(t,!0):this.vf.delete(t),this.Nf=this.vf.size>0}resetChannelStates(){this.Mf=new Map,this.vf=new Map,this.Cf=new Map,this.applyTranspositionPitches(new Map),this.Nf=!1}setChannelTranspositionPitch(t,e){let s=0;this.Cf.has(t)&&(s=this.Cf.get(t)),0===e?this.Cf.delete(t):this.Cf.set(t,e);for(const i of this.Af)if(i.playingChannel===t&&9!==i.playingChannel){let t=0;t-=s,t+=e,i.playingKey+=t,this.nd&&i.updatePitchRatio(this.nd.channelList[i.playingChannel],this.outSampleRate)}}applyTranspositionPitches(t){const e=this.Pf;for(const s of this.Af)if(s.playingChannel>=0&&9!==s.playingChannel){let i=0;e.has(s.playingChannel)&&(i-=e.get(s.playingChannel)),t.has(s.playingChannel)&&(i+=t.get(s.playingChannel)),s.playingKey+=i,this.nd&&s.updatePitchRatio(this.nd.channelList[s.playingChannel],this.outSampleRate)}this.Pf=t}dispatchEvent(t){this.xf.enqueue(t)}Ef(t,e,s){const i=this.Nf,n=[];for(;!this.xf.isEmpty;){const t=this.xf.dequeue();t.isMetronome&&this.metronomeVolume>0?(this.channelNoteOff(Vt.MetronomeChannel,Vt.MetronomeKey),this.channelNoteOn(Vt.MetronomeChannel,Vt.MetronomeKey,95/127)):t.event&&this.processMidiMessage(t.event),n.push(t)}for(const n of this.Af)if(-1!==n.playingPreset){const r=n.playingChannel,a=this.Mf.has(r)||i&&r!==Vt.MetronomeChannel&&!this.vf.has(r);t?n.render(this,t,e,s,a):n.kill()}return n}processMidiMessage(t){switch(t.type){case Ye.TimeSignature:const e=t;this.timeSignatureNumerator=e.numerator,this.timeSignatureDenominator=Math.pow(2,e.denominatorIndex);break;case Ye.NoteOn:const s=t;this.channelNoteOn(s.channel,s.noteKey,s.noteVelocity/127);break;case Ye.NoteOff:const i=t;this.channelNoteOff(i.channel,i.noteKey);break;case Ye.ControlChange:const n=t;this.channelMidiControl(n.channel,n.controller,n.value);break;case Ye.ProgramChange:const r=t;this.channelSetPresetNumber(r.channel,r.program,9===r.channel);break;case Ye.TempoChange:const a=t;this.currentTempo=a.beatsPerMinute;break;case Ye.PitchBend:const h=t;this.channelSetPitchWheel(h.channel,h.value);break;case Ye.PerNotePitchBend:const o=t;let c=o.value;c=c*Vt.MaxPitchWheel/Vt.MaxPitchWheel20,this.channelSetPerNotePitchWheel(o.channel,o.noteKey,c)}}get metronomeVolume(){return this.channelGetMixVolume(Vt.MetronomeChannel)}set metronomeVolume(t){this.setupMetronomeChannel(t)}setupMetronomeChannel(t){this.channelSetMixVolume(Vt.MetronomeChannel,t),t>0&&(this.channelSetVolume(Vt.MetronomeChannel,1),this.channelSetPresetNumber(Vt.MetronomeChannel,0,!0))}get masterVolume(){return Hn.decibelsToGain(this.globalGainDb)}set masterVolume(t){const e=Hn.gainToDecibels(t),s=e-this.globalGainDb;if(0!==s){for(const t of this.Af)-1!==t.playingPreset&&(t.noteGainDb+=s);this.globalGainDb=e}}resetSoft(){for(const t of this.Af)-1!==t.playingPreset&&(t.ampEnv.segment<is.Release||0!==t.ampEnv.parameters.release)&&t.endQuick(this.outSampleRate);if(this.nd)for(const t of this.nd.channelList)t.presetIndex=0,t.bank=0,t.pitchWheel=8192,t.midiPan=8192,t.perNotePitchWheel.clear(),t.midiVolume=16383,t.midiExpression=16383,t.midiRpn=65535,t.midiData=0,t.panOffset=0,t.gainDb=0,t.pitchRange=2,t.tuning=0}presets=null;Af=[];nd=null;Df=0;get presetCount(){return this.presets?.length??0}outputMode=es.StereoInterleaved;outSampleRate=0;globalGainDb=0;reset(){for(const t of this.Af)-1!==t.playingPreset&&(t.ampEnv.segment<is.Release||0!==t.ampEnv.parameters.release)&&t.endQuick(this.outSampleRate);this.nd=null}setOutput(t,e,s){this.outputMode=t,this.outSampleRate=e>=1?e:44100,this.globalGainDb=s}noteOn(t,e,s){if(!this.presets)return;const i=127*s|0;if(t<0||t>=this.presets.length)return;if(s<=0)return void this.noteOff(t,e);const n=this.Df++;for(const r of this.presets[t].regions){if(e<r.loKey||e>r.hiKey||i<r.loVel||i>r.hiVel)continue;let a=null;if(0!==r.group)for(const e of this.Af)e.playingPreset===t&&e.region.group===r.group?e.endQuick(this.outSampleRate):-1!==e.playingPreset||a||(a=e);else for(const t of this.Af)-1===t.playingPreset&&(a=t);if(!a){for(let t=0;t<4;t++){const t=new jn;t.playingPreset=-1,this.Af.push(t)}a=this.Af[this.Af.length-4]}a.region=r,a.playingPreset=t,a.playingKey=e,a.playIndex=n,a.noteGainDb=this.globalGainDb-r.attenuation-Hn.gainToDecibels(1/s),this.nd?this.nd.setupVoice(this,a):(a.calcPitchRatio(0,this.outSampleRate),a.panFactorLeft=Math.sqrt(.5-r.pan),a.panFactorRight=Math.sqrt(.5+r.pan)),a.sourceSamplePosition=r.offset;const h=r.loopMode!==ts.None&&r.loopStart<r.loopEnd;a.loopStart=h?r.loopStart:0,a.loopEnd=h?r.loopEnd:0,a.ampEnv.setup(r.ampEnv,e,i,!0,this.outSampleRate),a.modEnv.setup(r.modEnv,e,i,!1,this.outSampleRate);const o=r.initialFilterQ/10;a.lowPass.qInv=1/Math.pow(10,o/20),a.lowPass.z1=0,a.lowPass.z2=0,a.lowPass.active=r.initialFilterFc<=13500,a.lowPass.active&&a.lowPass.setup(Hn.cents2Hertz(r.initialFilterFc)/this.outSampleRate),a.modLfo.setup(r.delayModLFO,r.freqModLFO,this.outSampleRate),a.vibLfo.setup(r.delayVibLFO,r.freqVibLFO,this.outSampleRate)}}bankNoteOn(t,e,s,i){const n=this.Lf(t,e);return-1!==n&&(this.noteOn(n,s,i),!0)}noteOff(t,e){let s=null,i=null;const n=[];for(const r of this.Af)r.playingPreset!==t||r.playingKey!==e||r.ampEnv.segment>=is.Release||(!s||r.playIndex<s.playIndex?(s=r,i=r,n.push(r)):r.playIndex===s.playIndex&&(i=r,n.push(r)));if(s)for(const r of n)r!==s&&r!==i&&(r.playIndex!==s.playIndex||r.playingPreset!==t||r.playingKey!==e||r.ampEnv.segment>=is.Release)||r.end(this.outSampleRate)}bankNoteOff(t,e,s){const i=this.Lf(t,e);return-1!==i&&(this.noteOff(i,s),!0)}noteOffAll(t){for(const e of this.Af)-1!==e.playingPreset&&(t?e.endQuick(this.outSampleRate):e.ampEnv.segment<is.Release&&e.end(this.outSampleRate))}get activeVoiceCount(){let t=0;for(const e of this.Af)-1!==e.playingPreset&&t++;return t}Ff(t){if(this.nd&&t<this.nd.channelList.length)return this.nd.channelList[t];this.nd||(this.nd=new In);for(let e=this.nd.channelList.length;e<=t;e++){const t=new Rn;t.presetIndex=0,t.bank=0,t.pitchWheel=8192,t.midiPan=8192,t.midiVolume=16383,t.midiExpression=16383,t.midiRpn=65535,t.midiData=0,t.panOffset=0,t.gainDb=0,t.pitchRange=2,t.tuning=0,t.mixVolume=1,this.nd.channelList.push(t)}return this.nd.channelList[t]}Lf(t,e){if(!this.presets)return-1;for(let s=this.presets.length-1;s>=0;s--){const i=this.presets[s];if(i.presetNumber===e&&i.bank===t)return s}return-1}getPresetName(t){return this.presets?t<0||t>=this.presets.length?null:this.presets[t].name:null}bankGetPresetName(t,e){return this.getPresetName(this.Lf(t,e))}channelNoteOn(t,e,s){!this.nd||t>this.nd.channelList.length||(this.Pf.has(t)&&(e+=this.Pf.get(t)),this.Cf.has(t)&&(e+=this.Cf.get(t)),this.nd.activeChannel=t,this.noteOn(this.nd.channelList[t].presetIndex,e,s))}channelNoteOff(t,e){this.Pf.has(t)&&(e+=this.Pf.get(t)),this.Cf.has(t)&&(e+=this.Cf.get(t));const s=[];let i=null,n=null;for(const r of this.Af)-1===r.playingPreset||r.playingChannel!==t||r.playingKey!==e||r.ampEnv.segment>=is.Release||(!i||r.playIndex<i.playIndex?(i=r,n=r,s.push(r)):r.playIndex===i.playIndex&&(n=r,s.push(r)));if(this.Ff(t).perNotePitchWheel.delete(e),i)for(const r of s)r!==i&&r!==n&&(r.playIndex!==i.playIndex||-1===r.playingPreset||r.playingChannel!==t||r.playingKey!==e||r.ampEnv.segment>=is.Release)||r.end(this.outSampleRate)}channelNoteOffAll(t){this.Ff(t).perNotePitchWheel.clear();for(const e of this.Af)-1!==e.playingPreset&&e.playingChannel===t&&e.ampEnv.segment<is.Release&&e.end(this.outSampleRate)}channelSoundsOffAll(t){this.Ff(t).perNotePitchWheel.clear();for(const e of this.Af)-1!==e.playingPreset&&e.playingChannel===t&&(e.ampEnv.segment<is.Release||0===e.ampEnv.parameters.release)&&e.endQuick(this.outSampleRate)}channelSetPresetIndex(t,e){this.Ff(t).presetIndex=ue.int32ToUint16(e)}channelSetPresetNumber(t,e,s=!1){const i=this.Ff(t);let n=0;return s?(n=this.Lf(128|32767&i.bank,e),-1===n&&(n=this.Lf(128,e)),-1===n&&(n=this.Lf(128,0)),-1===n&&(n=this.Lf(2047&i.bank,e))):n=this.Lf(2047&i.bank,e),i.presetIndex=n,-1!==n}channelSetBank(t,e){this.Ff(t).bank=ue.int32ToUint16(e)}channelSetBankPreset(t,e,s){const i=this.Ff(t),n=this.Lf(e,s);return-1!==n&&(i.presetIndex=ue.int32ToUint16(n),i.bank=ue.int32ToUint16(e),!0)}channelSetPan(t,e){for(const s of this.Af)if(s.playingChannel===t&&-1!==s.playingPreset){const t=s.region.pan+e-.5;t<=-.5?(s.panFactorLeft=1,s.panFactorRight=0):t>=.5?(s.panFactorLeft=0,s.panFactorRight=1):(s.panFactorLeft=Math.sqrt(.5-t),s.panFactorRight=Math.sqrt(.5+t))}this.Ff(t).panOffset=e-.5}channelSetVolume(t,e){const s=this.Ff(t),i=Hn.gainToDecibels(e),n=i-s.gainDb;if(0!==n){for(const e of this.Af)e.playingChannel===t&&-1!==e.playingPreset&&(e.noteGainDb+=n);s.gainDb=i}}channelSetPitchWheel(t,e){const s=this.Ff(t);s.pitchWheel!==e&&(s.pitchWheel=ue.int32ToUint16(e),this.Wf(t,s))}channelSetPerNotePitchWheel(t,e,s){this.Pf.has(t)&&(e+=this.Pf.get(t)),this.Cf.has(t)&&(e+=this.Cf.get(t));const i=this.Ff(t);i.perNotePitchWheel.has(e)&&i.perNotePitchWheel.get(e)===s||(i.perNotePitchWheel.set(e,s),this.Wf(t,i,e))}Wf(t,e,s=-1){for(const i of this.Af)i.playingChannel!==t||-1===i.playingPreset||-1!==s&&i.playingKey!==s||i.updatePitchRatio(e,this.outSampleRate)}channelSetPitchRange(t,e){const s=this.Ff(t);s.pitchRange!==e&&(s.pitchRange=e,8192!==s.pitchWheel&&this.Wf(t,s))}channelSetTuning(t,e){const s=this.Ff(t);s.tuning!==e&&(s.tuning=e,this.Wf(t,s))}channelMidiControl(t,e,s){const i=this.Ff(t);switch(e){case ns.DataEntryFine:return i.midiData=ue.int32ToUint16(16256&i.midiData|s),void(0===i.midiRpn?this.channelSetPitchRange(t,(i.midiData>>7)+.01*(127&i.midiData)):1===i.midiRpn?this.channelSetTuning(t,(0|i.tuning)+(i.midiData-8192)/8192):2===i.midiRpn&&this.channelSetTuning(t,s-64+(i.tuning-(0|i.tuning))));case ns.VolumeCoarse:return i.midiVolume=ue.int32ToUint16(127&i.midiVolume|s<<7),void this.channelSetVolume(t,Math.pow(i.midiVolume/16383*(i.midiExpression/16383),3));case ns.VolumeFine:return i.midiVolume=ue.int32ToUint16(16256&i.midiVolume|s),void this.channelSetVolume(t,Math.pow(i.midiVolume/16383*(i.midiExpression/16383),3));case ns.ExpressionControllerCoarse:return i.midiExpression=ue.int32ToUint16(127&i.midiExpression|s<<7),void this.channelSetVolume(t,Math.pow(i.midiVolume/16383*(i.midiExpression/16383),3));case ns.ExpressionControllerFine:return i.midiExpression=ue.int32ToUint16(16256&i.midiExpression|s),void this.channelSetVolume(t,Math.pow(i.midiVolume/16383*(i.midiExpression/16383),3));case ns.PanCoarse:return i.midiPan=ue.int32ToUint16(127&i.midiPan|s<<7),void this.channelSetPan(t,i.midiPan/16383);case ns.PanFine:return i.midiPan=ue.int32ToUint16(16256&i.midiPan|s),void this.channelSetPan(t,i.midiPan/16383);case ns.DataEntryCoarse:return i.midiData=ue.int32ToUint16(127&i.midiData|s<<7),void(0===i.midiRpn?this.channelSetPitchRange(t,(i.midiData>>7)+.01*(127&i.midiData)):1===i.midiRpn?this.channelSetTuning(t,(0|i.tuning)+(i.midiData-8192)/8192):2===i.midiRpn&&e===ns.DataEntryCoarse&&this.channelSetTuning(t,s-64+(i.tuning-(0|i.tuning))));case ns.BankSelectCoarse:return void(i.bank=ue.int32ToUint16(32768|s));case ns.BankSelectFine:return void(i.bank=ue.int32ToUint16((32768&i.bank?(127&i.bank)<<7:0)|s));case ns.RegisteredParameterCourse:return void(i.midiRpn=ue.int32ToUint16(127&(65535===i.midiRpn?0:i.midiRpn)|s<<7));case ns.RegisteredParameterFine:return void(i.midiRpn=ue.int32ToUint16(16256&(65535===i.midiRpn?0:i.midiRpn)|s));case ns.NonRegisteredParameterFine:case ns.NonRegisteredParameterCourse:return void(i.midiRpn=65535);case ns.AllSoundOff:return void this.channelSoundsOffAll(t);case ns.AllNotesOff:return void this.channelNoteOffAll(t);case ns.ResetControllers:return i.midiVolume=16383,i.midiExpression=16383,i.midiPan=8192,i.bank=0,this.channelSetVolume(t,1),this.channelSetPan(t,.5),void this.channelSetPitchRange(t,2)}}channelGetPresetIndex(t){return this.nd&&t<this.nd.channelList.length?this.nd.channelList[t].presetIndex:0}channelGetPresetBank(t){return this.nd&&t<this.nd.channelList.length?32767&this.nd.channelList[t].bank:0}channelGetPan(t){return this.nd&&t<this.nd.channelList.length?this.nd.channelList[t].panOffset-.5:.5}channelGetVolume(t){return this.nd&&t<this.nd.channelList.length?Hn.decibelsToGain(this.nd.channelList[t].gainDb):1}channelGetPitchWheel(t){return this.nd&&t<this.nd.channelList.length?this.nd.channelList[t].pitchWheel:8192}channelGetPitchRange(t){return this.nd&&t<this.nd.channelList.length?this.nd.channelList[t].pitchRange:2}channelGetTuning(t){return this.nd&&t<this.nd.channelList.length?this.nd.channelList[t].tuning:0}resetPresets(){this.presets=[]}loadPresets(t,e,s,i){const n=[];for(let i=0;i<t.phdrs.length-1;i++){const r=t.phdrs[i];let a=0;const h=new Gn;n.push(h),h.name=r.presetName,h.bank=r.bank,h.presetNumber=r.preset;let o=0;for(let e=r.presetBagNdx;e<t.phdrs[i+1].presetBagNdx;e++){let s=0,i=127,n=0,r=127;for(let a=t.pbags[e].genNdx;a<t.pbags[e+1].genNdx;a++){const e=t.pgens[a];if(e.genOper===An.GenKeyRange){s=e.genAmount.lowByteAmount,i=e.genAmount.highByteAmount;continue}if(e.genOper===An.GenVelRange){n=e.genAmount.lowByteAmount,r=e.genAmount.highByteAmount;continue}if(e.genOper!==An.GenInstrument)continue;if(e.genAmount.wordAmount>=t.insts.length)continue;for(let a=t.insts[e.genAmount.wordAmount].instBagNdx;a<t.insts[e.genAmount.wordAmount+1].instBagNdx;a++){let e=0,h=127,c=0,l=127;for(let u=t.ibags[a].instGenNdx;u<t.ibags[a+1].instGenNdx;u++){const a=t.igens[u];a.genOper!==An.GenKeyRange?a.genOper!==An.GenVelRange?53===a.genOper&&h>=s&&e<=i&&l>=n&&c<=r&&o++:(c=a.genAmount.lowByteAmount,l=a.genAmount.highByteAmount):(e=a.genAmount.lowByteAmount,h=a.genAmount.highByteAmount)}}}}h.regions=new Array(o);let c=new $n;c.clear(!0);for(let n=r.presetBagNdx;n<t.phdrs[i+1].presetBagNdx;n++){const i=t.pbags[n],o=new $n(c);let l=!1;for(let c=i.genNdx;c<t.pbags[n+1].genNdx;c++){const i=t.pgens[c];if(i.genOper===An.GenInstrument){const n=i.genAmount.wordAmount;if(n>=t.insts.length)continue;let c=new $n;c.clear(!1);const u=t.insts[n];for(let i=u.instBagNdx;i<t.insts[n+1].instBagNdx;i++){const n=t.ibags[i],l=new $n(c);let d=!1;for(let c=n.instGenNdx;c<t.ibags[i+1].instGenNdx;c++){const i=t.igens[c];if(i.genOper===An.GenSampleId){if(l.hiKey<o.loKey||l.loKey>o.hiKey)continue;if(l.hiVel<o.loVel||l.loVel>o.hiVel)continue;o.loKey>l.loKey&&(l.loKey=o.loKey),o.hiKey<l.hiKey&&(l.hiKey=o.hiKey),o.loVel>l.loVel&&(l.loVel=o.loVel),o.hiVel<l.hiVel&&(l.hiVel=o.hiVel),l.offset+=o.offset,l.end+=o.end,l.loopStart+=o.loopStart,l.loopEnd+=o.loopEnd,l.transpose+=o.transpose,l.tune+=o.tune,l.pitchKeyTrack+=o.pitchKeyTrack,l.attenuation+=o.attenuation,l.pan+=o.pan,l.ampEnv.delay+=o.ampEnv.delay,l.ampEnv.attack+=o.ampEnv.attack,l.ampEnv.hold+=o.ampEnv.hold,l.ampEnv.decay+=o.ampEnv.decay,l.ampEnv.sustain+=o.ampEnv.sustain,l.ampEnv.release+=o.ampEnv.release,l.modEnv.delay+=o.modEnv.delay,l.modEnv.attack+=o.modEnv.attack,l.modEnv.hold+=o.modEnv.hold,l.modEnv.decay+=o.modEnv.decay,l.modEnv.sustain+=o.modEnv.sustain,l.modEnv.release+=o.modEnv.release,l.initialFilterQ+=o.initialFilterQ,l.initialFilterFc+=o.initialFilterFc,l.modEnvToPitch+=o.modEnvToPitch,l.modEnvToFilterFc+=o.modEnvToFilterFc,l.delayModLFO+=o.delayModLFO,l.freqModLFO+=o.freqModLFO,l.modLfoToPitch+=o.modLfoToPitch,l.modLfoToFilterFc+=o.modLfoToFilterFc,l.modLfoToVolume+=o.modLfoToVolume,l.delayVibLFO+=o.delayVibLFO,l.freqVibLFO+=o.freqVibLFO,l.vibLfoToPitch+=o.vibLfoToPitch,l.ampEnv.envToSecs(!0),l.modEnv.envToSecs(!1),l.delayModLFO=l.delayModLFO<-11950?0:Hn.timecents2Secs(l.delayModLFO),l.delayVibLFO=l.delayVibLFO<-11950?0:Hn.timecents2Secs(l.delayVibLFO),l.pan<-.5?l.pan=-.5:l.pan>.5&&(l.pan=.5),(l.initialFilterQ<1500||l.initialFilterQ>13500)&&(l.initialFilterQ=0);const n=t.sHdrs[i.genAmount.wordAmount];l.offset+=n.start,l.end+=n.end,l.loopStart+=n.startLoop,l.loopEnd+=n.endLoop,n.endLoop>0&&(l.loopEnd-=1),-1===l.pitchKeyCenter&&(l.pitchKeyCenter=n.originalPitch),l.tune+=n.pitchCorrection,l.sampleRate=n.sampleRate;const c=r.bank===Vt.PercussionBank;if(c&&Yn.Of(s,l.loKey,l.hiKey)||!c&&e.has(r.preset))if(1&n.sampleType){J.debug("AlphaSynth",`Loading of used sample ${n.sampleName} for preset ${r.presetName} (bank ${h.bank} program ${h.presetNumber})`);!!(16&n.sampleType)?l.samples=t.decodeSamples(n.start,n.end,!0):(l.samples=t.decodeSamples(2*l.offset,2*l.end,!1),l.loopStart>0&&(l.loopStart-=l.offset),l.loopEnd>0&&(l.loopEnd-=l.offset)),l.offset=0,l.end=l.samples.length-1}else J.warning("AlphaSynth",`Skipping load of unsupported sample ${n.sampleName} for preset ${r.presetName}, sample type ${n.sampleType} is not supported (bank ${h.bank} program ${h.presetNumber})`),l.samples=new Float32Array(0);else J.debug("AlphaSynth",`Skipping load of unused sample ${n.sampleName} for preset ${r.presetName} (bank ${h.bank} program ${h.presetNumber})`),l.samples=new Float32Array(0);h.regions[a]=new $n(l),a++,d=!0}else l.operator(i.genOper,i.genAmount)}n!==t.ibags[u.instBagNdx]||d||(c=new $n(l))}l=!0}else o.operator(i.genOper,i.genAmount)}i!==t.pbags[r.presetBagNdx]||l||(c=o)}}if(i&&this.presets)for(const t of n)this.presets.push(t);else this.presets=n}static Of(t,e,s){for(let i=e;i<=s;i++)if(t.has(i))return!0;return!1}hasSamplesForProgram(t){const e=this.presets;if(!e)return!1;for(const s of e)if(s.presetNumber===t)for(const t of s.regions)if(t.samples.length>0)return!0;return!1}hasSamplesForPercussion(t){const e=this.presets;if(!e)return!1;for(const s of e)if(s.bank===Vt.PercussionBank)for(const e of s.regions)if(e.loKey>=t&&e.hiKey<=t&&e.samples.length>0)return!0;return!1}}class Kn{events;constructor(t){this.events=t}}class Qn{playbackRange;constructor(t){this.playbackRange=t}}class Zn{soundFonts;sampleRate=44100;useSyncPoints=!1;masterVolume=1;metronomeVolume=0;playbackRange;trackVolume=new Map;trackTranspositionPitches=new Map}class tr{samples;currentTime=0;endTime=0;currentTick=0;endTick=0}class er{sequencer;synthesizer;isSoundFontLoaded=!1;Rf=!1;If=0;Gf=0;Hf=0;Vf=0;playedEventsQueue=new qn;midiEventsPlayedFilterSet=new Set;$f=0;Uf=!1;nn;zf;if=new zi(0,0,0,0,!1,120,120);get output(){return this.nn}isReady=!1;get isReadyForPlayback(){return this.isReady&&this.isSoundFontLoaded&&this.Rf}state=Ke.Paused;get logLevel(){return J.logLevel}set logLevel(t){J.logLevel=t}get masterVolume(){return this.synthesizer.masterVolume}set masterVolume(t){t=Math.max(t,Vt.MinVolume),this.updateMasterVolume(t)}updateMasterVolume(t){this.synthesizer.masterVolume=t}get metronomeVolume(){return this.Hf}set metronomeVolume(t){t=Math.max(t,Vt.MinVolume),this.Hf=t,this.synthesizer.metronomeVolume=t}get countInVolume(){return this.Vf}set countInVolume(t){t=Math.max(t,Vt.MinVolume),this.Vf=t}get midiEventsPlayedFilter(){return Array.from(this.midiEventsPlayedFilterSet)}set midiEventsPlayedFilter(t){this.midiEventsPlayedFilterSet=new Set(t)}get playbackSpeed(){return this.sequencer.playbackSpeed}set playbackSpeed(t){t=zt.clamp(t,Vt.MinPlaybackSpeed,Vt.MaxPlaybackSpeed),this.updatePlaybackSpeed(t)}updatePlaybackSpeed(t){const e=this.sequencer.playbackSpeed;this.sequencer.playbackSpeed=t,this.timePosition=this.timePosition*(e/t)}get loadedMidiInfo(){return this.zf}get currentPosition(){return this.if}get tickPosition(){return this.If}set tickPosition(t){this.timePosition=this.sequencer.mainTickPositionToTimePosition(t)}get timePosition(){return this.Gf}set timePosition(t){J.debug("AlphaSynth",`Seeking to position ${t}ms (main)`),this.sequencer.mainSeek(t),this.updateTimePosition(t,!0),this.sequencer.isPlayingMain&&(this.$f=0,this.output.resetSamples())}get playbackRange(){return this.sequencer.mainPlaybackRange}set playbackRange(t){this.sequencer.mainPlaybackRange=t,t&&(this.tickPosition=t.startTick),this.playbackRangeChanged.trigger(new Qn(t))}get isLooping(){return this.sequencer.isLooping}set isLooping(t){this.sequencer.isLooping=t}destroy(){J.debug("AlphaSynth","Destroying player"),this.stop(),this.output.destroy()}constructor(t,e,s){J.debug("AlphaSynth","Initializing player"),this.state=Ke.Paused,this.ready=new bi(()=>this.isReady),this.readyForPlayback=new bi(()=>this.isReadyForPlayback),this.midiLoaded=new mi(()=>this.zf?this.zf:null),this.stateChanged=new mi(()=>new Ui(this.state,!1)),this.positionChanged=new mi(()=>this.if),this.playbackRangeChanged=new mi(()=>this.playbackRange?new Qn(this.playbackRange):null),J.debug("AlphaSynth","Creating output"),this.nn=t,J.debug("AlphaSynth","Creating synthesizer"),this.synthesizer=e,this.sequencer=new $i(this.synthesizer),J.debug("AlphaSynth","Opening output"),this.output.ready.on(()=>{this.isReady=!0,this.ready.trigger(),this.Xf()}),this.output.sampleRequest.on(()=>{this.onSampleRequest()}),this.output.samplesPlayed.on(this.jf.bind(this)),this.output.open(s)}onSampleRequest(){if(this.state===Ke.Playing&&(!this.sequencer.isFinished||this.synthesizer.activeVoiceCount>0)){let t=new Float32Array(Vt.MicroBufferSize*Vt.MicroBufferCount*Vt.AudioChannels),e=0;for(let s=0;s<Vt.MicroBufferCount;s++){this.sequencer.fillMidiEventQueue();const s=this.synthesizer.synthesize(t,e,Vt.MicroBufferSize);e+=Vt.MicroBufferSize*Vt.AudioChannels;for(const t of s)this.midiEventsPlayedFilterSet.has(t.event.type)&&this.playedEventsQueue.enqueue(t);if(this.sequencer.isFinished)break}e<t.length&&(t=t.subarray(0,e)),this.$f+=t.length,this.output.addSamples(t)}else{const t=new Float32Array(0);this.output.addSamples(t)}}play(){return!(this.state!==Ke.Paused||!this.Rf)&&(this.output.activate(),this.Jf(),this.Vf>0&&(J.debug("AlphaSynth","Starting countin"),this.sequencer.startCountIn(),this.synthesizer.setupMetronomeChannel(this.Vf),this.updateTimePosition(0,!0)),this.output.play(),!0)}Jf(){this.sequencer.isPlayingOneTimeMidi&&(J.debug("AlphaSynth","Cancelling one time midi"),this.qf()),J.debug("AlphaSynth","Starting playback"),this.synthesizer.setupMetronomeChannel(this.metronomeVolume),this.Uf=!1,this.state=Ke.Playing,this.stateChanged.trigger(new Ui(this.state,!1))}pause(){this.state!==Ke.Paused&&this.Rf&&(J.debug("AlphaSynth","Pausing playback"),this.state=Ke.Paused,this.stateChanged.trigger(new Ui(this.state,!1)),this.output.pause(),this.synthesizer.noteOffAll(!1))}playPause(){this.state===Ke.Paused&&this.Rf?this.play():this.pause()}stop(){this.Rf&&(J.debug("AlphaSynth","Stopping playback"),this.state=Ke.Paused,this.output.pause(),this.$f=0,this.sequencer.stop(),this.synthesizer.noteOffAll(!0),this.tickPosition=this.sequencer.mainPlaybackRange?this.sequencer.mainPlaybackRange.startTick:0,this.stateChanged.trigger(new Ui(this.state,!0)))}playOneTimeMidiFile(t){this.sequencer.isPlayingOneTimeMidi?this.qf():this.pause(),this.sequencer.loadOneTimeMidi(t),this.synthesizer.noteOffAll(!0),this.updateTimePosition(0,!0),this.$f=0,this.output.resetSamples(),this.output.play()}resetSoundFonts(){this.stop(),this.synthesizer.resetPresets(),this.Yf=[],this.isSoundFontLoaded=!1,this.soundFontLoaded.trigger()}Yf=[];loadSoundFont(t,e){this.pause();const s=Fe.fromBuffer(t);try{J.debug("AlphaSynth","Loading soundfont from bytes");const t=new vn;t.load(s),e||(this.Yf=[]),this.Yf.push(t),this.isSoundFontLoaded=!0,this.soundFontLoaded.trigger(),J.debug("AlphaSynth","soundFont successfully loaded"),this.Xf()}catch(t){J.error("AlphaSynth",`Could not load soundfont from bytes ${t}`),this.soundFontLoadFailed.trigger(t)}}Xf(){if(this.isReadyForPlayback){this.synthesizer.setupMetronomeChannel(this.metronomeVolume);const t=this.sequencer.instrumentPrograms,e=this.sequencer.percussionKeys;let s=!1;for(const i of this.Yf)this.synthesizer.loadPresets(i,t,e,s),s=!0;this.readyForPlayback.trigger()}}loadMidiFile(t){this.stop();try{J.debug("AlphaSynth","Loading midi from model"),this.sequencer.loadMidi(t),this.Rf=!0,this.zf=new zi(0,this.sequencer.currentEndTime,0,this.sequencer.currentEndTick,!1,this.sequencer.currentTempo,this.sequencer.modifiedTempo),this.midiLoaded.trigger(this.zf),J.debug("AlphaSynth","Midi successfully loaded"),this.Xf(),this.tickPosition=0}catch(t){J.error("AlphaSynth",`Could not load midi from model ${t}`),this.midiLoadFailed.trigger(t)}}applyTranspositionPitches(t){this.synthesizer.applyTranspositionPitches(t)}setChannelTranspositionPitch(t,e){this.synthesizer.setChannelTranspositionPitch(t,e)}setChannelMute(t,e){this.synthesizer.channelSetMute(t,e)}resetChannelStates(){this.synthesizer.resetChannelStates()}setChannelSolo(t,e){this.synthesizer.channelSetSolo(t,e)}setChannelVolume(t,e){e=Math.max(e,Vt.MinVolume),this.synthesizer.channelSetMixVolume(t,e)}jf(t){if(0===t)return;const e=t/this.synthesizer.outSampleRate*1e3;this.$f-=t*Vt.AudioChannels,this.updateTimePosition(this.Gf+e,!1),this.checkForFinish()}checkForFinish(){let t=0,e=0;this.playbackRange&&this.sequencer.isPlayingMain?(t=this.playbackRange.startTick,e=this.playbackRange.endTick):e=this.sequencer.currentEndTick,this.If>=e&&(this.$f<=0?(this.$f=0,this.sequencer.isPlayingCountIn?(J.debug("AlphaSynth","Finished playback (count-in)"),this.sequencer.resetCountIn(),this.timePosition=this.sequencer.currentTime,this.Jf(),this.output.resetSamples()):this.sequencer.isPlayingOneTimeMidi?(J.debug("AlphaSynth","Finished playback (one time)"),this.output.resetSamples(),this.state=Ke.Paused,this.qf()):this.isLooping?(J.debug("AlphaSynth","Finished playback (main looping)"),this.finished.trigger(),this.tickPosition=t,this.Uf=!1):this.synthesizer.activeVoiceCount>0?this.Uf||(J.debug("AlphaSynth","Signaling synth to stop all voices (all samples played)"),this.synthesizer.noteOffAll(!0),this.Uf=!0):(this.Uf=!1,J.debug("AlphaSynth","Finished playback (main)"),this.finished.trigger(),this.stop())):this.Uf||(J.debug("AlphaSynth","Signaling synth to stop all voices (not all samples played)"),this.synthesizer.noteOffAll(!0),this.Uf=!0))}qf(){this.output.pause(),this.synthesizer.noteOffAll(!0),this.sequencer.resetOneTimeMidi(),this.timePosition=this.sequencer.currentTime}Kf(t){let e=this.Gf,s=this.sequencer.currentTimePositionToTickPosition(e);const i=this.sequencer.currentEndTime,n=this.sequencer.currentEndTick;return e>i&&(e=i,s=n),new zi(e,i,s,n,t,this.sequencer.currentTempo,this.sequencer.modifiedTempo)}updateTimePosition(t,e){this.Gf=t;const s=this.Kf(e);this.If=s.currentTick;const i=this.sequencer.isPlayingMain?"main":this.sequencer.isPlayingCountIn?"count-in":"one-time";if(J.debug("AlphaSynth",`Position changed: (time: ${s.currentTime}/${s.endTime}, tick: ${s.currentTick}/${s.endTick}, Active Voices: ${this.synthesizer.activeVoiceCount} (${i}), Tempo original: ${this.sequencer.currentTempo}, Tempo modified: ${this.sequencer.modifiedTempo})`),this.sequencer.isPlayingMain&&(this.if=s,this.positionChanged.trigger(s)),e)this.playedEventsQueue.clear();else{const t=[];for(;!this.playedEventsQueue.isEmpty&&this.playedEventsQueue.peek().time<s.currentTime;){const e=this.playedEventsQueue.dequeue();t.push(e.event)}t.length>0&&(t.reverse(),this.midiEventsPlayed.trigger(new Kn(t)))}}ready;readyForPlayback=new bi;finished=new bi;soundFontLoaded=new bi;soundFontLoadFailed=new mi;midiLoaded;midiLoadFailed=new mi;stateChanged;positionChanged;midiEventsPlayed=new mi;playbackRangeChanged;hasSamplesForProgram(t){return this.synthesizer.hasSamplesForProgram(t)}hasSamplesForPercussion(t){return this.synthesizer.hasSamplesForPercussion(t)}loadBackingTrack(t){}updateSyncPoints(t){}}class sr extends er{constructor(t,e){super(t,new Yn(t.sampleRate),e)}exportAudio(t,e,s,i){const n=new ir(t);n.loadMidiFile(e),t.useSyncPoints&&n.updateSyncPoints(s),n.applyTranspositionPitches(i);for(const[e,s]of t.trackTranspositionPitches)n.setChannelTranspositionPitch(e,s);for(const[e,s]of t.trackVolume)n.channelSetMixVolume(e,s);if(t.soundFonts)for(const e of t.soundFonts)n.loadSoundFont(e);else n.loadPresets(this.synthesizer.presets);return t.playbackRange&&n.limitExport(t.playbackRange),n.setup(),n}}class ir{Qf;Zf;constructor(t){this.Qf=new Yn(t.sampleRate),this.Zf=new $i(this.Qf),this.Qf.masterVolume=Math.max(t.masterVolume,Vt.MinVolume),this.Qf.metronomeVolume=Math.max(t.metronomeVolume,Vt.MinVolume)}loadSoundFont(t){const e=Fe.fromBuffer(t),s=new vn;s.load(e);const i=this.Zf.instrumentPrograms,n=this.Zf.percussionKeys;this.Qf.loadPresets(s,i,n,!0)}loadPresets(t){this.Qf.presets=t}limitExport(t){this.Zf.mainPlaybackRange=t,this.Zf.mainSeek(this.Zf.mainTickPositionToTimePosition(t.startTick))}setChannelTranspositionPitch(t,e){this.Qf.setChannelTranspositionPitch(t,e)}applyTranspositionPitches(t){this.Qf.applyTranspositionPitches(t)}loadMidiFile(t){this.Zf.loadMidi(t)}updateSyncPoints(t){this.Zf.mainUpdateSyncPoints(t)}channelSetMixVolume(t,e){e=Math.max(e,Vt.MinVolume),this.Qf.channelSetMixVolume(t,e)}tp=0;ep=0;setup(){this.Qf.setupMetronomeChannel(this.Qf.metronomeVolume);const t=this.Zf.currentSyncPoints,e=this.Zf.currentEndTime;if(0===t.length)this.ep=e;else{const e=t[t.length-1];let s=e.syncTime;const i=this.Zf.currentEndTick-e.synthTick;i>0&&(s+=H.ticksToMillis(i,e.syncBpm)),this.ep=s}}render(t){if(this.Zf.isFinished)return;const e=1e3*Vt.MicroBufferSize/this.Qf.outSampleRate,s=Math.ceil(t/e);let i=new Float32Array(Vt.MicroBufferSize*s*Vt.AudioChannels);const n=this.Zf.currentSyncPoints;let r=0,a=this.tp;for(let t=0;t<s;t++){if(n.length>0){this.Zf.currentUpdateSyncPoints(a),this.Zf.currentUpdateCurrentTempo(this.Zf.currentTime);const t=this.Zf.syncPointTempo/this.Zf.currentTempo;this.Zf.playbackSpeed!==t&&(this.Zf.playbackSpeed=t)}if(this.Zf.fillMidiEventQueue(),this.Qf.synthesize(i,r,Vt.MicroBufferSize),r+=Vt.MicroBufferSize*Vt.AudioChannels,a+=e,this.Zf.isFinished)break}r<i.length&&(i=i.subarray(0,r));const h=new tr;return h.currentTime=this.tp,h.endTime=this.ep,h.currentTick=this.Zf.currentTimePositionToTickPosition(this.Zf.currentTime),h.endTick=this.Zf.currentEndTick,this.tp+=t,h.samples=i,this.Zf.isFinished&&this.Qf.noteOffAll(!0),h}}class nr{static parseEnum(t,e){switch(typeof t){case"string":const s=Number.parseInt(t,10);return Number.isNaN(s)?e[Object.keys(e).find(e=>e.toLowerCase()===t.toLowerCase())]:s;case"number":return t;case"undefined":case"object":return}throw new I(s.Format,`Could not parse enum value '${t}'`)}static parseEnumExact(t,e){if(t in e)return e[t]}static forEach(t,e){if(t instanceof Map)t.forEach(e);else if("object"==typeof t)for(const s in t)e(t[s],s)}static getValue(t,e){return t instanceof Map?t.get(e):"object"==typeof t?t[e]:null}}class rr{static fromJson(t,e){e&&nr.forEach(e,(e,s)=>rr.setProperty(t,s,e))}static toJson(t){if(!t)return null;const e=new Map;{const s=new Map;e.set("groups",s);for(const[e,i]of t.groups)s.set(e.toString(),i)}return e}static setProperty(t,e,s){return"groups"===e&&(t.groups=new Map,nr.forEach(s,(e,s)=>{t.groups.set(nr.parseEnum(s,c),e)}),!0)}}class ar{static fromJson(t,e){e&&nr.forEach(e,(e,s)=>ar.setProperty(t,s,e))}static toJson(t){if(!t)return null;const e=new Map;return e.set("marker",t.marker),e.set("text",t.text),e}static setProperty(t,e,s){switch(e){case"marker":return t.marker=s,!0;case"text":return t.text=s,!0}return!1}}class hr{static fromJson(t,e){e&&nr.forEach(e,(e,s)=>hr.setProperty(t,s,e))}static toJson(t){if(!t)return null;const e=new Map;return e.set("baroccurence",t.barOccurence),e.set("millisecondoffset",t.millisecondOffset),e}static setProperty(t,e,s){switch(e){case"baroccurence":return t.barOccurence=s,!0;case"millisecondoffset":return t.millisecondOffset=s,!0}return!1}}class or{static fromJson(t,e){e&&nr.forEach(e,(e,s)=>or.setProperty(t,s,e))}static toJson(t){if(!t)return null;const e=new Map;return e.set("islinear",t.isLinear),e.set("type",t.type),e.set("value",t.value),t.syncPointValue&&e.set("syncpointvalue",hr.toJson(t.syncPointValue)),e.set("ratioposition",t.ratioPosition),e.set("text",t.text),e.set("isvisible",t.isVisible),e}static setProperty(t,e,s){switch(e){case"islinear":return t.isLinear=s,!0;case"type":return t.type=nr.parseEnum(s,n),!0;case"value":return t.value=s,!0;case"syncpointvalue":return s?(t.syncPointValue=new V,hr.fromJson(t.syncPointValue,s)):t.syncPointValue=void 0,!0;case"ratioposition":return t.ratioPosition=s,!0;case"text":return t.text=s,!0;case"isvisible":return t.isVisible=s,!0}return!1}}class cr{static fromJson(t,e){e&&nr.forEach(e,(e,s)=>cr.setProperty(t,s,e))}static toJson(t){if(!t)return null;const e=new Map;return e.set("type",t.type),e.set("length",t.length),e}static setProperty(t,e,s){switch(e){case"type":return t.type=nr.parseEnum(s,At),!0;case"length":return t.length=s,!0}return!1}}class lr{static fromJson(t,e){e&&nr.forEach(e,(e,s)=>lr.setProperty(t,s,e))}static toJson(t){if(!t)return null;const e=new Map;if(e.set("alternateendings",t.alternateEndings),e.set("isdoublebar",t.isDoubleBar),e.set("isrepeatstart",t.isRepeatStart),e.set("repeatcount",t.repeatCount),e.set("timesignaturenumerator",t.timeSignatureNumerator),e.set("timesignaturedenominator",t.timeSignatureDenominator),e.set("timesignaturecommon",t.timeSignatureCommon),t.beamingRules&&e.set("beamingrules",rr.toJson(t.beamingRules)),e.set("isfreetime",t.isFreeTime),e.set("tripletfeel",t.tripletFeel),t.section&&e.set("section",ar.toJson(t.section)),e.set("tempoautomations",t.tempoAutomations.map(t=>or.toJson(t))),void 0!==t.syncPoints&&e.set("syncpoints",t.syncPoints?.map(t=>or.toJson(t))),null!==t.fermata){const s=new Map;e.set("fermata",s);for(const[e,i]of t.fermata)s.set(e.toString(),cr.toJson(i))}if(e.set("start",t.start),e.set("isanacrusis",t.isAnacrusis),e.set("displayscale",t.displayScale),e.set("displaywidth",t.displayWidth),null!==t.directions){const s=[];e.set("directions",s);for(const e of t.directions)s.push(e)}return e}static setProperty(t,e,s){switch(e){case"alternateendings":return t.alternateEndings=s,!0;case"isdoublebar":return t.isDoubleBar=s,!0;case"isrepeatstart":return t.isRepeatStart=s,!0;case"repeatcount":return t.repeatCount=s,!0;case"timesignaturenumerator":return t.timeSignatureNumerator=s,!0;case"timesignaturedenominator":return t.timeSignatureDenominator=s,!0;case"timesignaturecommon":return t.timeSignatureCommon=s,!0;case"beamingrules":return s?(t.beamingRules=new Z,rr.fromJson(t.beamingRules,s)):t.beamingRules=void 0,!0;case"isfreetime":return t.isFreeTime=s,!0;case"tripletfeel":return t.tripletFeel=nr.parseEnum(s,F),!0;case"section":return s?(t.section=new _e,ar.fromJson(t.section,s)):t.section=null,!0;case"tempoautomations":t.tempoAutomations=[];for(const e of s){const s=new $;or.fromJson(s,e),t.tempoAutomations.push(s)}return!0;case"syncpoints":if(s){t.syncPoints=[];for(const e of s){const s=new $;or.fromJson(s,e),t.addSyncPoint(s)}}return!0;case"fermata":return t.fermata=new Map,nr.forEach(s,(e,s)=>{const i=new Se;cr.fromJson(i,e),t.addFermata(Number.parseInt(s),i)}),!0;case"start":return t.start=s,!0;case"isanacrusis":return t.isAnacrusis=s,!0;case"displayscale":return t.displayScale=s,!0;case"displaywidth":return t.displayWidth=s,!0;case"directions":for(const e of s)t.addDirection(nr.parseEnum(e,ze));return!0}return!1}}class ur{static fromJson(t,e){e&&nr.forEach(e,(e,s)=>ur.setProperty(t,s,e))}static toJson(t){if(!t)return null;const e=new Map;return e.set("offset",t.offset),e.set("value",t.value),e}static setProperty(t,e,s){switch(e){case"offset":return t.offset=s,!0;case"value":return t.value=s,!0}return!1}}class dr{static fromJson(t,e){e&&nr.forEach(e,(e,s)=>dr.setProperty(t,s,e))}static toJson(t){if(!t)return null;const e=new Map;e.set("notehead",t.noteHead),e.set("noteheadcenteronstem",t.noteHeadCenterOnStem);{const s=new Map;e.set("colors",s);for(const[e,i]of t.colors)s.set(e.toString(),ke.toJson(i))}return e}static setProperty(t,e,s){switch(e){case"notehead":return t.noteHead=nr.parseEnum(s,lt),!0;case"noteheadcenteronstem":return t.noteHeadCenterOnStem=s,!0;case"colors":return t.colors=new Map,nr.forEach(s,(e,s)=>{t.colors.set(nr.parseEnum(s,ft),ke.fromJson(e))}),!0}return!1}}class fr{static fromJson(t,e){e&&nr.forEach(e,(e,s)=>fr.setProperty(t,s,e))}static toJson(t){if(!t)return null;const e=new Map;return e.set("id",t.id),e.set("accentuated",t.accentuated),e.set("bendtype",t.bendType),e.set("bendstyle",t.bendStyle),e.set("iscontinuedbend",t.isContinuedBend),null!==t.bendPoints&&e.set("bendpoints",t.bendPoints?.map(t=>ur.toJson(t))),e.set("fret",t.fret),e.set("string",t.string),e.set("showstringnumber",t.showStringNumber),e.set("octave",t.octave),e.set("tone",t.tone),e.set("percussionarticulation",t.percussionArticulation),e.set("isvisible",t.isVisible),e.set("islefthandtapped",t.isLeftHandTapped),e.set("ishammerpullorigin",t.isHammerPullOrigin),e.set("isslurdestination",t.isSlurDestination),e.set("harmonictype",t.harmonicType),e.set("harmonicvalue",t.harmonicValue),e.set("isghost",t.isGhost),e.set("isletring",t.isLetRing),e.set("ispalmmute",t.isPalmMute),e.set("isdead",t.isDead),e.set("isstaccato",t.isStaccato),e.set("slideintype",t.slideInType),e.set("slideouttype",t.slideOutType),e.set("vibrato",t.vibrato),e.set("istiedestination",t.isTieDestination),e.set("lefthandfinger",t.leftHandFinger),e.set("righthandfinger",t.rightHandFinger),e.set("trillvalue",t.trillValue),e.set("trillspeed",t.trillSpeed),e.set("durationpercent",t.durationPercent),e.set("accidentalmode",t.accidentalMode),e.set("dynamics",t.dynamics),e.set("ornament",t.ornament),t.style&&e.set("style",dr.toJson(t.style)),t.toJson(e),e}static setProperty(t,e,s){switch(e){case"id":return t.id=s,!0;case"accentuated":return t.accentuated=nr.parseEnum(s,u),!0;case"bendtype":return t.bendType=nr.parseEnum(s,a),!0;case"bendstyle":return t.bendStyle=nr.parseEnum(s,r),!0;case"iscontinuedbend":return t.isContinuedBend=s,!0;case"bendpoints":if(s){t.bendPoints=[];for(const e of s){const s=new U;ur.fromJson(s,e),t.addBendPoint(s)}}return!0;case"fret":return t.fret=s,!0;case"string":return t.string=s,!0;case"showstringnumber":return t.showStringNumber=s,!0;case"octave":return t.octave=s,!0;case"tone":return t.tone=s,!0;case"percussionarticulation":return t.percussionArticulation=s,!0;case"isvisible":return t.isVisible=s,!0;case"islefthandtapped":return t.isLeftHandTapped=s,!0;case"ishammerpullorigin":return t.isHammerPullOrigin=s,!0;case"isslurdestination":return t.isSlurDestination=s,!0;case"harmonictype":return t.harmonicType=nr.parseEnum(s,f),!0;case"harmonicvalue":return t.harmonicValue=s,!0;case"isghost":return t.isGhost=s,!0;case"isletring":return t.isLetRing=s,!0;case"ispalmmute":return t.isPalmMute=s,!0;case"isdead":return t.isDead=s,!0;case"isstaccato":return t.isStaccato=s,!0;case"slideintype":return t.slideInType=nr.parseEnum(s,m),!0;case"slideouttype":return t.slideOutType=nr.parseEnum(s,g),!0;case"vibrato":return t.vibrato=nr.parseEnum(s,w),!0;case"istiedestination":return t.isTieDestination=s,!0;case"lefthandfinger":return t.leftHandFinger=nr.parseEnum(s,d),!0;case"righthandfinger":return t.rightHandFinger=nr.parseEnum(s,d),!0;case"trillvalue":return t.trillValue=s,!0;case"trillspeed":return t.trillSpeed=nr.parseEnum(s,c),!0;case"durationpercent":return t.durationPercent=s,!0;case"accidentalmode":return t.accidentalMode=nr.parseEnum(s,p),!0;case"dynamics":return t.dynamics=nr.parseEnum(s,i),!0;case"ornament":return t.ornament=nr.parseEnum(s,dt),!0;case"style":return s?(t.style=new Yt,dr.fromJson(t.style,s)):t.style=void 0,!0}return t.setProperty(e,s)}}class pr{static fromJson(t,e){e&&nr.forEach(e,(e,s)=>pr.setProperty(t,s,e))}static toJson(t){if(!t)return null;const e=new Map;return e.set("marks",t.marks),e.set("style",t.style),e}static setProperty(t,e,s){switch(e){case"marks":return t.marks=s,!0;case"style":return t.style=nr.parseEnum(s,kt),!0}return!1}}class br{static fromJson(t,e){e&&nr.forEach(e,(e,s)=>br.setProperty(t,s,e))}static toJson(t){if(!t)return null;const e=new Map;{const s=new Map;e.set("colors",s);for(const[e,i]of t.colors)s.set(e.toString(),ke.toJson(i))}return e}static setProperty(t,e,s){return"colors"===e&&(t.colors=new Map,nr.forEach(s,(e,s)=>{t.colors.set(nr.parseEnum(s,Bt),ke.fromJson(e))}),!0)}}class mr{static fromJson(t,e){e&&nr.forEach(e,(e,s)=>mr.setProperty(t,s,e))}static toJson(t){if(!t)return null;const e=new Map;return e.set("id",t.id),e.set("notes",t.notes.map(t=>fr.toJson(t))),e.set("isempty",t.isEmpty),e.set("whammystyle",t.whammyStyle),e.set("ottava",t.ottava),e.set("islegatoorigin",t.isLegatoOrigin),e.set("duration",t.duration),e.set("automations",t.automations.map(t=>or.toJson(t))),e.set("dots",t.dots),e.set("fade",t.fade),e.set("lyrics",t.lyrics),e.set("pop",t.pop),e.set("slap",t.slap),e.set("tap",t.tap),e.set("text",t.text),e.set("slashed",t.slashed),e.set("deadslapped",t.deadSlapped),e.set("brushtype",t.brushType),e.set("brushduration",t.brushDuration),e.set("tupletdenominator",t.tupletDenominator),e.set("tupletnumerator",t.tupletNumerator),e.set("iscontinuedwhammy",t.isContinuedWhammy),e.set("whammybartype",t.whammyBarType),null!==t.whammyBarPoints&&e.set("whammybarpoints",t.whammyBarPoints?.map(t=>ur.toJson(t))),e.set("vibrato",t.vibrato),e.set("chordid",t.chordId),e.set("gracetype",t.graceType),e.set("pickstroke",t.pickStroke),t.tremoloPicking&&e.set("tremolopicking",pr.toJson(t.tremoloPicking)),e.set("crescendo",t.crescendo),e.set("displaystart",t.displayStart),e.set("playbackstart",t.playbackStart),e.set("displayduration",t.displayDuration),e.set("playbackduration",t.playbackDuration),e.set("overridedisplayduration",t.overrideDisplayDuration),e.set("golpe",t.golpe),e.set("dynamics",t.dynamics),e.set("invertbeamdirection",t.invertBeamDirection),e.set("preferredbeamdirection",t.preferredBeamDirection),e.set("beamingmode",t.beamingMode),e.set("wahpedal",t.wahPedal),e.set("barrefret",t.barreFret),e.set("barreshape",t.barreShape),e.set("rasgueado",t.rasgueado),e.set("showtimer",t.showTimer),e.set("timer",t.timer),t.style&&e.set("style",br.toJson(t.style)),e}static setProperty(t,e,s){switch(e){case"id":return t.id=s,!0;case"notes":t.notes=[];for(const e of s){const s=new Kt;fr.fromJson(s,e),t.addNote(s)}return!0;case"isempty":return t.isEmpty=s,!0;case"whammystyle":return t.whammyStyle=nr.parseEnum(s,r),!0;case"ottava":return t.ottava=nr.parseEnum(s,b),!0;case"islegatoorigin":return t.isLegatoOrigin=s,!0;case"duration":return t.duration=nr.parseEnum(s,c),!0;case"automations":t.automations=[];for(const e of s){const s=new $;or.fromJson(s,e),t.automations.push(s)}return!0;case"dots":return t.dots=s,!0;case"fade":return t.fade=nr.parseEnum(s,mt),!0;case"lyrics":return t.lyrics=s,!0;case"pop":return t.pop=s,!0;case"slap":return t.slap=s,!0;case"tap":return t.tap=s,!0;case"text":return t.text=s,!0;case"slashed":return t.slashed=s,!0;case"deadslapped":return t.deadSlapped=s,!0;case"brushtype":return t.brushType=nr.parseEnum(s,h),!0;case"brushduration":return t.brushDuration=s,!0;case"tupletdenominator":return t.tupletDenominator=s,!0;case"tupletnumerator":return t.tupletNumerator=s,!0;case"iscontinuedwhammy":return t.isContinuedWhammy=s,!0;case"whammybartype":return t.whammyBarType=nr.parseEnum(s,pt),!0;case"whammybarpoints":if(s){t.whammyBarPoints=[];for(const e of s){const s=new U;ur.fromJson(s,e),t.addWhammyBarPoint(s)}}return!0;case"vibrato":return t.vibrato=nr.parseEnum(s,w),!0;case"chordid":return t.chordId=s,!0;case"gracetype":return t.graceType=nr.parseEnum(s,l),!0;case"pickstroke":return t.pickStroke=nr.parseEnum(s,ct),!0;case"tremolopicking":return s?(t.tremoloPicking=new Zt,pr.fromJson(t.tremoloPicking,s)):t.tremoloPicking=void 0,!0;case"crescendo":return t.crescendo=nr.parseEnum(s,o),!0;case"displaystart":return t.displayStart=s,!0;case"playbackstart":return t.playbackStart=s,!0;case"displayduration":return t.displayDuration=s,!0;case"playbackduration":return t.playbackDuration=s,!0;case"overridedisplayduration":return t.overrideDisplayDuration=s,!0;case"golpe":return t.golpe=nr.parseEnum(s,bt),!0;case"dynamics":return t.dynamics=nr.parseEnum(s,i),!0;case"invertbeamdirection":return t.invertBeamDirection=s,!0;case"preferredbeamdirection":return t.preferredBeamDirection=nr.parseEnum(s,Wt)??null,!0;case"beamingmode":return t.beamingMode=nr.parseEnum(s,St),!0;case"wahpedal":return t.wahPedal=nr.parseEnum(s,gt),!0;case"barrefret":return t.barreFret=s,!0;case"barreshape":return t.barreShape=nr.parseEnum(s,wt),!0;case"rasgueado":return t.rasgueado=nr.parseEnum(s,yt),!0;case"showtimer":return t.showTimer=s,!0;case"timer":return t.timer=s,!0;case"style":return s?(t.style=new te,br.fromJson(t.style,s)):t.style=void 0,!0}return!1}}class gr{static fromJson(t,e){e&&nr.forEach(e,(e,s)=>gr.setProperty(t,s,e))}static toJson(t){if(!t)return null;const e=new Map;{const s=new Map;e.set("colors",s);for(const[e,i]of t.colors)s.set(e.toString(),ke.toJson(i))}return e}static setProperty(t,e,s){return"colors"===e&&(t.colors=new Map,nr.forEach(s,(e,s)=>{t.colors.set(nr.parseEnum(s,R),ke.fromJson(e))}),!0)}}class wr{static fromJson(t,e){e&&nr.forEach(e,(e,s)=>wr.setProperty(t,s,e))}static toJson(t){if(!t)return null;const e=new Map;return e.set("id",t.id),e.set("beats",t.beats.map(t=>mr.toJson(t))),t.style&&e.set("style",gr.toJson(t.style)),e}static setProperty(t,e,s){switch(e){case"id":return t.id=s,!0;case"beats":t.beats=[];for(const e of s){const s=new ee;mr.fromJson(s,e),t.addBeat(s)}return!0;case"style":return s?(t.style=new nt,gr.fromJson(t.style,s)):t.style=void 0,!0}return!1}}class yr{static fromJson(t,e){e&&nr.forEach(e,(e,s)=>yr.setProperty(t,s,e))}static toJson(t){if(!t)return null;const e=new Map;return e.set("ratioposition",t.ratioPosition),e.set("pedaltype",t.pedalType),e}static setProperty(t,e,s){switch(e){case"ratioposition":return t.ratioPosition=s,!0;case"pedaltype":return t.pedalType=nr.parseEnum(s,P),!0}return!1}}class kr{static fromJson(t,e){e&&nr.forEach(e,(e,s)=>kr.setProperty(t,s,e))}static toJson(t){if(!t)return null;const e=new Map;{const s=new Map;e.set("colors",s);for(const[e,i]of t.colors)s.set(e.toString(),ke.toJson(i))}return e}static setProperty(t,e,s){return"colors"===e&&(t.colors=new Map,nr.forEach(s,(e,s)=>{t.colors.set(nr.parseEnum(s,C),ke.fromJson(e))}),!0)}}class Sr{static fromJson(t,e){e&&nr.forEach(e,(e,s)=>Sr.setProperty(t,s,e))}static toJson(t){if(!t)return null;const e=new Map;return e.set("id",t.id),e.set("clef",t.clef),e.set("clefottava",t.clefOttava),e.set("voices",t.voices.map(t=>wr.toJson(t))),e.set("similemark",t.simileMark),e.set("displayscale",t.displayScale),e.set("displaywidth",t.displayWidth),e.set("sustainpedals",t.sustainPedals.map(t=>yr.toJson(t))),e.set("barlineleft",t.barLineLeft),e.set("barlineright",t.barLineRight),e.set("keysignature",t.keySignature),e.set("keysignaturetype",t.keySignatureType),e.set("barnumberdisplay",t.barNumberDisplay),t.style&&e.set("style",kr.toJson(t.style)),e}static setProperty(t,e,s){switch(e){case"id":return t.id=s,!0;case"clef":return t.clef=nr.parseEnum(s,x),!0;case"clefottava":return t.clefOttava=nr.parseEnum(s,b),!0;case"voices":t.voices=[];for(const e of s){const s=new rt;wr.fromJson(s,e),t.addVoice(s)}return!0;case"similemark":return t.simileMark=nr.parseEnum(s,M),!0;case"displayscale":return t.displayScale=s,!0;case"displaywidth":return t.displayWidth=s,!0;case"sustainpedals":t.sustainPedals=[];for(const e of s){const s=new Y;yr.fromJson(s,e),t.sustainPedals.push(s)}return!0;case"barlineleft":return t.barLineLeft=nr.parseEnum(s,E),!0;case"barlineright":return t.barLineRight=nr.parseEnum(s,E),!0;case"keysignature":return t.keySignature=nr.parseEnum(s,v),!0;case"keysignaturetype":return t.keySignatureType=nr.parseEnum(s,N),!0;case"barnumberdisplay":return t.barNumberDisplay=nr.parseEnum(s,O),!0;case"style":return s?(t.style=new K,kr.fromJson(t.style,s)):t.style=void 0,!0}return!1}}class Br{static fromJson(t,e){e&&nr.forEach(e,(e,s)=>Br.setProperty(t,s,e))}static toJson(t){if(!t)return null;const e=new Map;return e.set("name",t.name),e.set("firstfret",t.firstFret),e.set("strings",t.strings),e.set("barrefrets",t.barreFrets),e.set("showname",t.showName),e.set("showdiagram",t.showDiagram),e.set("showfingering",t.showFingering),e}static setProperty(t,e,s){switch(e){case"name":return t.name=s,!0;case"firstfret":return t.firstFret=s,!0;case"strings":return t.strings=s,!0;case"barrefrets":return t.barreFrets=s,!0;case"showname":return t.showName=s,!0;case"showdiagram":return t.showDiagram=s,!0;case"showfingering":return t.showFingering=s,!0}return!1}}class _r{static fromJson(t,e){e&&nr.forEach(e,(e,s)=>_r.setProperty(t,s,e))}static toJson(t){if(!t)return null;const e=new Map;return e.set("isstandard",t.isStandard),e.set("name",t.name),e.set("tunings",t.tunings),e}static setProperty(t,e,s){switch(e){case"isstandard":return t.isStandard=s,!0;case"name":return t.name=s,!0;case"tunings":return t.tunings=s,!0}return!1}}class Tr{static fromJson(t,e){e&&nr.forEach(e,(e,s)=>Tr.setProperty(t,s,e))}static toJson(t){if(!t)return null;const e=new Map;if(e.set("bars",t.bars.map(t=>Sr.toJson(t))),null!==t.chords){const s=new Map;e.set("chords",s);for(const[e,i]of t.chords)s.set(e.toString(),Br.toJson(i))}return e.set("capo",t.capo),e.set("transpositionpitch",t.transpositionPitch),e.set("displaytranspositionpitch",t.displayTranspositionPitch),e.set("stringtuning",_r.toJson(t.stringTuning)),e.set("showslash",t.showSlash),e.set("shownumbered",t.showNumbered),e.set("showtablature",t.showTablature),e.set("showstandardnotation",t.showStandardNotation),e.set("ispercussion",t.isPercussion),e.set("standardnotationlinecount",t.standardNotationLineCount),e}static setProperty(t,e,s){switch(e){case"bars":t.bars=[];for(const e of s){const s=new Q;Sr.fromJson(s,e),t.addBar(s)}return!0;case"chords":return t.chords=new Map,nr.forEach(s,(e,s)=>{const i=new we;Br.fromJson(i,e),t.addChord(s,i)}),!0;case"capo":return t.capo=s,!0;case"transpositionpitch":return t.transpositionPitch=s,!0;case"displaytranspositionpitch":return t.displayTranspositionPitch=s,!0;case"stringtuning":return _r.fromJson(t.stringTuning,s),!0;case"showslash":return t.showSlash=s,!0;case"shownumbered":return t.showNumbered=s,!0;case"showtablature":return t.showTablature=s,!0;case"showstandardnotation":return t.showStandardNotation=s,!0;case"ispercussion":return t.isPercussion=s,!0;case"standardnotationlinecount":return t.standardNotationLineCount=s,!0}return!1}}class xr{static fromJson(t,e){e&&nr.forEach(e,(e,s)=>xr.setProperty(t,s,e))}static toJson(t){if(!t)return null;const e=new Map;return e.set("volume",t.volume),e.set("balance",t.balance),e.set("port",t.port),e.set("program",t.program),e.set("bank",t.bank),e.set("primarychannel",t.primaryChannel),e.set("secondarychannel",t.secondaryChannel),e.set("ismute",t.isMute),e.set("issolo",t.isSolo),e}static setProperty(t,e,s){switch(e){case"volume":return t.volume=s,!0;case"balance":return t.balance=s,!0;case"port":return t.port=s,!0;case"program":return t.program=s,!0;case"bank":return t.bank=s,!0;case"primarychannel":return t.primaryChannel=s,!0;case"secondarychannel":return t.secondaryChannel=s,!0;case"ismute":return t.isMute=s,!0;case"issolo":return t.isSolo=s,!0}return!1}}class Mr{static fromJson(t,e){e&&nr.forEach(e,(e,s)=>Mr.setProperty(t,s,e))}static toJson(t){if(!t)return null;const e=new Map;return e.set("id",t.id),e.set("elementtype",t.elementType),e.set("staffline",t.staffLine),e.set("noteheaddefault",t.noteHeadDefault),e.set("noteheadhalf",t.noteHeadHalf),e.set("noteheadwhole",t.noteHeadWhole),e.set("techniquesymbol",t.techniqueSymbol),e.set("techniquesymbolplacement",t.techniqueSymbolPlacement),e.set("outputmidinumber",t.outputMidiNumber),e}static setProperty(t,e,s){switch(e){case"id":return t.id=s,!0;case"elementtype":return t.elementType=s,!0;case"staffline":return t.staffLine=s,!0;case"noteheaddefault":return t.noteHeadDefault=nr.parseEnum(s,lt),!0;case"noteheadhalf":return t.noteHeadHalf=nr.parseEnum(s,lt),!0;case"noteheadwhole":return t.noteHeadWhole=nr.parseEnum(s,lt),!0;case"techniquesymbol":return t.techniqueSymbol=nr.parseEnum(s,lt),!0;case"techniquesymbolplacement":return t.techniqueSymbolPlacement=nr.parseEnum(s,ut),!0;case"outputmidinumber":return t.outputMidiNumber=s,!0}return!1}}class vr{static fromJson(t,e){e&&nr.forEach(e,(e,s)=>vr.setProperty(t,s,e))}static toJson(t){if(!t)return null;const e=new Map;{const s=new Map;e.set("colors",s);for(const[e,i]of t.colors)s.set(e.toString(),ke.toJson(i))}return e}static setProperty(t,e,s){return"colors"===e&&(t.colors=new Map,nr.forEach(s,(e,s)=>{t.colors.set(nr.parseEnum(s,Lt),ke.fromJson(e))}),!0)}}class Nr{static fromJson(t,e){e&&nr.forEach(e,(e,s)=>Nr.setProperty(t,s,e))}static toJson(t){if(!t)return null;const e=new Map;if(e.set("staves",t.staves.map(t=>Tr.toJson(t))),e.set("playbackinfo",xr.toJson(t.playbackInfo)),e.set("color",ke.toJson(t.color)),e.set("name",t.name),e.set("isvisibleonmultitrack",t.isVisibleOnMultiTrack),e.set("shortname",t.shortName),e.set("defaultsystemslayout",t.defaultSystemsLayout),e.set("systemslayout",t.systemsLayout),void 0!==t.lineBreaks){const s=[];e.set("linebreaks",s);for(const e of t.lineBreaks)s.push(e)}return e.set("percussionarticulations",t.percussionArticulations.map(t=>Mr.toJson(t))),t.style&&e.set("style",vr.toJson(t.style)),e}static setProperty(t,e,s){switch(e){case"staves":t.staves=[];for(const e of s){const s=new xe;Tr.fromJson(s,e),t.addStaff(s)}return!0;case"playbackinfo":return xr.fromJson(t.playbackInfo,s),!0;case"color":return t.color=ke.fromJson(s),!0;case"name":return t.name=s,!0;case"isvisibleonmultitrack":return t.isVisibleOnMultiTrack=s,!0;case"shortname":return t.shortName=s,!0;case"defaultsystemslayout":return t.defaultSystemsLayout=s,!0;case"systemslayout":return t.systemsLayout=s,!0;case"linebreaks":for(const e of s)t.addLineBreaks(e);return!0;case"percussionarticulations":t.percussionArticulations=[];for(const e of s){const s=new jt;Mr.fromJson(s,e),t.percussionArticulations.push(s)}return!0;case"style":return s?(t.style=new ve,vr.fromJson(t.style,s)):t.style=void 0,!0}return!1}}class Pr{static fromJson(t,e){e&&nr.forEach(e,(e,s)=>Pr.setProperty(t,s,e))}static toJson(t){if(!t)return null;const e=new Map;if(e.set("hidedynamics",t.hideDynamics),e.set("bracketextendmode",t.bracketExtendMode),e.set("usesystemsignseparator",t.useSystemSignSeparator),e.set("globaldisplaytuning",t.globalDisplayTuning),null!==t.perTrackDisplayTuning){const s=new Map;e.set("pertrackdisplaytuning",s);for(const[e,i]of t.perTrackDisplayTuning)s.set(e.toString(),i)}if(e.set("globaldisplaychorddiagramsontop",t.globalDisplayChordDiagramsOnTop),null!==t.perTrackChordDiagramsOnTop){const s=new Map;e.set("pertrackchorddiagramsontop",s);for(const[e,i]of t.perTrackChordDiagramsOnTop)s.set(e.toString(),i)}if(e.set("globaldisplaychorddiagramsinscore",t.globalDisplayChordDiagramsInScore),e.set("singletracktracknamepolicy",t.singleTrackTrackNamePolicy),e.set("multitracktracknamepolicy",t.multiTrackTrackNamePolicy),e.set("firstsystemtracknamemode",t.firstSystemTrackNameMode),e.set("othersystemstracknamemode",t.otherSystemsTrackNameMode),e.set("firstsystemtracknameorientation",t.firstSystemTrackNameOrientation),e.set("othersystemstracknameorientation",t.otherSystemsTrackNameOrientation),e.set("multitrackmultibarrest",t.multiTrackMultiBarRest),null!==t.perTrackMultiBarRest){const s=[];e.set("pertrackmultibarrest",s);for(const e of t.perTrackMultiBarRest)s.push(e)}return e.set("extendbarlines",t.extendBarLines),e.set("hideemptystaves",t.hideEmptyStaves),e.set("hideemptystavesinfirstsystem",t.hideEmptyStavesInFirstSystem),e.set("showsinglestaffbrackets",t.showSingleStaffBrackets),e.set("barnumberdisplay",t.barNumberDisplay),e}static setProperty(t,e,s){switch(e){case"hidedynamics":return t.hideDynamics=s,!0;case"bracketextendmode":return t.bracketExtendMode=nr.parseEnum(s,A),!0;case"usesystemsignseparator":return t.useSystemSignSeparator=s,!0;case"globaldisplaytuning":return t.globalDisplayTuning=s,!0;case"pertrackdisplaytuning":return t.perTrackDisplayTuning=new Map,nr.forEach(s,(e,s)=>{t.perTrackDisplayTuning.set(Number.parseInt(s),e)}),!0;case"globaldisplaychorddiagramsontop":return t.globalDisplayChordDiagramsOnTop=s,!0;case"pertrackchorddiagramsontop":return t.perTrackChordDiagramsOnTop=new Map,nr.forEach(s,(e,s)=>{t.perTrackChordDiagramsOnTop.set(Number.parseInt(s),e)}),!0;case"globaldisplaychorddiagramsinscore":return t.globalDisplayChordDiagramsInScore=s,!0;case"singletracktracknamepolicy":return t.singleTrackTrackNamePolicy=nr.parseEnum(s,D),!0;case"multitracktracknamepolicy":return t.multiTrackTrackNamePolicy=nr.parseEnum(s,D),!0;case"firstsystemtracknamemode":return t.firstSystemTrackNameMode=nr.parseEnum(s,L),!0;case"othersystemstracknamemode":return t.otherSystemsTrackNameMode=nr.parseEnum(s,L),!0;case"firstsystemtracknameorientation":return t.firstSystemTrackNameOrientation=nr.parseEnum(s,W),!0;case"othersystemstracknameorientation":return t.otherSystemsTrackNameOrientation=nr.parseEnum(s,W),!0;case"multitrackmultibarrest":return t.multiTrackMultiBarRest=s,!0;case"pertrackmultibarrest":return t.perTrackMultiBarRest=new Set(s),!0;case"extendbarlines":return t.extendBarLines=s,!0;case"hideemptystaves":return t.hideEmptyStaves=s,!0;case"hideemptystavesinfirstsystem":return t.hideEmptyStavesInFirstSystem=s,!0;case"showsinglestaffbrackets":return t.showSingleStaffBrackets=s,!0;case"barnumberdisplay":return t.barNumberDisplay=nr.parseEnum(s,O),!0}return!1}}class Cr{static fromJson(t,e){e&&nr.forEach(e,(e,s)=>Cr.setProperty(t,s,e))}static toJson(t){if(!t)return null;return new Map}static setProperty(t,e,s){return!1}}class Er{static fromJson(t,e){e&&nr.forEach(e,(e,s)=>Er.setProperty(t,s,e))}static toJson(t){if(!t)return null;const e=new Map;return e.set("template",t.template),e.set("isvisible",t.isVisible),e.set("textalign",t.textAlign),e}static setProperty(t,e,s){switch(e){case"template":return t.template=s,!0;case"isvisible":return t.isVisible=s,!0;case"textalign":return t.textAlign=nr.parseEnum(s,at),!0}return!1}}class Fr{static fromJson(t,e){e&&nr.forEach(e,(e,s)=>Fr.setProperty(t,s,e))}static toJson(t){if(!t)return null;const e=new Map;{const s=new Map;e.set("headerandfooter",s);for(const[e,i]of t.headerAndFooter)s.set(e.toString(),Er.toJson(i))}{const s=new Map;e.set("colors",s);for(const[e,i]of t.colors)s.set(e.toString(),ke.toJson(i))}return e}static setProperty(t,e,s){switch(e){case"headerandfooter":return t.headerAndFooter=new Map,nr.forEach(s,(e,s)=>{const i=new It;Er.fromJson(i,e),t.headerAndFooter.set(nr.parseEnum(s,ot),i)}),!0;case"colors":return t.colors=new Map,nr.forEach(s,(e,s)=>{t.colors.set(nr.parseEnum(s,ot),ke.fromJson(e))}),!0}return!1}}class Ar{static fromJson(t,e){e&&nr.forEach(e,(e,s)=>Ar.setProperty(t,s,e))}static toJson(t){if(!t)return null;const e=new Map;return e.set("album",t.album),e.set("artist",t.artist),e.set("copyright",t.copyright),e.set("instructions",t.instructions),e.set("music",t.music),e.set("notices",t.notices),e.set("subtitle",t.subTitle),e.set("title",t.title),e.set("words",t.words),e.set("tab",t.tab),e.set("masterbars",t.masterBars.map(t=>lr.toJson(t))),e.set("tracks",t.tracks.map(t=>Nr.toJson(t))),e.set("defaultsystemslayout",t.defaultSystemsLayout),e.set("systemslayout",t.systemsLayout),e.set("stylesheet",Pr.toJson(t.stylesheet)),t.backingTrack&&e.set("backingtrack",Cr.toJson(t.backingTrack)),t.style&&e.set("style",Fr.toJson(t.style)),e}static setProperty(t,e,s){switch(e){case"album":return t.album=s,!0;case"artist":return t.artist=s,!0;case"copyright":return t.copyright=s,!0;case"instructions":return t.instructions=s,!0;case"music":return t.music=s,!0;case"notices":return t.notices=s,!0;case"subtitle":return t.subTitle=s,!0;case"title":return t.title=s,!0;case"words":return t.words=s,!0;case"tab":return t.tab=s,!0;case"masterbars":t.masterBars=[];for(const e of s){const s=new tt;lr.fromJson(s,e),t.addMasterBar(s)}return!0;case"tracks":t.tracks=[];for(const e of s){const s=new Ne;Nr.fromJson(s,e),t.addTrack(s)}return!0;case"defaultsystemslayout":return t.defaultSystemsLayout=s,!0;case"systemslayout":return t.systemsLayout=s,!0;case"stylesheet":return Pr.fromJson(t.stylesheet,s),!0;case"backingtrack":return s?(t.backingTrack=new Xs,Cr.fromJson(t.backingTrack,s)):t.backingTrack=void 0,!0;case"style":return s?(t.style=new Gt,Fr.fromJson(t.style,s)):t.style=void 0,!0}return!1}}class Dr{static fromJson(t,e){e&&nr.forEach(e,(e,s)=>Dr.setProperty(t,s.toLowerCase(),e))}static toJson(t){if(!t)return null;const e=new Map;if(e.set("scriptfile",t.scriptFile),e.set("fontdirectory",t.fontDirectory),null!==t.smuflFontSources){const s=new Map;e.set("smuflfontsources",s);for(const[e,i]of t.smuflFontSources)s.set(e.toString(),i)}return e.set("file",t.file),e.set("tex",t.tex),e.set("tracks",t.tracks),e.set("enablelazyloading",t.enableLazyLoading),e.set("engine",t.engine),e.set("loglevel",t.logLevel),e.set("useworkers",t.useWorkers),e.set("includenotebounds",t.includeNoteBounds),e}static setProperty(t,e,s){switch(e){case"scriptfile":return t.scriptFile=s,!0;case"fontdirectory":return t.fontDirectory=s,!0;case"smuflfontsources":return t.smuflFontSources=new Map,nr.forEach(s,(e,s)=>{t.smuflFontSources.set(nr.parseEnum(s,Mh),e)}),!0;case"file":return t.file=s,!0;case"tex":return t.tex=s,!0;case"tracks":return t.tracks=s,!0;case"enablelazyloading":return t.enableLazyLoading=s,!0;case"engine":return t.engine=s,!0;case"loglevel":return t.logLevel=nr.parseEnum(s,_),!0;case"useworkers":return t.useWorkers=s,!0;case"includenotebounds":return t.includeNoteBounds=s,!0}return!1}}class Lr{static fromJson(t,e){e&&nr.forEach(e,(e,s)=>Lr.setProperty(t,s.toLowerCase(),e))}static toJson(t){if(!t)return null;const e=new Map;return e.set("topy",t.topY),e.set("bottomy",t.bottomY),e.set("x",t.x),e}static setProperty(t,e,s){switch(e){case"topy":return t.topY=s,!0;case"bottomy":return t.bottomY=s,!0;case"x":return t.x=s,!0}return!1}}class Wr{static clone(t){const e=new Rr;return e.musicFontSize=t.musicFontSize,e.oneStaffSpace=t.oneStaffSpace,e.tabLineSpacing=t.tabLineSpacing,e.arrowShaftThickness=t.arrowShaftThickness,e.barlineSeparation=t.barlineSeparation,e.beamSpacing=t.beamSpacing,e.beamThickness=t.beamThickness,e.bracketThickness=t.bracketThickness,e.dashedBarlineDashLength=t.dashedBarlineDashLength,e.dashedBarlineGapLength=t.dashedBarlineGapLength,e.dashedBarlineThickness=t.dashedBarlineThickness,e.hairpinThickness=t.hairpinThickness,e.legerLineThickness=t.legerLineThickness,e.legerLineExtension=t.legerLineExtension,e.octaveLineThickness=t.octaveLineThickness,e.pedalLineThickness=t.pedalLineThickness,e.repeatBarlineDotSeparation=t.repeatBarlineDotSeparation,e.repeatEndingLineThickness=t.repeatEndingLineThickness,e.slurMidpointThickness=t.slurMidpointThickness,e.staffLineThickness=t.staffLineThickness,e.stemThickness=t.stemThickness,e.thickBarlineThickness=t.thickBarlineThickness,e.thinBarlineThickness=t.thinBarlineThickness,e.thinThickBarlineSeparation=t.thinThickBarlineSeparation,e.tieMidpointThickness=t.tieMidpointThickness,e.tupletBracketThickness=t.tupletBracketThickness,e.stemUp=new Map(t.stemUp),e.stemDown=new Map(t.stemDown),e.repeatOffsetX=new Map(t.repeatOffsetX),e.standardStemLength=t.standardStemLength,e.stemFlagOffsets=new Map(t.stemFlagOffsets),e.glyphTop=new Map(t.glyphTop),e.glyphBottom=new Map(t.glyphBottom),e.glyphWidths=new Map(t.glyphWidths),e.glyphHeights=new Map(t.glyphHeights),e.numberedBarRendererBarSize=t.numberedBarRendererBarSize,e.numberedBarRendererBarSpacing=t.numberedBarRendererBarSpacing,e.numberedDashGlyphPadding=t.numberedDashGlyphPadding,e.numberedDashGlyphWidth=t.numberedDashGlyphWidth,e.lineRangedGlyphDashGap=t.lineRangedGlyphDashGap,e.lineRangedGlyphDashSize=t.lineRangedGlyphDashSize,e.preNoteEffectPadding=t.preNoteEffectPadding,e.postNoteEffectPadding=t.postNoteEffectPadding,e.onNoteEffectPadding=t.onNoteEffectPadding,e.stringNumberCirclePadding=t.stringNumberCirclePadding,e.rowContainerPadding=t.rowContainerPadding,e.rowContainerGap=t.rowContainerGap,e.alternateEndingsPadding=t.alternateEndingsPadding,e.sustainPedalLinePadding=t.sustainPedalLinePadding,e.tieHeight=t.tieHeight,e.beatTimerPadding=t.beatTimerPadding,e.bendNoteHeadElementPadding=t.bendNoteHeadElementPadding,e.ghostParenthesisWidth=t.ghostParenthesisWidth,e.ghostParenthesisPadding=t.ghostParenthesisPadding,e.brokenBeamWidth=t.brokenBeamWidth,e.tabWhammyTextPadding=t.tabWhammyTextPadding,e.tabWhammyPerHalfHeight=t.tabWhammyPerHalfHeight,e.tabWhammyDashSize=t.tabWhammyDashSize,e.songBookWhammyDipHeight=t.songBookWhammyDipHeight,e.deadSlappedLineWidth=t.deadSlappedLineWidth,e.leftHandTabTieWidth=t.leftHandTabTieWidth,e.tabBendDashSize=t.tabBendDashSize,e.tabBendStaffPadding=t.tabBendStaffPadding,e.tabBendPerValueHeight=t.tabBendPerValueHeight,e.tabBendLabelPadding=t.tabBendLabelPadding,e.simpleSlideWidth=t.simpleSlideWidth,e.simpleSlideHeight=t.simpleSlideHeight,e.chordDiagramPaddingX=t.chordDiagramPaddingX,e.chordDiagramPaddingY=t.chordDiagramPaddingY,e.chordDiagramStringSpacing=t.chordDiagramStringSpacing,e.chordDiagramFretSpacing=t.chordDiagramFretSpacing,e.chordDiagramNutHeight=t.chordDiagramNutHeight,e.chordDiagramFretHeight=t.chordDiagramFretHeight,e.chordDiagramLineWidth=t.chordDiagramLineWidth,e.tripletFeelBracketPadding=t.tripletFeelBracketPadding,e.accidentalPadding=t.accidentalPadding,e.preBeatGlyphSpacing=t.preBeatGlyphSpacing,e.tempoNoteScale=t.tempoNoteScale,e.tuningGlyphCircleNumberScale=t.tuningGlyphCircleNumberScale,e.tuningGlyphStringColumnScale=t.tuningGlyphStringColumnScale,e.tuningGlyphStringRowPadding=t.tuningGlyphStringRowPadding,e.directionsScale=t.directionsScale,e.multiVoiceDisplacedNoteHeadSpacing=t.multiVoiceDisplacedNoteHeadSpacing,e.stemFlagHeight=new Map(t.stemFlagHeight),e}}class Or{topY=0;bottomY=0;x=0}class Rr{static sp;static GraceScale=.75;static get bravuraDefaults(){let t=Rr.sp;return t||(t=new Rr,t.fillFromSmufl(Rr.bravuraMetadata),Rr.sp=t),Wr.clone(t)}musicFontSize=0;oneStaffSpace=0;tabLineSpacing=0;arrowShaftThickness=0;barlineSeparation=0;beamSpacing=0;beamThickness=0;bracketThickness=0;dashedBarlineDashLength=0;dashedBarlineGapLength=0;dashedBarlineThickness=0;hairpinThickness=0;legerLineThickness=0;legerLineExtension=0;octaveLineThickness=0;pedalLineThickness=0;repeatBarlineDotSeparation=0;repeatEndingLineThickness=0;slurMidpointThickness=0;staffLineThickness=0;stemThickness=0;thickBarlineThickness=0;thinBarlineThickness=0;thinThickBarlineSeparation=0;tieMidpointThickness=0;tupletBracketThickness=0;stemUp=new Map;stemDown=new Map;repeatOffsetX=new Map;standardStemLength=0;stemFlagOffsets=new Map;glyphTop=new Map;glyphBottom=new Map;glyphWidths=new Map;glyphHeights=new Map;hasSymbol(t){return this.glyphWidths.get(t)>0&&this.glyphHeights.get(t)>0}fillFromSmufl(t,e=36){this.musicFontSize=e,this.oneStaffSpace=e/4,this.tabLineSpacing=Math.floor(1.5*this.oneStaffSpace),this.arrowShaftThickness=t.engravingDefaults.arrowShaftThickness*this.oneStaffSpace,this.barlineSeparation=t.engravingDefaults.barlineSeparation*this.oneStaffSpace,this.beamSpacing=t.engravingDefaults.beamSpacing*this.oneStaffSpace,this.beamThickness=t.engravingDefaults.beamThickness*this.oneStaffSpace,this.bracketThickness=t.engravingDefaults.bracketThickness*this.oneStaffSpace,this.dashedBarlineDashLength=t.engravingDefaults.dashedBarlineDashLength*this.oneStaffSpace,this.dashedBarlineGapLength=t.engravingDefaults.dashedBarlineGapLength*this.oneStaffSpace,this.dashedBarlineThickness=t.engravingDefaults.dashedBarlineThickness*this.oneStaffSpace,this.hairpinThickness=t.engravingDefaults.hairpinThickness*this.oneStaffSpace,this.legerLineExtension=t.engravingDefaults.legerLineExtension*this.oneStaffSpace,this.legerLineThickness=t.engravingDefaults.legerLineThickness*this.oneStaffSpace,this.octaveLineThickness=t.engravingDefaults.octaveLineThickness*this.oneStaffSpace,this.pedalLineThickness=t.engravingDefaults.pedalLineThickness*this.oneStaffSpace,this.repeatBarlineDotSeparation=t.engravingDefaults.repeatBarlineDotSeparation*this.oneStaffSpace,this.repeatEndingLineThickness=t.engravingDefaults.repeatEndingLineThickness*this.oneStaffSpace,this.slurMidpointThickness=t.engravingDefaults.slurMidpointThickness*this.oneStaffSpace,this.staffLineThickness=t.engravingDefaults.staffLineThickness*this.oneStaffSpace,this.stemThickness=t.engravingDefaults.stemThickness*this.oneStaffSpace,this.thickBarlineThickness=t.engravingDefaults.thickBarlineThickness*this.oneStaffSpace,this.thinBarlineThickness=t.engravingDefaults.thinBarlineThickness*this.oneStaffSpace,"number"==typeof t.engravingDefaults.thinThickBarlineSeparation?this.thinThickBarlineSeparation=t.engravingDefaults.thinThickBarlineSeparation*this.oneStaffSpace:this.thinThickBarlineSeparation=t.engravingDefaults.barlineSeparation*this.oneStaffSpace,this.tieMidpointThickness=t.engravingDefaults.tieMidpointThickness*this.oneStaffSpace,this.tupletBracketThickness=t.engravingDefaults.tupletBracketThickness*this.oneStaffSpace;const s=3*this.oneStaffSpace;this.standardStemLength=s,this.stemFlagOffsets.set(c.QuadrupleWhole,0),this.stemFlagOffsets.set(c.DoubleWhole,0),this.stemFlagOffsets.set(c.Whole,0),this.stemFlagOffsets.set(c.Half,0),this.stemFlagOffsets.set(c.Quarter,0),this.stemFlagOffsets.set(c.Eighth,0),this.stemFlagOffsets.set(c.Sixteenth,0),this.stemFlagOffsets.set(c.ThirtySecond,0),this.stemFlagOffsets.set(c.SixtyFourth,0),this.stemFlagOffsets.set(c.OneHundredTwentyEighth,0),this.stemFlagOffsets.set(c.TwoHundredFiftySixth,0),this.stemFlagHeight.set(c.QuadrupleWhole,0),this.stemFlagHeight.set(c.DoubleWhole,0),this.stemFlagHeight.set(c.Whole,0),this.stemFlagHeight.set(c.Half,0),this.stemFlagHeight.set(c.Quarter,0),this.stemFlagHeight.set(c.Eighth,1*this.oneStaffSpace),this.stemFlagHeight.set(c.Sixteenth,1.5*this.oneStaffSpace),this.stemFlagHeight.set(c.ThirtySecond,2*this.oneStaffSpace),this.stemFlagHeight.set(c.SixtyFourth,3*this.oneStaffSpace),this.stemFlagHeight.set(c.OneHundredTwentyEighth,3.5*this.oneStaffSpace),this.stemFlagHeight.set(c.TwoHundredFiftySixth,4.2*this.oneStaffSpace);for(const[e,s]of Object.entries(t.glyphsWithAnchors)){const t=Rr.ip(e);if(t){if(s.stemDownNW){const e=new Or;e.x=s.stemDownNW[0]*this.oneStaffSpace,e.topY=s.stemDownNW[1]*this.oneStaffSpace,s.stemDownSW?e.bottomY=s.stemDownSW[1]*this.oneStaffSpace:e.bottomY=0,this.stemDown.set(t,e)}if(s.stemUpSE){const e=new Or,i=s.stemUpSE[0]*this.oneStaffSpace;e.bottomY=s.stemUpSE[1]*this.oneStaffSpace,s.stemUpNW?(e.x=s.stemUpNW[0]*this.oneStaffSpace,e.topY=s.stemUpNW[1]*this.oneStaffSpace):(e.x=i-this.stemThickness,e.topY=0),this.stemUp.set(t,e)}if(s.repeatOffset&&this.repeatOffsetX.set(t,s.repeatOffset[0]*this.oneStaffSpace),s.stemUpNW){const e=s.stemUpNW[1]*this.oneStaffSpace;switch(t){case lt.Flag8thUp:this.stemFlagOffsets.set(c.Eighth,e);break;case lt.Flag16thUp:this.stemFlagOffsets.set(c.Sixteenth,e);break;case lt.Flag32ndUp:this.stemFlagOffsets.set(c.ThirtySecond,e);break;case lt.Flag64thUp:this.stemFlagOffsets.set(c.SixtyFourth,e);break;case lt.Flag128thUp:this.stemFlagOffsets.set(c.OneHundredTwentyEighth,e);break;case lt.Flag256thUp:this.stemFlagOffsets.set(c.TwoHundredFiftySixth,e)}}}}const i=new Set,n=t.glyphBBoxes;if(n)for(const[t,e]of Object.entries(n)){const s=Rr.ip(t);s&&(i.add(s),this.glyphTop.set(s,e.bBoxNE[1]*this.oneStaffSpace),this.glyphBottom.set(s,e.bBoxSW[1]*this.oneStaffSpace),this.glyphWidths.set(s,(e.bBoxNE[0]-e.bBoxSW[0])*this.oneStaffSpace),this.glyphHeights.set(s,(e.bBoxNE[1]-e.bBoxSW[1])*this.oneStaffSpace))}const r=new Set([lt.None,lt.Space,lt.NoteheadNull]);for(const t of Xt.getAllMusicFontSymbols())i.has(t)||(r.has(t)||J.warning("SmuFL",`The provided SmuFL font is missing the glyph ${lt[t]} needed by alphaTab, the music notation might not show all details`),this.glyphTop.set(t,0),this.glyphBottom.set(t,0),this.glyphWidths.set(t,0),this.glyphHeights.set(t,0));this.numberedBarRendererBarSize=2*this.staffLineThickness,this.numberedBarRendererBarSpacing=this.beamSpacing,this.preNoteEffectPadding=.4*this.oneStaffSpace,this.postNoteEffectPadding=.2*this.oneStaffSpace,this.lineRangedGlyphDashGap=.5*this.oneStaffSpace,this.lineRangedGlyphDashSize=1*this.oneStaffSpace,this.numberedDashGlyphPadding=.3*this.oneStaffSpace,this.numberedDashGlyphPadding=.3*this.oneStaffSpace,this.stringNumberCirclePadding=.3*this.oneStaffSpace,this.rowContainerPadding=Math.ceil(.3*this.oneStaffSpace),this.rowContainerGap=Math.ceil(1*this.oneStaffSpace),this.onNoteEffectPadding=.2*this.oneStaffSpace,this.alternateEndingsPadding=.3*this.oneStaffSpace,this.sustainPedalLinePadding=.5*this.oneStaffSpace,this.tieHeight=1.2*this.oneStaffSpace,this.beatTimerPadding=.22*this.oneStaffSpace,this.bendNoteHeadElementPadding=.22*this.oneStaffSpace,this.ghostParenthesisWidth=.6*this.oneStaffSpace,this.ghostParenthesisPadding=.3*this.oneStaffSpace,this.brokenBeamWidth=1*this.oneStaffSpace,this.tabWhammyTextPadding=.4*this.oneStaffSpace,this.tabWhammyDashSize=.4*this.oneStaffSpace,this.tabBendDashSize=.4*this.oneStaffSpace,this.songBookWhammyDipHeight=.6*this.oneStaffSpace,this.tabWhammyPerHalfHeight=.6*this.oneStaffSpace,this.tabBendStaffPadding=.5*this.oneStaffSpace,this.tabBendPerValueHeight=.6*this.oneStaffSpace,this.tabBendLabelPadding=.3*this.oneStaffSpace,this.leftHandTabTieWidth=2.2*this.oneStaffSpace,this.numberedDashGlyphWidth=1.5*this.oneStaffSpace,this.deadSlappedLineWidth=.25*this.oneStaffSpace,this.simpleSlideWidth=1.3*this.oneStaffSpace,this.simpleSlideHeight=.3*this.oneStaffSpace,this.chordDiagramPaddingX=Math.ceil(.5*this.oneStaffSpace),this.chordDiagramPaddingY=Math.ceil(.2*this.oneStaffSpace),this.chordDiagramStringSpacing=Math.ceil(1.1*this.oneStaffSpace),this.chordDiagramFretSpacing=Math.ceil(1.3*this.oneStaffSpace),this.chordDiagramNutHeight=Math.ceil(.33*this.oneStaffSpace),this.chordDiagramFretHeight=Math.ceil(.1*this.oneStaffSpace),this.chordDiagramLineWidth=Math.ceil(.11*this.oneStaffSpace),this.tripletFeelBracketPadding=.2*this.oneStaffSpace,this.accidentalPadding=.1*this.oneStaffSpace,this.preBeatGlyphSpacing=.5*this.oneStaffSpace,this.multiVoiceDisplacedNoteHeadSpacing=.2*this.oneStaffSpace,this.tuningGlyphStringRowPadding=.2*this.oneStaffSpace}static smuflNameToGlyphNameMapping=new Map([["4stringTabClef","FourStringTabClef"],["6stringTabClef","SixStringTabClef"]]);static ip(t){const e=Rr.smuflNameToGlyphNameMapping.has(t)?Rr.smuflNameToGlyphNameMapping.get(t):t.substring(0,1).toUpperCase()+t.substring(1);return nr.parseEnumExact(e,lt)}numberedBarRendererBarSize=0;numberedBarRendererBarSpacing=0;numberedDashGlyphPadding=0;numberedDashGlyphWidth=0;lineRangedGlyphDashGap=0;lineRangedGlyphDashSize=0;preNoteEffectPadding=0;postNoteEffectPadding=0;onNoteEffectPadding=0;stringNumberCirclePadding=0;rowContainerPadding=0;rowContainerGap=0;alternateEndingsPadding=0;sustainPedalLinePadding=0;tieHeight=0;beatTimerPadding=0;bendNoteHeadElementPadding=0;ghostParenthesisWidth=0;ghostParenthesisPadding=0;brokenBeamWidth=0;tabWhammyTextPadding=0;tabWhammyPerHalfHeight=0;tabWhammyDashSize=0;songBookWhammyDipHeight=0;deadSlappedLineWidth=0;leftHandTabTieWidth=0;tabBendDashSize=0;tabBendStaffPadding=0;tabBendPerValueHeight=0;tabBendLabelPadding=0;simpleSlideWidth=0;simpleSlideHeight=0;chordDiagramPaddingX=0;chordDiagramPaddingY=0;chordDiagramStringSpacing=0;chordDiagramFretSpacing=0;chordDiagramNutHeight=0;chordDiagramFretHeight=0;chordDiagramLineWidth=0;tripletFeelBracketPadding=0;accidentalPadding=0;preBeatGlyphSpacing=0;tempoNoteScale=.7;tuningGlyphCircleNumberScale=.7;tuningGlyphStringColumnScale=1.5;tuningGlyphStringRowPadding=0;directionsScale=.6;multiVoiceDisplacedNoteHeadSpacing=0;getStemLength(t,e){return this.standardStemLength+(e?this.stemFlagOffsets.get(t):0)}stemFlagHeight=new Map;static bravuraMetadata={engravingDefaults:{arrowShaftThickness:.16,barlineSeparation:.4,beamSpacing:.25,beamThickness:.5,bracketThickness:.5,dashedBarlineDashLength:.5,dashedBarlineGapLength:.25,dashedBarlineThickness:.16,hairpinThickness:.16,legerLineExtension:.4,legerLineThickness:.16,lyricLineThickness:.16,octaveLineThickness:.16,pedalLineThickness:.16,repeatBarlineDotSeparation:.16,repeatEndingLineThickness:.16,slurEndpointThickness:.1,slurMidpointThickness:.22,staffLineThickness:.13,stemThickness:.12,subBracketThickness:.16,textEnclosureThickness:.16,thickBarlineThickness:.5,thinBarlineThickness:.16,tieEndpointThickness:.1,tieMidpointThickness:.22,thinThickBarlineSeparation:.4,tupletBracketThickness:.16},glyphBBoxes:{FourStringTabClef:{bBoxNE:[1.088,2.016],bBoxSW:[-.012,-2.032]},SixStringTabClef:{bBoxNE:[1.632,3.056],bBoxSW:[-.012,-2.992]},accidentalDoubleFlat:{bBoxNE:[1.644,1.748],bBoxSW:[0,-.7]},accidentalDoubleSharp:{bBoxNE:[.988,.508],bBoxSW:[0,-.5]},accidentalFlat:{bBoxNE:[.904,1.756],bBoxSW:[0,-.7]},accidentalNatural:{bBoxNE:[.672,1.364],bBoxSW:[0,-1.34]},accidentalQuarterToneFlatArrowUp:{bBoxNE:[.992,2.316],bBoxSW:[-.168,-.708]},accidentalQuarterToneSharpNaturalArrowUp:{bBoxNE:[.848,2.188],bBoxSW:[-.104,-1.36]},accidentalSharp:{bBoxNE:[.996,1.4],bBoxSW:[0,-1.392]},accidentalThreeQuarterTonesSharpArrowUp:{bBoxNE:[1.1,2.12],bBoxSW:[0,-1.388]},arrowheadBlackDown:{bBoxNE:[.912,1.196],bBoxSW:[0,0]},arrowheadBlackUp:{bBoxNE:[.912,1.196],bBoxSW:[0,0]},articAccentAbove:{bBoxNE:[1.356,.98],bBoxSW:[0,.004]},articAccentBelow:{bBoxNE:[1.356,0],bBoxSW:[0,-.976]},articMarcatoAbove:{bBoxNE:[.94,1.012],bBoxSW:[-.004,-.004]},articMarcatoBelow:{bBoxNE:[.94,0],bBoxSW:[-.004,-1.016]},articStaccatoAbove:{bBoxNE:[.336,.336],bBoxSW:[0,0]},articStaccatoBelow:{bBoxNE:[.336,0],bBoxSW:[0,-.336]},articTenutoAbove:{bBoxNE:[1.352,.192],bBoxSW:[-.004,0]},articTenutoBelow:{bBoxNE:[1.352,0],bBoxSW:[-.004,-.192]},augmentationDot:{bBoxNE:[.4,.2],bBoxSW:[0,-.2]},brace:{bBoxNE:[.328,3.988],bBoxSW:[.008,0]},bracketBottom:{bBoxNE:[1.876,0],bBoxSW:[0,-1.18]},bracketTop:{bBoxNE:[1.876,1.18],bBoxSW:[0,0]},buzzRoll:{bBoxNE:[.624,.464],bBoxSW:[-.62,-.464]},cClef:{bBoxNE:[2.796,2.024],bBoxSW:[0,-2.024]},cClef8vb:{bBoxNE:[2.796,2.024],bBoxSW:[0,-2.964]},clef15:{bBoxNE:[1.436,1.02],bBoxSW:[0,-.012]},clef8:{bBoxNE:[.82,.988],bBoxSW:[0,0]},coda:{bBoxNE:[3.82,3.592],bBoxSW:[-.016,-.632]},dynamicCrescendoHairpin:{bBoxNE:[2.944,1.424],bBoxSW:[.016,.372]},dynamicFF:{bBoxNE:[2.44,1.776],bBoxSW:[-.54,-.608]},dynamicFFF:{bBoxNE:[3.32,1.776],bBoxSW:[-.62,-.608]},dynamicFFFF:{bBoxNE:[4.28,1.776],bBoxSW:[-.62,-.608]},dynamicFFFFF:{bBoxNE:[5.24,1.776],bBoxSW:[-.62,-.608]},dynamicFFFFFF:{bBoxNE:[6.2,1.776],bBoxSW:[-.62,-.608]},dynamicForte:{bBoxNE:[1.456,1.776],bBoxSW:[-.564,-.608]},dynamicFortePiano:{bBoxNE:[2.476,1.776],bBoxSW:[-.564,-.608]},dynamicForzando:{bBoxNE:[1.988,1.776],bBoxSW:[-.564,-.608]},dynamicMF:{bBoxNE:[3.272,1.724],bBoxSW:[-.08,-.66]},dynamicMP:{bBoxNE:[3.3,1.096],bBoxSW:[-.08,-.568]},dynamicNiente:{bBoxNE:[1.232,1.096],bBoxSW:[-.092,-.04]},dynamicPF:{bBoxNE:[3.08,1.776],bBoxSW:[-.288,-.608]},dynamicPP:{bBoxNE:[2.912,1.096],bBoxSW:[-.328,-.568]},dynamicPPP:{bBoxNE:[4.292,1.096],bBoxSW:[-.368,-.568]},dynamicPPPP:{bBoxNE:[5.672,1.096],bBoxSW:[-.408,-.568]},dynamicPPPPP:{bBoxNE:[7.092,1.096],bBoxSW:[-.408,-.568]},dynamicPPPPPP:{bBoxNE:[8.512,1.096],bBoxSW:[-.408,-.568]},dynamicPiano:{bBoxNE:[1.464,1.096],bBoxSW:[-.356,-.568]},dynamicRinforzando1:{bBoxNE:[2.5,1.776],bBoxSW:[-.08,-.608]},dynamicRinforzando2:{bBoxNE:[2.976,1.776],bBoxSW:[-.08,-.608]},dynamicSforzando1:{bBoxNE:[2.416,1.776],bBoxSW:[0,-.608]},dynamicSforzandoPianissimo:{bBoxNE:[4.796,1.776],bBoxSW:[0,-.608]},dynamicSforzandoPiano:{bBoxNE:[3.38,1.776],bBoxSW:[0,-.608]},dynamicSforzato:{bBoxNE:[2.932,1.776],bBoxSW:[0,-.608]},dynamicSforzatoFF:{bBoxNE:[3.856,1.776],bBoxSW:[0,-.608]},dynamicSforzatoPiano:{bBoxNE:[4.304,1.776],bBoxSW:[0,-.608]},fClef:{bBoxNE:[2.736,1.048],bBoxSW:[-.02,-2.54]},fClef15ma:{bBoxNE:[2.736,1.984],bBoxSW:[-.02,-2.54]},fClef15mb:{bBoxNE:[2.736,1.048],bBoxSW:[-.02,-2.968]},fClef8va:{bBoxNE:[2.736,1.98],bBoxSW:[-.02,-2.54]},fClef8vb:{bBoxNE:[2.736,1.048],bBoxSW:[-.02,-2.976]},fermataAbove:{bBoxNE:[2.42,1.316],bBoxSW:[.012,-.012]},fermataLongAbove:{bBoxNE:[2.412,1.332],bBoxSW:[0,-.004]},fermataShortAbove:{bBoxNE:[2.416,1.364],bBoxSW:[0,0]},fingering0:{bBoxNE:[.94,1.004],bBoxSW:[.08,-.004]},fingering1:{bBoxNE:[.548,1.016],bBoxSW:[.08,0]},fingering2:{bBoxNE:[.888,1.012],bBoxSW:[.08,-.012]},fingering3:{bBoxNE:[.82,1.008],bBoxSW:[.08,0]},fingering4:{bBoxNE:[.864,1.012],bBoxSW:[.08,.004]},fingering5:{bBoxNE:[.82,1.032],bBoxSW:[.08,0]},fingeringALower:{bBoxNE:[1.068,1.032],bBoxSW:[0,-.02]},fingeringCLower:{bBoxNE:[.888,1.044],bBoxSW:[0,-.028]},fingeringILower:{bBoxNE:[.656,1.54],bBoxSW:[-.052,-.028]},fingeringMLower:{bBoxNE:[1.66,1.028],bBoxSW:[-.032,-.016]},fingeringPLower:{bBoxNE:[1.088,1.028],bBoxSW:[-.216,-.612]},fingeringTLower:{bBoxNE:[.604,1.484],bBoxSW:[0,-.028]},flag128thDown:{bBoxNE:[1.092,3.248],bBoxSW:[0,-2.32]},flag128thUp:{bBoxNE:[1.044,2.132],bBoxSW:[0,-3.248]},flag16thDown:{bBoxNE:[1.1635806326044895,3.2480256],bBoxSW:[0,-.036]},flag16thUp:{bBoxNE:[1.116,.008],bBoxSW:[0,-3.252]},flag256thDown:{bBoxNE:[1.196,3.252],bBoxSW:[0,-3.004]},flag256thUp:{bBoxNE:[1.056,2.816],bBoxSW:[0,-3.248]},flag32ndDown:{bBoxNE:[1.092,3.248],bBoxSW:[0,-.688]},flag32ndUp:{bBoxNE:[1.044,.596],bBoxSW:[0,-3.248]},flag64thDown:{bBoxNE:[1.092,3.248],bBoxSW:[0,-1.504]},flag64thUp:{bBoxNE:[1.044,1.388],bBoxSW:[0,-3.248]},flag8thDown:{bBoxNE:[1.224,3.232896633157715],bBoxSW:[0,-.056]},flag8thUp:{bBoxNE:[1.056,.036],bBoxSW:[0,-3.240768470618394]},fretboardFilledCircle:{bBoxNE:[.564,.564],bBoxSW:[0,0]},fretboardO:{bBoxNE:[.564,.564],bBoxSW:[0,0]},fretboardX:{bBoxNE:[.596,.596],bBoxSW:[0,0]},gClef:{bBoxNE:[2.684,4.392],bBoxSW:[0,-2.632]},gClef15ma:{bBoxNE:[2.684,5.276],bBoxSW:[0,-2.632]},gClef15mb:{bBoxNE:[2.684,4.392],bBoxSW:[0,-3.524]},gClef8va:{bBoxNE:[2.684,5.28],bBoxSW:[0,-2.632]},gClef8vb:{bBoxNE:[2.684,4.392],bBoxSW:[0,-3.512]},graceNoteSlashStemDown:{bBoxNE:[2.02,0],bBoxSW:[0,-1.604]},graceNoteSlashStemUp:{bBoxNE:[2.02,1.604],bBoxSW:[0,0]},guitarClosePedal:{bBoxNE:[1.144,1.14],bBoxSW:[0,-.004]},guitarFadeIn:{bBoxNE:[1.448,1.46],bBoxSW:[0,0]},guitarFadeOut:{bBoxNE:[1.448,1.46],bBoxSW:[0,0]},guitarGolpe:{bBoxNE:[1.08,1.128],bBoxSW:[.004,0]},guitarLeftHandTapping:{bBoxNE:[1.588,1.364],bBoxSW:[0,-.224]},guitarOpenPedal:{bBoxNE:[1.144,1.144],bBoxSW:[0,0]},guitarString0:{bBoxNE:[2.164,2.156],bBoxSW:[.004,0]},guitarString1:{bBoxNE:[2.16,2.156],bBoxSW:[0,0]},guitarString2:{bBoxNE:[2.16,2.156],bBoxSW:[0,0]},guitarString3:{bBoxNE:[2.16,2.156],bBoxSW:[0,0]},guitarString4:{bBoxNE:[2.164,2.156],bBoxSW:[.004,0]},guitarString5:{bBoxNE:[2.16,2.156],bBoxSW:[0,0]},guitarString6:{bBoxNE:[2.16,2.156],bBoxSW:[0,0]},guitarString7:{bBoxNE:[2.16,2.156],bBoxSW:[0,0]},guitarString8:{bBoxNE:[2.16,2.156],bBoxSW:[0,0]},guitarString9:{bBoxNE:[2.16,2.156],bBoxSW:[0,0]},guitarVibratoStroke:{bBoxNE:[.668,.476],bBoxSW:[-.056,0]},guitarVolumeSwell:{bBoxNE:[2.896,1.46],bBoxSW:[0,0]},guitarWideVibratoStroke:{bBoxNE:[.908,.896],bBoxSW:[-.096,0]},keyboardPedalPed:{bBoxNE:[4.076,2.22],bBoxSW:[0,-.032]},keyboardPedalUp:{bBoxNE:[1.8,1.8],bBoxSW:[0,0]},metAugmentationDot:{bBoxNE:[.4,.2],bBoxSW:[0,-.2]},metNote8thUp:{bBoxNE:[2.132,2.784],bBoxSW:[0,-.564]},metNoteQuarterUp:{bBoxNE:[1.328,2.752],bBoxSW:[0,-.564]},note8thUp:{bBoxNE:[2.264,3.492],bBoxSW:[0,-.552]},noteQuarterUp:{bBoxNE:[1.328,3.5],bBoxSW:[0,-.564]},noteShapeDiamondBlack:{bBoxNE:[1.444,.548],bBoxSW:[0,-.552]},noteShapeDiamondWhite:{bBoxNE:[1.444,.544],bBoxSW:[0,-.556]},noteShapeMoonBlack:{bBoxNE:[1.444,.5],bBoxSW:[0,-.5]},noteShapeMoonWhite:{bBoxNE:[1.444,.5],bBoxSW:[0,-.5]},noteShapeRoundBlack:{bBoxNE:[1.456,.552],bBoxSW:[0,-.552]},noteShapeRoundWhite:{bBoxNE:[1.464,.548],bBoxSW:[0,-.548]},noteShapeSquareBlack:{bBoxNE:[1.44,.46],bBoxSW:[0,-.46]},noteShapeSquareWhite:{bBoxNE:[1.44,.46],bBoxSW:[0,-.46]},noteShapeTriangleLeftBlack:{bBoxNE:[1.44,.5],bBoxSW:[0,-.5]},noteShapeTriangleLeftWhite:{bBoxNE:[1.44,.5],bBoxSW:[0,-.5]},noteShapeTriangleRightBlack:{bBoxNE:[1.44,.5],bBoxSW:[0,-.5]},noteShapeTriangleRightWhite:{bBoxNE:[1.44,.5],bBoxSW:[0,-.5]},noteShapeTriangleRoundBlack:{bBoxNE:[1.424,.5],bBoxSW:[0,-.5]},noteShapeTriangleRoundWhite:{bBoxNE:[1.424,.5],bBoxSW:[0,-.5]},noteShapeTriangleUpBlack:{bBoxNE:[1.424,.5],bBoxSW:[0,-.5]},noteShapeTriangleUpWhite:{bBoxNE:[1.424,.5],bBoxSW:[0,-.5]},noteheadBlack:{bBoxNE:[1.18,.5],bBoxSW:[0,-.5]},noteheadCircleSlash:{bBoxNE:[1,.5],bBoxSW:[0,-.5]},noteheadCircleX:{bBoxNE:[.996,.5],bBoxSW:[0,-.5]},noteheadCircleXDoubleWhole:{bBoxNE:[1.688,.62],bBoxSW:[0,-.62]},noteheadCircleXHalf:{bBoxNE:[1,.5],bBoxSW:[0,-.5]},noteheadCircleXWhole:{bBoxNE:[.996,.5],bBoxSW:[0,-.5]},noteheadCircledBlack:{bBoxNE:[1.284,.668],bBoxSW:[-.084,-.684]},noteheadCircledDoubleWhole:{bBoxNE:[2.412,.852],bBoxSW:[0,-.872]},noteheadCircledHalf:{bBoxNE:[1.244,.668],bBoxSW:[-.072,-.648]},noteheadCircledWhole:{bBoxNE:[1.748,.844],bBoxSW:[0,-.9]},noteheadClusterDoubleWhole3rd:{bBoxNE:[2.428,1.62],bBoxSW:[0,-.62]},noteheadClusterHalf3rd:{bBoxNE:[1.264,1.5],bBoxSW:[0,-.5]},noteheadClusterQuarter3rd:{bBoxNE:[1.44,1.5],bBoxSW:[0,-.5]},noteheadClusterWhole3rd:{bBoxNE:[1.7,1.5],bBoxSW:[0,-.5]},noteheadDiamondBlack:{bBoxNE:[1,.5],bBoxSW:[0,-.5]},noteheadDiamondBlackWide:{bBoxNE:[1.4,.5],bBoxSW:[0,-.5]},noteheadDiamondDoubleWhole:{bBoxNE:[1.728,.62],bBoxSW:[0,-.62]},noteheadDiamondHalf:{bBoxNE:[1.004,.5],bBoxSW:[0,-.5]},noteheadDiamondWhite:{bBoxNE:[1,.5],bBoxSW:[0,-.5]},noteheadDiamondWhiteWide:{bBoxNE:[1.4,.5],bBoxSW:[0,-.5]},noteheadDiamondWhole:{bBoxNE:[1.08,.5],bBoxSW:[0,-.5]},noteheadDoubleWhole:{bBoxNE:[2.396,.62],bBoxSW:[0,-.62]},noteheadDoubleWholeSquare:{bBoxNE:[1.664,.792],bBoxSW:[0,-.76]},noteheadHalf:{bBoxNE:[1.18,.5],bBoxSW:[0,-.5]},noteheadHeavyX:{bBoxNE:[1.54,.5],bBoxSW:[0,-.5]},noteheadHeavyXHat:{bBoxNE:[1.828,1.04],bBoxSW:[-.292,-.5]},noteheadParenthesis:{bBoxNE:[1.472,.728],bBoxSW:[-.292,-.72]},noteheadPlusBlack:{bBoxNE:[.996,.5],bBoxSW:[-.004,-.5]},noteheadPlusDoubleWhole:{bBoxNE:[1.892,.62],bBoxSW:[0,-.62]},noteheadPlusHalf:{bBoxNE:[1.044,.5],bBoxSW:[0,-.5]},noteheadPlusWhole:{bBoxNE:[1.14,.5],bBoxSW:[0,-.5]},noteheadRoundWhiteWithDot:{bBoxNE:[1.004,.5],bBoxSW:[0,-.5]},noteheadSlashHorizontalEnds:{bBoxNE:[2.12,1],bBoxSW:[0,-1]},noteheadSlashWhiteHalf:{bBoxNE:[3.12,1],bBoxSW:[0,-1]},noteheadSlashWhiteWhole:{bBoxNE:[3.92,1],bBoxSW:[0,-1]},noteheadSlashedBlack1:{bBoxNE:[1.5,.668],bBoxSW:[-.32,-.66]},noteheadSlashedBlack2:{bBoxNE:[1.504,.672],bBoxSW:[-.316,-.656]},noteheadSlashedDoubleWhole1:{bBoxNE:[2.384,.672],bBoxSW:[0,-.716]},noteheadSlashedDoubleWhole2:{bBoxNE:[2.384,.676],bBoxSW:[0,-.712]},noteheadSlashedHalf1:{bBoxNE:[1.544,.64],bBoxSW:[-.268,-.568]},noteheadSlashedHalf2:{bBoxNE:[1.52,.672],bBoxSW:[-.292,-.536]},noteheadSlashedWhole1:{bBoxNE:[1.732,.592],bBoxSW:[-.088,-.628]},noteheadSlashedWhole2:{bBoxNE:[1.744,.604],bBoxSW:[-.072,-.616]},noteheadSquareBlack:{bBoxNE:[1.252,.5],bBoxSW:[0,-.5]},noteheadSquareBlackLarge:{bBoxNE:[2,1],bBoxSW:[0,-1]},noteheadSquareBlackWhite:{bBoxNE:[2,1],bBoxSW:[0,-1]},noteheadSquareWhite:{bBoxNE:[1.252,.5],bBoxSW:[0,-.5]},noteheadTriangleDownBlack:{bBoxNE:[1.168,.5],bBoxSW:[0,-.5]},noteheadTriangleDownDoubleWhole:{bBoxNE:[1.932,.62],bBoxSW:[0,-.62]},noteheadTriangleDownHalf:{bBoxNE:[1.14,.5],bBoxSW:[0,-.5]},noteheadTriangleDownWhole:{bBoxNE:[1.276,.5],bBoxSW:[0,-.5]},noteheadTriangleRightBlack:{bBoxNE:[1.356,.5],bBoxSW:[0,-.5]},noteheadTriangleRightWhite:{bBoxNE:[1.356,.5],bBoxSW:[0,-.5]},noteheadTriangleUpBlack:{bBoxNE:[1.172,.5],bBoxSW:[0,-.5]},noteheadTriangleUpDoubleWhole:{bBoxNE:[1.932,.62],bBoxSW:[0,-.62]},noteheadTriangleUpHalf:{bBoxNE:[1.14,.5],bBoxSW:[0,-.5]},noteheadTriangleUpWhole:{bBoxNE:[1.276,.5],bBoxSW:[0,-.5]},noteheadWhole:{bBoxNE:[1.688,.5],bBoxSW:[0,-.5]},noteheadXBlack:{bBoxNE:[1.16,.5],bBoxSW:[0,-.5]},noteheadXDoubleWhole:{bBoxNE:[2.184,.62],bBoxSW:[0,-.62]},noteheadXHalf:{bBoxNE:[1.336,.5],bBoxSW:[0,-.5]},noteheadXOrnate:{bBoxNE:[.988,.504],bBoxSW:[0,-.504]},noteheadXWhole:{bBoxNE:[1.508,.5],bBoxSW:[0,-.5]},octaveBaselineB:{bBoxNE:[.796,1.352],bBoxSW:[0,-.04]},octaveBaselineM:{bBoxNE:[1.524,.928],bBoxSW:[0,-.02]},ornamentMordent:{bBoxNE:[2.916,1.276],bBoxSW:[.004,-.292]},ornamentShortTrill:{bBoxNE:[2.9,.98],bBoxSW:[0,0]},ornamentTrill:{bBoxNE:[2.084,1.56],bBoxSW:[0,-.04]},ornamentTurn:{bBoxNE:[1.84,.872],bBoxSW:[0,0]},ornamentTurnInverted:{bBoxNE:[1.828,.872],bBoxSW:[-.012,0]},ottava:{bBoxNE:[1.544,1.852],bBoxSW:[0,-.04]},ottavaAlta:{bBoxNE:[3.54,1.852],bBoxSW:[0,-.04]},ottavaBassaVb:{bBoxNE:[3.184,1.852],bBoxSW:[0,-.04]},pictEdgeOfCymbal:{bBoxNE:[4.828,2.14],bBoxSW:[.004,0]},quindicesima:{bBoxNE:[2.668,1.844],bBoxSW:[0,-.04]},quindicesimaAlta:{bBoxNE:[5.26,1.844],bBoxSW:[0,-.04]},repeat1Bar:{bBoxNE:[2.128,1.116],bBoxSW:[0,-1]},repeat2Bars:{bBoxNE:[3.048,1.116],bBoxSW:[0,-1]},repeatDot:{bBoxNE:[.4,.2],bBoxSW:[0,-.2]},rest128th:{bBoxNE:[1.94,2.756],bBoxSW:[0,-3]},rest16th:{bBoxNE:[1.28,.716],bBoxSW:[0,-2]},rest256th:{bBoxNE:[2.164,2.784],bBoxSW:[0,-4]},rest32nd:{bBoxNE:[1.452,1.704],bBoxSW:[0,-2]},rest64th:{bBoxNE:[1.692,1.72],bBoxSW:[0,-3.012]},rest8th:{bBoxNE:[.988,.696],bBoxSW:[0,-1.004]},restDoubleWhole:{bBoxNE:[.5,1],bBoxSW:[0,0]},restHBarLeft:{bBoxNE:[1.5,1.048],bBoxSW:[0,-1.08]},restHBarMiddle:{bBoxNE:[1.42,.384],bBoxSW:[-.108,-.416]},restHBarRight:{bBoxNE:[1.5,1.048],bBoxSW:[0,-1.08]},restHalf:{bBoxNE:[1.128,.568],bBoxSW:[0,-.008]},restLonga:{bBoxNE:[.5,1],bBoxSW:[0,-.996]},restQuarter:{bBoxNE:[1.08,1.492],bBoxSW:[.004,-1.5]},restWhole:{bBoxNE:[1.128,.036],bBoxSW:[0,-.54]},segno:{bBoxNE:[2.2,3.036],bBoxSW:[.016,-.108]},stringsDownBow:{bBoxNE:[1.248,1.272],bBoxSW:[0,0]},stringsUpBow:{bBoxNE:[.996,1.98],bBoxSW:[.004,.004]},systemDivider:{bBoxNE:[4.232,4.24],bBoxSW:[0,-.272]},textAugmentationDot:{bBoxNE:[.4,.256],bBoxSW:[0,-.144]},textBlackNoteFrac16thLongStem:{bBoxNE:[1.368,3.512],bBoxSW:[0,-.56]},textBlackNoteFrac32ndLongStem:{bBoxNE:[1.368,3.512],bBoxSW:[0,-.56]},textBlackNoteFrac8thLongStem:{bBoxNE:[1.368,3.512],bBoxSW:[0,-.56]},textBlackNoteLongStem:{bBoxNE:[1.328,3.512],bBoxSW:[0,-.564]},textCont16thBeamLongStem:{bBoxNE:[1.368,3.512],bBoxSW:[0,2.264]},textCont32ndBeamLongStem:{bBoxNE:[1.368,3.512],bBoxSW:[0,1.504]},textCont8thBeamLongStem:{bBoxNE:[1.368,3.512],bBoxSW:[0,3.012]},textTuplet3LongStem:{bBoxNE:[.94,5.3],bBoxSW:[0,4.2]},textTupletBracketEndLongStem:{bBoxNE:[1.272,4.764],bBoxSW:[0,3.94]},textTupletBracketStartLongStem:{bBoxNE:[1.272,4.764],bBoxSW:[0,3.94]},timeSig0:{bBoxNE:[1.8,1.004],bBoxSW:[.08,-1]},timeSig1:{bBoxNE:[1.256,1.004],bBoxSW:[.08,-1]},timeSig2:{bBoxNE:[1.704,1.016],bBoxSW:[.08,-1.028]},timeSig3:{bBoxNE:[1.604,.996],bBoxSW:[.08,-1.004]},timeSig4:{bBoxNE:[1.8,1.004],bBoxSW:[.08,-1]},timeSig5:{bBoxNE:[1.532,.984],bBoxSW:[.08,-1.004]},timeSig6:{bBoxNE:[1.656,1.004],bBoxSW:[.08,-.996]},timeSig7:{bBoxNE:[1.684,.996],bBoxSW:[.08,-1]},timeSig8:{bBoxNE:[1.664,1.036],bBoxSW:[.08,-1.036]},timeSig9:{bBoxNE:[1.656,1.004],bBoxSW:[.08,-.996]},timeSigCommon:{bBoxNE:[1.696,1.004],bBoxSW:[.02,-.996]},timeSigCutCommon:{bBoxNE:[1.672,1.444],bBoxSW:[0,-1.436]},tremolo1:{bBoxNE:[.6,.376],bBoxSW:[-.6,-.372]},tremolo2:{bBoxNE:[.596,.748],bBoxSW:[-.604,-.748]},tremolo3:{bBoxNE:[.6,1.112],bBoxSW:[-.6,-1.12]},tremolo4:{bBoxNE:[.6,1.496],bBoxSW:[-.6,-1.48]},tremolo5:{bBoxNE:[.6,1.88],bBoxSW:[-.604,-1.84]},tuplet0:{bBoxNE:[1.2731041262817027,1.5],bBoxSW:[-.001204330173715796,-.032]},tuplet1:{bBoxNE:[1.024,1.488],bBoxSW:[.04,0]},tuplet2:{bBoxNE:[1.316,1.5],bBoxSW:[.04,-.024]},tuplet3:{bBoxNE:[1.224,1.5],bBoxSW:[.04,-.032]},tuplet4:{bBoxNE:[1.252,1.488],bBoxSW:[.04,0]},tuplet5:{bBoxNE:[1.308,1.492],bBoxSW:[.04,-.032]},tuplet6:{bBoxNE:[1.256,1.5],bBoxSW:[.04105974105482295,-.032]},tuplet7:{bBoxNE:[1.332,1.488],bBoxSW:[.12,-.016]},tuplet8:{bBoxNE:[1.292,1.5],bBoxSW:[.04,-.032]},tuplet9:{bBoxNE:[1.254940258945177,1.5],bBoxSW:[.04,-.032]},tupletColon:{bBoxNE:[.484,1.072],bBoxSW:[.04,.232]},unpitchedPercussionClef1:{bBoxNE:[1.528,1],bBoxSW:[0,-1]},wiggleSawtooth:{bBoxNE:[3.06,1.06],bBoxSW:[-.068,-1.068]},wiggleSawtoothNarrow:{bBoxNE:[2.06,1.064],bBoxSW:[-.072,-1.064]},wiggleTrill:{bBoxNE:[1.08,.836],bBoxSW:[-.144,.392]},wiggleVibratoMediumFast:{bBoxNE:[1.292,.8],bBoxSW:[-.104,-.164]}},glyphsWithAnchors:{accidentalDoubleFlat:{cutOutNE:[.988,.644],cutOutSE:[1.336,-.396]},accidentalFlat:{cutOutNE:[.252,.656],cutOutSE:[.504,-.476]},accidentalNatural:{cutOutNE:[.192,.776],cutOutSW:[.476,-.828]},accidentalQuarterToneFlatArrowUp:{cutOutNE:[.604,.664],cutOutSE:[.62,-.452]},accidentalQuarterToneSharpNaturalArrowUp:{cutOutSW:[.616,-.868]},accidentalSharp:{cutOutNE:[.84,.896],cutOutNW:[.144,.568],cutOutSE:[.84,-.596],cutOutSW:[.144,-.896]},accidentalThreeQuarterTonesSharpArrowUp:{cutOutNW:[.272,1.304],cutOutSE:[.86,-.584],cutOutSW:[.132,-.888]},dynamicFF:{opticalCenter:[1.852,0]},dynamicFFF:{opticalCenter:[2.472,0]},dynamicFFFF:{opticalCenter:[2.824,0]},dynamicFFFFF:{opticalCenter:[2.976,0]},dynamicFFFFFF:{opticalCenter:[3.504,0]},dynamicForte:{opticalCenter:[1.256,0]},dynamicFortePiano:{opticalCenter:[1.5,0]},dynamicForzando:{opticalCenter:[1.352,0]},dynamicMF:{opticalCenter:[1.796,0]},dynamicMP:{opticalCenter:[1.848,0]},dynamicNiente:{opticalCenter:[.616,0]},dynamicPF:{opticalCenter:[1.68,0]},dynamicPP:{opticalCenter:[1.708,0]},dynamicPPP:{opticalCenter:[2.368,0]},dynamicPPPP:{opticalCenter:[3.004,0]},dynamicPPPPP:{opticalCenter:[3.552,0]},dynamicPPPPPP:{opticalCenter:[4.248,0]},dynamicPiano:{opticalCenter:[1.22,0]},dynamicRinforzando1:{opticalCenter:[1.564,0]},dynamicRinforzando2:{opticalCenter:[2.084,0]},dynamicSforzando1:{opticalCenter:[1.3,0]},dynamicSforzandoPianissimo:{opticalCenter:[1.972,0]},dynamicSforzandoPiano:{opticalCenter:[1.904,0]},dynamicSforzato:{opticalCenter:[1.76,0]},dynamicSforzatoFF:{opticalCenter:[2.276,0]},dynamicSforzatoPiano:{opticalCenter:[1.848,0]},flag128thDown:{stemDownSW:[0,-2.076]},flag128thUp:{stemUpNW:[0,1.9]},flag16thDown:{stemDownSW:[0,.128]},flag16thUp:{stemUpNW:[0,-.088]},flag256thDown:{stemDownSW:[0,-2.812]},flag256thUp:{stemUpNW:[0,2.592]},flag32ndDown:{stemDownSW:[0,-.448]},flag32ndUp:{stemUpNW:[0,.376]},flag64thDown:{stemDownSW:[0,-1.244]},flag64thUp:{stemUpNW:[0,1.172]},flag8thDown:{graceNoteSlashNW:[-.596,2.168],graceNoteSlashSE:[1.328,.628],stemDownSW:[0,.132]},flag8thUp:{graceNoteSlashNE:[1.284,-.796],graceNoteSlashSW:[-.644,-2.456],stemUpNW:[0,-.04]},guitarVibratoStroke:{repeatOffset:[.608,0]},guitarWideVibratoStroke:{repeatOffset:[.82,0]},noteShapeDiamondBlack:{stemDownNW:[0,0],stemUpSE:[1.444,0]},noteShapeDiamondWhite:{stemDownNW:[0,0],stemUpSE:[1.436,0]},noteShapeMoonBlack:{stemDownNW:[0,.068],stemUpSE:[1.44,.068]},noteShapeMoonWhite:{stemDownNW:[0,.072],stemUpSE:[1.444,.068]},noteShapeRoundBlack:{stemDownNW:[0,-.168],stemUpSE:[1.444,.184]},noteShapeRoundWhite:{stemDownNW:[0,-.168],stemUpSE:[1.456,.192]},noteShapeSquareBlack:{stemDownNW:[0,.46],stemUpSE:[1.44,-.46]},noteShapeSquareWhite:{stemDownNW:[0,.46],stemUpSE:[1.44,-.46]},noteShapeTriangleLeftBlack:{stemDownNW:[0,.5],stemUpSE:[1.436,-.5]},noteShapeTriangleLeftWhite:{stemDownNW:[0,.5],stemUpSE:[1.436,-.5]},noteShapeTriangleRightBlack:{stemDownNW:[0,.476],stemUpSE:[1.44,-.5]},noteShapeTriangleRightWhite:{stemDownNW:[0,.476],stemUpSE:[1.44,-.5]},noteShapeTriangleRoundBlack:{stemDownNW:[0,.172],stemUpSE:[1.424,.172]},noteShapeTriangleRoundWhite:{stemDownNW:[0,.172],stemUpSE:[1.424,.172]},noteShapeTriangleUpBlack:{stemDownNW:[0,-.5],stemUpSE:[1.424,-.5]},noteShapeTriangleUpWhite:{stemDownNW:[0,-.5],stemUpSE:[1.424,-.5]},noteheadBlack:{cutOutNW:[.208,.3],cutOutSE:[.94,-.296],splitStemDownNE:[.968,-.248],splitStemDownNW:[.12,-.416],splitStemUpSE:[1.092,.392],splitStemUpSW:[.312,.356],stemDownNW:[0,-.168],stemUpSE:[1.18,.168]},noteheadCircleSlash:{stemDownNW:[.004,0],stemUpSE:[1,0]},noteheadCircleX:{stemDownNW:[0,0],stemUpSE:[.996,0]},noteheadCircleXDoubleWhole:{noteheadOrigin:[.352,0]},noteheadCircleXHalf:{stemDownNW:[0,0],stemUpSE:[1,0]},noteheadCircledBlack:{stemDownNW:[0,-.164],stemUpSE:[1.18,.168]},noteheadCircledDoubleWhole:{noteheadOrigin:[.356,0]},noteheadCircledHalf:{stemDownNW:[0,-.144],stemUpSE:[1.172,.156]},noteheadClusterDoubleWhole3rd:{noteheadOrigin:[.364,0]},noteheadClusterHalf3rd:{stemDownNW:[0,-.164],stemUpSE:[1.264,1.144]},noteheadClusterQuarter3rd:{stemDownNW:[0,.26],stemUpSE:[1.44,.744]},noteheadDiamondBlack:{stemDownNW:[0,0],stemUpSE:[1,0]},noteheadDiamondBlackWide:{stemDownNW:[0,0],stemUpSE:[1.4,0]},noteheadDiamondDoubleWhole:{noteheadOrigin:[.324,0]},noteheadDiamondHalf:{stemDownNW:[0,0],stemUpSE:[1.004,0]},noteheadDiamondWhite:{stemDownNW:[0,0],stemUpSE:[1,0]},noteheadDiamondWhiteWide:{stemDownNW:[0,.004],stemUpSE:[1.4,0]},noteheadDoubleWhole:{noteheadOrigin:[.36,0]},noteheadHalf:{cutOutNW:[.204,.296],cutOutSE:[.98,-.3],splitStemDownNE:[.956,-.3],splitStemDownNW:[.128,-.428],splitStemUpSE:[1.108,.372],splitStemUpSW:[.328,.38],stemDownNW:[0,-.168],stemUpSE:[1.18,.168]},noteheadHeavyX:{stemDownNW:[0,-.436],stemUpSE:[1.54,.44]},noteheadHeavyXHat:{stemDownNW:[0,-.436],stemUpSE:[1.54,.456]},noteheadPlusBlack:{stemDownNW:[-.004,0],stemUpSE:[.996,0]},noteheadPlusDoubleWhole:{noteheadOrigin:[.372,0]},noteheadPlusHalf:{stemDownNW:[0,-.112],stemUpSE:[1.044,.088]},noteheadRoundWhiteWithDot:{stemDownNW:[0,0],stemUpSE:[1.004,0]},noteheadSlashHorizontalEnds:{stemDownNW:[0,-1],stemUpSE:[2.12,1]},noteheadSlashWhiteHalf:{stemDownNW:[0,-1],stemUpSE:[3.12,1]},noteheadSlashedBlack1:{stemDownNW:[0,-.172],stemUpSE:[1.18,.164]},noteheadSlashedBlack2:{stemDownNW:[0,-.172],stemUpSE:[1.18,.164]},noteheadSlashedDoubleWhole1:{noteheadOrigin:[.356,0]},noteheadSlashedDoubleWhole2:{noteheadOrigin:[.356,0]},noteheadSlashedHalf1:{stemDownNW:[0,-.168],stemUpSE:[1.168,.164]},noteheadSlashedHalf2:{stemDownNW:[0,-.164],stemUpSE:[1.172,.168]},noteheadSquareBlack:{stemDownNW:[0,-.5],stemUpSE:[1.252,.5]},noteheadSquareBlackLarge:{stemDownNW:[0,0],stemUpSE:[2,0]},noteheadSquareBlackWhite:{stemDownNW:[0,-1],stemUpSE:[2,1]},noteheadSquareWhite:{stemDownNW:[0,-.5],stemUpSE:[1.252,.5]},noteheadTriangleDownBlack:{stemDownNW:[0,.5],stemUpSE:[1.168,.5]},noteheadTriangleDownDoubleWhole:{noteheadOrigin:[.384,0]},noteheadTriangleDownHalf:{stemDownNW:[0,.464],stemUpSE:[1.14,.464]},noteheadTriangleRightBlack:{stemDownNW:[0,-.5],stemUpSE:[1.356,.5]},noteheadTriangleRightWhite:{stemDownNW:[0,-.5],stemUpSE:[1.356,.5]},noteheadTriangleUpBlack:{stemDownNW:[0,-.5],stemUpSE:[1.172,-.5]},noteheadTriangleUpDoubleWhole:{noteheadOrigin:[.34,0]},noteheadTriangleUpHalf:{stemDownNW:[0,-.46],stemUpSE:[1.14,-.46]},noteheadWhole:{cutOutNW:[.172,.332],cutOutSE:[1.532,-.364]},noteheadXBlack:{stemDownNW:[0,-.44],stemUpSE:[1.16,.444]},noteheadXDoubleWhole:{noteheadOrigin:[.348,0]},noteheadXHalf:{stemDownNW:[0,-.412],stemUpSE:[1.336,.412]},noteheadXOrnate:{stemDownNW:[0,-.312],stemUpSE:[.988,.316]},wiggleSawtooth:{repeatOffset:[2.992,0]},wiggleSawtoothNarrow:{repeatOffset:[1.996,0]},wiggleTrill:{repeatOffset:[.948,0]},wiggleVibratoMediumFast:{repeatOffset:[1.18,0]}}}}class Ir{static fromJson(t,e){e&&nr.forEach(e,(e,s)=>Ir.setProperty(t,s.toLowerCase(),e))}static toJson(t){if(!t)return null;const e=new Map;e.set("musicfontsize",t.musicFontSize),e.set("onestaffspace",t.oneStaffSpace),e.set("tablinespacing",t.tabLineSpacing),e.set("arrowshaftthickness",t.arrowShaftThickness),e.set("barlineseparation",t.barlineSeparation),e.set("beamspacing",t.beamSpacing),e.set("beamthickness",t.beamThickness),e.set("bracketthickness",t.bracketThickness),e.set("dashedbarlinedashlength",t.dashedBarlineDashLength),e.set("dashedbarlinegaplength",t.dashedBarlineGapLength),e.set("dashedbarlinethickness",t.dashedBarlineThickness),e.set("hairpinthickness",t.hairpinThickness),e.set("legerlinethickness",t.legerLineThickness),e.set("legerlineextension",t.legerLineExtension),e.set("octavelinethickness",t.octaveLineThickness),e.set("pedallinethickness",t.pedalLineThickness),e.set("repeatbarlinedotseparation",t.repeatBarlineDotSeparation),e.set("repeatendinglinethickness",t.repeatEndingLineThickness),e.set("slurmidpointthickness",t.slurMidpointThickness),e.set("stafflinethickness",t.staffLineThickness),e.set("stemthickness",t.stemThickness),e.set("thickbarlinethickness",t.thickBarlineThickness),e.set("thinbarlinethickness",t.thinBarlineThickness),e.set("thinthickbarlineseparation",t.thinThickBarlineSeparation),e.set("tiemidpointthickness",t.tieMidpointThickness),e.set("tupletbracketthickness",t.tupletBracketThickness);{const s=new Map;e.set("stemup",s);for(const[e,i]of t.stemUp)s.set(e.toString(),Lr.toJson(i))}{const s=new Map;e.set("stemdown",s);for(const[e,i]of t.stemDown)s.set(e.toString(),Lr.toJson(i))}{const s=new Map;e.set("repeatoffsetx",s);for(const[e,i]of t.repeatOffsetX)s.set(e.toString(),i)}e.set("standardstemlength",t.standardStemLength);{const s=new Map;e.set("stemflagoffsets",s);for(const[e,i]of t.stemFlagOffsets)s.set(e.toString(),i)}{const s=new Map;e.set("glyphtop",s);for(const[e,i]of t.glyphTop)s.set(e.toString(),i)}{const s=new Map;e.set("glyphbottom",s);for(const[e,i]of t.glyphBottom)s.set(e.toString(),i)}{const s=new Map;e.set("glyphwidths",s);for(const[e,i]of t.glyphWidths)s.set(e.toString(),i)}{const s=new Map;e.set("glyphheights",s);for(const[e,i]of t.glyphHeights)s.set(e.toString(),i)}e.set("numberedbarrendererbarsize",t.numberedBarRendererBarSize),e.set("numberedbarrendererbarspacing",t.numberedBarRendererBarSpacing),e.set("numbereddashglyphpadding",t.numberedDashGlyphPadding),e.set("numbereddashglyphwidth",t.numberedDashGlyphWidth),e.set("linerangedglyphdashgap",t.lineRangedGlyphDashGap),e.set("linerangedglyphdashsize",t.lineRangedGlyphDashSize),e.set("prenoteeffectpadding",t.preNoteEffectPadding),e.set("postnoteeffectpadding",t.postNoteEffectPadding),e.set("onnoteeffectpadding",t.onNoteEffectPadding),e.set("stringnumbercirclepadding",t.stringNumberCirclePadding),e.set("rowcontainerpadding",t.rowContainerPadding),e.set("rowcontainergap",t.rowContainerGap),e.set("alternateendingspadding",t.alternateEndingsPadding),e.set("sustainpedallinepadding",t.sustainPedalLinePadding),e.set("tieheight",t.tieHeight),e.set("beattimerpadding",t.beatTimerPadding),e.set("bendnoteheadelementpadding",t.bendNoteHeadElementPadding),e.set("ghostparenthesiswidth",t.ghostParenthesisWidth),e.set("ghostparenthesispadding",t.ghostParenthesisPadding),e.set("brokenbeamwidth",t.brokenBeamWidth),e.set("tabwhammytextpadding",t.tabWhammyTextPadding),e.set("tabwhammyperhalfheight",t.tabWhammyPerHalfHeight),e.set("tabwhammydashsize",t.tabWhammyDashSize),e.set("songbookwhammydipheight",t.songBookWhammyDipHeight),e.set("deadslappedlinewidth",t.deadSlappedLineWidth),e.set("lefthandtabtiewidth",t.leftHandTabTieWidth),e.set("tabbenddashsize",t.tabBendDashSize),e.set("tabbendstaffpadding",t.tabBendStaffPadding),e.set("tabbendpervalueheight",t.tabBendPerValueHeight),e.set("tabbendlabelpadding",t.tabBendLabelPadding),e.set("simpleslidewidth",t.simpleSlideWidth),e.set("simpleslideheight",t.simpleSlideHeight),e.set("chorddiagrampaddingx",t.chordDiagramPaddingX),e.set("chorddiagrampaddingy",t.chordDiagramPaddingY),e.set("chorddiagramstringspacing",t.chordDiagramStringSpacing),e.set("chorddiagramfretspacing",t.chordDiagramFretSpacing),e.set("chorddiagramnutheight",t.chordDiagramNutHeight),e.set("chorddiagramfretheight",t.chordDiagramFretHeight),e.set("chorddiagramlinewidth",t.chordDiagramLineWidth),e.set("tripletfeelbracketpadding",t.tripletFeelBracketPadding),e.set("accidentalpadding",t.accidentalPadding),e.set("prebeatglyphspacing",t.preBeatGlyphSpacing),e.set("temponotescale",t.tempoNoteScale),e.set("tuningglyphcirclenumberscale",t.tuningGlyphCircleNumberScale),e.set("tuningglyphstringcolumnscale",t.tuningGlyphStringColumnScale),e.set("tuningglyphstringrowpadding",t.tuningGlyphStringRowPadding),e.set("directionsscale",t.directionsScale),e.set("multivoicedisplacednoteheadspacing",t.multiVoiceDisplacedNoteHeadSpacing);{const s=new Map;e.set("stemflagheight",s);for(const[e,i]of t.stemFlagHeight)s.set(e.toString(),i)}return e}static setProperty(t,e,s){switch(e){case"musicfontsize":return t.musicFontSize=s,!0;case"onestaffspace":return t.oneStaffSpace=s,!0;case"tablinespacing":return t.tabLineSpacing=s,!0;case"arrowshaftthickness":return t.arrowShaftThickness=s,!0;case"barlineseparation":return t.barlineSeparation=s,!0;case"beamspacing":return t.beamSpacing=s,!0;case"beamthickness":return t.beamThickness=s,!0;case"bracketthickness":return t.bracketThickness=s,!0;case"dashedbarlinedashlength":return t.dashedBarlineDashLength=s,!0;case"dashedbarlinegaplength":return t.dashedBarlineGapLength=s,!0;case"dashedbarlinethickness":return t.dashedBarlineThickness=s,!0;case"hairpinthickness":return t.hairpinThickness=s,!0;case"legerlinethickness":return t.legerLineThickness=s,!0;case"legerlineextension":return t.legerLineExtension=s,!0;case"octavelinethickness":return t.octaveLineThickness=s,!0;case"pedallinethickness":return t.pedalLineThickness=s,!0;case"repeatbarlinedotseparation":return t.repeatBarlineDotSeparation=s,!0;case"repeatendinglinethickness":return t.repeatEndingLineThickness=s,!0;case"slurmidpointthickness":return t.slurMidpointThickness=s,!0;case"stafflinethickness":return t.staffLineThickness=s,!0;case"stemthickness":return t.stemThickness=s,!0;case"thickbarlinethickness":return t.thickBarlineThickness=s,!0;case"thinbarlinethickness":return t.thinBarlineThickness=s,!0;case"thinthickbarlineseparation":return t.thinThickBarlineSeparation=s,!0;case"tiemidpointthickness":return t.tieMidpointThickness=s,!0;case"tupletbracketthickness":return t.tupletBracketThickness=s,!0;case"stemup":return t.stemUp=new Map,nr.forEach(s,(e,s)=>{const i=new Or;Lr.fromJson(i,e),t.stemUp.set(nr.parseEnum(s,lt),i)}),!0;case"stemdown":return t.stemDown=new Map,nr.forEach(s,(e,s)=>{const i=new Or;Lr.fromJson(i,e),t.stemDown.set(nr.parseEnum(s,lt),i)}),!0;case"repeatoffsetx":return t.repeatOffsetX=new Map,nr.forEach(s,(e,s)=>{t.repeatOffsetX.set(nr.parseEnum(s,lt),e)}),!0;case"standardstemlength":return t.standardStemLength=s,!0;case"stemflagoffsets":return t.stemFlagOffsets=new Map,nr.forEach(s,(e,s)=>{t.stemFlagOffsets.set(nr.parseEnum(s,c),e)}),!0;case"glyphtop":return t.glyphTop=new Map,nr.forEach(s,(e,s)=>{t.glyphTop.set(nr.parseEnum(s,lt),e)}),!0;case"glyphbottom":return t.glyphBottom=new Map,nr.forEach(s,(e,s)=>{t.glyphBottom.set(nr.parseEnum(s,lt),e)}),!0;case"glyphwidths":return t.glyphWidths=new Map,nr.forEach(s,(e,s)=>{t.glyphWidths.set(nr.parseEnum(s,lt),e)}),!0;case"glyphheights":return t.glyphHeights=new Map,nr.forEach(s,(e,s)=>{t.glyphHeights.set(nr.parseEnum(s,lt),e)}),!0;case"numberedbarrendererbarsize":return t.numberedBarRendererBarSize=s,!0;case"numberedbarrendererbarspacing":return t.numberedBarRendererBarSpacing=s,!0;case"numbereddashglyphpadding":return t.numberedDashGlyphPadding=s,!0;case"numbereddashglyphwidth":return t.numberedDashGlyphWidth=s,!0;case"linerangedglyphdashgap":return t.lineRangedGlyphDashGap=s,!0;case"linerangedglyphdashsize":return t.lineRangedGlyphDashSize=s,!0;case"prenoteeffectpadding":return t.preNoteEffectPadding=s,!0;case"postnoteeffectpadding":return t.postNoteEffectPadding=s,!0;case"onnoteeffectpadding":return t.onNoteEffectPadding=s,!0;case"stringnumbercirclepadding":return t.stringNumberCirclePadding=s,!0;case"rowcontainerpadding":return t.rowContainerPadding=s,!0;case"rowcontainergap":return t.rowContainerGap=s,!0;case"alternateendingspadding":return t.alternateEndingsPadding=s,!0;case"sustainpedallinepadding":return t.sustainPedalLinePadding=s,!0;case"tieheight":return t.tieHeight=s,!0;case"beattimerpadding":return t.beatTimerPadding=s,!0;case"bendnoteheadelementpadding":return t.bendNoteHeadElementPadding=s,!0;case"ghostparenthesiswidth":return t.ghostParenthesisWidth=s,!0;case"ghostparenthesispadding":return t.ghostParenthesisPadding=s,!0;case"brokenbeamwidth":return t.brokenBeamWidth=s,!0;case"tabwhammytextpadding":return t.tabWhammyTextPadding=s,!0;case"tabwhammyperhalfheight":return t.tabWhammyPerHalfHeight=s,!0;case"tabwhammydashsize":return t.tabWhammyDashSize=s,!0;case"songbookwhammydipheight":return t.songBookWhammyDipHeight=s,!0;case"deadslappedlinewidth":return t.deadSlappedLineWidth=s,!0;case"lefthandtabtiewidth":return t.leftHandTabTieWidth=s,!0;case"tabbenddashsize":return t.tabBendDashSize=s,!0;case"tabbendstaffpadding":return t.tabBendStaffPadding=s,!0;case"tabbendpervalueheight":return t.tabBendPerValueHeight=s,!0;case"tabbendlabelpadding":return t.tabBendLabelPadding=s,!0;case"simpleslidewidth":return t.simpleSlideWidth=s,!0;case"simpleslideheight":return t.simpleSlideHeight=s,!0;case"chorddiagrampaddingx":return t.chordDiagramPaddingX=s,!0;case"chorddiagrampaddingy":return t.chordDiagramPaddingY=s,!0;case"chorddiagramstringspacing":return t.chordDiagramStringSpacing=s,!0;case"chorddiagramfretspacing":return t.chordDiagramFretSpacing=s,!0;case"chorddiagramnutheight":return t.chordDiagramNutHeight=s,!0;case"chorddiagramfretheight":return t.chordDiagramFretHeight=s,!0;case"chorddiagramlinewidth":return t.chordDiagramLineWidth=s,!0;case"tripletfeelbracketpadding":return t.tripletFeelBracketPadding=s,!0;case"accidentalpadding":return t.accidentalPadding=s,!0;case"prebeatglyphspacing":return t.preBeatGlyphSpacing=s,!0;case"temponotescale":return t.tempoNoteScale=s,!0;case"tuningglyphcirclenumberscale":return t.tuningGlyphCircleNumberScale=s,!0;case"tuningglyphstringcolumnscale":return t.tuningGlyphStringColumnScale=s,!0;case"tuningglyphstringrowpadding":return t.tuningGlyphStringRowPadding=s,!0;case"directionsscale":return t.directionsScale=s,!0;case"multivoicedisplacednoteheadspacing":return t.multiVoiceDisplacedNoteHeadSpacing=s,!0;case"stemflagheight":return t.stemFlagHeight=new Map,nr.forEach(s,(e,s)=>{t.stemFlagHeight.set(nr.parseEnum(s,c),e)}),!0}return!1}}class Gr{startPos;endPos;text;constructor(t,e,s){this.text=t,this.startPos=e,this.endPos=s}}class Hr{style="normal";variant="normal";weight="normal";stretch="normal";lineHeight="normal";size="1rem";families=[];parseOnlyFamilies=!1;np;rp=-1;an="";ap=null;constructor(t){this.an=t,this.np=this.hp(t)}hp(t){const e=[];let s=0;for(;s<t.length;){let i=s;for(;i<t.length&&" "!==t.charAt(i);)i++;i>s&&e.push(new Gr(t.substring(s,i),s,i)),s=i+1}return e}parse(){if(this.op(),1===this.np.length)switch(this.ap?.text){case"caption":case"icon":case"menu":case"message-box":case"small-caption":case"status-bar":case"inherit":return}this.parseOnlyFamilies||(this.cp(),this.lp()),this.up()}static parseFamilies(t){const e=new Hr(t);return e.parseOnlyFamilies=!0,e.parse(),e.families}up(){if(!this.ap){if(this.parseOnlyFamilies)return;throw new Error("Missing font list")}const t=this.an.substr(this.ap.startPos).trim();let e=0;for(;e<t.length;){const s=t.charAt(e);if(" "===s||","===s)e++;else if('"'===s||"'"===s){const i=this.dp(t,e+1,s);this.families.push(t.substring(e+1,i).split(`\\${s}`).join(s)),e=i+1}else{const s=this.dp(t,e+1,",");this.families.push(t.substring(e,s).trim()),e=s+1}}}dp(t,e,s){let i=!1;for(;e<t.length;){const n=t.charAt(e);if(!i&&n===s)return e;i=!i&&"\\"===n,e+=1}return t.length}lp(){if(!this.ap)throw new Error("Missing font size");const t=this.ap.text.split("/");if(t.length>=3)throw new Error(`Invalid font size '${this.ap}' specified`);if(this.fp(),t.length>=2)if("/"===t[1]){if(!this.ap)throw new Error("Missing line-height after font size");this.lineHeight=this.ap.text,this.fp()}else this.size=t[0],this.lineHeight=t[1];else{if(!(t.length>=1))throw new Error("Missing font size");if(this.size=t[0],this.ap&&0===this.ap.text.indexOf("/"))if("/"===this.ap.text){if(this.fp(),!this.ap)throw new Error("Missing line-height after font size");this.lineHeight=this.ap.text,this.fp()}else this.lineHeight=this.ap.text.substr(1),this.fp()}}fp(){this.rp++,this.rp<this.np.length?this.ap=this.np[this.rp]:this.ap=null}cp(){let t=!1,e=!1,s=!1,i=3;const n=[];for(;;){if(!this.ap)return;const r=this.ap.text;switch(r){case"normal":case"inherit":n.push(r),i--,this.fp();break;case"italic":case"oblique":this.style=r,t=!0,i--,this.fp();break;case"small-caps":this.variant=r,e=!0,i--,this.fp();break;case"bold":case"bolder":case"lighter":case"100":case"200":case"300":case"400":case"500":case"600":case"700":case"800":case"900":this.weight=r,s=!0,i--,this.fp();break;default:return}if(0===i)break}for(;n.length>0;){const i=n.pop();s?e?t||(this.style=i):this.variant=i:this.weight=i}}op(){this.rp=-1,this.fp()}static quoteFont(t){if(-1===t.indexOf(" "))return t;return`"${t.replaceAll('"','\\"')}"`}}!function(t){t[t.Plain=0]="Plain",t[t.Italic=1]="Italic"}(rs||(rs={})),function(t){t[t.Regular=0]="Regular",t[t.Bold=1]="Bold"}(as||(as={}));class Vr{pp;bp=0;mp;gp;wp;Gi;op(){this.bp=0,this.pp=this.toCssString()}get family(){return this.mp[0]}set family(t){this.families=Hr.parseFamilies(t)}get families(){return this.mp}set families(t){this.mp=t,this.op()}get size(){return this.Gi}set size(t){this.Gi=t,this.op()}get style(){return this.gp}set style(t){this.gp=t,this.op()}get weight(){return this.wp}set weight(t){this.wp=t,this.op()}get isBold(){return this.weight===as.Bold}get isItalic(){return this.style===rs.Italic}constructor(t,e,s=rs.Plain,i=as.Regular){this.mp=Hr.parseFamilies(t),this.Gi=e,this.gp=s,this.wp=i,this.pp=this.toCssString()}withSize(t){return Vr.withFamilyList(this.mp,t,this.gp,this.wp)}static withFamilyList(t,e,s=rs.Plain,i=as.Regular){const n=new Vr("",e,s,i);return n.families=t,n}toCssString(t=1){if(!(this.pp&&Math.abs(t-this.bp)<.01)){let e="";this.isBold&&(e+="bold "),this.isItalic&&(e+="italic "),e+=this.size*t,e+="px ",e+=this.families.map(t=>Hr.quoteFont(t)).join(", "),this.pp=e,this.bp=t}return this.pp}static fromJson(t){if(t instanceof Vr)return t;switch(typeof t){case"undefined":default:return;case"object":{const e=t,s=e.get("families"),i=e.get("size"),n=nr.parseEnum(e.get("style"),rs),r=nr.parseEnum(e.get("weight"),as);return Vr.withFamilyList(s,i,n,r)}case"string":{const e=new Hr(t);e.parse();const s=e.families,i=e.size.toLowerCase();let n=0;switch(i){case"xx-small":n=7;break;case"x-small":n=10;break;case"small":case"smaller":n=13;break;case"medium":n=16;break;case"large":case"larger":n=18;break;case"x-large":n=24;break;case"xx-large":n=32;break;default:try{n=i.endsWith("em")?16*Number.parseFloat(i.substr(0,i.length-2)):i.endsWith("pt")?16*Number.parseFloat(i.substr(0,i.length-2))/12:i.endsWith("px")?Number.parseFloat(i.substr(0,i.length-2)):12}catch{n=12}}let r=rs.Plain;"italic"===e.style&&(r=rs.Italic);let a=as.Regular;switch(e.weight.toLowerCase()){case"normal":case"lighter":break;default:a=as.Bold}return Vr.withFamilyList(s,n,r,a)}}}static toJson(t){if(!t)return;const e=new Map;return e.set("families",t.families),e.set("size",t.size),e.set("style",t.style),e.set("weight",t.weight),e}}class $r{static fromJson(t,e){e&&nr.forEach(e,(e,s)=>$r.setProperty(t,s.toLowerCase(),e))}static toJson(t){if(!t)return null;const e=new Map;e.set("smuflfontfamilyname",t.smuflFontFamilyName),e.set("engravingsettings",Ir.toJson(t.engravingSettings));{const s=new Map;e.set("elementfonts",s);for(const[e,i]of t.elementFonts)s.set(e.toString(),Vr.toJson(i))}return e.set("numberednotationfont",Vr.toJson(t.numberedNotationFont)),e.set("numberednotationgracefont",Vr.toJson(t.numberedNotationGraceFont)),e.set("tablaturefont",Vr.toJson(t.tablatureFont)),e.set("gracefont",Vr.toJson(t.graceFont)),e.set("stafflinecolor",ke.toJson(t.staffLineColor)),e.set("barseparatorcolor",ke.toJson(t.barSeparatorColor)),e.set("barnumbercolor",ke.toJson(t.barNumberColor)),e.set("mainglyphcolor",ke.toJson(t.mainGlyphColor)),e.set("secondaryglyphcolor",ke.toJson(t.secondaryGlyphColor)),e.set("scoreinfocolor",ke.toJson(t.scoreInfoColor)),e}static setProperty(t,e,s){switch(e){case"smuflfontfamilyname":return t.smuflFontFamilyName=s,!0;case"elementfonts":return nr.forEach(s,(e,s)=>{t.elementFonts.set(nr.parseEnum(s,B),Vr.fromJson(e))}),!0;case"numberednotationfont":return t.numberedNotationFont=Vr.fromJson(s),!0;case"numberednotationgracefont":return t.numberedNotationGraceFont=Vr.fromJson(s),!0;case"tablaturefont":return t.tablatureFont=Vr.fromJson(s),!0;case"gracefont":return t.graceFont=Vr.fromJson(s),!0;case"stafflinecolor":return t.staffLineColor=ke.fromJson(s),!0;case"barseparatorcolor":return t.barSeparatorColor=ke.fromJson(s),!0;case"barnumbercolor":return t.barNumberColor=ke.fromJson(s),!0;case"mainglyphcolor":return t.mainGlyphColor=ke.fromJson(s),!0;case"secondaryglyphcolor":return t.secondaryGlyphColor=ke.fromJson(s),!0;case"scoreinfocolor":return t.scoreInfoColor=ke.fromJson(s),!0}return["engravingsettings"].indexOf(e)>=0&&(Ir.fromJson(t.engravingSettings,s),!0)}}!function(t){t[t.Default=0]="Default",t[t.ScoreTab=1]="ScoreTab",t[t.Score=2]="Score",t[t.Tab=3]="Tab",t[t.TabMixed=4]="TabMixed"}(hs||(hs={}));class Ur{static yp="Arial, sans-serif";static kp="Georgia, serif";static Sp=new Vr(Ur.kp,12,rs.Italic);static defaultFonts=new Map([[B.ScoreTitle,new Vr(Ur.kp,32,rs.Plain)],[B.ScoreSubTitle,new Vr(Ur.kp,20,rs.Plain)],[B.ScoreArtist,new Vr(Ur.kp,20,rs.Plain)],[B.ScoreAlbum,new Vr(Ur.kp,20,rs.Plain)],[B.ScoreWords,new Vr(Ur.kp,15,rs.Plain)],[B.ScoreMusic,new Vr(Ur.kp,15,rs.Plain)],[B.ScoreWordsAndMusic,new Vr(Ur.kp,15,rs.Plain)],[B.ScoreCopyright,new Vr(Ur.yp,12,rs.Plain,as.Bold)],[B.EffectBeatTimer,new Vr(Ur.kp,12,rs.Plain)],[B.EffectDirections,new Vr(Ur.kp,14,rs.Plain)],[B.ChordDiagramFretboardNumbers,new Vr(Ur.yp,11,rs.Plain)],[B.EffectFingering,new Vr(Ur.kp,14,rs.Plain)],[B.EffectMarker,new Vr(Ur.kp,14,rs.Plain,as.Bold)],[B.EffectCapo,Ur.Sp],[B.EffectFreeTime,Ur.Sp],[B.EffectLyrics,Ur.Sp],[B.EffectTap,Ur.Sp],[B.ChordDiagrams,Ur.Sp],[B.EffectChordNames,Ur.Sp],[B.EffectText,Ur.Sp],[B.EffectPalmMute,Ur.Sp],[B.EffectLetRing,Ur.Sp],[B.EffectBeatBarre,Ur.Sp],[B.EffectTripletFeel,Ur.Sp],[B.EffectHarmonics,Ur.Sp],[B.EffectPickSlide,Ur.Sp],[B.GuitarTuning,Ur.Sp],[B.EffectRasgueado,Ur.Sp],[B.EffectWhammyBar,Ur.Sp],[B.TrackNames,Ur.Sp],[B.RepeatCount,new Vr(Ur.yp,11,rs.Plain)],[B.BarNumber,new Vr(Ur.yp,11,rs.Plain)],[B.ScoreBendSlur,new Vr(Ur.yp,11,rs.Plain)],[B.EffectAlternateEndings,new Vr(Ur.kp,15,rs.Plain)]]);smuflFontFamilyName;engravingSettings=Rr.bravuraDefaults;get copyrightFont(){return this.elementFonts.get(B.ScoreCopyright)}set copyrightFont(t){this.elementFonts.set(B.ScoreCopyright,t)}get titleFont(){return this.elementFonts.get(B.ScoreTitle)}set titleFont(t){this.elementFonts.set(B.ScoreTitle,t)}get subTitleFont(){return this.elementFonts.get(B.ScoreSubTitle)}set subTitleFont(t){this.elementFonts.set(B.ScoreSubTitle,t)}get wordsFont(){return this.elementFonts.get(B.ScoreWords)}set wordsFont(t){this.elementFonts.set(B.ScoreWords,t)}get timerFont(){return this.elementFonts.get(B.EffectBeatTimer)}set timerFont(t){this.elementFonts.set(B.EffectBeatTimer,t)}get directionsFont(){return this.elementFonts.get(B.EffectDirections)}set directionsFont(t){this.elementFonts.set(B.EffectDirections,t)}get fretboardNumberFont(){return this.elementFonts.get(B.ChordDiagramFretboardNumbers)}set fretboardNumberFont(t){this.elementFonts.set(B.ChordDiagramFretboardNumbers,t)}fingeringFont=Ur.Sp;inlineFingeringFont=Ur.Sp;get markerFont(){return this.elementFonts.get(B.EffectMarker)}set markerFont(t){this.elementFonts.set(B.EffectMarker,t)}effectFont=Ur.Sp;get barNumberFont(){return this.elementFonts.get(B.BarNumber)}set barNumberFont(t){this.elementFonts.set(B.BarNumber,t)}elementFonts=new Map;numberedNotationFont=new Vr(Ur.yp,16,rs.Plain);numberedNotationGraceFont=new Vr(Ur.yp,14,rs.Plain);tablatureFont=new Vr(Ur.yp,14,rs.Plain);graceFont=new Vr(Ur.yp,12,rs.Plain);staffLineColor=new ke(165,165,165,255);barSeparatorColor=new ke(34,34,17,255);barNumberColor=new ke(200,0,0,255);mainGlyphColor=new ke(0,0,0,255);secondaryGlyphColor=new ke(0,0,0,100);scoreInfoColor=new ke(0,0,0,255);constructor(){for(const[t,e]of Ur.defaultFonts)this.elementFonts.set(t,e.withSize(e.size))}getFontForElement(t){let e=B.ScoreWords;switch(t){case ot.Title:e=B.ScoreTitle;break;case ot.SubTitle:e=B.ScoreSubTitle;break;case ot.Artist:e=B.ScoreArtist;break;case ot.Album:e=B.ScoreAlbum;break;case ot.Words:e=B.ScoreWords;break;case ot.Music:e=B.ScoreMusic;break;case ot.WordsAndMusic:e=B.ScoreWordsAndMusic;break;case ot.Copyright:case ot.CopyrightSecondLine:e=B.ScoreCopyright;break;default:e=B.ScoreWords}return this.elementFonts.has(e)?this.elementFonts.get(e):Ur.defaultFonts.get(B.ScoreWords)}}!function(t){t[t.Automatic=0]="Automatic",t[t.UseModelLayout=1]="UseModelLayout"}(os||(os={}));class zr{scale=1;stretchForce=1;layoutMode=Je.Page;staveProfile=hs.Default;barsPerRow=-1;startBar=1;barCount=-1;barCountPerPartial=10;justifyLastSystem=!1;resources=new Ur;padding=[35,35];firstSystemPaddingTop=0;systemPaddingTop=10;systemPaddingBottom=10;lastSystemPaddingBottom=5;systemLabelPaddingLeft=0;systemLabelPaddingRight=3;accoladeBarPaddingRight=3;firstNotationStaffPaddingTop=0;lastNotationStaffPaddingBottom=0;notationStaffPaddingTop=0;notationStaffPaddingBottom=0;effectStaffPaddingTop=0;effectStaffPaddingBottom=0;firstStaffPaddingLeft=6;staffPaddingLeft=2;effectBandPaddingBottom=2;trackStaffPaddingBetween=5;lyricLinesPaddingBetween=5;systemsLayoutMode=os.Automatic}class Xr{static fromJson(t,e){e&&nr.forEach(e,(e,s)=>Xr.setProperty(t,s.toLowerCase(),e))}static toJson(t){if(!t)return null;const e=new Map;return e.set("scale",t.scale),e.set("stretchforce",t.stretchForce),e.set("layoutmode",t.layoutMode),e.set("staveprofile",t.staveProfile),e.set("barsperrow",t.barsPerRow),e.set("startbar",t.startBar),e.set("barcount",t.barCount),e.set("barcountperpartial",t.barCountPerPartial),e.set("justifylastsystem",t.justifyLastSystem),e.set("resources",$r.toJson(t.resources)),e.set("padding",t.padding),e.set("firstsystempaddingtop",t.firstSystemPaddingTop),e.set("systempaddingtop",t.systemPaddingTop),e.set("systempaddingbottom",t.systemPaddingBottom),e.set("lastsystempaddingbottom",t.lastSystemPaddingBottom),e.set("systemlabelpaddingleft",t.systemLabelPaddingLeft),e.set("systemlabelpaddingright",t.systemLabelPaddingRight),e.set("accoladebarpaddingright",t.accoladeBarPaddingRight),e.set("firstnotationstaffpaddingtop",t.firstNotationStaffPaddingTop),e.set("lastnotationstaffpaddingbottom",t.lastNotationStaffPaddingBottom),e.set("notationstaffpaddingtop",t.notationStaffPaddingTop),e.set("notationstaffpaddingbottom",t.notationStaffPaddingBottom),e.set("effectstaffpaddingtop",t.effectStaffPaddingTop),e.set("effectstaffpaddingbottom",t.effectStaffPaddingBottom),e.set("firststaffpaddingleft",t.firstStaffPaddingLeft),e.set("staffpaddingleft",t.staffPaddingLeft),e.set("effectbandpaddingbottom",t.effectBandPaddingBottom),e.set("trackstaffpaddingbetween",t.trackStaffPaddingBetween),e.set("lyriclinespaddingbetween",t.lyricLinesPaddingBetween),e.set("systemslayoutmode",t.systemsLayoutMode),e}static setProperty(t,e,s){switch(e){case"scale":return t.scale=s,!0;case"stretchforce":return t.stretchForce=s,!0;case"layoutmode":return t.layoutMode=nr.parseEnum(s,Je),!0;case"staveprofile":return t.staveProfile=nr.parseEnum(s,hs),!0;case"barsperrow":return t.barsPerRow=s,!0;case"startbar":return t.startBar=s,!0;case"barcount":return t.barCount=s,!0;case"barcountperpartial":return t.barCountPerPartial=s,!0;case"justifylastsystem":return t.justifyLastSystem=s,!0;case"padding":return t.padding=s,!0;case"firstsystempaddingtop":return t.firstSystemPaddingTop=s,!0;case"systempaddingtop":return t.systemPaddingTop=s,!0;case"systempaddingbottom":return t.systemPaddingBottom=s,!0;case"lastsystempaddingbottom":return t.lastSystemPaddingBottom=s,!0;case"systemlabelpaddingleft":return t.systemLabelPaddingLeft=s,!0;case"systemlabelpaddingright":return t.systemLabelPaddingRight=s,!0;case"accoladebarpaddingright":return t.accoladeBarPaddingRight=s,!0;case"firstnotationstaffpaddingtop":return t.firstNotationStaffPaddingTop=s,!0;case"lastnotationstaffpaddingbottom":return t.lastNotationStaffPaddingBottom=s,!0;case"notationstaffpaddingtop":return t.notationStaffPaddingTop=s,!0;case"notationstaffpaddingbottom":return t.notationStaffPaddingBottom=s,!0;case"effectstaffpaddingtop":return t.effectStaffPaddingTop=s,!0;case"effectstaffpaddingbottom":return t.effectStaffPaddingBottom=s,!0;case"firststaffpaddingleft":return t.firstStaffPaddingLeft=s,!0;case"staffpaddingleft":return t.staffPaddingLeft=s,!0;case"effectbandpaddingbottom":return t.effectBandPaddingBottom=s,!0;case"trackstaffpaddingbetween":return t.trackStaffPaddingBetween=s,!0;case"lyriclinespaddingbetween":return t.lyricLinesPaddingBetween=s,!0;case"systemslayoutmode":return t.systemsLayoutMode=nr.parseEnum(s,os),!0}if(["resources"].indexOf(e)>=0)return $r.fromJson(t.resources,s),!0;for(const i of["resources"])if(0===e.indexOf(i)&&$r.setProperty(t.resources,e.substring(i.length),s))return!0;return!1}}class jr{static fromJson(t,e){e&&nr.forEach(e,(e,s)=>jr.setProperty(t,s.toLowerCase(),e))}static toJson(t){if(!t)return null;const e=new Map;e.set("notationmode",t.notationMode),e.set("fingeringmode",t.fingeringMode);{const s=new Map;e.set("elements",s);for(const[e,i]of t.elements)s.set(e.toString(),i)}return e.set("rhythmmode",t.rhythmMode),e.set("rhythmheight",t.rhythmHeight),e.set("transpositionpitches",t.transpositionPitches),e.set("displaytranspositionpitches",t.displayTranspositionPitches),e.set("smallgracetabnotes",t.smallGraceTabNotes),e.set("extendbendarrowsontiednotes",t.extendBendArrowsOnTiedNotes),e.set("extendlineeffectstobeatend",t.extendLineEffectsToBeatEnd),e.set("slurheight",t.slurHeight),e}static setProperty(t,e,s){switch(e){case"notationmode":return t.notationMode=nr.parseEnum(s,S),!0;case"fingeringmode":return t.fingeringMode=nr.parseEnum(s,k),!0;case"elements":return t.elements=new Map,nr.forEach(s,(e,s)=>{t.elements.set(nr.parseEnum(s,B),e)}),!0;case"rhythmmode":return t.rhythmMode=nr.parseEnum(s,y),!0;case"rhythmheight":return t.rhythmHeight=s,!0;case"transpositionpitches":return t.transpositionPitches=s,!0;case"displaytranspositionpitches":return t.displayTranspositionPitches=s,!0;case"smallgracetabnotes":return t.smallGraceTabNotes=s,!0;case"extendbendarrowsontiednotes":return t.extendBendArrowsOnTiedNotes=s,!0;case"extendlineeffectstobeatend":return t.extendLineEffectsToBeatEnd=s,!0;case"slurheight":return t.slurHeight=s,!0}return!1}}class Jr{static fromJson(t,e){e&&nr.forEach(e,(e,s)=>Jr.setProperty(t,s.toLowerCase(),e))}static toJson(t){if(!t)return null;const e=new Map;return e.set("encoding",t.encoding),e.set("mergepartgroupsinmusicxml",t.mergePartGroupsInMusicXml),e.set("beattextaslyrics",t.beatTextAsLyrics),e}static setProperty(t,e,s){switch(e){case"encoding":return t.encoding=s,!0;case"mergepartgroupsinmusicxml":return t.mergePartGroupsInMusicXml=s,!0;case"beattextaslyrics":return t.beatTextAsLyrics=s,!0}return!1}}class qr{static fromJson(t,e){e&&nr.forEach(e,(e,s)=>qr.setProperty(t,s.toLowerCase(),e))}static toJson(t){if(!t)return null;const e=new Map;return e.set("notewidelength",t.noteWideLength),e.set("notewideamplitude",t.noteWideAmplitude),e.set("noteslightlength",t.noteSlightLength),e.set("noteslightamplitude",t.noteSlightAmplitude),e.set("beatwidelength",t.beatWideLength),e.set("beatwideamplitude",t.beatWideAmplitude),e.set("beatslightlength",t.beatSlightLength),e.set("beatslightamplitude",t.beatSlightAmplitude),e}static setProperty(t,e,s){switch(e){case"notewidelength":return t.noteWideLength=s,!0;case"notewideamplitude":return t.noteWideAmplitude=s,!0;case"noteslightlength":return t.noteSlightLength=s,!0;case"noteslightamplitude":return t.noteSlightAmplitude=s,!0;case"beatwidelength":return t.beatWideLength=s,!0;case"beatwideamplitude":return t.beatWideAmplitude=s,!0;case"beatslightlength":return t.beatSlightLength=s,!0;case"beatslightamplitude":return t.beatSlightAmplitude=s,!0}return!1}}class Yr{static fromJson(t,e){e&&nr.forEach(e,(e,s)=>Yr.setProperty(t,s.toLowerCase(),e))}static toJson(t){if(!t)return null;const e=new Map;return e.set("simpleslidepitchoffset",t.simpleSlidePitchOffset),e.set("simpleslidedurationratio",t.simpleSlideDurationRatio),e.set("shiftslidedurationratio",t.shiftSlideDurationRatio),e}static setProperty(t,e,s){switch(e){case"simpleslidepitchoffset":return t.simpleSlidePitchOffset=s,!0;case"simpleslidedurationratio":return t.simpleSlideDurationRatio=s,!0;case"shiftslidedurationratio":return t.shiftSlideDurationRatio=s,!0}return!1}}!function(t){t[t.Off=0]="Off",t[t.Continuous=1]="Continuous",t[t.OffScreen=2]="OffScreen",t[t.Smooth=3]="Smooth"}(cs||(cs={}));class Kr{noteWideLength=240;noteWideAmplitude=1;noteSlightLength=360;noteSlightAmplitude=.5;beatWideLength=480;beatWideAmplitude=2;beatSlightLength=480;beatSlightAmplitude=2}class Qr{simpleSlidePitchOffset=6;simpleSlideDurationRatio=.25;shiftSlideDurationRatio=.5}!function(t){t[t.WebAudioAudioWorklets=0]="WebAudioAudioWorklets",t[t.WebAudioScriptProcessor=1]="WebAudioScriptProcessor"}(ls||(ls={})),function(t){t[t.Disabled=0]="Disabled",t[t.EnabledAutomatic=1]="EnabledAutomatic",t[t.EnabledSynthesizer=2]="EnabledSynthesizer",t[t.EnabledBackingTrack=3]="EnabledBackingTrack",t[t.EnabledExternalMedia=4]="EnabledExternalMedia"}(us||(us={}));class Zr{soundFont=null;scrollElement="html,body";outputMode=ls.WebAudioAudioWorklets;enablePlayer=!1;playerMode=us.Disabled;enableCursor=!0;enableAnimatedBeatCursor=!0;enableElementHighlighting=!0;enableUserInteraction=!0;scrollOffsetX=0;scrollOffsetY=0;scrollMode=cs.Continuous;scrollSpeed=300;nativeBrowserSmoothScroll=!0;songBookBendDuration=75;songBookDipDuration=150;vibrato=new Kr;slide=new Qr;playTripletFeel=!0;bufferTimeInMilliseconds=500}class ta{static fromJson(t,e){e&&nr.forEach(e,(e,s)=>ta.setProperty(t,s.toLowerCase(),e))}static toJson(t){if(!t)return null;const e=new Map;return e.set("soundfont",t.soundFont),e.set("outputmode",t.outputMode),e.set("enableplayer",t.enablePlayer),e.set("playermode",t.playerMode),e.set("enablecursor",t.enableCursor),e.set("enableanimatedbeatcursor",t.enableAnimatedBeatCursor),e.set("enableelementhighlighting",t.enableElementHighlighting),e.set("enableuserinteraction",t.enableUserInteraction),e.set("scrolloffsetx",t.scrollOffsetX),e.set("scrolloffsety",t.scrollOffsetY),e.set("scrollmode",t.scrollMode),e.set("scrollspeed",t.scrollSpeed),e.set("nativebrowsersmoothscroll",t.nativeBrowserSmoothScroll),e.set("songbookbendduration",t.songBookBendDuration),e.set("songbookdipduration",t.songBookDipDuration),e.set("vibrato",qr.toJson(t.vibrato)),e.set("slide",Yr.toJson(t.slide)),e.set("playtripletfeel",t.playTripletFeel),e.set("buffertimeinmilliseconds",t.bufferTimeInMilliseconds),e}static setProperty(t,e,s){switch(e){case"soundfont":return t.soundFont=s,!0;case"scrollelement":return t.scrollElement=s,!0;case"outputmode":return t.outputMode=nr.parseEnum(s,ls),!0;case"enableplayer":return t.enablePlayer=s,!0;case"playermode":return t.playerMode=nr.parseEnum(s,us),!0;case"enablecursor":return t.enableCursor=s,!0;case"enableanimatedbeatcursor":return t.enableAnimatedBeatCursor=s,!0;case"enableelementhighlighting":return t.enableElementHighlighting=s,!0;case"enableuserinteraction":return t.enableUserInteraction=s,!0;case"scrolloffsetx":return t.scrollOffsetX=s,!0;case"scrolloffsety":return t.scrollOffsetY=s,!0;case"scrollmode":return t.scrollMode=nr.parseEnum(s,cs),!0;case"scrollspeed":return t.scrollSpeed=s,!0;case"nativebrowsersmoothscroll":return t.nativeBrowserSmoothScroll=s,!0;case"songbookbendduration":return t.songBookBendDuration=s,!0;case"songbookdipduration":return t.songBookDipDuration=s,!0;case"playtripletfeel":return t.playTripletFeel=s,!0;case"buffertimeinmilliseconds":return t.bufferTimeInMilliseconds=s,!0}if(["vibrato"].indexOf(e)>=0)return qr.fromJson(t.vibrato,s),!0;for(const i of["vibrato"])if(0===e.indexOf(i)&&qr.setProperty(t.vibrato,e.substring(i.length),s))return!0;if(["slide"].indexOf(e)>=0)return Yr.fromJson(t.slide,s),!0;for(const i of["slide"])if(0===e.indexOf(i)&&Yr.setProperty(t.slide,e.substring(i.length),s))return!0;return!1}}class ea{static fromJson(t,e){e&&nr.forEach(e,(e,s)=>ea.setProperty(t,s.toLowerCase(),e))}static toJson(t){if(!t)return null;const e=new Map;return e.set("indent",t.indent),e.set("comments",t.comments),e}static setProperty(t,e,s){switch(e){case"indent":return t.indent=s,!0;case"comments":return t.comments=s,!0}return!1}}class sa{static fromJson(t,e){e&&nr.forEach(e,(e,s)=>sa.setProperty(t,s.toLowerCase(),e))}static toJson(t){if(!t)return null;const e=new Map;return e.set("core",Dr.toJson(t.core)),e.set("display",Xr.toJson(t.display)),e.set("notation",jr.toJson(t.notation)),e.set("importer",Jr.toJson(t.importer)),e.set("player",ta.toJson(t.player)),e.set("exporter",ea.toJson(t.exporter)),e}static setProperty(t,e,s){if(["core",""].indexOf(e)>=0)return Dr.fromJson(t.core,s),!0;for(const i of["core",""])if(0===e.indexOf(i)&&Dr.setProperty(t.core,e.substring(i.length),s))return!0;if(["display",""].indexOf(e)>=0)return Xr.fromJson(t.display,s),!0;for(const i of["display",""])if(0===e.indexOf(i)&&Xr.setProperty(t.display,e.substring(i.length),s))return!0;if(["notation"].indexOf(e)>=0)return jr.fromJson(t.notation,s),!0;for(const i of["notation"])if(0===e.indexOf(i)&&jr.setProperty(t.notation,e.substring(i.length),s))return!0;if(["importer"].indexOf(e)>=0)return Jr.fromJson(t.importer,s),!0;for(const i of["importer"])if(0===e.indexOf(i)&&Jr.setProperty(t.importer,e.substring(i.length),s))return!0;if(["player"].indexOf(e)>=0)return ta.fromJson(t.player,s),!0;for(const i of["player"])if(0===e.indexOf(i)&&ta.setProperty(t.player,e.substring(i.length),s))return!0;if(["exporter"].indexOf(e)>=0)return ea.fromJson(t.exporter,s),!0;for(const i of["exporter"])if(0===e.indexOf(i)&&ea.setProperty(t.exporter,e.substring(i.length),s))return!0;return!1}}class ia{encoding="utf-8";mergePartGroupsInMusicXml=!1;beatTextAsLyrics=!1}class na{indent=2;comments=!1}class ra{core=new Cu;display=new zr;notation=new z;importer=new ia;player=new Zr;exporter=new na;setSongBookModeSettings(){this.notation.notationMode=S.SongBook,this.notation.smallGraceTabNotes=!1,this.notation.fingeringMode=k.SingleNoteEffectBand,this.notation.extendBendArrowsOnTiedNotes=!1,this.notation.elements.set(B.ParenthesisOnTiedBends,!1),this.notation.elements.set(B.TabNotesOnTiedBends,!1),this.notation.elements.set(B.ZerosOnDiveWhammys,!0)}static get songBook(){const t=new ra;return t.setSongBookModeSettings(),t}fillFromJson(t){sa.fromJson(this,t)}handleBackwardsCompatibility(){this.player.playerMode===us.Disabled&&this.player.enablePlayer&&(this.player.playerMode=us.EnabledAutomatic)}}class aa{static Bp(t,e){if(e instanceof Map){if("fromEntries"in Object)return Object.fromEntries(e);const t={};for(const[s,i]of e)t[s]=i;return t}return ArrayBuffer.isView(e)?Array.apply([],[e]):e}static scoreToJson(t){const e=aa.scoreToJsObject(t);return JSON.stringify(e,aa.Bp)}static jsonToScore(t,e){return aa.jsObjectToScore(JSON.parse(t),e)}static scoreToJsObject(t){return Ar.toJson(t)}static jsObjectToScore(t,e){const s=new Ht;return Ar.fromJson(s,t),s.finish(e??new ra),s}static settingsToJson(t){const e=aa.settingsToJsObject(t);return JSON.stringify(e,aa.Bp)}static jsonToSettings(t){return aa.jsObjectToSettings(JSON.parse(t))}static settingsToJsObject(t){return sa.toJson(t)}static jsObjectToSettings(t){const e=new ra;return sa.fromJson(e,t),e}static jsObjectToMidiFile(t){const e=new Ti;return nr.forEach(t,(t,s)=>{switch(s){case"tickShift":e.tickShift=t;break;case"division":e.division=t;break;case"tracks":for(const s of t){const t=aa._p(s);e.tracks.push(t)}}}),e}static _p(t){const e=new _i;return nr.forEach(t,(t,s)=>{if("events"===s)for(const s of t){const t=aa.jsObjectToMidiEvent(s);e.events.push(t)}}),e}static jsObjectToMidiEvent(t){const e=nr.getValue(t,"track"),i=nr.getValue(t,"tick"),n=nr.getValue(t,"type");switch(n){case Ye.TimeSignature:return new Mi(e,i,nr.getValue(t,"numerator"),nr.getValue(t,"denominatorIndex"),nr.getValue(t,"midiClocksPerMetronomeClick"),nr.getValue(t,"thirdySecondNodesInQuarter"));case Ye.AlphaTabRest:return new Pi(e,i,nr.getValue(t,"channel"));case Ye.AlphaTabMetronome:return new Ni(e,i,nr.getValue(t,"metronomeNumerator"),nr.getValue(t,"metronomeDurationInTicks"),nr.getValue(t,"metronomeDurationInMilliseconds"));case Ye.NoteOn:return new Ei(e,i,nr.getValue(t,"channel"),nr.getValue(t,"noteKey"),nr.getValue(t,"noteVelocity"));case Ye.NoteOff:return new Fi(e,i,nr.getValue(t,"channel"),nr.getValue(t,"noteKey"),nr.getValue(t,"noteVelocity"));case Ye.ControlChange:return new Ai(e,i,nr.getValue(t,"channel"),nr.getValue(t,"controller"),nr.getValue(t,"value"));case Ye.ProgramChange:return new Di(e,i,nr.getValue(t,"channel"),nr.getValue(t,"program"));case Ye.TempoChange:const s=new Li(i,0);return s.beatsPerMinute=nr.getValue(t,"beatsPerMinute"),s;case Ye.PitchBend:return new Wi(e,i,nr.getValue(t,"channel"),nr.getValue(t,"value"));case Ye.PerNotePitchBend:return new Oi(e,i,nr.getValue(t,"channel"),nr.getValue(t,"noteKey"),nr.getValue(t,"value"));case Ye.EndOfTrack:return new Ri(e,i)}throw new I(s.Format,`Unknown Midi Event type: ${n}`)}static midiFileToJsObject(t){const e=new Map;e.set("division",t.division),e.set("tickShift",t.tickShift);const s=[];for(const e of t.tracks)s.push(aa.Tp(e));return e.set("tracks",s),e}static Tp(t){const e=new Map,s=[];for(const e of t.events)s.push(aa.midiEventToJsObject(e));return e.set("events",s),e}static midiEventToJsObject(t){const e=new Map;switch(e.set("track",t.track),e.set("tick",t.tick),e.set("type",t.type),t.type){case Ye.TimeSignature:e.set("numerator",t.numerator),e.set("denominatorIndex",t.denominatorIndex),e.set("midiClocksPerMetronomeClick",t.midiClocksPerMetronomeClick),e.set("thirdySecondNodesInQuarter",t.thirtySecondNodesInQuarter);break;case Ye.AlphaTabRest:e.set("channel",t.channel);break;case Ye.AlphaTabMetronome:e.set("metronomeNumerator",t.metronomeNumerator),e.set("metronomeDurationInMilliseconds",t.metronomeDurationInMilliseconds),e.set("metronomeDurationInTicks",t.metronomeDurationInTicks);break;case Ye.NoteOn:case Ye.NoteOff:e.set("channel",t.channel),e.set("noteKey",t.noteKey),e.set("noteVelocity",t.noteVelocity);break;case Ye.ControlChange:e.set("channel",t.channel),e.set("controller",t.controller),e.set("value",t.value);break;case Ye.ProgramChange:e.set("channel",t.channel),e.set("program",t.program);break;case Ye.TempoChange:e.set("beatsPerMinute",t.beatsPerMinute);break;case Ye.PitchBend:e.set("channel",t.channel),e.set("value",t.value);break;case Ye.PerNotePitchBend:e.set("channel",t.channel),e.set("noteKey",t.noteKey),e.set("value",t.value);case Ye.EndOfTrack:}return e}}class ha{xp;Mp;vp=new Map;constructor(t,e){this.Mp=t,this.Mp.addEventListener("message",this.handleMessage.bind(this)),this.xp=new sr(new gi,e),this.xp.positionChanged.on(this.onPositionChanged.bind(this)),this.xp.stateChanged.on(this.onPlayerStateChanged.bind(this)),this.xp.finished.on(this.onFinished.bind(this)),this.xp.soundFontLoaded.on(this.onSoundFontLoaded.bind(this)),this.xp.soundFontLoadFailed.on(this.onSoundFontLoadFailed.bind(this)),this.xp.soundFontLoadFailed.on(this.onSoundFontLoadFailed.bind(this)),this.xp.midiLoaded.on(this.onMidiLoaded.bind(this)),this.xp.midiLoadFailed.on(this.onMidiLoadFailed.bind(this)),this.xp.readyForPlayback.on(this.onReadyForPlayback.bind(this)),this.xp.midiEventsPlayed.on(this.onMidiEventsPlayed.bind(this)),this.xp.playbackRangeChanged.on(this.onPlaybackRangeChanged.bind(this)),this.Mp.postMessage({cmd:"alphaSynth.ready"})}static init(){const t=Pu.globalThis;t.addEventListener("message",e=>{const s=e.data;if("alphaSynth.initialize"===s.cmd)gi.preferredSampleRate=s.sampleRate,J.logLevel=s.logLevel,Pu.globalThis.alphaSynthWebWorker=new ha(t,s.bufferTimeInMilliseconds)})}handleMessage(t){const e=t.data,s=e.cmd;switch(s){case"alphaSynth.setLogLevel":J.logLevel=e.value;break;case"alphaSynth.setMasterVolume":this.xp.masterVolume=e.value;break;case"alphaSynth.setMetronomeVolume":this.xp.metronomeVolume=e.value;break;case"alphaSynth.setPlaybackSpeed":this.xp.playbackSpeed=e.value;break;case"alphaSynth.setTickPosition":this.xp.tickPosition=e.value;break;case"alphaSynth.setTimePosition":this.xp.timePosition=e.value;break;case"alphaSynth.setPlaybackRange":this.xp.playbackRange=e.value;break;case"alphaSynth.setIsLooping":this.xp.isLooping=e.value;break;case"alphaSynth.setCountInVolume":this.xp.countInVolume=e.value;break;case"alphaSynth.setMidiEventsPlayedFilter":this.xp.midiEventsPlayedFilter=e.value;break;case"alphaSynth.play":this.xp.play();break;case"alphaSynth.pause":this.xp.pause();break;case"alphaSynth.playPause":this.xp.playPause();break;case"alphaSynth.stop":this.xp.stop();break;case"alphaSynth.playOneTimeMidiFile":this.xp.playOneTimeMidiFile(aa.jsObjectToMidiFile(e.midi));break;case"alphaSynth.loadSoundFontBytes":this.xp.loadSoundFont(e.data,e.append);break;case"alphaSynth.resetSoundFonts":this.xp.resetSoundFonts();break;case"alphaSynth.loadMidi":this.xp.loadMidiFile(aa.jsObjectToMidiFile(e.midi));break;case"alphaSynth.setChannelMute":this.xp.setChannelMute(e.channel,e.mute);break;case"alphaSynth.setChannelTranspositionPitch":this.xp.setChannelTranspositionPitch(e.channel,e.semitones);break;case"alphaSynth.setChannelSolo":this.xp.setChannelSolo(e.channel,e.solo);break;case"alphaSynth.setChannelVolume":this.xp.setChannelVolume(e.channel,e.volume);break;case"alphaSynth.resetChannelStates":this.xp.resetChannelStates();break;case"alphaSynth.destroy":this.xp.destroy(),this.Mp.postMessage({cmd:"alphaSynth.destroyed"});break;case"alphaSynth.applyTranspositionPitches":this.xp.applyTranspositionPitches(new Map(JSON.parse(e.transpositionPitches)))}s.startsWith("alphaSynth.exporter")&&this.Np(t)}Np(t){const e=t.data,s=e.cmd;try{switch(s){case"alphaSynth.exporter.initialize":const t=this.xp.exportAudio(e.options,aa.jsObjectToMidiFile(e.midi),e.syncPoints,e.transpositionPitches);this.vp.set(e.exporterId,t),this.Mp.postMessage({cmd:"alphaSynth.exporter.initialized",exporterId:e.exporterId});break;case"alphaSynth.exporter.render":if(this.vp.has(e.exporterId)){const t=this.vp.get(e.exporterId).render(e.milliseconds);this.Mp.postMessage({cmd:"alphaSynth.exporter.rendered",exporterId:e.exporterId,chunk:t})}else this.Mp.postMessage({cmd:"alphaSynth.exporter.error",exporterId:e.exporterId,error:new Error("Unknown exporter ID")});break;case"alphaSynth.exporter.destroy":this.vp.delete(e.exporterId)}}catch(t){this.Mp.postMessage({cmd:"alphaSynth.exporter.error",exporterId:e.exporterId,error:t})}}onPositionChanged(t){this.Mp.postMessage({cmd:"alphaSynth.positionChanged",currentTime:t.currentTime,endTime:t.endTime,currentTick:t.currentTick,endTick:t.endTick,isSeek:t.isSeek,originalTempo:t.originalTempo,modifiedTempo:t.modifiedTempo})}onPlayerStateChanged(t){this.Mp.postMessage({cmd:"alphaSynth.playerStateChanged",state:t.state,stopped:t.stopped})}onFinished(){this.Mp.postMessage({cmd:"alphaSynth.finished"})}onSoundFontLoaded(){this.Mp.postMessage({cmd:"alphaSynth.soundFontLoaded"})}onSoundFontLoadFailed(t){this.Mp.postMessage({cmd:"alphaSynth.soundFontLoadFailed",error:this.Pp(Pu.prepareForPostMessage(t))})}Pp(t){const e=JSON.parse(JSON.stringify(t));return t.message&&(e.message=t.message),t.stack&&(e.stack=t.stack),t.constructor&&t.constructor.name&&(e.type=t.constructor.name),e}onMidiLoaded(t){this.Mp.postMessage({cmd:"alphaSynth.midiLoaded",currentTime:t.currentTime,endTime:t.endTime,currentTick:t.currentTick,endTick:t.endTick,isSeek:t.isSeek,originalTempo:t.originalTempo,modifiedTempo:t.modifiedTempo})}onMidiLoadFailed(t){this.Mp.postMessage({cmd:"alphaSynth.midiLoaded",error:this.Pp(Pu.prepareForPostMessage(t))})}onReadyForPlayback(){this.Mp.postMessage({cmd:"alphaSynth.readyForPlayback"})}onMidiEventsPlayed(t){this.Mp.postMessage({cmd:"alphaSynth.midiEventsPlayed",events:t.events.map(aa.midiEventToJsObject)})}onPlaybackRangeChanged(t){this.Mp.postMessage({cmd:"alphaSynth.playbackRangeChanged",playbackRange:t.playbackRange})}}!function(t){t[t.Browser=0]="Browser",t[t.NodeJs=1]="NodeJs",t[t.BrowserModule=2]="BrowserModule"}(ds||(ds={}));class oa{characterWidths;characterHeights;constructor(t,e){this.characterWidths=t,this.characterHeights=e}}class ca{static fontSizeLookupTables=new Map;static ControlChars=32;static generateFontLookup(t){if(!ca.fontSizeLookupTables.has(t))if(Pu.isRunningInWorker||Pu.webPlatform===ds.NodeJs){const e=new oa(new Uint8Array([8]),new Uint8Array([10]));ca.fontSizeLookupTables.set(t,e)}else{const e=document.createElement("canvas").getContext("2d"),s=11;e.font=`${s}px ${t}`;const i=[],n=[];for(let t=ca.ControlChars;t<255;t++){const s=String.fromCharCode(t),r=e.measureText(s);i.push(r.width);const a=r.actualBoundingBoxDescent+r.actualBoundingBoxAscent;n.push(a)}const r=new oa(new Uint8Array(i),new Uint8Array(n));ca.fontSizeLookupTables.set(t,r)}}static measureString(t,e,s,i,n){let r;let a=e[0];for(let t=0;t<e.length;t++)if(ca.fontSizeLookupTables.has(e[t])){a=e[t];break}ca.fontSizeLookupTables.has(a)||ca.generateFontLookup(a),r=ca.fontSizeLookupTables.get(a);let h=1;i===rs.Italic&&(h*=1.1),n===as.Bold&&(h*=1.1);let o=0,c=0;for(let e=0;e<t.length;e++){const i=Math.min(r.characterWidths.length-1,t.charCodeAt(e)-ca.ControlChars);i>=0&&(o+=r.characterWidths[i]*s/11,c=Math.max(c,r.characterHeights[i]*s/11))}return h*=1.07,new Ot(o*h,c)}}class la{id=zt.newGuid();reuseViewport=!0;x=0;y=0;width=0;height=0;totalWidth=0;totalHeight=0;firstMasterBarIndex=-1;lastMasterBarIndex=-1;renderResult=null}class ua{masterBarBounds;visualBounds;realBounds;bar;beats=[];addBeat(t){t.barBounds=this,this.beats.push(t),this.masterBarBounds.addBeat(t)}findBeatAtPos(t){let e=null;for(const s of this.beats)if(!e||s.realBounds.x<t)e=s;else if(s.realBounds.x>t)break;return e}finish(t=1){this.realBounds.scaleWith(t),this.visualBounds.scaleWith(t),this.beats.sort((t,e)=>t.realBounds.x-e.realBounds.x);for(const e of this.beats)e.finish(t)}}class da{barBounds;visualBounds;onNotesX=0;realBounds;beat;notes=null;addNote(t){this.notes||(this.notes=[]),t.beatBounds=this,this.notes.push(t)}findNoteAtPos(t,e){const s=this.notes;if(!s)return null;for(const i of s){const s=i.noteHeadBounds.y+i.noteHeadBounds.h,n=i.noteHeadBounds.x+i.noteHeadBounds.w;if(i.noteHeadBounds.x<=t&&i.noteHeadBounds.y<=e&&t<=n&&e<=s)return i.note}return null}finish(t=1){if(this.realBounds.scaleWith(t),this.visualBounds.scaleWith(t),this.onNotesX*=t,this.notes)for(const e of this.notes)e.finish(t)}}class fa{index=0;isFirstOfLine=!1;visualBounds;realBounds;lineAlignedBounds;bars=[];staffSystemBounds=null;get staveGroupBounds(){return this.staffSystemBounds}addBar(t){t.masterBarBounds=this,this.bars.push(t)}findBeatAtPos(t){let e=null;for(const s of this.bars){const i=s.findBeatAtPos(t);if(i&&(!e||e.realBounds.x<i.realBounds.x)){const s=Math.abs(i.realBounds.x-t);(!e||s<1e7)&&(e=i)}}return e?e.beat:null}finish(t=1){this.realBounds.scaleWith(t),this.visualBounds.scaleWith(t),this.lineAlignedBounds.scaleWith(t),this.bars.sort((t,e)=>t.realBounds.y<e.realBounds.y?-1:t.realBounds.y>e.realBounds.y?1:t.realBounds.x<e.realBounds.x?-1:t.realBounds.x>e.realBounds.x?1:0);for(const e of this.bars)e.finish(t)}addBeat(t){this.staffSystemBounds.boundsLookup.addBeat(t)}}class pa{beatBounds;noteHeadBounds;note;finish(t=1){this.noteHeadBounds.scaleWith(t)}}class ba{index=0;visualBounds;realBounds;bars=[];boundsLookup;finish(t=1){this.realBounds.scaleWith(t),this.visualBounds.scaleWith(t);for(const e of this.bars)e.finish(t)}addBar(t){this.boundsLookup.addMasterBar(t),t.staffSystemBounds=this,this.bars.push(t)}findBarAtPos(t){let e=null;for(const s of this.bars)if(!e||s.realBounds.x<t)e=s;else if(t>s.realBounds.x+s.realBounds.w)break;return e}}class ma{toJson(){const t={},e=[];t.staffSystems=e;for(const t of this.staffSystems){const s={};s.visualBounds=this.Cp(t.visualBounds),s.realBounds=this.Cp(t.realBounds),s.bars=[];for(const e of t.bars){const t={};t.lineAlignedBounds=this.Cp(e.lineAlignedBounds),t.visualBounds=this.Cp(e.visualBounds),t.realBounds=this.Cp(e.realBounds),t.index=e.index,t.isFirstOfLine=e.isFirstOfLine,t.bars=[];for(const s of e.bars){const e={};e.visualBounds=this.Cp(s.visualBounds),e.realBounds=this.Cp(s.realBounds),e.beats=[];for(const t of s.beats){const s={};s.visualBounds=this.Cp(t.visualBounds),s.realBounds=this.Cp(t.realBounds),s.onNotesX=t.onNotesX;const i=s;if(i.beatIndex=t.beat.index,i.voiceIndex=t.beat.voice.index,i.barIndex=t.beat.voice.bar.index,i.staffIndex=t.beat.voice.bar.staff.index,i.trackIndex=t.beat.voice.bar.staff.track.index,t.notes){const e=[];s.notes=e;for(const s of t.notes){const t={};t.index=s.note.index,t.noteHeadBounds=this.Cp(s.noteHeadBounds),e.push(t)}}e.beats.push(s)}t.bars.push(e)}s.bars.push(t)}e.push(s)}return t}static fromJson(t,e){const s=new ma,i=t.staffSystems;for(const t of i){const i=new ba;i.visualBounds=ma.Ep(t.visualBounds),i.realBounds=ma.Ep(t.realBounds),s.addStaffSystem(i);for(const i of t.bars){const t=new fa;t.index=i.index,t.isFirstOfLine=i.isFirstOfLine,t.lineAlignedBounds=ma.Ep(i.lineAlignedBounds),t.visualBounds=ma.Ep(i.visualBounds),t.realBounds=ma.Ep(i.realBounds),s.addMasterBar(t);for(const s of i.bars){const i=new ua;i.visualBounds=ma.Ep(s.visualBounds),i.realBounds=ma.Ep(s.realBounds),t.addBar(i);for(const t of s.beats){const s=new da;s.visualBounds=ma.Ep(t.visualBounds),s.realBounds=ma.Ep(t.realBounds),s.onNotesX=t.onNotesX;const n=t;if(s.beat=e.tracks[n.trackIndex].staves[n.staffIndex].bars[n.barIndex].voices[n.voiceIndex].beats[n.beatIndex],t.notes){s.notes=[];for(const e of t.notes){const t=new pa,i=e;t.note=s.beat.notes[i.index],t.noteHeadBounds=ma.Ep(e.noteHeadBounds),s.addNote(t)}}i.addBeat(s)}}}}return s}static Ep(t){const e=new Us;return e.x=t.x,e.y=t.y,e.w=t.w,e.h=t.h,e}Cp(t){const e={};return e.x=t.x,e.y=t.y,e.w=t.w,e.h=t.h,e}j=new Map;Fp=new Map;Ap=null;staffSystems=[];isFinished=!1;finish(t=1){for(const e of this.staffSystems)e.finish(t);this.isFinished=!0}addStaffSystem(t){t.index=this.staffSystems.length,t.boundsLookup=this,this.staffSystems.push(t),this.Ap=t}addMasterBar(t){t.staffSystemBounds?this.Fp.set(t.index,t):(t.staffSystemBounds=this.Ap,this.Fp.set(t.index,t),this.Ap.addBar(t))}addBeat(t){this.j.has(t.beat.id)||this.j.set(t.beat.id,[]),this.j.get(t.beat.id)?.push(t)}findMasterBarByIndex(t){return this.Fp.has(t)?this.Fp.get(t):null}findMasterBar(t){const e=t.index;return this.Fp.has(e)?this.Fp.get(e):null}findBeat(t){const e=this.findBeats(t);return e?e[0]:null}findBeats(t){const e=t.id;return this.j.has(e)?this.j.get(e):null}getBeatAtPos(t,e){let s=0,i=this.staffSystems.length-1,n=-1;for(;s<=i;){const t=(i+s)/2|0,r=this.staffSystems[t];if(e>=r.realBounds.y&&e<=r.realBounds.y+r.realBounds.h){n=t;break}e<r.realBounds.y?i=t-1:s=t+1}if(-1===n)return null;const r=this.staffSystems[n].findBarAtPos(t);return r?r.findBeatAtPos(t):null}getNoteAtPos(t,e,s){const i=this.findBeats(t);if(i)for(const t of i){const i=t.findNoteAtPos(e,s);if(i)return i}return null}}class ga{Dp=Je.Page;Lp=null;Wp=null;canvas=null;score=null;tracks=null;layout=null;settings;boundsLookup=null;width=0;constructor(t){this.settings=t,this.Op(),this.Rp()}destroy(){this.score=null,this.canvas?.destroy(),this.canvas=null,this.layout=null,this.boundsLookup=null,this.tracks=null}Op(){return this.Lp!==this.settings.core.engine&&(this.canvas?.destroy(),this.canvas=Pu.getRenderEngineFactory(this.settings.core.engine).createCanvas(),this.Lp=this.settings.core.engine,!0)}Rp(){return(!this.layout||this.Dp!==this.settings.display.layoutMode)&&(this.layout=Pu.getLayoutEngineFactory(this.settings.display.layoutMode).createLayout(this),this.Dp=this.settings.display.layoutMode,!0)}renderScore(t,e,s){try{this.score=t;let i=null;if(null!=t&&null!=e){if(e){i=[];for(const s of e)s>=0&&s<t.tracks.length&&i.push(t.tracks[s])}else i=t.tracks.slice(0);0===i.length&&t.tracks.length>0&&i.push(t.tracks[0])}this.tracks=i,this.render(s)}catch(t){this.error.trigger(t)}}renderTracks(t){0===t.length?this.score=null:this.score=t[0].score,this.tracks=t,this.render()}updateSettings(t){this.settings=t}renderResult(t){try{const e=this.layout;e?(J.debug("Rendering",`Request render of lazy partial ${t}`),e.renderLazyPartial(t)):J.warning("Rendering",`Request render of lazy partial ${t} ignored, no layout exists`)}catch(t){this.error.trigger(t)}}render(t){if(0!==this.width)if(this.boundsLookup=new ma,this.Op(),this.canvas.lineWidth=1,this.canvas.settings=this.settings,this.tracks&&0!==this.tracks.length&&this.score){J.debug("Rendering",`Rendering ${this.tracks.length} tracks`);for(let t=0;t<this.tracks.length;t++){const e=this.tracks[t];J.debug("Rendering",`Track ${t}: ${e.name}`)}this.preRender.trigger(!1),this.Rp(),this.Ip(t),J.debug("Rendering","Rendering finished")}else J.debug("Rendering","Clearing rendered tracks because no score or tracks are set"),this.preRender.trigger(!1),this.Wp=null,this.Gp(),this.postRenderFinished.trigger(),J.debug("Rendering","Clearing finished");else J.warning("Rendering","AlphaTab skipped rendering because of width=0 (element invisible)",null)}resizeRender(){this.Rp()||this.Op()||this.Wp!==this.tracks||!this.tracks?(J.debug("Rendering","Starting full rerendering due to layout or canvas change",null),this.render()):this.layout.supportsResize?(J.debug("Rendering","Starting optimized rerendering for resize"),this.boundsLookup=new ma,this.preRender.trigger(!0),this.canvas.settings=this.settings,this.layout.resize(),this.Gp(),this.postRenderFinished.trigger()):J.debug("Rendering","Current layout does not support dynamic resizing, nothing was done",null),J.debug("Rendering","Resize finished")}Ip(t){J.debug("Rendering",`Rendering at scale ${this.settings.display.scale} with layout ${this.layout.name}`,null),this.layout.layoutAndRender(t),this.Wp=this.tracks,this.Gp(),this.postRenderFinished.trigger()}preRender=new mi;renderFinished=new mi;partialRenderFinished=new mi;partialLayoutFinished=new mi;postRenderFinished=new bi;error=new mi;Gp(){this.boundsLookup?.finish(this.settings.display.scale);const t=new la;t.totalHeight=this.layout.height,t.totalWidth=this.layout.width,t.renderResult=this.canvas.onRenderFinished(),this.renderFinished.trigger(t)}}class wa{Hp;Mp;constructor(t){this.Mp=t,this.Mp.addEventListener("message",this.Fl.bind(this),!1)}static init(){Pu.globalThis.alphaTabWebWorker=new wa(Pu.globalThis)}Fl(t){const e=t.data;switch(e?e.cmd:""){case"alphaTab.initialize":const t=aa.jsObjectToSettings(e.settings);J.logLevel=t.core.logLevel,this.Hp=new ga(t),this.Hp.partialRenderFinished.on(t=>{this.Mp.postMessage({cmd:"alphaTab.partialRenderFinished",result:t})}),this.Hp.partialLayoutFinished.on(t=>{this.Mp.postMessage({cmd:"alphaTab.partialLayoutFinished",result:t})}),this.Hp.renderFinished.on(t=>{this.Mp.postMessage({cmd:"alphaTab.renderFinished",result:t})}),this.Hp.postRenderFinished.on(()=>{this.Mp.postMessage({cmd:"alphaTab.postRenderFinished",boundsLookup:this.Hp.boundsLookup?.toJson()??null})}),this.Hp.preRender.on(t=>{this.Mp.postMessage({cmd:"alphaTab.preRender",resize:t})}),this.Hp.error.on(this.Vp.bind(this));break;case"alphaTab.render":this.Hp.render(e.renderHints);break;case"alphaTab.resizeRender":this.Hp.resizeRender();break;case"alphaTab.renderResult":this.Hp.renderResult(e.resultId);break;case"alphaTab.setWidth":this.Hp.width=e.width;break;case"alphaTab.renderScore":this.$p(e.fontSizes);const s=null==e.score?null:aa.jsObjectToScore(e.score,this.Hp.settings);this.zp(s,e.trackIndexes);break;case"alphaTab.updateSettings":this.Xp(e.settings)}}$p(t){if(!(t instanceof Map)){const e=t;t=new Map;for(const s in e)t.set(s,e[s])}if(t)for(const[e,s]of t)ca.fontSizeLookupTables.set(e,s)}Xp(t){sa.fromJson(this.Hp.settings,t)}zp(t,e,s){try{this.Hp.renderScore(t,e,s)}catch(t){this.Vp(t)}}Vp(t){J.error("Worker","An unexpected error occurred in worker",t),this.Mp.postMessage({cmd:"alphaTab.error",error:t})}}class ya{jp;Jp;qp=null;Yp;Kp=new ke(0,0,0,255);Qp=new Vr("Arial",10,rs.Plain);Zp;tb=0;settings;constructor(){this.jp=document.createElement("canvas"),this.jp.width=10,this.jp.height=10,this.jp.style.width="10px",this.jp.style.height="10px",this.Jp=this.jp.getContext("2d"),this.Jp.textBaseline="hanging"}destroy(){}onRenderFinished(){return null}beginRender(t,e){this.Zp=new Vr(this.settings.display.resources.smuflFontFamilyName,this.settings.display.resources.engravingSettings.musicFontSize,rs.Plain,as.Regular);const s=this.settings.display.scale;this.qp=document.createElement("canvas"),this.qp.width=t*Pu.highDpiFactor|0,this.qp.height=e*Pu.highDpiFactor|0,this.qp.style.width=`${t}px`,this.qp.style.height=`${e}px`,this.Yp=this.qp.getContext("2d"),this.Yp.textBaseline="hanging",this.Yp.scale(Pu.highDpiFactor*s,Pu.highDpiFactor*s),this.Yp.lineWidth=this.tb}endRender(){const t=this.qp;return this.qp=null,t}get color(){return this.Kp}set color(t){this.Kp.rgba!==t.rgba&&(this.Kp=t,this.Yp.strokeStyle=t.rgba,this.Yp.fillStyle=t.rgba)}get lineWidth(){return this.tb}set lineWidth(t){this.tb=t,this.Yp&&(this.Yp.lineWidth=t)}fillRect(t,e,s,i){s>0&&this.Yp.fillRect(t,e,s,i)}strokeRect(t,e,s,i){const n=this.lineWidth%2==0?0:.5;this.Yp.strokeRect(t+n,e+n,s,i)}beginPath(){this.Yp.beginPath()}closePath(){this.Yp.closePath()}moveTo(t,e){this.Yp.moveTo(t,e)}lineTo(t,e){this.Yp.lineTo(t,e)}quadraticCurveTo(t,e,s,i){this.Yp.quadraticCurveTo(t,e,s,i)}bezierCurveTo(t,e,s,i,n,r){this.Yp.bezierCurveTo(t,e,s,i,n,r)}fillCircle(t,e,s){this.Yp.beginPath(),this.Yp.arc(t,e,s,0,2*Math.PI,!0),this.fill()}strokeCircle(t,e,s){this.Yp.beginPath(),this.Yp.arc(t,e,s,0,2*Math.PI,!0),this.stroke()}fill(){this.Yp.fill(),this.Yp.beginPath()}stroke(){this.Yp.stroke(),this.Yp.beginPath()}get font(){return this.Qp}set font(t){this.Qp=t,this.Yp&&(this.Yp.font=t.toCssString(1)),this.Jp.font=t.toCssString(1)}get textAlign(){switch(this.Yp.textAlign){case"left":default:return at.Left;case"center":return at.Center;case"right":return at.Right}}set textAlign(t){switch(t){case at.Left:this.Yp.textAlign="left";break;case at.Center:this.Yp.textAlign="center";break;case at.Right:this.Yp.textAlign="right"}}get textBaseline(){switch(this.Yp.textBaseline){case"hanging":default:return ht.Top;case"middle":return ht.Middle;case"bottom":return ht.Bottom;case"alphabetic":return ht.Alphabetic}}set textBaseline(t){switch(t){case ht.Top:this.Yp.textBaseline="hanging";break;case ht.Middle:this.Yp.textBaseline="middle";break;case ht.Bottom:this.Yp.textBaseline="bottom";break;case ht.Alphabetic:this.Yp.textBaseline="alphabetic"}}beginGroup(t){}endGroup(){}fillText(t,e,s){this.Yp.fillText(t,e,s)}measureText(t){const e=this.Jp.measureText(t);return new Ot(e.width,e.actualBoundingBoxDescent+e.actualBoundingBoxAscent)}fillMusicFontSymbol(t,e,s,i,n=!1){i!==lt.None&&this.eb(t,e,s,String.fromCharCode(i),n)}fillMusicFontSymbols(t,e,s,i,n=!1){let r="";for(const t of i)t!==lt.None&&(r+=String.fromCharCode(t));this.eb(t,e,s,r,n)}eb(t,e,s,i,n){const r=this.Yp.textAlign,a=this.Yp.textBaseline,h=this.Yp.font;this.Yp.font=this.Zp.toCssString(s),this.Yp.textBaseline="alphabetic",this.Yp.textAlign=n?"center":"left",this.Yp.fillText(i,t,e),this.Yp.textBaseline=a,this.Yp.font=h,this.Yp.textAlign=r}beginRotate(t,e,s){this.Yp.save(),this.Yp.translate(t,e),this.Yp.rotate(s*Math.PI/180)}endRotate(){this.Yp.restore()}}class ka{sb;ib;tickShift=0;constructor(t,e=!1){this.sb=t,this.ib=e}addTickShift(t){this.sb.tickShift=t,this.tickShift=t}addTimeSignature(t,e,s){t+=this.tickShift;let i=0,n=s;for(;n>>=1,n>0;)i++;this.sb.addEvent(new Mi(0,t,e,i,48,8))}addRest(t,e,s){e+=this.tickShift,this.ib||this.sb.addEvent(new Pi(t,e,s))}addNote(t,e,s,i,n,r){e+=this.tickShift,this.sb.addEvent(new Ei(t,e,r,ka.nb(i),ka.nb(n))),this.sb.addEvent(new Fi(t,e+s,r,ka.nb(i),ka.nb(n)))}static nb(t){return t>127?127:t<0?0:t}addControlChange(t,e,s,i,n){e+=this.tickShift,this.sb.addEvent(new Ai(t,e,s,i,ka.nb(n)))}addProgramChange(t,e,s,i){e+=this.tickShift,this.sb.addEvent(new Di(t,e,s,i))}addTempo(t,e){t+=this.tickShift;const s=new Li(t,0);s.beatsPerMinute=e,this.sb.addEvent(s)}addBend(t,e,s,i){e+=this.tickShift,i=i>=Vt.MaxPitchWheel?Vt.MaxPitchWheel:Math.floor(i),this.sb.addEvent(new Wi(t,e,s,i))}addNoteBend(t,e,s,i,n){e+=this.tickShift,this.ib?this.addBend(t,e,s,n):(n=n*Vt.MaxPitchWheel20/Vt.MaxPitchWheel,this.sb.addEvent(new Oi(t,e,s,i,n)))}finishTrack(t,e){e+=this.tickShift,this.sb.format!==qe.MultiTrack&&0!==t||this.sb.addEvent(new Ri(t,e))}}class Sa{group;opening;iterations;closingIndex=0;constructor(t,e){this.group=t,this.opening=e,t.closings=t.closings.sort((t,e)=>t.index-e.index),this.iterations=t.closings.map(t=>0)}}!function(t){t[t.PlayingNormally=0]="PlayingNormally",t[t.DirectionJumped=1]="DirectionJumped",t[t.DirectionJumpedAlCoda=2]="DirectionJumpedAlCoda",t[t.DirectionJumpedAlDoubleCoda=3]="DirectionJumpedAlDoubleCoda",t[t.DirectionJumpedAlFine=4]="DirectionJumpedAlFine"}(fs||(fs={}));class Ba{De;rb=[];ab=new Set;hb=0;Bi=fs.PlayingNormally;shouldPlay=!0;index=0;currentTick=0;get finished(){return this.index>=this.De.masterBars.length}constructor(t){this.De=t}processCurrent(){const t=this.De.masterBars[this.index];if(this.Bi===fs.PlayingNormally){let e=t.alternateEndings;if(0===e&&(e=this.hb),t===t.repeatGroup.opening&&t.repeatGroup.isClosed&&!this.ab.has(t.repeatGroup)){const s=new Sa(t.repeatGroup,t);this.rb.push(s),this.ab.add(t.repeatGroup),this.hb=0,e=t.alternateEndings}if(0===this.rb.length||0===e)this.shouldPlay=!0;else{const t=this.rb[this.rb.length-1],s=t.iterations[t.closingIndex];this.hb=e,this.shouldPlay=!!(e&1<<s)}}else this.shouldPlay=!0;this.shouldPlay&&(this.currentTick+=t.calculateDuration())}moveNext(){this.ob()||this.cb()}lb(){this.ab.clear(),this.hb=0,this.rb=[]}ub(t,e,s){return!!t.has(e)&&(this.index=0,this.Bi=s,this.lb(),!0)}fb(t,e,s,i){if(t.has(e)){const t=this.pb(i,this.index,!0);return-1!==t&&(this.index=t,this.Bi=s,this.lb(),!0)}return!1}bb(t,e,s){if(t.has(e)){const t=this.pb(s,this.index,!1);return-1===t?(this.index++,!0):(this.index=t,this.Bi=fs.PlayingNormally,!0)}return!1}ob(){const t=this.De.masterBars[this.index],e=null!==t.directions&&t.directions.size>0;if(this.Bi===fs.PlayingNormally&&!e)return!1;if(!e)return this.index++,!0;switch(this.Bi){case fs.PlayingNormally:return!!(this.ub(t.directions,ze.JumpDaCapo,fs.DirectionJumped)||this.ub(t.directions,ze.JumpDaCapoAlCoda,fs.DirectionJumpedAlCoda)||this.ub(t.directions,ze.JumpDaCapoAlDoubleCoda,fs.DirectionJumpedAlDoubleCoda)||this.ub(t.directions,ze.JumpDaCapoAlFine,fs.DirectionJumpedAlFine))||(!!(this.fb(t.directions,ze.JumpDalSegno,fs.DirectionJumped,ze.TargetSegno)||this.fb(t.directions,ze.JumpDalSegnoAlCoda,fs.DirectionJumpedAlCoda,ze.TargetSegno)||this.fb(t.directions,ze.JumpDalSegnoAlDoubleCoda,fs.DirectionJumpedAlDoubleCoda,ze.TargetSegno)||this.fb(t.directions,ze.JumpDalSegnoAlFine,fs.DirectionJumpedAlFine,ze.TargetSegno))||!!(this.fb(t.directions,ze.JumpDalSegnoSegno,fs.DirectionJumped,ze.TargetSegnoSegno)||this.fb(t.directions,ze.JumpDalSegnoSegnoAlCoda,fs.DirectionJumpedAlCoda,ze.TargetSegnoSegno)||this.fb(t.directions,ze.JumpDalSegnoSegnoAlDoubleCoda,fs.DirectionJumpedAlDoubleCoda,ze.TargetSegnoSegno)||this.fb(t.directions,ze.JumpDalSegnoSegnoAlFine,fs.DirectionJumpedAlFine,ze.TargetSegnoSegno)));case fs.DirectionJumped:return this.index++,!0;case fs.DirectionJumpedAlCoda:return this.bb(t.directions,ze.JumpDaCoda,ze.TargetCoda)||this.index++,!0;case fs.DirectionJumpedAlDoubleCoda:return this.bb(t.directions,ze.JumpDaDoubleCoda,ze.TargetDoubleCoda)||this.index++,!0;case fs.DirectionJumpedAlFine:return t.directions.has(ze.TargetFine)?(this.index=this.De.masterBars.length,!0):(this.index++,!0)}return!0}pb(t,e,s){let i;return s?(i=this.mb(t,e),-1===i&&(i=this.gb(t,e)),i):(i=this.gb(t,e),-1===i&&(i=this.mb(t,e)),i)}gb(t,e){let s=e;for(;s<this.De.masterBars.length;){const e=this.De.masterBars[s].directions;if(e&&e.has(t))return s;s++}return-1}mb(t,e){let s=e;for(;s>=0;){const e=this.De.masterBars[s].directions;if(e&&e.has(t))return s;s--}return-1}cb(){const t=this.De.masterBars[this.index].repeatCount-1;if(this.rb.length>0&&t>0){const e=this.rb[this.rb.length-1];if(e.iterations[e.closingIndex]<t){this.index=e.opening.index,e.iterations[e.closingIndex]++;for(let t=0;t<e.closingIndex;t++)e.iterations[t]=0;e.closingIndex=0,this.hb=0}else e.closingIndex<e.group.closings.length-1?(e.closingIndex++,this.index++):(this.rb.pop(),this.ab.delete(e.group),this.index++)}else this.index++}}class _a{beat;playbackStart;constructor(t,e){this.beat=t,this.playbackStart=e}}class Ta{wb=new Map;start;end;highlightedBeats=[];nextBeat=null;previousBeat=null;get duration(){return this.end-this.start}constructor(t,e){this.start=t,this.end=e}highlightBeat(t,e){t.isEmpty&&!t.voice.isEmpty||this.wb.has(t.id)||(this.wb.set(t.id,!0),this.highlightedBeats.push(new _a(t,e)))}getVisibleBeatAtStart(t){for(const e of this.highlightedBeats)if(e.playbackStart===this.start&&t.has(e.beat.voice.bar.staff.track.index))return e.beat;return null}getVisibleBeatAtStartWithChecker(t){for(const e of this.highlightedBeats)if(e.playbackStart===this.start&&t.isVisible(e.beat))return e.beat;return null}}class xa{tick;tempo;constructor(t,e){this.tick=t,this.tempo=e}}class Ma{start=0;end=0;get tempo(){return this.tempoChanges[0].tempo}tempoChanges=[];masterBar;firstBeat=null;lastBeat=null;yb(t,e){null==this.firstBeat||null==t||null==this.lastBeat?(this.firstBeat=e,this.lastBeat=e):(e.nextBeat=t.nextBeat,e.previousBeat=t,t.nextBeat&&(t.nextBeat.previousBeat=e),t.nextBeat=e,t===this.lastBeat&&(this.lastBeat=e))}kb(t,e){null==this.firstBeat||null==t||null==this.lastBeat?(this.firstBeat=e,this.lastBeat=e):(e.previousBeat=t.previousBeat,e.nextBeat=t,t.previousBeat&&(t.previousBeat.nextBeat=e),t.previousBeat=e,t===this.firstBeat&&(this.firstBeat=e))}nextMasterBar=null;previousMasterBar=null;addBeat(t,e,i,n){const r=i+n;if(null==this.firstBeat){const s=new Ta(i,r);s.highlightBeat(t,e),this.yb(this.firstBeat,s)}else if(i>=this.lastBeat.end){const s=new Ta(this.lastBeat.end,r);s.highlightBeat(t,e),this.yb(this.lastBeat,s)}else{let n=null;if(i<this.firstBeat.start)n=this.firstBeat;else{let t=this.firstBeat;for(;null!=t;){if(i>=t.start&&i<t.end){n=t;break}t=t.nextBeat}if(null===n)throw new I(s.General,"Error on building lookup, unknown variant")}if(i<n.start)if(r===n.start){const s=new Ta(i,n.start);s.highlightBeat(t,e),this.kb(this.firstBeat,s)}else if(r<n.end){const s=new Ta(i,n.start);s.highlightBeat(t,e),this.kb(n,s);const a=new Ta(n.start,r);for(const t of n.highlightedBeats)a.highlightBeat(t.beat,t.playbackStart);a.highlightBeat(t,e),this.kb(n,a),n.start=r}else if(r===n.end){const s=new Ta(i,n.start);s.highlightBeat(t,e),n.highlightBeat(t,e),this.kb(n,s)}else{const s=new Ta(i,n.start);s.highlightBeat(t,e),n.highlightBeat(t,e),this.kb(n,s),this.addBeat(t,e,n.end,r-n.end)}else if(i>n.start)if(r===n.end){const s=new Ta(n.start,i);for(const t of n.highlightedBeats)s.highlightBeat(t.beat,t.playbackStart);n.start=i,n.highlightBeat(t,e),this.kb(n,s)}else if(r<n.end){const s=new Ta(n.start,i);this.kb(n,s);const a=new Ta(i,r);this.kb(n,a);for(const t of n.highlightedBeats)s.highlightBeat(t.beat,t.playbackStart),a.highlightBeat(t.beat,t.playbackStart);a.highlightBeat(t,e),n.start=r}else{const s=new Ta(n.start,i);for(const t of n.highlightedBeats)s.highlightBeat(t.beat,t.playbackStart);n.start=i,n.highlightBeat(t,e),this.kb(n,s),this.addBeat(t,e,n.end,r-n.end)}else if(r===n.end)n.highlightBeat(t,e);else if(r<n.end){const s=new Ta(n.start,r);for(const t of n.highlightedBeats)s.highlightBeat(t.beat,t.playbackStart);s.highlightBeat(t,e),n.start=r,this.kb(n,s)}else n.highlightBeat(t,e),this.addBeat(t,e,n.end,r-n.end)}}}!function(t){t[t.Unknown=0]="Unknown",t[t.ToNextBext=1]="ToNextBext",t[t.ToEndOfBar=2]="ToEndOfBar",t[t.ToEndOfBeat=3]="ToEndOfBeat"}(ps||(ps={}));class va{beat;masterBar;beatLookup;nextBeat=null;tickDuration=0;duration=0;cursorMode=ps.Unknown;get start(){return this.masterBar.start+this.beatLookup.start}get end(){return this.start+this.tickDuration}constructor(t){this.masterBar=t}calculateDuration(){if(1===this.masterBar.tempoChanges.length)this.duration=H.ticksToMillis(this.tickDuration,this.masterBar.tempoChanges[0].tempo);else{let t=0,e=this.start,s=this.masterBar.tempoChanges[0].tempo;const i=this.end;for(const n of this.masterBar.tempoChanges)if(n.tick<e)s=n.tempo;else{if(n.tick>i)break;t+=H.ticksToMillis(n.tick-e,s),s=n.tempo,e=n.tick}i>e&&(t+=H.ticksToMillis(i-e,s)),this.duration=t}}}class Na{Sb;constructor(t){this.Sb=t}isVisible(t){return this.Sb.has(t.voice.bar.staff.track.index)}}class Pa{_b=null;masterBarLookup=new Map;masterBars=[];multiBarRestInfo=null;playbackRange=null;findBeat(t,e,s=null){return this.findBeatWithChecker(new Na(t),e,s)}findBeatWithChecker(t,e,s=null){let i=null;if(s&&(i=this.Tb(t,s,e)),i||(i=this.xb(t,s,e,!1)),i){const t=this.playbackRange;if(null!==t&&i.start>=t.endTick)return null}return i}Tb(t,e,s){if(s>=e.start&&s<e.end)return e;if(e.nextBeat&&s>=e.nextBeat.start&&s<e.nextBeat.end&&(void 0===t||t.isVisible(e.nextBeat.beat))){const s=e.nextBeat;return this.Mb(s,t),s}return null}Nb(t,e){const s=this.multiBarRestInfo.get(t.masterBar.masterBar.index);let i=t.masterBar;for(let t=0;t<s.length&&i;t++)i=i.nextMasterBar;i?i.nextMasterBar?(t.nextBeat=this.Pb(e,i.nextMasterBar,i.nextMasterBar.start,!0),t.nextBeat?(t.tickDuration=t.nextBeat.start-t.start,t.cursorMode=ps.ToNextBext,(t.nextBeat.masterBar.masterBar.index!==i.masterBar.index+1&&(t.nextBeat.masterBar.masterBar.index!==i.masterBar.index||t.nextBeat.beat.playbackStart<=t.beat.playbackStart)||null!==this.playbackRange&&this.playbackRange.endTick<=t.nextBeat.start)&&(t.cursorMode=ps.ToEndOfBeat)):(t.tickDuration=i.nextMasterBar.end-t.start,t.cursorMode=ps.ToEndOfBeat)):(t.tickDuration=i.end-t.start,t.cursorMode=ps.ToEndOfBeat):(J.warning("Synth","MultiBar Rest Info and the nextMasterBar are out of sync, this is an unexpected error. Please report it as bug.  (broken chain fill-next)"),t.tickDuration=(t.masterBar.end-t.masterBar.start)*(s.length+1),t.cursorMode=ps.ToEndOfBeat),t.calculateDuration()}Mb(t,e){this.Fb(t)?this.Nb(t,e):this.Lb(t,e)}Lb(t,e){t.nextBeat=this.Wb(t.masterBar,t.beatLookup.nextBeat,t.end,e,!0),null==t.nextBeat&&(t.nextBeat=this.xb(e,t,t.end,!0)),t.nextBeat?(t.tickDuration=t.nextBeat.start-t.start,t.cursorMode=ps.ToNextBext,t.calculateDuration()):(t.tickDuration=t.masterBar.end-t.start,t.cursorMode=ps.ToEndOfBeat,t.calculateDuration()),t.nextBeat&&(t.nextBeat.masterBar.masterBar.index!==t.masterBar.masterBar.index+1&&(t.nextBeat.masterBar.masterBar.index!==t.masterBar.masterBar.index||t.nextBeat.beat.playbackStart<=t.beat.playbackStart)||null!==this.playbackRange&&this.playbackRange.endTick<=t.nextBeat.start)&&(t.cursorMode=ps.ToEndOfBeat)}Fb(t){return this.Ob(t.masterBar.masterBar.index,t.beat)}Ob(t,e){return this.multiBarRestInfo&&this.multiBarRestInfo.has(t)&&e.isRest&&e.voice.bar.isRestOnly}xb(t,e,s,i){let n=null;return null!=e&&(e.masterBar.start<=s&&e.masterBar.end>s?n=e.masterBar:e.masterBar.nextMasterBar&&e.masterBar.nextMasterBar.start<=s&&e.masterBar.nextMasterBar.end>s&&(n=e.masterBar.nextMasterBar)),n||(n=this.Rb(s)),n?this.Pb(t,n,s,i):null}Pb(t,e,s,i){let n=e;for(;n;){if(n.firstBeat){const e=this.Wb(n,n.firstBeat,s,t,i);if(e)return e}n=n.nextMasterBar}return null}Wb(t,e,s,i,n){if(!e)return null;let r=null,a=null;const h=s-t.start;for(;null!=e&&null==a;){if((e.start<=h||n&&h<0)&&h<e.end){if(r=e,a=e.getVisibleBeatAtStartWithChecker(i),!a)if(n){let s=t;for(;null!=s&&null==a;){for(;null!=e;){if(a=e.getVisibleBeatAtStartWithChecker(i),a){r=e,t=s;break}e=e.nextBeat}a&&r||(s=s.nextMasterBar,e=s?.firstBeat??null)}}else{let s=t;for(;null!=s&&null==a;){for(;null!=e;){if(a=e.getVisibleBeatAtStartWithChecker(i),a){r=e,t=s;break}e=e.previousBeat}a&&r||(s=s.previousMasterBar,e=s?.firstBeat??null)}}}else if(e.end>h)break;e=e?.nextBeat??null}if(null==a)return null;return this.Ib(t,r,a,n,i)}Ib(t,e,s,i,n){const r=new va(t);if(r.beat=s,r.beatLookup=e,r.tickDuration=e.end-e.start,i){if(this.Fb(r)){const s=this.multiBarRestInfo.get(t.masterBar.index);let i=t;for(let t=0;t<s.length&&i;t++)i=i.nextMasterBar;i?i.nextMasterBar?r.tickDuration=i.nextMasterBar.start-e.start:r.tickDuration=i.end-e.start:J.warning("Synth","MultiBar Rest Info and the nextMasterBar are out of sync, this is an unexpected error. Please report it as bug.  (broken chain stretch-result)")}}else this.Mb(r,n);return r.calculateDuration(),r}Rb(t){if(t<=0&&this.masterBars.length>0)return this.masterBars[0];const e=this.masterBars;let s=0,i=e.length-1;for(;s<=i;){const n=(i+s)/2|0,r=e[n];if(t>=r.start&&t<r.end)return r;t<r.start?i=n-1:s=n+1}return null}getMasterBar(t){if(!this.masterBarLookup.has(t.index)){const e=new Ma;return e.masterBar=t,e}return this.masterBarLookup.get(t.index)}getMasterBarStart(t){return this.masterBarLookup.has(t.index)?this.masterBarLookup.get(t.index).start:0}getBeatStart(t){return this.masterBarLookup.has(t.voice.bar.index)?this.masterBarLookup.get(t.voice.bar.index).start+t.playbackStart:0}addMasterBar(t){this.masterBars.push(t),this._b&&(t.previousMasterBar=this._b,this._b.nextMasterBar=t),this._b=t,this.masterBarLookup.has(t.masterBar.index)||this.masterBarLookup.set(t.masterBar.index,t)}addBeat(t,e,s){const i=this._b;if(i)if(e<0&&i.previousMasterBar){const n=i.previousMasterBar.end-i.previousMasterBar.start,r=n+e,a=r+s;if(i.previousMasterBar.addBeat(t,r,r,s),a>n){const n=s+e;i.addBeat(t,e,0,n)}}else i.addBeat(t,e,e,s)}}class Ca{noteOnly=0;untilTieOrSlideEnd=0;letRingEnd=0;beatDurationFactor=1}class Ea{firstBeatDuration=0;secondBeatStartOffset=0;secondBeatDuration=0}class Fa{durations=[];brushInfos=[]}class Aa{synthTick=0;synthTime=0;currentTempo=0;automationToSyncPoint=new Map;syncPoints;createNewSyncPoints=!1}class Da{static Hb=30;static Vb=80;De;jl;Si;$b=new Map;Ub=0;zb=new Set;tickLookup=new Pa;applyTranspositionPitches=!0;syncPoints=[];transpositionPitches=new Map;constructor(t,e,s){this.De=t,this.jl=e||new ra,this.Si=s}generate(){this.transpositionPitches.clear(),this.zb.clear(),this.Ub=0;for(const t of this.De.tracks)this.Xb(t);J.debug("Midi","Begin midi generation"),this.syncPoints=[],Da.jb(this.De,this.syncPoints,!1,(t,e,s,i,n)=>{this.Jb(t,e,s,i,n),0===t.index&&0===n&&this.qb()},(t,e,s)=>{for(const i of this.De.tracks)for(const n of i.staves)t<n.bars.length&&this.Yb(n.bars[t],e,s)},t=>{for(const e of this.De.tracks)this.Si.finishTrack(e.index,t)}),J.debug("Midi","Midi generation done")}qb(){let t=0;for(const e of this.De.tracks)for(const s of e.staves)for(const e of s.bars[0].voices)if(!e.isEmpty){const s=e.beats[0];s.playbackStart<t&&(t=s.playbackStart)}t=Math.abs(t),this.Si.addTickShift(t)}Xb(t){this.Kb(t,t.playbackInfo.primaryChannel,t.playbackInfo),t.playbackInfo.primaryChannel!==t.playbackInfo.secondaryChannel&&this.Kb(t,t.playbackInfo.secondaryChannel,t.playbackInfo)}Qb(t,e,s,i){this.$b.has(s)&&this.$b.get(s)===i||(this.Si.addProgramChange(t.index,e,s,i),this.$b.set(s,i))}Zb(t,e,s,i){const n=ge.bankToLsbMsb(i);this.Si.addControlChange(t.index,e,s,ns.BankSelectCoarse,n[1]),this.Si.addControlChange(t.index,e,s,ns.BankSelectFine,n[0])}static buildTranspositionPitches(t,e){const s=new Map;for(const i of t.tracks){const t=i.index<e.notation.transpositionPitches.length?e.notation.transpositionPitches[i.index]:-i.staves[0].transpositionPitch;s.set(i.playbackInfo.primaryChannel,t),s.set(i.playbackInfo.secondaryChannel,t)}return s}Kb(t,e,s){const i=t.index<this.jl.notation.transpositionPitches.length?this.jl.notation.transpositionPitches[t.index]:-t.staves[0].transpositionPitch;this.transpositionPitches.set(e,i);const n=Da.tm(s.volume),r=Da.tm(s.balance);this.Si.addControlChange(t.index,0,e,ns.VolumeCoarse,n),this.Si.addControlChange(t.index,0,e,ns.PanCoarse,r),this.Si.addControlChange(t.index,0,e,ns.ExpressionControllerCoarse,127),this.Si.addControlChange(t.index,0,e,ns.RegisteredParameterFine,0),this.Si.addControlChange(t.index,0,e,ns.RegisteredParameterCourse,0),this.Si.addControlChange(t.index,0,e,ns.DataEntryFine,0),this.Si.addControlChange(t.index,0,e,ns.DataEntryCoarse,Da.sm),this.Zb(t,0,e,s.bank),this.Qb(t,0,e,s.program)}static generateSyncPoints(t,e=!1){const s=[];return Da.jb(t,s,e,(t,e,s,i,n)=>{},(t,e,s)=>{},t=>{}),s}static buildModifiedTempoLookup(t){return Da.jb(t,[],!1,(t,e,s,i,n)=>{},(t,e,s)=>{},t=>{}).automationToSyncPoint}static jb(t,e,s,i,n,r){const a=new Ba(t),h=new Aa;h.currentTempo=t.tempo,h.syncPoints=e,h.createNewSyncPoints=s;let o=null;const c=new Map;for(;!a.finished;){const e=a.index,s=t.masterBars[e],r=a.currentTick;if(a.processCurrent(),a.shouldPlay){let t=c.has(e)?c.get(e):-1;t++,c.set(e,t),i(s,o,r,h.currentTempo,t);n(e,r,s.tempoAutomations.length>0?s.tempoAutomations[0].value:h.currentTempo),h.synthTick=r,Da.im(s,t,h)}a.moveNext(),o=s}if(e.length>0){const t=e[e.length-1],s=a.currentTick-t.synthTick;if(s>0){const i=new Gi;i.masterBarIndex=o.index,i.masterBarOccurence=c.get(o.index)-1,i.synthTick=a.currentTick,i.synthBpm=h.currentTempo,h.createNewSyncPoints?(i.syncBpm=t.synthBpm,i.synthBpm=t.synthBpm):1===e.length?i.syncBpm=t.synthBpm:i.syncBpm=e[e.length-2].syncBpm,i.synthTime=t.synthTime+H.ticksToMillis(s,t.synthBpm),i.syncTime=t.syncTime+H.ticksToMillis(s,i.syncBpm),h.createNewSyncPoints||t.updateSyncBpm(i.synthTime,i.syncTime),e.push(i)}}return r(a.currentTick),h}static im(t,e,s){const i=t.calculateDuration(),n=t.syncPoints,r=s.synthTick;s.createNewSyncPoints?Da.nm(t,e,s):n?Da.rm(t,e,s):Da.am(t,s);const a=r+i,h=a-s.synthTick;h>0&&(s.synthTime+=H.ticksToMillis(h,s.currentTempo),s.synthTick=a)}static nm(t,e,s){const i=s.synthTick;if(0===t.index&&0===e){s.currentTempo=t.score.tempo;const n=new Gi;n.masterBarIndex=t.index,n.masterBarOccurence=e,n.synthTick=i,n.synthBpm=s.currentTempo,n.synthTime=s.synthTime,n.syncBpm=s.currentTempo,n.syncTime=s.synthTime,s.syncPoints.push(n)}const n=t.calculateDuration();for(const r of t.tempoAutomations){const a=i+r.ratioPosition*n,h=a-s.synthTick;if(h>0&&(s.synthTick=a,s.synthTime+=H.ticksToMillis(h,s.currentTempo)),r.value!==s.currentTempo){s.currentTempo=r.value;const i=new Gi;i.masterBarIndex=t.index,i.masterBarOccurence=e,i.synthTick=a,i.synthBpm=s.currentTempo,i.synthTime=s.synthTime,i.syncBpm=s.currentTempo,i.syncTime=s.synthTime,s.syncPoints.push(i)}}}static rm(t,e,s){const i=s.synthTick,n=t.calculateDuration();let r,a=0;for(const h of t.syncPoints){if(h.syncPointValue.barOccurence!==e)continue;const o=i+h.ratioPosition*n;for(;a<t.tempoAutomations.length&&t.tempoAutomations[a].ratioPosition<=h.ratioPosition;){const e=t.tempoAutomations[a],h=i+e.ratioPosition*n;r=h-s.synthTick,r>0&&(s.synthTick=h,s.synthTime+=H.ticksToMillis(r,s.currentTempo)),s.currentTempo=e.value,a++}r=o-s.synthTick,r>0&&(s.synthTick=o,s.synthTime+=H.ticksToMillis(r,s.currentTempo)),s.syncPoints.length>0&&s.syncPoints[s.syncPoints.length-1].updateSyncBpm(s.synthTime,h.syncPointValue.millisecondOffset);const c=new Gi;c.masterBarIndex=t.index,c.masterBarOccurence=e,c.synthTick=o,c.synthBpm=s.currentTempo,c.synthTime=s.synthTime,c.syncTime=h.syncPointValue.millisecondOffset,c.syncBpm=0,s.syncPoints.push(c),s.automationToSyncPoint.set(h,c)}for(;a<t.tempoAutomations.length;){const e=t.tempoAutomations[a],h=i+e.ratioPosition*n;r=h-s.synthTick,r>0&&(s.synthTick=h,s.synthTime+=H.ticksToMillis(r,s.currentTempo)),s.currentTempo=e.value,a++}}static am(t,e){const s=e.synthTick,i=t.calculateDuration();for(const n of t.tempoAutomations){const t=s+n.ratioPosition*i,r=t-e.synthTick;r>0&&(e.synthTick=t,e.synthTime+=H.ticksToMillis(r,e.currentTempo)),e.currentTempo=n.value}}static tm(t){const e=Math.max(-32768,Math.min(32767,8*t-1));return Math.max(e,-1)+1}Jb(t,e,s,i,n){e&&e.timeSignatureDenominator===t.timeSignatureDenominator&&e.timeSignatureNumerator===t.timeSignatureNumerator||this.Si.addTimeSignature(s,t.timeSignatureNumerator,t.timeSignatureDenominator);const r=t.calculateDuration(),a=new Ma;if(t.tempoAutomations.length>0){t.tempoAutomations[0].ratioPosition>0&&a.tempoChanges.push(new xa(s,i));for(const e of t.tempoAutomations){const t=s+r*e.ratioPosition;this.Si.addTempo(t,e.value),a.tempoChanges.push(new xa(t,e.value))}}else e?a.tempoChanges.push(new xa(s,i)):(this.Si.addTempo(s,t.score.tempo),a.tempoChanges.push(new xa(s,t.score.tempo)));a.masterBar=t,a.start=s,a.end=a.start+r,this.tickLookup.addMasterBar(a)}Yb(t,e,s){const i=this.hm(t),n=this.Ub;for(const r of i.voices)this.Ub=n,this.om(r,e,t,s);const r=i.masterBar,a=r.calculateDuration(),h=r.tempoAutomations.slice();if(0===h.length)this.Ub=n+H.ticksToMillis(a,s);else{this.Ub=n;let t=e,i=s;const r=e+a;for(const e of h){const s=a*e.ratioPosition-t;s>0&&(this.Ub+=H.ticksToMillis(s,i)),i=e.value,t+=s}const o=r-t;o>0&&(this.Ub+=H.ticksToMillis(o,i))}i.id!==t.id&&this.tickLookup.addBeat(t.voices[0].beats[0],0,a)}hm(t){switch(t.simileMark){case M.Simple:t.previousBar&&(t=this.hm(t.previousBar));break;case M.FirstOfDouble:case M.SecondOfDouble:t.previousBar&&t.previousBar.previousBar&&(t=this.hm(t.previousBar.previousBar))}return t}om(t,e,s,i){if(t.isEmpty&&(!t.bar.isEmpty||0!==t.index))return;const n=s.masterBar.tempoAutomations.slice();let r=i;const a=s.masterBar.calculateDuration();for(const i of t.beats){const t=i.playbackStart/a;for(;n.length>0&&n[0].ratioPosition<=t;)r=n.shift().value;this.lm(i,e,s,r)}}um=null;lm(t,e,s,i){let n=t.playbackStart,r=t.playbackDuration;const a=t.voice.bar.masterBar.calculateDuration();t.voice.bar.isEmpty?r=a:t.voice.bar.masterBar.tripletFeel!==F.NoTripletFeel&&this.jl.player.playTripletFeel&&(this.um?(n-=this.um.secondBeatStartOffset,r=this.um.secondBeatDuration,this.um=null):(this.um=Da.dm(n,r,t),this.um&&(r=this.um.firstBeatDuration))),t.showTimer&&!this.zb.has(t.id)&&(t.timer=this.Ub,this.zb.add(t.id)),this.Ub+=H.ticksToMillis(r,i),s===t.voice.bar&&this.tickLookup.addBeat(t,n,r);const h=t.voice.bar.staff.track;for(const s of t.automations)this.fm(t,s,e);if(t.isRest)this.Si.addRest(h.index,e+n,h.playbackInfo.primaryChannel);else if(t.deadSlapped)this.pm(t,e+n);else{const s=this.bm(t),a=this.gm(t,r);for(const h of t.notes)this.wm(h,e+n,r,i,s,a)}if(t.fade!==mt.None&&this.ym(t,e+n,r),t.vibrato!==w.None){let s=240,i=3;switch(t.vibrato){case w.Slight:s=this.jl.player.vibrato.beatSlightLength,i=this.jl.player.vibrato.beatSlightAmplitude;break;case w.Wide:s=this.jl.player.vibrato.beatWideLength,i=this.jl.player.vibrato.beatWideAmplitude}this.km(e+n,t.playbackDuration,s,0,i,(e,s)=>{this.Si.addBend(t.voice.bar.staff.track.index,e,h.playbackInfo.secondaryChannel,s)})}}static dm(t,e,s){let i;switch(s.voice.bar.masterBar.tripletFeel){case F.Triplet8th:case F.Dotted8th:case F.Scottish8th:i=c.Eighth;break;case F.Triplet16th:case F.Dotted16th:case F.Scottish16th:i=c.Sixteenth;break;default:return null}const n=H.toTicks(i);if(e!==n)return null;if(t%n!==0)return null;if(!s.nextBeat||s.nextBeat.voice!==s.voice||s.playbackDuration!==n)return null;const r=new Ea;switch(s.voice.bar.masterBar.tripletFeel){case F.Triplet8th:r.firstBeatDuration=H.applyTuplet(H.toTicks(c.Quarter),3,2),r.secondBeatDuration=H.applyTuplet(H.toTicks(c.Eighth),3,2);break;case F.Dotted8th:r.firstBeatDuration=H.applyDot(H.toTicks(c.Eighth),!1),r.secondBeatDuration=H.toTicks(c.Sixteenth);break;case F.Scottish8th:r.firstBeatDuration=H.toTicks(c.Sixteenth),r.secondBeatDuration=H.applyDot(H.toTicks(c.Eighth),!1);break;case F.Triplet16th:r.firstBeatDuration=H.applyTuplet(H.toTicks(c.Eighth),3,2),r.secondBeatDuration=H.applyTuplet(H.toTicks(c.Sixteenth),3,2);break;case F.Dotted16th:r.firstBeatDuration=H.applyDot(H.toTicks(c.Sixteenth),!1),r.secondBeatDuration=H.toTicks(c.ThirtySecond);break;case F.Scottish16th:r.firstBeatDuration=H.toTicks(c.ThirtySecond),r.secondBeatDuration=H.applyDot(H.toTicks(c.Sixteenth),!1)}return r.secondBeatStartOffset=e-r.firstBeatDuration,r}pm(t,e){const s=H.toTicks(c.SixtyFourth),n=t.voice.bar.staff;if(n.tuning.length>0)for(const t of n.tuning)this.Si.addNote(n.track.index,e,s,t,H.dynamicToVelocity(i.F),n.track.playbackInfo.primaryChannel)}Sm(t){return t.hasBend||t.beat.hasWhammyBar||t.beat.vibrato!==w.None}Bm(t,e){if(this.Sm(e))return t.playbackInfo.secondaryChannel;let s=e;for(;s.isTieDestination;)if(s=s.tieOrigin,this.Sm(s))return t.playbackInfo.secondaryChannel;for(s=e;s.isTieOrigin;)if(s=s.tieDestination,this.Sm(s))return t.playbackInfo.secondaryChannel;return t.playbackInfo.primaryChannel}wm(t,e,s,i,n,r){const a=t.beat.voice.bar.staff.track,h=t.beat.voice.bar.staff;let o=t.calculateRealValue(this.applyTranspositionPitches,!0);if(t.isPercussion){const e=Jt.getArticulation(t);e&&(o=e.outputMidiNumber)}const c=null==r&&t.isStringed&&t.string<=n.length?n[t.string-1]:0,l=e+c,u=this._m(t,s,i);u.untilTieOrSlideEnd-=c,u.noteOnly-=c,u.letRingEnd-=c;const d=Da.Tm(t),f=this.Bm(a,t);let p=0;const b=Math.max(u.untilTieOrSlideEnd,u.letRingEnd);p=t.hasBend?Da.getPitchWheel(t.bendPoints[0].value):t.beat.hasWhammyBar?Da.getPitchWheel(t.beat.whammyBarPoints[0].value):t.isTieDestination||t.slideOrigin&&t.slideOrigin.slideOutType===g.Legato?-1:Da.getPitchWheel(0),p>=0&&this.Si.addNoteBend(a.index,l,f,o,p),t.beat.hasRasgueado?this.xm(a,t,l,o,d,f,r):t.ornament===dt.None?!t.isTrill||h.isPercussion?t.beat.isTremolo?this.Mm(t,l,u,o,d,f):(t.hasBend?this.vm(t,l,u,o,f,i):t.beat.hasWhammyBar&&0===t.index?this.Nm(t.beat,l,u,f,i):t.slideInType!==m.None||t.slideOutType!==g.None?this.Pm(t,l,u,o,f,i):(t.vibrato!==w.None||t.isTieDestination&&t.tieOrigin.vibrato!==w.None)&&this.Cm(t,l,u,o,f),t.isTieDestination||t.slideOrigin&&t.slideOrigin.slideOutType===g.Legato||this.Si.addNote(a.index,l,b,o,d,f)):this.Em(t,l,u,o,d,f):this.Fm(a,t,l,b,o,d,f)}static Am=[2,2,2,1,1,2,2,2,2,2,1,1];static ornamentKeysDown=[-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1];Fm(t,e,s,i,n,r,a){let h,o;const l=n%12,u=1/3;switch(e.ornament){case dt.Turn:h=[n+Da.Am[l],n,n+Da.ornamentKeysDown[l]],o=[H.toTicks(c.Sixteenth)*u,H.toTicks(c.Sixteenth)*u,H.toTicks(c.Sixteenth)*u];break;case dt.InvertedTurn:h=[n+Da.ornamentKeysDown[l],n,n+Da.Am[l]],o=[H.toTicks(c.Sixteenth)*u,H.toTicks(c.Sixteenth)*u,H.toTicks(c.Sixteenth)*u];break;case dt.UpperMordent:h=[n,n+Da.Am[l]],o=[H.toTicks(c.ThirtySecond),H.toTicks(c.ThirtySecond)];break;case dt.LowerMordent:h=[n,n+Da.ornamentKeysDown[l]],o=[H.toTicks(c.ThirtySecond),H.toTicks(c.ThirtySecond)];break;default:return}let d=1;i<H.QuarterTime&&(d=i/H.QuarterTime),r-=H.VelocityIncrement;let f=0;for(let e=0;e<h.length;e++){const i=o[e]*d;this.Si.addNote(t.index,s,i,h[e],r,a),s+=i,f+=i}const p=i-f;this.Si.addNote(t.index,s,p,n,r,a)}_m(t,e,s){const i=new Ca,n=H.toTicks(t.beat.duration);if(i.beatDurationFactor=e/n,i.noteOnly=e,i.untilTieOrSlideEnd=e,i.letRingEnd=e,t.isDead)return i.noteOnly=this.Dm(Da.Hb,e,s),i.untilTieOrSlideEnd=i.noteOnly,i.letRingEnd=i.noteOnly,i;if(t.isPalmMute)return i.noteOnly=this.Dm(Da.Vb,e,s),i.untilTieOrSlideEnd=i.noteOnly,i.letRingEnd=i.noteOnly,i;if(t.isStaccato)return i.noteOnly=e/2|0,i.untilTieOrSlideEnd=i.noteOnly,i.letRingEnd=i.noteOnly,i;if(t.isTieOrigin){const n=t.tieDestination;if(n)if(t.isTieDestination){const t=this._m(n,n.beat.playbackDuration,s);i.untilTieOrSlideEnd=e+t.untilTieOrSlideEnd}else{const e=t.beat.absolutePlaybackStart,r=this._m(n,n.beat.playbackDuration,s),a=n.beat.absolutePlaybackStart+r.untilTieOrSlideEnd;i.untilTieOrSlideEnd=a-e}}else if(t.slideOutType===g.Legato){const e=t.slideTarget;if(e){const n=t.beat.absolutePlaybackStart,r=this._m(e,e.beat.playbackDuration,s),a=e.beat.absolutePlaybackStart+r.untilTieOrSlideEnd;i.untilTieOrSlideEnd=a-n}}if(t.isLetRing&&this.jl.notation.notationMode===S.GuitarPro){let s=t.beat,n=0;const r=t.beat.voice.bar.masterBar.calculateDuration();for(;s.nextBeat;){const e=s.nextBeat;if(e.isRest)break;if(t.isStringed&&e.hasNoteOnString(t.string))break;if(s=s.nextBeat,n=s.absolutePlaybackStart-t.beat.absolutePlaybackStart+s.playbackDuration,n>r){n=r;break}}s===t.beat?i.letRingEnd=e:i.letRingEnd=n}else i.letRingEnd=i.untilTieOrSlideEnd;return i}Dm(t,e,s){const i=s*t/U.MaxPosition|0;return Math.min(i,e)}static Tm(t){let e=0;switch(!t.beat.voice.bar.staff.isPercussion&&t.hammerPullOrigin&&e--,t.isGhost&&e--,t.accentuated){case u.Normal:e++;break;case u.Heavy:e+=2}return H.dynamicToVelocity(t.dynamics,e)}ym(t,e,s){const i=t.voice.bar.staff.track;switch(t.fade){case mt.FadeIn:this.Lm(i,e,s,0,Da.tm(i.playbackInfo.volume));break;case mt.FadeOut:this.Lm(i,e,s,Da.tm(i.playbackInfo.volume),0);break;case mt.VolumeSwell:const t=s/2|0;this.Lm(i,e,t,0,Da.tm(i.playbackInfo.volume)),this.Lm(i,e+t,t,Da.tm(i.playbackInfo.volume),0)}}Lm(t,e,s,i,n){const r=(n-i)/(s=.8*s|0),a=s/120+1|0,h=e+s;for(let s=0;s<a;s++){const o=s===a-1,c=o?h:e+120*s,l=o?n:Math.round(i+(c-e)*r);this.Si.addControlChange(t.index,c,t.playbackInfo.primaryChannel,ns.VolumeCoarse,l),this.Si.addControlChange(t.index,c,t.playbackInfo.secondaryChannel,ns.VolumeCoarse,l)}}Cm(t,e,s,i,n){let r=0,a=0;switch(t.vibrato!==w.None?t.vibrato:t.isTieDestination?t.tieOrigin.vibrato:w.Slight){case w.Slight:r=this.jl.player.vibrato.noteSlightLength,a=this.jl.player.vibrato.noteSlightAmplitude;break;case w.Wide:r=this.jl.player.vibrato.noteWideLength,a=this.jl.player.vibrato.noteWideAmplitude;break;default:return}const h=t.beat.voice.bar.staff.track;let o=0;if(t.isTieDestination&&t.tieOrigin.hasBend){const e=t.tieOrigin.bendPoints;o=e[e.length-1].value}this.km(e,s.noteOnly,r,o,a,(t,e)=>{this.Si.addNoteBend(h.index,t,n,i,e)})}vibratoResolution=16;km(t,e,s,i,n,r){const a=this.vibratoResolution,h=s/2|0,o=t+e;for(;t<o;){let e=0;const c=t+s<o?s:o-t;for(;e<c;){const s=i+n*Math.sin(e*Math.PI/h);r(t+e|0,Da.getPitchWheel(s)),e+=a}t+=s}r(0|o,Da.getPitchWheel(i))}static sm=16;static Wm=Vt.DefaultPitchWheel/Da.sm;static Om=6;static Rm=150;static getPitchWheel(t){return Vt.DefaultPitchWheel+t/2*Da.Wm}Pm(t,e,s,i,n,r){const a=t.slideOutType===g.Legato?s.noteOnly:s.untilTieOrSlideEnd,h=[],o=t.beat.voice.bar.staff.track,c=this.jl.player.slide.simpleSlidePitchOffset,l=Math.floor(U.MaxPosition*this.jl.player.slide.simpleSlideDurationRatio),u=Math.floor(U.MaxPosition*this.jl.player.slide.shiftSlideDurationRatio);switch(t.slideInType){case m.IntoFromAbove:h.push(new U(0,c)),h.push(new U(l,0));break;case m.IntoFromBelow:h.push(new U(0,-c)),h.push(new U(l,0))}switch(t.slideOutType){case g.Legato:case g.Shift:h.push(new U(u,0));const e=2*(t.slideTarget.calculateRealValue(this.applyTranspositionPitches,!0)-t.calculateRealValue(this.applyTranspositionPitches,!0));h.push(new U(U.MaxPosition,e));break;case g.OutDown:h.push(new U(U.MaxPosition-l,0)),h.push(new U(U.MaxPosition,-c));break;case g.OutUp:h.push(new U(U.MaxPosition-l,0)),h.push(new U(U.MaxPosition,c))}this.Im(e,a,h,r,(t,e)=>{this.Si.addNoteBend(o.index,t,n,i,e)})}vm(t,e,s,i,n,h){const o=t.bendPoints,c=t.beat.voice.bar.staff.track,u=(t,e)=>{this.Si.addNoteBend(c.index,t,n,i,e)};let d,f=null;if(t.isTieOrigin&&this.jl.notation.extendBendArrowsOnTiedNotes){let e=t;for(;e.isTieOrigin&&!e.tieDestination.hasBend&&e.tieDestination.vibrato===w.None;)e=e.tieDestination;d=e.beat.absolutePlaybackStart-t.beat.absolutePlaybackStart+this._m(e,e.beat.playbackDuration,h).noteOnly}else if(t.isTieOrigin&&t.beat.graceType!==l.None){switch(t.tieDestination.bendType){case a.Bend:case a.BendRelease:case a.PrebendBend:f=t.tieDestination.bendPoints[1].value;break;case a.Prebend:case a.PrebendRelease:f=t.tieDestination.bendPoints[0].value}d=Math.max(s.noteOnly,H.millisToTicks(this.jl.player.songBookBendDuration,h))}else d=s.noteOnly;o[0].value>0&&!t.isContinuedBend&&e>0&&e--;const p=Math.min(d,H.millisToTicks(this.jl.player.songBookBendDuration,h));let b=[];switch(t.bendType){case a.Custom:b=o;break;case a.Bend:case a.Release:switch(t.bendStyle){case r.Default:b=o;break;case r.Gradual:b.push(new U(0,t.bendPoints[0].value)),(!f||f<t.bendPoints[1].value)&&(f=t.bendPoints[1].value),b.push(new U(U.MaxPosition,f));break;case r.Fast:return(!f||f<t.bendPoints[1].value)&&(f=t.bendPoints[1].value),void(t.beat.graceType===l.BendGrace?this.Gm(e,d,!0,[t.bendPoints[0].value,f],p,h,u):this.Gm(e,d,!1,[t.bendPoints[0].value,f],p,h,u))}break;case a.BendRelease:switch(t.bendStyle){case r.Default:b=o;break;case r.Gradual:b.push(new U(0,t.bendPoints[0].value)),b.push(new U(U.MaxPosition/2|0,t.bendPoints[1].value)),b.push(new U(U.MaxPosition,t.bendPoints[2].value));break;case r.Fast:return void this.Gm(e,d,!1,[t.bendPoints[0].value,t.bendPoints[1].value,t.bendPoints[2].value],p,h,u)}break;case a.Hold:case a.Prebend:b=o;break;case a.PrebendBend:switch(t.bendStyle){case r.Default:b=o;break;case r.Gradual:b.push(new U(0,t.bendPoints[0].value)),b.push(new U(U.MaxPosition,t.bendPoints[1].value));break;case r.Fast:return u(e,0|Da.getPitchWheel(t.bendPoints[0].value)),(!f||f<t.bendPoints[1].value)&&(f=t.bendPoints[1].value),void this.Gm(e,d,!1,[t.bendPoints[0].value,f],p,h,u)}break;case a.PrebendRelease:switch(t.bendStyle){case r.Default:b=o;break;case r.Gradual:b.push(new U(0,t.bendPoints[0].value)),b.push(new U(U.MaxPosition,t.bendPoints[1].value));break;case r.Fast:return u(e,0|Da.getPitchWheel(t.bendPoints[0].value)),void this.Gm(e,d,!1,[t.bendPoints[0].value,t.bendPoints[1].value],p,h,u)}}this.Im(e,d,b,h,u)}Gm(t,e,s,i,n,r,a){const h=s?t:t+e-n,o=n/(i.length-1);for(let t=0;t<i.length-1;t++){const e=Da.getPitchWheel(i[t]),s=Da.getPitchWheel(i[t+1]),n=h+o*t;this.Hm(n,o,e,s,r,a)}}Nm(t,e,s,i,n){const a=t.whammyBarPoints,h=t.voice.bar.staff.track,o=s.noteOnly;a[0].value>0&&!t.isContinuedWhammy&&e--;const c=(t,e)=>{this.Si.addBend(h.index,t,i,e)};let l=[];switch(t.whammyBarType){case pt.Custom:l=a;break;case pt.Dive:switch(t.whammyStyle){case r.Default:l=a;break;case r.Gradual:l.push(new U(0,a[0].value)),l.push(new U(U.MaxPosition,a[1].value));break;case r.Fast:const t=Math.min(o,H.millisToTicks(this.jl.player.songBookBendDuration,n));return void this.Gm(e,o,!1,[a[0].value,a[1].value],t,n,c)}break;case pt.Dip:switch(t.whammyStyle){case r.Default:l=a;break;case r.Gradual:l.push(new U(0,a[0].value)),l.push(new U(U.MaxPosition/2|0,a[1].value)),l.push(new U(U.MaxPosition,a[2].value));break;case r.Fast:const t=Math.min(o,H.millisToTicks(this.jl.player.songBookDipDuration,n));return void this.Gm(e,o,!0,[a[0].value,a[1].value,a[2].value],t,n,c)}break;case pt.Hold:case pt.Predive:l=a;break;case pt.PrediveDive:switch(t.whammyStyle){case r.Default:l=a;break;case r.Gradual:l.push(new U(0,a[0].value)),l.push(new U(U.MaxPosition/2|0,a[0].value)),l.push(new U(U.MaxPosition,a[1].value));break;case r.Fast:const t=Da.getPitchWheel(a[0].value);this.Si.addBend(h.index,e,i,0|t);const s=Math.min(o,H.millisToTicks(this.jl.player.songBookBendDuration,n));return void this.Gm(e,o,!1,[a[0].value,a[1].value],s,n,c)}}this.Im(e,o,l,n,c)}Im(t,e,s,i,n){const r=e/U.MaxPosition;for(let e=0;e<s.length-1;e++){const a=s[e],h=s[e+1],o=Da.getPitchWheel(a.value),c=Da.getPitchWheel(h.value),l=r*(h.offset-a.offset),u=t+r*a.offset;this.Hm(u,l,o,c,i,n)}}Hm(t,e,s,i,n,r){const a=H.ticksToMillis(e,n),h=Math.abs(i-s)/Da.Wm,o=Math.max(Da.Om*h,a/Da.Rm),c=e/o,l=(i-s)/o,u=t+e;for(let e=0;e<o;e++)r(0|t,Math.round(s)),s+=l,t+=c;r(0|u,i)}xm(t,e,s,i,n,r,a){let h=s;for(let s=0;s<a.durations.length;s++){const o=a.brushInfos[s],c=e.isStringed&&e.string<=o.length?o[e.string-1]:0,l=a.durations[s];this.Si.addNote(t.index,h+c,l-c,i,n,r),h+=l}}Em(t,e,s,i,n,r){const a=t.beat.voice.bar.staff.track,h=t.stringTuning+t.trillFret;let o=H.toTicks(t.trillSpeed),c=!0,l=e;const u=e+s.untilTieOrSlideEnd;for(;l+10<u;)l+o>=u&&(o=u-l),this.Si.addNote(a.index,l,o,c?i:h,n,r),c=!c,l+=o}Mm(t,e,s,i,n,r){const a=t.beat.voice.bar.staff.track;if(0===t.beat.tremoloPicking.marks)return;let h=t.beat.tremoloPicking.getDurationAsTicks(t.beat.duration)*s.beatDurationFactor,o=e;const c=e+s.untilTieOrSlideEnd;for(;o+10<c;)o+h>=c&&(h=c-o),this.Si.addNote(a.index,o,h,i,n,r),o+=h}static Vm=new Map([[yt.Ii,[h.BrushDown,h.BrushUp]],[yt.Mi,[h.BrushDown,h.BrushDown]],[yt.MiiTriplet,[h.BrushDown,h.BrushDown,h.BrushUp]],[yt.MiiAnapaest,[h.BrushDown,h.BrushDown,h.BrushUp]],[yt.PmpTriplet,[h.BrushUp,h.BrushDown,h.BrushDown]],[yt.PmpAnapaest,[h.BrushUp,h.BrushDown,h.BrushDown]],[yt.PeiTriplet,[h.BrushUp,h.BrushDown,h.BrushDown]],[yt.PeiAnapaest,[h.BrushUp,h.BrushDown,h.BrushDown]],[yt.PaiTriplet,[h.BrushUp,h.BrushDown,h.BrushDown]],[yt.PaiAnapaest,[h.BrushUp,h.BrushDown,h.BrushDown]],[yt.AmiTriplet,[h.BrushDown,h.BrushDown,h.BrushDown]],[yt.AmiAnapaest,[h.BrushDown,h.BrushDown,h.BrushDown]],[yt.Ppp,[h.None,h.BrushDown,h.BrushUp]],[yt.Amii,[h.BrushDown,h.BrushDown,h.BrushDown,h.BrushUp]],[yt.Amip,[h.BrushDown,h.BrushDown,h.BrushDown,h.BrushUp]],[yt.Eami,[h.BrushDown,h.BrushDown,h.BrushDown,h.BrushDown]],[yt.Eamii,[h.BrushDown,h.BrushDown,h.BrushDown,h.BrushDown,h.BrushUp]],[yt.Peami,[h.BrushDown,h.BrushDown,h.BrushDown,h.BrushDown,h.BrushUp]]]);static $m=new Map([[yt.Ii,[H.toTicks(c.Eighth),H.toTicks(c.Eighth)]],[yt.Mi,[H.toTicks(c.Eighth),H.toTicks(c.Eighth)]],[yt.MiiTriplet,[H.toTicks(c.Eighth)/3,H.toTicks(c.Eighth)/3,H.toTicks(c.Eighth)/3]],[yt.MiiAnapaest,[H.toTicks(c.Sixteenth),H.toTicks(c.Sixteenth),H.toTicks(c.Eighth)]],[yt.PmpTriplet,[H.toTicks(c.Eighth)/3,H.toTicks(c.Eighth)/3,H.toTicks(c.Eighth)/3]],[yt.PmpAnapaest,[H.toTicks(c.Sixteenth)/3,H.toTicks(c.Sixteenth)/3,H.toTicks(c.Eighth)/3]],[yt.PeiTriplet,[H.toTicks(c.Eighth)/3,H.toTicks(c.Eighth)/3,H.toTicks(c.Eighth)/3]],[yt.PeiAnapaest,[H.toTicks(c.Sixteenth),H.toTicks(c.Sixteenth),H.toTicks(c.Eighth)]],[yt.PaiTriplet,[H.toTicks(c.Eighth)/3,H.toTicks(c.Eighth)/3,H.toTicks(c.Eighth)/3]],[yt.PaiAnapaest,[H.toTicks(c.Sixteenth),H.toTicks(c.Sixteenth),H.toTicks(c.Eighth)]],[yt.AmiTriplet,[H.toTicks(c.Eighth)/3,H.toTicks(c.Eighth)/3,H.toTicks(c.Eighth)/3]],[yt.AmiAnapaest,[H.toTicks(c.Sixteenth)/3,H.toTicks(c.Sixteenth)/3,H.toTicks(c.Eighth)/3]],[yt.Ppp,[H.toTicks(c.Sixteenth)/3,H.toTicks(c.Sixteenth)/3,H.toTicks(c.Eighth)/3]],[yt.Amii,[H.toTicks(c.Sixteenth)/3,H.toTicks(c.Sixteenth)/3,H.toTicks(c.Sixteenth)/3,H.toTicks(c.Eighth)]],[yt.Amip,[H.toTicks(c.Sixteenth)/3,H.toTicks(c.Sixteenth)/3,H.toTicks(c.Sixteenth)/3,H.toTicks(c.Eighth)]],[yt.Eami,[H.toTicks(c.Sixteenth),H.toTicks(c.Sixteenth),H.toTicks(c.Sixteenth),H.toTicks(c.Sixteenth)]],[yt.Eamii,[H.toTicks(c.Sixteenth)/5,H.toTicks(c.Sixteenth)/5,H.toTicks(c.Sixteenth)/5,H.toTicks(c.Sixteenth)/5,H.toTicks(c.Sixteenth)/5]],[yt.Peami,[H.toTicks(c.Sixteenth)/5,H.toTicks(c.Sixteenth)/5,H.toTicks(c.Sixteenth)/5,H.toTicks(c.Sixteenth)/5,H.toTicks(c.Sixteenth)/5]]]);gm(t,e){if(!t.hasRasgueado)return null;const s=new Fa,i=Da.$m.get(t.rasgueado).reduce((t,e)=>t+e,0);s.durations=Da.$m.get(t.rasgueado).map(t=>e*t/i),s.brushInfos=new Array(s.durations.length);const n=H.toTicks(c.Sixteenth);let r=0,a=0;for(const e of t.notes)e.isTieDestination||(r|=1<<e.string-1,a++);const o=Da.Vm.get(t.rasgueado);for(let e=0;e<s.durations.length;e++){const i=s.durations[e]*n/H.QuarterTime,c=new Int32Array(t.voice.bar.staff.tuning.length);s.brushInfos[e]=c;const l=o[e];l!==h.None&&this.Um(t,c,l===h.ArpeggioDown||l===h.BrushDown,r,a,i)}return s}bm(t){const e=new Int32Array(t.voice.bar.staff.tuning.length);if(t.brushType){let s=0,i=0;for(const e of t.notes)e.isTieDestination||(s|=1<<e.string-1,i++);this.Um(t,e,t.brushType===h.ArpeggioDown||t.brushType===h.BrushDown,s,i,t.brushDuration)}return e}Um(t,e,s,i,n,r){if(t.notes.length>0){let a=0;const h=r/(n-1)|0;for(let n=0;n<t.voice.bar.staff.tuning.length;n++){const t=s?n:e.length-1-n;i&1<<t&&(e[t]=a,a+=h)}}return e}fm(t,e,s){switch(e.type){case n.Instrument:this.Qb(t.voice.bar.staff.track,t.playbackStart+s,t.voice.bar.staff.track.playbackInfo.primaryChannel,255&e.value),this.Qb(t.voice.bar.staff.track,t.playbackStart+s,t.voice.bar.staff.track.playbackInfo.secondaryChannel,255&e.value);break;case n.Bank:this.Zb(t.voice.bar.staff.track,t.playbackStart+s,t.voice.bar.staff.track.playbackInfo.primaryChannel,e.value),this.Zb(t.voice.bar.staff.track,t.playbackStart+s,t.voice.bar.staff.track.playbackInfo.secondaryChannel,e.value);break;case n.Balance:const i=Da.tm(e.value);this.Si.addControlChange(t.voice.bar.staff.track.index,t.playbackStart+s,t.voice.bar.staff.track.playbackInfo.primaryChannel,ns.PanCoarse,i),this.Si.addControlChange(t.voice.bar.staff.track.index,t.playbackStart+s,t.voice.bar.staff.track.playbackInfo.secondaryChannel,ns.PanCoarse,i);break;case n.Volume:const r=Da.tm(e.value);this.Si.addControlChange(t.voice.bar.staff.track.index,t.playbackStart+s,t.voice.bar.staff.track.playbackInfo.primaryChannel,ns.VolumeCoarse,r),this.Si.addControlChange(t.voice.bar.staff.track.index,t.playbackStart+s,t.voice.bar.staff.track.playbackInfo.secondaryChannel,ns.VolumeCoarse,r)}}prepareSingleBeat(t){let e=-1,s=-1,i=t;for(;i&&(-1===e||-1===s);){for(const i of t.automations)switch(i.type){case n.Instrument:s=i.value;break;case n.Tempo:e=i.value}i=i.previousBeat}const r=t.voice.bar.staff.track,a=t.voice.bar.masterBar;-1===e&&(e=a.score.tempo);const h=t.playbackStart/a.calculateDuration();for(const t of a.tempoAutomations){if(!(t.ratioPosition<=h))break;e=t.value}-1===s&&(s=r.playbackInfo.program);const o=r.playbackInfo.volume;this.Xb(r),this.Si.addTimeSignature(0,a.timeSignatureNumerator,a.timeSignatureDenominator),this.Si.addTempo(0,e);const c=Da.tm(o);return this.Si.addControlChange(0,0,r.playbackInfo.primaryChannel,ns.VolumeCoarse,c),this.Si.addControlChange(0,0,r.playbackInfo.secondaryChannel,ns.VolumeCoarse,c),e}generateSingleBeat(t){const e=this.prepareSingleBeat(t);this.lm(t,-t.playbackStart,t.voice.bar,e)}generateSingleNote(t){const e=this.prepareSingleBeat(t.beat);this.wm(t,0,t.beat.playbackDuration,e,new Int32Array(t.beat.voice.bar.staff.tuning.length),null)}}class La{onAttach(t){}onDetach(t){}placeBeatCursor(t,e,s){const i=e.barBounds.masterBarBounds.visualBounds;t.transitionToX(0,s),t.setBounds(s,i.y,1,i.h)}placeBarCursor(t,e){const s=e.barBounds.masterBarBounds.visualBounds;t.setBounds(s.x,s.y,s.w,s.h)}transitionBeatCursor(t,e,s,i,n,r){const a=r===ps.ToNextBext?2:1;i=s+(i-s)*a,n*=a,t.transitionToX(n,i)}}class Wa{onAttach(t){}onDetach(t){}placeBeatCursor(t,e,s){const i=e.barBounds.masterBarBounds.visualBounds;t.transitionToX(0,s),t.setBounds(s,i.y,1,i.h)}placeBarCursor(t,e){const s=e.barBounds.masterBarBounds.visualBounds;t.setBounds(s.x,s.y,s.w,s.h)}transitionBeatCursor(t,e,s,i,n,r){this.placeBeatCursor(t,e,s)}}!function(t){t[t.PreNotes=0]="PreNotes",t[t.OnNotes=1]="OnNotes",t[t.MiddleNotes=2]="MiddleNotes",t[t.Stem=3]="Stem",t[t.PostNotes=4]="PostNotes",t[t.EndBeat=5]="EndBeat"}(bs||(bs={}));class Oa{x;y;width=0;height=0;renderer;constructor(t,e){this.x=t,this.y=e}getBoundingBoxTop(){return this.y}getBoundingBoxBottom(){return this.getBoundingBoxTop()+this.height}doLayout(){}paint(t,e,s){}}class Ra extends Oa{scaleToWidth(t){this.width=t}}class Ia extends Ra{zm=[];Xm=0;beat;preNotes;onNotes;getLowestNoteY(t){return this.onNotes.getLowestNoteY(t)}getHighestNoteY(t){return this.onNotes.getHighestNoteY(t)}get beatId(){return this.beat.id}get isLastOfVoice(){return this.beat.isLastOfVoice}get displayDuration(){return this.beat.displayDuration}get graceIndex(){return this.beat.graceIndex}get graceType(){return this.beat.graceType}get absoluteDisplayStart(){return this.beat.absoluteDisplayStart}get graceGroup(){return this.beat.graceGroup}get voiceIndex(){return this.beat.voice.index}get isFirstOfTupletGroup(){return this.beat.hasTuplet&&this.beat.tupletGroup.beats[0].id===this.beat.id}get tupletGroup(){return this.beat.tupletGroup}get onTimeX(){return this.onNotes.x+this.onNotes.onTimeX}constructor(t){super(0,0),this.beat=t,this.zm=[]}getNoteY(t,e){return this.onNotes.y+this.onNotes.getNoteY(t,e)}getRestY(t){return this.onNotes.y+this.onNotes.getRestY(t)}getNoteX(t,e){return this.onNotes.x+this.onNotes.getNoteX(t,e)}addTie(t){t.renderer=this.renderer,this.zm.push(t),this.renderer.registerTie(t)}getBoundingBoxTop(){let t=zt.minBoundingBox(this.preNotes.getBoundingBoxTop(),this.onNotes.getBoundingBoxTop());return Number.isNaN(t)&&(t=this.renderer.middleYPosition),t}getBoundingBoxBottom(){let t=zt.maxBoundingBox(this.preNotes.getBoundingBoxBottom(),this.onNotes.getBoundingBoxBottom());return Number.isNaN(t)&&(t=this.renderer.middleYPosition),t}drawBeamHelperAsFlags(t){return t.hasFlag(!1,void 0)}get postBeatStretch(){return this.onNotes.computedWidth+this.Xm-this.onNotes.onTimeX}registerLayoutingInfo(t){const e=this.preNotes.computedWidth+this.onNotes.onTimeX;let s=this.postBeatStretch;for(const t of this.zm){s+=t.width}t.addBeatSpring(this,e,s),t.setBeatSizes(this,{preBeatSize:this.preNotes.width,onBeatSize:this.onNotes.width})}applyLayoutingInfo(t){this.updateWidth()}doLayout(){this.preNotes.x=0,this.preNotes.renderer=this.renderer,this.preNotes.container=this,this.preNotes.doLayout(),this.onNotes.x=this.preNotes.x+this.preNotes.width,this.onNotes.renderer=this.renderer,this.onNotes.container=this,this.onNotes.doLayout(),this.createBeatTies(),this.updateWidth()}createBeatTies(){let t=this.beat.notes.length-1;for(;t>=0;)this.createTies(this.beat.notes[t--])}doMultiVoiceLayout(){}updateWidth(){let t=this.preNotes.width+this.onNotes.width,e=0;for(const t of this.zm){const s=t;s.width>e&&(e=s.width)}this.Xm=e,t+=e,this.width=t}createTies(t){}static getGroupId(t){return`b${t.id}`}paint(t,e,s){if(this.preNotes.isEmpty&&this.onNotes.isEmpty&&0===this.zm.length)return;s.beginGroup(Ia.getGroupId(this.beat)),this.preNotes.paint(t+this.x,e+this.y,s),this.onNotes.paint(t+this.x,e+this.y,s);const i=t-this.renderer.beatGlyphsStart-this.renderer.x,n=e-this.renderer.y;for(let t=0,e=this.zm.length;t<e;t++){const e=this.zm[t];e.renderer=this.renderer,e.paint(i,n,s)}s.endGroup()}buildBoundingsLookup(t,e,s){const i=new da;if(i.beat=this.beat,this.beat.isEmpty)i.visualBounds=new Us,i.visualBounds.x=e+this.x,i.visualBounds.y=t.visualBounds.y,i.visualBounds.w=this.width,i.visualBounds.h=t.visualBounds.h,i.realBounds=new Us,i.realBounds.x=e+this.x,i.realBounds.y=t.realBounds.y,i.realBounds.w=this.width,i.realBounds.h=t.realBounds.h,i.onNotesX=e+this.x+this.onNotes.x+this.onNotes.onTimeX;else{i.visualBounds=new Us,i.visualBounds.x=e+this.x,this.preNotes.isEmpty?this.onNotes.isEmpty?i.visualBounds.x=e+this.x:i.visualBounds.x=e+this.x+this.onNotes.x:i.visualBounds.x=e+this.x+this.preNotes.x;let s=0;s=this.onNotes.isEmpty?this.preNotes.isEmpty?e+this.x+this.width:e+this.x+this.preNotes.x+this.preNotes.width:e+this.x+this.onNotes.x+this.onNotes.onTimeX+this.postBeatStretch,i.visualBounds.w=s-i.visualBounds.x,i.visualBounds.y=t.visualBounds.y,i.visualBounds.h=t.visualBounds.h,i.realBounds=new Us,i.realBounds.x=e+this.x,i.realBounds.y=t.realBounds.y,i.realBounds.w=this.width,i.realBounds.h=t.realBounds.h,i.onNotesX=e+this.x+this.onNotes.x+this.onNotes.onTimeX}t.addBeat(i),this.renderer.settings.core.includeNoteBounds&&this.onNotes.buildBoundingsLookup(i,e+this.x,s+this.y)}getBeatX(t,e=!1){switch(t){case bs.PreNotes:return this.preNotes.x;case bs.OnNotes:return this.onNotes.x;case bs.MiddleNotes:return this.onNotes.x+this.onNotes.middleX;case bs.Stem:return this.onNotes.x+this.onNotes.stemX;case bs.PostNotes:const t=e?this.renderer.layoutingInfo.getBeatSizes(this.beat)?.onBeatSize??this.onNotes.width:this.onNotes.width;return this.onNotes.x+t;case bs.EndBeat:return this.width}return this.preNotes.x}}class Ga{jm;Jm;jl;qm=0;De=null;Ym=null;get instance(){return this.jm}set instance(t){this.jm=t;const e=this.Jm;if(e)for(const t of e)t();if(t){const e=[];e.push(t.preRender.on(t=>this.preRender.trigger(t))),e.push(t.renderFinished.on(t=>this.renderFinished.trigger(t))),e.push(t.partialRenderFinished.on(t=>this.partialRenderFinished.trigger(t))),e.push(t.partialLayoutFinished.on(t=>this.partialLayoutFinished.trigger(t))),e.push(t.postRenderFinished.on(()=>this.postRenderFinished.trigger())),e.push(t.error.on(t=>this.error.trigger(t))),this.Jm=e,this.jl&&t.updateSettings(this.jl),t.width=this.qm,null!==this.De&&t.renderScore(this.De,this.Ym)}else this.Jm=void 0}get boundsLookup(){return this.jm?this.jm.boundsLookup:null}get width(){return this.jm?this.jm.width:0}set width(t){this.qm=t,this.jm&&(this.jm.width=t)}render(t){this.jm?.render(t)}resizeRender(){this.jm?.resizeRender()}renderScore(t,e,s){this.De=t,this.Ym=e,this.jm?.renderScore(t,e,s)}renderResult(t){this.jm?.renderResult(t)}updateSettings(t){this.jl=t,this.jm?.updateSettings(t)}destroy(){this.jm?.destroy(),this.jm=void 0}preRender=new mi;renderFinished=new mi;partialRenderFinished=new mi;partialLayoutFinished=new mi;postRenderFinished=new bi;error=new mi}class Ha{oldWidth=0;newWidth=0;settings=null}class Va{api;lastScroll=-1;constructor(t){this.api=t}[Symbol.dispose](){}forceScrollTo(t){this.Km(t,!0),this.lastScroll=-1}Km(t,e){const s=this.calculateLastScroll(t);(s!==this.lastScroll||e)&&(this.lastScroll=s,this.doScroll(t))}onBeatCursorUpdating(t,e,s,i,n,r){this.Km(t,!1)}}class $a extends Va{calculateLastScroll(t){return t.barBounds.masterBarBounds.realBounds.y}doScroll(t){const e=this.api.uiFacade,s=this.api.settings,i=e.getScrollContainer(),n=e.getOffset(i,this.api.container),r=t.barBounds.masterBarBounds.realBounds.y+s.player.scrollOffsetY;e.scrollToY(i,n.y+r,this.api.settings.player.scrollSpeed)}}class Ua extends Va{calculateLastScroll(t){return t.barBounds.masterBarBounds.realBounds.y}doScroll(t){const e=this.api.uiFacade,s=this.api.settings,i=e.getScrollContainer(),n=i.scrollTop+e.getOffset(null,i).h,r=t.barBounds.masterBarBounds;if(r.visualBounds.y+r.visualBounds.h>=n||r.visualBounds.y<i.scrollTop){const t=r.realBounds.y+s.player.scrollOffsetY;e.scrollToY(i,t,s.player.scrollSpeed)}}}class za{Qm;Zm=-1;tg;constructor(t){this.Qm=t,this.tg=t.uiFacade.getScrollContainer().resize.on(()=>{const e=t.uiFacade.getScrollContainer(),s=t.settings.player.scrollOffsetX,i=e.width+s;t.uiFacade.setCanvasOverflow(t.canvasElement,i,!0)})}[Symbol.dispose](){this.Qm.uiFacade.setCanvasOverflow(this.Qm.canvasElement,0,!0),this.tg()}forceScrollTo(t){const e=this.Qm.uiFacade,s=this.Qm.settings,i=e.getScrollContainer(),n=t.barBounds.masterBarBounds.realBounds.y+s.player.scrollOffsetY;e.scrollToY(i,n,0),this.Zm=-1}onBeatCursorUpdating(t,e,s,i,n,r){const a=this.Qm.uiFacade,h=this.Qm.settings,o=t.barBounds.masterBarBounds,c=o.realBounds.y+h.player.scrollOffsetY;if(c===this.Zm&&r>0)return;const l=a.getScrollContainer();if(a.scrollToY(l,c,0),0===r)return void(this.Zm=-1);this.Zm=c;const u=c+o.realBounds.h,d=this.eg(o);a.scrollToY(l,u,d)}eg(t){const e=t.staffSystemBounds.bars,s=this.Qm.tickCache;let i=0;const n=this.Qm.score.masterBars;for(const t of e){const e=n[t.index],r=s.getMasterBar(e),a=s.getMasterBar(e).tempoChanges;let h=a[0].tempo,o=a[0].tick;for(let t=1;t<a.length;t++){const e=a[t].tick-o;i+=H.ticksToMillis(e,h),h=a[t].tempo,o=a[t].tick}const c=r.end-o;i+=H.ticksToMillis(c,h)}return i}}class Xa extends Va{calculateLastScroll(t){return t.barBounds.masterBarBounds.visualBounds.x}doScroll(t){const e=this.api.uiFacade,s=this.api.settings,i=e.getScrollContainer(),n=t.barBounds.masterBarBounds.realBounds.x+s.player.scrollOffsetX;e.scrollToX(i,n,s.player.scrollSpeed)}}class ja extends Va{calculateLastScroll(t){return t.barBounds.masterBarBounds.visualBounds.x}doScroll(t){const e=this.api.uiFacade,s=this.api.settings,i=e.getScrollContainer(),n=i.scrollLeft+e.getOffset(null,i).w,r=t.barBounds.masterBarBounds;if(r.visualBounds.x+r.visualBounds.w>=n||r.visualBounds.x<i.scrollLeft){const t=r.realBounds.x+s.player.scrollOffsetX;e.scrollToX(i,t,s.player.scrollSpeed)}}}class Ja{Qm;Zm=-1;tg;constructor(t){this.Qm=t,this.tg=t.uiFacade.getScrollContainer().resize.on(()=>{const e=t.uiFacade.getScrollContainer(),s=t.settings.player.scrollOffsetX,i=e.width+s;t.uiFacade.setCanvasOverflow(t.canvasElement,i,!1)})}[Symbol.dispose](){this.tg(),this.Qm.uiFacade.setCanvasOverflow(this.Qm.canvasElement,0,!1)}forceScrollTo(t){const e=this.Qm.uiFacade,s=this.Qm.settings,i=e.getScrollContainer(),n=t.onNotesX+s.player.scrollOffsetY;e.scrollToY(i,n,0),this.Zm=-1}onBeatCursorUpdating(t,e,s,i,n,r){const a=this.Qm.uiFacade;if(n===this.Zm&&r>0)return;const h=this.Qm.settings,o=a.getScrollContainer();if(a.scrollToX(o,i+h.player.scrollOffsetX,0),0===r)return void(this.Zm=-1);this.Zm=n;const c=n+h.player.scrollOffsetX;a.scrollToX(o,c,r)}}class qa{activeBeats;constructor(t){this.activeBeats=t}}class Ya{startTick=0;endTick=0}class Ka{sg=1;Hf=0;Vf=0;ig=1;ng=!1;rg=[];jm;Jm;midiTickShift=0;constructor(){this.ready=new bi(()=>this.isReady),this.readyForPlayback=new bi(()=>this.isReadyForPlayback),this.midiLoaded=new mi(()=>this.jm?.loadedMidiInfo??null),this.stateChanged=new mi(()=>new Ui(this.state,!1)),this.positionChanged=new mi(()=>this.currentPosition),this.playbackRangeChanged=new mi(()=>{const t=this.playbackRange;return t?new Qn(t):null})}get instance(){return this.jm}set instance(t){this.jm=t;const e=this.Jm;if(e)for(const t of e)t();if(t){const e=[];e.push(t.ready.on(()=>this.ready.trigger())),e.push(t.readyForPlayback.on(()=>this.readyForPlayback.trigger())),e.push(t.finished.on(()=>this.finished.trigger())),e.push(t.soundFontLoaded.on(()=>this.soundFontLoaded.trigger())),e.push(t.soundFontLoadFailed.on(t=>this.soundFontLoadFailed.trigger(t))),e.push(t.midiLoaded.on(t=>{this.midiLoaded.trigger(this.ag(t))})),e.push(t.midiLoadFailed.on(t=>this.midiLoadFailed.trigger(t))),e.push(t.stateChanged.on(t=>this.stateChanged.trigger(t))),e.push(t.positionChanged.on(t=>{this.positionChanged.trigger(this.ag(t))})),e.push(t.midiEventsPlayed.on(t=>this.midiEventsPlayed.trigger(t))),e.push(t.playbackRangeChanged.on(t=>this.playbackRangeChanged.trigger(this.hg(t)))),this.Jm=e,this.isReady?(t.masterVolume=this.sg,t.metronomeVolume=this.Hf,t.countInVolume=this.Vf,t.playbackSpeed=this.ig,t.isLooping=this.ng,t.midiEventsPlayedFilter=this.rg,this.ready.trigger()):e.push(t.ready.on(()=>{t.masterVolume=this.sg,t.metronomeVolume=this.Hf,t.countInVolume=this.Vf,t.playbackSpeed=this.ig,t.isLooping=this.ng,t.midiEventsPlayedFilter=this.rg}))}else this.Jm=void 0}get output(){return this.jm.output}get isReady(){return!!this.jm&&this.jm.isReady}get isReadyForPlayback(){return!!this.jm&&this.jm.isReadyForPlayback}get state(){return this.jm?this.jm.state:Ke.Paused}get logLevel(){return J.logLevel}set logLevel(t){J.logLevel=t,this.jm&&(this.jm.logLevel=t)}get masterVolume(){return this.sg}set masterVolume(t){t=Math.max(t,Vt.MinVolume),this.sg=t,this.jm&&(this.jm.masterVolume=t)}get metronomeVolume(){return this.Hf}set metronomeVolume(t){t=Math.max(t,Vt.MinVolume),this.Hf=t,this.jm&&(this.jm.metronomeVolume=t)}get playbackSpeed(){return this.ig}set playbackSpeed(t){this.ig=t,this.jm&&(this.jm.playbackSpeed=t)}get loadedMidiInfo(){return this.jm?this.ag(this.jm.loadedMidiInfo):void 0}get currentPosition(){return this.jm?this.ag(this.jm.currentPosition):new zi(0,0,0,0,!1,120,120)}get tickPosition(){return this.jm?this.og(this.jm.tickPosition):0}set tickPosition(t){this.jm&&(this.jm.tickPosition=this.cg(t))}get timePosition(){return this.jm?this.jm.timePosition:0}set timePosition(t){this.jm&&(this.jm.timePosition=t)}get playbackRange(){return this.jm?this.lg(this.jm.playbackRange):null}set playbackRange(t){this.jm&&(this.jm.playbackRange=this.ug(t))}get isLooping(){return this.ng}set isLooping(t){this.ng=t,this.jm&&(this.jm.isLooping=t)}get countInVolume(){return this.Vf}set countInVolume(t){this.Vf=t,this.jm&&(this.jm.countInVolume=t)}get midiEventsPlayedFilter(){return this.rg}set midiEventsPlayedFilter(t){this.rg=t,this.jm&&(this.jm.midiEventsPlayedFilter=t)}destroy(){this.jm&&(this.jm.destroy(),this.jm=void 0)}play(){return!!this.jm&&this.jm.play()}pause(){this.jm&&this.jm.pause()}playPause(){this.jm&&this.jm.playPause()}stop(){this.jm&&this.jm.stop()}playOneTimeMidiFile(t){this.jm&&this.jm.playOneTimeMidiFile(t)}loadSoundFont(t,e){this.jm&&this.jm.loadSoundFont(t,e)}resetSoundFonts(){this.jm&&this.jm.resetSoundFonts()}loadMidiFile(t){this.jm&&this.jm.loadMidiFile(t)}loadBackingTrack(t){this.jm&&this.jm.loadBackingTrack(t)}updateSyncPoints(t){this.jm&&this.jm.updateSyncPoints(t)}applyTranspositionPitches(t){this.jm&&this.jm.applyTranspositionPitches(t)}setChannelTranspositionPitch(t,e){this.jm&&this.jm.setChannelTranspositionPitch(t,e)}setChannelMute(t,e){this.jm&&this.jm.setChannelMute(t,e)}resetChannelStates(){this.jm&&this.jm.resetChannelStates()}setChannelSolo(t,e){this.jm&&this.jm.setChannelSolo(t,e)}setChannelVolume(t,e){this.jm&&this.jm.setChannelVolume(t,e)}ready;readyForPlayback;finished=new bi;soundFontLoaded=new bi;soundFontLoadFailed=new mi;midiLoaded;midiLoadFailed=new mi;stateChanged;positionChanged;midiEventsPlayed=new mi;playbackRangeChanged;hg(t){if(null==t.playbackRange)return t;return this.midiTickShift>0?new Qn(this.lg(t.playbackRange)):t}lg(t){if(null==t)return t;const e=this.midiTickShift;if(e>0){const s=new Ya;return s.startTick=t.startTick-e,s.endTick=t.endTick-e,s}return t}ug(t){if(null==t)return t;const e=this.midiTickShift;if(e>0){const s=new Ya;return s.startTick=t.startTick+e,s.endTick=t.endTick+e,s}return t}ag(t){if(!t)return t;const e=this.midiTickShift;return e>0?new zi(t.currentTime,t.endTime,t.currentTick-e,t.endTick-e,t.isSeek,t.originalTempo,t.modifiedTempo):t}og(t){return t-this.midiTickShift}cg(t){return t+this.midiTickShift}}class Qa{xf=new qn;masterVolume=1;metronomeVolume=0;outSampleRate=44100;currentTempo=120;timeSignatureNumerator=4;timeSignatureDenominator=4;activeVoiceCount=0;output;noteOffAll(t){}resetSoft(){}resetPresets(){}loadPresets(t,e,s,i){}setupMetronomeChannel(t){}synthesizeSilent(t){this.fakeSynthesize()}dg(t){}dispatchEvent(t){this.xf.enqueue(t)}synthesize(t,e,s){return this.fakeSynthesize()}fakeSynthesize(){const t=[];for(;!this.xf.isEmpty;){const e=this.xf.dequeue();e.isMetronome&&this.metronomeVolume>0||e.event&&this.dg(e.event),t.push(e)}return t}applyTranspositionPitches(t){}setChannelTranspositionPitch(t,e){}channelSetMute(t,e){}channelSetSolo(t,e){}resetChannelStates(){}channelSetMixVolume(t,e){}hasSamplesForProgram(t){return!0}hasSamplesForPercussion(t){return!0}}class Za extends er{fg;constructor(t,e){super(t,new Qa,e),this.synthesizer.output=t,this.fg=t,t.timeUpdate.on(e=>{const s=this.sequencer.mainTimePositionFromBackingTrack(e,t.backingTrackDuration);this.sequencer.fillMidiEventQueueToEndTime(s),this.synthesizer.fakeSynthesize(),this.updateTimePosition(s,!1),this.checkForFinish()})}updateMasterVolume(t){super.updateMasterVolume(t),this.fg.masterVolume=t}updatePlaybackSpeed(t){super.updatePlaybackSpeed(t),this.fg.playbackRate=t}onSampleRequest(){}loadMidiFile(t){this.isSoundFontLoaded||(this.isSoundFontLoaded=!0,this.soundFontLoaded.trigger()),super.loadMidiFile(t)}updateTimePosition(t,e){super.updateTimePosition(t,e),e&&this.fg.seekTo(this.sequencer.mainTimePositionToBackingTrack(t,this.fg.backingTrackDuration))}loadBackingTrack(t){const e=t.backingTrack;e&&(this.fg.loadBackingTrack(e),this.timePosition=0)}updateSyncPoints(t){this.sequencer.mainUpdateSyncPoints(t),this.tickPosition=this.tickPosition}}class th{sampleRate=44100;pg=0;Si;get handler(){return this.Si}set handler(t){t&&0!==this.pg&&(t.seekTo(this.pg),this.pg=0),this.Si=t}get backingTrackDuration(){return this.handler?.backingTrackDuration??0}get playbackRate(){return this.handler?.playbackRate??1}set playbackRate(t){const e=this.handler;e&&(e.playbackRate=t)}get masterVolume(){return this.handler?.masterVolume??1}set masterVolume(t){const e=this.handler;e&&(e.masterVolume=t)}seekTo(t){const e=this.handler;e?e.seekTo(t):this.pg=t}loadBackingTrack(t){}open(t){this.ready.trigger()}updatePosition(t){this.timeUpdate.trigger(t)}play(){this.handler?.play()}destroy(){}pause(){this.handler?.pause()}addSamples(t){}resetSamples(){}activate(){}ready=new bi;samplesPlayed=new mi;timeUpdate=new mi;sampleRequest=new bi;async enumerateOutputDevices(){return[]}async setOutputDevice(t){}async getOutputDevice(){return null}}class eh extends Za{get handler(){return this.output.handler}set handler(t){this.output.handler=t}constructor(t){super(new th,t)}}class sh{cursorWrapper;barCursor;beatCursor;selectionWrapper;constructor(t,e,s,i){this.cursorWrapper=t,this.barCursor=e,this.beatCursor=s,this.selectionWrapper=i}}class ih{bounds=null;isVisible(t){const e=this.bounds;return!!e&&null!==e.findBeat(t)}}class nh{bg=0;Ym=null;mg=null;gg=new ih;wg=!1;De=null;yg=[];kg=us.Disabled;xp;Hp;Sg;Bg;_g;get midiTickShift(){return this.xp.midiTickShift}get actualPlayerMode(){return this.kg}uiFacade;container;get renderer(){return this.Hp}get score(){return this.De}settings;get tracks(){return this.yg}canvasElement;constructor(t,e){this.uiFacade=t,this.container=t.rootContainer,this.activeBeatsChanged=new mi(()=>this.xp.state===Ke.Playing&&this.Tg?new qa(this.Tg.beatLookup.highlightedBeats.map(t=>t.beat)):null),this.playedBeatChanged=new mi(()=>this.xp.state===Ke.Playing&&this.Tg?this.Tg.beat:null),this.scoreLoaded=new mi(()=>this.De?this.De:null),this.midiLoaded=new mi(()=>this.xp.loadedMidiInfo??null),t.initialize(this,e),J.logLevel=this.settings.core.logLevel,this.settings.handleBackwardsCompatibility(),Pu.printEnvironmentInfo(!1),this.canvasElement=t.createCanvasElement(),this.container.appendChild(this.canvasElement),this.Hp=new Ga,this.settings.core.useWorkers&&this.uiFacade.areWorkersSupported&&Pu.getRenderEngineFactory(this.settings.core.engine).supportsWorkers?this.Hp.instance=this.uiFacade.createWorkerRenderer():this.Hp.instance=new ga(this.settings),this.container.resize.on(Pu.throttle(()=>{this.wg||this.container.width!==this.Hp.width&&this.triggerResize()},t.resizeThrottle));const s=new Ha;s.oldWidth=this.Hp.width,s.newWidth=0|this.container.width,s.settings=this.settings,this.xg(s),this.Hp.preRender.on(this.Mg.bind(this)),this.Hp.renderFinished.on(t=>{this.Gp(t)}),this.Hp.postRenderFinished.on(()=>{const t=Date.now()-this.bg;J.debug("rendering",`Rendering completed in ${t}ms`),this.vg()}),this.Hp.preRender.on(t=>{this.bg=Date.now()}),this.Hp.partialLayoutFinished.on(t=>this.Ng(t,!1)),this.Hp.partialRenderFinished.on(this.Pg.bind(this)),this.Hp.renderFinished.on(t=>{this.Ng(t,!0)}),this.Hp.error.on(this.onError.bind(this)),this.Cg(),this.settings.player.playerMode!==us.Disabled&&this.Eg(),this.Fg(),this.uiFacade.beginInvoke(()=>{this.uiFacade.initialRender()})}Cg(){const t=new Ka;this.xp=t,t.ready.on(()=>{this.loadMidiForScore()}),t.readyForPlayback.on(()=>{if(this.Ag(),this.tracks)for(const e of this.tracks){const s=e.playbackInfo.volume/16;t.setChannelVolume(e.playbackInfo.primaryChannel,s),t.setChannelVolume(e.playbackInfo.secondaryChannel,s)}}),t.soundFontLoaded.on(this.Dg.bind(this)),t.soundFontLoadFailed.on(t=>{this.onError(t)}),t.midiLoaded.on(this.Lg.bind(this)),t.midiLoadFailed.on(t=>{this.onError(t)}),t.stateChanged.on(this.Wg.bind(this)),t.positionChanged.on(this.Og.bind(this)),t.midiEventsPlayed.on(this.Rg.bind(this)),t.playbackRangeChanged.on(this.Ig.bind(this)),t.finished.on(this.Gg.bind(this))}destroy(){this.wg=!0,this.xp.destroy(),this.uiFacade.destroy(),this.Hp.destroy()}updateSettings(){this.settings.handleBackwardsCompatibility();const t=this.score;t&&zt.applyPitchOffsets(this.settings,t),this.Hg(),this.Hp.updateSettings(this.settings),this.Eg(),this.Vg()}Hg(){const t=this.Hp;this.settings.core.useWorkers&&this.uiFacade.areWorkersSupported&&Pu.getRenderEngineFactory(this.settings.core.engine).supportsWorkers?t.instance instanceof ga&&(t.destroy(),t.instance=this.uiFacade.createWorkerRenderer()):t.instance instanceof ga||(t.destroy(),t.instance=new ga(this.settings))}load(t,e){try{return this.uiFacade.load(t,t=>{this.renderScore(t,e)},t=>{this.onError(t)})}catch(t){return this.onError(t),!1}}renderScore(t,e,s){const i=[];if(e)if(0===e.length)t.tracks.length>0&&i.push(t.tracks[0]);else if(1===e.length&&-1===e[0])for(const e of t.tracks)i.push(e);else for(const s of e)s>=0&&s<=t.tracks.length&&i.push(t.tracks[s]);else t.tracks.length>0&&i.push(t.tracks[0]);this.$g(t,i,s)}renderTracks(t,e){if(t.length>0){const i=t[0].score;for(const e of t)if(e.score!==i)return void this.onError(new I(s.General,"All rendered tracks must belong to the same score."));this.$g(i,t,e)}}$g(t,e,s){if(zt.applyPitchOffsets(this.settings,t),t!==this.score){this.De=t,this.yg=e,this.Ug=null,this.Ym=[];for(const t of e)this.Ym.push(t.index);this.mg=new Set(this.Ym),this.zg(t),this.loadMidiForScore(),this.render(s)}else{this.yg=e;const i=zt.computeFirstDisplayedBarIndex(t,this.settings),n=zt.computeLastDisplayedBarIndex(t,this.settings,i);this.Ug&&(this.Ug.multiBarRestInfo=zt.buildMultiBarRestInfo(this.tracks,i,n)),this.Ym=[];for(const t of e)this.Ym.push(t.index);this.mg=new Set(this.Ym),this.render(s)}}triggerResize(){if(this.container.isVisible){const t=new Ha;t.oldWidth=this.Hp.width,t.newWidth=this.container.width,t.settings=this.settings,this.xg(t),this.Hp.updateSettings(this.settings),this.Hp.width=this.container.width,this.Hp.resizeRender()}else J.warning("Rendering","AlphaTab container was invisible while autosizing, waiting for element to become visible",null),this.uiFacade.rootContainerBecameVisible.on(()=>{J.debug("Rendering","AlphaTab container became visible, doing autosizing",null),this.triggerResize()})}Ng(t,e){e&&(this.canvasElement.width=t.totalWidth,this.canvasElement.height=t.totalHeight,this.Xg&&(this.Xg.width=t.totalWidth,this.Xg.height=t.totalHeight)),(t.width>0||t.height>0)&&this.uiFacade.beginAppendRenderResults(t),e&&this.uiFacade.beginAppendRenderResults(null)}Pg(t){t&&t.renderResult&&this.uiFacade.beginUpdateRenderResults(t)}tex(t,e){try{const s=new Le;s.logErrors=!0,s.initFromString(t,this.settings);const i=s.readScore();this.renderScore(i,e)}catch(t){this.onError(t)}}loadSoundFont(t,e=!1){return this.uiFacade.loadSoundFont(t,e)}resetSoundFonts(){this.xp.resetSoundFonts()}render(t){this.uiFacade.canRender?(this.Hp.width=this.container.width,this.Hp.renderScore(this.score,this.Ym,t)):this.uiFacade.canRenderChanged.on(()=>this.render(t))}get customCursorHandler(){return this._g}set customCursorHandler(t){if(this._g===t)return;const e=this._g??this.Bg;if(this._g=t,this.Xg){const s=new sh(this.Xg,this.jg,this.Jg,this.qg);e?.onDetach(s),t?t?.onDetach(s):this.Bg&&this.Bg.onAttach(s)}}Ug=null;customScrollHandler;get tickCache(){return this.Ug}get boundsLookup(){return this.Hp.boundsLookup}get player(){return this.xp.instance?this.xp:null}get isReadyForPlayback(){return this.xp.isReadyForPlayback}get playerState(){return this.xp.state}get masterVolume(){return this.xp.masterVolume}set masterVolume(t){this.xp.masterVolume=t}get metronomeVolume(){return this.xp.metronomeVolume}set metronomeVolume(t){this.xp.metronomeVolume=t}get countInVolume(){return this.xp.countInVolume}set countInVolume(t){this.xp.countInVolume=t}get midiEventsPlayedFilter(){return this.xp.midiEventsPlayedFilter}set midiEventsPlayedFilter(t){this.xp.midiEventsPlayedFilter=t}get tickPosition(){return this.xp.tickPosition}set tickPosition(t){this.xp.tickPosition=t}get timePosition(){return this.xp.timePosition}set timePosition(t){this.xp.timePosition=t}get endTick(){return this.xp.currentPosition.endTick}get endTime(){return this.xp.currentPosition.endTime}get playbackRange(){return this.xp.playbackRange}set playbackRange(t){this.xp.playbackRange=t,this.Ug&&(this.Ug.playbackRange=t),this.Yg(t)}get playbackSpeed(){return this.xp.playbackSpeed}set playbackSpeed(t){this.xp.playbackSpeed=t}get isLooping(){return this.xp.isLooping}set isLooping(t){this.xp.isLooping=t}Kg(){this.xp.destroy(),this.Qg=0,this.Zg()}Eg(){let t=this.settings.player.playerMode;if(t===us.EnabledAutomatic){const e=this.score;if(!e)return!1;t=e?.backingTrack?.rawAudioFile?us.EnabledBackingTrack:us.EnabledSynthesizer}let e=null;if(t===this.kg)return this.tw(),!1;switch(this.Kg(),this.tw(),t){case us.Disabled:e=null;break;case us.EnabledSynthesizer:e=this.uiFacade.createWorkerPlayer();break;case us.EnabledBackingTrack:e=this.uiFacade.createBackingTrackPlayer();break;case us.EnabledExternalMedia:e=new eh(this.settings.player.bufferTimeInMilliseconds)}return this.kg=t,!!e&&(this.xp.instance=e,!1)}loadMidiForScore(){if(!this.score)return;const t=this.score;J.debug("AlphaTab","Generating Midi");const e=new Ti,s=new ka(e),i=new Da(t,this.settings,s),n=zt.computeFirstDisplayedBarIndex(t,this.settings),r=zt.computeLastDisplayedBarIndex(t,this.settings,n);i.tickLookup.multiBarRestInfo=zt.buildMultiBarRestInfo(this.tracks,n,r),i.applyTranspositionPitches=!1,i.generate(),this.Ug=i.tickLookup,this.Ug.playbackRange=this.playbackRange,this.ew(e);const a=this.xp;a.midiTickShift=s.tickShift,a.loadMidiFile(e),a.loadBackingTrack(t),a.updateSyncPoints(i.syncPoints),a.applyTranspositionPitches(i.transpositionPitches)}updateSyncPoints(){if(!this.score)return;const t=this.score;this.xp.updateSyncPoints(Da.generateSyncPoints(t))}changeTrackVolume(t,e){for(const s of t)this.xp.setChannelVolume(s.playbackInfo.primaryChannel,e),this.xp.setChannelVolume(s.playbackInfo.secondaryChannel,e)}changeTrackSolo(t,e){for(const s of t)this.xp.setChannelSolo(s.playbackInfo.primaryChannel,e),this.xp.setChannelSolo(s.playbackInfo.secondaryChannel,e)}changeTrackMute(t,e){for(const s of t)this.xp.setChannelMute(s.playbackInfo.primaryChannel,e),this.xp.setChannelMute(s.playbackInfo.secondaryChannel,e)}changeTrackTranspositionPitch(t,e){for(const s of t)this.xp.setChannelTranspositionPitch(s.playbackInfo.primaryChannel,e),this.xp.setChannelTranspositionPitch(s.playbackInfo.secondaryChannel,e)}play(){return this.xp.play()}pause(){this.xp.pause()}playPause(){this.xp.playPause()}stop(){this.xp.stop()}playBeat(t){const e=new Ti,s=new ka(e);new Da(t.voice.bar.staff.track.score,this.settings,s).generateSingleBeat(t),this.xp.playOneTimeMidiFile(e)}playNote(t){const e=new Ti,s=new ka(e);new Da(t.beat.voice.bar.staff.track.score,this.settings,s).generateSingleNote(t),this.xp.playOneTimeMidiFile(e)}Xg=null;jg=null;Jg=null;qg=null;Qg=0;Tg=null;sw=null;iw=!0;nw=Ke.Paused;rw=null;Zg(){if(!this.Xg)return;const t=this.customCursorHandler??this.Bg;t?.onDetach(new sh(this.Xg,this.jg,this.Jg,this.qg)),this.uiFacade.destroyCursors(),this.Xg=null,this.jg=null,this.Jg=null,this.qg=null}aw(){if(this.Xg)return;const t=this.uiFacade.createCursors();if(t){this.Xg=t.cursorWrapper,this.jg=t.barCursor,this.Jg=t.beatCursor,this.qg=t.selectionWrapper;const e=this.customCursorHandler??this.Bg;e?.onAttach(t),this.iw=!0}null!==this.Tg&&this.hw(this.Tg,!1,this.Qg>10,1,!0)}tw(){this.ow(),this.cw();const t=this.lw;t?this.aw():!t&&this.Xg&&this.Zg()}uw=!1;ow(){const t=this.Bg,e=this.settings.player.enableAnimatedBeatCursor;void 0!==t&&this.uw===e||(this.Bg=e?new La:new Wa)}dw=cs.Off;fw=!0;cw(){const t=this.Sg,e=this.settings.player.scrollMode,s=Pu.getLayoutEngineFactory(this.settings.display.layoutMode).vertical;if(this.dw!==e||this.fw!==s){if(t){t[Symbol.dispose]();const e=this.uiFacade.getScrollContainer();this.uiFacade.stopScrolling(e)}switch(e){case cs.Off:this.Sg=void 0;break;case cs.Continuous:this.Sg=s?new $a(this):new Xa(this);break;case cs.OffScreen:this.Sg=s?new Ua(this):new ja(this);break;case cs.Smooth:this.Sg=s?new za(this):new Ja(this)}}}pw(t,e,s,i=!1,n=!1){this.Qg=t;const r=this.Ug;if(r){const a=r.findBeatWithChecker(this.gg,t,this.Tg);a&&this.hw(a,e,i,s,n||this.playerState===Ke.Paused)}}hw(t,e,s,i,n=!1){const r=t.beat;if(!r)return;const a=this.Hp.boundsLookup;if(!a)return;const h=this.Tg,o=this.rw,c=this.nw;if(!n&&r===h?.beat&&a===o&&c===this.xp.state&&h?.start===t.start)return;const l=a.findBeat(r);l&&(this.Tg=t,this.rw=a,this.nw=this.xp.state,this.uiFacade.beginInvoke(()=>{this.bw(t,e,a,l,s,i)}))}scrollToCursor(){const t=this.sw;if(t){const e=this.customScrollHandler??this.Sg;e&&e.forceScrollTo(t)}}bw(t,e,s,i,n,r){const a=t.beat,h=t.nextBeat?.beat;let o=t.duration;const c=t.beatLookup.highlightedBeats,l=t.cursorMode,u=this.customCursorHandler??this.Bg,d=this.Jg,f=this.jg,p=i.barBounds.masterBarBounds,b=p.visualBounds,m=this.sw;this.sw=i,f&&u.placeBarCursor(f,i);const g=this.xp.state===Ke.Playing&&!e;let w=i.realBounds.x+i.realBounds.w,y=null;h&&l===ps.ToNextBext&&(y=s.findBeat(h),y&&y.barBounds.masterBarBounds.staffSystemBounds===p.staffSystemBounds&&(w=y.onNotesX));let k=i.onNotesX;if(d){const t=w-i.onNotesX,e=this.Qg-this.Tg.start,s=this.Tg.tickDuration>0?e/this.Tg.tickDuration:0;if(k=i.onNotesX+t*s,o-=o*s,o/=r,g){(!m||this.iw||b.y!==m.barBounds.masterBarBounds.visualBounds.y||k<m.onNotesX||p.index>m.barBounds.masterBarBounds.index+1)&&u.placeBeatCursor(d,i,k),this.uiFacade.beginInvoke(()=>{u.transitionBeatCursor(d,i,k,w,o,l)})}else o=0,u.placeBeatCursor(d,i,k);this.iw=!1}else this.iw=!0;this.uiFacade.removeHighlights();let S=!1;if(g){if(this.settings.player.enableElementHighlighting)for(const t of c){const e=Ia.getGroupId(t.beat);this.uiFacade.highlightElements(e,a.voice.bar.index)}n=!e,S=!0}if(n&&!this.mw&&this.settings.player.scrollMode!==cs.Off){const t=this.customScrollHandler??this.Sg;t&&t.onBeatCursorUpdating(i,null===y?void 0:y,l,k,w,o)}S&&(this.gw(a),this.ww(new qa(c.map(t=>t.beat))))}playedBeatChanged;gw(t){this.wg||(this.playedBeatChanged.trigger(t),this.uiFacade.triggerEvent(this.container,"playedBeatChanged",t))}activeBeatsChanged;ww(t){this.wg||(this.activeBeatsChanged.trigger(t),this.uiFacade.triggerEvent(this.container,"activeBeatsChanged",t))}mw=!1;yw=!1;kw;Sw;beatMouseDown=new mi;beatMouseMove=new mi;beatMouseUp=new mi;noteMouseDown=new mi;noteMouseMove=new mi;noteMouseUp=new mi;get lw(){return this.settings.player.playerMode!==us.Disabled&&this.settings.player.enableCursor}Bw(t,e){this.wg||(this.lw&&this.settings.player.enableUserInteraction&&(this.kw={beat:e},this.Sw=void 0),this.mw=!0,this.beatMouseDown.trigger(e),this.uiFacade.triggerEvent(this.container,"beatMouseDown",e,t))}_w(t,e){this.wg||(this.yw=!0,this.noteMouseDown.trigger(e),this.uiFacade.triggerEvent(this.container,"noteMouseDown",e,t))}Tw(t,e){this.wg||(this.settings.player.enableUserInteraction&&(this.Sw&&this.Sw.beat===e||(this.Sw={beat:e},this.xw(this.kw,this.Sw))),this.beatMouseMove.trigger(e),this.uiFacade.triggerEvent(this.container,"beatMouseMove",e,t))}Mw(t,e){this.wg||(this.noteMouseMove.trigger(e),this.uiFacade.triggerEvent(this.container,"noteMouseMove",e,t))}Nw(t,e){this.wg||(this.lw&&this.settings.player.enableUserInteraction&&this.applyPlaybackRangeFromHighlight(),this.beatMouseUp.trigger(e),this.uiFacade.triggerEvent(this.container,"beatMouseUp",e,t),this.mw=!1)}Pw(t,e){this.wg||(this.noteMouseUp.trigger(e),this.uiFacade.triggerEvent(this.container,"noteMouseUp",e,t),this.yw=!1)}Yg(t){if(this.Ug)if(t){const e=this.Ug.findBeat(this.mg,t.startTick),s=this.Ug.findBeat(this.mg,t.endTick);if(e&&s){const t={beat:e.beat},i={beat:s.beat};this.xw(t,i)}}else this.xw(void 0,void 0)}Fg(){this.canvasElement.mouseDown.on(t=>{if(!t.isLeftMouseButton)return;this.settings.player.enableUserInteraction&&t.preventDefault();const e=t.getX(this.canvasElement),s=t.getY(this.canvasElement),i=this.Hp.boundsLookup?.getBeatAtPos(e,s)??null;if(i&&(this.Bw(t,i),this.settings.core.includeNoteBounds)){const n=this.Hp.boundsLookup?.getNoteAtPos(i,e,s);n&&this._w(t,n)}}),this.canvasElement.mouseMove.on(t=>{if(!this.mw)return;const e=t.getX(this.canvasElement),s=t.getY(this.canvasElement),i=this.Hp.boundsLookup?.getBeatAtPos(e,s)??null;if(i&&(this.Tw(t,i),this.yw)){const n=this.Hp.boundsLookup?.getNoteAtPos(i,e,s);n&&this.Mw(t,n)}}),this.canvasElement.mouseUp.on(t=>{if(!this.mw)return;this.settings.player.enableUserInteraction&&t.preventDefault();const e=t.getX(this.canvasElement),s=t.getY(this.canvasElement),i=this.Hp.boundsLookup?.getBeatAtPos(e,s)??null;if(this.Nw(t,i),this.yw)if(i){const n=this.Hp.boundsLookup?.getNoteAtPos(i,e,s)??null;this.Pw(t,n)}else this.Pw(t,null)}),this.Hp.postRenderFinished.on(()=>{this.kw&&this.lw&&this.settings.player.enableUserInteraction&&this.xw(this.kw,this.Sw)})}highlightPlaybackRange(t,e){this.kw={beat:t},this.Sw={beat:e},this.xw(this.kw,this.Sw)}applyPlaybackRangeFromHighlight(){if(this.Sw){const t=this.Ug?.getBeatStart(this.kw.beat)??this.kw.beat.absolutePlaybackStart;if((this.Ug?.getBeatStart(this.Sw.beat)??this.Sw.beat.absolutePlaybackStart)<t){const t=this.kw;this.kw=this.Sw,this.Sw=t}}if(this.kw&&this.Ug){const t=this.Ug,e=t.getMasterBarStart(this.kw.beat.voice.bar.masterBar);if(this.Tg=null,this.xp.state===Ke.Paused&&this.pw(this.Ug.getBeatStart(this.kw.beat),!1,1),this.tickPosition=e+this.kw.beat.playbackStart,this.Sw&&this.kw.beat!==this.Sw.beat){const s=t.getMasterBarStart(this.Sw.beat.voice.bar.masterBar),i=new Ya;i.startTick=e+this.kw.beat.playbackStart,i.endTick=s+this.Sw.beat.playbackStart+this.Sw.beat.playbackDuration-50,this.playbackRange=i}else this.kw=void 0,this.playbackRange=null,this.xw(this.kw,this.Sw)}}clearPlaybackRangeHighlight(){this.xw(void 0,void 0)}playbackRangeHighlightChanged=new mi;xw(t,e){const s=this.Hp.boundsLookup;if(!s)return void this.playbackRangeHighlightChanged.trigger({});const i=this.qg;if(!i)return void this.playbackRangeHighlightChanged.trigger({});if(i.clear(),!t||!e||t.beat===e.beat)return void this.playbackRangeHighlightChanged.trigger({});t.bounds||(t.bounds=s.findBeat(t.beat)??void 0),e.bounds||(e.bounds=s.findBeat(e.beat)??void 0);const n=this.Ug?.getBeatStart(t.beat)??t.beat.absolutePlaybackStart;if((this.Ug?.getBeatStart(e.beat)??e.beat.absolutePlaybackStart)<n){const s=t;t=e,e=s}const r={startBeat:t.beat,startBeatBounds:t.bounds,endBeat:e.beat,endBeatBounds:e.bounds,highlightBlocks:[]};let a=t.bounds.realBounds.x;0===t.beat.index&&(a=t.bounds.barBounds.masterBarBounds.realBounds.x);let h=e.bounds.realBounds.x+e.bounds.realBounds.w;if(e.beat.index===e.beat.voice.beats.length-1&&(h=e.bounds.barBounds.masterBarBounds.realBounds.x+e.bounds.barBounds.masterBarBounds.realBounds.w),t.bounds.barBounds.masterBarBounds.staffSystemBounds!==e.bounds.barBounds.masterBarBounds.staffSystemBounds){const n=t.bounds.barBounds.masterBarBounds.staffSystemBounds.visualBounds.x,o=t.bounds.barBounds.masterBarBounds.staffSystemBounds.visualBounds.x+t.bounds.barBounds.masterBarBounds.staffSystemBounds.visualBounds.w,c=this.uiFacade.createSelectionElement(),l=new Us(a,t.bounds.barBounds.masterBarBounds.visualBounds.y,o-a,t.bounds.barBounds.masterBarBounds.visualBounds.h);c.setBounds(l.x,l.y,l.w,l.h),r.highlightBlocks.push(l),i.appendChild(c);const u=t.bounds.barBounds.masterBarBounds.staffSystemBounds.index+1,d=e.bounds.barBounds.masterBarBounds.staffSystemBounds.index;for(let t=u;t<d;t++){const e=s.staffSystems[t],a=this.uiFacade.createSelectionElement(),h=new Us(n,e.visualBounds.y,o-n,e.visualBounds.h);r.highlightBlocks.push(h),a.setBounds(h.x,h.y,h.w,h.h),i.appendChild(a)}const f=this.uiFacade.createSelectionElement(),p=new Us(n,e.bounds.barBounds.masterBarBounds.visualBounds.y,h-n,e.bounds.barBounds.masterBarBounds.visualBounds.h);r.highlightBlocks.push(p),f.setBounds(p.x,p.y,p.w,p.h),i.appendChild(f)}else{const e=this.uiFacade.createSelectionElement(),s=new Us(a,t.bounds.barBounds.masterBarBounds.visualBounds.y,h-a,t.bounds.barBounds.masterBarBounds.visualBounds.h);e.setBounds(s.x,s.y,s.w,s.h),r.highlightBlocks.push(s),i.appendChild(e)}this.playbackRangeHighlightChanged.trigger(r)}scoreLoaded;zg(t){this.wg||(this.scoreLoaded.trigger(t),this.uiFacade.triggerEvent(this.container,"scoreLoaded",t),this.Eg()||this.loadMidiForScore())}resize=new mi;xg(t){this.wg||(this.resize.trigger(t),this.uiFacade.triggerEvent(this.container,"resize",t))}renderStarted=new mi;Mg(t){this.wg||(this.renderStarted.trigger(t),this.uiFacade.triggerEvent(this.container,"renderStarted",t))}renderFinished=new mi;Gp(t){this.wg||(this.renderFinished.trigger(t),this.uiFacade.triggerEvent(this.container,"renderFinished",t))}postRenderFinished=new bi;vg(){this.wg||(this.gg.bounds=this.boundsLookup,this.Tg=null,this.pw(this.Qg,!1,1,!0,!0),this.postRenderFinished.trigger(),this.uiFacade.triggerEvent(this.container,"postRenderFinished",null))}error=new mi;onError(t){this.wg||(J.error("API","An unexpected error occurred",t),this.error.trigger(t),this.uiFacade.triggerEvent(this.container,"error",t))}get playerReady(){return this.xp.readyForPlayback}Ag(){this.wg||this.uiFacade.triggerEvent(this.container,"playerReady",null)}get playerFinished(){return this.xp.finished}Gg(){this.wg||this.uiFacade.triggerEvent(this.container,"playerFinished",null)}get soundFontLoaded(){return this.xp.soundFontLoaded}Dg(){this.wg||this.uiFacade.triggerEvent(this.container,"soundFontLoaded",null)}midiLoad=new mi;ew(t){this.wg||(this.midiLoad.trigger(t),this.uiFacade.triggerEvent(this.container,"midiLoad",t))}midiLoaded;Lg(t){this.wg||(this.midiLoaded.trigger(t),this.uiFacade.triggerEvent(this.container,"midiFileLoaded",t))}get playerStateChanged(){return this.xp.stateChanged}Wg(t){if(!this.wg){if(!t.stopped&&t.state===Ke.Paused){const t=this.Tg,e=this.Ug;t&&e&&(this.xp.tickPosition=e.getBeatStart(t.beat),this.scrollToCursor())}this.uiFacade.triggerEvent(this.container,"playerStateChanged",t)}}get playerPositionChanged(){return this.xp.positionChanged}Og(t){if(this.wg)return;const e=t.currentTick;this.Qg=e,this.uiFacade.beginInvoke(()=>{const s=t.modifiedTempo/t.originalTempo;this.pw(e,!1,s,!1,t.isSeek)}),this.uiFacade.triggerEvent(this.container,"playerPositionChanged",t)}get midiEventsPlayed(){return this.xp.midiEventsPlayed}Rg(t){this.wg||this.uiFacade.triggerEvent(this.container,"midiEventsPlayed",t)}get playbackRangeChanged(){return this.xp.playbackRangeChanged}Ig(t){this.wg||this.uiFacade.triggerEvent(this.container,"playbackRangeChanged",t)}settingsUpdated=new bi;Vg(){this.wg||(this.settingsUpdated.trigger(),this.uiFacade.triggerEvent(this.container,"settingsUpdated",null))}async enumerateOutputDevices(){return await this.xp.output.enumerateOutputDevices()}async setOutputDevice(t){await this.xp.output.setOutputDevice(t)}async getOutputDevice(){return await this.xp.output.getOutputDevice()}async exportAudio(t){if(!this.score)throw new I(s.General,"No song loaded");let e;if(this.kg===us.EnabledSynthesizer)e=this.uiFacade.createWorkerAudioExporter(this.xp.instance);else e=this.uiFacade.createWorkerAudioExporter(null);const i=this.score,n=new Ti,r=new ka(n),a=new Da(i,this.settings,r);a.applyTranspositionPitches=!1,a.generate();const h=new Zn;h.soundFonts=t.soundFonts,h.sampleRate=t.sampleRate,h.useSyncPoints=t.useSyncPoints,h.masterVolume=t.masterVolume,h.metronomeVolume=t.metronomeVolume,h.playbackRange=t.playbackRange;for(const[e,s]of t.trackVolume)if(e<this.score.tracks.length){const t=this.score.tracks[e];h.trackVolume.set(t.playbackInfo.primaryChannel,s),h.trackVolume.set(t.playbackInfo.secondaryChannel,s)}for(const[e,s]of t.trackTranspositionPitches)if(e<this.score.tracks.length){const t=this.score.tracks[e];h.trackTranspositionPitches.set(t.playbackInfo.primaryChannel,s),h.trackTranspositionPitches.set(t.playbackInfo.secondaryChannel,s)}return await e.initialize(h,n,a.syncPoints,a.transpositionPitches),e}}class rh extends I{xhr;constructor(t,e){super(s.General,t),this.xhr=e}}class ah{static loadAlphaTex(t,e){const s=new Le;return s.logErrors=!0,s.initFromString(t,e??new ra),s.readScore()}static loadScoreAsync(t,e,s,i){const n=new XMLHttpRequest;n.open("GET",t,!0,null,null),n.responseType="arraybuffer",n.onreadystatechange=()=>{if(n.readyState===XMLHttpRequest.DONE){const t=n.response;if(200===n.status||0===n.status&&t)try{const t=n.response,s=new Uint8Array(t),r=ah.loadScoreFromBytes(s,i);e(r)}catch(t){s(t)}else 0===n.status?s(new rh("You are offline!!\n Please Check Your Network.",n)):404===n.status?s(new rh("Requested URL not found.",n)):500===n.status?s(new rh("Internel Server Error.",n)):"parsererror"===n.statusText?s(new rh("Error.\nParsing JSON Request failed.",n)):"timeout"===n.statusText?s(new rh("Request Time out.",n)):s(new rh(`Unknow Error: ${n.responseText}`,n))}},n.send()}static loadScoreFromBytes(t,e){e||(e=new ra);const s=Pu.buildImporters();J.debug("ScoreLoader",`Loading score from ${t.length} bytes using ${s.length} importers`);let i=null;const n=Fe.fromBuffer(t);for(const t of s){n.reset();try{J.debug("ScoreLoader",`Importing using importer ${t.name}`),t.init(n,e),i=t.readScore(),J.debug("ScoreLoader",`Score imported using ${t.name}`);break}catch(e){if(!(e instanceof Ee))throw J.error("ScoreLoader","Score import failed due to unexpected error: ",e),e;J.debug("ScoreLoader",`${t.name} does not support the file`)}}if(i)return i;throw new Ee("No compatible importer found for file")}}class hh{mouseEvent;get isLeftMouseButton(){return 0===this.mouseEvent.button}getX(t){const e=t.element,s=e.getBoundingClientRect().left+e.ownerDocument.defaultView.pageXOffset;return this.mouseEvent.pageX-s}getY(t){const e=t.element,s=e.getBoundingClientRect().top+e.ownerDocument.defaultView.pageYOffset;return this.mouseEvent.pageY-s}preventDefault(){this.mouseEvent.preventDefault()}constructor(t){this.mouseEvent=t}}class oh{static Cw=new X(()=>new ResizeObserver(t=>{for(const e of t){const t=new CustomEvent("resize",{detail:e});e.target.dispatchEvent(t)}}));Ew=0;get width(){return this.element.offsetWidth}set width(t){this.element.style.width=`${t}px`}get scrollLeft(){return this.element.scrollLeft}set scrollLeft(t){this.element.scrollLeft=t}get scrollTop(){return this.element.scrollTop}set scrollTop(t){this.element.scrollTop=t}get height(){return this.element.offsetHeight}set height(t){this.element.style.height=t>=0?`${t}px`:"100%"}get isVisible(){return!!this.element.offsetWidth||!!this.element.offsetHeight||!!this.element.getClientRects().length}element;constructor(t){this.element=t,this.mouseDown={on:t=>{const e=e=>{t(new hh(e))};return this.element.addEventListener("mousedown",e,!0),()=>{this.element.removeEventListener("mousedown",e,!0)}},off:t=>{}},this.mouseUp={on:t=>{const e=e=>{t(new hh(e))};return this.element.addEventListener("mouseup",e,!0),()=>{this.element.removeEventListener("mouseup",e,!0)}},off:t=>{}},this.mouseMove={on:t=>{const e=e=>{t(new hh(e))};return this.element.addEventListener("mousemove",e,!0),()=>{this.element.removeEventListener("mousemove",e,!0)}},off:t=>{}};const e=this;this.resize={on:function(t){return 0===e.Ew&&oh.Cw.value.observe(e.element),e.element.addEventListener("resize",t,!0),e.Ew++,()=>this.off(t)},off:t=>{this.element.removeEventListener("resize",t,!0),this.Ew--,this.Ew<=0&&(this.Ew=0,oh.Cw.value.unobserve(this.element))}}}stopAnimation(){this.element.style.transition="none"}transitionToX(t,e){this.element.style.transition=`transform ${t}ms linear`,this.setBounds(e,Number.NaN,Number.NaN,Number.NaN)}lastBounds=new Us;setBounds(t,e,s,i){Number.isNaN(t)&&(t=this.lastBounds.x),Number.isNaN(e)&&(e=this.lastBounds.y),Number.isNaN(s)&&(s=this.lastBounds.w),Number.isNaN(i)&&(i=this.lastBounds.h),this.element.style.transform=`translate(${t}px, ${e}px) scale(${s}, ${i})`,this.element.style.transformOrigin="top left",this.lastBounds.x=t,this.lastBounds.y=e,this.lastBounds.w=s,this.lastBounds.h=i}resize;mouseDown;mouseMove;mouseUp;appendChild(t){this.element.appendChild(t.element)}clear(){this.element.innerText=""}}class ch{Fw;mp;Aw=!1;isFontLoaded=!1;fontLoaded=new mi;constructor(t){this.Fw=t,this.mp=t}checkForFontAvailability(){if(Pu.isRunningInWorker)return void(this.isFontLoaded=!1);if(this.Aw)return;this.Aw=!0;let t=0;const e=window.setInterval(()=>{J.warning("Rendering",`Could not load font '${this.mp[0]}' within ${5*(t+1)} seconds`,null),this.mp.length>1?(this.mp.shift(),t=0):t++},5e3);J.debug("Font",`Start checking for font availablility: ${this.mp.join(", ")}`);const s=t=>{this.mp.length>1?(J.debug("Font",`[${this.mp[0]}] Loading Failed, switching to ${this.mp[1]}`,t),this.mp.shift(),window.setTimeout(()=>{n()},0)):(J.error("Font",`[${this.Fw.join(",")}] Loading Failed, rendering cannot start`,t),window.clearInterval(e))},i=t=>{J.debug("Font",`[${t}] Font API signaled available`),this.isFontLoaded=!0,window.clearInterval(e),this.fontLoaded.trigger(this.mp[0])},n=async()=>{for(const t of this.mp)if(await this.Dw(t,!1))return void i(t);try{await document.fonts.load(`1em ${this.mp[0]}`)}catch(t){s(t)}return J.debug("Font",`[${this.mp[0]}] Font API signaled loaded`),await this.Dw(this.mp[0],!0)?i(this.mp[0]):s("Font not available"),!0};document.fonts.ready.then(()=>{n()})}Dw(t,e){return new Promise(s=>{const i=`1em ${t}`;if(document.fonts.check(i))s(!0);else if(e){J.debug("Font",`Font ${t} not available, creating test element to trigger load`);const e=document.createElement("div");e.style.font=i,e.style.opacity="0",e.style.position="absolute",e.style.top="0",e.style.left="0",e.innerText=`Trigger ${t} load`,document.body.appendChild(e),setTimeout(()=>{document.body.removeChild(e),document.fonts.check(i)?s(!0):s(!1)},200)}else s(!1)})}}class lh extends ki{Lw=null;Gl;Hl=0;Vl=0;open(t){super.open(t),this.Hl=Math.floor(t*this.sampleRate/1e3/ki.BufferSize),this.Gl=new pi(ki.BufferSize*this.Hl),this.onReady()}play(){super.play();const t=this.context;this.Lw=t.createScriptProcessor(4096,0,2),this.Lw.onaudioprocess=this.Ww.bind(this),this.Gl.clear(),this.Ul(),this.source=t.createBufferSource(),this.source.buffer=this.buffer,this.source.loop=!0,this.source.connect(this.Lw,0,0),this.source.start(0),this.Lw.connect(t.destination,0,0)}pause(){super.pause(),this.Lw&&this.Lw.disconnect(0),this.Lw=null}addSamples(t){this.Gl.write(t,0,t.length),this.Vl--}resetSamples(){this.Gl.clear()}Ul(){const t=this.Hl/2|0,e=t*ki.BufferSize;if(this.Gl.count+this.Vl*ki.BufferSize<e){for(let e=0;e<t;e++)this.onSampleRequest();this.Vl+=t}}Il=new Float32Array(0);Ww(t){const e=t.outputBuffer.getChannelData(0),s=t.outputBuffer.getChannelData(1),i=e.length+s.length;let n=this.Il;n.length!==i&&(n=new Float32Array(i),this.Il=n);const r=this.Gl.read(n,0,Math.min(n.length,this.Gl.count));let a=0;const h=Math.min(e.length,r);for(let t=0;t<h;t++)e[t]=n[a++],s[t]=n[a++];if(r<e.length)for(let t=r;t<e.length;t++)e[t]=0,s[t]=0;this.onSamplesPlayed(r/Vt.AudioChannels),this.Ul()}}class uh{Qf;nn;Ow=!1;Rw=!1;Iw=!1;Bi=Ke.Paused;sg=0;Hf=0;Vf=0;ig=0;ng=!1;Gw=null;rg=[];zf;if=new zi(0,0,0,0,!1,120,120);get output(){return this.nn}get isReady(){return this.Rw&&this.Iw}get isReadyForPlayback(){return this.Ow}get state(){return this.Bi}get logLevel(){return J.logLevel}get worker(){return this.Qf}set logLevel(t){J.logLevel=t,this.Qf.postMessage({cmd:"alphaSynth.setLogLevel",value:t})}get masterVolume(){return this.sg}set masterVolume(t){t=Math.max(t,Vt.MinVolume),this.sg=t,this.Qf.postMessage({cmd:"alphaSynth.setMasterVolume",value:t})}get metronomeVolume(){return this.Hf}set metronomeVolume(t){t=Math.max(t,Vt.MinVolume),this.Hf=t,this.Qf.postMessage({cmd:"alphaSynth.setMetronomeVolume",value:t})}get countInVolume(){return this.Vf}set countInVolume(t){t=Math.max(t,Vt.MinVolume),this.Vf=t,this.Qf.postMessage({cmd:"alphaSynth.setCountInVolume",value:t})}get midiEventsPlayedFilter(){return this.rg}set midiEventsPlayedFilter(t){this.rg=t,this.Qf.postMessage({cmd:"alphaSynth.setMidiEventsPlayedFilter",value:Pu.prepareForPostMessage(t)})}get playbackSpeed(){return this.ig}set playbackSpeed(t){t=zt.clamp(t,Vt.MinPlaybackSpeed,Vt.MaxPlaybackSpeed),this.ig=t,this.Qf.postMessage({cmd:"alphaSynth.setPlaybackSpeed",value:t})}get loadedMidiInfo(){return this.loadedMidiInfo}get currentPosition(){return this.if}get tickPosition(){return this.if.currentTick}set tickPosition(t){t<0&&(t=0),this.if=new zi(this.if.currentTime,this.if.endTime,t,this.if.endTick,!0,this.if.originalTempo,this.if.modifiedTempo),this.Qf.postMessage({cmd:"alphaSynth.setTickPosition",value:t})}get timePosition(){return this.if.currentTime}set timePosition(t){t<0&&(t=0),this.if=new zi(t,this.if.endTime,this.if.currentTick,this.if.endTick,!0,this.if.originalTempo,this.if.modifiedTempo),this.Qf.postMessage({cmd:"alphaSynth.setTimePosition",value:t})}get isLooping(){return this.ng}set isLooping(t){this.ng=t,this.Qf.postMessage({cmd:"alphaSynth.setIsLooping",value:t})}get playbackRange(){return this.Gw}set playbackRange(t){t&&(t.startTick<0&&(t.startTick=0),t.endTick<0&&(t.endTick=0)),this.Gw=t,this.Qf.postMessage({cmd:"alphaSynth.setPlaybackRange",value:Pu.prepareForPostMessage(t)})}constructor(t,e){this.Ow=!1,this.Rw=!1,this.Iw=!1,this.Bi=Ke.Paused,this.sg=0,this.Hf=0,this.ig=0,this.ng=!1,this.Gw=null,this.nn=t,this.nn.ready.on(this.Hw.bind(this)),this.nn.samplesPlayed.on(this.onOutputSamplesPlayed.bind(this)),this.nn.sampleRequest.on(this.onOutputSampleRequest.bind(this)),this.nn.open(e.player.bufferTimeInMilliseconds);try{this.Qf=Pu.createWebWorker(e)}catch(t){J.error("AlphaSynth",`Failed to create WebWorker: ${t}`)}this.Qf.addEventListener("message",this.handleWorkerMessage.bind(this),!1),this.Qf.postMessage({cmd:"alphaSynth.initialize",sampleRate:this.nn.sampleRate,logLevel:e.core.logLevel,bufferTimeInMilliseconds:e.player.bufferTimeInMilliseconds}),this.masterVolume=1,this.playbackSpeed=1,this.metronomeVolume=0}destroy(){this.Qf.postMessage({cmd:"alphaSynth.destroy"})}play(){return this.nn.activate(),this.Qf.postMessage({cmd:"alphaSynth.play"}),!0}pause(){this.Qf.postMessage({cmd:"alphaSynth.pause"})}playPause(){this.nn.activate(),this.Qf.postMessage({cmd:"alphaSynth.playPause"})}stop(){this.Qf.postMessage({cmd:"alphaSynth.stop"})}playOneTimeMidiFile(t){this.Qf.postMessage({cmd:"alphaSynth.playOneTimeMidiFile",midi:aa.midiFileToJsObject(Pu.prepareForPostMessage(t))})}loadSoundFont(t,e){this.Qf.postMessage({cmd:"alphaSynth.loadSoundFontBytes",data:Pu.prepareForPostMessage(t),append:e})}resetSoundFonts(){this.Qf.postMessage({cmd:"alphaSynth.resetSoundFonts"})}loadMidiFile(t){this.Qf.postMessage({cmd:"alphaSynth.loadMidi",midi:aa.midiFileToJsObject(Pu.prepareForPostMessage(t))})}applyTranspositionPitches(t){this.Qf.postMessage({cmd:"alphaSynth.applyTranspositionPitches",transpositionPitches:JSON.stringify(Array.from(Pu.prepareForPostMessage(t).entries()))})}setChannelTranspositionPitch(t,e){this.Qf.postMessage({cmd:"alphaSynth.setChannelTranspositionPitch",channel:t,semitones:e})}setChannelMute(t,e){this.Qf.postMessage({cmd:"alphaSynth.setChannelMute",channel:t,mute:e})}resetChannelStates(){this.Qf.postMessage({cmd:"alphaSynth.resetChannelStates"})}setChannelSolo(t,e){this.Qf.postMessage({cmd:"alphaSynth.setChannelSolo",channel:t,solo:e})}setChannelVolume(t,e){e=Math.max(e,Vt.MinVolume),this.Qf.postMessage({cmd:"alphaSynth.setChannelVolume",channel:t,volume:e})}handleWorkerMessage(t){const e=t.data;switch(e.cmd){case"alphaSynth.ready":this.Rw=!0,this.Vw();break;case"alphaSynth.destroyed":this.Qf.terminate();break;case"alphaSynth.readyForPlayback":this.Ow=!0,this.Xf();break;case"alphaSynth.positionChanged":this.if=new zi(e.currentTime,e.endTime,e.currentTick,e.endTick,e.isSeek,e.originalTempo,e.modifiedTempo),this.positionChanged.trigger(this.if);break;case"alphaSynth.midiEventsPlayed":this.midiEventsPlayed.trigger(new Kn(e.events.map(aa.jsObjectToMidiEvent)));break;case"alphaSynth.playerStateChanged":this.Bi=e.state,this.stateChanged.trigger(new Ui(e.state,e.stopped));break;case"alphaSynth.playbackRangeChanged":this.Gw=e.playbackRange,this.playbackRangeChanged.trigger(new Qn(this.Gw));break;case"alphaSynth.finished":this.finished.trigger();break;case"alphaSynth.soundFontLoaded":this.soundFontLoaded.trigger();break;case"alphaSynth.soundFontLoadFailed":this.soundFontLoadFailed.trigger(e.error);break;case"alphaSynth.midiLoaded":this.Xf(),this.zf=new zi(e.currentTime,e.endTime,e.currentTick,e.endTick,e.isSeek,e.originalTempo,e.modifiedTempo),this.midiLoaded.trigger(this.zf);break;case"alphaSynth.midiLoadFailed":this.Xf(),this.midiLoadFailed.trigger(e.error);break;case"alphaSynth.output.addSamples":this.nn.addSamples(e.samples);break;case"alphaSynth.output.play":this.nn.play();break;case"alphaSynth.output.pause":this.nn.pause();break;case"alphaSynth.output.destroy":this.nn.destroy();break;case"alphaSynth.output.resetSamples":this.nn.resetSamples()}}Vw(){this.isReady&&this.ready.trigger()}Xf(){this.isReadyForPlayback&&this.readyForPlayback.trigger()}ready=new bi;readyForPlayback=new bi;finished=new bi;soundFontLoaded=new bi;soundFontLoadFailed=new mi;midiLoaded=new mi;midiLoadFailed=new mi;stateChanged=new mi;positionChanged=new mi;midiEventsPlayed=new mi;playbackRangeChanged=new mi;onOutputSampleRequest(){this.Qf.postMessage({cmd:"alphaSynth.output.sampleRequest"})}onOutputSamplesPlayed(t){this.Qf.postMessage({cmd:"alphaSynth.output.samplesPlayed",samples:t})}Hw(){this.Iw=!0,this.Vw()}loadBackingTrack(t){}updateSyncPoints(t){}}class dh{Qm;El;qm=0;boundsLookup=null;constructor(t,e){this.Qm=t;try{this.El=Pu.createWebWorker(e)}catch(t){return void J.error("Rendering",`Failed to create WebWorker: ${t}`)}this.El.postMessage({cmd:"alphaTab.initialize",settings:this.$w(e)}),this.El.addEventListener("message",this.Uw.bind(this))}destroy(){this.El.terminate()}updateSettings(t){this.El.postMessage({cmd:"alphaTab.updateSettings",settings:this.$w(t)})}$w(t){const e=aa.settingsToJsObject(Pu.prepareForPostMessage(t));return e.delete("player"),e}render(t){this.El.postMessage({cmd:"alphaTab.render",renderHints:t})}resizeRender(){this.El.postMessage({cmd:"alphaTab.resizeRender"})}renderResult(t){this.El.postMessage({cmd:"alphaTab.renderResult",resultId:t})}get width(){return this.qm}set width(t){this.qm=t,this.El.postMessage({cmd:"alphaTab.setWidth",width:t})}Uw(t){const e=t.data;switch(e.cmd){case"alphaTab.preRender":this.preRender.trigger(e.resize);break;case"alphaTab.partialRenderFinished":this.partialRenderFinished.trigger(e.result);break;case"alphaTab.partialLayoutFinished":this.partialLayoutFinished.trigger(e.result);break;case"alphaTab.renderFinished":this.renderFinished.trigger(e.result);break;case"alphaTab.postRenderFinished":this.boundsLookup=ma.fromJson(e.boundsLookup,this.Qm.score),this.boundsLookup.finish(),this.postRenderFinished.trigger();break;case"alphaTab.error":this.error.trigger(e.error)}}renderScore(t,e,s){const i=null==t?null:aa.scoreToJsObject(Pu.prepareForPostMessage(t));this.El.postMessage({cmd:"alphaTab.renderScore",score:i,trackIndexes:Pu.prepareForPostMessage(e),fontSizes:ca.fontSizeLookupTables,renderHints:s})}preRender=new mi;partialRenderFinished=new mi;partialLayoutFinished=new mi;renderFinished=new mi;postRenderFinished=new bi;error=new mi}class fh extends oh{zw;Xw;centerAtPosition=!1;constructor(t,e,s){super(t),this.zw=e,this.Xw=s}get width(){return this.element.offsetWidth/this.zw}set width(t){this.element.style.width=t*this.zw+"px"}get height(){return this.element.offsetHeight/this.Xw}set height(t){this.element.style.height=t>=0?t*this.Xw+"px":"100%"}setBounds(t,e,s,i){Number.isNaN(t)&&(t=this.lastBounds.x),Number.isNaN(e)&&(e=this.lastBounds.y),Number.isNaN(s)?s=this.lastBounds.w:s/=this.zw,Number.isNaN(i)?i=this.lastBounds.h:i/=this.Xw;let n=`translate(${t}px, ${e}px) scale(${s}, ${i})`;this.centerAtPosition&&(n+=" translateX(-50%)"),this.element.style.transform=n,this.element.style.transformOrigin="top left",this.lastBounds.x=t,this.lastBounds.y=e,this.lastBounds.w=s,this.lastBounds.h=i}}class ph{sampleRate=44100;audioElement;jw=0;get backingTrackDuration(){const t=this.audioElement.duration??0;return Number.isFinite(t)?1e3*t:0}get playbackRate(){return this.audioElement.playbackRate}set playbackRate(t){this.audioElement.playbackRate=t}get masterVolume(){return this.audioElement.volume}set masterVolume(t){this.audioElement.volume=t}seekTo(t){this.audioElement.currentTime=t/1e3}loadBackingTrack(t){this.audioElement?.src&&URL.revokeObjectURL(this.audioElement.src);const e=new Blob([t.rawAudioFile]),s=this.audioElement.playbackRate;this.audioElement.src=URL.createObjectURL(e),this.audioElement.playbackRate=s}open(t){const e=document.createElement("audio");e.style.display="none",document.body.appendChild(e),e.addEventListener("seeked",()=>{this.Jw()}),e.addEventListener("timeupdate",()=>{this.Jw()}),this.audioElement=e,this.ready.trigger()}Jw(){const t=1e3*this.audioElement.currentTime;this.timeUpdate.trigger(t)}play(){this.audioElement.play(),this.jw=window.setInterval(()=>{this.Jw()},50)}destroy(){const t=this.audioElement;t&&document.body.removeChild(t)}pause(){this.audioElement.pause(),window.clearInterval(this.jw)}addSamples(t){}resetSamples(){}activate(){}ready=new bi;samplesPlayed=new mi;timeUpdate=new mi;sampleRequest=new bi;async enumerateOutputDevices(){return yi.enumerateOutputDevices()}async setOutputDevice(t){await yi.checkSinkIdSupport()&&(t?await this.audioElement.setSinkId(t.deviceId):await this.audioElement.setSinkId(""))}async getOutputDevice(){if(!await yi.checkSinkIdSupport())return null;const t=this.audioElement.sinkId;if("string"!=typeof t||""===t||"default"===t)return null;let e=yi.findKnownDevice(t);if(e)return e;const s=await this.enumerateOutputDevices();return e=s.find(e=>e.deviceId===t),e||(J.warning("WebAudio","Could not find output device in device list",t,s),null)}}class bh{static qw=1;El;Yw;Kw;Qw;Zw=null;constructor(t,e){this.Kw=bh.qw++,this.El=t,this.Qw=e}async initialize(t,e,s,i){const n=this.handleWorkerMessage.bind(this);this.El.worker.addEventListener("message",n,!1),this.Yw=()=>{this.El.worker.removeEventListener("message",n,!1)},this.Zw=Promise.withResolvers(),this.El.worker.postMessage({cmd:"alphaSynth.exporter.initialize",exporterId:this.Kw,options:Pu.prepareForPostMessage(t),midi:aa.midiFileToJsObject(Pu.prepareForPostMessage(e)),syncPoints:Pu.prepareForPostMessage(s),transpositionPitches:Pu.prepareForPostMessage(i)}),await this.Zw.promise}handleWorkerMessage(t){const e=t.data;if(e.exporterId!==this.Kw)return;switch(e.cmd){case"alphaSynth.exporter.initialized":this.Zw?.resolve(null),this.Zw=null;break;case"alphaSynth.exporter.error":this.Zw?.reject(e.error),this.Zw=null;break;case"alphaSynth.exporter.rendered":this.Zw?.resolve(e.chunk),this.Zw=null;break;case"alphaSynth.destroyed":this.Zw?.reject(new I(s.General,"Worker was destroyed")),this.Zw=null}}async render(t){if(this.Zw)throw new I(s.General,"There is already an ongoing operation, wait for initialize to complete before requesting render");return this.Zw=Promise.withResolvers(),this.El.worker.postMessage({cmd:"alphaSynth.exporter.render",exporterId:this.Kw,milliseconds:t}),await this.Zw.promise}destroy(){this.El.worker.postMessage({cmd:"alphaSynth.exporter.destroy",exporterId:this.Kw}),this.Yw(),this.Qw&&this.El.destroy()}[Symbol.dispose](){this.destroy()}}!function(t){t[t.LayoutDone=0]="LayoutDone",t[t.RenderRequested=1]="RenderRequested",t[t.RenderDone=2]="RenderDone",t[t.Detached=3]="Detached"}(ms||(ms={}));class mh{ty=new Map;Qm;ey=null;sy=null;iy=0;ny=null;hy;oy=new Map;ly=new Map;uy;rootContainerBecameVisible=new bi;canRenderChanged=new bi;get resizeThrottle(){return 10}rootContainer;areWorkersSupported;get canRender(){return this.py()}py(){let t=!1;for(const e of this.ty.values())e.isFontLoaded||(t=!0);return!t&&(J.debug("Font",`All fonts loaded: ${this.ty.size}`),!0)}by(t){ca.generateFontLookup(t),this.py()&&this.canRenderChanged.trigger()}constructor(t){if(Pu.webPlatform!==ds.Browser&&Pu.webPlatform!==ds.BrowserModule)throw new I(s.General,"Usage of AlphaTabApi is only possible in browser environments. For usage in node use the Low Level APIs");t.classList.add("alphaTab"),this.rootContainer=new oh(t),this.areWorkersSupported="Worker"in window,this.hy=new IntersectionObserver(this.my.bind(this),{threshold:[0,.01,1]}),this.hy.observe(t)}my(t){for(const e of t){const t=e.target;if(t===this.rootContainer.element)e.isIntersecting&&(this.rootContainerBecameVisible.trigger(),this.hy.unobserve(this.rootContainer.element));else if("layoutResultId"in t&&this.Qm.settings.core.enableLazyLoading){const s=t;e.isIntersecting?s.renderedResultId!==s.layoutResultId?this.ly.has(s.layoutResultId)?s.resultState!==ms.RenderRequested&&(s.resultState=ms.RenderRequested,this.Qm.renderer.renderResult(s.layoutResultId)):t.replaceChildren():s.resultState===ms.Detached&&(t.replaceChildren(...s.renderedResult),s.resultState=ms.RenderDone):s.resultState===ms.RenderDone&&(s.resultState=ms.Detached,s.replaceChildren())}}}createWorkerRenderer(){return new dh(this.Qm,this.Qm.settings)}initialize(t,e){let s;this.Qm=t,s=e instanceof ra?e:aa.jsObjectToSettings(e);const i=this.gy();sa.fromJson(s,i),s.notation.notationMode===S.SongBook&&s.setSongBookModeSettings(),t.settings=s,this.wy(s),this.ny=this.parseTracks(s.core.tracks),this.ey="";const n=t.container;s.core.tex&&(this.ey=n.element.textContent,n.element.innerText=""),this.yy(s),this.sy=s.core.file}wy(t){for(const e of t.display.resources.elementFonts.values())this.ky(e);this.ky(t.display.resources.graceFont),this.ky(t.display.resources.tablatureFont),this.ky(t.display.resources.numberedNotationFont),this.ky(t.display.resources.numberedNotationGraceFont)}ky(t){if(!this.ty.has(t.families.join(", "))){const e=new ch(t.families);this.ty.set(t.families.join(", "),e),e.fontLoaded.on(this.by.bind(this)),e.checkForFontAvailability()}}destroy(){const t=this.rootContainer.element;t.innerHTML="";const e=this.uy,s=e.elements.get(t.ownerDocument);s&&(s.usages--,s.usages<=0&&(s.element.remove(),e.elements.delete(t.ownerDocument))),0===e.elements.size&&mh.Sy.delete(e.hash)}createCanvasElement(){const t=document.createElement("div");return t.classList.add("at-surface",`at${this.uy.fontSuffix}`),t.style.fontSize="0",t.style.overflow="hidden",t.style.lineHeight="0",t.style.position="relative",new oh(t)}setCanvasOverflow(t,e,s){const i=t.element;0===e?(i.style.boxSizing="",i.style.paddingRight="",i.style.paddingBottom=""):s?(i.style.boxSizing="content-box",i.style.paddingBottom=`${e}px`):(i.style.boxSizing="content-box",i.style.paddingRight=`${e}px`)}triggerEvent(t,e,s=null,i){const n=t.element;e=`alphaTab.${e}`;const r=document.createEvent("CustomEvent"),a=i?i.mouseEvent:null;if(r.initCustomEvent(e,!1,!1,s),a&&(r.originalEvent=a),n.dispatchEvent(r),window&&"jQuery"in window){const t=window.jQuery,i=[];i.push(s),a&&i.push(a),t(n).trigger(e,i)}}load(t,e,s){if(t instanceof Ht)return e(t),!0;if(t instanceof ArrayBuffer){const s=new Uint8Array(t);return e(ah.loadScoreFromBytes(s,this.Qm.settings)),!0}return t instanceof Uint8Array?(e(ah.loadScoreFromBytes(t,this.Qm.settings)),!0):"string"==typeof t&&(ah.loadScoreAsync(t,e,s,this.Qm.settings),!0)}loadSoundFont(t,e){return!!this.Qm.player&&(t instanceof ArrayBuffer?(this.Qm.player.loadSoundFont(new Uint8Array(t),e),!0):t instanceof Uint8Array?(this.Qm.player.loadSoundFont(t,e),!0):"string"==typeof t&&(this.Qm.loadSoundFontFromUrl(t,e),!0))}initialRender(){this.Qm.renderer.preRender.on(t=>{this.iy=0,this.ly.clear(),this.oy.clear()});const t=()=>{this.Qm.renderer.width=0|this.rootContainer.width,this.Qm.renderer.updateSettings(this.Qm.settings),this.ey?(this.Qm.tex(this.ey,this.ny??void 0),this.ny=null):this.sy&&ah.loadScoreAsync(this.sy,t=>{this.Qm.renderScore(t,this.ny??void 0),this.ny=null},t=>{this.Qm.onError(t)},this.Qm.settings)};this.rootContainer.isVisible?t():this.rootContainerBecameVisible.on(t)}yy(t){const e=this.Qm.container.element.ownerDocument;mh.createSharedStyleElement(e);const s=t.core.smuflFontSources??Cu.buildDefaultSmuflFontSources(t.core.fontDirectory),i=mh.By(s.values()),n=mh.Sy;if(n.has(i)){const t=n.get(i);return t.checker.fontLoaded.on(this.by.bind(this)),this._y(t,e),void(this.uy=t)}const r=0===n.size?"":String(n.size),a=`alphaTab${r}`,h=`\n            @font-face {\n                font-display: block;\n                font-family: '${a}';\n                src: ${Array.from(s.entries()).map(t=>`url(${JSON.stringify(t[1])}) format('${mh.Ty(t[0])}')`).join(",")};\n                font-weight: normal;\n                font-style: normal;\n            }\n            .at-surface.at${r} .at {\n                font-family: '${a}';\n                speak: none;\n                font-style: normal;\n                font-weight: normal;\n                font-variant: normal;\n                text-transform: none;\n                line-height: 1;\n                line-height: 1;\n                -webkit-font-smoothing: antialiased;\n                -moz-osx-font-smoothing: grayscale;\n                font-size: ${t.display.resources.engravingSettings.musicFontSize}px;\n                overflow: visible !important;\n            }`,o=new ch([a]);o.fontLoaded.on(this.by.bind(this)),this.ty.set(a,o),o.checkForFontAvailability(),t.display.resources.smuflFontFamilyName=a;const c={hash:i,elements:new Map,fontSuffix:r,checker:o,cssSource:h};this._y(c,e),n.set(i,c),this.uy=c}_y(t,e){if(t.elements.has(e))return void t.elements.get(e).usages++;const s=e.createElement("style");s.id=`alphaTabStyle${t.fontSuffix}`,s.innerHTML=t.cssSource,e.getElementsByTagName("head").item(0).appendChild(s),t.elements.set(e,{element:s,usages:1})}static Ty(t){switch(t){case Mh.EmbeddedOpenType:return"embedded-opentype";case Mh.Woff:return"woff";case Mh.Woff2:return"woff2";case Mh.OpenType:return"opentype";case Mh.TrueType:return"truetype";case Mh.Svg:return"svg"}}static Sy=new Map;static By(t,e=0){let s=3735928559^e,i=1103547991^e;for(const e of t)for(let t=0;t<e.length;t++){const n=e.charCodeAt(t);s=Math.imul(s^n,2654435761),i=Math.imul(i^n,1597334677)}return s=Math.imul(s^s>>>16,2246822507),s^=Math.imul(i^i>>>13,3266489909),i=Math.imul(i^i>>>16,2246822507),i^=Math.imul(s^s>>>13,3266489909),4294967296*(2097151&i)+(s>>>0)}static createSharedStyleElement(t){let e=t.getElementById("alphaTabStyle");if(!e){e=document.createElement("style"),e.id="alphaTabStyleShared";const t="\n                .at-surface * {\n                    cursor: default;\n                    vertical-align: top;\n                    overflow: visible;\n                }\n                .at-surface-svg text {\n                    dominant-baseline: alphabetic;\n                    white-space:pre;\n                }";e.innerHTML=t,document.getElementsByTagName("head").item(0).appendChild(e)}}parseTracks(t){if(!t)return[];const e=[];if("string"==typeof t)try{if("all"===t)return[-1];t=JSON.parse(t)}catch{t=[0]}if("number"==typeof t)e.push(t);else if("length"in t){const s=t.length,i=t;for(let t=0;t<s;t++){const s=i[t];let n=0;n="number"==typeof s?s:"index"in s?s.index:Number.parseInt(s.toString(),10),(n>=0||-1===n)&&e.push(n)}}else"index"in t&&e.push(t.index);return e}gy(){const t=new Map,e=this.Qm.container.element;if(e.dataset)for(const s of Object.keys(e.dataset)){let i=e.dataset[s];try{const t=i;i=JSON.parse(t)}catch{""===i&&(i=null)}t.set(s,i)}else for(let s=0;s<e.attributes.length;s++){const i=e.attributes.item(s),n=i.nodeName;if(n.startsWith("data-")){const e=n.substr(5).split("-");let s=e[0];for(let t=1;t<e.length;t++)s+=e[t].substr(0,1).toUpperCase()+e[t].substr(1);let r=i.nodeValue;try{r=JSON.parse(r)}catch{""===r&&(r=null)}t.set(s,r)}}return t}beginUpdateRenderResults(t){if(!this.ly.has(t.id))return;const e=this.ly.get(t.id),s=t.renderResult;"string"==typeof s?e.innerHTML=s:"nodeType"in s&&e.replaceChildren(s),e.resultState=ms.RenderDone,e.renderedResultId=t.id,e.renderedResult=Array.from(e.children)}beginAppendRenderResults(t){const e=this.Qm.canvasElement.element;if(t){let s;this.iy<e.childElementCount?s=e.childNodes.item(this.iy):(s=document.createElement("div"),e.appendChild(s)),s.style.zIndex="1",s.style.position="absolute",s.style.left=`${t.x}px`,s.style.top=`${t.y}px`,s.style.width=`${t.width}px`,s.style.height=`${t.height}px`,s.style.display="inline-block",s.layoutResultId=t.id,s.resultState=ms.LayoutDone,s.renderedResultId=void 0,s.renderedResult=void 0,t.reuseViewport||(s.textContent=""),this.ly.set(t.id,s);for(let e=t.firstMasterBarIndex;e<=t.lastMasterBarIndex;e++)e>=0&&this.oy.set(e,s);this.Qm.settings.core.enableLazyLoading&&(this.hy.unobserve(s),this.hy.observe(s)),this.iy++}else for(;e.childElementCount>this.iy;)this.Qm.settings.core.enableLazyLoading&&this.hy.unobserve(e.lastChild),e.removeChild(e.lastElementChild)}createWorkerPlayer(){let t=null;const e="ScriptProcessorNode"in window;return window.isSecureContext&&"AudioWorkletNode"in window&&this.Qm.settings.player.outputMode===ls.WebAudioAudioWorklets?(J.debug("Player","Will use webworkers for synthesizing and web audio api with worklets for playback"),t=new uh(new Bi(this.Qm.settings),this.Qm.settings)):e&&(J.debug("Player","Will use webworkers for synthesizing and web audio api with ScriptProcessor for playback"),t=new uh(new lh,this.Qm.settings)),t?t.ready.on(()=>{this.Qm.settings.player.soundFont&&this.Qm.loadSoundFontFromUrl(this.Qm.settings.player.soundFont,!1)}):J.error("Player","Player requires webworkers and web audio api, browser unsupported",null),t}createWorkerAudioExporter(t){const e=null===t||!(t instanceof uh);return e&&(t=this.createWorkerPlayer()),new bh(t,e)}beginInvoke(t){window.requestAnimationFrame(()=>{t()})}xy=[];highlightElements(t,e){const s=this.oy.get(e);if(s){const e=s.getElementsByClassName(t);for(let t=0;t<e.length;t++)e.item(t).classList.add("at-highlight"),this.xy.push(e.item(t))}}removeHighlights(){const t=this.xy;if(t){for(const e of t)e.classList.remove("at-highlight");this.xy=[]}}destroyCursors(){const t=this.Qm.container.element,e=t.querySelector(".at-cursors");t.removeChild(e)}createCursors(){const t=this.Qm.container.element,e=document.createElement("div");e.classList.add("at-cursors");const s=document.createElement("div");s.classList.add("at-selection");const i=this.createScalingElement(),n=this.createScalingElement(),r=i.element;r.classList.add("at-cursor-bar");const a=n.element;return a.classList.add("at-cursor-beat"),t.style.position="relative",t.style.textAlign="left",e.style.position="absolute",e.style.zIndex="1000",e.style.display="inline",e.style.pointerEvents="none",s.style.position="absolute",r.style.position="absolute",r.style.left="0",r.style.top="0",r.style.willChange="transform",i.width=1,i.height=1,i.setBounds(0,0,1,1),a.style.position="absolute",a.style.transition="all 0s linear",a.style.left="0",a.style.top="0",a.style.willChange="transform",n.width=3,n.height=1,n.centerAtPosition=!0,n.setBounds(0,0,1,1),t.insertBefore(e,t.firstChild),e.appendChild(s),e.appendChild(r),e.appendChild(a),new sh(new oh(e),i,n,new oh(s))}getOffset(t,e){const s=e.element,i=s.getBoundingClientRect();let n=i.top+s.ownerDocument.defaultView.pageYOffset,r=i.left+s.ownerDocument.defaultView.pageXOffset;if(t){const e=t.element,s=e.nodeName.toLowerCase();if("html"!==s&&"body"!==s){const s=this.getOffset(null,t);n=n+e.scrollTop-s.y,r=r+e.scrollLeft-s.x}}const a=new Us;return a.x=r,a.y=n,a.w=i.width,a.h=i.height,a}My=null;getScrollContainer(){if(this.My)return this.My;let t="string"==typeof this.Qm.settings.player.scrollElement?document.querySelector(this.Qm.settings.player.scrollElement):this.Qm.settings.player.scrollElement;const e=t.nodeName.toLowerCase();if("html"===e||"body"===e)if("scrollingElement"in document)t=document.scrollingElement;else{t=-1!==navigator.userAgent.indexOf("WebKit")?document.body:document.documentElement}return this.My=new oh(t),this.My}createSelectionElement(){return this.createScalingElement()}createScalingElement(){const t=document.createElement("div");t.style.position="absolute";const e=new fh(t,100,100);return e.width=1,e.height=1,e.setBounds(0,0,1,1),e}scrollToY(t,e,s){this.vy(t.element,e,s)}scrollToX(t,e,s){this.Ny(t.element,e,s)}stopScrolling(t){const e=this.Py.get(t.element);void 0!==e&&this.Cy.delete(e)}get Ey(){const t=this.Qm.settings.player;return t.nativeBrowserSmoothScroll&&t.scrollMode!==cs.Smooth}Fy=0;Cy=new Set;Py=new Map;vy(t,e,s){this.Ey?t.scrollTo({top:e,behavior:"smooth"}):this.Ay(t,t.scrollTop,e,s,e=>{t.scrollTop=e})}Ay(t,e,s,i,n){const r=this.Py.get(t);if(void 0!==r&&this.Cy.delete(r),0===i)return void n(s);const a=this.Fy++;this.Py.set(t,a),this.Cy.add(a);const h=s-e;let o=0;const c=t=>{if(!this.Cy.has(a))return;0===o&&(o=t);const s=t-o,r=Math.min(s/i,1);n(e+h*r|0),s<i?window.requestAnimationFrame(c):this.Cy.delete(a)};window.requestAnimationFrame(c)}Ny(t,e,s){this.Ey?t.scrollTo({left:e,behavior:"smooth"}):this.Ay(t,t.scrollLeft,e,s,e=>{t.scrollLeft=e})}createBackingTrackPlayer(){return new Za(new ph,this.Qm.settings.player.bufferTimeInMilliseconds)}}class gh{loaded;total;constructor(t,e){this.loaded=t,this.total=e}}class wh extends nh{constructor(t,e){super(new mh(t),e)}tex(t,e){const s=this.uiFacade;super.tex(t,s.parseTracks(e))}print(t,e=null){const s=window.open("","","width=0,height=0"),i=s.document.createElement("div");t?i.style.width=t:this.settings.display.layoutMode===Je.Horizontal?i.style.width="297mm":i.style.width="210mm",s.document.write("\n        <!DOCTYPE html>\n        <html>\n          <head>\n            <style>\n            .at-surface {\n                width: auto !important;\n                height: auto !important;\n            }\n            .at-surface > div {\n                position: relative!important;\n                left: auto !important;\n                top: auto !important;\n                break-inside: avoid;\n            }\n            </style>\n          </head>\n          <body></body>\n        </html>\n        ");const n=this.score;n&&(n.artist&&n.title?s.document.title=`${n.title} - ${n.artist}`:n.title&&(s.document.title=`${n.title}`)),s.document.body.appendChild(i);const r=void 0!==window.screenLeft?window.screenLeft:window.left,a=void 0!==window.screenTop?window.screenTop:window.top,h="innerWidth"in window?window.innerWidth:"clientWidth"in document.documentElement?document.documentElement.clientWidth:window.screen.width,o="innerHeight"in window?window.innerHeight:"clientHeight"in document.documentElement?document.documentElement.clientHeight:window.screen.height,c=i.offsetWidth+50,l=window.innerHeight,u=(h/2|0)-(c/2|0)+r,d=(o/2|0)-(l/2|0)+a;s.resizeTo(c,l),s.moveTo(u,d),s.focus();const f=aa.jsObjectToSettings(aa.settingsToJsObject(this.settings));f.core.enableLazyLoading=!1,f.core.useWorkers=!0,f.core.file=null,f.core.tracks=null,f.player.enableCursor=!1,f.player.playerMode=us.Disabled,f.player.enableElementHighlighting=!1,f.player.enableUserInteraction=!1,f.player.soundFont=null,f.display.scale=.8,f.display.stretchForce=.8,sa.fromJson(f,e);const p=new wh(i,f);s.onunload=()=>{p.destroy()},p.renderer.postRenderFinished.on(()=>{s.print()}),p.renderTracks(this.tracks)}downloadMidi(t=qe.SingleTrackMultiChannel){if(!this.score)return;const e=new Ti;e.format=t;const s=new ka(e,!0);new Da(this.score,this.settings,s).generate();const i=e.toBinary(),n=this.score.title?`${this.score.title}.mid`:"File.mid",r=document.createElement("a");r.download=n;const a=new Blob([i],{type:"audio/midi"}),h=URL.createObjectURL(a);r.href=h,r.style.display="none",document.body.appendChild(r),r.click(),document.body.removeChild(r)}changeTrackMute(t,e){const s=this.Dy(this.uiFacade.parseTracks(t));super.changeTrackMute(s,e)}changeTrackSolo(t,e){const s=this.Dy(this.uiFacade.parseTracks(t));super.changeTrackSolo(s,e)}changeTrackVolume(t,e){const s=this.Dy(this.uiFacade.parseTracks(t));super.changeTrackVolume(s,e)}Dy(t){if(!this.score)return[];const e=[];if(1===t.length&&-1===t[0])for(const t of this.score.tracks)e.push(t);else for(const s of t)s>=0&&s<this.score.tracks.length&&e.push(this.score.tracks[s]);return e}soundFontLoad=new mi;loadSoundFontFromUrl(t,e){const s=this.player;if(!s)return;J.debug("AlphaSynth",`Start loading Soundfont from url ${t}`);const i=new XMLHttpRequest;i.open("GET",t,!0,null,null),i.responseType="arraybuffer",i.onload=t=>{const s=new Uint8Array(i.response);this.loadSoundFont(s,e)},i.onerror=t=>{J.error("AlphaSynth",`Loading failed: ${t.message}`),s.soundFontLoadFailed.trigger(new rh(t.message,i))},i.onprogress=t=>{J.debug("AlphaSynth",`Soundfont downloading: ${t.loaded}/${t.total} bytes`);const e=new gh(t.loaded,t.total);this.soundFontLoad.trigger(e),this.uiFacade.triggerEvent(this.container,"soundFontLoad",e)},i.send()}}class yh{exec(t,e,s){if("string"!=typeof e&&(s=[e],e="init"),95===e.charCodeAt(0)||"exec"===e)return null;const i=new jQuery(t),n=i.data("alphaTab");if("destroy"===e&&!n)return null;if("init"!==e&&!n)throw new Error("alphaTab not initialized");const r=this[e];if(r){const t=[i,n].concat(s);return r.apply(this,t)}return J.error("Api",`Method '${e}' does not exist on jQuery.alphaTab`),null}init(t,e,s){if(!e){e=new wh(t[0],s),t.data("alphaTab",e);for(const i of this.Ly)i(t,e,s)}}destroy(t,e){t.removeData("alphaTab"),e.destroy()}print(t,e,s,i){e.print(s,i)}load(t,e,s,i){return e.load(s,i)}render(t,e){e.render()}renderScore(t,e,s,i){e.renderScore(s,i)}renderTracks(t,e,s){e.renderTracks(s)}invalidate(t,e){e.render()}tex(t,e,s,i){e.tex(s,i)}muteTrack(t,e,s,i){e.changeTrackMute(s,i)}soloTrack(t,e,s,i){e.changeTrackSolo(s,i)}trackVolume(t,e,s,i){e.changeTrackVolume(s,i)}loadSoundFont(t,e,s,i){e.loadSoundFont(s,i)}resetSoundFonts(t,e){e.resetSoundFonts()}pause(t,e){e.pause()}play(t,e){return e.play()}playPause(t,e){e.playPause()}stop(t,e){e.stop()}api(t,e){return e}player(t,e){return e.player}isReadyForPlayback(t,e){return e.isReadyForPlayback}playerState(t,e){return e.playerState}masterVolume(t,e,s){return"number"==typeof s&&(e.masterVolume=s),e.masterVolume}metronomeVolume(t,e,s){return"number"==typeof s&&(e.metronomeVolume=s),e.metronomeVolume}countInVolume(t,e,s){return"number"==typeof s&&(e.countInVolume=s),e.countInVolume}midiEventsPlayedFilter(t,e,s){return Array.isArray(s)&&(e.midiEventsPlayedFilter=s),e.midiEventsPlayedFilter}playbackSpeed(t,e,s){return"number"==typeof s&&(e.playbackSpeed=s),e.playbackSpeed}tickPosition(t,e,s){return"number"==typeof s&&(e.tickPosition=s),e.tickPosition}timePosition(t,e,s){return"number"==typeof s&&(e.timePosition=s),e.timePosition}loop(t,e,s){return"boolean"==typeof s&&(e.isLooping=s),e.isLooping}renderer(t,e){return e.renderer}score(t,e){return e.score}settings(t,e){return e.settings}tracks(t,e){return e.tracks}Ly=[];Wy(t){this.Ly.push(t)}static restore(t){new jQuery(t).empty().removeData("alphaTab")}}var kh,Sh,Bh,_h,Th,xh,Mh,vh="function"==typeof SuppressedError?SuppressedError:function(t,e,s){var i=new Error(s);return i.name="SuppressedError",i.error=t,i.suppressed=e,i};class Nh{static Oy;static Ry=null;static enable(t,e){Nh.Oy=e,Nh.initializeMusicFont(Nh.Oy.AlphaSkiaTypeface.register(t))}static initializeMusicFont(t){Nh.Ry=new Nh.Oy.AlphaSkiaTextStyle([t.familyName],t.weight,t.isItalic)}static registerFont(t,e){const s=Nh.Oy.AlphaSkiaTypeface.register(t.buffer);return e||(e=Vr.withFamilyList([s.familyName],12,s.isItalic?rs.Italic:rs.Plain,s.weight>400?as.Bold:as.Regular)),e}qp;Kp=new ke(0,0,0,0);tb=0;Iy=null;Gy=1;Hy=new Map;Qp=new Vr("Arial",10,rs.Plain);Vy=null;settings;get font(){return this.Qp}set font(t){if(this.Qp===t)return;this.Qp=t;const e=this.$y(t);if(this.Hy.has(e))this.Iy=this.Hy.get(e);else{const s=new Nh.Oy.AlphaSkiaTextStyle(t.families,t.weight===as.Bold?700:400,t.isItalic);this.Hy.set(e,s),this.Iy=s}}$y(t){return[...t.families,t.weight.toString(),t.isItalic?"italic":"upright"].join("_")}constructor(){this.qp=new Nh.Oy.AlphaSkiaCanvas,this.color=new ke(0,0,0,255)}destroy(){this.qp[Symbol.dispose]();for(const t of this.Hy.values())t[Symbol.dispose]()}onRenderFinished(){return null}beginRender(t,e){this.Gy=this.settings.display.scale,this.qp.beginRender(t,e,Pu.highDpiFactor);const s=this.settings.display.resources.smuflFontFamilyName;s&&s!==Nh.Ry.familyNames[0]?this.Hy.has(s)?this.Vy=this.Hy.get(s):(this.Vy=new Nh.Oy.AlphaSkiaTextStyle([s],Nh.Ry.weight,Nh.Ry.isItalic),this.Hy.set(s,this.Vy)):this.Vy=Nh.Ry}endRender(){return this.qp.endRender()}get color(){return this.Kp}set color(t){this.Kp.rgba!==t.rgba&&(this.Kp=t,this.qp.color=Nh.Oy.AlphaSkiaCanvas.rgbaToColor(t.r,t.g,t.b,t.a))}get lineWidth(){return this.tb}set lineWidth(t){this.tb=t,this.qp.lineWidth=t}fillRect(t,e,s,i){s>0&&this.qp.fillRect(t*this.Gy,e*this.Gy,s*this.Gy,i*this.Gy)}strokeRect(t,e,s,i){const n=this.lineWidth%2==0?0:.5;this.qp.strokeRect(t*this.Gy+n,e*this.Gy+n,s*this.Gy,i*this.Gy)}beginPath(){this.qp.beginPath()}closePath(){this.qp.closePath()}moveTo(t,e){this.qp.moveTo(t*this.Gy,e*this.Gy)}lineTo(t,e){this.qp.lineTo(t*this.Gy,e*this.Gy)}quadraticCurveTo(t,e,s,i){this.qp.quadraticCurveTo(t*this.Gy,e*this.Gy,s*this.Gy,i*this.Gy)}bezierCurveTo(t,e,s,i,n,r){this.qp.bezierCurveTo(t*this.Gy,e*this.Gy,s*this.Gy,i*this.Gy,n*this.Gy,r*this.Gy)}fillCircle(t,e,s){this.qp.fillCircle(t*this.Gy,e*this.Gy,s*this.Gy)}strokeCircle(t,e,s){this.qp.strokeCircle(t*this.Gy,e*this.Gy,s*this.Gy)}fill(){this.qp.fill()}stroke(){this.qp.stroke()}textAlign=at.Left;textBaseline=ht.Top;beginGroup(t){}endGroup(){}fillText(t,e,s){if(0===t.length)return;let i=Nh.Oy.AlphaSkiaTextAlign.Left;switch(this.textAlign){case at.Left:i=Nh.Oy.AlphaSkiaTextAlign.Left;break;case at.Center:i=Nh.Oy.AlphaSkiaTextAlign.Center;break;case at.Right:i=Nh.Oy.AlphaSkiaTextAlign.Right}let n=Nh.Oy.AlphaSkiaTextBaseline.Top;switch(this.textBaseline){case ht.Top:n=Nh.Oy.AlphaSkiaTextBaseline.Top;break;case ht.Middle:n=Nh.Oy.AlphaSkiaTextBaseline.Middle;break;case ht.Bottom:n=Nh.Oy.AlphaSkiaTextBaseline.Bottom;break;case ht.Alphabetic:n=Nh.Oy.AlphaSkiaTextBaseline.Alphabetic}this.qp.fillText(t,this.Iy,this.Qp.size*this.Gy,e*this.Gy,s*this.Gy,i,n)}measureText(t){const e={stack:[],error:void 0,hasError:!1};try{const s=function(t,e,s){if(null!=e){if("object"!=typeof e&&"function"!=typeof e)throw new TypeError("Object expected.");var i,n;if(s){if(!Symbol.asyncDispose)throw new TypeError("Symbol.asyncDispose is not defined.");i=e[Symbol.asyncDispose]}if(void 0===i){if(!Symbol.dispose)throw new TypeError("Symbol.dispose is not defined.");i=e[Symbol.dispose],s&&(n=i)}if("function"!=typeof i)throw new TypeError("Object not disposable.");n&&(i=function(){try{n.call(this)}catch(t){return Promise.reject(t)}}),t.stack.push({value:e,dispose:i,async:s})}else s&&t.stack.push({async:!0});return e}(e,this.qp.measureText(t,this.Iy,this.Qp.size,Nh.Oy.AlphaSkiaTextAlign.Left,Nh.Oy.AlphaSkiaTextBaseline.Alphabetic),!1),[i,n]=this.Uy(s,t);return new Ot(i,n)}catch(t){e.error=t,e.hasError=!0}finally{!function(t){function e(e){t.error=t.hasError?new vh(e,t.error,"An error was suppressed during disposal."):e,t.hasError=!0}var s,i=0;(function n(){for(;s=t.stack.pop();)try{if(!s.async&&1===i)return i=0,t.stack.push(s),Promise.resolve().then(n);if(s.dispose){var r=s.dispose.call(s.value);if(s.async)return i|=2,Promise.resolve(r).then(n,function(t){return e(t),n()})}else i|=1}catch(t){e(t)}if(1===i)return t.hasError?Promise.reject(t.error):Promise.resolve();if(t.hasError)throw t.error})()}(e)}}Uy(t,e){let s=t.width;if(e.length>0&&s<1)for(let e=0;e<5&&(s=t.width,!(s>1));e++);return[s,t.actualBoundingBoxAscent+t.actualBoundingBoxDescent]}fillMusicFontSymbol(t,e,s,i,n){i!==lt.None&&this.eb(t,e,s,String.fromCharCode(i),n)}fillMusicFontSymbols(t,e,s,i,n){let r="";for(const t of i)t!==lt.None&&(r+=String.fromCharCode(t));this.eb(t,e,s,r,n)}eb(t,e,s,i,n){this.qp.fillText(i,this.Vy,this.settings.display.resources.engravingSettings.musicFontSize*this.Gy*s,t*this.Gy,e*this.Gy,n?Nh.Oy.AlphaSkiaTextAlign.Center:Nh.Oy.AlphaSkiaTextAlign.Left,Nh.Oy.AlphaSkiaTextBaseline.Alphabetic)}beginRotate(t,e,s){this.qp.beginRotate(t*this.Gy,e*this.Gy,s)}endRotate(){this.qp.endRotate()}}class Ph{buffer="";zy="";Xy=!0;scale=1;color=new ke(255,255,255,255);lineWidth=1;font=new Vr("Arial",10,rs.Plain);textAlign=at.Left;textBaseline=ht.Top;settings;destroy(){}beginRender(t,e){this.scale=this.settings.display.scale,this.buffer=`<svg xmlns="http://www.w3.org/2000/svg" version="1.1" width="${0|t}px" height="${0|e}px" class="at-surface-svg">\n`,this.zy="",this.Xy=!0,this.textBaseline=ht.Top}beginGroup(t){this.buffer+=`<g class="${t}">`}endGroup(){this.buffer+="</g>"}endRender(){return this.buffer+="</svg>",this.buffer}fillRect(t,e,s,i){s>0&&(this.buffer+=`<rect x="${t*this.scale}" y="${e*this.scale}" width="${s*this.scale}" height="${i*this.scale}" fill="${this.color.rgba}" />\n`)}strokeRect(t,e,s,i){const n=this.lineWidth*this.scale%2==0?0:.5;this.buffer+=`<rect x="${t*this.scale+n}" y="${e*this.scale+n}" width="${s*this.scale}" height="${i*this.scale}" stroke="${this.color.rgba}"`,1!==this.lineWidth&&(this.buffer+=` stroke-width="${this.lineWidth*this.scale}"`),this.buffer+=' fill="transparent" />\n'}beginPath(){}closePath(){this.zy+=" z"}moveTo(t,e){this.zy+=` M${t*this.scale},${e*this.scale}`}lineTo(t,e){this.Xy=!1,this.zy+=` L${t*this.scale},${e*this.scale}`}quadraticCurveTo(t,e,s,i){this.Xy=!1,this.zy+=` Q${t*this.scale},${e*this.scale},${s*this.scale},${i*this.scale}`}bezierCurveTo(t,e,s,i,n,r){this.Xy=!1,this.zy+=` C${t*this.scale},${e*this.scale},${s*this.scale},${i*this.scale},${n*this.scale},${r*this.scale}`}fillCircle(t,e,s){this.Xy=!1,t*=this.scale,e*=this.scale,s*=this.scale,this.zy+=` M${t-s},${e} A1,1 0 0,0 ${t+s},${e} A1,1 0 0,0 ${t-s},${e} z`,this.fill()}strokeCircle(t,e,s){this.Xy=!1,t*=this.scale,e*=this.scale,s*=this.scale,this.zy+=` M${t-s},${e} A1,1 0 0,0 ${t+s},${e} A1,1 0 0,0 ${t-s},${e} z`,this.stroke()}fill(){this.Xy||(this.buffer+=`<path d="${this.zy}"`,"#000000"!==this.color.rgba&&(this.buffer+=` fill="${this.color.rgba}"`),this.buffer+=' style="stroke: none"/>'),this.zy="",this.Xy=!0}stroke(){if(!this.Xy){let t=`<path d="${this.zy}" stroke="${this.color.rgba}"`;1===this.lineWidth&&1===this.scale||(t+=` stroke-width="${this.lineWidth*this.scale}"`),t+=' style="fill: none" />',this.buffer+=t}this.zy="",this.Xy=!0}fillText(t,e,s){if(""===t)return;let i=`<text x="${e*this.scale}" y="${s*this.scale}" style='stroke: none; font:${this.font.toCssString(this.settings.display.scale)}; ${this.getSvgBaseLine()}'`;"#000000"!==this.color.rgba&&(i+=` fill="${this.color.rgba}"`),this.textAlign!==at.Left&&(i+=` text-anchor="${this.getSvgTextAlignment(this.textAlign)}"`),i+=`>${Ph.jy(t)}</text>`,this.buffer+=i}static jy(t){return t.replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}getSvgTextAlignment(t){switch(t){case at.Left:return"start";case at.Center:return"middle";case at.Right:return"end"}return""}getSvgBaseLine(){switch(this.textBaseline){case ht.Top:return"dominant-baseline: hanging";case ht.Bottom:return"dominant-baseline: ideographic";case ht.Alphabetic:return"";case ht.Middle:return"dominant-baseline: middle";default:return""}}measureText(t){return t?ca.measureString(t,this.font.families,this.font.size,this.font.style,this.font.weight):new Ot(0,0)}onRenderFinished(){return null}beginRotate(t,e,s){this.buffer+=`<g transform="translate(${t*this.scale} ,${e*this.scale}) rotate( ${s})">`}endRotate(){this.buffer+="</g>"}}class Ch extends Ph{fillMusicFontSymbol(t,e,s,i,n){i!==lt.None&&this.eb(t,e,s,`&#${i};`,n)}fillMusicFontSymbols(t,e,s,i,n){let r="";for(const t of i)t!==lt.None&&(r+=`&#${t};`);this.eb(t,e,s,r,n)}eb(t,e,s,i,n){t*=this.scale,e*=this.scale,this.buffer+=`<g transform="translate(${t} ${e})" class="at" ><text`;const r=this.scale*s;this.buffer+=1!==r?` style="font-size: ${100*r}%; stroke:none"`:' style="stroke:none"',"#000000"!==this.color.rgba&&(this.buffer+=` fill="${this.color.rgba}"`),n&&(this.buffer+=` text-anchor="${this.getSvgTextAlignment(at.Center)}"`),this.buffer+=`>${i}</text></g>`}}!function(t){t[t.OwnedTop=0]="OwnedTop",t[t.OwnedBottom=1]="OwnedBottom",t[t.SharedTop=2]="SharedTop",t[t.SharedBottom=3]="SharedBottom"}(kh||(kh={}));class Eh{hideOnMultiTrack=!1;hideOnPercussionTrack=!1;effectBands;constructor(t){this.effectBands=t}canCreate(t,e){return!this.hideOnPercussionTrack||!e.isPercussion}}!function(t){t[t.SinglePreBeat=0]="SinglePreBeat",t[t.SingleOnBeat=1]="SingleOnBeat",t[t.SingleOnBeatToEnd=2]="SingleOnBeatToEnd",t[t.GroupedOnBeat=3]="GroupedOnBeat",t[t.GroupedOnBeatToEnd=4]="GroupedOnBeatToEnd",t[t.FullBar=5]="FullBar"}(Sh||(Sh={}));class Fh extends Oa{beat=null;nextGlyph=null;previousGlyph=null;constructor(t=0,e=0){super(t,e)}}class Ah extends Fh{Jy;qy="";Yy;Ky;Ln;constructor(t,e,s,i,n,r){super(t,e),this.Jy=zt.getAlternateEndingsList(s),this.Yy=i,this.Ky=n,this.Ln=r}doLayout(){super.doLayout(),this.height=this.renderer.resources.elementFonts.get(B.EffectAlternateEndings).size+2*this.renderer.smuflMetrics.alternateEndingsPadding;let t="";for(let e=0,s=this.Jy.length;e<s;e++)t+=this.Jy[e]+1,t+=". ";this.qy=t}paint(t,e,s){let i=this.Ky?this.width-s.lineWidth:this.width;if(this.renderer.bar.getActualBarLineRight()===E.LightHeavy&&(i-=this.renderer.smuflMetrics.thickBarlineThickness+this.renderer.smuflMetrics.barlineSeparation),t=(0|t)+s.lineWidth/2,e=(0|e)+s.lineWidth/2,this.Ln&&(t+=this.renderer.smuflMetrics.alternateEndingsPadding,i-=this.renderer.smuflMetrics.alternateEndingsPadding),this.Yy?(s.moveTo(t+this.x,e+this.y+this.height),s.lineTo(t+this.x,e+this.y)):s.moveTo(t+this.x,e+this.y),s.lineTo(t+this.x+i,e+this.y),this.Ky&&s.lineTo(t+this.x+i,e+this.y+this.height),s.stroke(),this.Yy){const i=s.textBaseline;s.textBaseline=ht.Top;const n=this.renderer.resources;s.font=n.elementFonts.get(B.EffectAlternateEndings),s.fillText(this.qy,t+this.x+this.renderer.smuflMetrics.alternateEndingsPadding,e+this.y+this.renderer.smuflMetrics.alternateEndingsPadding),s.textBaseline=i}}}class Dh{get effectId(){return this.notationElement.toString()}finalizeBand(t){}onAlignGlyphs(t){}}class Lh extends Dh{get notationElement(){return B.EffectAlternateEndings}get hideOnMultiTrack(){return!0}get canShareBand(){return!1}get sizingMode(){return Sh.FullBar}shouldCreateGlyph(t,e){return 0===e.voice.index&&0===e.index&&0!==e.voice.bar.masterBar.alternateEndings}createNewGlyph(t,e){const s=e.voice.bar.masterBar,i=null===s.previousMasterBar||s.alternateEndings!==s.previousMasterBar.alternateEndings;let n=s.isRepeatEnd||null===s.nextMasterBar||s.alternateEndings!==s.nextMasterBar.alternateEndings;s.repeatGroup.closings.some(t=>t.index>=s.index)||(n=!1);const r=null!==s.previousMasterBar&&s.alternateEndings!==s.previousMasterBar.alternateEndings&&s.previousMasterBar.alternateEndings>0;return new Ah(0,0,s.alternateEndings,i,n,r)}canExpand(t,e){return!0}}class Wh extends Fh{endPosition;forceGroupedRendering=!1;endOnBarLine=!1;constructor(t){super(),this.endPosition=t}get isLinkedWithPrevious(){return!!this.previousGlyph&&this.previousGlyph.renderer.staff?.system===this.renderer.staff.system}get isLinkedWithNext(){return!!this.nextGlyph&&this.nextGlyph.renderer.isFinalized&&this.nextGlyph.renderer.staff?.system===this.renderer.staff.system}paint(t,e,s){if(this.isLinkedWithPrevious)return;if(!this.isLinkedWithNext&&!this.forceGroupedRendering)return void this.paintNonGrouped(t,e,s);let i;if(!this.isLinkedWithNext&&this.forceGroupedRendering)i=this;else for(i=this.nextGlyph;i.isLinkedWithNext;)i=i.nextGlyph;const n=i.renderer,r=i.beat,a=this.endPosition,h=t-this.renderer.x,o=this.calculateEndX(n,r,h,a);this.paintGrouped(t,e,o,s)}calculateEndX(t,e,s,i){return e?s+t.x+t.getBeatX(e,i):s+t.x+this.x+this.width}paintNonGrouped(t,e,s){const i=t-this.renderer.x,n=this.calculateEndX(this.renderer,this.beat,i,this.endPosition);this.paintGrouped(t,e,n,s)}}class Oh extends Wh{Qy;Zy;tk=0;ek;constructor(t,e,s=!0){super(bs.OnNotes),this.Qy=t,this.Zy=s,this.ek=e}doLayout(){this.renderer.settings.notation.extendLineEffectsToBeatEnd&&(this.endPosition=bs.EndBeat,this.forceGroupedRendering=!0),super.doLayout(),this.renderer.scoreRenderer.canvas.font=this.renderer.resources.elementFonts.get(this.ek);const t=this.renderer.scoreRenderer.canvas.measureText(this.Qy);this.height=t.height,this.tk=t.width}paintNonGrouped(t,e,s){const i=this.renderer.resources;s.font=i.elementFonts.get(this.ek);const n=s.textBaseline;s.textBaseline=ht.Middle,s.fillText(this.Qy,t+this.x-this.tk/2,e+this.y+this.height/2),s.textBaseline=n}paintGrouped(t,e,s,i){this.paintNonGrouped(t,e,i);const n=this.renderer.smuflMetrics.lineRangedGlyphDashGap,r=this.renderer.smuflMetrics.lineRangedGlyphDashSize,a=this.renderer.smuflMetrics.pedalLineThickness,h=t+this.x+this.tk/2+n/2,o=e+this.y+this.height/2-a/2;if(this.Zy){if(s>h){let t=h;for(;t<s;){const e=Math.min(t+r,s);i.fillRect(t,o,e-t,a),t+=r+n}i.fillRect(s,o-r/2+a/2,a,r)}}else i.fillRect(h,o,s-h,a),i.fillRect(s-a,o,a,r/2)}}class Rh extends Dh{get notationElement(){return B.EffectLetRing}get canShareBand(){return!1}get hideOnMultiTrack(){return!1}shouldCreateGlyph(t,e){return e.isBarre}get sizingMode(){return Sh.GroupedOnBeat}createNewGlyph(t,e){let s="";switch(e.barreShape){case wt.None:case wt.Full:break;case wt.Half:s+="1/2"}return s+=`B ${Rh.toRoman(e.barreFret)}`,new Oh(s,B.EffectBeatBarre,!1)}static sk=new Map([["L",50],["XL",40],["X",10],["IX",9],["V",5],["IV",4],["I",1]]);static toRoman(t){let e="";if(t>0)for(const[s,i]of Rh.sk){const n=Math.floor(t/i);t-=n*i,e+=s.repeat(n)}return e}canExpand(t,e){return t.barreFret===e.barreFret&&t.barreShape===e.barreShape}}class Ih extends Fh{u;ik="";nk=0;rk=0;constructor(t){super(0,0),this.u=t}doLayout(){const t=this.u/6e4|0,e=(this.u-6e4*t)/1e3|0;this.ik=`${t}:${e.toString().padStart(2,"0")}`;const s=this.renderer.scoreRenderer.canvas;s.font=this.renderer.resources.elementFonts.get(B.EffectBeatTimer);const i=s.measureText(this.ik);this.rk=s.font.size+2*this.renderer.smuflMetrics.beatTimerPadding,this.nk=i.width+2*this.renderer.smuflMetrics.beatTimerPadding,this.height=this.rk+2*this.renderer.smuflMetrics.beatTimerPadding}paint(t,e,s){const i=this.nk/2|0;s.strokeRect(t+this.x-i,e+this.y+this.renderer.smuflMetrics.beatTimerPadding,this.nk,this.rk);const n=s.font,r=s.textBaseline,a=s.textAlign;s.font=this.renderer.resources.elementFonts.get(B.EffectBeatTimer),s.textBaseline=ht.Middle,s.textAlign=at.Center,s.fillText(this.ik,t+this.x,e+this.y+this.height/2),s.font=n,s.textBaseline=r,s.textAlign=a}}class Gh extends Dh{get notationElement(){return B.EffectBeatTimer}get hideOnMultiTrack(){return!0}get canShareBand(){return!0}get sizingMode(){return Sh.SingleOnBeat}shouldCreateGlyph(t,e){return e.showTimer}createNewGlyph(t,e){return new Ih(e.timer??0)}canExpand(t,e){return!0}}class Hh extends Fh{ak;hk=null;font;textAlign;textBaseline;colorOverride;constructor(t,e,s,i,n=at.Left,r=null,a){super(t,e),this.ak=s.split("\n"),this.font=i,this.textAlign=n,this.textBaseline=r,this.colorOverride=a}doLayout(){super.doLayout(),this.hk=[];const t=this.renderer.scoreRenderer.canvas;for(const e of this.ak){t.font=this.font;const s=t.measureText(e),i=s.height;this.hk.push(i),this.height+=i,this.width=Math.max(this.width,s.width)}}paint(t,e,s){const i=s.color;s.color=this.colorOverride??i,s.font=this.font;const n=s.textAlign,r=s.textBaseline;s.textAlign=this.textAlign,null!==this.textBaseline&&(s.textBaseline=this.textBaseline);let a=e+this.y;for(let e=0;e<this.ak.length;e++)s.fillText(this.ak[e],t+this.x,a),a+=this.hk[e];s.textAlign=n,s.textBaseline=r,s.color=i}}class Vh extends Dh{get notationElement(){return B.EffectCapo}get hideOnMultiTrack(){return!1}get canShareBand(){return!1}get sizingMode(){return Sh.SingleOnBeat}shouldCreateGlyph(t,e){return 0===e.index&&0===e.voice.bar.index&&0!==e.voice.bar.staff.capo}createNewGlyph(t,e){return new Hh(0,0,`Capo. fret ${e.voice.bar.staff.capo}`,t.resources.elementFonts.get(B.EffectCapo),at.Left)}canExpand(t,e){return!1}}class $h extends Fh{static ck=5;lk;uk=0;dk=0;fk=0;pk;ek;constructor(t,e,s,i,n=!1){super(t,e),this.lk=s,this.pk=n,this.ek=i}doLayout(){super.doLayout();const t=this.renderer.resources.elementFonts.get(this.ek);if(this.uk=1.5*t.size,this.dk=1.5*t.size,this.height=this.uk,this.width=2*this.renderer.smuflMetrics.chordDiagramPaddingX,this.renderer.settings.notation.isNotationElementVisible(B.ChordDiagramFretboardNumbers))this.lk.firstFret>1?this.fk=this.renderer.smuflMetrics.chordDiagramFretSpacing:this.fk=0,this.height+=this.dk+$h.ck*this.renderer.smuflMetrics.chordDiagramFretSpacing+2*this.renderer.smuflMetrics.chordDiagramPaddingY,this.width+=this.fk+(this.lk.strings.length-1)*this.renderer.smuflMetrics.chordDiagramStringSpacing;else if(this.lk.showName){const e=this.renderer.scoreRenderer.canvas;e.font=t,this.width+=e.measureText(this.lk.name).width}}paint(t,e,s){t+=this.x+this.renderer.smuflMetrics.chordDiagramPaddingX+this.fk,e+=this.y,this.pk&&(t-=this.width/2);const i=this.renderer.resources,n=i.engravingSettings.chordDiagramLineWidth,r=this.width-2*this.renderer.smuflMetrics.chordDiagramPaddingX-this.fk+n,a=s.textAlign,h=s.textBaseline,o=i.elementFonts.get(this.ek);s.font=o,s.textAlign=at.Center,s.textBaseline=ht.Top,this.lk.showName&&s.fillText(this.lk.name,t+r/2,e+o.size/2),this.renderer.settings.notation.isNotationElementVisible(B.ChordDiagramFretboardNumbers)&&this.bk(t,e,s,r),s.textAlign=a,s.textBaseline=h}bk(t,e,s,i){e+=this.uk;const n=this.renderer.resources,r=this.renderer.smuflMetrics.chordDiagramStringSpacing,a=this.renderer.smuflMetrics.chordDiagramFretSpacing,h=n.engravingSettings.glyphHeights.get(lt.FretboardFilledCircle),o=n.engravingSettings.glyphTop.get(lt.FretboardFilledCircle),c=n.engravingSettings.glyphHeights.get(lt.FretboardX)/2,l=n.engravingSettings.glyphHeights.get(lt.FretboardO)/2,u=n.engravingSettings.chordDiagramLineWidth;s.font=n.elementFonts.get(B.ChordDiagramFretboardNumbers),s.textBaseline=ht.Middle;for(let i=0;i<this.lk.strings.length;i++){const n=t+i*r,a=e+this.dk/2;let h=this.lk.strings[this.lk.strings.length-i-1];h<0?Rt.fillMusicFontSymbolSafe(s,n,a+c,1,lt.FretboardX,!0):0===h?Rt.fillMusicFontSymbolSafe(s,n,a+l,1,lt.FretboardO,!0):(h-=this.lk.firstFret-1,s.fillText(h.toString(),n,a))}e+=this.dk;for(let i=0;i<this.lk.strings.length;i++){const n=t+i*r;s.fillRect(n,e,u,a*$h.ck+1)}this.lk.firstFret>1?(s.textAlign=at.Left,s.fillText(this.lk.firstFret.toString(),t-this.fk,e+a/2),s.fillRect(t,e,i,u)):s.fillRect(t,e-this.renderer.smuflMetrics.chordDiagramNutHeight/2,i,this.renderer.smuflMetrics.chordDiagramNutHeight);for(let n=0;n<=$h.ck;n++){const r=e+n*a;s.fillRect(t,r,i,this.renderer.smuflMetrics.chordDiagramFretHeight)}const d=new Map;for(const t of this.lk.barreFrets){const e=[-1,-1];d.set(t-this.lk.firstFret,e)}for(let i=0;i<this.lk.strings.length;i++){let n=this.lk.strings[i];if(n>0){if(n-=this.lk.firstFret,d.has(n)){const t=d.get(n);(-1===t[0]||i<t[0])&&(t[0]=i),(-1===t[1]||i>t[1])&&(t[1]=i)}const c=e+n*a+a/2+.5,l=t+(this.lk.strings.length-i-1)*r+u/2;Rt.fillMusicFontSymbolSafe(s,l,c+o-h/2,1,lt.FretboardFilledCircle,!0)}}for(const[i,n]of d){const o=e+i*a+a/2+.5,c=t+(this.lk.strings.length-n[1]-1)*r,l=t+(this.lk.strings.length-n[0]-1)*r;s.fillRect(c,o-h/2,l-c,h)}}}class Uh extends Dh{get notationElement(){return B.EffectChordNames}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return Sh.SingleOnBeat}shouldCreateGlyph(t,e){return e.hasChord}createNewGlyph(t,e){return e.voice.bar.staff.track.score.stylesheet.globalDisplayChordDiagramsInScore?new $h(0,0,e.chord,B.EffectChordNames,!0):new Hh(0,0,e.chord.name,t.resources.elementFonts.get(B.EffectChordNames),at.Center)}canExpand(t,e){return!1}}class zh extends Wh{Xn;constructor(t,e,s){super(bs.EndBeat),this.Xn=o.None,this.Xn=s,this.x=t,this.y=e}doLayout(){super.doLayout(),this.height=this.renderer.smuflMetrics.glyphHeights.get(lt.DynamicCrescendoHairpin)}paintGrouped(t,e,s,i){const n=t+this.x,r=this.height,a=this.renderer.smuflMetrics.glyphWidths.get(lt.NoteheadBlack)/2;i.beginPath(),this.Xn===o.Crescendo?(s-=a,i.moveTo(s,e+this.y),i.lineTo(n,e+this.y+r/2),i.lineTo(s,e+this.y+r)):(s-=a,i.moveTo(n,e+this.y),i.lineTo(s,e+this.y+r/2),i.lineTo(n,e+this.y+r));const h=i.lineWidth;i.lineWidth=this.renderer.smuflMetrics.hairpinThickness,i.stroke(),i.lineWidth=h}}class Xh extends Dh{get notationElement(){return B.EffectCrescendo}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return Sh.GroupedOnBeatToEnd}shouldCreateGlyph(t,e){return e.crescendo!==o.None}createNewGlyph(t,e){return new zh(0,0,e.crescendo)}canExpand(t,e){return t.crescendo===e.crescendo}}class jh extends Oa{mk;Gy=1;constructor(t){super(0,0),this.mk=t}doLayout(){this.height=0;const t=this.renderer.smuflMetrics.directionsScale;this.Gy=t;for(const e of this.mk){const s=this.renderer.smuflMetrics.glyphHeights.get(e)*t;s>this.height&&(this.height=s)}}paint(t,e,s){s.fillMusicFontSymbols(t+this.x,e+this.y+this.height,this.Gy,this.mk,!0)}}class Jh extends Oa{ik;constructor(t){super(0,0),this.ik=t}doLayout(){const t=this.renderer.scoreRenderer.canvas;t.font=this.renderer.resources.elementFonts.get(B.EffectDirections),this.height=t.measureText(this.ik).height}paint(t,e,s){const i=s.font,n=s.textBaseline,r=s.textAlign;s.font=this.renderer.resources.elementFonts.get(B.EffectDirections),s.textBaseline=ht.Middle,s.textAlign=at.Right,s.fillText(this.ik,t+this.x,e+this.y+this.height/2),s.font=i,s.textBaseline=n,s.textAlign=r}}class qh extends Fh{gk;wk=[];yk=[];constructor(t,e,s){super(t,e),this.gk=s}doLayout(){const t=this.gk;t.has(ze.TargetSegnoSegno)&&this.wk.push(new jh([lt.Segno,lt.Segno])),t.has(ze.TargetSegno)&&this.wk.push(new jh([lt.Segno])),t.has(ze.TargetDoubleCoda)&&this.wk.push(new jh([lt.Coda,lt.Coda])),t.has(ze.TargetCoda)&&this.wk.push(new jh([lt.Coda])),t.has(ze.TargetFine)&&this.yk.push(new Jh("Fine")),t.has(ze.JumpDaDoubleCoda)&&this.yk.push(new Jh("To Double Coda")),t.has(ze.JumpDaCoda)&&this.yk.push(new Jh("To Coda")),t.has(ze.JumpDalSegnoSegno)&&this.yk.push(new Jh("D.S.S.")),t.has(ze.JumpDalSegnoSegnoAlCoda)&&this.yk.push(new Jh("D.S.S. al Coda")),t.has(ze.JumpDalSegnoSegnoAlDoubleCoda)&&this.yk.push(new Jh("D.S.S. al Double Coda")),t.has(ze.JumpDalSegnoSegnoAlFine)&&this.yk.push(new Jh("D.S.S. al Fine")),t.has(ze.JumpDalSegno)&&this.yk.push(new Jh("D.S.")),t.has(ze.JumpDalSegnoAlCoda)&&this.yk.push(new Jh("D.S. al Coda")),t.has(ze.JumpDalSegnoAlDoubleCoda)&&this.yk.push(new Jh("D.S. al Double Coda")),t.has(ze.JumpDalSegnoAlFine)&&this.yk.push(new Jh("D.S. al Fine")),t.has(ze.JumpDaCapo)&&this.yk.push(new Jh("D.C.")),t.has(ze.JumpDaCapoAlCoda)&&this.yk.push(new Jh("D.C. al Coda")),t.has(ze.JumpDaCapoAlDoubleCoda)&&this.yk.push(new Jh("D.C. al Double Coda")),t.has(ze.JumpDaCapoAlFine)&&this.yk.push(new Jh("D.C. al Fine"));const e=this.kk(this.wk),s=this.kk(this.yk);this.height=Math.max(e,s)}kk(t){let e=0;const s=this.renderer.settings.display.effectBandPaddingBottom;for(const i of t)i.y=e,i.renderer=this.renderer,i.doLayout(),e+=i.height+s;return e}paint(t,e,s){for(const i of this.wk)i.paint(t+this.x,e+this.y,s);for(const i of this.yk)i.paint(t+this.x+this.width,e+this.y,s)}}class Yh extends Dh{get notationElement(){return B.EffectDirections}get hideOnMultiTrack(){return!0}get canShareBand(){return!1}get sizingMode(){return Sh.FullBar}shouldCreateGlyph(t,e){return 0===e.voice.index&&0===e.index&&null!==e.voice.bar.masterBar.directions&&e.voice.bar.masterBar.directions.size>0}createNewGlyph(t,e){return new qh(0,0,e.voice.bar.masterBar.directions)}canExpand(t,e){return!0}}class Kh extends Fh{glyphScale=0;symbol;center=!1;colorOverride;offsetX=0;offsetY=0;constructor(t,e,s,i){super(t,e),this.glyphScale=s,this.symbol=i}getBoundingBoxTop(){const t=this.renderer.smuflMetrics.glyphTop.get(this.symbol);return this.y-this.offsetY-t}doLayout(){this.width=this.renderer.smuflMetrics.glyphWidths.get(this.symbol)*this.glyphScale,this.height=this.renderer.smuflMetrics.glyphHeights.get(this.symbol)*this.glyphScale}paint(t,e,s){if(0===this.width&&0===this.height)return;const i=s.color;this.colorOverride&&(s.color=this.colorOverride),s.fillMusicFontSymbol(t+this.x+this.offsetX,e+this.y+this.offsetY,this.glyphScale,this.symbol,this.center),s.color=i}}class Qh extends Fh{glyphScale=0;symbols;center=!1;colorOverride;offsetX=0;offsetY=0;constructor(t,e,s,i){super(t,e),this.glyphScale=s,this.symbols=i}getBoundingBoxTop(){let t=0;for(let e=0;e<this.symbols.length;e++){const s=this.renderer.smuflMetrics.glyphTop.get(this.symbols[e]);(0===e||s<t)&&(t=s)}return this.y-this.offsetY-t}doLayout(){this.width=0,this.height=0;for(let t=0;t<this.symbols.length;t++){const e=this.renderer.smuflMetrics.glyphWidths.get(this.symbols[t])*this.glyphScale,s=this.renderer.smuflMetrics.glyphHeights.get(this.symbols[t])*this.glyphScale;(0===t||e>this.width)&&(this.width=e),(0===t||s>this.height)&&(this.height=s)}}paint(t,e,s){if(0===this.width&&0===this.height)return;const i=s.color;this.colorOverride&&(s.color=this.colorOverride),s.fillMusicFontSymbols(t+this.x+this.offsetX,e+this.y+this.offsetY,this.glyphScale,this.symbols,this.center),s.color=i}}class Zh extends Kh{constructor(t,e,s){super(t,e,1,Zh.Sk(s))}doLayout(){super.doLayout(),this.center=!0,this.height=this.renderer.smuflMetrics.glyphHeights.get(lt.DynamicForte);const t=this.renderer.smuflMetrics.glyphTop.get(lt.DynamicForte);this.offsetY=t}static Sk(t){switch(t){case i.PPP:return lt.DynamicPPP;case i.PP:return lt.DynamicPP;case i.P:return lt.DynamicPiano;case i.MP:return lt.DynamicMP;case i.MF:return lt.DynamicMF;case i.F:return lt.DynamicForte;case i.FF:return lt.DynamicFF;case i.FFF:return lt.DynamicFFF;case i.PPPP:return lt.DynamicPPPP;case i.PPPPP:case i.PPPPPP:return lt.DynamicPPPPP;case i.FFFF:return lt.DynamicFFFF;case i.FFFFF:return lt.DynamicFFFFF;case i.FFFFFF:return lt.DynamicFFFFFF;case i.SF:return lt.DynamicSforzando1;case i.SFP:return lt.DynamicSforzandoPiano;case i.SFPP:return lt.DynamicSforzandoPianissimo;case i.FP:return lt.DynamicFortePiano;case i.RF:return lt.DynamicRinforzando1;case i.RFZ:return lt.DynamicRinforzando2;case i.SFZ:return lt.DynamicSforzato;case i.SFFZ:return lt.DynamicSforzatoFF;case i.FZ:return lt.DynamicForzando;case i.N:return lt.DynamicNiente;case i.PF:return lt.DynamicPF;case i.SFZP:return lt.DynamicSforzatoPiano;default:return lt.None}}}class to extends Dh{get notationElement(){return B.EffectDynamics}get hideOnMultiTrack(){return!1}get canShareBand(){return!1}get sizingMode(){return Sh.SingleOnBeat}shouldCreateGlyph(t,e){return this.Bk(e)}Bk(t){if(t.voice.bar.staff.track.score.stylesheet.hideDynamics||t.isEmpty||t.voice.isEmpty||t.isRest)return!1;const e=this._k(t);let s=0===t.voice.index&&!e||t.dynamics!==e?.dynamics;if(s&&t.voice.index>0)for(const e of t.voice.bar.voices)if(e.index<t.voice.index){const i=e.getBeatAtPlaybackStart(t.playbackStart);i&&t.dynamics===i.dynamics&&this.Bk(i)&&(s=!1)}return s}_k(t){let e=t.previousBeat;for(;null!=e;){if(!e.isRest)return e;e=e.previousBeat}return null}createNewGlyph(t,e){return new Zh(0,0,e.dynamics)}canExpand(t,e){return!0}}class eo extends Kh{constructor(t){super(0,0,1,eo.Sk(t)),this.center=!0}static Sk(t){switch(t){case mt.FadeIn:return lt.GuitarFadeIn;case mt.FadeOut:return lt.GuitarFadeOut;case mt.VolumeSwell:return lt.GuitarVolumeSwell}return lt.None}paint(t,e,s){super.paint(t,e+this.height,s)}}class so extends Dh{get notationElement(){return B.EffectFadeIn}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return Sh.SingleOnBeat}shouldCreateGlyph(t,e){return e.fade!==mt.None}createNewGlyph(t,e){return new eo(e.fade)}canExpand(t,e){return!0}}class io extends Kh{constructor(t,e,s){super(t,e,1,io.Sk(s))}static Sk(t){switch(t){case At.Short:return lt.FermataShortAbove;case At.Medium:return lt.FermataAbove;case At.Long:return lt.FermataLongAbove;default:return lt.None}}paint(t,e,s){super.paint(t-this.width/2,e+this.height,s)}}class no extends Dh{get notationElement(){return B.EffectFermata}get hideOnMultiTrack(){return!1}get canShareBand(){return!1}get sizingMode(){return Sh.SingleOnBeat}shouldCreateGlyph(t,e){return 0===e.voice.index&&!!e.fermata}createNewGlyph(t,e){return new io(0,0,e.fermata.type)}canExpand(t,e){return!0}}class ro extends Oa{glyphs=null;get isEmpty(){return!this.glyphs||0===this.glyphs.length}getBoundingBoxTop(){let t=Number.NaN;const e=this.glyphs;if(e)for(const s of e)t=zt.minBoundingBox(t,s.getBoundingBoxTop());return t}getBoundingBoxBottom(){let t=Number.NaN;const e=this.glyphs;if(e)for(const s of e)t=zt.maxBoundingBox(t,s.getBoundingBoxBottom());return t}doLayout(){if(!this.glyphs||0===this.glyphs.length)return void(this.width=0);let t=0,e=0;for(let s=0,i=this.glyphs.length;s<i;s++){const i=this.glyphs[s];i.renderer=this.renderer,i.doLayout(),t=Math.max(t,i.width),e=Math.max(e,i.y+i.height)}this.width=t,this.height=e}addGlyph(t){this.glyphs||(this.glyphs=[]),this.renderer&&(t.renderer=this.renderer),this.glyphs.push(t)}paint(t,e,s){const i=this.glyphs;if(i&&0!==i.length)for(const n of i)n.paint(t+this.x,e+this.y,s)}}class ao{static score(t,e,s,i=!1){if(!s.style&&!i)return;const n=ao.Tk(t.settings.display.resources,e);return new ho(t,e,s.style,n)}static scoreColor(t,e,s){const i=ao.Tk(t,e);if(s.style&&s.style.colors.has(e))return s.style.colors.get(e)??i}static Tk(t,e){return t.mainGlyphColor}static bar(t,e,s,i=!1){if(!s.style&&!i)return;let n=t.settings.display.resources.mainGlyphColor;switch(e){case C.StandardNotationRepeats:case C.GuitarTabsRepeats:case C.SlashRepeats:case C.NumberedRepeats:case C.StandardNotationClef:case C.GuitarTabsClef:case C.StandardNotationKeySignature:case C.NumberedKeySignature:case C.StandardNotationTimeSignature:case C.GuitarTabsTimeSignature:case C.SlashTimeSignature:case C.NumberedTimeSignature:break;case C.StandardNotationBarLines:case C.GuitarTabsBarLines:case C.SlashBarLines:case C.NumberedBarLines:n=t.settings.display.resources.barSeparatorColor;break;case C.StandardNotationBarNumber:case C.SlashBarNumber:case C.NumberedBarNumber:case C.GuitarTabsBarNumber:n=t.settings.display.resources.barNumberColor;break;case C.StandardNotationStaffLine:case C.GuitarTabsStaffLine:case C.SlashStaffLine:case C.NumberedStaffLine:n=t.settings.display.resources.staffLineColor}return new ho(t,e,s.style,n)}static voice(t,e,s,i=!1){if(!s.style&&!i)return;const n=0===s.index?t.settings.display.resources.mainGlyphColor:t.settings.display.resources.secondaryGlyphColor;return new ho(t,e,s.style,n)}static trackColor(t,e,s){const i=ao.xk(t,e);if(s.style&&s.style.colors.has(e))return s.style.colors.get(e)??i}static xk(t,e){let s=t.mainGlyphColor;switch(e){case Lt.TrackName:case Lt.SystemSeparator:case Lt.StringTuning:break;case Lt.BracesAndBrackets:s=t.barSeparatorColor}return s}static track(t,e,s,i=!1){if(!s.style&&!i)return;const n=ao.xk(t.settings.display.resources,e);return new ho(t,e,s.style,n)}static beatColor(t,e,s){const i=ao.Mk(t,e,s);if(s.style&&s.style.colors.has(e))return s.style.colors.get(e)??i}static Mk(t,e,s){return 0===s.voice.index?t.mainGlyphColor:t.secondaryGlyphColor}static beat(t,e,s,i=!1){if(!s.style&&!i)return;const n=ao.Mk(t.settings.display.resources,e,s);return new ho(t,e,s.style,n)}static noteColor(t,e,s){const i=ao.vk(t,e,s);if(s.style&&s.style.colors.has(e))return s.style.colors.get(e)??i}static vk(t,e,s){return 0===s.beat.voice.index?t.mainGlyphColor:t.secondaryGlyphColor}static note(t,e,s,i=!1){if(!s.style&&!i)return;const n=0===s.beat.voice.index?t.settings.display.resources.mainGlyphColor:t.settings.display.resources.secondaryGlyphColor;return new ho(t,e,s.style,n)}}class ho{qp;Nk;constructor(t,e,s,i){this.qp=t,s&&s.colors.has(e)?(this.Nk=t.color,t.color=s.colors.get(e)??i):s||(this.Nk=t.color,t.color=i)}[Symbol.dispose](){this.Nk&&(this.qp.color=this.Nk)}}class oo{line=0;symbols;color;constructor(t,e){this.line=t,this.symbols=e}}class co extends ro{Pk=new Map;constructor(){super(0,0)}get isEmpty(){return 0===this.Pk.size}addFingers(t){const e=this.renderer.settings;if(e.notation.fingeringMode!==k.ScoreDefault&&e.notation.fingeringMode!==k.ScoreForcePiano)return;const s=co.fingerToMusicFontSymbol(this.renderer.settings,t.beat,t.leftHandFinger,!0);s!==lt.None&&this.Ck(t,s);const i=co.fingerToMusicFontSymbol(this.renderer.settings,t.beat,t.rightHandFinger,!1);i!==lt.None&&this.Ck(t,i)}static fingerToMusicFontSymbol(t,e,s,i){if(t.notation.fingeringMode===k.ScoreForcePiano||t.notation.fingeringMode===k.SingleNoteEffectBandForcePiano||ge.isPiano(e.voice.bar.staff.track.playbackInfo.program))switch(s){case d.Unknown:case d.NoOrDead:return lt.None;case d.Thumb:return lt.Fingering1;case d.IndexFinger:return lt.Fingering2;case d.MiddleFinger:return lt.Fingering3;case d.AnnularFinger:return lt.Fingering4;case d.LittleFinger:return lt.Fingering5;default:return lt.None}if(i)switch(s){case d.Unknown:return lt.None;case d.NoOrDead:return lt.Fingering0;case d.Thumb:return lt.FingeringTLower;case d.IndexFinger:return lt.Fingering1;case d.MiddleFinger:return lt.Fingering2;case d.AnnularFinger:return lt.Fingering3;case d.LittleFinger:return lt.Fingering4;default:return lt.None}switch(s){case d.Unknown:case d.NoOrDead:return lt.None;case d.Thumb:return lt.FingeringPLower;case d.IndexFinger:return lt.FingeringILower;case d.MiddleFinger:return lt.FingeringMLower;case d.AnnularFinger:return lt.FingeringALower;case d.LittleFinger:return lt.FingeringCLower;default:return lt.None}}Ck(t,e){const s=this.renderer,i=s.getNoteSteps(t);if(this.Pk.has(i)){this.Pk.get(i).symbols.push(e)}else{const n=new oo(i,[e]);n.color=ao.noteColor(s.resources,ft.StandardNotationEffects,t),this.Pk.set(i,n)}}doLayout(){const t=this.renderer;for(const[e,s]of this.Pk){const e=new Qh(0,0,1,s.symbols);e.colorOverride=s.color,e.renderer=t,e.y=t.getScoreY(s.line),e.doLayout(),e.offsetY=e.height/2,this.addGlyph(e),this.width=Math.max(this.width,e.width)}for(const t of this.glyphs){const e=t;e.x=this.width/2,e.center=!0}}}class lo extends Dh{get notationElement(){return B.EffectFingering}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return Sh.SingleOnBeat}shouldCreateGlyph(t,e){return!(0!==e.voice.index||e.isRest||t.notation.fingeringMode!==k.SingleNoteEffectBand&&t.notation.fingeringMode!==k.SingleNoteEffectBandForcePiano)&&(1===e.notes.length&&e.notes[0].isFingering)}createNewGlyph(t,e){let s=d.Unknown,i=!1;const n=e.notes[0];n.leftHandFinger!==d.Unknown?(s=n.leftHandFinger,i=!0):n.rightHandFinger!==d.Unknown&&(s=n.rightHandFinger);const r=co.fingerToMusicFontSymbol(t.settings,e,s,i),a=new Kh(0,0,1,r);return a.center=!0,a.renderer=t,a.doLayout(),a.offsetY=t.smuflMetrics.glyphTop.get(a.symbol),a}canExpand(t,e){return!0}}class uo extends Dh{get notationElement(){return B.EffectText}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return Sh.SinglePreBeat}shouldCreateGlyph(t,e){const s=e.voice.bar.masterBar;return 0===e.voice.bar.staff.index&&0===e.voice.index&&0===e.index&&s.isFreeTime&&(0===s.index||s.isFreeTime!==s.previousMasterBar.isFreeTime)}createNewGlyph(t,e){return new Hh(0,0,"Free time",t.resources.elementFonts.get(B.EffectFreeTime),at.Left)}canExpand(t,e){return!0}}class fo extends Kh{constructor(t,e,s=!1){super(t,e,Rr.GraceScale,lt.GuitarGolpe),this.center=s}doLayout(){super.doLayout(),this.offsetY=this.height}}class po extends Dh{Ek;constructor(t){super(),this.Ek=t}get notationElement(){return B.EffectGolpe}get effectId(){return`${super.effectId}.${bt[this.Ek]}`}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return Sh.SingleOnBeat}shouldCreateGlyph(t,e){return e.golpe===this.Ek}createNewGlyph(t,e){return new fo(0,0,!0)}canExpand(t,e){return!1}}class bo extends Dh{lastCreateInfo=null;shouldCreateGlyph(t,e){this.lastCreateInfo=[];for(let t=0,s=e.notes.length;t<s;t++){const s=e.notes[t];this.shouldCreateGlyphForNote(s)&&this.lastCreateInfo.push(s)}return this.lastCreateInfo.length>0}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}canExpand(t,e){return!0}}class mo extends bo{Fk;Ge=null;Ak;get effectId(){return this.Ak}get notationElement(){return B.EffectHarmonics}constructor(t){switch(super(),this.Fk=t,t){case f.None:this.Ak="harmonics-none";break;case f.Natural:this.Ak="harmonics-natural";break;case f.Artificial:this.Ak="harmonics-artificial";break;case f.Pinch:this.Ak="harmonics-pinch";break;case f.Tap:this.Ak="harmonics-tap";break;case f.Semi:this.Ak="harmonics-semi";break;case f.Feedback:this.Ak="harmonics-feedback";break;default:this.Ak=""}}shouldCreateGlyphForNote(t){return!(!t.isHarmonic||t.harmonicType!==this.Fk)&&(t.beat!==this.Ge&&(this.Ge=t.beat),!0)}get sizingMode(){return Sh.GroupedOnBeat}createNewGlyph(t,e){return new Oh(mo.harmonicToString(this.Fk),B.EffectHarmonics)}static harmonicToString(t){switch(t){case f.Natural:return"N.H.";case f.Artificial:return"A.H.";case f.Pinch:return"P.H.";case f.Tap:return"T.H.";case f.Semi:return"S.H.";case f.Feedback:return"Fdbk."}return""}}class go extends Kh{constructor(){super(0,0,1,lt.GuitarLeftHandTapping),this.center=!0}doLayout(){super.doLayout(),this.offsetY=this.renderer.smuflMetrics.glyphTop.get(this.symbol)}}class wo extends bo{get notationElement(){return B.EffectTap}get sizingMode(){return Sh.SingleOnBeat}shouldCreateGlyphForNote(t){return t.isLeftHandTapped}createNewGlyph(t,e){return new go}}class yo extends Dh{get notationElement(){return B.EffectLetRing}get canShareBand(){return!1}get hideOnMultiTrack(){return!1}shouldCreateGlyph(t,e){return e.isLetRing}get sizingMode(){return Sh.GroupedOnBeat}createNewGlyph(t,e){return new Oh("LetRing",B.EffectLetRing)}canExpand(t,e){return!0}}class ko extends Fh{ak;Dk=[];font;textAlign;constructor(t,e,s,i,n=at.Center){super(t,e),this.ak=s,this.font=i,this.textAlign=n}doLayout(){super.doLayout();const t=this.renderer.settings.display.lyricLinesPaddingBetween,e=this.renderer.scoreRenderer.canvas;e.font=this.font;let s=0;for(const i of this.ak){this.Dk.push(s);s+=e.measureText(i.length>0?i:" ").height+t}s-=t,this.height=s}paint(t,e,s){s.font=this.font;const i=s.textAlign;s.textAlign=this.textAlign;for(let i=0;i<this.ak.length;i++)this.ak[i]&&s.fillText(this.ak[i],t+this.x,e+this.y+this.Dk[i]);s.textAlign=i}}class So extends Dh{get notationElement(){return B.EffectLyrics}get hideOnMultiTrack(){return!1}get canShareBand(){return!1}get sizingMode(){return Sh.SingleOnBeat}shouldCreateGlyph(t,e){return!!e.lyrics}createNewGlyph(t,e){return new ko(0,0,e.lyrics,t.resources.elementFonts.get(B.EffectLyrics),at.Center)}canExpand(t,e){return!0}}class Bo extends Dh{get notationElement(){return B.EffectMarker}get hideOnMultiTrack(){return!0}get canShareBand(){return!0}get sizingMode(){return Sh.SinglePreBeat}shouldCreateGlyph(t,e){return 0===e.voice.bar.staff.index&&0===e.voice.index&&0===e.index&&e.voice.bar.masterBar.isSectionStart}createNewGlyph(t,e){return new Hh(0,0,e.voice.bar.masterBar.section.marker?`[${e.voice.bar.masterBar.section.marker}] ${e.voice.bar.masterBar.section.text}`:e.voice.bar.masterBar.section.text,t.resources.elementFonts.get(B.EffectMarker),at.Left)}canExpand(t,e){return!0}}class _o extends Kh{constructor(t){super(0,0,1,_o.Sk(t)),this.center=!0}static Sk(t){switch(t){case dt.InvertedTurn:return lt.OrnamentTurnInverted;case dt.Turn:return lt.OrnamentTurn;case dt.UpperMordent:return lt.OrnamentShortTrill;case dt.LowerMordent:return lt.OrnamentMordent}return lt.None}doLayout(){super.doLayout(),this.height=this.renderer.smuflMetrics.glyphHeights.get(lt.OrnamentMordent),this.offsetY=this.renderer.smuflMetrics.glyphTop.get(lt.OrnamentMordent)}}class To extends Dh{get notationElement(){return B.EffectNoteOrnament}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return Sh.SingleOnBeat}shouldCreateGlyph(t,e){return e.notes.some(t=>t.ornament!==dt.None)}createNewGlyph(t,e){return new _o(e.notes.find(t=>t.ornament!==dt.None).ornament)}canExpand(t,e){return!1}}class xo extends Kh{constructor(t,e,s,i){super(t,e,i,xo.getMusicSymbol(s))}static getMusicSymbol(t){switch(t){case T.Natural:return lt.AccidentalNatural;case T.Sharp:return lt.AccidentalSharp;case T.Flat:return lt.AccidentalFlat;case T.NaturalQuarterNoteUp:return lt.AccidentalQuarterToneSharpNaturalArrowUp;case T.SharpQuarterNoteUp:return lt.AccidentalThreeQuarterTonesSharpArrowUp;case T.FlatQuarterNoteUp:return lt.AccidentalQuarterToneFlatArrowUp;case T.DoubleSharp:return lt.AccidentalDoubleSharp;case T.DoubleFlat:return lt.AccidentalDoubleFlat}return lt.None}}class Mo extends Fh{Lk;Wk;ik="";Ok=T.None;Rk=0;Ik=0;constructor(t,e,s,i){super(t,e),this.Lk=s,this.Wk=i}doLayout(){super.doLayout();let t="",e="",s=T.None;switch(this.Wk){case N.Major:switch(t="1 = ",this.Lk){case v.Cb:e="  C",s=T.Flat;break;case v.Gb:e="  G",s=T.Flat;break;case v.Db:e="  D",s=T.Flat;break;case v.Ab:e="  A",s=T.Flat;break;case v.Eb:e="  E",s=T.Flat;break;case v.Bb:e="  B",s=T.Flat;break;case v.F:e="F";break;case v.C:e="C",s=T.None;break;case v.G:e="G",s=T.None;break;case v.D:e="D",s=T.None;break;case v.A:e="A",s=T.None;break;case v.E:e="E",s=T.None;break;case v.B:e="B",s=T.None;break;case v.FSharp:e="  F",s=T.Sharp;break;case v.CSharp:e="  C",s=T.Sharp}break;case N.Minor:switch(t="6 = ",this.Lk){case v.Cb:e="  a",s=T.Flat;break;case v.Gb:e="  e",s=T.Flat;break;case v.Db:e="  b",s=T.Flat;break;case v.Ab:e="f",s=T.None;break;case v.Eb:e="c",s=T.None;break;case v.Bb:e="g",s=T.None;break;case v.F:e="d";break;case v.C:e="a",s=T.None;break;case v.G:e="e",s=T.None;break;case v.D:e="b",s=T.None;break;case v.A:e="  f",s=T.Sharp;break;case v.E:e="  c",s=T.Sharp;break;case v.B:e="  g",s=T.Sharp;break;case v.FSharp:e="  d",s=T.Sharp;break;case v.CSharp:e="  a",s=T.Sharp}}this.ik=t+e,this.Ok=s;const i=this.renderer.scoreRenderer.canvas,n=this.renderer.settings,r=n.display.resources;i.font=r.numberedNotationFont,this.Rk=i.measureText(t).width;const a=i.measureText(t+e);this.Ik=0===this.renderer.index?n.display.firstStaffPaddingLeft:n.display.staffPaddingLeft,this.width=this.Ik+a.width,this.height=a.height}paint(t,e,s){const i=ao.bar(s,C.NumberedKeySignature,this.renderer.bar);try{const i=this.renderer.resources;s.font=i.numberedNotationFont,s.textBaseline=ht.Alphabetic,s.fillText(this.ik,t+this.x+this.Ik,e+this.y+this.height),this.Ok!==T.None&&Rt.fillMusicFontSymbolSafe(s,t+this.x+this.Ik+this.Rk,e+this.y+this.height,1,xo.getMusicSymbol(this.Ok),!1)}finally{i?.[Symbol.dispose]?.()}}}class vo extends Dh{get notationElement(){return B.EffectNumberedNotationKeySignature}get hideOnMultiTrack(){return!1}get canShareBand(){return!1}get sizingMode(){return Sh.FullBar}shouldCreateGlyph(t,e){const s=e.voice.bar;return 0===e.index&&0===e.voice.index&&(!s.previousBar||s.keySignature!==s.previousBar.keySignature)}createNewGlyph(t,e){return new Mo(0,0,t.bar.keySignature,t.bar.keySignatureType)}canExpand(t,e){return!1}}class No extends Wh{Gk;Hk;constructor(t,e){super(bs.PostNotes),this.Gk=t,this.Hk=e}doLayout(){super.doLayout(),this.height=this.renderer.smuflMetrics.glyphHeights.get(lt.QuindicesimaAlta)}paintNonGrouped(t,e,s){this.Vk(t,e,s)}Vk(t,e,s){let i=0;switch(this.Gk){case b.S:i=this.renderer.smuflMetrics.glyphWidths.get(lt.QuindicesimaAlta),Rt.fillMusicFontSymbolSafe(s,t+this.x-i/2,e+this.y+this.height,1,lt.QuindicesimaAlta,!1);break;case b._:i=this.renderer.smuflMetrics.glyphWidths.get(lt.OttavaAlta),Rt.fillMusicFontSymbolSafe(s,t+this.x-i/2,e+this.y+this.height,1,lt.OttavaAlta,!1);break;case b.T:i=this.renderer.smuflMetrics.glyphWidths.get(lt.OttavaBassaVb),Rt.fillMusicFontSymbolSafe(s,t+this.x-i/2,e+this.y+this.height,1,lt.OttavaBassaVb,!1);break;case b.M:i=1*(this.renderer.smuflMetrics.glyphWidths.get(lt.Quindicesima)+this.renderer.smuflMetrics.glyphWidths.get(lt.OctaveBaselineM)+this.renderer.smuflMetrics.glyphWidths.get(lt.OctaveBaselineB)),Rt.fillMusicFontSymbolsSafe(s,t+this.x-i/2,e+this.y+this.height,1,[lt.Quindicesima,lt.OctaveBaselineM,lt.OctaveBaselineB],!1)}return i/2}paintGrouped(t,e,s,i){const n=this.Vk(t,e,i),r=this.renderer.smuflMetrics.lineRangedGlyphDashGap,a=t+this.x+n+r;let h=e+this.y;const o=.5*this.height;h+=this.Hk?0:this.height;const c=this.renderer.smuflMetrics.lineRangedGlyphDashSize,l=i.lineWidth;if(i.lineWidth=this.renderer.smuflMetrics.octaveLineThickness,s>a){let t=a;for(;t<s;)i.beginPath(),i.moveTo(t,0|h),i.lineTo(Math.min(t+c,s),0|h),t+=c+r,i.stroke();i.beginPath(),this.Hk?(i.moveTo(s,h),i.lineTo(s,h+o)):(i.moveTo(s,h),i.lineTo(s,h-o)),i.stroke()}i.lineWidth=l}}class Po extends Dh{Hk;get effectId(){return"ottavia-"+(this.Hk?"above":"below")}get notationElement(){return B.EffectOttavia}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return Sh.GroupedOnBeat}constructor(t){super(),this.Hk=t}shouldCreateGlyph(t,e){switch(e.ottava){case b.S:case b._:return this.Hk;case b.T:case b.M:return!this.Hk}return!1}createNewGlyph(t,e){return new No(e.ottava,this.Hk)}canExpand(t,e){return t.ottava===e.ottava}}class Co extends bo{get notationElement(){return B.EffectPalmMute}shouldCreateGlyphForNote(t){return t.isPalmMute}get sizingMode(){return Sh.GroupedOnBeat}createNewGlyph(t,e){return new Oh("P.M.",B.EffectPalmMute)}}class Eo extends bo{get notationElement(){return B.EffectPickSlide}shouldCreateGlyphForNote(t){return t.slideOutType===g.PickSlideDown||t.slideOutType===g.PickSlideUp}get sizingMode(){return Sh.GroupedOnBeat}createNewGlyph(t,e){return new Oh("P.S.",B.EffectPickSlide)}}class Fo extends Kh{constructor(t,e,s){super(t,e,Rr.GraceScale,Fo.Sk(s)),this.center=!0}doLayout(){super.doLayout(),this.offsetY=this.height}static Sk(t){switch(t){case ct.Up:return lt.StringsUpBow;case ct.Down:return lt.StringsDownBow;default:return lt.None}}}class Ao extends Dh{get notationElement(){return B.EffectPickStroke}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return Sh.SingleOnBeat}shouldCreateGlyph(t,e){return e.pickStroke!==ct.None}createNewGlyph(t,e){return new Fo(0,0,e.pickStroke)}canExpand(t,e){return!0}}class Do extends Dh{get notationElement(){return B.EffectRasgueado}get canShareBand(){return!1}get hideOnMultiTrack(){return!1}shouldCreateGlyph(t,e){return e.hasRasgueado}get sizingMode(){return Sh.GroupedOnBeat}createNewGlyph(t,e){return new Oh("rasg.",B.EffectRasgueado)}canExpand(t,e){return!0}}class Lo extends Oa{$k=[];Uk=[];zk;isEmpty=!0;previousBand=null;isLinkedToPrevious=!1;firstBeat=null;lastBeat=null;height=0;originalHeight=0;voice;info;slot=null;constructor(t,e,s){super(0,0),this.voice=t,this.info=e,this.zk=s}*iterateAllGlyphs(){for(const t of this.Uk)for(const e of t.values())yield e}finalizeBand(){this.info.finalizeBand(this)}doLayout(){super.doLayout();for(let t=0;t<this.renderer.bar.voices.length;t++)this.Uk.push(new Map),this.$k.push([])}static shouldCreateGlyph(t,e,s){return e.shouldCreateGlyph(s.settings,t)&&(!e.hideOnMultiTrack||0===s.staff.trackIndex)}createGlyph(t){if(t.voice===this.voice&&Lo.shouldCreateGlyph(t,this.info,this.renderer)){if(this.isEmpty=!1,this.firstBeat&&!t.isBefore(this.firstBeat)||(this.firstBeat=t),!this.lastBeat||t.isAfter(this.lastBeat))switch(this.lastBeat=t,this.info.sizingMode){case Sh.SingleOnBeatToEnd:case Sh.GroupedOnBeatToEnd:this.lastBeat.nextBeat&&(this.lastBeat=this.lastBeat.nextBeat)}const e=this.Xk(this.info.sizingMode,t);e.height>this.height&&(this.height=e.height,this.originalHeight=e.height)}}resetHeight(){this.height=this.originalHeight}Xk(t,e){let s;switch(t){case Sh.FullBar:case Sh.SinglePreBeat:case Sh.SingleOnBeat:case Sh.SingleOnBeatToEnd:return s=this.info.createNewGlyph(this.renderer,e),s.renderer=this.renderer,s.beat=e,s.doLayout(),this.Uk[e.voice.index].set(e.index,s),this.$k[e.voice.index].push(s),s;case Sh.GroupedOnBeat:case Sh.GroupedOnBeatToEnd:const i=t===Sh.GroupedOnBeat?Sh.SingleOnBeat:Sh.SingleOnBeatToEnd;if(e.index>0||this.renderer.index>0){const t=e.previousBeat;if(this.info.shouldCreateGlyph(this.renderer.settings,t)){let s=null;if(e.index>0&&this.Uk[e.voice.index].has(t.index))s=this.Uk[e.voice.index].get(t.index);else if(this.renderer.index>0){const e=this.zk.previousContainer.getBand(t.voice,this.info.effectId);if(e){const i=e.Uk[t.voice.index];i.has(t.index)&&(s=i.get(t.index))}}const n=this.Xk(i,e);return s&&this.info.canExpand(t,e)&&(s.nextGlyph=n,n.previousGlyph=s,this.isLinkedToPrevious=!0),n}return this.Xk(i,e)}return this.Xk(i,e);default:return this.Xk(Sh.SingleOnBeat,e)}}paint(t,e,s){super.paint(t,e,s);for(let i=0,n=this.$k.length;i<n;i++){const n=this.$k[i];for(let i=0,r=n.length;i<r;i++){const r=n[i],a=ao.beat(s,Bt.Effects,r.beat,!1);try{r.paint(t+this.x,e+this.y,s)}finally{a?.[Symbol.dispose]?.()}}}}alignGlyphs(){for(let t=0;t<this.Uk.length;t++)for(const e of this.Uk[t].keys()){const s=this.renderer.bar.voices[t].beats[e];this.jk(this.info.sizingMode,s)}this.info.onAlignGlyphs(this)}jk(t,e){const s=this.Uk[e.voice.index].get(e.index),i=this.renderer.getBeatContainer(e);switch(t){case Sh.SinglePreBeat:const t=this.renderer.layoutingInfo.getPreBeatSize(e);s.x=this.renderer.beatGlyphsStart+i.x+i.onTimeX-t;break;case Sh.SingleOnBeat:case Sh.GroupedOnBeat:s.x=this.renderer.beatGlyphsStart+i.x+i.onTimeX;break;case Sh.SingleOnBeatToEnd:case Sh.GroupedOnBeatToEnd:if(s.x=this.renderer.beatGlyphsStart+i.x+i.onTimeX,i.isLastOfVoice)s.width=this.renderer.width-s.x;else{const t=this.renderer.layoutingInfo.getPostBeatSize(e);s.width=t}break;case Sh.FullBar:s.width=this.renderer.width}}}class Wo{uniqueEffectId=null;y=0;height=0;firstBeat=null;lastBeat=null}class Oo{bands;shared;constructor(){this.bands=[],this.shared=new Wo}update(t){t.info.canShareBand||(this.shared.uniqueEffectId=t.info.effectId),t.slot=this,this.bands.push(t),t.height>this.shared.height&&(this.shared.height=t.height),this.shared.firstBeat&&!t.firstBeat.isBefore(this.shared.firstBeat)||(this.shared.firstBeat=t.firstBeat),this.shared.lastBeat&&!t.lastBeat.isAfter(this.shared.lastBeat)||(this.shared.lastBeat=t.lastBeat)}canBeUsed(t){return!((this.shared.uniqueEffectId||!t.info.canShareBand)&&t.info.effectId!==this.shared.uniqueEffectId)&&(!this.shared.firstBeat||(this.shared.lastBeat===t.firstBeat||(!!this.shared.lastBeat.isBefore(t.firstBeat)||!!this.shared.lastBeat.isBefore(this.shared.firstBeat))))}}class Ro{Jk;qk;slots;owner;constructor(t){this.slots=[],this.Jk=new Map,this.qk=new Map,this.owner=t}reset(){this.Jk.clear(),this.qk.clear(),this.slots=[]}getOrCreateSlot(t){if(this.qk.has(t))return this.qk.get(t);if(this.Jk.has(t.info.effectId)){const e=this.Jk.get(t.info.effectId);if(e.canBeUsed(t))return this.qk.set(t,e),e}for(const e of this.slots)if(e.canBeUsed(t))return this.qk.set(t,e),e;const e=new Oo;return this.slots.push(e),this.qk.set(t,e),e}register(t){const e=this.getOrCreateSlot(t);e.update(t),this.Jk.set(t.info.effectId,e)}sortSlots(t){for(const e of this.slots)e.bands.sort((e,s)=>t.get(e.info)-t.get(s.info));this.slots.sort((e,s)=>t.get(e.bands[0].info)-t.get(s.bands[0].info))}}class Io{Yk=[];Kk=new Map;Qk=null;Zk=new Map;height=0;infos;Hp;tS;alignGlyphs(){for(const t of this.Yk)t.alignGlyphs()}get previousContainer(){return 0===this.Hp.index?void 0:this.tS?this.Hp.previousRenderer.topEffects:this.Hp.previousRenderer.bottomEffects}get isLinkedToPreviousRenderer(){return this.Yk.some(t=>t.isLinkedToPrevious)}constructor(t,e){this.Hp=t,this.tS=e}reLayout(){this.resetEffectBandSizingInfo(),this.sizeAndAlignEffectBands()}afterStaffBarReverted(){this.resetEffectBandSizingInfo(),this.sizeAndAlignEffectBands()}createVoiceGlyphs(t){let e=0;const s=this.Hp,i=s.settings.notation;for(const n of this.infos){if(!i.isNotationElementVisible(n.effect.notationElement))continue;let r;this.Zk.set(n.effect,n.order??e);for(const e of t.beats)!r&&Lo.shouldCreateGlyph(e,n.effect,s)&&(r=new Lo(t,n.effect,this),r.renderer=this.Hp,r.doLayout(),this.Yk.push(r),this.Kk.set(`${t.index}.${n.effect.effectId}`,r)),void 0!==r&&r.createGlyph(e);e++}}doLayout(){this.Zk.clear(),this.Yk=[],this.Kk=new Map,this.resetEffectBandSizingInfo()}resetEffectBandSizingInfo(){this.Hp.index>0?this.Qk=this.previousContainer.Qk:this.Qk&&this.Qk.owner===this?this.Qk.reset():this.Qk=new Ro(this)}finalizeEffects(){return this.eS(!0)}updateEffectBandHeights(){return this.eS(!1)}eS(t){if(!this.Qk)return!1;let e=0;const s=this.Hp.settings.display.effectBandPaddingBottom;for(const i of this.Qk.slots){i.shared.y=e;for(const s of i.bands)e+=0,s.y=e,t&&s.finalizeBand(),s.height=i.shared.height;e+=i.shared.height+s}return e=Math.ceil(e),e!==this.height&&(this.height=e,!0)}sizeAndAlignEffectBands(t=!0){for(const e of this.Yk)e.resetHeight(),e.alignGlyphs(),t&&!e.isEmpty&&this.Qk.register(e);t&&this.Qk.sortSlots(this.Zk)}paint(t,e,s){const i=this.Hp.resources;for(const n of this.Yk)s.color=0===n.voice.index?i.mainGlyphColor:i.secondaryGlyphColor,n.isEmpty||n.paint(t,e,s)}getBand(t,e){const s=`${t.index}.${e}`;return this.Kk.has(s)?this.Kk.get(s):null}}class Go extends ro{gap=0;constructor(){super(0,0),this.glyphs=[]}doLayout(){}addGlyph(t){t.x=this.width,t.renderer=this.renderer,t.doLayout(),this.width=t.x+t.width+this.gap,super.addGlyph(t)}}class Ho extends Oa{static KeySizeBeat="Beat";voiceDrawOrder;sS=new Map;beatGlyphs=new Map;tupletGroups=new Map;constructor(){super(0,0)}getBoundingBoxTop(){let t=Number.NaN;for(const e of this.beatGlyphs.values())for(const s of e)t=zt.minBoundingBox(t,s.getBoundingBoxTop());return t}getBoundingBoxBottom(){let t=Number.NaN;for(const e of this.beatGlyphs.values())for(const s of e)t=zt.maxBoundingBox(t,s.getBoundingBoxBottom());return t}scaleToWidth(t){const e=this.renderer.layoutingInfo.spaceToForce(t);this.iS(e)}iS(t){this.width=this.renderer.layoutingInfo.calculateVoiceWidth(t);const e=this.renderer.layoutingInfo.buildOnTimePositions(t);for(const t of this.beatGlyphs.values())for(let s=0,i=t.length;s<i;s++){const n=t[s];if(n.graceType===l.None)n.x=e.get(n.absoluteDisplayStart)-n.onTimeX;else{const i=n.graceGroup.beats[0].absoluteDisplayStart,r=n.graceGroup.id;if(n.graceGroup.isComplete&&e.has(i)){n.x=e.get(i)-n.onTimeX;const t=this.renderer.layoutingInfo.allGraceRods.get(r),s=n.graceGroup.beats[n.graceGroup.beats.length-1].nextBeat,a=s?this.renderer.layoutingInfo.getPreBeatSize(s):0;n.x-=a,n.x-=t[n.graceIndex].postSpringWidth,n.x+=t[n.graceIndex].graceBeatWidth;const h=t[n.graceGroup.beats.length-1];n.x-=h.graceBeatWidth}else{const e=this.renderer.layoutingInfo.incompleteGraceRods.get(r),i=e[n.graceIndex].postSpringWidth-e[n.graceIndex].preSpringWidth;s>0?0===n.graceIndex?n.x=t[s-1].x+t[s-1].width:n.x=t[s-1].x+e[n.graceIndex-1].postSpringWidth-e[n.graceIndex-1].preSpringWidth-i:n.x=-i}}if(s>0){const e=n.x-t[s-1].x;t[s-1].scaleToWidth(e)}if(s===i-1){const e=this.width-t[t.length-1].x;n.scaleToWidth(e)}}}registerLayoutingInfo(t){for(const e of this.beatGlyphs.values())for(const s of e)s.registerLayoutingInfo(t)}applyLayoutingInfo(t){for(const e of this.beatGlyphs.values()){for(const s of e)s.applyLayoutingInfo(t);this.iS(Math.max(this.renderer.settings.display.stretchForce,t.minStretchForce))}}addGlyph(t){let e;this.beatGlyphs.has(t.voiceIndex)?e=this.beatGlyphs.get(t.voiceIndex):(e=[],this.beatGlyphs.set(t.voiceIndex,e)),t.x=0===e.length?0:e[e.length-1].x+e[e.length-1].width,t.renderer=this.renderer,e.push(t);const s=t.beatId;s>=0&&this.sS.set(s,t);const i=t.x+t.width;if(i>this.width&&(this.width=i),t.isFirstOfTupletGroup){let e;this.tupletGroups.has(t.voiceIndex)?e=this.tupletGroups.get(t.voiceIndex):(e=[],this.tupletGroups.set(t.voiceIndex,e)),e.push(t.tupletGroup)}}getBeatX(t,e=bs.PreNotes,s=!1){const i=this.getBeatContainer(t);return i?i.x+i.getBeatX(e,s):0}getLowestNoteY(t,e){const s=this.getBeatContainer(t);return s?s.y+s.getLowestNoteY(e):0}getHighestNoteY(t,e){const s=this.getBeatContainer(t);return s?s.y+s.getHighestNoteY(e):0}getNoteX(t,e){const s=this.getBeatContainer(t.beat);return s?s.x+s.getNoteX(t,e):0}getNoteY(t,e){const s=this.getBeatContainer(t.beat);return s?s.y+s.getNoteY(t,e):0}getRestY(t,e){const s=this.getBeatContainer(t);return s?s.y+s.getRestY(e):0}getBeatContainer(t){if(this.sS.has(t.id))return this.sS.get(t.id)}buildBoundingsLookup(t,e,s){for(const[i,n]of this.beatGlyphs){const r=this.renderer.bar.voices[i];if(0===i||!r.isEmpty)for(const i of n)i.buildBoundingsLookup(t,e+this.x,s+this.y)}}doLayout(){for(const t of this.beatGlyphs.values()){let e=0;for(const s of t)s.x=e,s.doLayout(),e+=s.width;e>this.width&&(this.width=e)}this.renderer.bar.isMultiVoice&&this.nS(),this.voiceDrawOrder=Array.from(this.beatGlyphs.keys()),Pu.sortDescending(this.voiceDrawOrder)}nS(){for(const t of this.beatGlyphs.values()){let e=0;for(const s of t)s.x=e,s.doMultiVoiceLayout(),e+=s.width;e>this.width&&(this.width=e)}}paint(t,e,s){for(const i of this.voiceDrawOrder){const n=this.beatGlyphs.get(i),r=this.renderer.bar.voices[i],a=ao.voice(s,R.Glyphs,r,!0);try{for(let i=0,r=n.length;i<r;i++)n[i].paint(t+this.x,e+this.y,s)}finally{a?.[Symbol.dispose]?.()}}}}class Vo extends Oa{tieDirection=Wt.Up;slurEffectId;isForEnd;constructor(t,e){super(0,0),this.slurEffectId=t,this.isForEnd=e}rS=0;aS=0;hS=0;oS=0;cS=0;lS;uS=!1;get checkForOverflow(){return this.uS&&void 0!==this.lS}getBoundingBoxTop(){return this.lS?this.lS.y:this.aS}getBoundingBoxBottom(){return this.lS?this.lS.y+this.lS.h:this.aS}doLayout(){this.width=0;const t=this.lookupStartBeatRenderer(),e=this.lookupEndBeatRenderer();this.rS=0,this.hS=0,this.aS=0,this.oS=0,this.height=0,this.tieDirection=this.calculateTieDirection();const s=this.isForEnd;if(this.uS=!1,s){if(t.staff!==e.staff){const s=t.staff.barRenderers[0];this.rS=s.x,this.hS=this.calculateEndX();const i=t.scoreRenderer.layout.slurRegistry.completeMultiSystemSlur(this);this.aS=i?i.calculateMultiSystemSlurY(e):this.caclculateEndY(),this.oS=this.caclculateEndY(),this.uS=t.staff!==e.staff}}else{if(t!==e)if(this.rS=this.calculateStartX(),this.aS=this.calculateStartY(),e&&t.staff===e.staff)this.hS=this.calculateEndX(),this.oS=this.caclculateEndY();else{const e=t.staff.barRenderers[t.staff.barRenderers.length-1];this.hS=e.x+e.width,this.oS=this.aS,t.scoreRenderer.layout.slurRegistry.startMultiSystemSlur(this)}else this.uS=!0,this.rS=this.calculateStartX(),this.hS=this.calculateEndX(),this.aS=this.calculateStartY(),this.oS=this.caclculateEndY();this.uS=!0}let i;if(this.lS=void 0,this.y=Math.min(this.aS,this.oS),this.shouldDrawBendSlur()?(this.cS=0,i=Vo.calculateBendSlurHeight(this.rS,this.aS,this.hS,this.oS,this.tieDirection===Wt.Down,this.renderer.smuflMetrics.tieHeight)):(this.cS=this.getTieHeight(this.rS,this.aS,this.hS,this.oS),i=Vo.calculateActualTieHeight(1,this.rS,this.aS,this.hS,this.oS,this.tieDirection===Wt.Down,this.cS,this.renderer.smuflMetrics.tieMidpointThickness)),this.lS=i,this.height=i.h,this.tieDirection===Wt.Up){const t=this.y-i.y;t>0&&(this.y-=t)}}paint(t,e,s){this.uS&&(this.shouldDrawBendSlur()?Vo.drawBendSlur(s,t+this.rS,e+this.aS,t+this.hS,e+this.oS,this.tieDirection===Wt.Down,this.renderer.smuflMetrics.tieHeight):Vo.paintTie(s,1,t+this.rS,e+this.aS,t+this.hS,e+this.oS,this.tieDirection===Wt.Down,this.cS,this.renderer.smuflMetrics.tieMidpointThickness))}getTieHeight(t,e,s,i){return this.renderer.smuflMetrics.tieHeight}calculateMultiSystemSlurY(t){const e=this.lookupStartBeatRenderer(),s=this.calculateStartY()-e.y;return t.y+s}shouldCreateMultiSystemSlur(t){const e=this.lookupEndBeatRenderer()?.staff;return!e||t.staff.system.index<e.system.index}static calculateActualTieHeight(t,e,s,i,n,r,a,h){const o=Vo.dS(t,e,s,i,n,r,a,h);if(0===o.length)return new Us(e,s,i-e,n-s);const c=o[0],l=o[1],u=o[2],d=o[3],f=o[4],p=o[5],b=o[6],m=o[7],g=.125*c+.375*u+.375*f+.125*b,w=.125*l+.375*d+.375*p+.125*m,y=Math.min(c,b,g),k=Math.max(c,b,g);let S=Math.min(l,m,w),B=Math.max(l,m,w);r?B+=h:S-=h;const _=new Us;return _.x=y,_.y=S,_.w=k-y,_.h=B-S,_}static dS(t,e,s,i,n,r,a,h){if(e===i&&s===n)return[];if(i<e){let t=e;e=i,i=t,t=s,s=n,n=t}a*=t,h*=t,r&&(a*=-1,h*=-1),t>=1&&(h*=1.2);const o=n-s,c=i-e,l=Math.sqrt(c*c+o*o);let u=e+.25*l,d=s-a,f=e+.75*l,p=s-a,b=e+.75*l,m=s-a-h,g=e+.25*l,w=s-a-h;const y=Math.atan2(o,c);return[u,d]=Vo.fS(u,d,e,s,y),[f,p]=Vo.fS(f,p,e,s,y),[b,m]=Vo.fS(b,m,e,s,y),[g,w]=Vo.fS(g,w,e,s,y),[e,s,u,d,f,p,i,n,b,m,g,w,e,s]}static fS(t,e,s,i,n){const r=t-s,a=e-i;return[s+(r*Math.cos(n)-a*Math.sin(n)),i+(r*Math.sin(n)+a*Math.cos(n))]}static paintTie(t,e,s,i,n,r,a,h,o){const c=Vo.dS(e,s,i,n,r,a,h,o);t.beginPath(),t.moveTo(c[0],c[1]),t.bezierCurveTo(c[2],c[3],c[4],c[5],c[6],c[7]),t.bezierCurveTo(c[8],c[9],c[10],c[11],c[12],c[13]),t.closePath(),t.fill()}static calculateBendSlurTopY(t,e,s,i,n,r,a){let h=i-e,o=s-t;const c=Math.sqrt(h*h+o*o);n?h*=-1:o*=-1,h/=c,o/=c;let l=a*r;s-t<20&&(l/=2);return(i+e)/2+l*o}static calculateBendSlurHeight(t,e,s,i,n,r){let a=i-e,h=s-t;const o=Math.sqrt(a*a+h*h);n?a*=-1:h*=-1,a/=o,h/=o;let c=r;s-t<20&&(c/=2);const l=(i+e)/2+c*h,u=Math.min(e,i,l),d=Math.max(e,i,l);return new Us(t,Math.min(e,i,l),s-t,d-u)}static drawBendSlur(t,e,s,i,n,r,a,h){let o=n-s,c=i-e;const l=Math.sqrt(o*o+c*c);r?o*=-1:c*=-1,o/=l,c/=l;let u=a;i-e<20&&(u/=2);const d=(i+e)/2+u*o,f=(n+s)/2+u*c;if(t.beginPath(),t.moveTo(e,s),t.lineTo(d,f),t.lineTo(i,n),t.stroke(),h){const e=t.measureText(h).width,s=r?0:-t.font.size;t.fillText(h,d-e/2,f+s)}}}class $o extends Vo{startNote;endNote;startNoteRenderer=null;endNoteRenderer=null;constructor(t,e,s,i){super(t,i),this.startNote=e,this.endNote=s}get isLeftHandTap(){return this.startNote===this.endNote}getTieHeight(t,e,s,i){return this.isLeftHandTap?this.renderer.smuflMetrics.tieHeight:super.getTieHeight(t,e,s,i)}calculateTieDirection(){return this.lookupStartBeatRenderer().getBeatDirection(this.startNote.beat)===Wt.Up?Wt.Down:Wt.Up}calculateStartX(){const t=this.lookupStartBeatRenderer();return this.isLeftHandTap?this.calculateEndX()-t.smuflMetrics.leftHandTabTieWidth:t.x+t.getNoteX(this.startNote,this.getStartNotePosition())}getStartNotePosition(){return _h.Center}calculateStartY(){const t=this.lookupStartBeatRenderer();return this.isLeftHandTap?t.y+t.getNoteY(this.startNote,Bh.Center):this.tieDirection===Wt.Up?t.y+t.getNoteY(this.startNote,Bh.Top):t.y+t.getNoteY(this.startNote,Bh.Bottom)}calculateEndX(){const t=this.lookupEndBeatRenderer();return t?this.isLeftHandTap?t.x+t.getNoteX(this.endNote,_h.Left):t.x+t.getNoteX(this.endNote,_h.Center):this.calculateStartY()+this.renderer.smuflMetrics.leftHandTabTieWidth}getEndNotePosition(){return _h.Center}caclculateEndY(){const t=this.lookupEndBeatRenderer();return t?this.isLeftHandTap?t.y+t.getNoteY(this.endNote,Bh.Center):this.tieDirection===Wt.Up?t.y+t.getNoteY(this.endNote,Bh.Top):t.y+t.getNoteY(this.endNote,Bh.Bottom):this.calculateStartY()}lookupEndBeatRenderer(){return this.endNoteRenderer||(this.endNoteRenderer=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,this.endNote.beat.voice.bar)),this.endNoteRenderer}lookupStartBeatRenderer(){return this.startNoteRenderer||(this.startNoteRenderer=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,this.startNote.beat.voice.bar)),this.startNoteRenderer}shouldDrawBendSlur(){return!1}}class Uo extends Vo{pS;constructor(t){super(t.slurEffectId,!1),this.pS=t}lookupStartBeatRenderer(){return this.renderer}lookupEndBeatRenderer(){return this.renderer}shouldDrawBendSlur(){return!1}calculateTieDirection(){return this.pS.tieDirection}calculateStartY(){return this.pS.calculateMultiSystemSlurY(this.renderer)}caclculateEndY(){return this.calculateStartY()}calculateStartX(){return this.renderer.staff.barRenderers[0].x}calculateEndX(){const t=this.renderer.staff.barRenderers[this.renderer.staff.barRenderers.length-1];return t.x+t.width}}class zo extends Oa{Gy=0;bS;mk=[];constructor(t,e,s,i,n=1){super(t,e),this.mk=zo.getSymbols(s),this.Gy=n,this.bS=i}static getSymbols(t){const e=[];for(;t>0;){const s=t%10;e.unshift(zo.getSymbol(s)),t=t/10|0}return e}static getSymbol(t){switch(t){case 0:return lt.TimeSig0;case 1:return lt.TimeSig1;case 2:return lt.TimeSig2;case 3:return lt.TimeSig3;case 4:return lt.TimeSig4;case 5:return lt.TimeSig5;case 6:return lt.TimeSig6;case 7:return lt.TimeSig7;case 8:return lt.TimeSig8;case 9:return lt.TimeSig9;default:return lt.None}}doLayout(){let t=0;for(const e of this.mk)t+=this.renderer.smuflMetrics.glyphWidths.get(e);this.width=t}paint(t,e,s){switch(this.bS){case ht.Top:e+=this.renderer.smuflMetrics.glyphBottom.get(this.mk[0]);break;case ht.Bottom:e+=this.renderer.smuflMetrics.glyphTop.get(this.mk[0])}s.fillMusicFontSymbols(t+this.x,e+this.y,this.Gy,this.mk)}}class Xo extends Oa{static mS=[lt.RestHBarLeft,lt.RestHBarMiddle,lt.RestHBarMiddle,lt.RestHBarMiddle,lt.RestHBarRight];gS=[];wS=0;constructor(){super(0,0)}doLayout(){const t=this.renderer.smuflMetrics;this.width=Xo.mS.reduce((e,s)=>e+t.glyphWidths.get(s),0);const e=this.renderer.additionalMultiRestBars.length+1;this.gS=zo.getSymbols(e),this.wS=this.renderer.getLineY(-1.5);const s=t.glyphTop.get(this.gS[0]);this.renderer.registerOverflowTop(Math.abs(this.wS)+s)}paint(t,e,s){s.fillMusicFontSymbols(t+this.x,e+this.y+this.renderer.height/2,1,Xo.mS);const i=this.renderer.getLineY(-1.5);s.fillMusicFontSymbols(t+this.x+this.width/2,e+this.y+i|0,1,this.gS,!0)}}class jo extends Ra{yS;constructor(){super(0,0)}get absoluteDisplayStart(){return this.renderer.bar.masterBar.start}get beatId(){return-1}get onTimeX(){return 0}get graceType(){return l.None}get graceIndex(){return 0}get graceGroup(){return null}get voiceIndex(){return 0}get isFirstOfTupletGroup(){return!1}get tupletGroup(){return null}get isLastOfVoice(){return!0}get displayDuration(){return 0}getRestY(t){const e=this.yS;if(e)switch(t){case Bh.Top:return e.y;case Bh.TopWithStem:return e.y-this.renderer.smuflMetrics.getStemLength(c.Quarter,!0);case Bh.Center:case Bh.StemUp:case Bh.StemDown:return e.y+e.height/2;case Bh.Bottom:return e.y+e.height;case Bh.BottomWithStem:return e.y+e.height+this.renderer.smuflMetrics.getStemLength(c.Quarter,!0)}return 0}getNoteY(t,e){return this.getRestY(e)}getHighestNoteY(t){return this.getRestY(t)}getLowestNoteY(t){return this.getRestY(t)}getNoteX(t,e){const s=this.yS;if(s)switch(e){case _h.Left:return s.x;case _h.Center:return s.x+s.width/2;case _h.Right:return s.x+s.width}return 0}getBeatX(t,e){const s=this.yS;if(s)switch(t){case bs.PreNotes:return s.x;case bs.OnNotes:case bs.MiddleNotes:case bs.Stem:case bs.PostNotes:return s.x+s.width;case bs.EndBeat:return this.width}return 0}registerLayoutingInfo(t){const e=this.yS?.width??0;t.addBeatSpring(this,0,e)}applyLayoutingInfo(t){}buildBoundingsLookup(t,e,s){}doLayout(){this.renderer.showMultiBarRest&&(this.yS=new Xo,this.yS.renderer=this.renderer,this.yS.doLayout(),this.width=this.yS.width)}doMultiVoiceLayout(){}getBoundingBoxTop(){return this.yS?.getBoundingBoxTop()??Number.NaN}getBoundingBoxBottom(){return this.yS?.getBoundingBoxBottom()??Number.NaN}paint(t,e,s){this.yS?.paint(t+this.x,e+this.y,s)}}class Jo{startBeat=null;startX=0;startY=0;endBeat=null;endX=0;endY=0;calcY(t){return this.startX===this.endX?this.startY:(this.endY-this.startY)/(this.endX-this.startX)*(t-this.startX)+this.startY}}class qo{kS;Hp;SS;voice=null;beats=[];shortestDuration=c.QuadrupleWhole;hasTuplet=!1;slashBeats=[];restBeats=[];lowestNoteInHelper=null;BS=-1;highestNoteInHelper=null;_S=-1;invertBeamDirection=!1;preferredBeamDirection=null;graceType=l.None;get isRestBeamHelper(){return 1===this.beats.length&&this.beats[0].isRest}hasStem(t,e){return t&&qo.beatHasStem(e)||!t&&qo.beatHasStem(e)}static beatHasStem(t){return t.duration>c.Whole}hasFlag(t,e){return t&&qo.beatHasFlag(e)||!t&&1===this.beats.length&&qo.beatHasFlag(this.beats[0])}static beatHasFlag(t){return!t.deadSlapped&&!t.isRest&&(t.duration>c.Quarter||t.graceType!==l.None)}constructor(t,e,s){this.kS=t,this.Hp=e,this.beats=[],this.SS=s}alignWithBeats(){for(const t of this.drawingInfos.values())t.startX=this.Hp.getBeatX(t.startBeat,bs.Stem),t.endX=this.Hp.getBeatX(t.endBeat,bs.Stem),this.drawingInfos.clear()}finish(){this.Hp.completeBeamingHelper(this)}static computeLineHeightsForRest(t){switch(t){case c.QuadrupleWhole:case c.DoubleWhole:return[2,2];case c.Whole:return[0,1];case c.Half:return[1,0];case c.Quarter:return[3,3];case c.Eighth:return[2,2];case c.Sixteenth:return[2,4];case c.ThirtySecond:return[4,4];case c.SixtyFourth:return[4,6];case c.OneHundredTwentyEighth:return[6,6];case c.TwoHundredFiftySixth:return[6,8]}return[0,0]}checkBeat(t){t.invertBeamDirection&&(this.invertBeamDirection=!0),this.voice||(this.voice=t.voice);let e=!1;if(0===this.beats.length)e=!0;else switch(this.beats[this.beats.length-1].beamingMode){case St.Auto:case St.ForceSplitOnSecondaryToNext:e=this.TS(this.beats[this.beats.length-1],t);break;case St.ForceSplitToNext:e=!1;break;case St.ForceMergeWithNext:e=!0}return e&&(null==this.preferredBeamDirection&&null!==t.preferredBeamDirection&&(this.preferredBeamDirection=t.preferredBeamDirection),t.hasTuplet&&(this.hasTuplet=!0),t.graceType!==l.None&&(this.graceType=t.graceType),t.isRest?0===this.beats.length?this.beats.push(t):this.restBeats.push(t):(this.isRestBeamHelper&&(this.beats=[]),this.beats.push(t),this.xS(t.minNote),this.xS(t.maxNote),this.shortestDuration<t.duration&&(this.shortestDuration=t.duration)),t.slashed&&this.slashBeats.push(t)),e}xS(t){if(!t)return;let e,s;this.voice&&t.isPercussion?(e=-ci.getPercussionSteps(t),s=e):(e=ci.getNoteValue(t),s=e,t.harmonicType!==f.None&&t.harmonicType!==f.Natural&&(s=t.realValue-this.kS.displayTranspositionPitch)),(!this.lowestNoteInHelper||e<this.BS)&&(this.lowestNoteInHelper=t,this.BS=e),(!this.highestNoteInHelper||s>this._S)&&(this.highestNoteInHelper=t,this._S=s)}TS(t,e){if(!t||!e||t.graceType!==e.graceType||t.graceType===l.BendGrace||e.graceType===l.BendGrace||t.deadSlapped||e.deadSlapped)return!1;if(t.graceType!==l.None&&e.graceType!==l.None)return!0;if(t.voice.bar!==e.voice.bar)return!1;const s=t.playbackStart,i=e.playbackStart;if(!qo.MS(t.duration)||!qo.MS(e.duration))return s===i;if(t.tupletGroup!==e.tupletGroup)return!1;if(t.hasTuplet&&e.hasTuplet&&t.tupletGroup===e.tupletGroup&&t.tupletGroup.isFull)return!0;return this.SS.calculateGroupIndex(s)===this.SS.calculateGroupIndex(i)}static MS(t){switch(t){case c.Whole:case c.Half:case c.Quarter:return!1;default:return!0}}static isFullBarJoin(t,e,s){return zt.getIndex(t.duration)-2-s>0&&zt.getIndex(e.duration)-2-s>0}get beatOfLowestNote(){return this.lowestNoteInHelper.beat}get beatOfHighestNote(){return this.highestNoteInHelper.beat}drawingInfos=new Map}class Yo{topY=0;bottomY=0;constructor(t,e){this.topY=t,this.bottomY=e}}class Ko{beat;topY=-1e3;bottomY=-1e3;slots=[];constructor(t){this.beat=t}addSlot(t,e){if(this.slots.push(new Yo(t,e)),-1e3===this.topY)this.topY=t,this.bottomY=e;else{const s=Math.min(t,e),i=Math.max(t,e);s<this.topY&&(this.topY=s),i>this.bottomY&&(this.bottomY=i)}}}class Qo{reservedLayoutAreasByDisplayTime=new Map;restDurationsByDisplayTime=new Map;getBeatMinMaxY(){let t=-1e3,e=-1e3;for(const s of this.reservedLayoutAreasByDisplayTime.values())-1e3===t?(t=s.topY,e=s.bottomY):(t>s.topY&&(t=s.topY),e<s.bottomY&&(e=s.bottomY));return-1e3===t?[0,0]:[t,e]}reserveBeatSlot(t,e,s){e!==s&&(this.reservedLayoutAreasByDisplayTime.has(t.displayStart)||this.reservedLayoutAreasByDisplayTime.set(t.displayStart,new Ko(t)),this.reservedLayoutAreasByDisplayTime.get(t.displayStart).addSlot(e,s),t.isRest&&this.registerRest(t))}registerRest(t){this.restDurationsByDisplayTime.has(t.displayStart)||this.restDurationsByDisplayTime.set(t.displayStart,new Map),this.restDurationsByDisplayTime.get(t.displayStart).has(t.playbackDuration)||this.restDurationsByDisplayTime.get(t.displayStart).set(t.playbackDuration,t.id)}applyRestCollisionOffset(t,e,s){if(t.voice.index>0&&this.reservedLayoutAreasByDisplayTime.has(t.playbackStart)){const i=qo.computeLineHeightsForRest(t.duration).map(t=>t*s),n=e-i[0],r=e+i[1];let a=n;const h=this.reservedLayoutAreasByDisplayTime.get(t.playbackStart);let o=!1;for(const t of h.slots)if(n>=t.topY&&n<=t.bottomY||r>=t.topY&&r<=t.bottomY){o=!0;break}if(o){a=1===t.voice.index?h.topY-i[1]-i[0]:h.bottomY;const e=a+i[0]+i[1],r=2*s,o=Math.ceil(Math.abs(a-n)/r);return h.addSlot(a,e),a<n?o*-r:o*r}}return 0}}class Zo{vS=0;NS=[];PS;constructor(t,e,s){this.vS=e,this.NS=s,this.PS=t}calculateGroupIndex(t){if(0===this.NS.length)return t;t%=this.PS;const e=Math.floor(t/this.vS);return this.NS[e]}static build(t,e,s){const i=t.calculateDuration(!1),n=H.toTicks(e),r=i/n;if(r<0||0===s.length)return new Zo(0,0,[]);let a=0,h=s[a];const o=[];for(let t=0;t<r;t++)a<s.length?(o.push(a),h--,h<=0&&(a++,a<s.length&&(h=s[a]))):(o.push(a),a++);return new Zo(i,n,o)}}class tc{Hp;CS=new Map;beamHelpers=[];collisionHelper;preferredBeamDirection=null;constructor(t){this.Hp=t,this.collisionHelper=new Qo}initialize(){const t=this.Hp,e=this.Hp.bar,s=e.masterBar,i=s.actualBeamingRules??tc.ES(s),n=i.findRule(e.shortestDuration),r=`beaming_${i.uniqueId}_${n[0]}`;let a=this.Hp.scoreRenderer.layout.beamingRuleLookups.has(r)?this.Hp.scoreRenderer.layout.beamingRuleLookups.get(r):void 0;a||(a=Zo.build(s,n[0],n[1]),this.Hp.scoreRenderer.layout.beamingRuleLookups.set(r,a));let h=null,o=null;for(let s=0,i=e.voices.length;s<i;s++){const i=e.voices[s];this.beamHelpers.push([]);for(let s=0,n=i.beats.length;s<n;s++){const n=i.beats[s];let r;n.graceType!==l.None?r=o:(r=h,o&&o.finish(),o=null),r&&r.checkBeat(n)||(r&&r.finish(),r=new qo(e.staff,t,a),r.preferredBeamDirection=this.preferredBeamDirection,r.checkBeat(n),n.graceType!==l.None?o=r:h=r,this.beamHelpers[i.index].push(r)),this.CS.set(n.id,r)}h&&h.finish(),o&&o.finish(),h=null,o=null}}static FS;static ES(t){let e=tc.FS;e||(e=new Map([Z.createSimple(2,16,c.Sixteenth,[1,1]),Z.createSimple(1,8,c.Eighth,[1]),Z.createSimple(1,4,c.Quarter,[1]),Z.createSimple(3,16,c.Sixteenth,[3]),Z.createSimple(4,16,c.Sixteenth,[2,2]),Z.createSimple(2,8,c.Eighth,[1,1]),Z.createSimple(5,16,c.Sixteenth,[3,2]),Z.createSimple(6,16,c.Sixteenth,[3,3]),Z.createSimple(3,8,c.Eighth,[3]),Z.createSimple(4,8,c.Eighth,[2,2]),Z.createSimple(2,4,c.Quarter,[1,1]),Z.createSimple(9,16,c.Sixteenth,[3,3,3]),Z.createSimple(5,8,c.Eighth,[3,2]),Z.createSimple(12,16,c.Sixteenth,[3,3,3,3]),Z.createSimple(6,8,c.Eighth,[3,3,3]),Z.createSimple(3,4,c.Quarter,[1,1,1]),Z.createSimple(7,8,c.Eighth,[4,3]),Z.createSimple(8,8,c.Eighth,[3,3,2]),Z.createSimple(4,4,c.Quarter,[1,1,1,1]),Z.createSimple(9,8,c.Eighth,[3,3,3]),Z.createSimple(10,8,c.Eighth,[4,3,3]),Z.createSimple(5,4,c.Quarter,[1,1,1,1,1]),Z.createSimple(12,8,c.Eighth,[3,3,3,3]),Z.createSimple(6,4,c.Quarter,[1,1,1,1,1,1]),Z.createSimple(15,8,c.Eighth,[3,3,3,3,3,3]),Z.createSimple(8,4,c.Quarter,[1,1,1,1,1,1,1,1]),Z.createSimple(18,8,c.Eighth,[3,3,3,3,3,3])].map(t=>[`${t.timeSignatureNumerator}_${t.timeSignatureDenominator}`,t])),tc.FS=e);const s=`${t.timeSignatureNumerator}_${t.timeSignatureDenominator}`;if(e.has(s))return e.get(s);let i=H.QuarterTime;if(8===t.timeSignatureDenominator)t.timeSignatureNumerator%3==0&&(i+=H.QuarterTime/2|0);const n=Math.ceil(t.calculateDuration(!1)/i),r=i/H.QuarterTime*2,a=new Z,h=[];for(let t=0;t<n;t++)h.push(r);return a.groups.set(c.Eighth,h),a.timeSignatureNumerator=t.timeSignatureNumerator,a.timeSignatureDenominator=t.timeSignatureDenominator,a.finish(),e.set(s,a),a}getBeamingHelperForBeat(t){return this.CS.has(t.id)?this.CS.get(t.id):void 0}}!function(t){t[t.TopWithStem=0]="TopWithStem",t[t.Top=1]="Top",t[t.Center=2]="Center",t[t.Bottom=3]="Bottom",t[t.BottomWithStem=4]="BottomWithStem",t[t.StemUp=5]="StemUp",t[t.StemDown=6]="StemDown"}(Bh||(Bh={})),function(t){t[t.Left=0]="Left",t[t.Center=1]="Center",t[t.Right=2]="Right"}(_h||(_h={}));class ec{AS=new Go;voiceContainer=new Ho;DS=new Go;zm=[];LS;topEffects;bottomEffects;get nextRenderer(){return this.bar&&this.bar.nextBar?this.scoreRenderer.layout.getRendererForBar(this.staff.staffId,this.bar.nextBar):null}get previousRenderer(){return this.bar&&this.bar.previousBar?this.scoreRenderer.layout.getRendererForBar(this.staff.staffId,this.bar.previousBar):null}scoreRenderer;staff;layoutingInfo;bar;additionalMultiRestBars=null;get lastBar(){return this.additionalMultiRestBars?this.additionalMultiRestBars[this.additionalMultiRestBars.length-1]:this.bar}x=0;y=0;width=0;computedWidth=0;height=0;index=0;WS=0;OS=0;beatEffectsMinY=Number.NaN;beatEffectsMaxY=Number.NaN;get topOverflow(){return this.WS+this.topEffects.height}get bottomOverflow(){return this.OS+this.bottomEffects.height}helpers;get collisionHelper(){return this.helpers.collisionHelper}isLinkedToPrevious=!1;canWrap=!0;get showMultiBarRest(){return!0}constructor(t,e){this.scoreRenderer=t,this.bar=e,this.helpers=new tc(this),this.topEffects=new Io(this,!0),this.bottomEffects=new Io(this,!1)}registerTie(t){this.zm.push(t)}get middleYPosition(){return 0}registerBeatEffectOverflows(t,e){const s=this.beatEffectsMinY;(Number.isNaN(s)||t<s)&&(this.beatEffectsMinY=t);const i=this.beatEffectsMaxY;(Number.isNaN(i)||e>i)&&(this.beatEffectsMaxY=e)}registerOverflowTop(t){return(t=Math.ceil(t))>this.WS&&(this.WS=t,!0)}registerOverflowBottom(t){return(t=Math.ceil(t))>this.OS&&(this.OS=t,!0)}scaleToWidth(t){const e=t-this.AS.width-this.DS.width;this.voiceContainer.scaleToWidth(e);for(const t of this.helpers.beamHelpers)for(const e of t)e.alignWithBeats();this.DS.x=this.AS.x+this.AS.width+e,this.width=t,this.topEffects.alignGlyphs(),this.bottomEffects.alignGlyphs()}get resources(){return this.settings.display.resources}get smuflMetrics(){return this.resources.engravingSettings}get settings(){return this.scoreRenderer.settings}wasFirstOfStaff=!1;get isFirstOfStaff(){return 0===this.index}get isLastOfStaff(){return this.index===this.staff.barRenderers.length-1}get isLast(){return!this.bar||this.bar.index===this.scoreRenderer.layout.lastBarIndex}RS(){const t=this.layoutingInfo,e=this.AS.width;t.preBeatSize<e&&(t.preBeatSize=e);this.voiceContainer.registerLayoutingInfo(t);const s=this.DS.width;t.postBeatSize<s&&(t.postBeatSize=s)}IS=0;afterReverted(){this.staff=void 0,this.registerMultiSystemSlurs(void 0),this.isFinalized=!1}afterStaffBarReverted(){this.topEffects.afterStaffBarReverted(),this.bottomEffects.afterStaffBarReverted(),this.GS()}applyLayoutingInfo(){if(this.IS>=this.layoutingInfo.version)return!1;this.topEffects.resetEffectBandSizingInfo(),this.bottomEffects.resetEffectBandSizingInfo(),this.IS=this.layoutingInfo.version,this.AS.width=this.layoutingInfo.preBeatSize;const t=this.voiceContainer;return t.x=this.AS.x+this.AS.width,t.applyLayoutingInfo(this.layoutingInfo),this.DS.x=Math.floor(t.x+t.width),this.DS.width=this.layoutingInfo.postBeatSize,this.width=Math.ceil(this.DS.x+this.DS.width),this.computedWidth=this.width,this.topEffects.sizeAndAlignEffectBands(),this.bottomEffects.sizeAndAlignEffectBands(),this.GS(),!0}isFinalized=!1;registerMultiSystemSlurs(t){if(!t)return void(this.LS=void 0);let e;for(const s of t){const t=new Uo(s);t.renderer=this,t.tieDirection=s.tieDirection,e||(e=[]),e.push(t)}this.LS=e}HS(t,e,s){let i=!1;for(const n of t){const t=n;if(t.doLayout(),n.checkForOverflow){const n=t.getBoundingBoxTop(),r=t.getBoundingBoxBottom()-s;r>0&&this.registerOverflowBottom(r)&&(i=!0);const a=n-e;a<0&&this.registerOverflowTop(-1*a)&&(i=!0)}}return i}finalizeRenderer(){this.isFinalized=!0;let t=!1;const e=this.y,s=this.y+this.height;this.HS(this.zm,e,s)&&(t=!0);const i=this.LS;i&&this.HS(i,e,s)&&(t=!0);const n=this.topEffects.finalizeEffects(),r=this.bottomEffects.finalizeEffects();return(n||r)&&(t=!0),t&&(this.updateSizes(),this.GS()),t}GS(){this.staff.registerOverflowTop(this.topOverflow),this.staff.registerOverflowBottom(this.bottomOverflow)}doLayout(){if(this.bar){this.helpers.initialize(),this.zm=[],this.AS.renderer=this,this.voiceContainer.renderer=this,this.DS.renderer=this,this.topEffects.doLayout(),this.bottomEffects.doLayout(),this.bar.simileMark===M.SecondOfDouble&&(this.canWrap=!1),this.createPreBeatGlyphs(),this.createBeatGlyphs(),this.createPostBeatGlyphs(),this.RS(),this.topEffects.sizeAndAlignEffectBands(!1),this.bottomEffects.sizeAndAlignEffectBands(!1),this.updateSizes();for(const t of this.helpers.beamHelpers)for(const e of t)e.finish();this.computedWidth=this.width,this.calculateOverflows(0,this.height)}}calculateOverflows(t,e){const s=this.AS.glyphs;if(s)for(const t of s){const s=t.getBoundingBoxTop();s<0&&this.registerOverflowTop(-1*s);const i=t.getBoundingBoxBottom();i>e&&this.registerOverflowBottom(i-e)}const i=this.DS.glyphs;if(i)for(const t of i){const s=t.getBoundingBoxTop();s<0&&this.registerOverflowTop(-1*s);const i=t.getBoundingBoxBottom();i>e&&this.registerOverflowBottom(i-e)}const n=this.voiceContainer,r=n.getBoundingBoxTop();r<0&&this.registerOverflowTop(-1*r);const a=n.getBoundingBoxBottom();a>e&&this.registerOverflowBottom(a-e);const h=this.beatEffectsMinY;!Number.isNaN(h)&&h<0&&this.registerOverflowTop(-1*h);const o=this.beatEffectsMaxY;!Number.isNaN(o)&&o>e&&this.registerOverflowBottom(o-e)}updateSizes(){this.staff.registerStaffTop(0),this.voiceContainer.x=this.AS.x+this.AS.width,this.DS.x=Math.floor(this.voiceContainer.x+this.voiceContainer.width),this.width=Math.ceil(this.DS.x+this.DS.width);const t=this.topEffects.updateEffectBandHeights(),e=this.bottomEffects.updateEffectBandHeights();(t||e)&&this.GS(),this.height+=this.layoutingInfo.height,this.height=Math.ceil(this.height),this.staff.registerStaffBottom(this.height)}addPreBeatGlyph(t){t.renderer=this,this.AS.addGlyph(t)}addBeatGlyph(t){t.renderer=this,this.voiceContainer.addGlyph(t)}getBeatContainer(t){return this.voiceContainer.getBeatContainer(t)}paint(t,e,s){this.paintContent(t,e,s);const i=e+this.y-this.staff.topOverflow;this.topEffects.paint(t+this.x,i,s);const n=e+this.y+this.height+this.staff.bottomOverflow-this.bottomEffects.height;this.bottomEffects.paint(t+this.x,n,s)}paintContent(t,e,s){this.paintBackground(t,e,s),s.color=this.resources.mainGlyphColor,this.AS.paint(t+this.x,e+this.y,s),this.voiceContainer.paint(t+this.x,e+this.y,s),s.color=this.resources.mainGlyphColor,this.DS.paint(t+this.x,e+this.y,s),this.VS(t,e,s)}VS(t,e,s){const i=this.LS;if(i)for(const n of i)n.paint(t,e,s)}paintBackground(t,e,s){this.layoutingInfo.paint(t+this.x+this.AS.x+this.AS.width,e+this.y+this.height,s)}buildBoundingsLookup(t,e,s){const i=new ua;i.bar=this.bar,i.visualBounds=new Us,i.visualBounds.x=e+this.x,i.visualBounds.y=s+this.y,i.visualBounds.w=this.width,i.visualBounds.h=this.height,i.realBounds=new Us,i.realBounds.x=e+this.x,i.realBounds.y=s+this.y,i.realBounds.w=this.width,i.realBounds.h=this.height,t.addBar(i),this.voiceContainer.buildBoundingsLookup(i,e+this.x,s+this.y)}addPostBeatGlyph(t){this.DS.addGlyph(t)}createPreBeatGlyphs(){this.wasFirstOfStaff=this.isFirstOfStaff}createBeatGlyphs(){if(this.additionalMultiRestBars){const t=new jo;this.addBeatGlyph(t)}else for(const t of this.bar.filledVoices)this.createVoiceGlyphs(this.bar.voices[t]);this.voiceContainer.doLayout(),(this.topEffects.isLinkedToPreviousRenderer||this.bottomEffects.isLinkedToPreviousRenderer)&&(this.isLinkedToPrevious=!0)}createVoiceGlyphs(t){this.topEffects.createVoiceGlyphs(t),this.bottomEffects.createVoiceGlyphs(t)}createPostBeatGlyphs(){}get beatGlyphsStart(){return this.voiceContainer.x}get postBeatGlyphsStart(){return this.DS.x}getBeatX(t,e=bs.PreNotes,s=!1){return this.beatGlyphsStart+this.voiceContainer.getBeatX(t,e,s)}getRatioPositionX(t){const e=this.bar.isEmpty?this.beatGlyphsStart:this.getBeatX(this.bar.voices[0].beats[0],bs.MiddleNotes);return e+(this.postBeatGlyphsStart-e)*t}getNoteX(t,e){return this.beatGlyphsStart+this.voiceContainer.getNoteX(t,e)}getNoteY(t,e){return this.voiceContainer.y+ +this.voiceContainer.getNoteY(t,e)}getRestY(t,e){return this.voiceContainer.y+ +this.voiceContainer.getRestY(t,e)}reLayout(){this.topEffects.reLayout(),this.bottomEffects.reLayout(),this.updateSizes(),(this.wasFirstOfStaff&&!this.isFirstOfStaff||!this.wasFirstOfStaff&&this.isFirstOfStaff)&&(this.recreatePreBeatGlyphs(),this.DS.doLayout()),this.RS(),this.calculateOverflows(0,this.height)}recreatePreBeatGlyphs(){this.AS=new Go,this.AS.renderer=this,this.createPreBeatGlyphs()}paintSimileMark(t,e,s){const i=ao.voice(s,R.Glyphs,this.bar.voices[0],!0);try{switch(this.bar.simileMark){case M.Simple:s.beginGroup(Ia.getGroupId(this.bar.voices[0].beats[0])),Rt.fillMusicFontSymbolSafe(s,t+this.x+this.width/2,e+this.y+this.height/2,1,lt.Repeat1Bar,!0),s.endGroup();break;case M.SecondOfDouble:s.beginGroup(Ia.getGroupId(this.bar.voices[0].beats[0])),s.beginGroup(Ia.getGroupId(this.bar.previousBar.voices[0].beats[0])),Rt.fillMusicFontSymbolSafe(s,t+this.x,e+this.y+this.height/2,1,lt.Repeat2Bars,!0),s.endGroup(),s.endGroup()}}finally{i?.[Symbol.dispose]?.()}}completeBeamingHelper(t){}}class sc extends Wh{Ek;$S=lt.None;US=0;zS=0;XS;constructor(t,e,s,i=!1){super(bs.EndBeat),this.Ek=s,this.x=t,this.y=e,this.XS=i}doLayout(){switch(super.doLayout(),this.Ek){case w.Slight:this.$S=this.slightVibratoGlyph;break;case w.Wide:this.$S=this.wideVibratoGlyph}this.US=this.renderer.smuflMetrics.repeatOffsetX.get(this.$S),this.zS=this.renderer.smuflMetrics.glyphTop.get(this.$S),this.height=this.renderer.smuflMetrics.glyphHeights.get(this.$S)}paintGrouped(t,e,s,i){let n=(s-(t+this.x))/this.US;this.XS||(n=Math.floor(n)),n<1&&(n=1);const r=[];for(let t=0;t<n;t++)r.push(this.$S);i.fillMusicFontSymbols(t+this.x,e+this.y+this.zS,1,r,!1)}}class ic extends sc{get slightVibratoGlyph(){return lt.GuitarVibratoStroke}get wideVibratoGlyph(){return lt.GuitarWideVibratoStroke}}class nc extends U{lineValue=0;constructor(t=0,e=0){super(t,e),this.lineValue=e}}class rc extends Oa{jS=[];JS=new Map;qS=-1;YS=-1;KS=-1;QS=-1;ZS=-1;tB=-1;eB=-1;checkForOverflow=!1;constructor(){super(0,0)}addBends(t){this.jS.push(t);const e=this.sB(t);this.JS.set(t.id,e),(-1===this.eB||this.eB<t.maxBendPoint.value)&&(this.eB=t.maxBendPoint.value);let s=0;switch(t.bendType){case a.Bend:s=e[1].value,t.isTieOrigin?(-1===this.QS||s<this.QS)&&(this.QS=s):(-1===this.KS||s<this.KS)&&(this.KS=s);break;case a.Release:s=e[1].value,t.isTieOrigin?(-1===this.tB||s<this.tB)&&(this.tB=s):s>0&&(-1===this.ZS||s<this.ZS)&&(this.ZS=s);break;case a.BendRelease:s=e[1].value,(-1===this.YS||s<this.YS)&&(this.YS=s),s=e[2].value,t.isTieOrigin?(-1===this.tB||s<this.tB)&&(this.tB=s):s>0&&(-1===this.ZS||s<this.ZS)&&(this.ZS=s);break;case a.Prebend:s=e[0].value,(-1===this.qS||s<this.qS)&&(this.qS=s);break;case a.PrebendBend:s=e[0].value,(-1===this.qS||s<this.qS)&&(this.qS=s),s=e[1].value,t.isTieOrigin?(-1===this.QS||s<this.QS)&&(this.QS=s):(-1===this.KS||s<this.KS)&&(this.KS=s);break;case a.PrebendRelease:s=e[0].value,(-1===this.qS||s<this.qS)&&(this.qS=s),s=e[1].value,t.isTieOrigin?(-1===this.tB||s<this.tB)&&(this.tB=s):s>0&&(-1===this.ZS||s<this.ZS)&&(this.ZS=s)}}doLayout(){super.doLayout(),this.iB();let t=0;for(const e of this.jS){const s=this.JS.get(e.id);switch(e.bendType){case a.Bend:s[1].lineValue=e.isTieOrigin?this.QS:this.KS;break;case a.Release:t=e.isTieOrigin?this.tB:this.ZS,t>=0&&(s[1].lineValue=t);break;case a.BendRelease:s[1].lineValue=this.YS,t=e.isTieOrigin?this.tB:this.ZS,t>=0&&(s[2].lineValue=t);break;case a.Prebend:s[0].lineValue=this.qS;break;case a.PrebendBend:s[0].lineValue=this.qS,s[1].lineValue=e.isTieOrigin?this.QS:this.KS;break;case a.PrebendRelease:s[0].lineValue=this.qS,t=e.isTieOrigin?this.tB:this.ZS,t>=0&&(s[1].lineValue=t)}}this.width=0,this.jS.sort((t,e)=>t.isStringed?t.string-e.string:t.realValue-e.realValue)}iB(){const t=this.renderer.resources,e=this.renderer.smuflMetrics;let s=this.eB*e.tabBendPerValueHeight;s+=e.tabBendStaffPadding;const i=this.renderer.scoreRenderer.canvas;i.font=t.tablatureFont;s+=i.measureText("full").height+t.engravingSettings.tabBendLabelPadding,this.renderer.registerOverflowTop(s)}sB(t){const e=[];switch(t.bendType){case a.Custom:for(const s of t.bendPoints)e.push(new nc(s.offset,s.value));break;case a.BendRelease:e.push(new nc(0,t.bendPoints[0].value)),e.push(new nc(U.MaxPosition/2|0,t.bendPoints[1].value)),e.push(new nc(U.MaxPosition,t.bendPoints[3].value));break;case a.Bend:case a.Hold:case a.Prebend:case a.PrebendBend:case a.PrebendRelease:case a.Release:e.push(new nc(0,t.bendPoints[0].value)),e.push(new nc(U.MaxPosition,t.bendPoints[1].value))}return e}paint(t,e,s){const i=s.color;this.jS.length>1&&(s.color=this.renderer.resources.secondaryGlyphColor);for(const n of this.jS){const r=this.renderer;let h=n,o=!1,c=null,l=!1,u=null;for(;h.isTieOrigin;){const t=h.tieDestination;if(c=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,t.beat.voice.bar),!c||r.staff!==c.staff)break;if(h=t,o=!0,h.hasBend||!this.renderer.settings.notation.extendBendArrowsOnTiedNotes||h.vibrato!==w.None){l=!0;break}}u=h.beat,c=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,u.voice.bar),u.isLastOfVoice&&!h.hasBend&&this.renderer.settings.notation.extendBendArrowsOnTiedNotes&&(u=null);const d=r.smuflMetrics,f=d.glyphWidths.get(lt.ArrowheadBlackDown),p=e+r.y-d.tabBendStaffPadding;let b=t+r.x;const m=this.JS.get(n.id);m[0].value>0||n.isContinuedBend?b+=r.getBeatX(n.beat,bs.MiddleNotes):b+=r.getNoteX(n,_h.Right);let g=0;!u||u.isLastOfVoice&&!l?(g=t+c.x+c.postBeatGlyphsStart,g-=this.renderer.smuflMetrics.postNoteEffectPadding):l||!u.nextBeat?g=t+c.x+c.getBeatX(u,bs.MiddleNotes):n.bendType===a.Hold?g=t+c.x+c.getBeatX(u.nextBeat,bs.OnNotes):(g=t+c.x+c.getBeatX(u.nextBeat,bs.PreNotes),g-=this.renderer.smuflMetrics.postNoteEffectPadding),o||(g-=f/2),this.nB(s,b,p,g,r,n,m),this.rB(s,t,g+f/2,p-d.tabBendPerValueHeight*m[m.length-1].lineValue,c,h),s.color=i}}rB(t,e,s,i,n,r){if(r.isTieDestination&&r.vibrato!==w.None&&!r.hasBend){const a=e+n.x,h=new ic(s-a,0,r.vibrato);h.beat=r.beat,h.renderer=n,h.doLayout(),h.paint(a,i,t)}}nB(t,e,s,i,n,r,h){const o=t.lineWidth,c=this.renderer.resources,l=t.textBaseline;t.textBaseline=ht.Alphabetic,t.lineWidth=c.engravingSettings.arrowShaftThickness;const u=(i-e)/U.MaxPosition;for(let i=0,o=h.length-1;i<o;i++){const o=h[i];let c=h[i+1];0!==i||0===o.value||r.isTieDestination||this.aB(t,e,s,u,n,r,new nc(0,0),o),r.bendType!==a.Prebend?(0===i&&(e+=this.renderer.smuflMetrics.postNoteEffectPadding),this.aB(t,e,s,u,n,r,o,c)):r.isTieOrigin&&r.tieDestination.hasBend&&(c=new nc(U.MaxPosition,o.value),c.lineValue=o.lineValue,this.aB(t,e,s,u,n,r,o,c))}t.lineWidth=o,t.textBaseline=l}hB(t,e,s,i,n,r,a){if(r.value===a.value){if(r.lineValue>0){let n=i;const r=this.renderer.smuflMetrics.tabBendDashSize,a=e+r;if((n-e)/(2*r)<1)t.moveTo(n,s),t.lineTo(e,s);else for(;n>a;)t.moveTo(n,s),t.lineTo(n-r,s),n-=2*r;t.stroke()}}else if(i>e){const h=a.value>r.value?3:-3;t.moveTo(e,s),t.bezierCurveTo((e+i)/2,s,i,s,i,n+h),t.stroke()}else t.moveTo(e,s),t.lineTo(i,n),t.stroke()}aB(t,e,s,i,n,r,a,h){const o=n.lineOffset/2,c=n.resources,l=c.engravingSettings,u=e+i*a.offset;let d;0===a.value?(d=s+l.tabBendStaffPadding,h.offset===a.offset?d+=n.getNoteY(r.beat.maxStringNote,Bh.Top)-o:d+=n.getNoteY(r,Bh.Center)):d=s-l.tabBendPerValueHeight*a.lineValue;const f=e+i*h.offset;let p;p=0===h.lineValue?s+l.tabBendStaffPadding+n.getNoteY(r.beat.maxStringNote,Bh.Center):s-l.tabBendPerValueHeight*h.lineValue,this.hB(t,u,d,f,p,a,h);const b=l.glyphWidths.get(lt.ArrowheadBlackDown);if(a.value!==h.value){const e=h.value>a.value;this.oB(t,f,p,d,b,e),this.cB(t,u,d,f,p,r,c.graceFont),this.lB(t,d,f,p-l.tabBendLabelPadding,a,h,c.tablatureFont)}}cB(t,e,s,i,n,a,h){if(a.bendStyle===r.Gradual){const r="grad.",a=t.measureText(r);t.font=h;let o=0,c=0;if(s>n){const t=Math.abs(s-n);o=t>a.height?s-t/2:s,c=(e+i-a.width)/2}else o=s,c=i-a.width;t.fillText(r,c,o)}}lB(t,e,s,i,n,r,a){if(0!==r.value){const h=r.value>n.value;let o=r.value,c="";if(4===o)c="full",o-=4;else if(o>=4||o<=-4){const t=o/4|0;c+=t,o-=4*t}if(o>0&&(c+=rc.getFractionSign(o)),""!==c){const n=h?i:e+1*Math.abs(i-e)/3;t.font=a;const r=s-t.measureText(c).width/2;t.fillText(c,r,n)}}}oB(t,e,s,i,n,r){r?(s+n>i&&(s=i-n),t.beginPath(),t.moveTo(e,s),t.lineTo(e-.5*n,s+n),t.lineTo(e+.5*n,s+n),t.closePath(),t.fill()):(s<i&&(s=i+n),t.beginPath(),t.moveTo(e,s),t.lineTo(e-.5*n,s-n),t.lineTo(e+.5*n,s-n),t.closePath(),t.fill())}static getFractionSign(t){switch(t){case 1:return"¼";case 2:return"½";case 3:return"¾";default:return`${t}/ 4`}}}class ac extends Fh{Ge;JS;uB=!1;originalTopOffset=0;originalBottomOffset=0;topOffset=0;bottomOffset=0;constructor(t){super(0,0),this.Ge=t,this.JS=this.sB(t)}sB(t){if(t.whammyBarType===pt.Custom)return t.whammyBarPoints;const e=[];switch(t.whammyBarType){case pt.Dive:case pt.Hold:case pt.PrediveDive:case pt.Predive:e.push(new U(0,t.whammyBarPoints[0].value)),e.push(new U(U.MaxPosition,t.whammyBarPoints[1].value));break;case pt.Dip:e.push(new U(0,t.whammyBarPoints[0].value)),e.push(new U(U.MaxPosition/2|0,t.whammyBarPoints[1].value)),e.push(new U(U.MaxPosition,t.whammyBarPoints[t.whammyBarPoints.length-1].value))}return e}doLayout(){if(super.doLayout(),this.Ge.whammyBarType===pt.Custom)return;this.uB=this.renderer.settings.notation.notationMode===S.SongBook&&this.Ge.whammyBarType===pt.Dip;const t=this.Ge.minWhammyPoint,e=this.Ge.maxWhammyPoint;let s=e.value>0?-this.dB(e.value):0,i=t.value<0?-this.dB(t.value):0;const n=this.renderer.scoreRenderer.canvas;n.font=this.renderer.resources.tablatureFont;const r=n.measureText("-1").height+this.renderer.smuflMetrics.tabWhammyTextPadding;if((0!==s||0!==this.Ge.whammyBarPoints[0].value||this.renderer.settings.notation.isNotationElementVisible(B.ZerosOnDiveWhammys))&&(s-=r),0!==i)if(this.uB)s-=r;else{const t=i-r;t<s&&(s=t)}s=Math.abs(s),i=Math.abs(i),this.topOffset=s,this.bottomOffset=i,this.originalTopOffset=s,this.originalBottomOffset=i,this.height=s+i,this.width=0}dB(t){if(0===t)return 0;let e=this.renderer.smuflMetrics.tabWhammyPerHalfHeight+Math.log2(Math.abs(t)/2)*this.renderer.smuflMetrics.tabWhammyPerHalfHeight;return t<0&&(e=-e),e}paint(t,e,s){const i=ao.beat(s,Bt.StandardNotationEffects,this.Ge);try{const i=this.renderer;let n=this.Ge.nextBeat,a=null,h=bs.PreNotes;n&&(a=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,n.voice.bar),a&&a.staff===i.staff&&(a===i||n.hasWhammyBar)?h=!n.hasWhammyBar||i.settings.notation.notationMode===S.SongBook&&n.whammyBarType===pt.Dip?bs.PreNotes:bs.MiddleNotes:(n=null,a=null));let o=0,c=0;this.uB?(o=t+i.getBeatX(this.Ge,bs.OnNotes,!0),c=t+i.getBeatX(this.Ge,bs.PostNotes,!0)):(o=t+i.getBeatX(this.Ge,bs.MiddleNotes,!0),c=a?t-i.x+a.x+a.getBeatX(n,h,!0):t+i.getBeatX(this.Ge,bs.EndBeat)-i.smuflMetrics.postNoteEffectPadding);const l=s.textAlign,u=s.textBaseline;if(s.textAlign=at.Center,s.textBaseline=ht.Alphabetic,s.font=this.renderer.resources.tablatureFont,this.JS.length>=2){const t=(c-o)/U.MaxPosition;s.beginPath();const i=e+this.topOffset;let n=this.Ge.whammyStyle===r.Gradual?"grad.":"";for(let e=0,r=this.JS.length-1;e<r;e++){const r=this.JS[e],a=this.JS[e+1];let h=0===e;0!==e||0===r.value||this.Ge.isContinuedWhammy||(this.fB(!1,new U(0,0),r,o,i,t,s),h=!1),this.fB(h,r,a,o,i,t,s,n),n=""}s.stroke()}s.textAlign=l,s.textBaseline=u}finally{i?.[Symbol.dispose]?.()}}fB(t,e,s,i,n,r,a,h){const o=i+r*e.offset,c=i+r*s.offset,l=n-this.dB(e.value),u=n-this.dB(s.value);if(e.offset===s.offset){const t=this.renderer.smuflMetrics.tabWhammyDashSize;if(Math.abs(u-l)/(2*t)<1)a.moveTo(o,l),a.lineTo(c,u);else{const e=Math.max(l,u);let s=Math.min(l,u);for(;e>s;)a.moveTo(o,s),a.lineTo(o,s+t),s+=2*t}a.stroke()}else if(e.value===s.value){const t=this.renderer.smuflMetrics.tabWhammyDashSize;if(Math.abs(c-o)/(2*t)<1)a.moveTo(o,l),a.lineTo(c,u);else{let e=Math.max(o,c);const s=Math.min(o,c);for(;e>s;)a.moveTo(e,l),a.lineTo(e-t,l),e-=2*t}a.stroke()}else a.moveTo(o,l),a.lineTo(c,u);const d=this.renderer.smuflMetrics.tabWhammyTextPadding;!t||this.Ge.isContinuedWhammy||this.uB||(this.renderer.settings.notation.isNotationElementVisible(B.ZerosOnDiveWhammys)&&a.fillText("0",o,l-d),h&&a.fillText(h,o,l-d));let f=Math.abs(s.value);if((0!==f||this.renderer.settings.notation.isNotationElementVisible(B.ZerosOnDiveWhammys)&&!this.uB)&&e.value!==s.value){let t="";if(s.value<0&&(t+="-"),f>=4){const e=f/4|0;t+=e,f-=4*e}else 0===f&&(t+="0");f>0&&(t+=rc.getFractionSign(f));let i=0;i=this.uB||e.offset===s.offset?Math.min(l,u):u;const n=c;a.fillText(t,n,i-d)}}}class hc extends Dh{get notationElement(){return B.EffectWhammyBar}get effectId(){return`${super.effectId}.simpledip`}get hideOnMultiTrack(){return!1}get canShareBand(){return!1}get sizingMode(){return Sh.SingleOnBeat}shouldCreateGlyph(t,e){return t.notation.notationMode===S.SongBook&&e.hasWhammyBar&&e.whammyBarType===pt.Dip}createNewGlyph(t,e){return new ac(e)}canExpand(t,e){return!0}}class oc extends sc{get slightVibratoGlyph(){return lt.WiggleSawtoothNarrow}get wideVibratoGlyph(){return lt.WiggleSawtooth}}class cc extends Dh{get notationElement(){return B.EffectSlightBeatVibrato}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return Sh.GroupedOnBeatToEnd}shouldCreateGlyph(t,e){return e.vibrato===w.Slight}createNewGlyph(t,e){return new oc(0,0,w.Slight)}canExpand(t,e){return!0}}class lc extends bo{pB;get notationElement(){return B.EffectSlightNoteVibrato}shouldCreateGlyphForNote(t){let e=t.vibrato===w.Slight||t.isTieDestination&&t.tieOrigin.vibrato===w.Slight;return this.pB&&e&&t.isTieDestination&&t.tieOrigin.hasBend&&(e=!1),e}get sizingMode(){return Sh.GroupedOnBeatToEnd}createNewGlyph(t,e){return new ic(0,0,w.Slight)}constructor(t){super(),this.pB=t}}class uc extends Fh{constructor(){super(0,0)}doLayout(){super.doLayout(),this.height=this.renderer.smuflMetrics.glyphHeights.get(lt.KeyboardPedalPed)}paint(t,e,s){const i=this.renderer,n=e+this.y,r=this.height,a=i.bar.sustainPedals,h=this.renderer.smuflMetrics.glyphWidths.get(lt.KeyboardPedalPed),o=this.renderer.smuflMetrics.glyphWidths.get(lt.KeyboardPedalUp);let c=0;for(;c<a.length;){let e=a[c];for(;null!=e;){const i=t+this.renderer.getRatioPositionX(e.ratioPosition);let l=0;if(e.pedalType===P.Down?(Rt.fillMusicFontSymbolSafe(s,i,n+r,1,lt.KeyboardPedalPed,!0),l=h/2+this.renderer.smuflMetrics.sustainPedalLinePadding):e.pedalType===P.Up&&(Rt.fillMusicFontSymbolSafe(s,i,n+r,1,lt.KeyboardPedalUp,!0),l=o/2+this.renderer.smuflMetrics.sustainPedalLinePadding),e.nextPedalMarker)if(e.nextPedalMarker.bar===e.bar){let a=t+this.renderer.getRatioPositionX(e.nextPedalMarker.ratioPosition);switch(e.nextPedalMarker.pedalType){case P.Down:a-=h/2;break;case P.Hold:break;case P.Up:a-=o/2}const c=i+l;a>c&&s.fillRect(c,n+r-this.renderer.smuflMetrics.pedalLineThickness,a-c,this.renderer.smuflMetrics.pedalLineThickness)}else{const e=t+this.x+this.width,a=i+l;s.fillRect(a,n+r-this.renderer.smuflMetrics.pedalLineThickness,e-a,this.renderer.smuflMetrics.pedalLineThickness)}if(0===c&&e.previousPedalMarker){const e=t+this.x,a=i-l;s.fillRect(e,n+r-this.renderer.smuflMetrics.pedalLineThickness,a-e,this.renderer.smuflMetrics.pedalLineThickness)}c++,null!=e.nextPedalMarker&&e.nextPedalMarker.bar!==e.bar?(e=null,c=a.length):e=e.nextPedalMarker}}}}class dc extends Dh{get notationElement(){return B.EffectSustainPedal}get hideOnMultiTrack(){return!1}get canShareBand(){return!1}get sizingMode(){return Sh.FullBar}shouldCreateGlyph(t,e){return 0===e.voice.index&&0===e.index&&e.voice.bar.sustainPedals.length>0}createNewGlyph(t,e){return new uc}canExpand(t,e){return!0}}class fc extends Dh{get notationElement(){return B.EffectWhammyBarLine}get hideOnMultiTrack(){return!1}get canShareBand(){return!1}get sizingMode(){return Sh.GroupedOnBeatToEnd}shouldCreateGlyph(t,e){return e.hasWhammyBar}createNewGlyph(t,e){return new ac(e)}canExpand(t,e){return e.hasWhammyBar}static offsetSharedDataKey="tab.whammy.offset";onAlignGlyphs(t){const e=t.renderer.staff.getSharedLayoutData(fc.offsetSharedDataKey,[0,0]);t.renderer.staff.setSharedLayoutData(fc.offsetSharedDataKey,e);for(const s of t.iterateAllGlyphs()){const t=s;t.originalTopOffset>e[0]&&(e[0]=t.originalTopOffset),t.originalBottomOffset>e[1]&&(e[1]=t.originalBottomOffset)}}finalizeBand(t){const e=t.renderer.staff.getSharedLayoutData(fc.offsetSharedDataKey,[0,0]),s=e[0],i=e[1];for(const e of t.iterateAllGlyphs()){const t=e;t.topOffset=s,t.bottomOffset=i,t.height=s+i}t.slot.shared.height=s+i,t.height=s+i}}class pc extends Dh{get notationElement(){return B.EffectTap}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return Sh.SingleOnBeat}shouldCreateGlyph(t,e){return e.slap||e.pop||e.tap}createNewGlyph(t,e){const s=t.resources;return e.slap?new Hh(0,0,"S",s.elementFonts.get(B.EffectTap),at.Center):e.pop?new Hh(0,0,"P",s.elementFonts.get(B.EffectTap),at.Center):new Hh(0,0,"T",s.elementFonts.get(B.EffectTap),at.Center)}canExpand(t,e){return!0}}class bc extends Fh{bB;constructor(t){super(0,0),this.bB=t}doLayout(){super.doLayout();const t=this.renderer.resources;this.height=this.renderer.smuflMetrics.glyphHeights.get(lt.MetNoteQuarterUp)*t.engravingSettings.tempoNoteScale}paint(t,e,s){for(const i of this.bB){let n=t+this.renderer.getRatioPositionX(i.ratioPosition);const r=this.renderer.resources;s.font=r.elementFonts.get(B.EffectMarker);const a=e+this.y+this.height+this.renderer.smuflMetrics.glyphBottom.get(lt.MetNoteQuarterUp)*r.engravingSettings.tempoNoteScale,h=s.textBaseline;if(s.textBaseline=ht.Alphabetic,i.text){const t=`${i.text} `,e=s.measureText(t);s.fillText(t,n,a),n+=e.width}else n-=r.engravingSettings.glyphWidths.get(lt.MetNoteQuarterUp)/2;Rt.fillMusicFontSymbolSafe(s,n,a,r.engravingSettings.tempoNoteScale,lt.MetNoteQuarterUp),n+=this.renderer.smuflMetrics.glyphWidths.get(lt.MetNoteQuarterUp)*r.engravingSettings.tempoNoteScale,s.fillText(` = ${i.value.toString()}`,n,a),s.textBaseline=h,n+=s.measureText(` = ${i.value.toString()}`).width}}}class mc extends Dh{get notationElement(){return B.EffectTempo}get hideOnMultiTrack(){return!0}get canShareBand(){return!1}get sizingMode(){return Sh.SinglePreBeat}shouldCreateGlyph(t,e){return 0===e.voice.bar.staff.index&&0===e.voice.index&&0===e.index&&e.voice.bar.masterBar.tempoAutomations.some(t=>t.isVisible)}createNewGlyph(t,e){return new bc(e.voice.bar.masterBar.tempoAutomations.filter(t=>t.isVisible))}canExpand(t,e){return!0}}class gc extends Dh{get notationElement(){return B.EffectText}get hideOnMultiTrack(){return!1}get canShareBand(){return!1}get sizingMode(){return Sh.SingleOnBeat}shouldCreateGlyph(t,e){return!!e.text}createNewGlyph(t,e){return new Hh(0,0,e.text,t.resources.elementFonts.get(B.EffectText),at.Left)}canExpand(t,e){return!0}}class wc extends Wh{constructor(t,e){super(bs.EndBeat),this.x=t,this.y=e}doLayout(){super.doLayout(),this.height=this.renderer.smuflMetrics.glyphHeights.get(lt.OrnamentTrill)}paintGrouped(t,e,s,i){const n=this.renderer.smuflMetrics.glyphWidths.get(lt.OrnamentTrill),r=t+this.x+n,a=this.renderer.smuflMetrics.repeatOffsetX.get(lt.WiggleTrill),h=Math.ceil((s-r)/a),o=[lt.OrnamentTrill];for(let t=0;t<h;t++)o.push(lt.WiggleTrill);i.fillMusicFontSymbols(t+this.x-n/2,e+this.y+this.height,1,o,!1)}}class yc extends bo{get notationElement(){return B.EffectTrill}shouldCreateGlyphForNote(t){return t.isTrill}get sizingMode(){return Sh.GroupedOnBeatToEnd}createNewGlyph(t,e){return new wc(0,0)}}!function(t){t[t.EighthEighth=0]="EighthEighth",t[t.SixteenthSixteenth=1]="SixteenthSixteenth",t[t.QuarterTripletEighthTriplet=2]="QuarterTripletEighthTriplet",t[t.EighthSixteenthTriplet=3]="EighthSixteenthTriplet",t[t.EighthDottedSixteenth=4]="EighthDottedSixteenth",t[t.SixteenthDottedThirtySecond=5]="SixteenthDottedThirtySecond",t[t.SixteenthEighthDotted=6]="SixteenthEighthDotted",t[t.ThirtySecondSixteenthDotted=7]="ThirtySecondSixteenthDotted"}(Th||(Th={}));class kc extends Fh{mB;gB=0;wB=0;constructor(t){super(0,0),this.mB=t}doLayout(){super.doLayout();const t=this.renderer.smuflMetrics.tempoNoteScale;this.height=this.renderer.smuflMetrics.glyphHeights.get(lt.MetNoteQuarterUp)*t,this.gB=this.renderer.smuflMetrics.glyphHeights.get(lt.Tuplet3)*t,this.wB=this.renderer.smuflMetrics.tripletFeelBracketPadding,this.height+=this.gB}paint(t,e,s){t+=this.x,e+=this.y;let i=Th.EighthEighth,n=Th.EighthEighth;switch(this.mB){case F.NoTripletFeel:i=Th.EighthEighth,n=Th.EighthEighth;break;case F.Triplet8th:i=Th.EighthEighth,n=Th.QuarterTripletEighthTriplet;break;case F.Triplet16th:i=Th.SixteenthSixteenth,n=Th.EighthSixteenthTriplet;break;case F.Dotted8th:i=Th.EighthEighth,n=Th.EighthDottedSixteenth;break;case F.Dotted16th:i=Th.SixteenthSixteenth,n=Th.SixteenthDottedThirtySecond;break;case F.Scottish8th:i=Th.EighthEighth,n=Th.SixteenthEighthDotted;break;case F.Scottish16th:i=Th.SixteenthSixteenth,n=Th.ThirtySecondSixteenthDotted}const r=this.renderer.smuflMetrics.tempoNoteScale,a=e+this.renderer.smuflMetrics.glyphTop.get(lt.MetNoteQuarterUp)*r,h=e+this.height,o=s.textBaseline;s.textBaseline=ht.Bottom,s.font=this.renderer.resources.elementFonts.get(B.EffectTripletFeel),s.fillText("(",t,h),t+=s.measureText("( ").width,t=this.yB(t,a+this.gB,s,i),s.fillText(" = ",t,h),t+=s.measureText(" = ").width,t=this.yB(t,a+this.gB,s,n),s.fillText(" )",t,h),s.textBaseline=o}yB(t,e,s,i){const n=this.renderer.smuflMetrics.tempoNoteScale;let r=[],a=[];const h=[];let o=lt.None;switch(i){case Th.EighthEighth:h.push(at.Center),r=[lt.MetNoteQuarterUp],a=[lt.MetNoteQuarterUp];break;case Th.SixteenthSixteenth:h.push(at.Center),h.push(at.Center),r=[lt.MetNoteQuarterUp],a=[lt.MetNoteQuarterUp];break;case Th.QuarterTripletEighthTriplet:r=[lt.MetNoteQuarterUp],a=[lt.MetNote8thUp],o=lt.Tuplet3;break;case Th.EighthSixteenthTriplet:h.push(at.Center),h.push(at.Right),r=[lt.MetNoteQuarterUp],a=[lt.MetNoteQuarterUp],o=lt.Tuplet3;break;case Th.EighthDottedSixteenth:h.push(at.Center),h.push(at.Right),r=[lt.MetNoteQuarterUp,lt.Space,lt.MetAugmentationDot],a=[lt.MetNoteQuarterUp];break;case Th.SixteenthDottedThirtySecond:h.push(at.Center),h.push(at.Center),h.push(at.Right),r=[lt.MetNoteQuarterUp,lt.Space,lt.MetAugmentationDot],a=[lt.MetNoteQuarterUp];break;case Th.SixteenthEighthDotted:h.push(at.Center),h.push(at.Left),r=[lt.MetNoteQuarterUp],a=[lt.MetNoteQuarterUp,lt.Space,lt.MetAugmentationDot];break;case Th.ThirtySecondSixteenthDotted:h.push(at.Center),h.push(at.Center),h.push(at.Left),r=[lt.MetNoteQuarterUp],a=[lt.MetNoteQuarterUp,lt.Space,lt.MetAugmentationDot]}const c=this.renderer.smuflMetrics.glyphWidths.get(lt.MetNoteQuarterUp)*n,l=t+c-this.renderer.smuflMetrics.stemThickness*n,u=l+2*c+this.renderer.smuflMetrics.stemThickness*n,d=this.renderer.smuflMetrics.tempoNoteScale*this.renderer.smuflMetrics.beamThickness,f=this.renderer.smuflMetrics.tempoNoteScale*this.renderer.smuflMetrics.beamSpacing,p=this.renderer.smuflMetrics.brokenBeamWidth*n;let b=e-this.renderer.smuflMetrics.glyphHeights.get(lt.MetNoteQuarterUp)*n+d;if(o!==lt.None){const e=(t+u)/2,i=b-this.gB-this.wB,r=this.renderer.smuflMetrics.glyphTop.get(o)*n,a=this.renderer.smuflMetrics.glyphWidths.get(o)*n;Rt.fillMusicFontSymbolSafe(s,e,i+r,n,o,!0);const h=e-a/2-this.wB,c=e+a/2+this.wB,l=this.gB/2,d=s.lineWidth;s.beginPath(),s.moveTo(t,i+l+l),s.lineTo(t,i+l),s.lineTo(h,i+l),s.moveTo(c,i+l),s.lineTo(u,i+l),s.lineTo(u,i+l+l),s.lineWidth=this.renderer.smuflMetrics.tupletBracketThickness*n,s.stroke(),s.lineWidth=d}s.fillMusicFontSymbols(t,e,n,r,!1),t+=c,t+=c,s.fillMusicFontSymbols(t,e,n,a,!1),t+=c,a[a.length-1]!==lt.MetAugmentationDot&&a[0]!==lt.MetNote8thUp||(t+=c);for(const t of h){switch(t){case at.Left:s.fillRect(l,b,p,d);break;case at.Center:s.fillRect(l,b,u-l,d);break;case at.Right:s.fillRect(u-p,b,p,d)}b+=d+f}return t}}class Sc extends Dh{get notationElement(){return B.EffectTripletFeel}get hideOnMultiTrack(){return!0}get canShareBand(){return!1}get sizingMode(){return Sh.SinglePreBeat}shouldCreateGlyph(t,e){return 0===e.index&&(0===e.voice.bar.masterBar.index&&e.voice.bar.masterBar.tripletFeel!==F.NoTripletFeel||e.voice.bar.masterBar.index>0&&e.voice.bar.masterBar.tripletFeel!==e.voice.bar.masterBar.previousMasterBar.tripletFeel)}createNewGlyph(t,e){return new kc(e.voice.bar.masterBar.tripletFeel)}canExpand(t,e){return!0}}class Bc extends Kh{constructor(t){super(0,0,1,Bc.Sk(t)),this.center=!0}static Sk(t){switch(t){case gt.Open:return lt.GuitarOpenPedal;case gt.Closed:return lt.GuitarClosePedal}return lt.None}paint(t,e,s){super.paint(t,e+this.height,s)}}class _c extends Dh{get notationElement(){return B.EffectWahPedal}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return Sh.SingleOnBeat}shouldCreateGlyph(t,e){return e.wahPedal!==gt.None}createNewGlyph(t,e){return new Bc(e.wahPedal)}canExpand(t,e){return!1}}class Tc extends Dh{get notationElement(){return B.EffectWhammyBar}get hideOnMultiTrack(){return!1}get canShareBand(){return!1}get sizingMode(){return Sh.GroupedOnBeat}shouldCreateGlyph(t,e){return e.hasWhammyBar}createNewGlyph(t,e){return new Oh("w/bar",B.EffectWhammyBar)}canExpand(t,e){return!0}}class xc extends Dh{get notationElement(){return B.EffectWideBeatVibrato}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return Sh.GroupedOnBeatToEnd}shouldCreateGlyph(t,e){return e.vibrato===w.Wide}createNewGlyph(t,e){return new oc(0,0,w.Wide)}canExpand(t,e){return!0}}class Mc extends bo{get notationElement(){return B.EffectWideNoteVibrato}shouldCreateGlyphForNote(t){return t.vibrato===w.Wide||t.isTieDestination&&t.tieOrigin.vibrato===w.Wide}get sizingMode(){return Sh.GroupedOnBeatToEnd}createNewGlyph(t,e){return new ic(0,0,w.Wide)}}class vc extends ro{kB=0;SB;constructor(t,e,s=at.Center){super(t,e),this.glyphs=[],this.SB=s}doLayout(){const t=this.renderer.smuflMetrics.rowContainerGap,e=this.kB-t;let s=0;switch(this.SB){case at.Left:s=0;break;case at.Center:s=(this.width-e)/2;break;case at.Right:s=this.width-e}for(const e of this.glyphs)e.x=s,s+=e.width+t}addGlyphToRow(t){this.glyphs.push(t),this.kB+=t.width+this.renderer.smuflMetrics.rowContainerGap,t.height>this.height&&(this.height=t.height)}}class Nc extends ro{BB=[];SB;constructor(t,e,s=at.Center){super(t,e),this.height=0,this.glyphs=[],this.SB=s}doLayout(){let t=0,e=0;const s=this.renderer.smuflMetrics.rowContainerGap;this.BB=[];let i=new vc(t,e,this.SB);i.renderer=this.renderer,i.width=this.width;for(const n of this.glyphs){const r=t+n.width+s;r<this.width?(i.addGlyphToRow(n),t=Math.ceil(r)):(i.isEmpty||(i.doLayout(),this.BB.push(i),e+=i.height+s),t=0,i=new vc(t,e,this.SB),i.renderer=this.renderer,i.width=this.width,i.addGlyphToRow(n),t+=Math.ceil(n.width+s))}i.isEmpty||(i.doLayout(),this.BB.push(i),e+=Math.ceil(i.height+this.renderer.smuflMetrics.rowContainerPadding)),this.height=e}paint(t,e,s){for(const i of this.BB)i.paint(t+this.x,e+this.y,s)}}class Pc extends Nc{addChord(t){if(t.strings.length>0){const e=new $h(0,0,t,B.ChordDiagrams);e.renderer=this.renderer,e.doLayout(),this.glyphs.push(e)}}paint(t,e,s){if(this.glyphs.length>0){const i=ao.score(s,ot.ChordDiagramList,this.renderer.scoreRenderer.score);try{super.paint(t,e,s)}finally{i?.[Symbol.dispose]?.()}}}}class Cc extends Nc{constructor(t,e){super(t,e,at.Left)}}class Ec extends ro{_B;TB;colorOverride;constructor(t,e,s,i){super(t,e),this._B=s,this.TB=i,this.glyphs=[]}doLayout(){if(!(this.glyphs.length>0)){this.xB(this._B);for(const t of this.glyphs)t.renderer=this.renderer,t.doLayout()}}paint(t,e,s){const i=s.color;this.colorOverride&&(s.color=this.colorOverride),super.paint(t,e,s),s.color=i}xB(t){const e=this.renderer.resources;if(this.height=0,this.TB.length>0){const t=new Hh(0,this.height,this.TB,e.elementFonts.get(B.GuitarTuning),at.Left);t.renderer=this.renderer,t.doLayout(),this.height+=t.height,this.addGlyph(t)}if(t.name.length>0){const s=new Hh(0,this.height,t.name,e.elementFonts.get(B.GuitarTuning),at.Left);s.renderer=this.renderer,s.doLayout(),this.height+=s.height,this.addGlyph(s)}const s=this.renderer.smuflMetrics.tuningGlyphCircleNumberScale,i=this.renderer.smuflMetrics.glyphHeights.get(lt.GuitarString0)*s;this.renderer.scoreRenderer.canvas.font=e.elementFonts.get(B.GuitarTuning);const n=(i+this.renderer.scoreRenderer.canvas.measureText(" = Gb").width)*e.engravingSettings.tuningGlyphStringColumnScale;if(this.width=Math.max(this.renderer.scoreRenderer.canvas.measureText(this.TB).width,Math.max(this.renderer.scoreRenderer.canvas.measureText(t.name).width,2*n)),!t.isStandard){const r=0|Math.ceil(t.tunings.length/2);let a=0;const h=this.height+this.renderer.smuflMetrics.tuningGlyphStringRowPadding;let o=h;for(let c=0,l=t.tunings.length;c<l;c++){const l=lt.GuitarString0+(c+1);this.addGlyph(new Kh(a,o+i,s,l));const u=` = ${Te.getTextForTuning(t.tunings[c],!1)}`;this.addGlyph(new Hh(a+i,o+i/2,u,e.elementFonts.get(B.GuitarTuning),at.Left,ht.Middle)),o+=i+this.renderer.smuflMetrics.tuningGlyphStringRowPadding;const d=o;this.height<d&&(this.height=d),c===r-1&&(o=h,a+=n)}}}}class Fc{er=new Map;clear(){this.er.clear()}startMultiSystemSlur(t){const e=Fc.MB(t.renderer.staff);let s;this.er.has(e)?s=this.er.get(e):(s={startedSlurs:new Map},this.er.set(e,s)),s.startedSlurs.set(t.slurEffectId,{startGlyph:t})}static MB(t){return`${t.modelStaff.index}.${t.modelStaff.track.index}.${t.staffId}`}completeMultiSystemSlur(t){const e=Fc.MB(t.renderer.staff);if(!this.er.has(e))return;const s=this.er.get(e);if(s.startedSlurs.has(t.slurEffectId)){const e=s.startedSlurs.get(t.slurEffectId);return e.endGlyph=t,e.startGlyph}}*getAllContinuations(t){const e=Fc.MB(t.staff);if(!this.er.has(e)||t.index>0)return;const s=this.er.get(e);for(const e of s.startedSlurs.values())e.startGlyph.shouldCreateMultiSystemSlur(t)&&(yield e.startGlyph)}}class Ac{v;vB=new Map;staffTrackGroup;system;barRenderers=[];x=0;y=0;height=0;index=0;staffIndex=0;isVisible=!1;NB=0;get isFirstInSystem(){return this.system.firstVisibleStaff===this}topEffectInfos=[];bottomEffectInfos=[];trackIndex=0;modelStaff;get staffId(){return this.v.staffId}staffTop=0;topPadding=0;bottomPadding=0;staffBottom=0;get contentTop(){return this.y+this.staffTop+this.topPadding+this.topOverflow}get contentBottom(){return this.y+this.topPadding+this.topOverflow+this.staffBottom}constructor(t,e,s,i){this.v=i,this.trackIndex=e,this.modelStaff=s,this.system=t;for(const t of i.effectBands)if(!t.shouldCreate||t.shouldCreate(s))switch(t.mode){case kh.OwnedTop:case kh.SharedTop:this.topEffectInfos.push(t);break;case kh.OwnedBottom:case kh.SharedBottom:this.bottomEffectInfos.push(t)}this.PB()}getSharedLayoutData(t,e){return this.vB.has(t)?this.vB.get(t):e}setSharedLayoutData(t,e){this.vB.set(t,e)}registerStaffTop(t){t>this.staffTop&&(this.staffTop=t)}registerStaffBottom(t){t>this.staffBottom&&(this.staffBottom=t)}addBarRenderer(t){t.staff=this,t.index=this.barRenderers.length,t.reLayout(),this.barRenderers.push(t),this.system.layout.registerBarRenderer(this.staffId,t),(t.bar.isEmpty||t.bar.isRestOnly)&&this.NB++,this.PB()}PB(){const t=this.modelStaff.track.score.stylesheet,e=t.hideEmptyStaves&&(t.hideEmptyStavesInFirstSystem||this.system.index>0);this.isVisible=!e||this.NB<this.barRenderers.length}addBar(t,e,s){const i=this.v.create(this.system.layout.renderer,t);i.topEffects.infos=this.topEffectInfos,i.bottomEffects.infos=this.bottomEffectInfos,i.additionalMultiRestBars=s,i.staff=this,i.index=this.barRenderers.length,i.layoutingInfo=e,i.doLayout(),this.barRenderers.push(i),this.system.layout.registerBarRenderer(this.staffId,i),(t.isEmpty||t.isRestOnly)&&this.NB++,this.PB()}revertLastBar(){this.resetSharedLayoutData();const t=this.barRenderers[this.barRenderers.length-1];this.barRenderers.splice(this.barRenderers.length-1,1),this.topOverflow=0,this.bottomOverflow=0;for(const t of this.barRenderers)t.afterStaffBarReverted();return(t.bar.isEmpty||t.bar.isRestOnly)&&this.NB--,this.PB(),t}resetSharedLayoutData(){this.vB.clear()}topOverflow=0;registerOverflowTop(t){t>this.topOverflow&&(this.topOverflow=t)}bottomOverflow=0;registerOverflowBottom(t){t>this.bottomOverflow&&(this.bottomOverflow=t)}calculateHeightForAccolade(){this.CB(),this.height=this.barRenderers.length>0?this.barRenderers[0].height:0,this.height>0&&(this.height+=Math.ceil(this.topPadding+this.topOverflow+this.bottomOverflow+this.bottomPadding))}CB(){const t=0===this.index,e=this.index===this.system.staves.length-1,s=this.system.layout.renderer.settings.display;this.topPadding=t?s.firstNotationStaffPaddingTop:s.notationStaffPaddingTop,this.bottomPadding=e?s.lastNotationStaffPaddingBottom:s.notationStaffPaddingBottom}finalizeStaff(){this.CB(),this.height=0;let t=!1,e=this.topOverflow;for(const e of this.barRenderers)e.registerMultiSystemSlurs(this.system.layout.slurRegistry.getAllContinuations(e)),e.finalizeRenderer()&&(t=!0),this.height=Math.max(this.height,e.height);if(t){e=this.topOverflow;for(const t of this.barRenderers)t.y=this.topPadding+e;for(const t of this.barRenderers)t.finalizeRenderer()}this.height>0&&(this.height+=this.topPadding+e+this.bottomOverflow+this.bottomPadding),this.height=Math.ceil(this.height),this.PB()}paint(t,e,s,i,n){if(0!==this.height&&0!==n)for(let r=i,a=Math.min(i+n,this.barRenderers.length);r<a;r++)this.barRenderers[r].paint(t+this.x,e+this.y,s)}}class Dc{timePosition=0;longestDuration=0;smallestDuration=0;force=0;springConstant=0;get springWidth(){return this.preSpringWidth+this.postSpringWidth}preBeatWidth=0;graceBeatWidth=0;postSpringWidth=0;get preSpringWidth(){return this.preBeatWidth+this.graceBeatWidth}allDurations=new Set}class Lc{static EB=30;static FB=7;AB=[];DB=-1;LB=0;WB=new Map;OB=0;RB=new Map;IB=Lc.EB;version=0;preBeatSize=0;postBeatSize=0;minStretchForce=0;totalSpringConstant=0;GB(t){this.minStretchForce<t&&(this.minStretchForce=t)}getBeatSizes(t){const e=t.absoluteDisplayStart;if(this.RB.has(e))return this.RB.get(e)}setBeatSizes(t,e){const s=t.absoluteDisplayStart;if(this.RB.has(s)){const t=this.RB.get(s);t.onBeatSize<e.onBeatSize&&(t.onBeatSize=e.onBeatSize),t.preBeatSize<e.preBeatSize&&(t.preBeatSize=e.preBeatSize)}else this.RB.set(s,e)}getPreBeatSize(t){if(t.graceType!==l.None){const e=t.graceGroup.id;return this.allGraceRods.get(e)[t.graceIndex].preBeatWidth}const e=t.absoluteDisplayStart;return this.springs.has(e)?this.springs.get(e).preBeatWidth:0}getPostBeatSize(t){if(t.graceType!==l.None){const e=t.graceGroup.id;return this.allGraceRods.get(e)[t.graceIndex].postSpringWidth}const e=t.absoluteDisplayStart;return this.springs.has(e)?this.springs.get(e).postSpringWidth:0}incompleteGraceRods=new Map;allGraceRods=new Map;springs=new Map;addSpring(t,e,s,i,n){let r;if(this.version++,this.springs.has(t))r=this.springs.get(t),r.postSpringWidth<n&&(r.postSpringWidth=n),r.graceBeatWidth<s&&(r.graceBeatWidth=s),r.preBeatWidth<i&&(r.preBeatWidth=i),e<r.smallestDuration&&(r.smallestDuration=e),e>r.longestDuration&&(r.longestDuration=e),r.allDurations.add(e);else{if(r=new Dc,r.timePosition=t,r.allDurations.add(e),this.AB.length>0){const t=this.AB[this.AB.length-1];for(const e of t.allDurations)t.timePosition;e<this.IB&&(this.IB=e)}r.longestDuration=e,r.postSpringWidth=n,r.graceBeatWidth=s,r.preBeatWidth=i,this.springs.set(t,r);const a=this.AB;let h=a.length-1;for(;h>0&&a[h].timePosition>t;)h--;this.AB.splice(h+1,0,r)}return(-1===this.DB||this.DB>t)&&(this.DB=t),r}addBeatSpring(t,e,s){const i=t.absoluteDisplayStart;if(t.graceType!==l.None){const n=t.graceGroup.id;this.allGraceRods.has(n)||this.allGraceRods.set(n,new Array(t.graceGroup.beats.length)),t.graceGroup.isComplete||this.incompleteGraceRods.has(n)||this.incompleteGraceRods.set(n,new Array(t.graceGroup.beats.length));const r=this.allGraceRods.get(n)[t.graceIndex];if(r)r.postSpringWidth<s&&(r.postSpringWidth=s),r.preBeatWidth<e&&(r.preBeatWidth=e);else{const r=new Dc;r.timePosition=i,r.postSpringWidth=s,r.preBeatWidth=e,t.graceGroup.isComplete||(this.incompleteGraceRods.get(n)[t.graceIndex]=r),this.allGraceRods.get(n)[t.graceIndex]=r}}else{let n=0;if(t.graceGroup&&this.allGraceRods.has(t.graceGroup.id))for(const e of this.allGraceRods.get(t.graceGroup.id))n+=e.springWidth;this.addSpring(i,t.displayDuration,n,e,s)}}finish(){for(const[t,e]of this.allGraceRods){let t=0;for(const s of e)t+=s.preBeatWidth,s.graceBeatWidth=t,t+=s.postSpringWidth}this.OB=0;for(const t of this.incompleteGraceRods.values())for(const e of t)this.OB+=e.preBeatWidth+e.postSpringWidth;this.HB(),this.version++}HB(){let t=0;const e=this.AB;if(0===e.length)return this.totalSpringConstant=-1,void(this.minStretchForce=-1);for(let s=0;s<e.length;s++){const i=e[s];let n=0;if(s===e.length-1)n=i.longestDuration;else{const t=e[s+1];n=Math.abs(t.timePosition-i.timePosition)}i.springConstant=this.VB(i,n),t+=1/i.springConstant}this.totalSpringConstant=1/t,this.minStretchForce=0;for(let t=0;t<e.length;t++){const s=e[t];let i=0;if(t===e.length-1)i=s.postSpringWidth;else{const n=e[t+1];i=s.postSpringWidth+n.preSpringWidth}0===t&&(i+=s.preSpringWidth);const n=i*s.springConstant;this.GB(n)}}height=0;paint(t,e,s){}VB(t,e){e<=0&&(e=H.toTicks(c.TwoHundredFiftySixth)),0===t.smallestDuration&&(t.smallestDuration=e);const s=t.smallestDuration,i=this.IB,n=Lc.FB;return s/e*(1/((1+.85*Math.log2(e/i))*n))}spaceToForce(t){return-1!==this.totalSpringConstant?(this.AB.length>0&&(t-=this.AB[0].preSpringWidth),t-=this.OB,Math.max(t,0)*this.totalSpringConstant):-1}calculateVoiceWidth(t){let e=0;return-1!==this.totalSpringConstant&&(e=this.$B(t,this.totalSpringConstant)),this.AB.length>0&&(e+=this.AB[0].preSpringWidth),e+=this.OB,e}$B(t,e){return t/e}buildOnTimePositions(t){if(-1===this.totalSpringConstant)return new Map;if(zt.isAlmostEqualTo(this.LB,t)&&this.WB)return this.WB;this.LB=t;const e=new Map;this.WB=e;const s=this.AB;if(0===s.length)return e;let i=s[0].preSpringWidth;for(let n=0;n<s.length;n++)e.set(s[n].timePosition,i),i+=this.$B(t,s[n].springConstant);return e}}class Wc{width=0;isLinkedToPrevious=!1;canWrap=!0;masterBar;additionalMultiBarRestIndexes=null;get lastMasterBarIndex(){return this.additionalMultiBarRestIndexes?this.additionalMultiBarRestIndexes[this.additionalMultiBarRestIndexes.length-1]:this.masterBar.index}renderers=[];layoutingInfo}class Oc{track;staffSystem;staves=[];firstVisibleStaff;lastVisibleStaff;bracket=null;constructor(t,e){this.staffSystem=t,this.track=e}addStaff(t){this.staves.push(t)}}class Rc{UB;firstStaffInBracket;lastStaffInBracket;firstVisibleStaffInBracket;lastVisibleStaffInBracket;drawAsBrace=!1;braceScale=1;width=0;index=0;canPaint=!1;constructor(t){this.UB=t}updateCanPaint(){let t,e;for(let s=this.firstStaffInBracket.index;s<=this.lastStaffInBracket.index;s++){const i=this.UB.allStaves[s];i.isVisible&&(t||(t=i),e=i)}if(this.firstVisibleStaffInBracket=t,this.lastVisibleStaffInBracket=e,!t||!e)return void(this.canPaint=!1);this.UB.layout.renderer.score.stylesheet.showSingleStaffBrackets||t!==e?this.canPaint=!0:this.canPaint=!1}finalizeBracket(t){if(!this.canPaint)return void(this.width=0);const e=t.glyphHeights.get(lt.Brace),s=t.glyphWidths.get(lt.Brace);if(this.drawAsBrace?this.width=s:this.width=t.bracketThickness,!this.drawAsBrace)return;const i=this.firstVisibleStaffInBracket.contentTop,n=(this.lastVisibleStaffInBracket.contentBottom-i)/e;this.braceScale=n,this.width=s*this.braceScale}}class Ic extends Rc{track;constructor(t,e){super(t),this.track=e,this.drawAsBrace=Ic.isTrackDrawAsBrace(e)}includesStaff(t){return t.modelStaff.track===this.track}static isTrackDrawAsBrace(t){return t.staves.filter(t=>t.showStandardNotation).length>1}}class Gc extends Ic{includesStaff(t){return t.modelStaff.track===this.track||!this.drawAsBrace&&this.track.playbackInfo.program===t.modelStaff.track.playbackInfo.program}}class Hc{zB=!1;nr=[];XB=new Map;jB=0;JB=!1;x=0;y=0;index=0;accoladeWidth=0;isFull=!1;width=0;computedWidth=0;totalBarDisplayScale=0;isLast=!1;masterBarsRenderers=[];staves=[];layout;topPadding;bottomPadding;allStaves=[];firstVisibleStaff;constructor(t){this.layout=t,this.topPadding=t.renderer.settings.display.systemPaddingTop,this.bottomPadding=t.renderer.settings.display.systemPaddingBottom}get firstBarIndex(){return this.masterBarsRenderers[0].masterBar.index}get lastBarIndex(){return this.masterBarsRenderers[this.masterBarsRenderers.length-1].lastMasterBarIndex}addMasterBarRenderers(t,e){if(0===t.length)return null;this.masterBarsRenderers.push(e),e.layoutingInfo.preBeatSize=0;let s,i=0,n=!1;for(const t of this.staves){let r,a;for(const h of t.staves){const t=e.renderers[i++];h.addBarRenderer(t),h.isVisible&&(n=!0,r||(r=h),s||(s=h),a=h)}t.firstVisibleStaff=r,t.lastVisibleStaff=a,s||(s=r)}if(!n){const t=this.staves[0],e=t.staves[0];e.isVisible=!0,t.firstVisibleStaff=e,t.lastVisibleStaff=e,s=e}return this.firstVisibleStaff=s,this.qB(t),this.YB(),e}addBars(t,e,s){const i=new Wc;let n;i.additionalMultiBarRestIndexes=s,i.layoutingInfo=new Lc,i.masterBar=t[0].score.masterBars[e],this.masterBarsRenderers.push(i);let r=!1;const a=i.layoutingInfo;for(const t of this.staves){let h,o;for(const n of t.staves){const c=t.track.staves[n.modelStaff.index].bars[e],l=null==s?null:s.map(e=>t.track.staves[n.modelStaff.index].bars[e]);n.addBar(c,a,l),n.isVisible&&(r=!0,h||(h=n),o=n);const u=n.barRenderers[n.barRenderers.length-1];i.renderers.push(u),u.isLinkedToPrevious&&(i.isLinkedToPrevious=!0),u.canWrap||(i.canWrap=!1)}t.firstVisibleStaff=h,t.lastVisibleStaff=o,n||(n=h)}if(!r){const t=this.staves[0],e=t.staves[0];e.isVisible=!0,t.firstVisibleStaff=e,t.lastVisibleStaff=e,n=e}return this.firstVisibleStaff=n,this.qB(t),a.finish(),i.width=this.YB(),i}getBarDisplayScale(t){return this.staves.length>1?t.bar.masterBar.displayScale:t.bar.displayScale}revertLastBar(){if(this.masterBarsRenderers.length>1){const t=this.masterBarsRenderers[this.masterBarsRenderers.length-1];this.masterBarsRenderers.splice(this.masterBarsRenderers.length-1,1);let e,s=0,i=0;for(const t of this.staves){let n,r;for(const e of t.staves){const t=e.revertLastBar(),a=t.computedWidth;a>s&&(s=a),t.afterReverted(),i=this.getBarDisplayScale(t),e.isVisible&&(n||(n=e),r=e)}t.firstVisibleStaff=n,t.lastVisibleStaff=r,e||(e=n)}return this.firstVisibleStaff=e,this.width-=s,this.computedWidth-=s,this.totalBarDisplayScale-=i,t}return null}YB(){let t=0,e=0;for(const s of this.allStaves){const i=s.barRenderers[s.barRenderers.length-1];i.applyLayoutingInfo(),e=this.getBarDisplayScale(i),i.computedWidth>t&&(t=i.computedWidth)}return this.totalBarDisplayScale+=e,this.width+=t,this.computedWidth+=t,t}qB(t){const e=this.layout.renderer.settings;if(this.zB)for(const t of this.nr)t.updateCanPaint(),t.finalizeBracket(e.display.resources.engravingSettings);else{this.zB=!0,this.accoladeWidth=0;const s=this.layout.renderer.score.stylesheet;if(this.layout.renderer.settings.notation.isNotationElementVisible(B.TrackNames)){const i=1===this.layout.renderer.tracks.length?s.singleTrackTrackNamePolicy:s.multiTrackTrackNamePolicy,n=0===this.index?s.firstSystemTrackNameMode:s.otherSystemsTrackNameMode,r=0===this.index?s.firstSystemTrackNameOrientation:s.otherSystemsTrackNameOrientation;let a=!1;switch(i){case D.Hidden:break;case D.FirstSystem:a=0===this.index;break;case D.AllSystems:a=!0}let h=!1;if(a){const s=this.layout.renderer.canvas,i=e.display.resources.elementFonts.get(B.TrackNames);s.font=i;for(const e of t){let t="";switch(n){case L.FullName:t=e.name;break;case L.ShortName:t=e.shortName}if(t.length>0){h=!0;const e=s.measureText(t);switch(r){case W.Horizontal:this.accoladeWidth=Math.ceil(Math.max(this.accoladeWidth,e.width));break;case W.Vertical:this.accoladeWidth=Math.ceil(Math.max(this.accoladeWidth,e.height))}}}this.accoladeWidth+=e.display.systemLabelPaddingLeft,h&&(this.accoladeWidth+=e.display.systemLabelPaddingRight)}}let i=0;for(const t of this.allStaves)t.y=i,t.calculateHeightForAccolade(),i+=t.height;let n=0;for(const t of this.nr)t.updateCanPaint(),t.finalizeBracket(e.display.resources.engravingSettings),n=Math.max(n,t.width);this.accoladeWidth+=n,this.width+=this.accoladeWidth,this.computedWidth+=this.accoladeWidth}}KB(t){for(let e=0,s=this.staves.length;e<s;e++){const s=this.staves[e];if(s.track===t)return s}return null}addStaff(t){const e=t.modelStaff.track;let s=this.KB(e);s||(s=new Oc(this,e),this.staves.push(s)),t.staffTrackGroup=s,t.system=this,t.index=this.allStaves.length,this.allStaves.push(t),s.addStaff(t);let i=this.nr.find(e=>e.includesStaff(t));if(!i)switch(e.score.stylesheet.bracketExtendMode){case A.NoBrackets:break;case A.GroupStaves:i=new Ic(this,e),i.index=this.nr.length,this.nr.push(i);break;case A.GroupSimilarInstruments:i=new Gc(this,e),i.index=this.nr.length,this.nr.push(i)}i&&(i.firstStaffInBracket||(i.firstStaffInBracket=t),i.lastStaffInBracket=t,s.bracket=i,this.XB.set(t,i))}get height(){return Math.ceil(this.jB+this.topPadding+this.bottomPadding)}paint(t,e,s){if(this.paintPartial(t+this.x,e+this.y+this.topPadding,s,0,this.masterBarsRenderers.length),this.JB){const i=ao.track(s,Lt.SystemSeparator,this.allStaves[0].modelStaff.track);try{const i=this.layout.renderer.settings.display.resources.engravingSettings,n=Math.min(0,i.glyphBottom.get(lt.SystemDivider)??0);Rt.fillMusicFontSymbolSafe(s,t+this.x,e+this.y+this.height+n,1,lt.SystemDivider,!1),Rt.fillMusicFontSymbolSafe(s,t+this.x+this.width-i.glyphWidths.get(lt.SystemDivider),e+this.y+this.height+n,1,lt.SystemDivider,!1)}finally{i?.[Symbol.dispose]?.()}}}paintPartial(t,e,s,i,n){for(const r of this.allStaves)r.isVisible&&r.paint(t,e,s,i,n);const r=this.layout.renderer.settings.display.resources;if(this.staves.length>0&&0===i){s.color=r.barSeparatorColor;const i=this.layout.renderer.settings,n=this.layout.renderer.settings.notation.isNotationElementVisible(B.TrackNames);if(s.font=r.elementFonts.get(B.TrackNames),n){const n=this.layout.renderer.score.stylesheet,r=1===this.layout.renderer.tracks.length?n.singleTrackTrackNamePolicy:n.multiTrackTrackNamePolicy,a=0===this.index?n.firstSystemTrackNameMode:n.otherSystemsTrackNameMode,h=0===this.index?n.firstSystemTrackNameOrientation:n.otherSystemsTrackNameOrientation;let o=!1;switch(r){case D.Hidden:break;case D.FirstSystem:o=0===this.index;break;case D.AllSystems:o=!0}if(o){const n=s.textBaseline,r=s.textAlign;for(const n of this.staves)if(n.firstVisibleStaff){const r=e+n.firstVisibleStaff.contentTop,o=e+n.lastVisibleStaff.contentBottom;let c="";switch(a){case L.FullName:c=n.track.name;break;case L.ShortName:c=n.track.shortName}const l=ao.track(s,Lt.TrackName,n.track);try{if(c.length>0){const e=t+n.staves[0].x-i.display.accoladeBarPaddingRight-(n.bracket?.width??0)-i.display.systemLabelPaddingRight;switch(h){case W.Horizontal:s.textBaseline=ht.Middle,s.textAlign=at.Right,s.fillText(c,e,(r+o)/2);break;case W.Vertical:s.textBaseline=ht.Bottom,s.textAlign=at.Center;const t=.1;s.beginRotate(e,(r+o)/2,-90-t),s.fillText(c,0,0),s.endRotate()}}}finally{l?.[Symbol.dispose]?.()}}s.textBaseline=n,s.textAlign=r}}const a=!this.layout.renderer.score.stylesheet.extendBarLines;if(this.allStaves.length>0&&a){let i=null;for(const n of this.allStaves)if(n.isVisible){if(null!==i){const a=i.contentBottom,h=n.contentTop,o=t+i.x,c=i.barRenderers[0],l=ao.bar(s,c.staffLineBarSubElement,c.bar);try{const t=Math.ceil(h-a);s.fillRect(o,e+a,r.engravingSettings.thinBarlineThickness,t)}finally{l?.[Symbol.dispose]?.()}}i=n}}this.QB(t,e,s)}}QB(t,e,s){const i=this.layout.renderer.settings;for(const n of this.nr)if(n.canPaint){const r=t+n.firstVisibleStaffInBracket.x,a=n.width,h=i.display.accoladeBarPaddingRight;let o=e+n.firstVisibleStaffInBracket.contentTop,c=e+n.lastVisibleStaffInBracket.contentBottom;if(n.drawAsBrace)Rt.fillMusicFontSymbolSafe(s,r-h-a,c,n.braceScale,lt.Brace);else if(n.firstVisibleStaffInBracket!==n.lastVisibleStaffInBracket){const t=.25*i.display.resources.engravingSettings.oneStaffSpace;o-=t,c+=t;const e=3;s.fillRect(r-h-a,o-e,a,Math.ceil(c-o+2*e));const n=r-h-a;Rt.fillMusicFontSymbolSafe(s,n,o,1,lt.BracketTop),Rt.fillMusicFontSymbolSafe(s,n,Math.floor(c),1,lt.BracketBottom)}}}finalizeSystem(){const t=this.layout.renderer.settings;if(0===this.index&&(this.topPadding=t.display.firstSystemPaddingTop),this.isLast)this.bottomPadding=t.display.lastSystemPaddingBottom;else if(this.layout.renderer.score.stylesheet.useSystemSignSeparator&&this.layout.renderer.tracks.length>1){const e=t.display.resources.engravingSettings.glyphHeights.get(lt.SystemDivider);this.bottomPadding=Math.max(this.bottomPadding,e),this.JB=!0}if(!this.ZB()){this.staves[0].staves[0].isVisible=!0,this.ZB(!0)}for(const e of this.nr)e.finalizeBracket(t.display.resources.engravingSettings)}ZB(t=!1){let e=0;const s=this.layout.renderer.settings,i=s.display.resources.engravingSettings,n=i.glyphHeights.get(lt.BracketTop),r=i.glyphHeights.get(lt.BracketBottom);let a,h=0,o=!1;for(const i of this.staves){let c,l;for(const u of i.staves){void 0!==a&&a.trackIndex!==u.trackIndex&&(e+=s.display.trackStaffPaddingBetween);const i=this.XB.has(u)?this.XB.get(u):void 0,d=i&&!i.drawAsBrace&&i.canPaint;if(d&&i.firstStaffInBracket===u){const t=n-u.topOverflow;t>0&&(e+=t)}if(u.x=this.accoladeWidth,u.y=e,t||u.finalizeStaff(),u.isVisible&&(e+=u.height,o=!0,a=u,c||(c=u),l=u),h=0,d&&i.lastStaffInBracket===u){const t=r-u.bottomOverflow;t>0&&(u.isVisible?e+=t:h=t)}}if(i.firstVisibleStaff=c,i.lastVisibleStaff=l,this.firstVisibleStaff||(this.firstVisibleStaff=c),t)break}return h&&(e+=h),this.jB=e,o}buildBoundingsLookup(t,e){if(this.layout.renderer.boundsLookup.isFinished)return;const s=this.allStaves[0],i=this.allStaves[this.allStaves.length-1],n=(e+=this.topPadding)+this.y+s.y,r=e+this.y+i.y+i.height-n,a=e+this.y,h=e+this.y+this.height-a,o=e+this.y+s.y+s.topPadding+s.topOverflow,c=e+this.y+i.y+i.height-i.bottomPadding-i.bottomOverflow-o,l=this.x+s.x,u=new ba;u.visualBounds=new Us,u.visualBounds.x=t+this.x,u.visualBounds.y=e+this.y,u.visualBounds.w=this.width,u.visualBounds.h=this.height-this.topPadding-this.bottomPadding,u.realBounds=new Us,u.realBounds.x=t+this.x,u.realBounds.y=e+this.y,u.realBounds.w=this.width,u.realBounds.h=this.height,this.layout.renderer.boundsLookup.addStaffSystem(u);const d=new Map;for(let t=0;t<this.staves.length;t++)for(const s of this.staves[t].staves)if(s.isVisible)for(const t of s.barRenderers){let i;d.has(t.bar.masterBar.index)?i=d.get(t.bar.masterBar.index):(i=new fa,i.index=t.bar.masterBar.index,i.isFirstOfLine=t.isFirstOfStaff,i.realBounds=new Us,i.realBounds.x=l+t.x,i.realBounds.y=a,i.realBounds.w=t.width,i.realBounds.h=h,i.visualBounds=new Us,i.visualBounds.x=l+t.x,i.visualBounds.y=n,i.visualBounds.w=t.width,i.visualBounds.h=r,i.lineAlignedBounds=new Us,i.lineAlignedBounds.x=l+t.x,i.lineAlignedBounds.y=o,i.lineAlignedBounds.w=t.width,i.lineAlignedBounds.h=c,this.layout.renderer.boundsLookup.addMasterBar(i),d.set(i.index,i)),t.buildBoundingsLookup(i,l,e+this.y+s.y)}}getBarX(t){if(0===this.allStaves.length||0===this.layout.renderer.tracks.length)return 0;const e=this.layout.renderer.tracks[0].staves[0].bars[t];return this.layout.getRendererForBar(this.allStaves[0].staffId,e).x}}class Vc{args;renderCallback;constructor(t,e){this.args=t,this.renderCallback=e}}class $c{t_=new Map;pagePadding=null;profile=new Set;renderer;width=0;height=0;multiBarRestInfo=null;get scaledWidth(){return Math.round(this.width/this.renderer.settings.display.scale)}headerGlyphs=new Map;footerGlyphs=new Map;chordDiagrams=null;tuningGlyph=null;constructor(t){this.renderer=t}slurRegistry=new Fc;beamingRuleLookups=new Map;resize(){this.e_.clear(),this.slurRegistry.clear(),this.doResize()}layoutAndRender(t){this.e_.clear(),this.slurRegistry.clear(),this.beamingRuleLookups.clear(),this.t_.clear(),this.profile=Pu.staveProfiles.get(this.renderer.settings.display.staveProfile);const e=this.renderer.score;this.firstBarIndex=zt.computeFirstDisplayedBarIndex(e,this.renderer.settings),this.lastBarIndex=zt.computeLastDisplayedBarIndex(e,this.renderer.settings,this.firstBarIndex),this.multiBarRestInfo=zt.buildMultiBarRestInfo(this.renderer.tracks,this.firstBarIndex,this.lastBarIndex),this.pagePadding=this.renderer.settings.display.padding.map(t=>t/this.renderer.settings.display.scale),this.pagePadding||(this.pagePadding=[0,0,0,0]),1===this.pagePadding.length?this.pagePadding=[this.pagePadding[0],this.pagePadding[0],this.pagePadding[0],this.pagePadding[0]]:2===this.pagePadding.length&&(this.pagePadding=[this.pagePadding[0],this.pagePadding[1],this.pagePadding[0],this.pagePadding[1]]),this.s_(),this.doLayoutAndRender(t)}e_=new Map;registerPartial(t,e){if(0===t.height)return;const s=this.renderer.settings.display.scale;t.x*=s,t.y*=s,t.width*=s,t.height*=s,t.totalWidth*=s,t.totalHeight*=s,this.renderer.settings.core.enableLazyLoading?(this.e_.set(t.id,new Vc(t,e)),this.renderer.partialLayoutFinished.trigger(t)):(this.renderer.partialLayoutFinished.trigger(t),this.i_(t,e))}i_(t,e){const s=this.renderer.canvas;s.beginRender(t.width,t.height),e(s),t.renderResult=s.endRender(),this.renderer.partialRenderFinished.trigger(t)}renderLazyPartial(t){if(this.e_.has(t)){const e=this.e_.get(t);this.i_(e.args,e.renderCallback)}}static headerElements=new X(()=>new Map([[ot.Title,B.ScoreTitle],[ot.SubTitle,B.ScoreSubTitle],[ot.Artist,B.ScoreArtist],[ot.Album,B.ScoreAlbum],[ot.Words,B.ScoreWords],[ot.Music,B.ScoreMusic],[ot.WordsAndMusic,B.ScoreWordsAndMusic],[ot.Transcriber,void 0]]));static footerElements=new X(()=>new Map([[ot.Copyright,B.ScoreCopyright],[ot.CopyrightSecondLine,void 0]]));n_(t,e,s,i){switch(s){case ot.WordsAndMusic:if(e.words!==e.music)return;break;case ot.Words:case ot.Music:if(e.words===e.music)return;break;case ot.CopyrightSecondLine:if(!this.footerGlyphs.has(ot.Copyright))return}const n=t.display.resources,r=t.notation,a=e.style&&e.style.headerAndFooter.has(s)?e.style.headerAndFooter.get(s):Gt.defaultHeaderAndFooter.get(s);let h=void 0===a.isVisible||a.isVisible;if(void 0!==i&&(h=r.isNotationElementVisible(i)),!h)return;const o=a.buildText(e);return o?new Hh(0,0,o,n.getFontForElement(s),a.textAlign,void 0,ao.scoreColor(n,s,e)):void 0}s_(){J.debug("ScoreLayout","Creating score info glyphs");const t=this.renderer.settings,e=this.renderer.score;this.headerGlyphs=new Map,this.footerGlyphs=new Map;const s=new ec(this.renderer,this.renderer.tracks[0].staves[0].bars[0]);for(const[i,n]of $c.headerElements.value){const r=this.n_(t,e,i,n);r&&(r.renderer=s,r.doLayout(),this.headerGlyphs.set(i,r))}for(const[i,n]of $c.footerElements.value){const r=this.n_(t,e,i,n);r&&(r.renderer=s,r.doLayout(),this.footerGlyphs.set(i,r))}const i=t.notation,n=t.display.resources;if(i.isNotationElementVisible(B.GuitarTuning)){const t=[];for(const s of this.renderer.tracks)for(const i of s.staves){let n=!i.isPercussion&&i.isStringed&&i.tuning.length>0&&i.showTablature;if(e.stylesheet.perTrackDisplayTuning&&e.stylesheet.perTrackDisplayTuning.has(s.index)&&!1===e.stylesheet.perTrackDisplayTuning.get(s.index)&&(n=!1),n){t.push(i);break}}if(t.length>0&&e.stylesheet.globalDisplayTuning){this.tuningGlyph=new Cc(0,0),this.tuningGlyph.renderer=s;for(const e of t)if(e.stringTuning.tunings.length>0){const i=t.length>1?e.track.name:"",r=new Ec(0,0,e.stringTuning,i);r.colorOverride=ao.trackColor(n,Lt.StringTuning,e.track),r.renderer=s,r.doLayout(),this.tuningGlyph.addGlyph(r)}}else this.tuningGlyph=null}if(i.isNotationElementVisible(B.ChordDiagrams)){this.chordDiagrams=new Pc(0,0),this.chordDiagrams.renderer=s;const t=new Set;for(const s of this.renderer.tracks){if(e.stylesheet.globalDisplayChordDiagramsOnTop&&(null==e.stylesheet.perTrackChordDiagramsOnTop||!e.stylesheet.perTrackChordDiagramsOnTop.has(s.index)||e.stylesheet.perTrackChordDiagramsOnTop.get(s.index)))for(const e of s.staves){const s=e.chords;if(s)for(const[,e]of s)t.has(e.uniqueId)||e.showDiagram&&(t.add(e.uniqueId),this.chordDiagrams.addChord(e))}}this.chordDiagrams.isEmpty&&(this.chordDiagrams=null)}else this.chordDiagrams=null}firstBarIndex=0;lastBarIndex=0;createEmptyStaffSystem(t){const e=new Hc(this);e.index=t;const s=Pu.defaultRenderers,i=[];for(let t=0;t<this.renderer.tracks.length;t++){const n=this.renderer.tracks[t];for(let r=0;r<n.staves.length;r++){const a=n.staves[r];let h,o=[],c=[];for(const r of s)if(this.profile.has(r.staffId)&&r.canCreate(n,a)){const s=new Ac(e,t,a,r);s.topEffectInfos.splice(0,0,...o),s.bottomEffectInfos.push(...c),h=s,i.push(s),o=[],c=[]}else for(const t of r.effectBands)switch(t.mode){case kh.SharedTop:o.push(t);break;case kh.SharedBottom:c.push(t)}h&&(o.length>0&&h.bottomEffectInfos.push(...o),c.length>0&&h.bottomEffectInfos.push(...c))}}for(const t of i)e.addStaff(t);return e}registerBarRenderer(t,e){if(this.t_.has(t)||this.t_.set(t,new Map),this.t_.get(t).set(e.bar.id,e),e.additionalMultiRestBars)for(const s of e.additionalMultiRestBars)this.t_.get(t).set(s.id,e)}getRendererForBar(t,e){const s=e.id;return this.t_.has(t)&&this.t_.get(t).has(s)?this.t_.get(t).get(s):null}layoutAndRenderBottomScoreInfo(t){t=Math.round(t);const e=new la;e.x=0,e.y=t;let s=0;const i=this.renderer.settings.display.resources,n=[];let r=0;for(const[t,e]of $c.footerElements.value)if(this.footerGlyphs.has(t)){const e=this.footerGlyphs.get(t);e.y=s,this.alignScoreInfoGlyph(e),s+=e.height,n.push(e),r=Math.max(r,Math.round(e.x+e.width))}return s=Math.round(s),n.length>0&&(e.width=r,e.height=s,e.totalWidth=this.scaledWidth,e.totalHeight=t+e.height,this.registerPartial(e,t=>{t.color=i.scoreInfoColor,t.textAlign=at.Left,t.textBaseline=ht.Top;for(const e of n)e.paint(0,0,t)})),t+s}alignScoreInfoGlyph(t){if(Pu.getLayoutEngineFactory(this.renderer.settings.display.layoutMode).vertical)switch(t.textAlign){case at.Left:t.x=this.pagePadding[0];break;case at.Center:t.x=this.scaledWidth/2;break;case at.Right:t.x=this.scaledWidth-this.pagePadding[2]}else t.x=this.firstBarX,t.textAlign=at.Left}layoutAndRenderAnnotation(t){const e=this.renderer.settings.display.resources,s=e.elementFonts.has(B.ScoreCopyright)?e.elementFonts.get(B.ScoreCopyright).families:e.tablatureFont.families,i=Vr.withFamilyList(s,12,rs.Plain,as.Bold),n=new ec(this.renderer,this.renderer.tracks[0].staves[0].bars[0]),r=new Hh(0,0,"rendered by alphaTab",i,at.Center,void 0,e.mainGlyphColor);r.renderer=n,r.doLayout(),this.alignScoreInfoGlyph(r);const a=new la;return a.width=r.x+r.width,a.x=0,a.height=12,a.y=t,a.totalWidth=this.scaledWidth,a.totalHeight=t+12,a.firstMasterBarIndex=-1,a.lastMasterBarIndex=-1,this.registerPartial(a,t=>{t.color=e.mainGlyphColor,t.font=i,t.textAlign=at.Left,t.textBaseline=ht.Top,r.paint(0,0,t)}),t+12}}class Uc{x=0;width=0;masterBars=[];results=[]}class zc extends $c{UB=null;get name(){return"HorizontalScreen"}get supportsResize(){return!1}get firstBarX(){let t=this.pagePadding[0];return this.UB&&(t+=this.UB.accoladeWidth),t}doResize(){}doLayoutAndRender(t){const e=this.renderer.score;let s=this.renderer.settings.display.startBar;s--,s=Math.min(e.masterBars.length-1,Math.max(0,s));let i=s,n=this.renderer.settings.display.barCount;n<=0&&(n=e.masterBars.length),n=s+n-1,n=Math.min(e.masterBars.length-1,Math.max(0,n)),this.UB=this.createEmptyStaffSystem(0),this.UB.isLast=!0,this.UB.x=this.pagePadding[0],this.UB.y=this.pagePadding[1];const r=this.renderer.settings.display.barCountPerPartial,a=[];let h=new Uc;for(;i<=n;){const t=this.multiBarRestInfo,s=null!==t&&t.has(i)?t.get(i):null,n=this.UB.addBars(this.renderer.tracks,i,s);h.masterBars.length>=r&&!n.isLinkedToPrevious&&(h=this.r_(a,h)),this.a_(n),h.results.push(n),h.masterBars.push(e.masterBars[i]),h.width+=n.width,i++}h.masterBars.length>0&&this.r_(a,h),this.h_(),this.height=Math.floor(this.UB.y+this.UB.height),this.width=this.UB.x+this.UB.width+this.pagePadding[2],i=0;let o=0;for(let e=0;e<a.length;e++){const s=a[e],n=new la;n.reuseViewport=t?.reuseViewport??!1,n.x=o,n.y=0,n.totalWidth=this.width,n.totalHeight=this.height,n.width=s.width,n.height=this.height,n.firstMasterBarIndex=s.masterBars[0].index,n.lastMasterBarIndex=s.masterBars[s.masterBars.length-1].index,o+=s.width;const r=i,h=e;this.UB.buildBoundingsLookup(0,0),this.registerPartial(n,t=>{let e=this.UB.getBarX(s.masterBars[0].index)+this.UB.accoladeWidth;0===h&&(e-=this.UB.x+this.UB.accoladeWidth),t.color=this.renderer.settings.display.resources.mainGlyphColor,t.textAlign=at.Left,J.debug(this.name,`Rendering partial from bar ${s.masterBars[0].index} to ${s.masterBars[s.masterBars.length-1].index}`,null),this.UB.paintPartial(-e,this.UB.y,t,r,s.masterBars.length)}),i+=s.masterBars.length}this.height=this.layoutAndRenderBottomScoreInfo(this.height),this.height=this.layoutAndRenderAnnotation(this.height),this.height+=this.pagePadding[3],this.height*=this.renderer.settings.display.scale}a_(t){t.width=0,this.UB.width-=t.width;for(const e of t.renderers){const s=e.staff.system.staves.length>1?e.bar.masterBar.displayWidth:e.bar.displayWidth;s>0&&e.scaleToWidth(s);const i=e.x+e.width;i>t.width&&(t.width=i)}this.UB.width+=t.width}r_(t,e){0===t.length&&(e.width+=this.UB.accoladeWidth+this.pagePadding[0]),t.push(e),J.debug(this.name,`Finished partial from bar ${e.masterBars[0].index} to ${e.masterBars[e.masterBars.length-1].index}`,null);const s=new Uc;return s.x=e.x+e.width,s}h_(){this.o_(),this.UB.finalizeSystem()}o_(){this.width=0;const t=this.UB;for(const e of t.allStaves){e.resetSharedLayoutData();let s=0;for(const t of e.barRenderers)t.x=s,t.y=e.topPadding+e.topOverflow,t.scaleToWidth(t.width),s+=t.width;s>this.width&&(t.width=s)}t.width+=t.accoladeWidth}}class Xc extends $c{c_=[];l_=[];u_=[];d_=!1;doLayoutAndRender(t){let e=this.pagePadding[1];this.width=this.renderer.width,this.l_=[],this.d_=t?.reuseViewport??!1,e=this.f_(e,-1),e=this.p_(e,-1),e=this.b_(e,-1),e=this.m_(e),e=this.layoutAndRenderBottomScoreInfo(e),e=this.layoutAndRenderAnnotation(e),this.height=(e+this.pagePadding[3])*this.renderer.settings.display.scale}registerPartial(t,e){t.reuseViewport=this.d_,super.registerPartial(t,e)}get supportsResize(){return!0}get firstBarX(){let t=this.pagePadding[0];return this.c_.length>0&&(t+=this.c_[0].accoladeWidth),t}doResize(){let t=this.pagePadding[1];this.width=this.renderer.width;const e=this.height;this.d_=!0,t=this.f_(t,e),t=this.p_(t,e),t=this.b_(t,e),t=this.g_(t,e),t=this.layoutAndRenderBottomScoreInfo(t),t=this.layoutAndRenderAnnotation(t),this.height=(t+this.pagePadding[3])*this.renderer.settings.display.scale}p_(t,e=-1){if(!this.tuningGlyph)return t;const s=this.renderer.settings.display.resources;this.tuningGlyph.x=this.pagePadding[0],this.tuningGlyph.width=this.scaledWidth-this.pagePadding[0]-this.pagePadding[2],this.tuningGlyph.doLayout();const i=Math.round(this.tuningGlyph.height),n=new la;return n.x=0,n.y=t,n.width=this.scaledWidth,n.height=i,n.totalWidth=this.scaledWidth,n.totalHeight=e<0?t+n.height:e,this.registerPartial(n,t=>{t.color=s.scoreInfoColor,t.textAlign=at.Center,this.tuningGlyph.paint(0,0,t)}),t+i}b_(t,e=-1){if(!this.chordDiagrams)return t;const s=this.renderer.settings.display.resources;this.chordDiagrams.x=this.pagePadding[0],this.chordDiagrams.width=this.scaledWidth-this.pagePadding[0]-this.pagePadding[2],this.chordDiagrams.doLayout();const i=Math.round(this.chordDiagrams.height),n=new la;return n.x=0,n.y=t,n.width=this.scaledWidth,n.height=i,n.totalWidth=this.scaledWidth,n.totalHeight=e<0?t+i:e,this.registerPartial(n,t=>{t.color=s.scoreInfoColor,t.textAlign=at.Center,this.chordDiagrams.paint(0,0,t)}),t+i}f_(t,e=-1){J.debug(this.name,"Layouting score info");const s=new la;s.x=0,s.y=t;let i=0;const n=this.renderer.settings.display.resources,r=[];for(const[t,e]of $c.headerElements.value)if(this.headerGlyphs.has(t)){const e=this.headerGlyphs.get(t);e.y=i,this.alignScoreInfoGlyph(e);let s=e.font.size;if(t===ot.Words&&this.headerGlyphs.has(ot.Music)){this.headerGlyphs.get(ot.Music).textAlign!==e.textAlign&&(s=0)}i+=s,r.push(e)}return r.length>0&&(i=Math.floor(i+17),s.width=this.scaledWidth,s.height=i,s.totalWidth=this.scaledWidth,s.totalHeight=e<0?t+s.height:e,this.registerPartial(s,t=>{t.color=n.scoreInfoColor,t.textAlign=at.Center;for(const e of r)e.paint(0,0,t)})),t+i}g_(t,e){if(this.getBarsPerSystem(0)>0)for(let s=0;s<this.c_.length;s++){const i=this.c_[s];i.width=i.computedWidth,this.w_(i),t+=this.y_(i,e)}else{for(const t of this.l_)for(const e of t.renderers)e.afterReverted();this.c_=[];let s=0;const i=this.k_;let n=this.createEmptyStaffSystem(this.c_.length);for(n.x=this.pagePadding[0],n.y=t;s<this.l_.length;){let r=this.l_[s];if(n.width+r.width<=i||0===n.masterBarsRenderers.length)n.addMasterBarRenderers(this.renderer.tracks,r),s++,this.S_(s)&&(n.isFull=!0);else{for(;r&&!r.canWrap&&n.masterBarsRenderers.length>1;)r=n.revertLastBar(),s--;n.isFull=!0}n.isFull&&(n.isLast=this.lastBarIndex===n.lastBarIndex,this.c_.push(n),this.w_(n),t+=this.y_(n,e),n=this.createEmptyStaffSystem(this.c_.length),n.x=this.pagePadding[0],n.y=t)}n.isLast=this.lastBarIndex===n.lastBarIndex,this.w_(n),t+=this.y_(n,e)}return t}m_(t){let e=this.firstBarIndex;const s=this.lastBarIndex;for(this.c_=[];e<=s;){const i=this.B_(e,s);this.c_.push(i),i.x=this.pagePadding[0],i.y=t,e=i.lastBarIndex+1,this.w_(i),J.debug(this.name,`Rendering partial from bar ${i.firstBarIndex} to ${i.lastBarIndex}`,null),t+=this.y_(i,t)}return t}y_(t,e){const s=Math.floor(t.height),i=new la;return i.x=0,i.y=t.y,i.totalWidth=this.scaledWidth,i.totalHeight=e,i.width=this.scaledWidth,i.height=s,i.firstMasterBarIndex=t.firstBarIndex,i.lastMasterBarIndex=t.lastBarIndex,t.buildBoundingsLookup(0,0),this.registerPartial(i,e=>{this.renderer.canvas.color=this.renderer.settings.display.resources.mainGlyphColor,this.renderer.canvas.textAlign=at.Left,t.paint(0,-i.y/this.renderer.settings.display.scale,e)}),s}w_(t){t.isFull||t.width>this.k_||this.renderer.settings.display.justifyLastSystem?this.__(t,this.k_):this.__(t,t.width),t.finalizeSystem()}__(t,e){const s=e-t.accoladeWidth,i=this.shouldApplyBarScale,n=t.totalBarDisplayScale,r=(e-t.computedWidth)/t.masterBarsRenderers.length;for(const e of t.allStaves){e.resetSharedLayoutData();let a=0;for(const h of e.barRenderers){let o;if(h.x=a,h.y=e.topPadding+e.topOverflow,i){o=t.getBarDisplayScale(h)*s/n}else o=h.computedWidth+r;h.scaleToWidth(o),a+=h.width}}t.width=e}B_(t,e){const s=this.createEmptyStaffSystem(this.c_.length),i=this.getBarsPerSystem(s.index),n=this.k_,r=e+1;let a=t;for(;a<r;){if(this.u_.length>0)for(const t of this.u_)s.addMasterBarRenderers(this.renderer.tracks,t),a=t.lastMasterBarIndex;else{const t=this.multiBarRestInfo,e=null!==t&&t.has(a)?t.get(a):null,i=s.addBars(this.renderer.tracks,a,e);this.l_.push(i),a=i.lastMasterBarIndex}this.u_=[];let t=!1;if((-1===i&&s.width>=n&&0!==s.masterBarsRenderers.length||s.masterBarsRenderers.length===i+1)&&(t=!0),t){let t=s.revertLastBar();if(t)for(this.u_.push(t);t&&!t.canWrap&&s.masterBarsRenderers.length>1;)t=s.revertLastBar(),t&&this.u_.push(t);return s.isFull=!0,s.isLast=!1,this.u_.reverse(),s}if(this.S_(a))return s.isFull=!0,s.isLast=!1,s;s.x=0,a++}return s.isLast=e===s.lastBarIndex,s}S_(t){let e=!1,s=!0;for(const i of this.renderer.tracks)i.lineBreaks&&i.lineBreaks.has(t+1)?e=!0:s=!1;return e&&s}get k_(){return this.scaledWidth-this.pagePadding[0]-this.pagePadding[2]}}class jc extends Xc{get name(){return"PageView"}getBarsPerSystem(t){let e=this.renderer.settings.display.barsPerRow;return this.renderer.settings.display.systemsLayoutMode===os.UseModelLayout&&(e=zt.getSystemLayout(this.renderer.score,t,this.renderer.tracks)),e}get shouldApplyBarScale(){return this.renderer.settings.display.systemsLayoutMode===os.UseModelLayout}}class Jc extends Xc{get name(){return"Parchment"}getBarsPerSystem(t){return zt.getSystemLayout(this.renderer.score,t,this.renderer.tracks)}get shouldApplyBarScale(){return!0}}class qc extends Oa{doLayout(){this.width=this.renderer.smuflMetrics.thinBarlineThickness}paint(t,e,s){this.paintExtended(t,e,s,this.height)}}class Yc extends qc{T_;constructor(t,e,s){super(t,e),this.T_=s}doLayout(){this.width=this.T_?this.renderer.smuflMetrics.repeatEndingLineThickness:this.renderer.smuflMetrics.thinBarlineThickness}paintExtended(t,e,s,i){s.fillRect(t+this.x,e+this.y,this.renderer.smuflMetrics.thinBarlineThickness,i)}}class Kc extends qc{paintExtended(t,e,s,i){const n=this.renderer.smuflMetrics.thinBarlineThickness/2,r=this.renderer.getLineHeight(1);let a=e+this.y+.5*r+n;const h=e+this.y+i;for(;a<h;)s.fillCircle(t+this.x,a,n),a+=r}}class Qc extends qc{paintExtended(t,e,s,i){const n=this.renderer.smuflMetrics.dashedBarlineDashLength,r=t+this.x-this.width/2,a=Math.ceil(i/2/n),h=e+this.y+i,o=this.renderer.smuflMetrics.dashedBarlineGapLength,c=s.lineWidth;if(s.lineWidth=this.renderer.smuflMetrics.dashedBarlineThickness,s.beginPath(),a<1)s.moveTo(r,e+this.y),s.lineTo(r,h);else{let t=e+this.y;for(;t<h;){s.moveTo(r,t);const e=Math.min(h-t,n);s.lineTo(r,t+e),t+=n+o}}s.stroke(),s.lineWidth=c}}class Zc extends qc{doLayout(){this.width=this.renderer.smuflMetrics.thickBarlineThickness}paintExtended(t,e,s,i){s.fillRect(t+this.x,e+this.y,this.width,i)}}class tl extends qc{doLayout(){this.width=this.renderer.smuflMetrics.glyphWidths.get(lt.RepeatDot)}paintExtended(t,e,s,i){const n=this.renderer,r=n.heightLineCount%2==0?1:.5,a=e+this.y+this.height/2,h=n.getLineHeight(r),o=n.smuflMetrics.glyphTop.get(lt.RepeatDot)-n.smuflMetrics.glyphHeights.get(lt.RepeatDot)/2;Rt.fillMusicFontSymbolSafe(s,t+this.x,a+o-h,1,lt.RepeatDot),Rt.fillMusicFontSymbolSafe(s,t+this.x,a+o+h,1,lt.RepeatDot)}}class el extends qc{paintExtended(t,e,s,i){const n=this.renderer;if(n.drawnLineCount-1<=2)return;const r=n.smuflMetrics.staffLineThickness/2,a=(n.drawnLineCount-1)/2,h=n.getLineY(a-1)-r,o=n.getLineY(a+1)+r;s.fillRect(t+this.x,e+h,n.smuflMetrics.thinBarlineThickness,o-h)}}class sl extends qc{paintExtended(t,e,s,i){const n=this.renderer.getLineHeight(1),r=-n/2+1;s.fillRect(t+this.x,e+this.y+r,1,n)}}class il extends Go{x_;M_;constructor(t,e){super(),this.x_=t,this.M_=e}doLayout(){const t=this.renderer.bar,e=t.masterBar,s=this.x_?t.getActualBarLineRight():t.getActualBarLineLeft(0===this.renderer.index),i=this.x_&&e.isRepeatEnd||!this.x_&&e.isRepeatStart;let n=E.Automatic;if(!this.x_){const t=this.renderer.previousRenderer;if(t&&t.staff===this.renderer.staff&&(n=t.bar.getActualBarLineRight(),s===n))return}switch(this.x_&&e.isRepeatEnd&&(this.addGlyph(new tl(0,0)),this.width+=this.renderer.smuflMetrics.repeatBarlineDotSeparation),s){case E.Dashed:this.addGlyph(new Qc(0,0));break;case E.Dotted:this.addGlyph(new Kc(0,0));break;case E.Heavy:n!==E.LightHeavy&&n!==E.HeavyHeavy&&this.addGlyph(new Zc(0,0));break;case E.HeavyHeavy:n!==E.LightHeavy&&n!==E.Heavy&&this.addGlyph(new Zc(0,0)),this.width+=this.renderer.smuflMetrics.barlineSeparation,this.addGlyph(new Zc(0,0));break;case E.HeavyLight:n!==E.LightHeavy&&n!==E.Heavy&&n!==E.HeavyHeavy&&this.addGlyph(new Zc(0,0)),this.width+=this.renderer.smuflMetrics.thinThickBarlineSeparation,this.addGlyph(new Yc(0,0,i));break;case E.LightHeavy:n!==E.HeavyLight&&n!==E.Regular&&n!==E.LightLight&&this.addGlyph(new Yc(0,0,i)),this.width+=this.renderer.smuflMetrics.thinThickBarlineSeparation,this.addGlyph(new Zc(0,0));break;case E.LightLight:n!==E.HeavyLight&&n!==E.Regular&&this.addGlyph(new Yc(0,0,i)),this.width+=this.renderer.smuflMetrics.barlineSeparation,this.addGlyph(new Yc(0,0,i));break;case E.None:break;case E.Regular:n!==E.HeavyLight&&n!==E.LightLight&&this.addGlyph(new Yc(0,0,i));break;case E.Short:this.addGlyph(new el(0,0));break;case E.Tick:this.addGlyph(new sl(0,0))}this.x_||e.isRepeatStart&&(this.width+=this.renderer.smuflMetrics.repeatBarlineDotSeparation,this.addGlyph(new tl(0,0)));const r=this.renderer,a=r.smuflMetrics.staffLineThickness;let h=this.y,o=this.y;r.drawnLineCount<2||!this.x_&&r.isFirstOfStaff||this.x_&&r.isLastOfStaff?(h-=a,o+=r.height):(h+=r.getLineY(0)-a/2,o+=r.getLineY(r.drawnLineCount-1)+a/2);const c=o-h;let l=0;if(this.M_&&this.x_){const t=Math.ceil(this.width);l=t-this.width,this.width=t}for(const t of this.glyphs)t.y=h,t.x+=l,t.height=c}paint(t,e,s){const i=this.glyphs;if(!i)return;const n=this.renderer,r=ao.bar(s,n.barLineBarSubElement,this.renderer.bar,!0);try{let r=this.height;const a=n.staff,h=a.system.allStaves;let o=!1;if(this.M_&&a.index<h.length-1){const t=h[a.index+1],e=a.y+n.y;r=t.y+t.topOverflow+n.smuflMetrics.staffLineThickness-e,o=!0}for(const n of i)o?n.paintExtended(t,e,s,r):n.paint(t,e,s)}finally{r?.[Symbol.dispose]?.()}}}class nl extends Oa{v_;constructor(t,e,s){super(t,e),this.v_=`${s}  `}doLayout(){this.renderer.scoreRenderer.canvas.font=this.renderer.resources.elementFonts.get(B.BarNumber);const t=this.renderer.scoreRenderer.canvas.measureText(this.v_);this.width=t.width,this.height=t.height,this.y-=this.height}paint(t,e,s){if(!this.renderer.staff.isFirstInSystem)return;const i=ao.bar(s,this.renderer.barNumberBarSubElement,this.renderer.bar,!0);try{const i=this.renderer.resources,n=s.textBaseline;s.font=i.elementFonts.get(B.BarNumber),s.textBaseline=ht.Top,s.fillText(this.v_,t+this.x,e+this.y),s.textBaseline=n}finally{i?.[Symbol.dispose]?.()}}}class rl extends $o{shouldDrawBendSlur(){return this.renderer.settings.notation.extendBendArrowsOnTiedNotes&&!!this.startNote.bendOrigin&&this.startNote.isTieOrigin}calculateTieDirection(){return Wt.Up}}class al{x=0;y=-3e3;width=0}class hl extends ro{constructor(){super(0,0)}doLayout(){if(!this.glyphs||0===this.glyphs.length)return void(this.width=0);this.glyphs.sort((t,e)=>t.y<e.y?-1:t.y>e.y?1:0);const t=[];t.push(new al);for(let e=0,s=this.glyphs.length;e<s;e++){const s=this.glyphs[e];s.renderer=this.renderer,s.doLayout();let i=0;for(;t[i].y>s.y;)i++,i===t.length&&t.push(new al);s.x=i,t[i].y=s.y+s.height,t[i].width<s.width&&(t[i].width=s.width)}this.width=0;const e=this.renderer.smuflMetrics.accidentalPadding;for(const s of t)this.width+=s.width+e,s.x=this.width;for(let e=0,s=this.glyphs.length;e<s;e++){const s=this.glyphs[e],i=t[s.x];s.x=this.width-i.x}}}class ol extends Kh{constructor(t,e){super(t,e,1,lt.AugmentationDot)}doLayout(){super.doLayout(),this.offsetX=this.width/2,this.width*=1.5}}class cl extends ro{Uk=[];N_=[];container;computedWidth=0;constructor(){super(0,0)}doLayout(){let t=0;if(this.glyphs)for(let e=0,s=this.glyphs.length;e<s;e++){const s=this.glyphs[e];s.x=t,s.renderer=this.renderer,s.doLayout(),t+=s.width}this.width=t,this.computedWidth=t}noteLoop(t){for(let e=this.container.beat.notes.length-1;e>=0;e--)t(this.container.beat.notes[e])}addEffect(t){super.addGlyph(t),this.Uk.push(t)}addNormal(t){super.addGlyph(t),this.N_.push(t)}get effectElement(){}paint(t,e,s){this.P_(t,e,s),this.C_(t,e,s)}C_(t,e,s){for(const i of this.N_)i.paint(t+this.x,e+this.y,s)}P_(t,e,s){const i=this.effectElement?ao.beat(s,this.effectElement,this.container.beat):void 0;try{for(const i of this.Uk)i.paint(t+this.x,e+this.y,s)}finally{i?.[Symbol.dispose]?.()}}}class ll extends cl{onTimeX=0;middleX=0;stemX=0}class ul extends Oa{E_=0;constructor(){super(0,0)}getBoundingBoxTop(){return this.E_}getBoundingBoxBottom(){return this.E_+this.height}doLayout(){this.width=this.renderer.smuflMetrics.glyphWidths.get(lt.NoteheadSlashWhiteHalf);const t=this.renderer,e=t.getLineHeight(t.heightLineCount-1),s=t.getLineY(0)+(t.drawnLineCount>0?t.getLineHeight(t.drawnLineCount-1):0)/2-e/2;this.height=e,this.E_=s}paint(t,e,s){const i=this.height,n=this.E_,r=s.lineWidth;s.lineWidth=this.renderer.smuflMetrics.deadSlappedLineWidth,s.moveTo(t+this.x,e+n),s.lineTo(t+this.x+this.width,e+n+i),s.moveTo(t+this.x,e+n+i),s.lineTo(t+this.x+this.width,e+n),s.stroke(),s.lineWidth=r}}class dl extends Oa{F_;Ge;v_;A_;D_=0;L_=0;constructor(t,e,s,i,n,r){super(t,e),this.F_=i,this.v_=s,this.Ge=n,this.A_=r}getBoundingBoxTop(){let t=-this.height/2;return this.A_>0&&this.D_<t&&(t=this.D_),this.y+t}getBoundingBoxBottom(){let t=this.height/2;const e=this.D_+Math.abs(this.A_)*this.L_*2;return this.A_<0&&t<e&&(t=e),this.y+t}paint(t,e,s){const i=this.Ge.isRest?ao.beat(s,Bt.NumberedRests,this.Ge):this.Ge.notes.length>0?ao.note(s,ft.NumberedNumber,this.Ge.notes[0]):void 0;try{const i=this.renderer.resources;s.font=this.F_?i.numberedNotationGraceFont:i.numberedNotationFont;const n=s.textBaseline;s.textBaseline=ht.Middle,s.textAlign=at.Left,s.fillText(this.v_.toString(),t+this.x,e+this.y),s.textBaseline=n;const r=Math.abs(this.A_);let a=this.D_+i.engravingSettings.glyphTop.get(lt.AugmentationDot);for(let i=0;i<r;i++)Rt.fillMusicFontSymbolSafe(s,t+this.x+this.width/2,e+this.y+a,1,lt.AugmentationDot,!0),a+=2*this.L_}finally{i?.[Symbol.dispose]?.()}}doLayout(){const t=this.renderer.resources,e=this.F_?t.numberedNotationGraceFont:t.numberedNotationFont,s=this.renderer.scoreRenderer.canvas;s.font=e;const i=s.measureText(`${this.v_}`);this.height=i.height,this.width=i.width;const n=this.A_,r=t.engravingSettings.glyphHeights.get(lt.AugmentationDot),a=Math.abs(n)*r*2;n>0?this.D_=-this.height/2-a-t.engravingSettings.glyphTop.get(lt.AugmentationDot):n<0&&(this.D_=this.height/2+r+t.engravingSettings.glyphTop.get(lt.AugmentationDot)),this.L_=r}}class fl extends Oa{constructor(t,e,s){super(t,e),this.width=s}getBoundingBoxTop(){return Number.NaN}getBoundingBoxBottom(){return Number.NaN}}class pl extends cl{accidental=T.None;skipLayout=!1;get effectElement(){return Bt.NumberedEffects}doLayout(){if(!this.skipLayout){if(!this.container.beat.isRest&&!this.container.beat.isEmpty){const t=new hl;if(t.renderer=this.renderer,this.container.beat.notes.length>0){const e=this.container.beat.notes[0],s=zt.resolveSpelling(this.renderer.bar.keySignature,e.displayValue,e.accidentalMode),i=zt.getKeySignatureAccidentalOffset(this.renderer.bar.keySignature,s.degree),n=s.accidentalOffset-i;let r=T.None;if(e.accidentalMode!==p.ForceNone&&(e.hasQuarterToneOffset?r=n>0?T.SharpQuarterNoteUp:n<0?T.FlatQuarterNoteUp:T.NaturalQuarterNoteUp:0!==n&&(r=zt.accidentalOffsetToType(n))),r!==T.None){this.accidental=r;const s=this.renderer,i=ao.noteColor(s.resources,ft.NumberedAccidentals,e),n=new xo(0,s.getLineY(0),r,e.beat.graceType!==l.None?Rr.GraceScale*Rr.GraceScale:Rr.GraceScale);n.colorOverride=i,n.renderer=this.renderer,t.addGlyph(n),this.addNormal(t),this.addNormal(new fl(0,0,this.renderer.smuflMetrics.preNoteEffectPadding))}}}super.doLayout()}}}class bl extends ll{noteHeads=null;deadSlapped=null;get effectElement(){return Bt.NumberedEffects}getNoteX(t,e){let s=null;if(this.noteHeads?s=this.noteHeads:this.deadSlapped&&(s=this.deadSlapped),s){let t=s.x;switch(e){case _h.Left:break;case _h.Center:t+=s.width/2;break;case _h.Right:t+=s.width}return t}return 0}buildBoundingsLookup(t,e,s){if(this.noteHeads&&this.container.beat.notes.length>0){const i=new pa;i.note=this.container.beat.notes[0],i.noteHeadBounds=new Us,i.noteHeadBounds.x=e+this.x+this.noteHeads.x,i.noteHeadBounds.y=s+this.y+this.noteHeads.y-this.noteHeads.height/2,i.noteHeadBounds.w=this.width,i.noteHeadBounds.h=this.height,t.addNote(i)}}getLowestNoteY(t){return this.W_(t)}getHighestNoteY(t){return this.W_(t)}getNoteY(t,e){return this.W_(e)}getRestY(t){return this.W_(t)}W_(t){let e=null;if(this.noteHeads?e=this.noteHeads:this.deadSlapped&&(e=this.deadSlapped),e){let s=this.y+e.y;switch(t){case Bh.Top:case Bh.TopWithStem:s-=e.height/2;break;case Bh.Center:break;case Bh.Bottom:case Bh.BottomWithStem:s+=e.height/2;case Bh.StemUp:case Bh.StemDown:}return s}return 0}static O_=[59,66,61,68,63,70,65,60,67,62,69,64,71,66,61];static R_=[68,63,70,65,60,67,62,69,64,71,66,61,68,63,70];doLayout(){const t=this.renderer;t.shortestDuration<this.container.beat.duration&&(t.shortestDuration=this.container.beat.duration);let e=0;if(!this.container.beat.isEmpty){const s=t.getLineY(0);let i="0";if(this.container.beat.notes.length>0){const t=this.container.beat.notes[0];if(t.isDead)i="X";else{const s=this.renderer.bar.keySignature,n=this.renderer.bar.keySignatureType,r=s+7,a=(n===N.Minor?bl.R_:bl.O_)[r],h=zt.resolveSpelling(s,t.displayValue,t.accidentalMode),o=zt.getKeySignatureTonicDegree(s,n),c=n===N.Minor?(o+2)%7:o;i=((h.degree-c+7)%7+1).toString();const l=t.displayValue-a;e=Math.floor(l/12)}}if(this.container.beat.deadSlapped){const t=new ul;t.renderer=this.renderer,t.doLayout(),this.deadSlapped=t,this.addEffect(t)}else{const t=this.container.beat.graceType!==l.None,n=new dl(0,s,i,t,this.container.beat,e);this.noteHeads=n,this.addNormal(n)}if(this.container.beat.dots>0&&this.container.beat.duration>=c.Quarter)for(let t=0;t<this.container.beat.dots;t++){const t=new ol(0,s);t.renderer=this.renderer,this.addEffect(t)}}super.doLayout(),this.container.beat.isEmpty?this.onTimeX=this.width/2:this.noteHeads?this.onTimeX=this.noteHeads.x+this.noteHeads.width/2:this.deadSlapped&&(this.onTimeX=this.deadSlapped.x+this.deadSlapped.width/2),this.middleX=this.onTimeX,this.stemX=this.middleX}}class ml extends $o{calculateTieDirection(){return this.isLeftHandTap?Wt.Up:ml.getBeamDirectionForNote(this.startNote)}static getBeamDirectionForNote(t){return t.string>3?Wt.Up:Wt.Down}}class gl extends ml{I_;constructor(t,e,s,i,n){super(t,e,s,n),this.I_=i}getTieHeight(t,e,s,i){return Math.log(s-t+1)*this.renderer.settings.notation.slurHeight/2}tryExpand(t,e,s,i){if(this.I_!==s)return!1;if(this.startNote.beat.id!==t.beat.id)return!1;if(this.endNote.beat.id!==e.beat.id)return!1;if(this.renderer===this.lookupEndBeatRenderer()!==i)return!1;if(this.tieDirection!==ml.getBeamDirectionForNote(t))return!1;switch(this.tieDirection){case Wt.Up:t.realValue>this.startNote.realValue&&(this.startNote=t),e.realValue>this.endNote.realValue&&(this.endNote=e);break;case Wt.Down:t.realValue<this.startNote.realValue&&(this.startNote=t),e.realValue<this.endNote.realValue&&(this.endNote=e)}return!0}}class wl extends gl{calculateTieDirection(){return Wt.Up}}class yl extends Ia{zn=new Map;G_=[];H_;hasAdditionalNumbers=!1;*iterateAdditionalNumbers(){const t=this.H_;if(t)for(const e of t)e instanceof kl&&(yield e)}constructor(t){super(t),this.preNotes=new pl,this.onNotes=new bl}addDash(t){let e=this.H_;e||(e=[],this.H_=e),e.push(t)}addNotes(t){let e=this.H_;e||(e=[],this.H_=e),e.push(t),this.hasAdditionalNumbers=!0}doLayout(){this.zn.clear(),this.G_=[],super.doLayout()}buildBoundingsLookup(t,e,s){super.buildBoundingsLookup(t,e,s);const i=this.H_;if(i){const e=t.beats[t.beats.length-1],s=i[i.length-1],n=s.x+s.contentWidth;e.visualBounds.w=n-e.visualBounds.x;const r=s.x+s.width;e.realBounds.w=r-e.realBounds.x}}createTies(t){if(t.isVisible){if(t.isTieOrigin&&t.tieDestination.isVisible&&!this.zn.has("numbered.tie")){const e=new rl(`numbered.tie.${t.beat.id}`,t,t.tieDestination,!1);this.addTie(e),this.zn.set(e.slurEffectId,e)}if(t.isTieDestination){const e=new rl(`numbered.tie.${t.tieOrigin.beat.id}`,t.tieOrigin,t,!0);this.addTie(e)}if(t.isLeftHandTapped&&!t.isHammerPullDestination&&!this.zn.has(`numbered.tie.leftHandTap.${t.beat.id}`)){const e=new rl(`numbered.tie.leftHandTap.${t.beat.id}`,t,t,!1);this.addTie(e),this.zn.set(e.slurEffectId,e)}if(t.isEffectSlurOrigin&&t.effectSlurDestination){let e=!1;for(const s of this.G_)if(s.tryExpand(t,t.effectSlurDestination,!1,!1)){e=!0;break}if(!e){const e=new wl("numbered.slur.effect",t,t.effectSlurDestination,!1,!1);this.G_.push(e),this.addTie(e),this.zn.set(e.slurEffectId,e),this.zn.set("numbered.slur.effect",e)}}if(t.isEffectSlurDestination&&t.effectSlurOrigin){let e=!1;for(const s of this.G_)if(s.tryExpand(t.effectSlurOrigin,t,!1,!0)){e=!0;break}if(!e){const e=new wl("numbered.slur.effect",t.effectSlurOrigin,t,!1,!0);this.G_.push(e),this.addTie(e),this.zn.set(e.slurEffectId,e),this.zn.set("numbered.slur.effect",e)}}}}}class kl extends yl{V_;U_;constructor(t,e,s){super(t),this.V_=e,this.U_=s,this.preNotes.skipLayout=!0,this.barCount=kl.z_(s)}static z_(t){return t>=H.toTicks(c.Eighth)?1:t>=H.toTicks(c.Sixteenth)?2:t>=H.toTicks(c.ThirtySecond)?3:t>=H.toTicks(c.SixtyFourth)?4:t>=H.toTicks(c.OneHundredTwentyEighth)?5:t>=H.toTicks(c.TwoHundredFiftySixth)?6:0}barCount;get beatId(){return-1}get contentWidth(){return this.onNotes.width}get absoluteDisplayStart(){return this.V_}get displayDuration(){return this.U_}get graceType(){return l.None}get graceIndex(){return 0}get graceGroup(){return null}get isFirstOfTupletGroup(){return!1}get tupletGroup(){return null}get isLastOfVoice(){return!1}buildBoundingsLookup(t,e,s){}}class Sl extends Ra{V_;X_;constructor(t,e){super(0,0),this.V_=e,this.X_=t}get beatId(){return-1}get contentWidth(){return this.renderer.smuflMetrics.numberedDashGlyphWidth}get absoluteDisplayStart(){return this.V_}get displayDuration(){return H.QuarterTime}get onTimeX(){return this.renderer.smuflMetrics.numberedDashGlyphWidth/2}get graceType(){return l.None}get graceIndex(){return 0}get graceGroup(){return null}get voiceIndex(){return this.X_}get isFirstOfTupletGroup(){return!1}get tupletGroup(){return null}get isLastOfVoice(){return!1}getLowestNoteY(t){return 0}getHighestNoteY(t){return 0}getNoteY(t,e){return 0}doMultiVoiceLayout(){}getRestY(t){return 0}getNoteX(t,e){return 0}getBeatX(t,e){return 0}registerLayoutingInfo(t){const e=this.renderer.smuflMetrics.numberedDashGlyphWidth;t.addBeatSpring(this,e/2,e/2)}applyLayoutingInfo(t){}buildBoundingsLookup(t,e,s){}paint(t,e,s){const i=this.renderer,n=i.smuflMetrics.numberedDashGlyphWidth,r=i.smuflMetrics.numberedBarRendererBarSize,a=Math.ceil(e+i.getLineY(0)-r);s.fillRect(t+this.x,a,n,r)}}class Bl extends Oa{j_;colorOverride;constructor(t){super(0,0),this.j_=t}doLayout(){super.doLayout(),this.width=this.renderer.smuflMetrics.ghostParenthesisWidth+this.renderer.smuflMetrics.ghostParenthesisPadding}paint(t,e,s){const i=s.color;this.colorOverride&&(s.color=this.colorOverride),this.j_?Vo.paintTie(s,1,t+this.x+this.renderer.smuflMetrics.ghostParenthesisWidth,e+this.y+this.height,t+this.x+this.renderer.smuflMetrics.ghostParenthesisWidth,e+this.y,!1,this.renderer.smuflMetrics.ghostParenthesisWidth/2,this.renderer.smuflMetrics.tieMidpointThickness):Vo.paintTie(s,1,t+this.x+this.renderer.smuflMetrics.ghostParenthesisPadding,e+this.y,t+this.x+this.renderer.smuflMetrics.ghostParenthesisPadding,e+this.y+this.height,!1,this.renderer.smuflMetrics.ghostParenthesisWidth/2,this.renderer.smuflMetrics.tieMidpointThickness),s.color=i}}class _l extends ro{J_=0;q_=0;Y_;K_;barSubElement=C.StandardNotationTimeSignature;constructor(t,e,s,i,n,r){super(t,e),this.J_=s,this.q_=i,this.Y_=n,this.K_=r}paint(t,e,s){const i=ao.bar(s,this.barSubElement,this.renderer.bar);try{super.paint(t,e,s)}finally{i?.[Symbol.dispose]?.()}}doLayout(){if(this.Y_&&2===this.J_&&2===this.q_){const t=new Kh(0,0,this.commonScale,lt.TimeSigCutCommon);this.addGlyph(t),super.doLayout()}else if(this.Y_&&4===this.J_&&4===this.q_){const t=new Kh(0,0,this.commonScale,lt.TimeSigCommon);this.addGlyph(t),super.doLayout()}else{const t=new zo(0,0,this.J_,ht.Top,this.numberScale),e=new zo(0,0,this.q_,ht.Bottom,this.numberScale);this.addGlyph(t),this.addGlyph(e),super.doLayout();const s=this.width;t.x=(s-t.width)/2,e.x=(s-e.width)/2,this.width=Math.max(t.x+t.width,e.x+e.width)}if(this.K_){const t=2*this.renderer.smuflMetrics.oneStaffSpace,e=new Bl(!0);e.renderer=this.renderer,e.y=-t,e.height=2*t,e.doLayout();for(const t of this.glyphs)t.x+=e.width;this.width+=e.width,this.addGlyph(e);const s=new Bl(!1);s.renderer=this.renderer,s.x=this.width,s.y=-t,s.height=2*t,s.doLayout(),this.addGlyph(s),this.width+=s.width}}}class Tl extends _l{get commonScale(){return 1}get numberScale(){return 1}}class xl extends Kh{constructor(t,e,s,i,n){super(t,e,n?Rr.GraceScale:1,xl.getSymbol(s,i,n))}paint(t,e,s){const i=s.color;super.paint(t,e,s),s.color=i}static getSymbol(t,e,s){if(s&&(t=c.Eighth),e===Wt.Up)switch(t){case c.Eighth:return lt.Flag8thUp;case c.Sixteenth:return lt.Flag16thUp;case c.ThirtySecond:return lt.Flag32ndUp;case c.SixtyFourth:return lt.Flag64thUp;case c.OneHundredTwentyEighth:return lt.Flag128thUp;case c.TwoHundredFiftySixth:return lt.Flag256thUp;default:return lt.Flag8thUp}switch(t){case c.Eighth:return lt.Flag8thDown;case c.Sixteenth:return lt.Flag16thDown;case c.ThirtySecond:return lt.Flag32ndDown;case c.SixtyFourth:return lt.Flag64thDown;case c.OneHundredTwentyEighth:case c.TwoHundredFiftySixth:return lt.Flag128thDown;default:return lt.Flag8thDown}}}class Ml extends Oa{Q_=0;constructor(t,e,s){super(t,e),this.Q_=0,this.Q_=s}doLayout(){this.renderer.scoreRenderer.canvas.font=this.renderer.resources.elementFonts.get(B.RepeatCount);const t=this.renderer.scoreRenderer.canvas.measureText(`x${this.Q_}`);this.width=0,this.height=t.height,this.y-=t.height}paint(t,e,s){const i=ao.bar(s,this.renderer.repeatsBarSubElement,this.renderer.bar);try{const i=this.renderer.resources,n=s.textAlign;s.font=i.elementFonts.get(B.RepeatCount),s.textAlign=at.Right;const r=`x${this.Q_}`,a=s.measureText(r).width/1.5;s.fillText(r,t+this.x-a,e+this.y),s.textAlign=n}finally{i?.[Symbol.dispose]?.()}}}class vl extends ec{firstLineY=0;Z_=!1;tupletSize=0;get lineOffset(){return this.lineSpacing}get tupletOffset(){return.5*this.smuflMetrics.oneStaffSpace}get topGlyphOverflow(){return 0}get bottomGlyphOverflow(){return 0}initLineBasedSizes(){this.height=this.lineOffset*(this.heightLineCount-1)}updateSizes(){this.initLineBasedSizes(),this.adjustSizes(),this.updateFirstLineY(),super.updateSizes()}adjustSizes(){}updateFirstLineY(){const t=this.lineOffset*(this.heightLineCount-1),e=0===this.drawnLineCount?0:(this.drawnLineCount-1)*this.lineOffset,s=this.smuflMetrics.staffLineThickness/2;this.firstLineY=((t-e)/2|0)-s}doLayout(){this.initLineBasedSizes(),this.updateFirstLineY(),this.tupletSize=this.smuflMetrics.glyphHeights.get(lt.Tuplet0),super.doLayout()}getLineY(t){return this.firstLineY+this.getLineHeight(t)}getLineHeight(t){return this.lineOffset*t}paintContent(t,e,s){super.paintContent(t,e,s),this.paintBeams(t,e,s,this.flagsSubElement,this.beamsSubElement),this.paintTuplets(t,e,s,this.tupletSubElement)}paintBackground(t,e,s){super.paintBackground(t,e,s),this.paintStaffLines(t,e,s),this.paintSimileMark(t,e,s)}paintStaffLines(t,e,s){const i=ao.bar(s,this.staffLineBarSubElement,this.bar,!0);try{const i=[];for(let t=0,e=this.drawnLineCount;t<e;t++)i.push([]);this.additionalMultiRestBars||this.collectSpaces(i);for(const t of i)t.sort((t,e)=>t[0]>e[0]?1:t[0]<e[0]?-1:0);const n=this.width,r=this.smuflMetrics.staffLineThickness/2;for(let a=0;a<this.drawnLineCount;a++){const h=this.getLineY(a)-r;let o=0;for(const n of i[a])s.fillRect(t+this.x+o,e+this.y+h,n[0]-o,this.smuflMetrics.staffLineThickness),o=n[0]+n[1];s.fillRect(t+this.x+o,e+this.y+h,n-o,this.smuflMetrics.staffLineThickness)}}finally{i?.[Symbol.dispose]?.()}}collectSpaces(t){}createStartSpacing(){if(this.Z_)return!1;const t=0===this.index?this.settings.display.firstStaffPaddingLeft:this.settings.display.staffPaddingLeft;return this.addPreBeatGlyph(new fl(0,0,t)),this.Z_=!0,!0}paintTuplets(t,e,s,i,n=!1){for(const r of this.voiceContainer.voiceDrawOrder)if(this.voiceContainer.tupletGroups.has(r)){const a=this.voiceContainer.tupletGroups.get(r);for(const r of a)this.tT(t,e,s,r,i,n)}}getBeatDirection(t){const e=this.helpers.getBeamingHelperForBeat(t);return e?this.getBeamDirection(e):Wt.Up}getTupletBeamDirection(t){return this.getBeamDirection(t)}calculateBeamYWithDirection(t,e,s){return this.ensureBeamDrawingInfo(t,s),t.drawingInfos.get(s).calcY(e)}tT(t,e,s,i,n,r){const a=this.resources,h=s.textAlign,o=s.textBaseline;let c;s.color=0===i.voice.index?this.resources.mainGlyphColor:this.resources.secondaryGlyphColor,s.textAlign=at.Center,s.textBaseline=ht.Middle;const l=i.beats[0].tupletNumerator,u=i.beats[0].tupletDenominator;if(2===l&&3===u)c=[lt.Tuplet2];else if(3===l&&2===u)c=[lt.Tuplet3];else if(4===l&&6===u)c=[lt.Tuplet4];else if(5===l&&4===u)c=[lt.Tuplet5];else if(6===l&&4===u)c=[lt.Tuplet6];else if(7===l&&4===u)c=[lt.Tuplet7];else if(9===l&&8===u)c=[lt.Tuplet9];else if(10===l&&8===u)c=[lt.Tuplet1,lt.Tuplet0];else if(11===l&&8===u)c=[lt.Tuplet1,lt.Tuplet1];else if(12===l&&8===u)c=[lt.Tuplet1,lt.Tuplet2];else if(13===l&&8===u)c=[lt.Tuplet1,lt.Tuplet3];else{c=[];const t=lt.Tuplet0;l>10?(c.push(t+Math.floor(l/10)),c.push(t+(l-10))):c.push(t+l),c.push(lt.TupletColon),u>10?(c.push(t+Math.floor(u/10)),c.push(t+(u-10))):c.push(t+u)}const d=this.tupletOffset,f=this.tupletSize,p=d+.5*f,b=ao.beat(s,n,i.beats[0]);try{const n=s.lineWidth;if(s.lineWidth=this.smuflMetrics.tupletBracketThickness,1!==i.beats.length&&i.isFull){const n=i.beats[0],h=i.beats[i.beats.length-1];let o=null,l=null;for(let t=0;t<i.beats.length;t++)if(!i.beats[t].isRest){o=i.beats[t];break}for(let t=i.beats.length-1;t>=0;t--)if(!i.beats[t].isRest){l=i.beats[t];break}let u=!1;o||(o=n,u=!0),l||(l=h);const d=this.getBeatX(n,bs.OnNotes),b=this.getBeatX(h,bs.PostNotes),m=this.helpers.getBeamingHelperForBeat(o),g=this.helpers.getBeamingHelperForBeat(l),w=this.getTupletBeamDirection(m);let y=this.calculateBeamYWithDirection(m,d,w),k=this.calculateBeamYWithDirection(g,b,w);u&&(y=Math.max(y,k),k=y),w===Wt.Down?(y+=p,k+=p):(y-=p,k-=p);const S=c.reduce((t,e)=>t+a.engravingSettings.glyphWidths.get(e),0),B=.5*a.engravingSettings.oneStaffSpace,_=(d+b)/2,T=_-S/2-B,x=_+S/2+B,M=(k-y)/(b-d),v=y-M*d,N=M*T+v,P=M*_+v,C=M*x+v,E=w===Wt.Down?y-.5*f:y+.5*f,F=w===Wt.Down?k-.5*f:k+.5*f,A=s.lineWidth%2==0?0:.5;t+=A,e+=A,T>d&&(s.beginPath(),s.moveTo(t+this.x+d,e+this.y+E),r?s.quadraticCurveTo(t+this.x+(T+d)/2,e+this.y+N,t+this.x+T,e+this.y+N):(s.lineTo(t+this.x+d,e+this.y+y),s.lineTo(t+this.x+T,e+this.y+N)),s.moveTo(t+this.x+x,e+this.y+C),r?s.quadraticCurveTo(t+this.x+(b+x)/2,e+this.y+C,t+this.x+b,e+this.y+F):(s.lineTo(t+this.x+b,e+this.y+k),s.lineTo(t+this.x+b,e+this.y+F)),s.stroke()),s.fillMusicFontSymbols(t+this.x+_,e+this.y+P+.5*f,1,c,!0)}else for(const n of i.beats){const i=this.helpers.getBeamingHelperForBeat(n);if(!i)continue;const r=this.getTupletBeamDirection(i),a=this.getBeatX(n,bs.Stem);let h=this.calculateBeamYWithDirection(i,a,r);r===Wt.Down?h+=p:h-=p,s.fillMusicFontSymbols(t+this.x+a,e+this.y+h+.5*f,1,c,!0)}s.textAlign=h,s.textBaseline=o,s.lineWidth=n}finally{b?.[Symbol.dispose]?.()}}paintBeams(t,e,s,i,n){for(const r of this.voiceContainer.voiceDrawOrder)for(const a of this.helpers.beamHelpers[r])this.paintBeamHelper(t,e,s,a,i,n)}drawBeamHelperAsFlags(t){return 1===t.beats.length}hasFlag(t){if(t.isRest)return!1;const e=this.helpers.getBeamingHelperForBeat(t);return e?e.hasFlag(this.drawBeamHelperAsFlags(e),t):qo.beatHasFlag(t)}hasStem(t){if(t.isRest)return!1;const e=this.helpers.getBeamingHelperForBeat(t);return e?e.hasStem(this.drawBeamHelperAsFlags(e),t):qo.beatHasStem(t)}paintBeamHelper(t,e,s,i,n,r){s.color=0===i.voice.index?this.resources.mainGlyphColor:this.resources.secondaryGlyphColor,this.shouldPaintBeamingHelper(i)&&(this.drawBeamHelperAsFlags(i)?this.paintFlag(t,e,s,i,n):this.paintBar(t,e,s,i,r))}shouldPaintBeamingHelper(t){return!t.isRestBeamHelper}shouldPaintFlag(t){return t.graceType!==l.BendGrace&&(!t.deadSlapped&&((t.graceType===l.None||this.settings.notation.notationMode!==S.SongBook)&&(t.duration!==c.Whole&&t.duration!==c.DoubleWhole&&t.duration!==c.QuadrupleWhole)))}paintFlag(t,e,s,i,n){for(const r of i.beats){if(!this.shouldPaintFlag(r))continue;const a=r.graceType!==l.None,h=this.getBeatX(r,bs.Stem),o=this.getBeamDirection(i),c=e+this.y+this.getFlagTopY(r,o),u=e+this.y+this.getFlagBottomY(r,o);let d=0;if(d=o===Wt.Down?u:c,!i.hasStem(!0,r))continue;this.paintBeamingStem(r,e+this.y,t+this.x+h,c,u,s);const f=ao.beat(s,n,r);try{let e=0;if(i.hasFlag(!0,r)){const i=new xl(t+this.x+h,d,r.duration,o,a);i.renderer=this,i.doLayout(),i.paint(0,0,s),e=i.width/2}r.graceType===l.BeforeBeat&&(o===Wt.Down?Rt.fillMusicFontSymbolSafe(s,t+this.x+h+e/2,(c+u-this.smuflMetrics.glyphHeights.get(lt.GraceNoteSlashStemDown))/2,Rr.GraceScale,lt.GraceNoteSlashStemDown,!0):Rt.fillMusicFontSymbolSafe(s,t+this.x+h+e/2,(c+u+this.smuflMetrics.glyphHeights.get(lt.GraceNoteSlashStemUp))/2,Rr.GraceScale,lt.GraceNoteSlashStemUp,!0))}finally{f?.[Symbol.dispose]?.()}}}recreatePreBeatGlyphs(){this.Z_=!1,super.recreatePreBeatGlyphs()}calculateBeamY(t,e){return this.calculateBeamYWithDirection(t,e,this.getBeamDirection(t))}createPreBeatGlyphs(){super.createPreBeatGlyphs(),this.addPreBeatGlyph(new il(!1,this.bar.staff.track.score.stylesheet.extendBarLines)),this.createLinePreBeatGlyphs();let t=!1;0===this.index&&(t=this.createStartSpacing()),this.shouldCreateBarNumber()?this.addPreBeatGlyph(new nl(0,this.getLineHeight(-.5),this.bar.index+1)):t||this.addPreBeatGlyph(new fl(0,0,this.smuflMetrics.oneStaffSpace))}shouldCreateBarNumber(){let t=O.AllBars;switch(t=this.settings.notation.isNotationElementVisible(B.BarNumber)?void 0!==this.bar.barNumberDisplay?this.bar.barNumberDisplay:this.bar.staff.track.score.stylesheet.barNumberDisplay:O.Hide,t){case O.AllBars:return!0;case O.FirstOfSystem:return this.isFirstOfStaff;case O.Hide:return!1}return!0}createPostBeatGlyphs(){super.createPostBeatGlyphs();const t=this.lastBar;this.addPostBeatGlyph(new il(!0,this.bar.staff.track.score.stylesheet.extendBarLines)),t.masterBar.isRepeatEnd&&t.masterBar.repeatCount>2&&this.settings.notation.isNotationElementVisible(B.RepeatCount)&&this.addPostBeatGlyph(new Ml(0,this.getLineHeight(-.5),this.bar.masterBar.repeatCount))}paintBar(t,e,s,i,n){const r=this.getBeamDirection(i),a=i.graceType!==l.None?Rr.GraceScale:1;let h=(this.beamSpacing+this.beamThickness)*a,o=this.beamThickness*a;r===Wt.Down&&(h=-h,o=-o);for(let c=0,l=i.beats.length;c<l;c++){const l=i.beats[c];if(l.deadSlapped)continue;const u=this.getBeatX(l,bs.Stem);let d=e+this.y;r===Wt.Up?d+=this.getFlagBottomY(l,r):d+=this.getFlagTopY(l,r);const f=e+this.y+this.calculateBeamY(i,u);let p,b;d<f?(p=d,b=f):(p=f,b=d),this.paintBeamingStem(l,e+this.y,t+this.x+u,p,b,s);const m=ao.beat(s,n,l);try{const n=this.smuflMetrics.brokenBeamWidth*a,r=zt.getIndex(l.duration)-2,d=e+this.y,f=this.smuflMetrics.stemThickness;for(let e=0;e<r;e++){let a=Math.floor(u+f),p=0,b=0,m=0;const g=d+e*h;if(c<i.beats.length-1){const h=qo.isFullBarJoin(l,i.beats[c+1],e);if(e===r-1&&h&&l.beamingMode===St.ForceSplitOnSecondaryToNext)p=Math.ceil(a+n),b=g+this.calculateBeamY(i,a),m=g+this.calculateBeamY(i,p),vl.paintSingleBar(s,t+this.x+a,b,t+this.x+p,m,o),p=Math.floor(this.getBeatX(i.beats[c+1],bs.Stem)),a=Math.floor(p-n),b=g+this.calculateBeamY(i,a),m=g+this.calculateBeamY(i,p),vl.paintSingleBar(s,t+this.x+a,b,t+this.x+p,m,o);else{if(h)p=Math.ceil(this.getBeatX(i.beats[c+1],bs.Stem));else{if(0!==c&&qo.isFullBarJoin(i.beats[c-1],l,e))continue;p=Math.ceil(a+n)}b=g+this.calculateBeamY(i,a),m=g+this.calculateBeamY(i,p),vl.paintSingleBar(s,t+this.x+a,b,t+this.x+p,m,o)}}else c>0&&!qo.isFullBarJoin(l,i.beats[c-1],e)&&(p=Math.ceil(u),a=Math.floor(u-n),b=g+this.calculateBeamY(i,a),m=g+this.calculateBeamY(i,p),vl.paintSingleBar(s,t+this.x+a,b,t+this.x+p,m,o))}}finally{m?.[Symbol.dispose]?.()}}if(i.graceType===l.BeforeBeat){const n=this.getBeatX(i.beats[0],bs.Stem),a=this.smuflMetrics.glyphWidths.get(lt.Flag8thUp)*Rr.GraceScale;let c=e+this.y+this.calculateBeamY(i,n)|0;c+=o+h,r===Wt.Down?Rt.fillMusicFontSymbolSafe(s,t+this.x+n+a/2,c,Rr.GraceScale,lt.GraceNoteSlashStemDown,!0):Rt.fillMusicFontSymbolSafe(s,t+this.x+n+a/2,c,Rr.GraceScale,lt.GraceNoteSlashStemUp,!0)}}static paintSingleBar(t,e,s,i,n,r){t.beginPath(),t.moveTo(e,s),t.lineTo(i,n),t.lineTo(i,n+r),t.lineTo(e,s+r),t.closePath(),t.fill()}calculateBeamingOverflows(t,e){let s=0,i=0;for(const t of this.helpers.beamHelpers)for(const e of t)if(this.shouldPaintBeamingHelper(e))if(1===e.beats.length&&e.beats[0].duration>=c.Half){const t=this.getTupletBeamDirection(e),n=this.getBeamDirection(e),r=this.smuflMetrics.stemFlagOffsets.get(e.beats[0].duration);if(n===Wt.Up){let a=this.getFlagTopY(e.beats[0],n)-r;if(e.hasTuplet&&t===n&&(a-=this.tupletSize+this.tupletOffset),a<s&&(s=a),e.hasTuplet&&t!==n){let s=this.getFlagBottomY(e.beats[0],t);s+=this.tupletSize+this.tupletOffset,s>i&&(i=s)}}else{let a=this.getFlagBottomY(e.beats[0],n)+r;if(e.hasTuplet&&t===n&&(a+=this.tupletSize+this.tupletOffset),a>i&&(i=a),e.hasTuplet&&t!==n){let i=this.getFlagTopY(e.beats[0],t);i-=this.tupletSize+this.tupletOffset,i<s&&(s=i)}}}else{const t=this.getBeamDirection(e);this.ensureBeamDrawingInfo(e,t);const n=e.drawingInfos.get(t),r=this.getTupletBeamDirection(e);if(t===Wt.Up){let a=Math.min(n.startY,n.endY);e.hasTuplet&&r===t&&(a-=this.tupletSize+this.tupletOffset),a<s&&(s=a);let h=this.voiceContainer.getLowestNoteY(e.beatOfLowestNote,Bh.Bottom);e.hasTuplet&&r!==t&&(h+=this.tupletSize+this.tupletOffset),h>i&&(i=h)}else{let a=Math.max(n.startY,n.endY);e.hasTuplet&&r===t&&(a+=this.tupletSize+this.tupletOffset),a>i&&(i=a);let h=this.voiceContainer.getHighestNoteY(e.beatOfHighestNote,Bh.Top);e.hasTuplet&&r!==t&&(h-=this.tupletSize+this.tupletOffset),h<s&&(s=h)}}else;s<t&&this.registerOverflowTop(Math.abs(s)),i>e&&this.registerOverflowBottom(Math.abs(i)-e)}initializeBeamDrawingInfo(t,e){const s=new Jo,i=t.beats[0],n=t.beats[t.beats.length-1];s.startBeat=i,s.startX=this.getBeatX(i,bs.Stem),s.startY=e===Wt.Up?this.getFlagTopY(i,e):this.getFlagBottomY(i,e),s.endBeat=n,s.endX=this.getBeatX(n,bs.Stem),s.endY=e===Wt.Up?this.getFlagTopY(n,e):this.getFlagBottomY(n,e);const r=this.smuflMetrics.oneStaffSpace;return e===Wt.Down&&s.startY>s.endY&&s.startY-s.endY>r&&(s.endY=s.startY-r),e===Wt.Down&&s.endY>s.startY&&s.endY-s.startY>r&&(s.startY=s.endY-r),e===Wt.Up&&s.startY<s.endY&&s.endY-s.startY>r&&(s.endY=s.startY+r),e===Wt.Up&&s.endY<s.startY&&s.startY-s.endY>r&&(s.startY=s.endY+r),s}get beamSpacing(){return this.smuflMetrics.beamSpacing}get beamThickness(){return this.smuflMetrics.beamThickness}ensureBeamDrawingInfo(t,e){if(t.drawingInfos.has(e))return;const s=this.initializeBeamDrawingInfo(t,e);t.drawingInfos.set(e,s);const i=zt.getIndex(t.shortestDuration)-2,n=this.applyBarShift(t,e,s,i);if(t.beats.length>1){if(e===Wt.Up){const i=n+this.getFlagTopY(t.beatOfHighestNote,e),r=s.calcY(this.getBeatX(t.beatOfHighestNote,bs.Stem))-i;r>0&&(s.startY-=r,s.endY-=r)}else{const i=n+this.getFlagBottomY(t.beatOfLowestNote,e)-s.calcY(this.getBeatX(t.beatOfLowestNote,bs.Stem));i>0&&(s.startY+=i,s.endY+=i)}let r=0;if(t.restBeats.length>0){const e=t.graceType!==l.None?Rr.GraceScale:1;r=i*(this.beamSpacing+this.beamThickness)*e}for(const i of t.restBeats)if(i.isRest&&i.index<t.beats[t.beats.length-1].index)if(e===Wt.Up){const t=this.getBeatContainer(i).getBoundingBoxTop()-r,e=s.calcY(this.getBeatX(i,bs.Stem))-t;e>0&&(s.startY-=e,s.endY-=e)}else if(e===Wt.Down){const t=this.getBeatContainer(i).getBoundingBoxBottom()+r-s.calcY(this.getBeatX(i,bs.Stem));t>0&&(s.startY+=t,s.endY+=t)}if(t.slashBeats.length>0)for(const i of t.slashBeats){const t=s.calcY(this.getBeatX(i,bs.Stem)),n=(e===Wt.Up?this.getFlagTopY(i,e):this.getFlagBottomY(i,e))-t;n>0&&(s.startY+=n,s.endY+=n)}}Wt.Up,s.startY=Math.round(s.startY),s.endY=Math.round(s.endY)}applyBarShift(t,e,s,i){let n=0;const r=t.isRestBeamHelper,a=t.graceType!==l.None?Rr.GraceScale:1;if(i>2&&!r){const t=this.beamSpacing*a,r=this.beamThickness*a,h=i*r+(i-1)*t;if(e===Wt.Up){const e=s.startY+2*r+t-h,i=s.startY-e;i>0&&(n=-1*i,s.startY-=i,s.endY-=i)}else{const e=s.startY-2*r+t+h-s.startY;e>0&&(n=e,s.startY+=e,s.endY+=e)}}return n}getMinLineOfBeat(t){return 0}getMaxLineOfBeat(t){return 0}}class Nl extends vl{static StaffId="numbered";simpleWhammyOverflow=0;eT;shortestDuration=c.QuadrupleWhole;get dotSpacing(){return 2*this.smuflMetrics.glyphHeights.get(lt.AugmentationDot)}get repeatsBarSubElement(){return C.NumberedRepeats}get barNumberBarSubElement(){return C.NumberedBarNumber}get barLineBarSubElement(){return C.NumberedBarLines}get staffLineBarSubElement(){return C.NumberedStaffLine}constructor(t,e){super(t,e),this.eT=!e.staff.showSlash&&!e.staff.showTablature&&!e.staff.showStandardNotation}get lineSpacing(){return this.smuflMetrics.oneStaffSpace}get heightLineCount(){return 5}get drawnLineCount(){return 0}get bottomGlyphOverflow(){return 0}get flagsSubElement(){return Bt.NumberedDuration}get beamsSubElement(){return Bt.NumberedDuration}get tupletSubElement(){return Bt.NumberedTuplet}shouldPaintBeamingHelper(t){return!0}paintFlag(t,e,s,i,n){this.paintBar(t,e,s,i,n)}paintBar(t,e,s,i,n){if(0!==i.beats.length&&i.graceType===l.None)for(let r=0,a=i.beats.length;r<a;r++){const a=i.beats[r],h=ao.beat(s,n,a);try{const n=this.getBeamDirection(i),h=i.graceType!==l.None?Rr.GraceScale:1;let o=(this.beamSpacing+this.beamThickness)*h,c=this.beamThickness*h;n===Wt.Down&&(o=-o,c=-c);let u=zt.getIndex(a.duration)-2,d=this.getBeatX(a,bs.PreNotes),f=0,p=0;r===i.beats.length-1?(f=d,p=this.getBeatX(a,bs.PostNotes)):(f=d,p=this.getBeatX(i.beats[r+1],bs.PreNotes));const b=e+this.y+this.calculateBeamY(i,d);for(let e=0;e<u;e++){const i=b+e*o;vl.paintSingleBar(s,t+this.x+f,i,t+this.x+p,i,c)}const m=this.voiceContainer.getBeatContainer(a);if(m&&m.hasAdditionalNumbers)for(const e of m.iterateAdditionalNumbers()){u=e.barCount,d=this.beatGlyphsStart+e.x+e.getBeatX(bs.PreNotes,!1);for(let i=0;i<u;i++){const n=b+i*o,r=this.beatGlyphsStart+e.x+e.getBeatX(bs.PostNotes,!1);vl.paintSingleBar(s,t+this.x+d,n,t+this.x+r,n,c)}}}finally{h?.[Symbol.dispose]?.()}}}calculateOverflows(t,e){super.calculateOverflows(t,e),this.bar.isEmpty||this.calculateBeamingOverflows(t,e)}getNoteLine(t){return 0}sT(t){const e=zt.getIndex(t.duration)-2;let s=0;if(e>0){const t=this.smuflMetrics;s=t.numberedBarRendererBarSpacing+e*(t.numberedBarRendererBarSpacing+t.numberedBarRendererBarSize)}return s}getFlagTopY(t,e){const s=this.sT(t),i=this.voiceContainer.getBeatContainer(t);return i?e===Wt.Up?i.getBoundingBoxTop()-s:i.getBoundingBoxBottom():e===Wt.Up?this.voiceContainer.getBoundingBoxTop()-s:this.voiceContainer.getBoundingBoxBottom()}getFlagBottomY(t,e){const s=this.sT(t),i=this.voiceContainer.getBeatContainer(t);return i?e===Wt.Down?i.getBoundingBoxBottom()+s:this.getLineY(0):e===Wt.Down?this.voiceContainer.getBoundingBoxBottom()+s:this.getLineY(0)}getBeamDirection(t){return Wt.Down}getTupletBeamDirection(t){return Wt.Up}createPreBeatGlyphs(){this.wasFirstOfStaff=this.isFirstOfStaff,(0===this.index||this.bar.masterBar.isRepeatStart&&this.eT)&&this.addPreBeatGlyph(new il(!1,this.bar.staff.track.score.stylesheet.extendBarLines)),this.createLinePreBeatGlyphs();const t=this.createStartSpacing();this.shouldCreateBarNumber()?this.addPreBeatGlyph(new nl(0,this.getLineHeight(-.5),this.bar.index+1)):t||this.addPreBeatGlyph(new fl(0,0,this.smuflMetrics.oneStaffSpace))}createLinePreBeatGlyphs(){this.eT&&(!this.bar.previousBar||this.bar.previousBar&&this.bar.masterBar.timeSignatureNumerator!==this.bar.previousBar.masterBar.timeSignatureNumerator||this.bar.previousBar&&this.bar.masterBar.timeSignatureDenominator!==this.bar.previousBar.masterBar.timeSignatureDenominator||this.bar.previousBar&&this.bar.masterBar.isFreeTime&&this.bar.masterBar.isFreeTime!==this.bar.previousBar.masterBar.isFreeTime)&&(this.createStartSpacing(),this.iT())}iT(){const t=this.bar.masterBar,e=new Tl(0,this.getLineY(0),t.timeSignatureNumerator,t.timeSignatureDenominator,t.timeSignatureCommon,t.isFreeTime&&(null==t.previousMasterBar||t.isFreeTime!==t.previousMasterBar.isFreeTime));e.barSubElement=C.NumberedTimeSignature,this.addPreBeatGlyph(e)}createPostBeatGlyphs(){this.eT&&super.createPostBeatGlyphs()}createVoiceGlyphs(t){if(t.index>0)return;super.createVoiceGlyphs(t);const e=this.bar.masterBar.start;for(const s of t.beats){const i=new yl(s);if(this.addBeatGlyph(i),s.duration<c.Quarter){const n=s.displayStart+s.displayDuration;let r=s.displayStart+H.QuarterTime;for(;r<n;){if(n-r>=H.QuarterTime){const s=new Sl(t.index,e+r);this.addBeatGlyph(s),i.addDash(s)}else if(s.duration===c.Half&&s.dots>1){const t=new kl(s,e+r,n-r);this.addBeatGlyph(t),i.addNotes(t)}r+=H.QuarterTime}}}}paintBeamingStem(t,e,s,i,n,r){}get beamSpacing(){return this.smuflMetrics.numberedBarRendererBarSpacing}get beamThickness(){return this.smuflMetrics.numberedBarRendererBarSize}paintBeamHelper(t,e,s,i,n,r){0===i.voice?.index&&super.paintBeamHelper(t,e,s,i,n,r)}applyBarShift(t,e,s,i){return 0}calculateBeamYWithDirection(t,e,s){this.ensureBeamDrawingInfo(t,s);const i=t.drawingInfos.get(s);return s===Wt.Up?Math.min(i.startY,i.endY):Math.max(i.startY,i.endY)}paintTuplets(t,e,s,i,n=!1){super.paintTuplets(t,e,s,i,!0)}}class Pl extends Eh{get staffId(){return Nl.StaffId}create(t,e){return new Nl(t,e)}canCreate(t,e){return super.canCreate(t,e)&&e.showNumbered}}class Cl extends Kh{nT;rT;aT;constructor(t,e,s,i){super(t,e,1,Cl.Sk(s,i)),this.nT=s,this.rT=i}getBoundingBoxTop(){let t=super.getBoundingBoxTop();const e=this.aT;if(e){const s=this.y+e.getBoundingBoxTop();t=zt.minBoundingBox(t,s)}return t}getBoundingBoxBottom(){let t=super.getBoundingBoxBottom();const e=this.aT;if(e){const s=this.y+e.getBoundingBoxBottom();t=zt.maxBoundingBox(t,s)}return t}doLayout(){switch(this.center=!0,super.doLayout(),this.width=this.renderer.smuflMetrics.glyphWidths.get(lt.GClef),this.offsetX=this.width/2,this.aT=void 0,this.nT){case x.C3:case x.C4:if(this.rT===b.T)return;break;case x.F4:case x.G2:return}let t,e=!1;switch(this.rT){case b.S:t=lt.Clef15,e=!0;break;case b._:t=lt.Clef8,e=!0;break;case b.T:t=lt.Clef8;break;case b.M:t=lt.Clef15;break;default:return}const s=this.width/2,i=e?this.renderer.smuflMetrics.glyphTop.get(this.symbol):this.renderer.smuflMetrics.glyphBottom.get(this.symbol)-this.renderer.smuflMetrics.glyphHeights.get(t);this.aT=new Kh(s,-i,1,t),this.aT.center=!0,this.aT.renderer=this.renderer,this.aT.doLayout()}static Sk(t,e){switch(t){case x.Neutral:return lt.UnpitchedPercussionClef1;case x.C3:case x.C4:return e===b.T?lt.CClef8vb:lt.CClef;case x.F4:switch(e){case b.S:return lt.FClef15ma;case b._:return lt.FClef8va;case b.T:return lt.FClef8vb;case b.M:return lt.FClef15mb;default:return lt.FClef}case x.G2:switch(e){case b.S:return lt.GClef15ma;case b._:return lt.GClef8va;case b.T:return lt.GClef8vb;case b.M:return lt.GClef15mb;default:return lt.GClef}default:return lt.None}}paint(t,e,s){const i=ao.bar(s,C.StandardNotationClef,this.renderer.bar);try{super.paint(t,e,s);const i=this.aT;i&&i.paint(t+this.x,e+this.y,s)}finally{i?.[Symbol.dispose]?.()}}}class El extends Go{paint(t,e,s){const i=ao.bar(s,C.StandardNotationKeySignature,this.renderer.bar);try{super.paint(t,e,s)}finally{i?.[Symbol.dispose]?.()}}}class Fl extends Fh{je;constructor(t,e,s){super(t,e),this.je=s}static Sk(t,e){switch(t){case u.None:return lt.None;case u.Normal:return e?lt.ArticAccentAbove:lt.ArticAccentBelow;case u.Heavy:return e?lt.ArticMarcatoAbove:lt.ArticMarcatoBelow;case u.Tenuto:return e?lt.ArticTenutoAbove:lt.ArticTenutoBelow;default:return lt.None}}doLayout(){this.width=this.renderer.smuflMetrics.glyphWidths.get(lt.ArticAccentAbove),this.height=this.renderer.smuflMetrics.glyphHeights.get(lt.ArticAccentAbove)}paint(t,e,s){const i=this.renderer.getBeatDirection(this.je.beat),n=Fl.Sk(this.je.accentuated,i===Wt.Down),r=i===Wt.Up?e+this.y:e+this.y+this.height;Rt.fillMusicFontSymbolSafe(s,t+this.x,r,1,n,!0)}}class Al extends Kh{constructor(t,e){super(t,e,Rr.GraceScale,lt.ArticStaccatoAbove),this.center=!0}doLayout(){super.doLayout(),this.offsetY=this.height}}class Dl extends Kh{centerOnStem=!1;constructor(t,e,s,i){super(t,e,s?Rr.GraceScale:1,i)}paint(t,e,s){this.centerOnStem&&(this.center=!0),super.paint(t,e,s)}}class Ll extends Dl{constructor(t,e,s,i){super(t,e,i,Ll.getSymbol(s))}static getSymbol(t){switch(t){case c.QuadrupleWhole:return lt.NoteheadDoubleWholeSquare;case c.DoubleWhole:return lt.NoteheadDoubleWhole;case c.Whole:return lt.NoteheadWhole;case c.Half:return lt.NoteheadHalf;default:return lt.NoteheadBlack}}}class Wl extends Dl{constructor(t,e,s){super(t,e,s,lt.NoteheadXOrnate)}}class Ol extends Dl{constructor(t,e,s,i){super(t,e,i,Ol.Sk(s))}static Sk(t){switch(t){case c.QuadrupleWhole:case c.DoubleWhole:case c.Whole:case c.Half:return lt.NoteheadDiamondWhiteWide;default:return lt.NoteheadDiamondBlackWide}}}class Rl{steps=0;isGhost;color;constructor(t,e,s){this.steps=t,this.isGhost=e,this.color=s}}class Il extends Oa{j_;Pk=[];hT=[];isEmpty=!0;constructor(t){super(0,0),this.j_=t}addParenthesis(t){const e=this.renderer,s=e.getNoteSteps(t),i=t.isGhost||this.oT(t)&&e.settings.notation.isNotationElementVisible(B.ParenthesisOnTiedBends),n=ao.noteColor(e.resources,ft.Effects,t);this.cT(new Rl(s,i,n))}addParenthesisOnSteps(t,e){const s=new Rl(t,e,void 0);this.cT(s)}cT(t){this.Pk.push(t),t.isGhost&&(this.isEmpty=!1)}oT(t){return!!t.isTieDestination&&(!!t.tieOrigin.hasBend||this.oT(t.tieOrigin))}doLayout(){const t=this.renderer;this.Pk.sort((t,e)=>t.steps-e.steps);let e=null;const s=t.getScoreHeight(1);for(let i=0,n=this.Pk.length;i<n;i++){let n;if(this.Pk[i].isGhost)if(e){const n=t.getScoreY(this.Pk[i].steps)+s;e.height=n-e.y}else n=new Bl(this.j_),n.colorOverride=this.Pk[i].color,n.renderer=this.renderer,n.y=t.getScoreY(this.Pk[i].steps)-s,n.height=2*s,n.doLayout(),this.hT.push(n),e=n;else e=null}this.width=this.hT.length>0?this.hT[0].width:0}paint(t,e,s){super.paint(t,e,s);for(const i of this.hT)i.paint(t+this.x,e+this.y,s)}}class Gl extends Dl{F_;lT;constructor(t,e,s,i,n){super(t,e,n,s.getSymbol(i)),this.F_=n,this.lT=s}paint(t,e,s){const i=s.color;this.colorOverride&&(s.color=this.colorOverride);const n=this.F_?1:0;Rt.fillMusicFontSymbolSafe(s,t+this.x,e+this.y+n,this.glyphScale,this.symbol,!1),this.lT.techniqueSymbol!==lt.None&&this.lT.techniqueSymbolPlacement===ut.Inside&&Rt.fillMusicFontSymbolSafe(s,t+this.x,e+this.y+n,this.glyphScale,this.lT.techniqueSymbol,!1),s.color=i}doLayout(){super.doLayout(),0===this.width&&(this.height=this.renderer.smuflMetrics.glyphWidths.get(lt.NoteheadBlack)),0===this.height&&(this.height=this.renderer.smuflMetrics.glyphHeights.get(lt.NoteheadBlack))}}class Hl extends Kh{constructor(t,e){super(t,e,.5,lt.PictEdgeOfCymbal),this.center=!0}doLayout(){super.doLayout(),this.offsetY=this.height}}!function(t){t[t.NoIntersection=0]="NoIntersection",t[t.EndsTouchingOuter=1]="EndsTouchingOuter",t[t.EndsTouchingInner=2]="EndsTouchingInner",t[t.ExactMatch=3]="ExactMatch",t[t.FullIntersection=4]="FullIntersection"}(xh||(xh={}));class Vl{mainVoiceDirection=Wt.Up;groups=new Map;minX=0;maxX=0;uT=!1;constructor(t){this.mainVoiceDirection=t}update(){let t=0,e=0;for(const s of this.groups.values()){const i=s.minX+s.multiVoiceShiftX,n=s.maxX+s.multiVoiceShiftX;i<t&&(t=i),e<n&&(e=n)}this.minX=t,this.maxX=e}finish(t){if(!this.uT){this.uT=!0;for(const e of this.groups.values())this.dT(e,t);this.update()}}dT(t,e){if(this.mainVoiceDirection===t.direction)return;const s=this.groups.get(this.mainVoiceDirection),i=Vl.fT(s,t),n=e.multiVoiceDisplacedNoteHeadSpacing;switch(i){case xh.NoIntersection:return;case xh.ExactMatch:Vl.pT(s,t)||(s.direction===Wt.Up?t.displacedNotes?t.multiVoiceShiftX=t.stemX+t.correctNotes.width+n:t.multiVoiceShiftX=t.correctNotes.width+n:s.multiVoiceShiftX=t.stemX+n);break;case xh.EndsTouchingOuter:if(s.direction===Wt.Up)if(s.displacedNotes)t.multiVoiceShiftX=s.stemX;else{const e=s.stemX-t.stemX;t.multiVoiceShiftX=e}else if(s.displacedNotes)t.multiVoiceShiftX=-t.stemX;else{const e=t.stemX-s.stemX;s.multiVoiceShiftX=e}break;case xh.EndsTouchingInner:s.direction===Wt.Up?(s.multiVoiceShiftX=s.stemX,t.hasFlag&&(s.multiVoiceShiftX+=n)):(t.multiVoiceShiftX=t.stemX,s.hasFlag&&(t.multiVoiceShiftX+=n));break;case xh.FullIntersection:(s.hasStem||t.hasStem)&&(s.direction===Wt.Up?(s.multiVoiceShiftX=s.stemX,t.hasFlag?s.multiVoiceShiftX+=n:s.multiVoiceShiftX-=n):(t.multiVoiceShiftX=t.stemX,s.hasFlag?t.multiVoiceShiftX+=n:t.multiVoiceShiftX-=n))}}static pT(t,e){const s=t.direction===Wt.Up?t.maxStep:t.minStep,i=e.direction===Wt.Up?e.maxStep:e.minStep,n=t.correctNotes.notes.get(s);if(n.length>1)return!1;const r=e.correctNotes.notes.get(i);return!(r.length>1)&&Vl.bT(n[0].glyph,r[0].glyph)}static bT(t,e){return t.glyphScale===e.glyphScale&&t.centerOnStem===e.centerOnStem&&Xt.isBlackNoteHead(t.symbol)&&Xt.isBlackNoteHead(e.symbol)}static fT(t,e){let s=0;if(t.direction===Wt.Up){const i=t.maxStep;s=e.minStep-i}else{s=t.minStep-e.maxStep}return 0===s?xh.ExactMatch:1===s?xh.EndsTouchingOuter:-1===s?xh.EndsTouchingInner:s<0?xh.FullIntersection:xh.NoIntersection}}class $l extends Oa{Pk=[];mT;noteGroup;minStepsNote=null;maxStepsNote=null;get stemX(){return this.noteGroup?this.noteGroup.stemX+this.noteGroup.multiVoiceShiftX:0}noteStartX=0;onTimeX=0;constructor(){super(0,0)}getBoundingBoxTop(){return this.minStepsNote?this.minStepsNote.glyph.getBoundingBoxTop():this.y}getBoundingBoxBottom(){return this.maxStepsNote?this.maxStepsNote.glyph.getBoundingBoxBottom():this.y+this.height}add(t,e){const s={glyph:t,steps:e};this.Pk.push(s),(!this.minStepsNote||this.minStepsNote.steps>s.steps)&&(this.minStepsNote=s),(!this.maxStepsNote||this.maxStepsNote.steps<s.steps)&&(this.maxStepsNote=s)}gT(t){const e=this.direction;let s;t.groups||(t.mainVoiceDirection=e),e===Wt.Up?this.Pk.sort((t,e)=>e.steps-t.steps):this.Pk.sort((t,e)=>t.steps-e.steps);const i=this.hasFlag,n=this.hasStem;return t.groups.has(e)?(s=t.groups.get(e),i&&(s.hasFlag=i),n&&(s.hasStem=n)):(s={correctNotes:{notes:new Map,width:0,minX:Number.NaN},direction:e,stemX:0,maxX:Number.NaN,minX:Number.NaN,minStep:Number.NaN,maxStep:Number.NaN,multiVoiceShiftX:0,hasFlag:i,hasStem:n},t.groups.set(e,s)),s}doLayout(){const t=this.getScoreChordNoteHeadInfo(),e=this.gT(t);this.noteGroup=e,this.mT=t,this.wT(e),this.yT(e),t.update(),this.kT()}kT(){const t=this.noteGroup;this.onTimeX=t.correctNotes.minX+t.correctNotes.width/2,this.width=this.noteStartX+t.multiVoiceShiftX+t.maxX-t.minX}doMultiVoiceLayout(){this.mT.finish(this.renderer.smuflMetrics),this.kT()}yT(t){t.direction===Wt.Up?(this.ST(t,t.correctNotes,!0),t.displacedNotes&&this.ST(t,t.displacedNotes,!1)):(this.ST(t,t.correctNotes,!1),t.displacedNotes&&this.ST(t,t.displacedNotes,!0))}ST(t,e,s){const i=this.scale,n=this.renderer.smuflMetrics;for(const r of e.notes.values())for(const a of r){a.glyph.x=t.stemX,a.glyph.centerOnStem||(s?n.stemUp.has(a.glyph.symbol)?a.glyph.x-=n.stemUp.get(a.glyph.symbol).x*i:a.glyph.x-=n.glyphWidths.get(a.glyph.symbol)*i:n.stemDown.has(a.glyph.symbol)&&(a.glyph.x+=n.stemDown.get(a.glyph.symbol).x*i)),e.width=Math.max(e.width,a.glyph.width),(Number.isNaN(e.minX)||a.glyph.x<e.minX)&&(e.minX=a.glyph.x),(Number.isNaN(t.minX)||a.glyph.x<t.minX)&&(t.minX=a.glyph.x);const r=a.glyph.x+a.glyph.width;(Number.isNaN(t.maxX)||r>t.maxX)&&(t.maxX=r)}}static BT(t,e){return t.notes.has(e.steps)||t.notes.has(e.steps+1)||t.notes.has(e.steps-1)}wT(t){for(const e of this.Pk){e.glyph.renderer=this.renderer,e.glyph.doLayout();let s,i;$l.BT(t.correctNotes,e)?(t.displacedNotes||(t.displacedNotes={notes:new Map,width:0,minX:0}),s=t.displacedNotes):s=t.correctNotes,s.notes.has(e.steps)?i=s.notes.get(e.steps):(i=[],s.notes.set(e.steps,i)),i.push(e),(Number.isNaN(t.minStep)||e.steps<t.minStep)&&(t.minStep=e.steps),(Number.isNaN(t.maxStep)||e.steps>t.maxStep)&&(t.maxStep=e.steps),this._T(e,t)}}_T(t,e){const s=this.renderer.smuflMetrics,i=this.scale;let n;if(e.direction===Wt.Up||e.displacedNotes)if(s.stemUp.has(t.glyph.symbol)){n=s.stemUp.get(t.glyph.symbol).x*i}else n=s.glyphWidths.get(t.glyph.symbol)*i;else if(s.stemDown.has(t.glyph.symbol)){n=s.stemDown.get(t.glyph.symbol).x*i}else n=0;n+=this.noteStartX,n>e.stemX&&(e.stemX=n)}paint(t,e,s){t+=this.x,e+=this.y,this.TT(t,e,s);t+=this.noteGroup.multiVoiceShiftX;const i=this.Pk;for(const n of i)n.glyph.renderer=this.renderer,n.glyph.paint(t,e,s)}TT(t,e,s){if(!this.minStepsNote)return;const i=this.renderer,n=ao.bar(s,C.StandardNotationStaffLine,i.bar,!0);try{const n=this.scale,r=this.renderer.smuflMetrics.legerLineExtension*n,a=this.width+2*r-this.noteStartX,h=i.getLineHeight(1),o=i.getLineY(-1),c=i.getLineY(i.drawnLineCount),l=i.getLineY(this.minStepsNote.steps/2),u=i.getLineY(this.maxStepsNote.steps/2),d=this.renderer.smuflMetrics.legerLineThickness*n/2;let f=o;for(;f>=l;)s.fillRect(t-r+this.noteStartX,e+f-d,a,this.renderer.smuflMetrics.legerLineThickness*n),f-=h;for(f=c;f<=u;)s.fillRect(t-r+this.noteStartX,e+f-d,a,this.renderer.smuflMetrics.legerLineThickness*n),f+=h}finally{n?.[Symbol.dispose]?.()}}}class Ul extends Kh{constructor(t,e,s){super(t,e,1,Ul.Sk(s))}static Sk(t){if(t.style===kt.BuzzRoll)return lt.BuzzRoll;switch(t.marks){case 1:return lt.Tremolo1;case 2:return lt.Tremolo2;case 3:return lt.Tremolo3;case 4:return lt.Tremolo4;case 5:return lt.Tremolo5;default:return lt.None}}stemExtensionHeight=0;alignTremoloPickingGlyph(t,e,s,i){const n=this.renderer,r=n.smuflMetrics;let a=0;const h=r.glyphHeights.get(lt.Tremolo1)/2,o=this.height/2,c=this.symbol===lt.Tremolo1,l=n.lineSpacing,u=c?l:l/2;if(t===Wt.Up){let t=e;t+=r.stemFlagHeight.get(i),t-=r.stemFlagOffsets.get(i),a=u*Math.ceil(t/u);const n=s-l;n<a+o&&(a=n-o),t+=h;const c=a-o;this.stemExtensionHeight=t>c?t-c:0}else{let t=e;t-=r.stemFlagHeight.get(i),t+=r.stemFlagOffsets.get(i),a=u*Math.floor(t/u);const n=s+l;n>a-o&&(a=n+o),t-=h;const c=a+o;this.stemExtensionHeight=t<c?c-t:0}this.y=a}}class zl extends $l{xT=new Map;jS=[];MT=null;vT=null;NT=0;aboveBeatEffects=new Map;belowBeatEffects=new Map;beat;get direction(){return this.renderer.getBeatDirection(this.beat)}get hasFlag(){return this.renderer.hasFlag(this.beat)}get hasStem(){return this.renderer.hasStem(this.beat)}get scale(){return this.beat.graceType!==l.None?Rr.GraceScale:1}getScoreChordNoteHeadInfo(){if(this.beat.graceType!==l.None)return new Vl(this.direction);const t=this.beat.voice.bar.staff,e=`score.noteheads.${t.track.index}.${t.index}.${this.beat.voice.bar.index}.${this.beat.absoluteDisplayStart}`;let s=this.renderer.staff.getSharedLayoutData(e,void 0);return s||(s=new Vl(this.direction),this.renderer.staff.setSharedLayoutData(e,s)),s}getNoteX(t,e){if(this.xT.has(t.id)){const s=this.xT.get(t.id);let i=this.x+s.x;switch(e){case _h.Left:break;case _h.Center:i+=s.width/2;break;case _h.Right:i+=s.width}return i}return 0}getNoteY(t,e){if(this.xT.has(t.id)){const s=this.xT.get(t.id);return this.W_(s,e)}return 0}getLowestNoteY(t){return this.maxStepsNote?this.W_(this.maxStepsNote.glyph,t):0}getHighestNoteY(t){return this.minStepsNote?this.W_(this.minStepsNote.glyph,t):0}W_(t,e){let s=this.y+t.y;const i=this.renderer,n=this.beat.graceType!==l.None?Rr.GraceScale:1;switch(e){case Bh.TopWithStem:s-=(i.smuflMetrics.stemUp.has(t.symbol)?i.smuflMetrics.stemUp.get(t.symbol).bottomY:0)*n,s-=i.smuflMetrics.getStemLength(this.beat.duration,i.hasFlag(this.beat))*n,s-=this.NT;let e=i.centerStaffStemY(this.direction);return e-=this.NT,Math.min(e,s);case Bh.Top:s-=t.height/2;break;case Bh.Center:break;case Bh.Bottom:s+=t.height/2;break;case Bh.BottomWithStem:s-=(this.renderer.smuflMetrics.stemDown.has(t.symbol)?this.renderer.smuflMetrics.stemDown.get(t.symbol).topY:-this.renderer.smuflMetrics.glyphHeights.get(t.symbol)/2)*n,s+=i.smuflMetrics.getStemLength(this.beat.duration,i.hasFlag(this.beat))*n,s+=this.NT;let r=i.centerStaffStemY(this.direction);return r+=this.NT,Math.max(r,s);case Bh.StemUp:s-=(i.smuflMetrics.stemUp.has(t.symbol)?i.smuflMetrics.stemUp.get(t.symbol).bottomY:0)*n;break;case Bh.StemDown:s-=(i.smuflMetrics.stemDown.has(t.symbol)?i.smuflMetrics.stemDown.get(t.symbol).topY:-i.smuflMetrics.glyphHeights.get(t.symbol)/2)*n}return s}addMainNoteGlyph(t,e,s){super.add(t,s),this.xT.set(e.id,t),this.jS.push(e)}addEffectNoteGlyph(t,e){super.add(t,e)}doLayout(){super.doLayout();const t=this.renderer;this.beat.deadSlapped&&(this.MT=new ul,this.MT.renderer=this.renderer,this.MT.doLayout(),this.width=this.MT.width,this.onTimeX=this.width/2);let e=0,s=0;const i=this.renderer.smuflMetrics.onNoteEffectPadding;this.beat.deadSlapped?(s=t.getScoreY(0),e=t.getScoreY(t.heightLineCount)):this.direction===Wt.Up?(s=this.W_(this.maxStepsNote.glyph,Bh.Bottom)+i,e=this.W_(this.minStepsNote.glyph,Bh.TopWithStem)-i):(s=this.W_(this.maxStepsNote.glyph,Bh.BottomWithStem)+i,e=this.W_(this.minStepsNote.glyph,Bh.Top)-i);let n=null,r=null;for(const t of this.aboveBeatEffects.values())t.renderer=this.renderer,t.doLayout(),e-=t.height,t.y=e,(null===n||n>e)&&(n=e),(null===r||r<e)&&(r=e),e-=i;for(const t of this.belowBeatEffects.values())t.renderer=this.renderer,t.doLayout(),t.y=s,(null===n||n>s)&&(n=s),(null===r||r<s)&&(r=s),s+=t.height+i;null!==n&&t.registerBeatEffectOverflows(n,r??0),this.beat.isTremolo&&!this.beat.deadSlapped&&(this.vT=new Ul(0,0,this.beat.tremoloPicking),this.vT.renderer=this.renderer,this.vT.doLayout(),this.PT())}PT(){const t=this.vT,e=this.direction;e===Wt.Up?t.alignTremoloPickingGlyph(e,this.getHighestNoteY(Bh.TopWithStem),this.getHighestNoteY(Bh.Center),this.beat.duration):t.alignTremoloPickingGlyph(e,this.getLowestNoteY(Bh.BottomWithStem),this.getLowestNoteY(Bh.Center),this.beat.duration),this.NT=t.stemExtensionHeight;let s=this.stemX;this.beat.duration<c.Half&&(s=this.width/2),t.x=s}buildBoundingsLookup(t,e,s){for(const i of this.jS)if(this.xT.has(i.id)){const n=this.xT.get(i.id),r=new pa;r.note=i,r.noteHeadBounds=new Us,r.noteHeadBounds.x=e+this.x+n.x,r.noteHeadBounds.y=s+this.y+n.y-n.height/2,r.noteHeadBounds.w=n.width,r.noteHeadBounds.h=n.height,t.addNote(r)}}paint(t,e,s){this.P_(t,e,s),super.paint(t,e,s)}P_(t,e,s){const i=ao.beat(s,Bt.StandardNotationEffects,this.beat);try{for(const i of this.aboveBeatEffects.values())i.paint(t+this.x+this.width/2,e+this.y,s);for(const i of this.belowBeatEffects.values())i.paint(t+this.x+this.width/2,e+this.y,s);this.vT&&this.vT.paint(t,e,s),this.MT&&this.MT.paint(t,e,s)}finally{i?.[Symbol.dispose]?.()}}}class Xl extends Kh{constructor(t,e,s){super(t,e,1,Xl.getSymbol(s))}static getSymbol(t){switch(t){case c.QuadrupleWhole:return lt.RestLonga;case c.DoubleWhole:return lt.RestDoubleWhole;case c.Whole:return lt.RestWhole;case c.Half:return lt.RestHalf;case c.Quarter:return lt.RestQuarter;case c.Eighth:return lt.Rest8th;case c.Sixteenth:return lt.Rest16th;case c.ThirtySecond:return lt.Rest32nd;case c.SixtyFourth:return lt.Rest64th;case c.OneHundredTwentyEighth:return lt.Rest128th;case c.TwoHundredFiftySixth:return lt.Rest256th;default:return lt.None}}paint(t,e,s){this.internalPaint(t,e,s,Bt.StandardNotationRests)}internalPaint(t,e,s,i){const n=ao.beat(s,i,this.beat);try{super.paint(t,e,s)}finally{n?.[Symbol.dispose]?.()}}}class jl extends $l{Ge;CT=!1;ET=new Map;FT=new hl;AT=null;DT=null;isEmpty=!0;LT;get scale(){return Rr.GraceScale}get hasFlag(){return!1}get hasStem(){return!1}get direction(){return Wt.Up}constructor(t,e,s=!1){super(),this.Ge=e,this.LT=t,this.CT=s,s&&(this.AT=new Il(!0),this.DT=new Il(!1))}getScoreChordNoteHeadInfo(){const t=this.Ge.voice.bar.staff,e=`score.noteheads.${this.LT}.${t.track.index}.${t.index}.${this.Ge.absoluteDisplayStart}`;let s=this.renderer.staff.getSharedLayoutData(e,void 0);return s||(s=new Vl(this.direction),this.renderer.staff.setSharedLayoutData(e,s)),new Vl(this.direction)}containsNoteValue(t){return this.ET.has(t)}getNoteValueY(t){return this.ET.has(t)?this.y+this.ET.get(t).y:0}addGlyph(t,e,s){const i=this.renderer,n=new Ll(0,0,c.Quarter,!0),r=i.accidentalHelper.applyAccidentalForValue(this.Ge,t,e,!0),a=i.accidentalHelper.getNoteStepsForValue(t,!1);if(n.y=i.getScoreY(a),this.CT&&(this.AT.renderer=this.renderer,this.DT.renderer=this.renderer,this.AT.addParenthesisOnSteps(a,!0),this.DT.addParenthesisOnSteps(a,!0)),r!==T.None){const t=new xo(0,n.y,r,Rr.GraceScale);t.renderer=this.renderer,this.FT.renderer=this.renderer,this.FT.addGlyph(t)}this.ET.set(t,n),this.add(n,a),this.isEmpty=!1}doLayout(){let t=0;this.CT&&(this.AT.x=t,this.AT.renderer=this.renderer,this.AT.doLayout(),t+=this.AT.width+this.renderer.smuflMetrics.bendNoteHeadElementPadding),this.FT.isEmpty||(t+=this.FT.width+this.renderer.smuflMetrics.bendNoteHeadElementPadding,this.FT.x=t,this.FT.renderer=this.renderer,this.FT.doLayout(),t+=this.FT.width+this.renderer.smuflMetrics.bendNoteHeadElementPadding),this.noteStartX=t,super.doLayout(),this.CT&&(this.DT.x=this.width+this.renderer.smuflMetrics.bendNoteHeadElementPadding,this.DT.renderer=this.renderer,this.DT.doLayout(),this.width+=this.DT.width+this.renderer.smuflMetrics.bendNoteHeadElementPadding)}paint(t,e,s){this.FT.isEmpty||this.FT.paint(t+this.x,e+this.y,s),this.CT&&(this.AT.paint(t+this.x,e+this.y,s),this.DT.paint(t+this.x,e+this.y,s)),super.paint(t,e,s)}}class Jl extends ro{drawBendSlur(t,e,s,i,n,r,a){Vo.drawBendSlur(t,e,s,i,n,r,this.renderer.smuflMetrics.tieHeight,a)}doLayout(){if(this.glyphs){this.width=0;for(const t of this.glyphs)t.doLayout(),this.width+=t.width}}getTieDirection(t,e){return e.getBeatDirection(t)===Wt.Up?Wt.Down:Wt.Up}}class ql extends Jl{zk;Ge;WT=null;checkForOverflow=!1;constructor(t){super(0,0),this.zk=t,this.Ge=t.beat}get hasBoundingBox(){const t=this.WT;return!!t&&(!!t.minStepsNote&&!!t.maxStepsNote)}getBoundingBoxTop(){return this.WT?.minStepsNote?this.WT.minStepsNote.glyph.getBoundingBoxTop():super.getBoundingBoxTop()}getBoundingBoxBottom(){return this.WT?.maxStepsNote?this.WT.maxStepsNote.glyph.getBoundingBoxBottom():super.getBoundingBoxBottom()}doMultiVoiceLayout(){this.WT?.doMultiVoiceLayout()}doLayout(){const t=this.renderer,e=t.settings.notation.notationMode;switch(this.Ge.whammyBarType){case pt.None:case pt.Custom:case pt.Hold:return;case pt.Dive:case pt.PrediveDive:{const e=new jl("postwhammy",this.Ge,!1);this.WT=e,e.renderer=t;const s=this.Ge.whammyBarPoints[this.Ge.whammyBarPoints.length-1];for(const t of this.Ge.notes)t.isTieOrigin||e.addGlyph(this.OT(t,s),s.value%2!=0,void 0);e.doLayout(),this.addGlyph(e)}break;case pt.Dip:if(e===S.SongBook)return;{const e=new jl("middlewhammy",this.Ge,!1);if(e.renderer=t,t.settings.notation.notationMode===S.GuitarPro){const t=this.Ge.whammyBarPoints[1];for(const s of this.Ge.notes)e.addGlyph(this.OT(s,this.Ge.whammyBarPoints[1]),t.value%2!=0,void 0)}e.doLayout(),this.addGlyph(e);const s=new jl("postwhammy",this.Ge,!1);if(s.renderer=t,this.WT=s,t.settings.notation.notationMode===S.GuitarPro){const t=this.Ge.whammyBarPoints[this.Ge.whammyBarPoints.length-1];for(const e of this.Ge.notes)s.addGlyph(this.OT(e,t),t.value%2!=0,void 0)}s.doLayout(),this.addGlyph(s)}case pt.Predive:}super.doLayout(),this.width=this.width/2}paint(t,e,s){const i=this.Ge;switch(i.whammyBarType){case pt.None:case pt.Custom:return}const n=this.renderer.settings.notation.notationMode,a=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,i.voice.bar),h=ao.beat(s,Bt.StandardNotationEffects,i);try{const h=t+a.x+a.getBeatX(i,bs.MiddleNotes),o=this.getTieDirection(i,a);let c=1===this.Ge.notes.length?o:Wt.Up;const l=s.textAlign,u=this.renderer.smuflMetrics.glyphHeights.get(lt.NoteheadBlack);for(let l=0;l<i.notes.length;l++){const d=i.notes[l],f=ao.note(s,ft.StandardNotationEffects,d);try{let f=e+a.y;l>0&&l>=(this.Ge.notes.length/2|0)&&(c=Wt.Down),c===Wt.Down?f+=a.getNoteY(d,Bh.Bottom):f+=a.getNoteY(d,Bh.Top);let p=t+a.x+a.getBeatX(i,bs.EndBeat);if(p-=this.renderer.smuflMetrics.postNoteEffectPadding,this.WT){p-=this.WT.width-this.WT.onTimeX}const b=i.whammyStyle===r.Gradual&&0===l?"grad.":"";let m=null;d.isTieOrigin&&(m=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,d.tieDestination.beat.voice.bar),m&&m.staff===a.staff?p=t+m.x+m.getBeatX(d.tieDestination.beat,bs.MiddleNotes):m=null);let g=u*Rr.GraceScale*.5;c===Wt.Up&&(g=-g);const w=i.whammyBarPoints.length>0?this.OT(d,i.whammyBarPoints[i.whammyBarPoints.length-1]):0;let y=0,k=!1;switch(this.glyphs&&this.glyphs[0].containsNoteValue(w)?(y=this.glyphs[0].getNoteValueY(w)+g,k=!0):m&&(d.isTieOrigin&&d.tieDestination.beat.hasWhammyBar||d.beat.isContinuedWhammy)?(y=e+m.y+m.getNoteY(d.tieDestination,Bh.Top),k=!0,c===Wt.Down&&(y+=u)):d.isTieOrigin&&(y=m?e+m.y+m.getNoteY(d.tieDestination,Bh.Top):f,c===Wt.Down&&(y+=u)),i.whammyBarType){case pt.Hold:d.isTieOrigin&&Vo.paintTie(s,1,h,f,p,y,o===Wt.Down,this.renderer.smuflMetrics.tieHeight,this.renderer.smuflMetrics.slurMidpointThickness);break;case pt.Dive:if(0===l){const t=this.glyphs[0];t.x=p-t.onTimeX;const i=this.glyphs[0].y;t.y=e+a.y,t.paint(0,0,s),t.containsNoteValue(w)&&(y-=i,y+=t.y)}k?this.drawBendSlur(s,h,f,p,y,c===Wt.Down,b):d.isTieOrigin&&Vo.paintTie(s,1,h,f,p,y,o===Wt.Down,this.renderer.smuflMetrics.tieHeight,this.renderer.smuflMetrics.slurMidpointThickness);break;case pt.Dip:if(n===S.SongBook)d.isTieOrigin&&Vo.paintTie(s,1,h,f,p,y,o===Wt.Down,this.renderer.smuflMetrics.tieHeight,this.renderer.smuflMetrics.slurMidpointThickness);else{const t=(h+p)/2,n=this.glyphs[0];n.x=t-n.onTimeX,n.y=e+a.y,n.paint(0,0,s);const r=this.OT(d,i.whammyBarPoints[1]),o=n.getNoteValueY(r)+g;this.drawBendSlur(s,h,f,t,o,c===Wt.Down,b);const l=this.glyphs[1];l.x=p-l.onTimeX,l.y=e+a.y,l.paint(0,0,s),y=l.getNoteValueY(w)+g,this.drawBendSlur(s,t,o,p,y,c===Wt.Down,b)}break;case pt.PrediveDive:case pt.Predive:let r=t+a.x+a.getBeatX(d.beat,bs.PreNotes);r+=this.zk.prebendNoteHeadOffset;const u=e+a.y+a.getScoreY(a.accidentalHelper.getNoteStepsForValue(d.displayValue-(d.beat.whammyBarPoints[0].value/2|0),!1))+g;if(this.drawBendSlur(s,r,u,h,f,c===Wt.Down,b),this.glyphs){const t=this.glyphs[0];t.x=p-t.onTimeX,t.y=e+a.y,t.paint(0,0,s),this.drawBendSlur(s,h,f,p,y,c===Wt.Down,b)}}}finally{f?.[Symbol.dispose]?.()}}s.textAlign=l}finally{h?.[Symbol.dispose]?.()}}OT(t,e){return t.displayValueWithoutBend+(e.value/2|0)}}class Yl extends Dl{beatEffects=new Map;noteHeadElement=ft.SlashNoteHead;effectElement=Bt.SlashEffects;stemX=0;constructor(t,e,s){super(t,e,s.graceType!==l.None,Yl.getSymbol(s.duration)),this.beat=s}paint(t,e,s){const i=0===this.beat.notes.length?void 0:ao.note(s,this.noteHeadElement,this.beat.notes[0]);try{super.paint(t,e,s),this.P_(t,e,s)}finally{i?.[Symbol.dispose]?.()}}P_(t,e,s){const i=ao.beat(s,this.effectElement,this.beat);try{for(const i of this.beatEffects.values())i.paint(t+this.x,e+this.y,s)}finally{i?.[Symbol.dispose]?.()}}doLayout(){super.doLayout();const t=this.renderer,e=t.smuflMetrics.onNoteEffectPadding;let s=t.smuflMetrics.glyphHeights.get(this.symbol),i=Number.NaN,n=Number.NaN;for(const r of this.beatEffects.values())r.y+=s,r.x+=this.width/2,r.renderer=t,s+=r.height+e,r.doLayout(),(Number.isNaN(i)||i>s)&&(i=s),(Number.isNaN(n)||n<s)&&(n=s);Number.isNaN(i)||t.registerBeatEffectOverflows(i,n);const r=t.getBeatDirection(this.beat),a=this.symbol;if(r===Wt.Up){const e=t.smuflMetrics.stemUp.has(a)?t.smuflMetrics.stemUp.get(a).x:0;this.stemX=e}else{const e=t.smuflMetrics.stemDown.has(a)?t.smuflMetrics.stemDown.get(a).x:0;this.stemX=e}}static getSymbol(t){switch(t){case c.QuadrupleWhole:case c.DoubleWhole:case c.Whole:return lt.NoteheadSlashWhiteWhole;case c.Half:return lt.NoteheadSlashWhiteHalf;default:return lt.NoteheadSlashHorizontalEnds}}}class Kl extends Fh{RT=new Set;addString(t){this.RT.add(t)}doLayout(){const t=this.renderer.smuflMetrics.glyphWidths.get(lt.GuitarString0)*this.renderer.smuflMetrics.tuningGlyphCircleNumberScale;this.height=(t+this.renderer.smuflMetrics.stringNumberCirclePadding)*this.RT.size,this.width=t}paint(t,e,s){const i=this.renderer.bar.staff.tuning.length;let n=0;const r=this.renderer.smuflMetrics.glyphWidths.get(lt.GuitarString0)*this.renderer.smuflMetrics.tuningGlyphCircleNumberScale;for(const a of this.RT){const h=i-a,o=lt.GuitarString1+h;Rt.fillMusicFontSymbolSafe(s,t+this.x,e+this.y+r+n,this.renderer.smuflMetrics.tuningGlyphCircleNumberScale,o,!0),n+=r+this.renderer.smuflMetrics.stringNumberCirclePadding}}}class Ql extends ll{IT=Number.NaN;GT=!1;HT;noteHeads=null;restGlyph=null;get effectElement(){return Bt.StandardNotationEffects}buildBoundingsLookup(t,e,s){this.noteHeads&&this.noteHeads.buildBoundingsLookup(t,e+this.x,s+this.y)}getBoundingBoxTop(){let t=this.y;return this.noteHeads?t=this.noteHeads.getBoundingBoxTop():this.restGlyph&&(t=this.restGlyph.getBoundingBoxTop()),this.HT?.hasBoundingBox&&(t=Math.min(t,this.HT.getBoundingBoxTop())),t}getBoundingBoxBottom(){let t=this.y+this.height;return this.noteHeads?t=this.noteHeads.getBoundingBoxBottom():this.restGlyph&&(t=this.restGlyph.getBoundingBoxBottom()),this.HT?.hasBoundingBox&&(t=Math.max(t,this.HT.getBoundingBoxBottom())),t}getLowestNoteY(t){return this.noteHeads?this.noteHeads.getLowestNoteY(t):0}getHighestNoteY(t){return this.noteHeads?this.noteHeads.getHighestNoteY(t):0}getNoteY(t,e){return t.beat.slashed&&(t=t.beat.notes[0]),this.noteHeads?this.noteHeads.getNoteY(t,e):0}getNoteX(t,e){return t.beat.slashed&&(t=t.beat.notes[0]),this.noteHeads?this.noteHeads.getNoteX(t,e):0}getRestY(t){const e=this.restGlyph;if(e)switch(t){case Bh.TopWithStem:return e.getBoundingBoxTop()-this.renderer.smuflMetrics.getStemLength(c.Quarter,!0);case Bh.Top:return e.getBoundingBoxTop();case Bh.Center:case Bh.StemUp:case Bh.StemDown:return e.getBoundingBoxTop()+e.height/2;case Bh.Bottom:return e.getBoundingBoxBottom();case Bh.BottomWithStem:return e.getBoundingBoxBottom()+this.renderer.smuflMetrics.getStemLength(c.Quarter,!0)}return 0}applyRestCollisionOffset(){if(this.restGlyph&&Number.isNaN(this.IT)){this.IT=this.renderer.collisionHelper.applyRestCollisionOffset(this.container.beat,this.restGlyph.y,this.renderer.getScoreHeight(1)),this.y+=this.IT;const t=this.renderer.collisionHelper.restDurationsByDisplayTime;t.has(this.container.beat.playbackStart)&&t.get(this.container.beat.playbackStart).has(this.container.beat.playbackDuration)&&t.get(this.container.beat.playbackStart).get(this.container.beat.playbackDuration)!==this.container.beat.id&&(this.GT=!0)}}paint(t,e,s){this.GT||super.paint(t,e,s)}doMultiVoiceLayout(){this.applyRestCollisionOffset(),this.noteHeads?.doMultiVoiceLayout(),this.HT?.doMultiVoiceLayout();let t=0;if(this.glyphs)for(const e of this.glyphs)e.x=t,t+=e.width;this.width=t,this.computedWidth=t,this.VT()}doLayout(){this.xB(),super.doLayout(),this.VT()}VT(){this.container.beat.isEmpty?(this.onTimeX=this.width/2,this.middleX=this.onTimeX,this.stemX=this.middleX):this.restGlyph?(this.onTimeX=this.restGlyph.x+this.restGlyph.width/2,this.middleX=this.onTimeX,this.stemX=this.middleX):this.noteHeads&&(this.onTimeX=this.noteHeads.x+this.noteHeads.onTimeX,this.middleX=this.noteHeads.x+this.noteHeads.width/2,this.stemX=this.noteHeads.x+this.noteHeads.stemX)}xB(){this.container.beat.isEmpty||(this.container.beat.isRest?this.$T():this.UT())}UT(){const t=this.renderer,e=new zl;this.noteHeads=e,e.beat=this.container.beat;const s=new Il(!1);if(s.renderer=this.renderer,this.container.beat.slashed){const e=t.heightLineCount-1,s=new Yl(0,t.getScoreY(e),this.container.beat);s.colorOverride=ao.noteColor(t.resources,ft.StandardNotationNoteHead,this.container.beat.notes[0]),this.noteHeads.addMainNoteGlyph(s,this.container.beat.notes[0],e)}else for(const t of this.container.beat.notes)t.isVisible&&(this.zT(t),s.addParenthesis(t));if(this.addNormal(e),s.isEmpty||this.addEffect(s),this.container.beat.hasWhammyBar){const t=new ql(this.container);this.HT=t,t.renderer=this.renderer,t.doLayout(),this.container.addTie(t)}if(this.container.beat.dots>0)for(let e=0;e<this.container.beat.dots;e++){const e=new ro(0,0);e.renderer=this.renderer;for(const s of this.container.beat.notes){this.XT(t.getNoteSteps(s),e).colorOverride=ao.noteColor(t.resources,ft.StandardNotationEffects,s)}this.addEffect(e)}if(this.renderer.bar.isMultiVoice){let e=0,s=0;const i=t.getBeatDirection(this.container.beat);let n=0;this.container.beat.hasTuplet&&(n+=t.tupletOffset+t.tupletSize),i===Wt.Up?(e=this.getHighestNoteY(Bh.TopWithStem)-n,s=this.getLowestNoteY(Bh.Bottom)):(e=this.getHighestNoteY(Bh.Top),s=this.getLowestNoteY(Bh.BottomWithStem)+n),this.renderer.collisionHelper.reserveBeatSlot(this.container.beat,e,s)}}$T(){const t=this.renderer;let e=2*Math.ceil((this.renderer.bar.staff.standardNotationLineCount-1)/2);this.container.beat.duration===c.Whole&&1!==this.renderer.bar.staff.standardNotationLineCount&&3!==this.renderer.bar.staff.standardNotationLineCount&&(e-=2);const s=new Xl(0,t.getScoreY(e),this.container.beat.duration);if(this.restGlyph=s,s.beat=this.container.beat,this.addNormal(s),this.renderer.bar.isMultiVoice)if(0===this.container.beat.voice.index){const e=qo.computeLineHeightsForRest(this.container.beat.duration),i=s.y-t.getScoreHeight(e[0]),n=s.y+t.getScoreHeight(e[1]);this.renderer.collisionHelper.reserveBeatSlot(this.container.beat,i,n)}else this.renderer.collisionHelper.registerRest(this.container.beat);if(this.container.beat.dots>0)for(let t=0;t<this.container.beat.dots;t++){const t=new ro(0,0);t.renderer=this.renderer,this.XT(e,t),this.addEffect(t)}}XT(t,e){const s=this.renderer,i=new ol(0,s.getScoreY(t));return e.addGlyph(i),i}jT(t){const e=this.container.beat.graceType!==l.None,s=t.style;if(void 0!==s?.noteHead){const i=new Ll(0,0,t.beat.duration,e);return i.symbol=s.noteHead,s.noteHeadCenterOnStem&&(i.centerOnStem=!0),i}if(t.beat.voice.bar.staff.isPercussion){const s=Jt.getArticulation(t);if(s)return new Gl(0,0,s,t.beat.duration,e);J.warning("Rendering",`No articulation found for percussion instrument ${t.percussionArticulation}`)}return t.isDead?new Wl(0,0,e):t.beat.graceType===l.BendGrace?new Ll(0,0,c.Quarter,!0):t.harmonicType===f.Natural?new Ol(0,0,t.beat.duration,e):new Ll(0,0,t.beat.duration,e)}zT(t){if(t.beat.graceType===l.BendGrace&&!t.hasBend)return;const e=this.renderer,s=this.jT(t);s.colorOverride=ao.noteColor(e.resources,ft.StandardNotationNoteHead,t);let i=e.getNoteSteps(t);if(s.y=e.getScoreY(i),this.noteHeads.addMainNoteGlyph(s,t,i),!t.beat.slashed&&t.harmonicType!==f.None&&t.harmonicType!==f.Natural){const n=t.displayValue+t.harmonicPitch,r=new Ol(0,0,t.beat.duration,this.container.beat.graceType!==l.None);r.colorOverride=s.colorOverride,i=e.accidentalHelper.getNoteStepsForValue(n,!1),r.y=e.getScoreY(i),this.noteHeads.addEffectNoteGlyph(r,i)}const n=this.noteHeads.belowBeatEffects,r=this.noteHeads.aboveBeatEffects,a=e.getBeatDirection(this.container.beat)===Wt.Up?this.noteHeads.belowBeatEffects:this.noteHeads.aboveBeatEffects;if(t.isStaccato&&!n.has("Staccato")&&a.set("Staccato",new Al(0,0)),t.accentuated!==u.Normal||n.has("Accent")||a.set("Accent",new Fl(0,0,t)),t.accentuated!==u.Heavy||n.has("HAccent")||a.set("HAccent",new Fl(0,0,t)),t.accentuated!==u.Tenuto||n.has("Tenuto")||a.set("Tenuto",new Fl(0,0,t)),t.showStringNumber&&t.isStringed){let e;r.has("StringNumber")?e=r.get("StringNumber"):(e=new Kl(0,0),r.set("StringNumber",e)),e.addString(t.string)}if(t.isPercussion){const e=Jt.getArticulation(t);if(e&&e.techniqueSymbolPlacement!==ut.Inside){let t;switch(e.techniqueSymbolPlacement){case ut.Above:t=this.noteHeads.aboveBeatEffects;break;case ut.Below:t=this.noteHeads.belowBeatEffects;break;case ut.Outside:t=a;break;default:return}switch(e.techniqueSymbol){case lt.PictEdgeOfCymbal:t.set("PictEdgeOfCymbal",new Hl(0,0));break;case lt.ArticStaccatoAbove:t.set("ArticStaccatoAbove",new Al(0,0));break;case lt.StringsUpBow:t.set("StringsUpBow",new Fo(0,0,ct.Up));break;case lt.StringsDownBow:t.set("StringsDownBow",new Fo(0,0,ct.Down));break;case lt.GuitarGolpe:t.set("GuitarGolpe",new fo(0,0,!0))}}}}}class Zl extends Oa{Ge;JT;constructor(t){super(0,0),this.Ge=t}doLayout(){if(this.Ge.brushType===h.ArpeggioUp||this.Ge.brushType===h.ArpeggioDown){const t=new ic(0,0,w.Slight,!0);t.renderer=this.renderer,t.doLayout(),this.JT=t,this.width=t.height}else this.width=0}paint(t,e,s){if(this.Ge.brushType===h.ArpeggioUp||this.Ge.brushType===h.ArpeggioDown){const i=this.renderer,n=i.lineOffset,r=e+this.y+(i.getNoteY(this.Ge.maxNote,Bh.Bottom)-n),a=e+this.y+i.getNoteY(this.Ge.minNote,Bh.Top)+n,o=t+this.x+this.width/2,c=this.renderer.smuflMetrics.glyphWidths.get(lt.ArrowheadBlackDown),l=this.JT;if(this.Ge.brushType===h.ArpeggioUp){const e=r+c,i=a-c;l.width=Math.abs(i-e),s.beginRotate(t+this.x,i,-90),l.paint(0,0,s),s.endRotate(),s.beginPath(),s.moveTo(o,a),s.lineTo(o+c/2,a-c),s.lineTo(o-c/2,a-c),s.closePath(),s.fill()}else if(this.Ge.brushType===h.ArpeggioDown){const e=r+c,i=a;l.width=Math.abs(i-e),s.beginRotate(t+this.x,e,90),l.paint(0,-l.height,s),s.endRotate(),s.beginPath(),s.moveTo(o,r),s.lineTo(o+c/2,r+c),s.lineTo(o-c/2,r+c),s.closePath(),s.fill()}}}}class tu extends cl{qT=null;get prebendNoteHeadOffset(){return this.qT?this.qT.x+this.qT.onTimeX:0}get effectElement(){return Bt.StandardNotationEffects}accidentals=null;doMultiVoiceLayout(){this.qT?.doMultiVoiceLayout()}doLayout(){this.container.beat.isRest||this.xB(),super.doLayout()}xB(){const t=new hl;t.renderer=this.renderer;const e=new co;e.renderer=this.renderer;const s=new Il(!0);s.renderer=this.renderer;let i=null,n=!1;for(const r of this.container.beat.notes){const h=ao.noteColor(this.renderer.resources,ft.StandardNotationEffects,r);if(r.isVisible){if(r.hasBend)switch(r.bendType){case a.PrebendBend:case a.Prebend:case a.PrebendRelease:i||(i=new jl("prebend",this.container.beat,!0),i.renderer=this.renderer),i.addGlyph(r.displayValue-(r.bendPoints[0].value/2|0),!1,h)}else if(r.beat.hasWhammyBar)switch(r.beat.whammyBarType){case pt.PrediveDive:case pt.Predive:i||(i=new jl("prebend",this.container.beat,!0),i.renderer=this.renderer),i.addGlyph(r.displayValue-(r.beat.whammyBarPoints[0].value/2|0),!1,h)}switch(this.YT(r,t),s.addParenthesis(r),e.addFingers(r),r.slideInType){case m.IntoFromBelow:case m.IntoFromAbove:n=!0}}}n&&this.addNormal(new fl(0,0,this.renderer.smuflMetrics.simpleSlideWidth*(this.container.beat.graceType!==l.None?Rr.GraceScale:1))),this.qT=i,i&&(this.addEffect(i),this.addNormal(new fl(0,0,this.renderer.smuflMetrics.preNoteEffectPadding*(this.container.beat.graceType!==l.None?Rr.GraceScale:1)))),this.container.beat.brushType!==h.None&&(this.addEffect(new Zl(this.container.beat)),this.addNormal(new fl(0,0,this.renderer.smuflMetrics.preNoteEffectPadding*(this.container.beat.graceType!==l.None?Rr.GraceScale:1)))),e.isEmpty||(this.isEmpty||this.addNormal(new fl(0,0,this.renderer.smuflMetrics.preNoteEffectPadding*(this.container.beat.graceType!==l.None?Rr.GraceScale:1))),this.addEffect(e),this.addNormal(new fl(0,0,this.renderer.smuflMetrics.preNoteEffectPadding*(this.container.beat.graceType!==l.None?Rr.GraceScale:1)))),s.isEmpty||this.addEffect(s),t.isEmpty||(this.accidentals=t,this.isEmpty||this.addNormal(new fl(0,0,this.renderer.smuflMetrics.preNoteEffectPadding*(this.container.beat.graceType!==l.None?Rr.GraceScale:1))),this.addNormal(t),this.addNormal(new fl(0,0,this.renderer.smuflMetrics.preNoteEffectPadding*(this.container.beat.graceType!==l.None?Rr.GraceScale:1))))}YT(t,e){const s=this.renderer;let i=s.accidentalHelper.applyAccidental(t),n=s.getNoteSteps(t);const r=this.container.beat.graceType!==l.None,a=ao.noteColor(s.resources,ft.StandardNotationAccidentals,t),h=r?Rr.GraceScale:1;if(i!==T.None){const t=new xo(0,s.getScoreY(n),i,h);t.colorOverride=a,t.renderer=this.renderer,e.addGlyph(t)}if(t.harmonicType!==f.None&&t.harmonicType!==f.Natural){const o=t.displayValue+t.harmonicPitch;i=s.accidentalHelper.applyAccidentalForValue(t.beat,o,r,!1),n=s.accidentalHelper.getNoteStepsForValue(o,!1);const c=new xo(0,s.getScoreY(n),i,h);c.colorOverride=a,c.renderer=this.renderer,e.addGlyph(c)}}}class eu extends Jl{Ge;jS=[];KT=null;QT=null;zk;checkForOverflow=!1;constructor(t){super(0,0),this.Ge=t.beat,this.zk=t}doLayout(){super.doLayout(),this.width=0}getBoundingBoxTop(){return super.getBoundingBoxTop()-this.ZT(Wt.Up)}getBoundingBoxBottom(){return super.getBoundingBoxBottom()+this.ZT(Wt.Down)}doMultiVoiceLayout(){this.QT?.doMultiVoiceLayout(),this.KT?.doMultiVoiceLayout()}ZT(t){const e=this.getTieDirection(this.Ge,this.renderer);if(e!==t)return 0;let s=0;for(const t of this.jS){if(t.isTieOrigin)continue;switch(t.bendType){case a.Custom:case a.Prebend:case a.Hold:continue}const i=2*this.renderer.getBeatContainer(this.Ge).width;let n=0,h=0;switch(t.bendType){case a.Bend:case a.PrebendBend:n=this.KT.minStepsNote.glyph.getBoundingBoxTop(),h=i;break;case a.BendRelease:n=this.QT.minStepsNote.glyph.getBoundingBoxTop(),h=i/2;break;case a.Release:case a.PrebendRelease:n=this.KT.maxStepsNote.glyph.getBoundingBoxTop(),h=i}const o=this.renderer.getNoteY(t,Bh.Top);let c=Math.abs(Vo.calculateBendSlurTopY(0,o,h,n,e===Wt.Down,1,this.renderer.smuflMetrics.tieHeight)-n);if(t.bendStyle===r.Gradual){const t=this.renderer.resources,e=this.renderer.scoreRenderer.canvas;e.font=t.elementFonts.get(B.ScoreBendSlur),c+=e.measureText("grad.").height}c>s&&(s=c)}return s}addBends(t){if(this.jS.push(t),t.isTieOrigin)return;const e=ao.noteColor(this.renderer.resources,ft.StandardNotationEffects,t);switch(t.bendType){case a.Bend:case a.PrebendRelease:case a.PrebendBend:{let s=this.KT;s||(s=new jl("postbend",t.beat,!1),s.renderer=this.renderer,this.KT=s,this.addGlyph(s));const i=t.bendPoints[t.bendPoints.length-1];s.addGlyph(this.OT(t,i),i.value%2!=0,e)}break;case a.Release:if(!t.isTieOrigin){let s=this.KT;s||(s=new jl("postbend",t.beat,!1),s.renderer=this.renderer,this.KT=s,this.addGlyph(s));const i=t.bendPoints[t.bendPoints.length-1];s.addGlyph(this.OT(t,i),i.value%2!=0,e)}break;case a.BendRelease:{let s=this.QT;s||(s=new jl("middlebend",t.beat,!1),this.QT=s,s.renderer=this.renderer,this.addGlyph(s));const i=t.bendPoints[1];s.addGlyph(this.OT(t,t.bendPoints[1]),i.value%2!=0,e);let n=this.KT;n||(n=new jl("postbend",t.beat,!1),n.renderer=this.renderer,this.KT=n,this.addGlyph(n));const r=t.bendPoints[t.bendPoints.length-1];n.addGlyph(this.OT(t,r),r.value%2!=0,e)}}}paint(t,e,s){const i=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,this.Ge.voice.bar),n=t+i.x+i.getBeatX(this.Ge,bs.MiddleNotes);let r=t+i.x;if(this.Ge.isLastOfVoice?r+=i.getBeatX(this.Ge,bs.EndBeat):r+=i.getBeatX(this.Ge.nextBeat,bs.PreNotes),r-=this.renderer.smuflMetrics.postNoteEffectPadding,this.KT){r-=this.KT.width-this.KT.onTimeX}const a=(n+r)/2;this.QT&&(this.QT.x=a-this.QT.onTimeX,this.QT.y=e+i.y,this.QT.paint(0,0,s)),this.KT&&(this.KT.x=r-this.KT.onTimeX,this.KT.y=e+i.y,this.KT.paint(0,0,s)),this.jS.sort((t,e)=>e.displayValue-t.displayValue),this.renderer.settings.notation.isNotationElementVisible(B.ScoreBendSlur)&&this.tx(t,e,s,i,n,a,r)}tx(t,e,s,i,n,h,o){const c=this.Ge.graceType===l.BendGrace?this.Ge.nextBeat:this.Ge;let u=1===this.jS.length?this.getTieDirection(c,i):Wt.Up;const d=this.renderer.smuflMetrics.glyphHeights.get(lt.NoteheadBlack);s.font=this.renderer.resources.elementFonts.get(B.ScoreBendSlur);for(let c=0;c<this.jS.length;c++){const l=this.jS[c],f=ao.note(s,ft.StandardNotationEffects,l);try{c>0&&c>=(this.jS.length/2|0)&&(u=Wt.Down);let f=e+i.y+i.getNoteY(l,Bh.Top),p=d*Rr.GraceScale*.5;u===Wt.Down&&(f+=d);const b=l.bendStyle===r.Gradual?"grad.":"";if(l.isTieOrigin){const r=l.tieDestination,h=r?this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,r.beat.voice.bar):null;if(h&&h.staff===i.staff){const i=t+h.x+h.getBeatX(r.beat,bs.MiddleNotes);let o=e+h.y+h.getNoteY(r,Bh.Top);u===Wt.Down&&(o+=d),l.bendType===a.Hold||l.bendType===a.Prebend?Vo.paintTie(s,1,n,f,i,o,u===Wt.Down,this.renderer.smuflMetrics.tieHeight,this.renderer.smuflMetrics.slurMidpointThickness):this.drawBendSlur(s,n,f,i,o,u===Wt.Down,b)}else{const r=t+i.x+i.width,h=l.tieDestination.displayValue;i.accidentalHelper.applyAccidentalForValue(l.beat,h,!1,!0);const o=e+i.y+i.getScoreY(i.accidentalHelper.getNoteStepsForValue(h,!1));l.bendType===a.Hold||l.bendType===a.Prebend?Vo.paintTie(s,1,n,f,r,o,u===Wt.Down,this.renderer.smuflMetrics.tieHeight,this.renderer.smuflMetrics.slurMidpointThickness):this.drawBendSlur(s,n,f,r,o,u===Wt.Down,b)}switch(l.bendType){case a.Prebend:case a.PrebendBend:case a.PrebendRelease:let r=t+i.x+i.getBeatX(l.beat,bs.PreNotes);r+=this.zk.prebendNoteHeadOffset;const h=e+i.y+i.getScoreY(i.accidentalHelper.getNoteStepsForValue(l.displayValue-(l.bendPoints[0].value/2|0),!1))+p;this.drawBendSlur(s,r,h,n,f,u===Wt.Down)}}else{u===Wt.Up&&(p=-p);let r=0,c=0;switch(l.bendType){case a.Bend:r=this.OT(l,l.bendPoints[l.bendPoints.length-1]),c=this.KT.getNoteValueY(r)+p,this.drawBendSlur(s,n,f,o,c,u===Wt.Down,b);break;case a.BendRelease:const d=this.OT(l,l.bendPoints[1]),m=this.QT.getNoteValueY(d)+p;this.drawBendSlur(s,n,f,h,m,u===Wt.Down,b),r=this.OT(l,l.bendPoints[l.bendPoints.length-1]),c=this.KT.getNoteValueY(r)+p,this.drawBendSlur(s,h,m,o,c,u===Wt.Down,b);break;case a.Release:this.glyphs&&(r=this.OT(l,l.bendPoints[l.bendPoints.length-1]),c=this.glyphs[0].getNoteValueY(r)+p,this.drawBendSlur(s,n,f,o,c,u===Wt.Down,b));break;case a.Prebend:case a.PrebendBend:case a.PrebendRelease:let g=t+i.x+i.getBeatX(l.beat,bs.PreNotes);g+=this.zk.prebendNoteHeadOffset;const w=e+i.y+i.getScoreY(i.accidentalHelper.getNoteStepsForValue(l.displayValue-(l.bendPoints[0].value/2|0),!1))+p;this.drawBendSlur(s,g,w,n,f,u===Wt.Down),this.glyphs&&(r=this.OT(l,l.bendPoints[l.bendPoints.length-1]),c=this.glyphs[0].getNoteValueY(r)+p,this.drawBendSlur(s,n,f,o,c,u===Wt.Down,b))}}}finally{f?.[Symbol.dispose]?.()}}}OT(t,e){return t.displayValueWithoutBend+(e.value/2|0)}}class su extends Vo{startBeat;endBeat;startBeatRenderer=null;endBeatRenderer=null;constructor(t,e,s,i){super(t,i),this.startBeat=e,this.endBeat=s}doLayout(){super.doLayout()}lookupStartBeatRenderer(){return this.startBeatRenderer||(this.startBeatRenderer=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,this.startBeat.voice.bar)),this.startBeatRenderer}lookupEndBeatRenderer(){return this.endBeatRenderer||(this.endBeatRenderer=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,this.endBeat.voice.bar)),this.endBeatRenderer}shouldDrawBendSlur(){return!1}calculateTieDirection(){return this.startBeat.isRest?Wt.Up:this.lookupStartBeatRenderer().getBeatDirection(this.startBeat)===Wt.Up?Wt.Down:Wt.Up}calculateStartX(){const t=this.lookupStartBeatRenderer();return t.x+t.getBeatX(this.startBeat,bs.MiddleNotes)}calculateStartY(){const t=this.lookupStartBeatRenderer();return this.startBeat.isRest?this.tieDirection===Wt.Up?t.y+t.getRestY(this.startBeat,Bh.Top):t.y+t.getRestY(this.startBeat,Bh.Bottom):this.tieDirection===Wt.Up?t.y+t.getNoteY(this.startBeat.maxNote,Bh.Top):t.y+t.getNoteY(this.startBeat.minNote,Bh.Bottom)}calculateEndX(){const t=this.lookupEndBeatRenderer();if(!t)return this.calculateStartX()+this.renderer.smuflMetrics.leftHandTabTieWidth;const e=t.getBeatDirection(this.endBeat);return t.x+t.getBeatX(this.endBeat,this.endBeat.duration>c.Whole&&e===this.tieDirection?bs.Stem:bs.MiddleNotes)}caclculateEndY(){const t=this.lookupEndBeatRenderer();if(!t)return this.calculateStartY();if(this.endBeat.isRest)return this.tieDirection===Wt.Up?t.y+t.getRestY(this.endBeat,Bh.Top):t.y+t.getRestY(this.endBeat,Bh.Bottom);const e=this.lookupStartBeatRenderer().getBeatDirection(this.startBeat),s=t.getBeatDirection(this.endBeat);return e!==s&&this.startBeat.graceType===l.None?s===this.tieDirection?this.tieDirection===Wt.Up?t.y+t.getNoteY(this.endBeat.maxNote,Bh.TopWithStem):t.y+t.getNoteY(this.endBeat.minNote,Bh.BottomWithStem):this.tieDirection===Wt.Up?t.y+t.getNoteY(this.endBeat.maxNote,Bh.BottomWithStem):t.y+t.getNoteY(this.endBeat.minNote,Bh.TopWithStem):this.tieDirection===Wt.Up?t.y+t.getNoteY(this.endBeat.maxNote,Bh.Top):t.y+t.getNoteY(this.endBeat.minNote,Bh.Bottom)}}class iu extends Oa{sx;ix;nx;hx;checkForOverflow=!1;constructor(t,e,s,i){super(0,0),this.sx=e,this.ix=t,this.nx=s,this.hx=i}doLayout(){this.width=0}paint(t,e,s){this.ox(t,e,s),this.lx(t,e,s)}ox(t,e,s){const i=this.renderer,n=i.smuflMetrics.simpleSlideWidth;let r=t+i.x+i.getNoteX(this.nx,_h.Left)-i.smuflMetrics.preNoteEffectPadding;const a=e+i.y+i.getNoteY(this.nx,Bh.Center);let h=r-n,o=e+i.y;switch(this.ix){case m.IntoFromBelow:o+=i.getNoteY(this.nx,Bh.Bottom);break;case m.IntoFromAbove:o+=i.getNoteY(this.nx,Bh.Top);break;default:return}const c=this.ux(i,this.nx.beat);h-=c,r-=c,this.bx(s,!1,h,r,o,a)}ux(t,e){return t.getBeatContainer(e).accidentalsWidth}lx(t,e,s){const i=this.renderer,n=i.smuflMetrics.simpleSlideWidth,r=i.smuflMetrics.postNoteEffectPadding;let a=0,h=0,o=0,c=0,l=!1;switch(this.sx){case g.Shift:case g.Legato:if(a=t+i.x+i.getBeatX(this.nx.beat,bs.PostNotes)+r,h=e+i.y+i.getNoteY(this.nx,Bh.Center),this.nx.slideTarget){const s=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,this.nx.slideTarget.beat.voice.bar);s&&s.staff===i.staff?(o=t+s.x+s.getBeatX(this.nx.slideTarget.beat,bs.PreNotes)-r,c=e+s.y+s.getNoteY(this.nx.slideTarget,Bh.Center)):(o=t+i.x+i.width,c=this.nx.slideTarget.realValue>this.nx.realValue?e+i.y+i.getNoteY(this.nx,Bh.Top):e+i.y+i.getNoteY(this.nx,Bh.Bottom))}else o=t+i.x+this.hx.x,c=h;break;case g.OutUp:a=t+i.x+i.getNoteX(this.nx,_h.Right)+r,h=e+i.y+i.getNoteY(this.nx,Bh.Center),o=a+n,c=e+i.y+i.getNoteY(this.nx,Bh.Top);break;case g.OutDown:a=t+i.x+i.getNoteX(this.nx,_h.Right)+r,h=e+i.y+i.getNoteY(this.nx,Bh.Center),o=a+n,c=e+i.y+i.getNoteY(this.nx,Bh.Bottom);break;case g.PickSlideUp:a=t+i.x+i.getNoteX(this.nx,_h.Right)+2*r,h=e+i.y+i.getNoteY(this.nx,Bh.Center),c=e+i.y+i.getNoteY(this.nx,Bh.Top),o=t+i.x+i.width,this.nx.beat.nextBeat&&this.nx.beat.nextBeat.voice===this.nx.beat.voice&&(o=t+i.x+i.getBeatX(this.nx.beat.nextBeat,bs.PreNotes)),l=!0;break;case g.PickSlideDown:a=t+i.x+i.getNoteX(this.nx,_h.Right)+2*r,h=e+i.y+i.getNoteY(this.nx,Bh.Center),c=e+i.y+i.getNoteY(this.nx,Bh.Bottom),o=t+i.x+i.width,this.nx.beat.nextBeat&&this.nx.beat.nextBeat.voice===this.nx.beat.voice&&(o=t+i.x+i.getBeatX(this.nx.beat.nextBeat,bs.PreNotes)),l=!0;break;default:return}this.bx(s,l,a,o,h,c)}bx(t,e,s,i,n,r){if(e){const e=new ic(0,0,w.Slight);e.renderer=this.renderer,e.doLayout(),n-=e.height/2;const a=i-s,h=(r-=e.height/2)-n,o=Math.sqrt(Math.pow(h,2)+Math.pow(a,2));e.width=a;const c=Math.asin(h/o)*(180/Math.PI);t.beginRotate(s,n,c),e.paint(0,0,t),t.endRotate()}else t.beginPath(),t.moveTo(s,n),t.lineTo(i,r),t.stroke()}}class nu extends $o{shouldDrawBendSlur(){return this.renderer.settings.notation.extendBendArrowsOnTiedNotes&&!!this.startNote.bendOrigin&&this.startNote.isTieOrigin}calculateStartX(){return this.isLeftHandTap?this.calculateEndX()-this.renderer.smuflMetrics.leftHandTabTieWidth:this.renderer.x+this.renderer.getBeatX(this.startNote.beat,bs.PostNotes)}calculateEndX(){const t=this.lookupEndBeatRenderer();return t?this.isLeftHandTap?t.x+t.getNoteX(this.endNote,_h.Left):t.x+t.getBeatX(this.endNote.beat,bs.PreNotes):this.calculateStartX()+this.renderer.smuflMetrics.leftHandTabTieWidth}}class ru extends nu{getTieHeight(t,e,s,i){return Math.log2(s-t+1)*this.renderer.settings.notation.slurHeight/2}calculateStartX(){return this.renderer.x+(this.mx()?this.renderer.getBeatX(this.startNote.beat,bs.MiddleNotes):this.renderer.getNoteX(this.startNote,_h.Right))}calculateStartY(){return this.mx()?this.tieDirection===Wt.Up?this.renderer.y+this.renderer.getNoteY(this.startNote,Bh.Top):this.renderer.y+this.renderer.getNoteY(this.startNote,Bh.Bottom):this.renderer.y+this.renderer.getNoteY(this.startNote,Bh.Center)}calculateEndX(){const t=this.lookupEndBeatRenderer();return t?this.gx()?this.wx()?t.x+t.getBeatX(this.endNote.beat,bs.Stem):t.x+t.getNoteX(this.endNote,_h.Center):t.x+t.getBeatX(this.endNote.beat,bs.PreNotes):this.calculateStartX()+this.renderer.smuflMetrics.leftHandTabTieWidth}caclculateEndY(){const t=this.lookupEndBeatRenderer();return t?this.gx()?this.wx()?this.tieDirection===Wt.Up?t.y+t.getNoteY(this.endNote,Bh.TopWithStem):t.y+t.getNoteY(this.endNote,Bh.BottomWithStem):this.tieDirection===Wt.Up?t.y+t.getNoteY(this.endNote,Bh.Top):t.y+t.getNoteY(this.endNote,Bh.Bottom):t.y+t.getNoteY(this.endNote,Bh.Center):this.calculateStartY()}mx(){return this.startNote===this.startNote.beat.maxNote&&this.tieDirection===Wt.Up||this.startNote===this.startNote.beat.minNote&&this.tieDirection===Wt.Down}gx(){return this.startNote.beat.graceType===l.None&&(this.endNote===this.endNote.beat.maxNote&&this.tieDirection===Wt.Up||this.endNote===this.endNote.beat.minNote&&this.tieDirection===Wt.Down)}wx(){const t=this.lookupStartBeatRenderer().getBeatDirection(this.startNote.beat),e=this.lookupEndBeatRenderer();return t!==(e?e.getBeatDirection(this.endNote.beat):t)&&this.startNote.beat.graceType===l.None}}class au extends Ia{yx=null;kx=null;Sx=null;constructor(t){super(t),this.preNotes=new tu,this.onNotes=new Ql}get prebendNoteHeadOffset(){return this.preNotes.prebendNoteHeadOffset}get accidentalsWidth(){const t=this.preNotes;return t&&t.accidentals?t.accidentals.width:0}doMultiVoiceLayout(){this.preNotes.x=0,this.preNotes.doMultiVoiceLayout(),this.onNotes.x=this.preNotes.x+this.preNotes.width,this.onNotes.doMultiVoiceLayout(),this.yx?.doMultiVoiceLayout()}doLayout(){this.kx=null,this.Sx=null;const t=this.renderer,e=this.beat,s=e.graceType!==l.None;if(t.hasFlag(e)){const i=t.getBeatDirection(e),n=s?Rr.GraceScale:1,r=xl.getSymbol(e.duration,i,s),a=t.smuflMetrics.glyphWidths.get(r)*n;this.Bx=a}else if(s){const e=t.smuflMetrics.glyphWidths.get(lt.Flag8thUp)*Rr.GraceScale;this.Bx=e}super.doLayout(),this.yx&&(this.yx.renderer=this.renderer,this.yx.doLayout(),this.updateWidth())}getBoundingBoxTop(){return null!==this.yx?zt.minBoundingBox(this.yx.getBoundingBoxTop(),super.getBoundingBoxTop()):super.getBoundingBoxTop()}getBoundingBoxBottom(){return null!==this.yx?zt.maxBoundingBox(this.yx.getBoundingBoxBottom(),super.getBoundingBoxTop()):super.getBoundingBoxBottom()}createTies(t){if(t.isVisible){if(t.isTieOrigin&&!t.hasBend&&!t.beat.hasWhammyBar&&t.beat.graceType!==l.BendGrace&&t.tieDestination&&t.tieDestination.isVisible){const e=new nu(`score.tie.${t.id}`,t,t.tieDestination,!1);this.addTie(e)}if(t.isTieDestination&&!t.tieOrigin.hasBend&&!t.beat.hasWhammyBar){const e=new nu(`score.tie.${t.tieOrigin.id}`,t.tieOrigin,t,!0);this.addTie(e)}if(t.slideInType!==m.None||t.slideOutType!==g.None){const e=new iu(t.slideInType,t.slideOutType,t,this);this.addTie(e)}if(t.isSlurOrigin&&t.slurDestination&&t.slurDestination.isVisible){const e=new ru(`score.slur.${t.id}`,t,t.slurDestination,!1);this.addTie(e)}if(t.isSlurDestination){const e=new ru(`score.slur.${t.slurOrigin.id}`,t.slurOrigin,t,!0);this.addTie(e)}if(!this.kx&&t.isEffectSlurOrigin&&t.effectSlurDestination){const e=new ru(`score.slur.effect.${t.beat.id}`,t,t.effectSlurDestination,!1);this.kx=e,this.addTie(e)}if(!this.Sx&&t.beat.isEffectSlurDestination&&t.beat.effectSlurOrigin){const e=this.renderer.getBeatDirection(t.beat),s=e===Wt.Up?t.beat.effectSlurOrigin.minNote:t.beat.effectSlurOrigin.maxNote,i=e===Wt.Up?t.beat.minNote:t.beat.maxNote,n=new ru(`score.slur.effect.${s.beat.id}`,s,i,!0);this.Sx=n,this.addTie(n)}if(t.hasBend){if(!this.yx){const t=new eu(this);this.yx=t,t.renderer=this.renderer,this.addTie(t)}this.yx.addBends(t)}if(this.beat.isLegatoOrigin){if(!this.beat.previousBeat||!this.beat.previousBeat.isLegatoOrigin){let t=this.beat.nextBeat;for(;t.nextBeat&&t.nextBeat.isLegatoDestination;)t=t.nextBeat;this.addTie(new su(`score.legato.${this.beat.id}`,this.beat,t,!1))}}else if(this.beat.isLegatoDestination&&!this.beat.isLegatoOrigin){let t=this.beat.previousBeat;for(;t.previousBeat&&t.previousBeat.isLegatoOrigin;)t=t.previousBeat;this.addTie(new su(`score.legato.${t.id}`,t,this.beat,!0))}}}Bx=0;get postBeatStretch(){return super.postBeatStretch+this.Bx}updateWidth(){super.updateWidth(),this.width+=this.Bx}}class hu extends vl{static StaffId="score";static _x=[-1,2,-2,1,4,0,3];static Tx=[3,0,4,1,5,2,6];accidentalHelper;constructor(t,e){super(t,e),this.accidentalHelper=new ci(this)}get repeatsBarSubElement(){return C.StandardNotationRepeats}get barNumberBarSubElement(){return C.StandardNotationBarNumber}get barLineBarSubElement(){return C.StandardNotationBarLines}get staffLineBarSubElement(){return C.StandardNotationStaffLine}get lineSpacing(){return this.smuflMetrics.oneStaffSpace}get heightLineCount(){return Math.max(5,this.bar.staff.standardNotationLineCount)}get drawnLineCount(){return this.bar.staff.standardNotationLineCount}getScoreY(t){return super.getLineY(t/2)}getScoreHeight(t){return super.getLineHeight(t/2)}calculateOverflows(t,e){super.calculateOverflows(t,e),this.bar.isEmpty||this.calculateBeamingOverflows(t,e)}get flagsSubElement(){return Bt.StandardNotationFlags}get beamsSubElement(){return Bt.StandardNotationBeams}get tupletSubElement(){return Bt.StandardNotationTuplet}getFlagTopY(t,e){const s=e===Wt.Up?Bh.TopWithStem:Bh.StemDown;return t.isRest?this.getRestY(t,s):this.voiceContainer.getHighestNoteY(t,s)}getFlagBottomY(t,e){const s=e===Wt.Up?Bh.StemUp:Bh.BottomWithStem;return t.isRest?this.getRestY(t,s):this.voiceContainer.getLowestNoteY(t,s)}getBeamDirection(t){return this.xx.has(t)?this.xx.get(t):Wt.Up}centerStaffStemY(t){return this.bar.staff.standardNotationLineCount===xe.DefaultStandardNotationLineCount?this.getScoreY(this.bar.staff.standardNotationLineCount-1):t===Wt.Up?this.getScoreY(2*this.bar.staff.standardNotationLineCount):this.getScoreY(0)}get middleYPosition(){return this.getScoreY(this.bar.staff.standardNotationLineCount-1)}applyLayoutingInfo(){const t=super.applyLayoutingInfo();if(t&&this.bar.isMultiVoice){const t=this.getScoreY(-2),e=this.getScoreY(2*this.heightLineCount),s=this.helpers.collisionHelper.getBeatMinMaxY();s[0]<t&&this.registerOverflowTop(Math.abs(s[0])),s[1]>e&&this.registerOverflowBottom(Math.abs(s[1])-e)}return t}getMinLineOfBeat(t){return this.accidentalHelper.getMinSteps(t)/2}getMaxLineOfBeat(t){return this.accidentalHelper.getMaxSteps(t)/2}createLinePreBeatGlyphs(){let t=!1;if(this.isFirstOfStaff||this.bar.clef!==this.bar.previousBar.clef||this.bar.clefOttava!==this.bar.previousBar.clefOttava){let e=0;switch(this.bar.clef){case x.Neutral:e=this.bar.staff.standardNotationLineCount-1;break;case x.F4:e=2;break;case x.C3:e=4;break;case x.C4:e=2;break;case x.G2:e=6}this.createStartSpacing(),this.addPreBeatGlyph(new Cl(0,this.getScoreY(e),this.bar.clef,this.bar.clefOttava)),this.addPreBeatGlyph(new fl(0,0,this.smuflMetrics.preBeatGlyphSpacing)),t=!0}(t||0===this.index&&this.bar.keySignature!==v.C||this.bar.previousBar&&this.bar.keySignature!==this.bar.previousBar.keySignature)&&(this.createStartSpacing(),this.Mx()),(!this.bar.previousBar||this.bar.previousBar&&this.bar.masterBar.timeSignatureNumerator!==this.bar.previousBar.masterBar.timeSignatureNumerator||this.bar.previousBar&&this.bar.masterBar.timeSignatureDenominator!==this.bar.previousBar.masterBar.timeSignatureDenominator||this.bar.previousBar&&this.bar.masterBar.isFreeTime&&this.bar.masterBar.isFreeTime!==this.bar.previousBar.masterBar.isFreeTime)&&(this.createStartSpacing(),this.iT())}Mx(){let t=0;const e=this.bar.keySignature,s=this.bar.previousBar?this.bar.previousBar.keySignature:0;switch(this.bar.clef){case x.Neutral:t=0;break;case x.G2:t=1;break;case x.F4:t=3;break;case x.C3:t=2;break;case x.C4:t=0}const i=new El;i.gap=this.smuflMetrics.accidentalPadding,i.renderer=this;const n=new Map,r=[];if(zt.keySignatureIsSharp(e))for(let s=0;s<Math.abs(e);s++){const e=hu._x[s]+t;r.push(new xo(0,this.getScoreY(e),T.Sharp,1)),n.set(e,!0)}else for(let s=0;s<Math.abs(e);s++){const e=hu.Tx[s]+t;r.push(new xo(0,this.getScoreY(e),T.Flat,1)),n.set(e,!0)}if(this.bar.keySignature===v.C){const e=Math.abs(s),r=zt.keySignatureIsSharp(s)?hu._x:hu.Tx;for(let s=0;s<e;s++){const e=r[s]+t;n.has(e)||i.addGlyph(new xo(0,this.getScoreY(r[s]+t),T.Natural,1))}}for(const t of r)i.addGlyph(t);this.addPreBeatGlyph(i),i.isEmpty||this.addPreBeatGlyph(new fl(0,0,this.smuflMetrics.preBeatGlyphSpacing))}iT(){const t=this.bar.staff.standardNotationLineCount-1;this.addPreBeatGlyph(new Tl(0,this.getScoreY(t),this.bar.masterBar.timeSignatureNumerator,this.bar.masterBar.timeSignatureDenominator,this.bar.masterBar.timeSignatureCommon,this.bar.masterBar.isFreeTime)),this.addPreBeatGlyph(new fl(0,0,this.smuflMetrics.preBeatGlyphSpacing))}createVoiceGlyphs(t){super.createVoiceGlyphs(t);for(const e of t.beats)this.addBeatGlyph(new au(e))}getNoteLine(t){return this.accidentalHelper.getNoteSteps(t)/2}getNoteSteps(t){return this.accidentalHelper.getNoteSteps(t)}xx=new Map;completeBeamingHelper(t){const e=this.vx(t);this.xx.set(t,e)}vx(t){if(!t.voice)return Wt.Up;if(null!==t.preferredBeamDirection)return t.preferredBeamDirection;if(t.voice.index>0)return this.Nx(t,Wt.Down);if(t.voice.bar.isMultiVoice)return this.Nx(t,Wt.Up);if(t.beats[0].graceType!==l.None)return this.Nx(t,Wt.Up);if(1===t.beats.length&&t.beats[0].slashed)return this.Nx(t,Wt.Down);if(t.highestNoteInHelper&&t.lowestNoteInHelper){const e=(this.Px(t.highestNoteInHelper)+this.Px(t.lowestNoteInHelper))/2;return this.Nx(t,this.middleYPosition<e?Wt.Up:Wt.Down)}return this.Nx(t,Wt.Up)}Px(t){const e=ci.computeStepsWithoutAccidentals(this.bar,t);return this.getScoreY(e)}Nx(t,e){return t.invertBeamDirection?e===Wt.Down?Wt.Up:Wt.Down:e}paintBeamingStem(t,e,s,i,n,r){const a=ao.beat(r,Bt.StandardNotationStem,t);try{r.fillRect(s,i,this.smuflMetrics.stemThickness,n-i)}finally{a?.[Symbol.dispose]?.()}}}class ou extends Eh{get staffId(){return hu.StaffId}create(t,e){return new hu(t,e)}canCreate(t,e){return super.canCreate(t,e)&&e.showStandardNotation}}class cu extends Xl{paint(t,e,s){super.internalPaint(t,e,s,Bt.SlashRests)}}class lu extends ll{vT;NT=0;noteHeads=null;deadSlapped=null;restGlyph=null;get effectElement(){return Bt.SlashEffects}getNoteX(t,e){let s=null;if(this.noteHeads?s=this.noteHeads:this.deadSlapped&&(s=this.deadSlapped),s){let t=s.x;switch(e){case _h.Left:break;case _h.Center:t+=s.width/2;break;case _h.Right:t+=s.width}return t}return 0}buildBoundingsLookup(t,e,s){if(this.noteHeads&&this.container.beat.notes.length>0){const i=new pa;i.note=this.container.beat.notes[0],i.noteHeadBounds=new Us,i.noteHeadBounds.x=e+this.x+this.noteHeads.x,i.noteHeadBounds.y=s+this.y+this.noteHeads.y-this.noteHeads.height/2,i.noteHeadBounds.w=this.width,i.noteHeadBounds.h=this.height,t.addNote(i)}}getLowestNoteY(t){return this.W_(t)}getHighestNoteY(t){return this.W_(t)}getRestY(t){const e=this.restGlyph;if(e)switch(t){case Bh.TopWithStem:return e.getBoundingBoxTop()-this.renderer.smuflMetrics.getStemLength(c.Quarter,!0);case Bh.Top:return e.getBoundingBoxTop();case Bh.Center:case Bh.StemUp:case Bh.StemDown:return e.getBoundingBoxTop()+e.height/2;case Bh.Bottom:return e.getBoundingBoxBottom();case Bh.BottomWithStem:return e.getBoundingBoxBottom()+this.renderer.smuflMetrics.getStemLength(c.Quarter,!0)}return 0}getNoteY(t,e){return this.W_(e)}W_(t){let e=null,s=lt.None,i=!1;if(this.noteHeads?(e=this.noteHeads,s=Yl.getSymbol(this.container.beat.duration),i=!0):this.deadSlapped&&(e=this.deadSlapped),e){let n=this.y+e.y;const r=this.renderer,a=this.container.beat,h=a.graceType!==l.None?Rr.GraceScale:1;switch(t){case Bh.TopWithStem:return i?(n-=(r.smuflMetrics.stemUp.has(s)?r.smuflMetrics.stemUp.get(s).bottomY:0)*h,n-=r.smuflMetrics.getStemLength(a.duration,r.hasFlag(a))*h,n-=this.NT):n-=e.height/2,n;case Bh.Top:n-=e.height/2;break;case Bh.Center:break;case Bh.Bottom:n+=e.height/2;break;case Bh.BottomWithStem:return i?(n-=(r.smuflMetrics.stemDown.has(s)?r.smuflMetrics.stemDown.get(s).topY:-r.smuflMetrics.glyphHeights.get(s)/2)*h,n+=r.smuflMetrics.getStemLength(a.duration,r.hasFlag(a))*h,n+=this.NT):n+=e.height/2,n;case Bh.StemUp:n-=this.renderer.smuflMetrics.stemUp.has(s)?this.renderer.smuflMetrics.stemUp.get(s).bottomY:0;break;case Bh.StemDown:n-=this.renderer.smuflMetrics.stemDown.has(s)?this.renderer.smuflMetrics.stemDown.get(s).topY:0}return n}return 0}doLayout(){const t=this.renderer,e=t.getLineY(0);if(this.container.beat.deadSlapped){const t=new ul;t.renderer=this.renderer,t.doLayout(),this.deadSlapped=t,this.addEffect(t)}else if(!this.container.beat.isEmpty)if(this.container.beat.isRest){const t=new cu(0,e,this.container.beat.duration);this.restGlyph=t,t.beat=this.container.beat,this.addNormal(t)}else{const t=new Yl(0,e,this.container.beat);this.noteHeads=t,t.beat=this.container.beat,this.addNormal(t),this.container.beat.isTremolo&&(this.vT=new Ul(0,0,this.container.beat.tremoloPicking),this.vT.renderer=this.renderer,this.vT.doLayout(),this.PT())}if(this.container.beat.dots>0)for(let s=0;s<this.container.beat.dots;s++)this.addEffect(new ol(0,e-t.getLineHeight(.5)));super.doLayout(),this.container.beat.isEmpty?(this.onTimeX=this.width/2,this.stemX=this.onTimeX):this.restGlyph?(this.onTimeX=this.restGlyph.x+this.restGlyph.width/2,this.stemX=this.onTimeX):this.noteHeads?(this.onTimeX=this.noteHeads.x+this.noteHeads.width/2,this.stemX=this.noteHeads.x+this.noteHeads.stemX):this.deadSlapped&&(this.onTimeX=this.deadSlapped.x+this.deadSlapped.width/2,this.stemX=this.onTimeX),this.middleX=this.onTimeX;const s=this.vT;s&&(s.x=this.container.beat.duration<c.Half?this.width/2:this.stemX)}PT(){const t=this.vT;t.alignTremoloPickingGlyph(Wt.Up,this.W_(Bh.TopWithStem),this.W_(Bh.Center),this.container.beat.duration),this.NT=t.stemExtensionHeight;let e=this.stemX;this.container.beat.duration<c.Half&&(e=this.width/2),t.x=e}paint(t,e,s){super.paint(t,e,s);const i=this.vT;i&&i.paint(t+this.x,e+this.y,s)}}class uu extends $o{calculateTieDirection(){return Wt.Down}getStartNotePosition(){return _h.Right}getEndNotePosition(){return _h.Left}}class du extends Ia{Cx=null;constructor(t){super(t),this.preNotes=new cl,this.onNotes=new lu}doLayout(){const t=this.renderer,e=this.beat,s=e.graceType!==l.None;if(t.hasFlag(e)){const i=t.getBeatDirection(e),n=s?Rr.GraceScale:1,r=xl.getSymbol(e.duration,i,s),a=t.smuflMetrics.glyphWidths.get(r)*n;this.Bx=a}else if(s){const e=t.smuflMetrics.glyphWidths.get(lt.Flag8thUp)*Rr.GraceScale;this.Bx=e}super.doLayout()}createTies(t){if(t.isVisible){if(!this.Cx&&t.isTieOrigin&&t.tieDestination.isVisible){const e=new uu("slash.tie",t,t.tieDestination,!1);this.Cx=e,this.addTie(e)}if(!this.Cx&&t.isTieDestination){const e=new uu("slash.tie",t.tieOrigin,t,!0);this.Cx=e,this.addTie(e)}}}Bx=0;get postBeatStretch(){return super.postBeatStretch+this.Bx}updateWidth(){super.updateWidth(),this.width+=this.Bx}}class fu extends vl{static StaffId="slash";simpleWhammyOverflow=0;Ex;constructor(t,e){super(t,e),this.Ex=!e.staff.showTablature&&!e.staff.showStandardNotation,this.helpers.preferredBeamDirection=Wt.Up}get repeatsBarSubElement(){return C.SlashRepeats}get barNumberBarSubElement(){return C.SlashBarNumber}get barLineBarSubElement(){return C.SlashBarLines}get staffLineBarSubElement(){return C.SlashStaffLine}get lineSpacing(){return this.smuflMetrics.oneStaffSpace}get heightLineCount(){return 5}get drawnLineCount(){return 1}get bottomGlyphOverflow(){return 0}get flagsSubElement(){return Bt.SlashFlags}get beamsSubElement(){return Bt.SlashBeams}get tupletSubElement(){return Bt.SlashTuplet}doLayout(){super.doLayout(),this.voiceContainer.tupletGroups.size>0&&this.registerOverflowTop(this.tupletSize)}getNoteLine(t){return 0}getFlagTopY(t,e){const s=e===Wt.Up?Bh.TopWithStem:Bh.StemDown;return t.notes.length>0?this.getNoteY(t.notes[0],s):this.getRestY(t,s)}getFlagBottomY(t,e){const s=e===Wt.Up?Bh.StemUp:Bh.BottomWithStem;return t.notes.length>0?this.getNoteY(t.notes[0],s):this.getRestY(t,s)}getBeamDirection(t){return Wt.Up}createLinePreBeatGlyphs(){this.Ex&&(!this.bar.previousBar||this.bar.previousBar&&this.bar.masterBar.timeSignatureNumerator!==this.bar.previousBar.masterBar.timeSignatureNumerator||this.bar.previousBar&&this.bar.masterBar.timeSignatureDenominator!==this.bar.previousBar.masterBar.timeSignatureDenominator||this.bar.previousBar&&this.bar.masterBar.isFreeTime&&this.bar.masterBar.isFreeTime!==this.bar.previousBar.masterBar.isFreeTime)&&(this.createStartSpacing(),this.iT())}iT(){this.addPreBeatGlyph(new fl(0,0,this.smuflMetrics.oneStaffSpace));const t=this.bar.masterBar,e=new Tl(0,this.getLineY(0),t.timeSignatureNumerator,t.timeSignatureDenominator,t.timeSignatureCommon,t.isFreeTime&&(null==t.previousMasterBar||t.isFreeTime!==t.previousMasterBar.isFreeTime));e.barSubElement=C.SlashTimeSignature,this.addPreBeatGlyph(e)}createVoiceGlyphs(t){if(!(t.index>0)){super.createVoiceGlyphs(t);for(const e of t.beats)this.addBeatGlyph(new du(e))}}calculateOverflows(t,e){super.calculateOverflows(t,e),this.bar.isEmpty||this.calculateBeamingOverflows(t,e)}shouldPaintBeamingHelper(t){return super.shouldPaintBeamingHelper(t)&&0===t.voice.index}paintBeamingStem(t,e,s,i,n,r){const a=ao.beat(r,Bt.SlashStem,t);try{r.fillRect(s,i,this.smuflMetrics.stemThickness,n-i)}finally{a?.[Symbol.dispose]?.()}}paintBeamHelper(t,e,s,i,n,r){0===i.voice?.index&&super.paintBeamHelper(t,e,s,i,n,r)}}class pu extends Eh{get staffId(){return fu.StaffId}create(t,e){return new fu(t,e)}canCreate(t,e){return super.canCreate(t,e)&&e.showSlash}}class bu extends Oa{je;Ax=null;Dx=null;Lx=0;isEmpty=!1;noteStringWidth=0;constructor(t,e,s){super(t,e),this.je=s}get Ik(){return.25*this.renderer.lineSpacing}getBoundingBoxTop(){return this.y-this.height/2-this.Ik}getBoundingBoxBottom(){return this.y+this.height/2}doLayout(){const t=this.je;let e=t.fret-t.beat.voice.bar.staff.transpositionPitch;if(t.harmonicType===f.Natural&&0!==t.harmonicValue&&(e=t.harmonicValue-t.beat.voice.bar.staff.transpositionPitch),t.isTieDestination)0===t.beat.index&&this.renderer.settings.notation.notationMode===S.GuitarPro||(t.bendType===a.Bend||t.bendType===a.BendRelease)&&this.renderer.settings.notation.isNotationElementVisible(B.TabNotesOnTiedBends)?this.Ax=`(${(t.tieOrigin.fret-t.beat.voice.bar.staff.transpositionPitch).toString()})`:this.Ax="";else if(this.Ax=t.isDead?"x":e.toString(),t.isGhost)this.Ax=`(${this.Ax})`;else if(t.harmonicType===f.Natural){const t=this.Ax.indexOf(String.fromCharCode(46));t>=0&&(this.Ax=this.Ax.substr(0,t+2)),this.Ax=`<${this.Ax}>`}if(t.isTrill)this.Dx=`(${(t.trillFret-t.beat.voice.bar.staff.transpositionPitch).toString()})`;else if(zt.isAlmostEqualTo(t.harmonicValue,0))this.Dx="";else switch(t.harmonicType){case f.Artificial:case f.Pinch:case f.Tap:case f.Semi:case f.Feedback:let s=(e+t.harmonicValue).toString();const i=s.indexOf(String.fromCharCode(46));i>=0&&(s=s.substr(0,i+2)),this.Dx=`<${s}>`;break;default:this.Dx=""}if(this.isEmpty=!this.Ax,!this.isEmpty){this.renderer.scoreRenderer.canvas.font=this.renderer.resources.tablatureFont;const t=!!this.Dx;this.noteStringWidth=this.renderer.scoreRenderer.canvas.measureText(this.Ax+(t?" ":"")).width,this.width=this.noteStringWidth,this.height=this.renderer.scoreRenderer.canvas.font.size,t&&(this.renderer.scoreRenderer.canvas.font=this.renderer.resources.graceFont,this.Lx=3+this.renderer.scoreRenderer.canvas.measureText(this.Dx).width,this.width+=this.Lx)}}paint(t,e,s){if(this.isEmpty)return;const i=this.noteStringWidth+this.Lx,n=t+this.x+(this.width-i)/2,r=e+this.y;this.paintTrill(n,r,s);const a=ao.note(s,ft.GuitarTabFretNumber,this.je);try{s.fillText(this.Ax,n,r)}finally{a?.[Symbol.dispose]?.()}}paintTrill(t,e,s){const i=ao.note(s,ft.GuitarTabFretNumber,this.je);try{const i=this.renderer.scoreRenderer.canvas.font;this.renderer.scoreRenderer.canvas.font=this.renderer.resources.graceFont,s.fillText(this.Dx,t+this.noteStringWidth,e),this.renderer.scoreRenderer.canvas.font=i}finally{i?.[Symbol.dispose]?.()}}buildBoundingsLookup(t,e,s){const i=new pa;i.note=this.je,i.noteHeadBounds=new Us,i.noteHeadBounds.x=e+this.x,i.noteHeadBounds.y=s+this.y-this.height/2,i.noteHeadBounds.w=this.width,i.noteHeadBounds.h=this.height,t.addNote(i)}}class mu extends Oa{jS=[];MT=null;F_;beat;maxStringNote=null;minStringNote=null;beatEffects=new Map;notesPerString=new Map;noteStringWidth=0;constructor(t,e,s){super(t,e),this.F_=s}buildBoundingsLookup(t,e,s){for(const i of this.jS)i.buildBoundingsLookup(t,e+this.x,s+this.y)}getNoteX(t,e){if(this.notesPerString.has(t.string)){const s=this.notesPerString.get(t.string);let i=this.x+s.x;switch(e){case _h.Left:break;case _h.Center:i+=s.noteStringWidth/2;break;case _h.Right:i+=s.width}return i}return 0}getLowestNoteY(t){return this.maxStringNote?this.getNoteY(this.maxStringNote,t):0}getHighestNoteY(t){return this.minStringNote?this.getNoteY(this.minStringNote,t):0}getNoteY(t,e){if(this.notesPerString.has(t.string)){const s=this.notesPerString.get(t.string);let i=this.y+s.y;switch(e){case Bh.Top:i-=s.height/2;break;case Bh.StemUp:i=this.y+s.getBoundingBoxTop();break;case Bh.Center:break;case Bh.Bottom:i+=s.height/2;break;case Bh.StemDown:i=this.y+s.getBoundingBoxBottom();break;case Bh.TopWithStem:i=-this.renderer.settings.notation.rhythmHeight,i-=this.calculateTremoloHeightForStem();break;case Bh.BottomWithStem:i=this.renderer.height+this.renderer.settings.notation.rhythmHeight,i+=this.calculateTremoloHeightForStem()}return i}return 0}calculateTremoloHeightForStem(){const t=this.beat;if(!t.isTremolo)return 0;if(t.duration<=c.Quarter)return 0;const e=Ul.Sk(t.tremoloPicking),s=this.renderer.smuflMetrics;return s.glyphHeights.has(e)?s.glyphHeights.get(e):0}doLayout(){let t=0;if(this.beat.deadSlapped)this.MT=new ul,this.MT.renderer=this.renderer,this.MT.doLayout(),t=this.MT.width,this.noteStringWidth=t;else{let e=0;for(let s=0,i=this.jS.length;s<i;s++){const i=this.jS[s];i.renderer=this.renderer,i.doLayout(),i.width>t&&(t=i.width),i.noteStringWidth>e&&(e=i.noteStringWidth)}this.noteStringWidth=e;const s=this.renderer.resources.tablatureFont.size;let i=Number.NaN,n=Number.NaN,r=this.getNoteY(this.minStringNote,Bh.Center)+s/2;const a=this.renderer.smuflMetrics.onNoteEffectPadding;for(const t of this.beatEffects.values())t.y+=r,t.x+=this.width/2,t.renderer=this.renderer,t.doLayout(),r+=t.height+a,(Number.isNaN(i)||i>r)&&(i=r),(Number.isNaN(n)||n<r)&&(n=r);Number.isNaN(i)||this.renderer.registerBeatEffectOverflows(i,n)}this.width=t}addNoteGlyph(t,e){this.jS.push(t),this.notesPerString.set(e.string,t),(!this.minStringNote||e.string<this.minStringNote.string)&&(this.minStringNote=e),(!this.maxStringNote||e.string>this.maxStringNote.string)&&(this.maxStringNote=e)}paint(t,e,s){if(t+=this.x,e+=this.y,this.beat.deadSlapped)this.MT?.paint(t,e,s);else{const i=this.renderer.resources,n=s.textBaseline;s.textBaseline=ht.Middle,s.font=this.F_?i.graceFont:i.tablatureFont;const r=this.jS,a=this.width;for(const i of r)i.renderer=this.renderer,i.width=a,i.paint(t,e,s);s.textBaseline=n;const h=ao.beat(s,Bt.GuitarTabEffects,this.beat);try{for(const i of this.beatEffects.values())i.paint(t,e,s)}finally{h?.[Symbol.dispose]?.()}}}}class gu extends Kh{Wx;constructor(t,e,s,i){super(t,e,1,Xl.getSymbol(i)),this.Wx=s}doLayout(){super.doLayout()}paint(t,e,s){if(this.Wx){const i=ao.beat(s,Bt.GuitarTabRests,this.beat);try{super.paint(t,e,s)}finally{i?.[Symbol.dispose]?.()}}}}class wu extends ll{slash=null;noteNumbers=null;restGlyph=null;get effectElement(){return Bt.GuitarTabEffects}getNoteX(t,e){if(this.slash){let t=this.slash.x;switch(e){case _h.Left:break;case _h.Center:t+=this.slash.width/2;break;case _h.Right:t+=this.slash.width}return t}return this.noteNumbers?this.noteNumbers.getNoteX(t,e):0}getNoteY(t,e){return this.noteNumbers?this.noteNumbers.getNoteY(t,e):0}getRestY(t){const e=this.restGlyph;if(e)switch(t){case Bh.TopWithStem:return e.getBoundingBoxTop()-this.renderer.smuflMetrics.getStemLength(c.Quarter,!0);case Bh.Top:return e.getBoundingBoxTop();case Bh.Center:case Bh.StemUp:case Bh.StemDown:return e.getBoundingBoxTop()+e.height/2;case Bh.Bottom:return e.getBoundingBoxTop();case Bh.BottomWithStem:return e.getBoundingBoxBottom()+this.renderer.smuflMetrics.getStemLength(c.Quarter,!0)}return 0}getLowestNoteY(t){return this.noteNumbers?this.noteNumbers.getLowestNoteY(t):0}getHighestNoteY(t){return this.noteNumbers?this.noteNumbers.getHighestNoteY(t):0}buildBoundingsLookup(t,e,s){this.noteNumbers&&this.noteNumbers.buildBoundingsLookup(t,e+this.x,s+this.y)}doLayout(){const t=this.renderer,e=[];if(this.container.beat.isRest){const e=Math.floor((this.renderer.bar.staff.tuning.length-1)/2),s=t.getLineY(e),i=new gu(0,s,t.showRests,this.container.beat.duration);if(this.restGlyph=i,i.beat=this.container.beat,this.addNormal(i),this.container.beat.dots>0&&t.showRests)for(let t=0;t<this.container.beat.dots;t++)this.addEffect(new ol(0,s))}else{const s=this.renderer.settings.notation.smallGraceTabNotes&&this.container.beat.graceType!==l.None;let i;if(this.container.beat.slashed&&!this.container.beat.notes.some(t=>t.isTieDestination)){const e=Math.floor((this.renderer.bar.staff.tuning.length-1)/2),s=t.getLineY(e),n=new Yl(0,s,this.container.beat);n.noteHeadElement=ft.GuitarTabFretNumber,n.effectElement=Bt.GuitarTabEffects,this.slash=n,n.beat=this.container.beat,this.addNormal(n),i=n.beatEffects}else{const t=new mu(0,0,s);this.noteNumbers=t,t.beat=this.container.beat;for(const t of this.container.beat.notes)t.isVisible&&this.zT(t);this.addNormal(t),i=t.beatEffects}if(this.container.beat.isTremolo&&!i.has("tremolo")){const t=new Ul(0,0,this.container.beat.tremoloPicking);t.offsetY=this.renderer.smuflMetrics.glyphTop.get(t.symbol),i.set("tremolo",t),e.push(t)}if(this.container.beat.dots>0&&t.rhythmMode!==y.Hidden){const t=this.getNoteY(this.container.beat.maxNote,Bh.BottomWithStem);for(let e=0;e<this.container.beat.dots;e++)this.addEffect(new ol(0,t))}}if(this.isEmpty)return;let s=0;for(let t=0,e=this.glyphs.length;t<e;t++){const e=this.glyphs[t];e.x=s,e.renderer=this.renderer,e.doLayout(),s+=e.width}this.width=s,this.computedWidth=s,this.container.beat.isEmpty?this.onTimeX=this.width/2:this.restGlyph?this.onTimeX=this.restGlyph.x+this.restGlyph.width/2:this.noteNumbers?this.onTimeX=this.noteNumbers.x+this.noteNumbers.noteStringWidth/2:this.slash&&(this.onTimeX=this.slash.x+this.slash.width/2),this.middleX=this.onTimeX,this.stemX=this.middleX;for(const t of e)t.x=this.onTimeX}zT(t){const e=this.renderer,s=new bu(0,0,t),i=e.getNoteLine(t);s.y=e.getLineY(i),s.renderer=this.renderer,s.doLayout(),this.noteNumbers.addNoteGlyph(s,t);const n=s.getBoundingBoxTop(),r=s.getBoundingBoxBottom();this.renderer.collisionHelper.reserveBeatSlot(this.container.beat,n,r);const a=e.minString,h=e.maxString;(Number.isNaN(a)||a<t.string)&&(e.minString=i),(Number.isNaN(h)||h>t.string)&&(e.maxString=i)}}class yu extends Oa{Ge;JT;constructor(t){super(0,0),this.Ge=t}doLayout(){if(this.width=this.renderer.smuflMetrics.glyphWidths.get(lt.ArrowheadBlackDown),this.Ge.brushType===h.ArpeggioUp){const t=new ic(0,0,w.Slight,!0);t.renderer=this.renderer,t.doLayout(),this.JT=t}else if(this.Ge.brushType===h.ArpeggioDown){const t=new ic(0,0,w.Slight,!0);t.renderer=this.renderer,t.doLayout(),this.JT=t}}paint(t,e,s){const i=this.renderer,n=e+this.x+i.getNoteY(this.Ge.maxStringNote,Bh.Top),r=e+this.y+i.getNoteY(this.Ge.minStringNote,Bh.Bottom),a=t+this.x+this.width/2,o=this.renderer.smuflMetrics.glyphWidths.get(lt.ArrowheadBlackDown);if(this.Ge.brushType!==h.None){if(this.Ge.brushType===h.BrushUp||this.Ge.brushType===h.BrushDown)s.beginPath(),s.moveTo(a,n),s.lineTo(a,r),s.stroke();else if(this.Ge.brushType===h.ArpeggioUp){const e=this.JT,i=n,a=r-o;e.width=Math.abs(a-i),s.beginRotate(t+this.x,a,-90),e.paint(0,(this.width-e.height)/2,s),s.endRotate()}else if(this.Ge.brushType===h.ArpeggioDown){const e=this.JT,i=n+o,a=r;e.width=Math.abs(a-i),s.beginRotate(t+this.x,i,90),e.paint(0,-(this.width-e.height/2),s),s.endRotate()}this.Ge.brushType===h.BrushUp||this.Ge.brushType===h.ArpeggioUp?(s.beginPath(),s.moveTo(a,r),s.lineTo(a+o/2,r-o),s.lineTo(a-o/2,r-o),s.closePath(),s.fill()):(s.beginPath(),s.moveTo(a,n),s.lineTo(a+o/2,n+o),s.lineTo(a-o/2,n+o),s.closePath(),s.fill())}}}class ku extends cl{doLayout(){this.container.beat.brushType===h.None||this.container.beat.isRest||(this.addEffect(new yu(this.container.beat)),this.addNormal(new fl(0,0,this.renderer.smuflMetrics.preNoteEffectPadding))),super.doLayout()}get effectElement(){return Bt.GuitarTabEffects}}class Su extends Oa{ix;sx;nx;hx;checkForOverflow=!1;constructor(t,e,s,i){super(0,0),this.ix=t,this.sx=e,this.nx=s,this.hx=i}doLayout(){this.width=0}paint(t,e,s){this.ox(t,e,s),this.Ox(t,e,s)}ox(t,e,s){const i=this.renderer,n=this.renderer.smuflMetrics.simpleSlideWidth,r=this.renderer.smuflMetrics.simpleSlideHeight;let a=0,h=0,o=0,c=0;const l=this.renderer.smuflMetrics.preNoteEffectPadding;switch(this.ix){case m.IntoFromBelow:o=t+i.x+i.getNoteX(this.nx,_h.Left)-l,c=e+i.y+i.getNoteY(this.nx,Bh.Center)-r,a=o-n,h=e+i.y+i.getNoteY(this.nx,Bh.Center)+r;break;case m.IntoFromAbove:o=t+i.x+i.getNoteX(this.nx,_h.Left)-l,c=e+i.y+i.getNoteY(this.nx,Bh.Center)+r,a=o-n,h=e+i.y+i.getNoteY(this.nx,Bh.Center)-r;break;default:return}this.bx(s,!1,a,o,h,c)}Ox(t,e,s){const i=this.renderer,n=this.renderer.smuflMetrics.simpleSlideWidth,r=this.renderer.smuflMetrics.simpleSlideHeight;let a=0,h=0,o=0,c=0,l=!1;const u=this.renderer.smuflMetrics.postNoteEffectPadding;switch(this.sx){case g.Shift:case g.Legato:if(a=t+i.x+i.getBeatX(this.nx.beat,bs.PostNotes)+u,h=e+i.y+i.getNoteY(this.nx,Bh.Center),this.nx.slideTarget){const s=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,this.nx.slideTarget.beat.voice.bar);s&&s.staff===i.staff?(o=t+s.x+s.getBeatX(this.nx.slideTarget.beat,bs.OnNotes)-u,c=e+s.y+s.getNoteY(this.nx.slideTarget,Bh.Center)):(o=t+i.x+i.width,c=h),this.nx.slideTarget.fret>this.nx.fret?(h+=r,c-=r):(h-=r,c+=r)}else o=t+i.x+this.hx.x,c=h;break;case g.OutUp:a=t+i.x+i.getNoteX(this.nx,_h.Right)+u,h=e+i.y+i.getNoteY(this.nx,Bh.Center)+r,o=a+n,c=e+i.y+i.getNoteY(this.nx,Bh.Center)-r;break;case g.OutDown:a=t+i.x+i.getNoteX(this.nx,_h.Right)+u,h=e+i.y+i.getNoteY(this.nx,Bh.Center)-r,o=a+n,c=e+i.y+i.getNoteY(this.nx,Bh.Center)+r;break;case g.PickSlideDown:a=t+i.x+i.getNoteX(this.nx,_h.Right)+2*u,h=e+i.y+i.getNoteY(this.nx,Bh.Center),o=t+i.x+i.width,c=h+3*r,this.nx.beat.nextBeat&&this.nx.beat.nextBeat.voice===this.nx.beat.voice&&(o=t+i.x+i.getBeatX(this.nx.beat.nextBeat,bs.PreNotes)),l=!0;break;case g.PickSlideUp:a=t+i.x+i.getNoteX(this.nx,_h.Right)+2*u,h=e+i.y+i.getNoteY(this.nx,Bh.Center),o=t+i.x+i.width,c=h-3*r,this.nx.beat.nextBeat&&this.nx.beat.nextBeat.voice===this.nx.beat.voice&&(o=t+i.x+i.getBeatX(this.nx.beat.nextBeat,bs.PreNotes)),l=!0;break;default:return}this.bx(s,l,a,o,h,c)}bx(t,e,s,i,n,r){if(e){const e=new ic(0,0,w.Slight);e.renderer=this.renderer,e.doLayout(),n-=e.height/2;const a=i-s,h=(r-=e.height/2)-n,o=Math.sqrt(Math.pow(h,2)+Math.pow(a,2));e.width=a;const c=Math.asin(h/o)*(180/Math.PI);t.beginRotate(s,n,c),e.paint(0,0,t),t.endRotate()}else t.beginPath(),t.moveTo(s,n),t.lineTo(i,r),t.stroke()}}class Bu extends Ia{yx=null;G_=[];constructor(t){super(t),this.preNotes=new ku,this.onNotes=new wu}drawBeamHelperAsFlags(t){return t.hasFlag(this.renderer.drawBeamHelperAsFlags(t),this.beat)}doLayout(){this.G_=[],super.doLayout(),this.yx&&(this.yx.renderer=this.renderer,this.yx.doLayout(),this.updateWidth())}createTies(t){if(!t.isVisible)return;const e=this.renderer;if(t.isTieOrigin&&e.showTiedNotes&&t.tieDestination.isVisible){const e=new ml(`tab.tie.${t.id}`,t,t.tieDestination,!1);this.addTie(e)}if(t.isTieDestination&&e.showTiedNotes){const e=new ml(`tab.tie.${t.tieOrigin.id}`,t.tieOrigin,t,!0);this.addTie(e)}if(t.isLeftHandTapped&&!t.isHammerPullDestination){const e=new ml(`tab.tie.leftHandTap.${t.id}`,t,t,!1);this.addTie(e)}if(t.isEffectSlurOrigin&&t.effectSlurDestination){let e=!1;for(const s of this.G_)if(s.tryExpand(t,t.effectSlurDestination,!1,!1)){e=!0;break}if(!e){const e=new gl(`tab.slur.effect.${t.id}`,t,t.effectSlurDestination,!1,!1);this.G_.push(e),this.addTie(e)}}if(t.isEffectSlurDestination&&t.effectSlurOrigin){let e=!1;for(const s of this.G_)if(s.tryExpand(t.effectSlurOrigin,t,!1,!0)){e=!0;break}if(!e){const e=new gl(`tab.slur.effect.${t.effectSlurOrigin.id}`,t.effectSlurOrigin,t,!1,!0);this.G_.push(e),this.addTie(e)}}if(t.slideInType!==m.None||t.slideOutType!==g.None){const e=new Su(t.slideInType,t.slideOutType,t,this);this.addTie(e)}if(t.hasBend){if(!this.yx){const t=new rc;this.yx=t,t.renderer=this.renderer,this.addTie(t)}this.yx.addBends(t)}}}class _u extends Kh{constructor(t,e){super(t,e,1,lt.SixStringTabClef)}doLayout(){this.symbol=this.renderer.bar.staff.tuning.length<=4?lt.FourStringTabClef:lt.SixStringTabClef,this.center=!0,super.doLayout(),this.width=this.renderer.smuflMetrics.glyphWidths.get(lt.GClef),this.offsetX=this.width/2}}class Tu extends _l{doLayout(){this.barSubElement=C.GuitarTabsTimeSignature,super.doLayout()}get commonScale(){return 1}get numberScale(){return this.renderer.bar.staff.tuning.length<=4?Rr.GraceScale:1}}class xu extends vl{static StaffId="tab";Rx=!1;showTimeSignature=!1;showRests=!1;showTiedNotes=!1;Ix=!1;get showMultiBarRest(){return this.Ix}get repeatsBarSubElement(){return C.GuitarTabsRepeats}get barNumberBarSubElement(){return C.GuitarTabsBarNumber}get barLineBarSubElement(){return C.GuitarTabsBarLines}get staffLineBarSubElement(){return C.GuitarTabsStaffLine}get lineSpacing(){return this.smuflMetrics.tabLineSpacing}get heightLineCount(){return this.bar.staff.tuning.length}get drawnLineCount(){return this.bar.staff.tuning.length}get rhythmMode(){let t=this.settings.notation.rhythmMode;return t===y.Automatic&&(t=this.bar.staff.showStandardNotation?y.Hidden:y.ShowWithBars),t}getNoteLine(t){return this.bar.staff.tuning.length-t.string}minString=Number.NaN;maxString=Number.NaN;collectSpaces(t){if(this.additionalMultiRestBars)return;const e=this.smuflMetrics.staffLineThickness,s=this.bar.staff.tuning;for(const i of this.voiceContainer.beatGlyphs.values())for(const n of i){const i=n.onNotes,r=i.noteNumbers;if(r)for(const[a,h]of r.notesPerString)h.isEmpty||t[s.length-a].push(new Float32Array([this.beatGlyphsStart+n.x+i.x+r.x-e,r.width+2*e]))}}doLayout(){this.bar.staff.showStandardNotation&&this.scoreRenderer.layout.profile.has(hu.StaffId)||(this.showTimeSignature=!0,this.showRests=!0,this.showTiedNotes=!0,this.Ix=!0),super.doLayout();0===this.minString&&this.registerOverflowTop(this.lineSpacing/2);this.maxString===this.bar.staff.tuning.length-1&&this.registerOverflowBottom(this.lineSpacing/2),this.rhythmMode!==y.Hidden&&(this.Rx=this.voiceContainer.tupletGroups.size>0,this.Rx&&this.registerOverflowBottom(this.settings.notation.rhythmHeight+this.tupletSize))}createLinePreBeatGlyphs(){if(this.isFirstOfStaff){const t=(this.bar.staff.tuning.length-1)/2;this.createStartSpacing(),this.addPreBeatGlyph(new _u(0,this.getLineY(t)))}this.showTimeSignature&&(!this.bar.previousBar||this.bar.previousBar&&this.bar.masterBar.timeSignatureNumerator!==this.bar.previousBar.masterBar.timeSignatureNumerator||this.bar.previousBar&&this.bar.masterBar.timeSignatureDenominator!==this.bar.previousBar.masterBar.timeSignatureDenominator||this.bar.previousBar&&this.bar.masterBar.isFreeTime&&this.bar.masterBar.isFreeTime!==this.bar.previousBar.masterBar.isFreeTime)&&(this.createStartSpacing(),this.iT())}iT(){this.addPreBeatGlyph(new fl(0,0,this.smuflMetrics.oneStaffSpace));const t=(this.bar.staff.tuning.length+1)/2-1;this.addPreBeatGlyph(new Tu(0,this.getLineY(t),this.bar.masterBar.timeSignatureNumerator,this.bar.masterBar.timeSignatureDenominator,this.bar.masterBar.timeSignatureCommon,this.bar.masterBar.isFreeTime))}createVoiceGlyphs(t){super.createVoiceGlyphs(t);for(const e of t.beats)this.addBeatGlyph(new Bu(e))}get flagsSubElement(){return Bt.GuitarTabFlags}get beamsSubElement(){return Bt.GuitarTabBeams}get tupletSubElement(){return Bt.GuitarTabTuplet}paintBeams(t,e,s,i,n){this.rhythmMode!==y.Hidden&&super.paintBeams(t,e,s,i,n)}paintTuplets(t,e,s,i,n=!1){this.rhythmMode!==y.Hidden&&super.paintTuplets(t,e,s,i,n)}drawBeamHelperAsFlags(t){return super.drawBeamHelperAsFlags(t)||this.rhythmMode===y.ShowWithBeams}getFlagTopY(t,e){const s=t.maxStringNote,i=e===Wt.Up?Bh.TopWithStem:Bh.StemDown;return s?this.getNoteY(s,i):this.getRestY(t,i)}getFlagBottomY(t,e){const s=t.minStringNote,i=e===Wt.Up?Bh.StemUp:Bh.BottomWithStem;return s?this.getNoteY(s,i):this.getRestY(t,i)}getBeamDirection(t){return Wt.Down}shouldPaintFlag(t){return!!super.shouldPaintFlag(t)&&t.graceType===l.None}paintBeamingStem(t,e,s,i,n,r){if(n<i){const t=n;n=i,i=t}const a=ao.beat(r,Bt.GuitarTabStem,t);try{let a=[];if(this.helpers.collisionHelper.reservedLayoutAreasByDisplayTime.has(t.displayStart)&&(a=this.helpers.collisionHelper.reservedLayoutAreasByDisplayTime.get(t.displayStart).slots.slice(),a.sort((t,e)=>t.topY-e.topY)),1===a.length)return void r.fillRect(s,i,this.smuflMetrics.stemThickness,n-i);const h=n-e,o=a[a.length-1];r.fillRect(s,e+o.bottomY,this.smuflMetrics.stemThickness,h-o.bottomY);for(let t=a.length-1;t>0;t--){const i=a[t].topY,n=a[t-1].bottomY;n<i&&r.fillRect(s,e+n,this.smuflMetrics.stemThickness,i-n)}}finally{a?.[Symbol.dispose]?.()}}calculateOverflows(t,e){super.calculateOverflows(t,e),this.bar.isEmpty||this.rhythmMode!==y.Hidden&&this.calculateBeamingOverflows(t,e)}}class Mu extends Eh{get staffId(){return xu.StaffId}constructor(t){super(t),this.hideOnPercussionTrack=!0}canCreate(t,e){return e.showTablature&&e.tuning.length>0&&super.canCreate(t,e)}create(t,e){return new xu(t,e)}}class vu{vertical;createLayout;constructor(t,e){this.vertical=t,this.createLayout=e}}class Nu{supportsWorkers;createCanvas;constructor(t,e){this.supportsWorkers=t,this.createCanvas=e}}class Pu{static highDpiFactor=1;static Gx=void 0;static get globalThis(){if(void 0===Pu.Gx){try{Pu.Gx=globalThis}catch{}void 0===Pu.Gx&&(Pu.Gx=self),void 0===Pu.Gx&&(Pu.Gx=global),void 0===Pu.Gx&&(Pu.Gx=window),void 0===Pu.Gx&&(Pu.Gx=Function("return this")())}return Pu.Gx}static webPlatform=Pu.Hx();static isWebPackBundled=Pu.Vx();static isViteBundled=Pu.$x();static scriptFile=Pu.Ux();static fontDirectory=Pu.zx();static get isRunningInWorker(){return"WorkerGlobalScope"in Pu.globalThis}static get isRunningInAudioWorklet(){return"AudioWorkletGlobalScope"in Pu.globalThis}static createWebWorker;static createAudioWorklet;static throttle(t,e){let s=0;return()=>{Pu.globalThis.clearTimeout(s),s=Pu.globalThis.setTimeout(t,e)}}static Ux(){if(!Pu.isRunningInWorker&&Pu.globalThis.ALPHATAB_ROOT){let t=Pu.globalThis.ALPHATAB_ROOT;return t=Pu.ensureFullUrl(t),t=Pu.Xx(t),t}try{const t=import.meta.url;if(t&&-1===t.indexOf("file://"))return t}catch{}return"document"in Pu.globalThis&&document.currentScript&&document.currentScript instanceof HTMLScriptElement?document.currentScript.src:null}static ensureFullUrl(t){if(!t)return"";if(!t.startsWith("http")&&!t.startsWith("https")&&!t.startsWith("file")){let e="";const s=Pu.globalThis.location;if(e+=s.protocol?.toString(),e+="//"?.toString(),s.hostname&&(e+=s.hostname?.toString()),s.port&&(e+=":"?.toString(),e+=s.port?.toString()),!t.startsWith("/")){const t=s.pathname.split("/").slice(0,-1).join("/");t.length>0&&(t.startsWith("/")||(e+="/"?.toString()),e+=t?.toString())}return t.startsWith("/")||(e+="/"?.toString()),e+=t?.toString(),e}return t}static Xx(t){return t&&!t.endsWith(".js")&&(t.endsWith("/")||(t+="/"),t+="alphaTab.js"),t}static zx(){if(!Pu.isRunningInWorker&&Pu.globalThis.ALPHATAB_FONT)return Pu.ensureFullUrl(Pu.globalThis.ALPHATAB_FONT);const t=Pu.scriptFile;if(t){const e=t.lastIndexOf(String.fromCharCode(47));if(e>=0)return`${t.substr(0,e)}/font/`}return null}static jx(){if(!Pu.isRunningInWorker&&Pu.globalThis&&"jQuery"in Pu.globalThis){const t=Pu.globalThis.jQuery,e=new yh;t.fn.alphaTab=function(t){const s=Array.prototype.slice.call(arguments,1);return 1===this.length?e.exec(this[0],t,s):this.each((i,n)=>{e.exec(n,t,s)})},t.alphaTab={restore:yh.restore},t.fn.alphaTab.fn=e}}static renderEngines=Pu.Jx();static layoutEngines=Pu.qx();static staveProfiles=Pu.Yx();static getRenderEngineFactory(t){return t&&Pu.renderEngines.has(t)?Pu.renderEngines.get(t):Pu.renderEngines.get("default")}static getLayoutEngineFactory(t){return t&&Pu.layoutEngines.has(t)?Pu.layoutEngines.get(t):Pu.layoutEngines.get(Je.Page)}static buildImporters(){return[new Hs,new hi,new si,new fi,new Gs,new Le]}static Jx(){const t=new Map;return t.set("svg",new Nu(!0,()=>new Ch)),t.set("default",t.get("svg")),t.set("skia",new Nu(!1,()=>new Nh)),Pu.Kx(t),t}static enableAlphaSkia(t,e){Nh.enable(t,e)}static registerAlphaSkiaCustomFont(t){return Nh.registerFont(t)}static Kx(t){t.set("html5",new Nu(!1,()=>new ya))}static defaultRenderers=[new pu([{effect:new mc,mode:kh.SharedTop},{effect:new Sc,mode:kh.SharedTop},{effect:new Bo,mode:kh.SharedTop},{effect:new Yh,mode:kh.SharedTop},{effect:new uo,mode:kh.SharedTop},{effect:new gc,mode:kh.SharedTop},{effect:new Gh,mode:kh.SharedTop},{effect:new Uh,mode:kh.SharedTop},{effect:new Lh,mode:kh.SharedTop,order:1e3}]),new ou([{effect:new Vh,mode:kh.SharedTop},{effect:new no,mode:kh.SharedTop},{effect:new Rh,mode:kh.SharedTop},{effect:new To,mode:kh.SharedTop},{effect:new Do,mode:kh.SharedTop},{effect:new _c,mode:kh.SharedTop},{effect:new Tc,mode:kh.OwnedTop},{effect:new hc,mode:kh.OwnedTop},{effect:new yc,mode:kh.OwnedTop},{effect:new Po(!0),mode:kh.OwnedTop},{effect:new wo,mode:kh.OwnedTop},{effect:new pc,mode:kh.OwnedTop},{effect:new xc,mode:kh.OwnedTop},{effect:new cc,mode:kh.OwnedTop},{effect:new Mc,mode:kh.OwnedTop},{effect:new lc(!1),mode:kh.OwnedTop},{effect:new so,mode:kh.OwnedTop,shouldCreate:t=>!t.showTablature},{effect:new yo,mode:kh.OwnedTop,shouldCreate:t=>!t.showTablature},{effect:new Ao,mode:kh.OwnedTop,shouldCreate:t=>!t.showTablature},{effect:new Eo,mode:kh.OwnedTop,shouldCreate:t=>!t.showTablature},{effect:new po(bt.Finger),mode:kh.OwnedTop},{effect:new po(bt.Thumb),mode:kh.OwnedBottom},{effect:new Xh,mode:kh.SharedBottom},{effect:new to,mode:kh.SharedBottom},{effect:new dc,mode:kh.SharedBottom}]),new Pl([{effect:new vo,mode:kh.OwnedTop,order:1e3}]),new Mu([{effect:new So,mode:kh.SharedTop},{effect:new fc,mode:kh.OwnedTop},{effect:new yc,mode:kh.OwnedTop},{effect:new xc,mode:kh.OwnedTop},{effect:new cc,mode:kh.OwnedTop},{effect:new Mc,mode:kh.OwnedTop},{effect:new lc(!0),mode:kh.OwnedTop},{effect:new pc,mode:kh.OwnedTop},{effect:new so,mode:kh.OwnedTop},{effect:new mo(f.Natural),mode:kh.OwnedTop},{effect:new mo(f.Artificial),mode:kh.OwnedTop},{effect:new mo(f.Pinch),mode:kh.OwnedTop},{effect:new mo(f.Tap),mode:kh.OwnedTop},{effect:new mo(f.Semi),mode:kh.OwnedTop},{effect:new mo(f.Feedback),mode:kh.OwnedTop},{effect:new yo,mode:kh.OwnedTop},{effect:new lo,mode:kh.OwnedTop},{effect:new Co,mode:kh.OwnedTop},{effect:new Ao,mode:kh.OwnedTop},{effect:new Eo,mode:kh.OwnedTop},{effect:new wo,mode:kh.OwnedTop},{effect:new po(bt.Finger),mode:kh.OwnedTop,shouldCreate:t=>!t.showStandardNotation},{effect:new po(bt.Thumb),mode:kh.OwnedBottom,shouldCreate:t=>!t.showStandardNotation}])];static Yx(){const t=new Map;return t.set(hs.Default,new Set([fu.StaffId,hu.StaffId,Nl.StaffId,xu.StaffId])),t.set(hs.ScoreTab,new Set([fu.StaffId,hu.StaffId,Nl.StaffId,xu.StaffId])),t.set(hs.Score,new Set([hu.StaffId])),t.set(hs.Tab,new Set([xu.StaffId])),t.set(hs.TabMixed,new Set([xu.StaffId])),t}static qx(){const t=new Map;return t.set(Je.Page,new vu(!0,t=>new jc(t))),t.set(Je.Horizontal,new vu(!1,t=>new zc(t))),t.set(Je.Parchment,new vu(!0,t=>new Jc(t))),t}static initializeMain(t,e){Pu.isRunningInWorker||Pu.isRunningInAudioWorklet||(Pu.webPlatform!==ds.Browser&&Pu.webPlatform!==ds.BrowserModule||(Pu.jx(),Pu.highDpiFactor=window.devicePixelRatio),Pu.createWebWorker=t,Pu.createAudioWorklet=e)}static get alphaTabWorker(){return Pu.globalThis.Worker}static get alphaTabUrl(){return Pu.globalThis.URL}static initializeWorker(){if(!Pu.isRunningInWorker)throw new I(s.General,"Not running in worker, cannot run worker initialization");wa.init(),ha.init(),Pu.createWebWorker=t=>{throw new I(s.General,"Nested workers are not supported")}}static initializeAudioWorklet(){if(!Pu.isRunningInAudioWorklet)throw new I(s.General,"Not running in audio worklet, cannot run worklet initialization");Si.init()}static Vx(){try{if("function"==typeof __webpack_require__)return"boolean"!=typeof __ALPHATAB_WEBPACK__&&J.warning("WebPack","Detected bundling with WebPack but @coderline/alphatab-webpack was not used! To ensure alphaTab works as expected use our bundler plugins. Learn more at https://www.alphatab.net/docs/getting-started/installation-webpack"),!0}catch{}return!1}static $x(){try{if("string"==typeof __BASE__)return"boolean"!=typeof __ALPHATAB_VITE__&&J.warning("Vite","Detected bundling with Vite but @coderline/alphatab-vite was not used! To ensure alphaTab works as expected use our bundler plugins. Learn more at https://www.alphatab.net/docs/getting-started/installation-vite"),!0}catch{}return!1}static Hx(){if(!(void 0!==Pu.globalThis.Window&&Pu.globalThis instanceof Pu.globalThis.Window))try{if("[object process]"===Object.prototype.toString.call("undefined"!=typeof process?process:0))return ds.NodeJs}catch{}try{const t=import.meta.url;if(t&&"string"==typeof t&&!t.startsWith("file://"))return ds.BrowserModule}catch{}return ds.Browser}static printEnvironmentInfo(t=!0){const e=t?t=>{J.log.debug("VersionInfo",t)}:t=>{J.debug("VersionInfo",t)};G.print(e),e(`High DPI: ${Pu.highDpiFactor}`),Pu.Qx(e)}static Qx(t){t(`Platform: ${ds[Pu.webPlatform]}`),t(`WebPack: ${Pu.isWebPackBundled}`),t(`Vite: ${Pu.isViteBundled}`),Pu.webPlatform!==ds.NodeJs&&(t(`Browser: ${navigator.userAgent}`),t(`Window Size: ${window.outerWidth}x${window.outerHeight}`),t(`Screen Size: ${window.screen.width}x${window.screen.height}`))}static prepareForPostMessage(t){if(!t)return t;if("object"==typeof t){const e=t.Zx;if(e)return Pu.prepareForPostMessage(e)}return t}static quoteJsonString(t){return JSON.stringify(t)}static sortDescending(t){t.sort((t,e)=>e-t)}}!function(t){t[t.EmbeddedOpenType=0]="EmbeddedOpenType",t[t.Woff=1]="Woff",t[t.Woff2=2]="Woff2",t[t.OpenType=3]="OpenType",t[t.TrueType=4]="TrueType",t[t.Svg=5]="Svg"}(Mh||(Mh={}));class Cu{scriptFile=null;fontDirectory=null;smuflFontSources=null;static buildDefaultSmuflFontSources(t){const e=new Map,s=t??"";return e.set(Mh.Woff2,`${s}Bravura.woff2`),e.set(Mh.Woff,`${s}Bravura.woff`),e.set(Mh.OpenType,`${s}Bravura.otf`),e}file=null;tex=!1;tracks=null;enableLazyLoading=!0;engine="default";logLevel=_.Info;useWorkers=!0;includeNoteBounds=!1;constructor(){this.scriptFile=Pu.scriptFile,this.fontDirectory=Pu.fontDirectory}}const Eu=Object.freeze(Object.defineProperty({__proto__:null,get AlphaTexAccidentalMode(){return Mt},AlphaTexDiagnosticBag:le,get AlphaTexDiagnosticCode(){return xt},get AlphaTexDiagnosticsSeverity(){return Tt},AlphaTexLexer:fe,get AlphaTexNodeType(){return _t},get AlphaTexParseMode(){return Ct},AlphaTexParser:pe,get AlphaTexStaffNoteKind(){return Nt},get AlphaTexVoiceMode(){return vt},get ArgumentListParseTypesMode(){return Pt}},Symbol.toStringTag,{value:"Module"})),Fu=Object.freeze(Object.defineProperty({__proto__:null,AlphaTexErrorWithDiagnostics:Ae,AlphaTexImporter:Le,ScoreImporter:Ce,ScoreLoader:ah,UnsupportedFormatError:Ee,alphaTex:Eu},Symbol.toStringTag,{value:"Module"})),Au=Object.freeze(Object.defineProperty({__proto__:null,ByteBuffer:Fe,IOHelper:de},Symbol.toStringTag,{value:"Module"}));class Du{data;settings;init(t,e){this.data=t,this.settings=e}export(t,e=null){const s=Fe.withCapacity(1024);return this.init(s,e??new ra),this.writeScore(t),s.toArray()}}class Lu{tex="";isStartOfLine=!0;indentString="";currentIndent=0;indent(){this.indentString.length>0&&this.currentIndent++}outdent(){this.indentString.length>0&&this.currentIndent--}tM(){if(this.isStartOfLine&&this.indentString.length>0)for(let t=0;t<this.currentIndent;t++)this.tex+=this.indentString;this.isStartOfLine=!1}write(t){this.tM(),this.tex+=t,this.isStartOfLine=!1}writeString(t){this.tM(),this.tex+=Pu.quoteJsonString(t)}writeLine(t){this.tM(),void 0!==t&&(this.tex+=t),this.indentString.length>0?this.tex+="\n":this.tex.endsWith(" ")||(this.tex+=" "),this.isStartOfLine=!0}}class Wu{eM;sM=!1;get tex(){return this.eM.tex}constructor(t){const e=new Lu;this.sM=t.exporter.comments,e.indentString=t.exporter.indent>0?" ".repeat(t.exporter.indent):"",this.eM=e}writeScoreNode(t){this.iM(t.leadingComments);for(const e of t.bars)this.nM(e);this.iM(t.trailingComments)}nM(t){this.iM(t.leadingComments),this.rM(t.metaData),this.eM.indent();for(const e of t.beats)this.aM(e);this.eM.outdent(),this.iM(t.trailingComments),this.hM(t.pipe,!0)}aM(t){this.iM(t.leadingComments),t.durationChange&&this.oM(t.durationChange),t.rest?this.cM(t.rest):t.notes&&this.lM(t.notes),this.hM(t.durationDot,!1),this.cM(t.durationValue),this.hM(t.beatMultiplier,!1),this.cM(t.beatMultiplierValue),t.beatEffects&&this.uM(t.beatEffects,!1),this.iM(t.trailingComments),this.eM.writeLine()}lM(t){this.iM(t.leadingComments),this.hM(t.openParenthesis,!1);let e=!0;for(const s of t.notes)e||this.eM.write(" "),this.dM(s),e=!1;this.hM(t.closeParenthesis,!1),this.iM(t.trailingComments)}dM(t){this.iM(t.leadingComments),this.cM(t.noteValue),this.hM(t.noteStringDot,!1),this.cM(t.noteString),t.noteEffects&&this.uM(t.noteEffects,!1),this.iM(t.trailingComments)}oM(t){this.iM(t.leadingComments),this.hM(t.colon,!1),this.cM(t.value),t.properties&&(this.eM.write(" "),this.uM(t.properties,!1)),this.iM(t.trailingComments),this.eM.write(" ")}rM(t){for(const e of t)this.fM(e)}pM=0;bM=0;X_=0;fM(t){switch(t.tag.tag.text){case"track":this.bM>0&&this.eM.outdent(),this.pM>0&&this.eM.outdent();break;case"staff":this.bM>0&&this.eM.outdent();break;case"voice":this.X_>0&&this.eM.outdent()}this.iM(t.leadingComments),this.hM(t.tag.prefix,!1),this.cM(t.tag.tag);let e=!0;switch(t.propertiesBeforeArguments?(t.properties&&(this.eM.write(" "),this.uM(t.properties,!1)),t.arguments&&(this.eM.write(" "),this.mM(t.arguments))):(t.arguments&&(this.eM.write(" "),this.mM(t.arguments)),t.properties&&(this.eM.write(" "),this.uM(t.properties,!0),e=!1)),t.trailingComments&&(this.eM.write(" "),this.iM(t.trailingComments)),t.tag.tag.text){case"track":this.pM++,this.bM=0,this.X_=0,this.eM.indent();break;case"staff":this.bM++,this.X_=0,this.eM.indent();break;case"voice":this.X_++,this.eM.indent()}e&&this.eM.writeLine()}uM(t,e){this.iM(t.leadingComments),this.hM(t.openBrace,e),e&&this.eM.indent();let s=!0;for(const i of t.properties)s||e||this.eM.write(" "),this.gM(i),s=!1,e&&this.eM.writeLine();e&&this.eM.outdent(),this.hM(t.closeBrace,e),this.iM(t.trailingComments)}gM(t){this.iM(t.leadingComments),this.cM(t.property),t.arguments&&(this.eM.write(" "),this.mM(t.arguments)),this.iM(t.trailingComments)}mM(t){this.iM(t.leadingComments),this.hM(t.openParenthesis,!1);let e=!0;for(const s of t.arguments)e||this.eM.write(" "),this.cM(s),e=!1;this.hM(t.closeParenthesis,!1),this.iM(t.trailingComments)}cM(t){if(t){switch(this.iM(t.leadingComments),t.nodeType){case _t.Ident:this.eM.write(t.text);break;case _t.Arguments:this.mM(t);break;case _t.Number:this.eM.write(t.value.toString());break;case _t.String:this.eM.writeString(t.text)}this.iM(t.trailingComments)}}hM(t,e){if(t){switch(this.iM(t.leadingComments),t.nodeType){case _t.Dot:this.eM.write(".");break;case _t.Backslash:this.eM.write("\\");break;case _t.DoubleBackslash:this.eM.write("\\\\");break;case _t.Pipe:this.eM.write("|");break;case _t.LBrace:this.eM.write("{");break;case _t.RBrace:this.eM.write("}");break;case _t.LParen:this.eM.write("(");break;case _t.RParen:this.eM.write(")");break;case _t.Colon:this.eM.write(":");break;case _t.Asterisk:this.eM.write("*")}this.iM(t.trailingComments),e&&this.eM.writeLine()}}iM(t){if(this.sM&&t)for(const e of t){let t=e.text;t.startsWith(" ")||(t=` ${t}`),e.multiLine?(t.endsWith(" ")||(t+=" "),this.eM.write(`/*${t}*/`)):this.eM.writeLine(`//${t}`)}}}class Ou{icon=Ru.Piano;instrumentSetName;instrumentSetType;constructor(t,e,s=null){if(this.icon=t,this.instrumentSetName=e,s)this.instrumentSetType=s;else{const t=e.split(" ");t[0]=t[0].substr(0,1).toLowerCase()+t[0].substr(1),this.instrumentSetType=t.join("")}}}var Ru;!function(t){t[t.SteelGuitar=1]="SteelGuitar",t[t.AcousticGuitar=2]="AcousticGuitar",t[t.TwelveStringGuitar=3]="TwelveStringGuitar",t[t.ElectricGuitar=4]="ElectricGuitar",t[t.Bass=5]="Bass",t[t.ClassicalGuitar=23]="ClassicalGuitar",t[t.UprightBass=6]="UprightBass",t[t.Ukulele=7]="Ukulele",t[t.Banjo=8]="Banjo",t[t.Mandolin=9]="Mandolin",t[t.Piano=10]="Piano",t[t.Synth=12]="Synth",t[t.Strings=11]="Strings",t[t.Brass=13]="Brass",t[t.Reed=14]="Reed",t[t.Woodwind=15]="Woodwind",t[t.Vocal=16]="Vocal",t[t.PitchedIdiophone=17]="PitchedIdiophone",t[t.Fx=21]="Fx",t[t.PercussionKit=18]="PercussionKit",t[t.Idiophone=19]="Idiophone",t[t.Membraphone=20]="Membraphone"}(Ru||(Ru={}));class Iu{lineCount=0;name="";type="";elements=[];static create(t,e,s,i){const n=new Iu;return n.name=t,n.type=e,n.lineCount=s,n.elements=i,n}}class Gu{name;type;soundbankName;articulations;constructor(t,e,s,i){this.name=t,this.type=e,this.soundbankName=s,this.articulations=i}}class Hu{name;staffLine;noteHeads;techniqueSymbol;techniqueSymbolPlacement;inputMidiNumbers;outputMidiNumber;outputRSESound;constructor(t,e,s,i,n,r,a,h){this.name=t,this.staffLine=e,this.noteHeads=s,this.techniqueSymbol=i,this.techniqueSymbolPlacement=n,this.inputMidiNumbers=r,this.outputMidiNumber=a,this.outputRSESound=h}static template(t,e,s){return new Hu(t,0,[],lt.None,ut.Outside,e,0,s)}}class Vu{static wM=new Map([[0,new Ou(Ru.Piano,"Acoustic Piano")],[1,new Ou(Ru.Piano,"Acoustic Piano")],[2,new Ou(Ru.Piano,"Electric Piano")],[3,new Ou(Ru.Piano,"Acoustic Piano")],[4,new Ou(Ru.Piano,"Electric Piano")],[5,new Ou(Ru.Piano,"Electric Piano")],[6,new Ou(Ru.Piano,"Harpsichord")],[7,new Ou(Ru.Piano,"Harpsichord")],[8,new Ou(Ru.PitchedIdiophone,"Celesta")],[9,new Ou(Ru.PitchedIdiophone,"Vibraphone")],[10,new Ou(Ru.PitchedIdiophone,"Vibraphone")],[11,new Ou(Ru.PitchedIdiophone,"Vibraphone")],[12,new Ou(Ru.PitchedIdiophone,"Xylophone")],[13,new Ou(Ru.PitchedIdiophone,"Xylophone")],[14,new Ou(Ru.PitchedIdiophone,"Vibraphone")],[15,new Ou(Ru.Banjo,"Banjo")],[16,new Ou(Ru.Piano,"Electric Organ")],[17,new Ou(Ru.Piano,"Electric Organ")],[18,new Ou(Ru.Piano,"Electric Organ")],[19,new Ou(Ru.Piano,"Electric Organ")],[20,new Ou(Ru.Piano,"Electric Organ")],[21,new Ou(Ru.Piano,"Electric Organ")],[22,new Ou(Ru.Woodwind,"Recorder")],[23,new Ou(Ru.Piano,"Electric Organ")],[24,new Ou(Ru.ClassicalGuitar,"Nylon Guitar")],[25,new Ou(Ru.SteelGuitar,"Steel Guitar")],[26,new Ou(Ru.SteelGuitar,"Electric Guitar")],[27,new Ou(Ru.ElectricGuitar,"Electric Guitar")],[28,new Ou(Ru.ElectricGuitar,"Electric Guitar")],[29,new Ou(Ru.ElectricGuitar,"Electric Guitar")],[30,new Ou(Ru.SteelGuitar,"Electric Guitar")],[31,new Ou(Ru.SteelGuitar,"Electric Guitar")],[32,new Ou(Ru.Bass,"Acoustic Bass")],[33,new Ou(Ru.Bass,"Electric Bass")],[34,new Ou(Ru.Bass,"Electric Bass")],[35,new Ou(Ru.Bass,"Acoustic Bass")],[36,new Ou(Ru.Bass,"Electric Bass")],[37,new Ou(Ru.Bass,"Electric Bass")],[38,new Ou(Ru.Synth,"Synth Bass")],[39,new Ou(Ru.Synth,"Synth Bass")],[40,new Ou(Ru.Strings,"Violin")],[41,new Ou(Ru.Strings,"Viola")],[42,new Ou(Ru.Strings,"Cello")],[43,new Ou(Ru.Strings,"Contrabass")],[44,new Ou(Ru.Strings,"Violin")],[45,new Ou(Ru.Strings,"Violin")],[46,new Ou(Ru.Piano,"Harp")],[47,new Ou(Ru.Membraphone,"Timpani")],[48,new Ou(Ru.Strings,"Violin")],[49,new Ou(Ru.Strings,"Violin")],[50,new Ou(Ru.Strings,"Violin")],[51,new Ou(Ru.Strings,"Violin")],[52,new Ou(Ru.Vocal,"Voice")],[53,new Ou(Ru.Vocal,"Voice")],[54,new Ou(Ru.Vocal,"Voice")],[55,new Ou(Ru.Synth,"Pad Synthesizer")],[56,new Ou(Ru.Brass,"Trumpet")],[57,new Ou(Ru.Brass,"Trombone")],[58,new Ou(Ru.Brass,"Tuba")],[59,new Ou(Ru.Brass,"Trumpet")],[60,new Ou(Ru.Brass,"French Horn")],[61,new Ou(Ru.Brass,"Trumpet")],[62,new Ou(Ru.Brass,"Trumpet")],[63,new Ou(Ru.Brass,"Trumpet")],[64,new Ou(Ru.Reed,"Saxophone")],[65,new Ou(Ru.Reed,"Saxophone")],[66,new Ou(Ru.Reed,"Saxophone")],[67,new Ou(Ru.Reed,"Saxophone")],[68,new Ou(Ru.Reed,"Oboe")],[69,new Ou(Ru.Reed,"English Horn")],[70,new Ou(Ru.Reed,"Bassoon")],[71,new Ou(Ru.Reed,"Clarinet")],[72,new Ou(Ru.Reed,"Piccolo")],[73,new Ou(Ru.Woodwind,"Flute")],[74,new Ou(Ru.Woodwind,"Recorder")],[75,new Ou(Ru.Woodwind,"Flute")],[76,new Ou(Ru.Woodwind,"Recorder")],[77,new Ou(Ru.Woodwind,"Flute")],[78,new Ou(Ru.Woodwind,"Recorder")],[79,new Ou(Ru.Woodwind,"Flute")],[80,new Ou(Ru.Synth,"Lead Synthesizer")],[81,new Ou(Ru.Synth,"Lead Synthesizer")],[82,new Ou(Ru.Synth,"Lead Synthesizer")],[83,new Ou(Ru.Synth,"Lead Synthesizer")],[84,new Ou(Ru.Synth,"Lead Synthesizer")],[85,new Ou(Ru.Synth,"Lead Synthesizer")],[86,new Ou(Ru.Synth,"Lead Synthesizer")],[87,new Ou(Ru.Synth,"Lead Synthesizer")],[88,new Ou(Ru.Synth,"Pad Synthesizer")],[89,new Ou(Ru.Synth,"Pad Synthesizer")],[90,new Ou(Ru.Synth,"Pad Synthesizer")],[91,new Ou(Ru.Synth,"Pad Synthesizer")],[92,new Ou(Ru.Synth,"Pad Synthesizer")],[93,new Ou(Ru.Synth,"Pad Synthesizer")],[94,new Ou(Ru.Synth,"Pad Synthesizer")],[95,new Ou(Ru.Synth,"Pad Synthesizer")],[96,new Ou(Ru.Fx,"Pad Synthesizer")],[97,new Ou(Ru.Fx,"Pad Synthesizer")],[98,new Ou(Ru.Fx,"Pad Synthesizer")],[99,new Ou(Ru.Fx,"Pad Synthesizer")],[100,new Ou(Ru.Fx,"Lead Synthesizer")],[101,new Ou(Ru.Fx,"Lead Synthesizer")],[102,new Ou(Ru.Fx,"Lead Synthesizer")],[103,new Ou(Ru.Fx,"Trumpet")],[104,new Ou(Ru.ElectricGuitar,"Banjo")],[105,new Ou(Ru.Banjo,"Banjo")],[106,new Ou(Ru.Ukulele,"Ukulele")],[107,new Ou(Ru.Banjo,"Banjo")],[108,new Ou(Ru.PitchedIdiophone,"Xylophone")],[109,new Ou(Ru.Reed,"Bassoon")],[110,new Ou(Ru.Strings,"Violin")],[111,new Ou(Ru.Woodwind,"Flute")],[112,new Ou(Ru.PitchedIdiophone,"Xylophone")],[113,new Ou(Ru.Idiophone,"Celesta")],[114,new Ou(Ru.PitchedIdiophone,"Vibraphone")],[115,new Ou(Ru.Idiophone,"Xylophone")],[116,new Ou(Ru.Membraphone,"Xylophone")],[117,new Ou(Ru.Membraphone,"Xylophone")],[118,new Ou(Ru.Membraphone,"Xylophone")],[119,new Ou(Ru.Idiophone,"Celesta")],[120,new Ou(Ru.Fx,"Steel Guitar")],[121,new Ou(Ru.Fx,"Recorder")],[122,new Ou(Ru.Fx,"Recorder")],[123,new Ou(Ru.Fx,"Recorder")],[124,new Ou(Ru.Fx,"Recorder")],[125,new Ou(Ru.Fx,"Recorder")],[126,new Ou(Ru.Fx,"Recorder")],[127,new Ou(Ru.Fx,"Timpani")]]);static yM=Iu.create("Drums","drumKit",5,[new Gu("Snare","snare","Master-Snare",[Hu.template("Snare (hit)",[38],"stick.hit.hit"),Hu.template("Snare (side stick)",[37],"stick.hit.sidestick"),Hu.template("Snare (rim shot)",[91],"stick.hit.rimshot")]),new Gu("Charley","hiHat","Master-Hihat",[Hu.template("Hi-Hat (closed)",[42],"stick.hit.closed"),Hu.template("Hi-Hat (half)",[92],"stick.hit.half"),Hu.template("Hi-Hat (open)",[46],"stick.hit.open"),Hu.template("Pedal Hi-Hat (hit)",[44],"pedal.hit.pedal")]),new Gu("Acoustic Kick Drum","kickDrum","AcousticKick-Percu",[Hu.template("Kick (hit)",[35],"pedal.hit.hit")]),new Gu("Kick Drum","kickDrum","Master-Kick",[Hu.template("Kick (hit)",[36],"pedal.hit.hit")]),new Gu("Tom Very High","tom","Master-Tom05",[Hu.template("High Floor Tom (hit)",[50],"stick.hit.hit")]),new Gu("Tom High","tom","Master-Tom04",[Hu.template("High Tom (hit)",[48],"stick.hit.hit")]),new Gu("Tom Medium","tom","Master-Tom03",[Hu.template("Mid Tom (hit)",[47],"stick.hit.hit")]),new Gu("Tom Low","tom","Master-Tom02",[Hu.template("Low Tom (hit)",[45],"stick.hit.hit")]),new Gu("Tom Very Low","tom","Master-Tom01",[Hu.template("Very Low Tom (hit)",[43],"stick.hit.hit")]),new Gu("Ride","ride","Master-Ride",[Hu.template("Ride (edge)",[93],"stick.hit.edge"),Hu.template("Ride (middle)",[51],"stick.hit.mid"),Hu.template("Ride (bell)",[53],"stick.hit.bell"),Hu.template("Ride (choke)",[94],"stick.hit.choke")]),new Gu("Splash","splash","Master-Splash",[Hu.template("Splash (hit)",[55],"stick.hit.hit"),Hu.template("Splash (choke)",[95],"stick.hit.choke")]),new Gu("China","china","Master-China",[Hu.template("China (hit)",[52],"stick.hit.hit"),Hu.template("China (choke)",[96],"stick.hit.choke")]),new Gu("Crash High","crash","Master-Crash02",[Hu.template("Crash high (hit)",[49],"stick.hit.hit"),Hu.template("Crash high (choke)",[97],"stick.hit.choke")]),new Gu("Crash Medium","crash","Master-Crash01",[Hu.template("Crash medium (hit)",[57],"stick.hit.hit"),Hu.template("Crash medium (choke)",[98],"stick.hit.choke")]),new Gu("Cowbell Low","cowbell","CowbellBig-Percu",[Hu.template("Cowbell low (hit)",[99],"stick.hit.hit"),Hu.template("Cowbell low (tip)",[100],"stick.hit.tip")]),new Gu("Cowbell Medium","cowbell","CowbellMid-Percu",[Hu.template("Cowbell medium (hit)",[56],"stick.hit.hit"),Hu.template("Cowbell medium (tip)",[101],"stick.hit.tip")]),new Gu("Cowbell High","cowbell","CowbellSmall-Percu",[Hu.template("Cowbell high (hit)",[102],"stick.hit.hit"),Hu.template("Cowbell high (tip)",[103],"stick.hit.tip")]),new Gu("Woodblock Low","woodblock","WoodblockLow-Percu",[Hu.template("Woodblock low (hit)",[77],"stick.hit.hit")]),new Gu("Woodblock High","woodblock","WoodblockHigh-Percu",[Hu.template("Woodblock high (hit)",[76],"stick.hit.hit")]),new Gu("Bongo High","bongo","BongoHigh-Percu",[Hu.template("Bongo High (hit)",[60],"hand.hit.hit"),Hu.template("Bongo High (mute)",[104],"hand.hit.mute"),Hu.template("Bongo High (slap)",[105],"hand.hit.slap")]),new Gu("Bongo Low","bongo","BongoLow-Percu",[Hu.template("Bongo Low (hit)",[61],"hand.hit.hit"),Hu.template("Bongo Low (mute)",[106],"hand.hit.mute"),Hu.template("Bongo Low (slap)",[107],"hand.hit.slap")]),new Gu("Timbale Low","timbale","TimbaleLow-Percu",[Hu.template("Timbale low (hit)",[66],"stick.hit.hit")]),new Gu("Timbale High","timbale","TimbaleHigh-Percu",[Hu.template("Timbale high (hit)",[65],"stick.hit.hit")]),new Gu("Agogo Low","agogo","AgogoLow-Percu",[Hu.template("Agogo low (hit)",[68],"stick.hit.hit")]),new Gu("Agogo High","agogo","AgogoHigh-Percu",[Hu.template("Agogo high (hit)",[67],"stick.hit.hit")]),new Gu("Conga Low","conga","CongaLow-Percu",[Hu.template("Conga low (hit)",[64],"hand.hit.hit"),Hu.template("Conga low (slap)",[108],"hand.hit.slap"),Hu.template("Conga low (mute)",[109],"hand.hit.mute")]),new Gu("Conga High","conga","CongaHigh-Percu",[Hu.template("Conga high (hit)",[63],"hand.hit.hit"),Hu.template("Conga high (slap)",[110],"hand.hit.slap"),Hu.template("Conga high (mute)",[62],"hand.hit.mute")]),new Gu("Whistle Low","whistle","WhistleLow-Percu",[Hu.template("Whistle low (hit)",[72],"blow.hit.hit")]),new Gu("Whistle High","whistle","WhistleHigh-Percu",[Hu.template("Whistle high (hit)",[71],"blow.hit.hit")]),new Gu("Guiro","guiro","Guiro-Percu",[Hu.template("Guiro (hit)",[73],"stick.hit.hit"),Hu.template("Guiro (scrap-return)",[74],"stick.scrape.return")]),new Gu("Surdo","surdo","Surdo-Percu",[Hu.template("Surdo (hit)",[86],"brush.hit.hit"),Hu.template("Surdo (mute)",[87],"brush.hit.mute")]),new Gu("Tambourine","tambourine","Tambourine-Percu",[Hu.template("Tambourine (hit)",[54],"hand.hit.hit"),Hu.template("Tambourine (return)",[111],"hand.hit.return"),Hu.template("Tambourine (roll)",[112],"hand.hit.roll"),Hu.template("Tambourine (hand)",[113],"hand.hit.handhit")]),new Gu("Cuica","cuica","Cuica-Percu",[Hu.template("Cuica (open)",[79],"hand.hit.hit"),Hu.template("Cuica (mute)",[78],"hand.hit.mute")]),new Gu("Vibraslap","vibraslap","Vibraslap-Percu",[Hu.template("Vibraslap (hit)",[58],"hand.hit.hit")]),new Gu("Triangle","triangle","Triangle-Percu",[Hu.template("Triangle (hit)",[81],"stick.hit.hit"),Hu.template("Triangle (mute)",[80],"stick.hit.mute")]),new Gu("Grancassa","grancassa","Grancassa-Percu",[Hu.template("Grancassa (hit)",[114],"mallet.hit.hit")]),new Gu("Piatti","piatti","Piatti-Percu",[Hu.template("Piatti (hit)",[115],"hand.hit.hit"),Hu.template("Piatti (hand)",[116],"hand.hit.hit")]),new Gu("Cabasa","cabasa","Cabasa-Percu",[Hu.template("Cabasa (hit)",[69],"hand.hit.hit"),Hu.template("Cabasa (return)",[117],"hand.hit.return")]),new Gu("Castanets","castanets","Castanets-Percu",[Hu.template("Castanets (hit)",[85],"hand.hit.hit")]),new Gu("Claves","claves","Claves-Percu",[Hu.template("Claves (hit)",[75],"stick.hit.hit")]),new Gu("Left Maraca","maraca","Maracas-Percu",[Hu.template("Left Maraca (hit)",[70],"hand.hit.hit"),Hu.template("Left Maraca (return)",[118],"hand.hit.return")]),new Gu("Right Maraca","maraca","Maracas-Percu",[Hu.template("Right Maraca (hit)",[119],"hand.hit.hit"),Hu.template("Right Maraca (return)",[120],"hand.hit.return")]),new Gu("Shaker","shaker","ShakerStudio-Percu",[Hu.template("Shaker (hit)",[82],"hand.hit.hit"),Hu.template("Shaker (return)",[122],"hand.hit.return")]),new Gu("Bell Tree","bellTree","BellTree-Percu",[Hu.template("Bell Tree (hit)",[84],"stick.hit.hit"),Hu.template("Bell Tree (return)",[123],"stick.hit.return")]),new Gu("Jingle Bell","jingleBell","JingleBell-Percu",[Hu.template("Jingle Bell (hit)",[83],"stick.hit.hit")]),new Gu("Tinkle Bell","jingleBell","JingleBell-Percu",[Hu.template("Tinkle Bell (hit)",[83],"stick.hit.hit")]),new Gu("Golpe","unpitched","Golpe-Percu",[Hu.template("Golpe (thumb)",[124],"thumb.hit.body"),Hu.template("Golpe (finger)",[125],"finger4.hit.body")]),new Gu("Hand Clap","handClap","GroupHandClap-Percu",[Hu.template("Hand Clap (hit)",[39],"hand.hit.hit")]),new Gu("Electric Snare","snare","ElectricSnare-Percu",[Hu.template("Electric Snare (hit)",[40],"stick.hit.hit")]),new Gu("Sticks","snare","Stick-Percu",[Hu.template("Snare (side stick)",[31],"stick.hit.sidestick")]),new Gu("Very Low Floor Tom","tom","LowFloorTom-Percu",[Hu.template("Low Floor Tom (hit)",[41],"stick.hit.hit")]),new Gu("Ride Cymbal 2","ride","Ride-Percu",[Hu.template("Ride (edge)",[59],"stick.hit.edge"),Hu.template("Ride (middle)",[126],"stick.hit.mid"),Hu.template("Ride (bell)",[127],"stick.hit.bell"),Hu.template("Ride (choke)",[29],"stick.hit.choke")]),new Gu("Reverse Cymbal","crash","Reverse-Cymbal",[Hu.template("Reverse Cymbal (hit)",[30],"stick.hit.hit")]),new Gu("Metronome","snare","Metronome-Percu",[Hu.template("Metronome (hit)",[33],"stick.hit.sidestick"),Hu.template("Metronome (bell)",[34],"stick.hit.hit")])]);static kM=void 0;static SM=void 0;static BM(){const t=Vu.yM,e=new Map,s=new Map;for(const i of t.elements)for(const t of i.articulations)for(const n of t.inputMidiNumbers){const r=`${i.name}.${n}`;e.set(r,i),s.set(r,t)}return Vu.kM=e,Vu.SM=s,e}static getIconId(t){return 9===t.primaryChannel?Ru.PercussionKit:Vu.wM.has(t.program)?Vu.wM.get(t.program).icon:Ru.SteelGuitar}static buildInstrumentSet(t){return t.percussionArticulations.length>0||t.isPercussion?Vu._M(t):Vu.TM(t)}static xM=new Gu("Pitched","pitched","",[new Hu("",0,[lt.NoteheadBlack,lt.NoteheadHalf,lt.NoteheadWhole],lt.None,ut.Outside,[],0,"")]);static TM(t){const e=new Iu;e.lineCount=t.staves[0].standardNotationLineCount;const s=Vu.wM.has(t.playbackInfo.program)?Vu.wM.get(t.playbackInfo.program):Vu.wM.get(0);e.name=s.instrumentSetName,e.type=s.instrumentSetType;const i=new Gu(Vu.xM.name,Vu.xM.type,Vu.xM.soundbankName,[Vu.xM.articulations[0]]);return e.elements.push(i),e}static _M(t){Vu.kM||Vu.BM();const e=new Iu;e.lineCount=t.staves[0].standardNotationLineCount,e.name="Drums",e.type="drumKit";const s=t.percussionArticulations.length>0?t.percussionArticulations:Array.from(Jt.instrumentArticulations.values());let i;for(const t of s){const s=new Hu(t.elementType,t.staffLine,[t.noteHeadDefault,t.noteHeadHalf,t.noteHeadWhole],t.techniqueSymbol,t.techniqueSymbolPlacement,[t.id],t.outputMidiNumber,""),n=t.uniqueId;if(Vu.SM.has(n)){const t=Vu.SM.get(n);s.inputMidiNumbers=t.inputMidiNumbers,s.name=t.name,s.outputRSESound=t.outputRSESound}if(Vu.kM.has(n)){const s=Vu.kM.get(n);i&&i.name===t.elementType||(i=new Gu(s.name,s.type,s.soundbankName,[]),e.elements.push(i))}else i&&i.name===t.elementType||(i=new Gu(t.elementType,t.elementType,"",[]),e.elements.push(i));i.articulations.push(s)}return e}}class $u{static Ta=44100;MM=new Map;writeXml(t){const e=new xs;return this.MM=new Map,this.vM(e,t),e.toFormattedString("",!0)}vM(t,e){const s=t.addElement("GPIF");s.addElement("GPVersion").innerText="8.1.3";const i=s.addElement("GPRevision");i.attributes.set("required","12024"),i.attributes.set("recommended","13000"),i.innerText="13007";const n=s.addElement("Encoding");n.addElement("EncodingDescription").innerText="GP8";const r=new Ss;r.nodeType=Ve.Comment,r.value=`Written by alphaTab ${G.version} (${G.commit})`,n.addChild(r),this.NM(s,e),this.PM(s,e),this.CM(s,e),this.EM(s,e),this.FM(s,e),this.AM(s,e),this.DM(s,e);const a=s.addElement("Bars"),h=s.addElement("Voices"),o=s.addElement("Beats"),c=s.addElement("Notes"),l=s.addElement("Rhythms");for(const t of e.tracks)for(const e of t.staves)for(const t of e.bars){this.LM(a,t);for(const e of t.voices){this.WM(h,e);for(const t of e.beats){this.OM(o,t,l);for(const e of t.notes)this.RM(c,e)}}}}DM(t,e){if(!e.backingTrack?.rawAudioFile)return;const s=t.addElement("Assets").addElement("Asset");s.attributes.set("id",this.xa),this.backingTrackAssetFileName="Content/Assets/backing-track",s.addElement("EmbeddedFilePath").setCData(this.backingTrackAssetFileName)}xa;IM;backingTrackAssetFileName;CM(t,e){if(!e.backingTrack?.rawAudioFile)return;const s=t.addElement("BackingTrack");this.xa="0",s.addElement("IconId").innerText="21",s.addElement("Color").innerText="0 0 0",s.addElement("Name").setCData("Audio Track"),s.addElement("ShortName").setCData("a.track"),s.addElement("PlaybackState").innerText="Default",s.addElement("Enabled").innerText="true",s.addElement("Source").innerText="Local",s.addElement("AssetId").innerText="0";const i=s.addElement("ChannelStrip");i.addElement("Parameters").innerText="0.500000 0.500000 0.500000 0.500000 0.500000 0.500000 0.500000 0.500000 0.500000 0.000000 0.500000 0.500000 0.800000 0.500000 0.500000 0.500000",i.addElement("YouTubeVideoUrl").innerText="",i.addElement("Filter").innerText="6",i.addElement("FramesPerPixel").innerText="400";const n=void 0!==this.IM?this.IM:0;s.addElement("FramePadding").innerText=`${n}`,s.addElement("Semitones").innerText="0",s.addElement("Cents").innerText="0"}RM(t,e){const s=t.addElement("Note");s.attributes.set("id",e.id.toString()),this.GM(s,e),e.isGhost&&(s.addElement("AntiAccent").innerText="normal"),e.isLetRing&&s.addElement("LetRing"),e.isTrill&&(s.addElement("Trill").innerText=e.trillValue.toString());let i=0;switch(e.isStaccato&&(i|=1),e.accentuated){case u.Normal:i|=8;break;case u.Heavy:i|=4;break;case u.Tenuto:i|=16}if(i>0&&(s.addElement("Accent").innerText=i.toString()),e.isTieOrigin||e.isTieDestination){const t=s.addElement("Tie");t.attributes.set("origin",e.isTieOrigin?"true":"false"),t.attributes.set("destination",e.isTieDestination?"true":"false")}switch(e.vibrato){case w.Slight:s.addElement("Vibrato").innerText="Slight";break;case w.Wide:s.addElement("Vibrato").innerText="Wide"}if(e.isFingering){switch(e.leftHandFinger){case d.Thumb:s.addElement("LeftFingering").innerText="P";break;case d.IndexFinger:s.addElement("LeftFingering").innerText="I";break;case d.MiddleFinger:s.addElement("LeftFingering").innerText="M";break;case d.AnnularFinger:s.addElement("LeftFingering").innerText="A";break;case d.LittleFinger:s.addElement("LeftFingering").innerText="C"}switch(e.rightHandFinger){case d.Thumb:s.addElement("RightFingering").innerText="P";break;case d.IndexFinger:s.addElement("RightFingering").innerText="I";break;case d.MiddleFinger:s.addElement("RightFingering").innerText="M";break;case d.AnnularFinger:s.addElement("RightFingering").innerText="A";break;case d.LittleFinger:s.addElement("RightFingering").innerText="C"}}e.percussionArticulation>=0?s.addElement("InstrumentArticulation").innerText=e.percussionArticulation.toString():s.addElement("InstrumentArticulation").innerText="0",e.ornament!==dt.None&&(s.addElement("Ornament").innerText=dt[e.ornament])}GM(t,e){const s=t.addElement("Properties");if(this.HM(s,e),this.VM(s,e),e.isStringed&&(this.$M(s,"String","String",(e.string-1).toString()),this.$M(s,"Fret","Fret",e.fret.toString()),this.$M(s,"Midi","Number",e.realValue.toString()),e.showStringNumber&&this.$M(s,"ShowStringNumber","Enable",null)),e.isPiano&&(this.$M(s,"Octave","Number",e.octave.toString()),this.$M(s,"Tone","Step",e.tone.toString()),this.$M(s,"Midi","Number",e.realValue.toString())),e.beat.tap&&this.$M(s,"Tapped","Enable",null),e.harmonicType!==f.None){switch(e.harmonicType){case f.Natural:this.$M(s,"HarmonicType","HType","Natural");break;case f.Artificial:this.$M(s,"HarmonicType","HType","Artificial");break;case f.Pinch:this.$M(s,"HarmonicType","HType","Pinch");break;case f.Tap:this.$M(s,"HarmonicType","HType","Tap");break;case f.Semi:this.$M(s,"HarmonicType","HType","Semi");break;case f.Feedback:this.$M(s,"HarmonicType","HType","Feedback")}0!==e.harmonicValue&&this.$M(s,"HarmonicFret","HFret",e.harmonicValue.toString())}e.isDead&&this.$M(s,"Muted","Enable",null),e.isPalmMute&&this.$M(s,"PalmMuted","Enable",null),e.hasBend&&this.UM(s,e),e.isHammerPullOrigin&&this.$M(s,"HopoOrigin","Enable",null),e.isHammerPullDestination&&this.$M(s,"HopoDestination","Enable",null),e.isLeftHandTapped&&this.$M(s,"LeftHandTapped","Enable",null);let i=0;switch(e.slideInType){case m.IntoFromAbove:i|=32;break;case m.IntoFromBelow:i|=16}switch(e.slideOutType){case g.Shift:i|=1;break;case g.Legato:i|=2;break;case g.OutDown:i|=4;break;case g.OutUp:i|=8;break;case g.PickSlideDown:i|=64;break;case g.PickSlideUp:i|=128}i>0&&this.$M(s,"Slide","Flags",i.toString())}VM(t,e){e.isPercussion?this.zM(t,"ConcertPitch","C","-1",""):this.XM(t,"TransposedPitch",e.displayValueWithoutBend,e.accidentalMode,e.beat.voice.bar.keySignature)}HM(t,e){e.isPercussion?this.zM(t,"ConcertPitch","C","-1",""):this.XM(t,"ConcertPitch",e.realValueWithoutHarmonic,e.accidentalMode,e.beat.voice.bar.keySignature)}static jM=["C","C","D","D","E","F","F","G","G","A","A","B"];XM(t,e,s,i,n){let r=0,a=0,h="",o="";const c=()=>{switch(r=s%12,a=s/12|0,h=$u.jM[r],zt.computeAccidental(n,p.Default,s,!1)){case T.None:case T.Natural:o="";break;case T.Sharp:o="#";break;case T.Flat:o="b";break;case T.DoubleSharp:o="x";break;case T.DoubleFlat:o="bb"}};switch(c(),i){case p.Default:break;case p.ForceNone:case p.ForceNatural:o="";break;case p.ForceSharp:o="#";break;case p.ForceDoubleSharp:"#"===o&&(s-=2,c()),o="x";break;case p.ForceFlat:"#"===o&&(s+=1,c()),o="b";break;case p.ForceDoubleFlat:"#"===o&&(s+=2,c()),o="bb"}this.zM(t,e,h,a.toString(),o)}zM(t,e,s,i,n){const r=t.addElement("Property");r.attributes.set("name",e);const a=r.addElement("Pitch");a.addElement("Step").innerText=s,a.addElement("Accidental").innerText=n,a.addElement("Octave").innerText=i}UM(t,e){e.hasBend&&e.bendPoints.length<=4&&this.JM(t,e.bendPoints)}JM(t,e){this.$M(t,"Bended","Enable",null);const s=e[0],i=e[e.length-1];let n,r;switch(e.length){case 4:n=e[1],r=e[2];break;case 3:n=e[1],r=e[1];break;default:n=new U((s.offset+i.offset)/2,(s.value+i.value)/2),r=n}this.$M(t,"BendDestinationOffset","Float",this.so(i.offset).toString()),this.$M(t,"BendDestinationValue","Float",this.eo(i.value).toString()),this.$M(t,"BendMiddleOffset1","Float",this.so(n.offset).toString()),this.$M(t,"BendMiddleOffset2","Float",this.so(r.offset).toString()),this.$M(t,"BendMiddleValue","Float",this.eo(n.value).toString()),this.$M(t,"BendOriginOffset","Float",this.so(s.offset).toString()),this.$M(t,"BendOriginValue","Float",this.eo(s.value).toString())}eo(t){return 25*t}so(t){return t/U.MaxPosition*100}OM(t,e,s){const n=t.addElement("Beat");if(n.attributes.set("id",e.id.toString()),n.addElement("Dynamic").innerText=i[e.dynamics],e.fade!==mt.None&&(n.addElement("Fadding").innerText=mt[e.fade]),e.isTremolo)switch(e.tremoloPicking.marks){case 1:n.addElement("Tremolo").innerText="1/2";break;case 2:n.addElement("Tremolo").innerText="1/4";break;case 3:n.addElement("Tremolo").innerText="1/8"}switch(e.hasChord&&n.addElement("Chord").setCData(e.chordId),e.crescendo!==o.None&&(n.addElement("Hairpin").innerText=o[e.crescendo]),e.brushType){case h.ArpeggioUp:n.addElement("Arpeggio").innerText="Up";break;case h.ArpeggioDown:n.addElement("Arpeggio").innerText="Down"}switch(e.text&&n.addElement("FreeText").setCData(e.text),e.graceType){case l.OnBeat:case l.BeforeBeat:n.addElement("GraceNotes").innerText=l[e.graceType]}if(e.ottava!==b.Regular&&(n.addElement("Ottavia").innerText=b[e.ottava].substr(1)),e.hasWhammyBar&&this.qM(n,e),e.isLegatoOrigin||e.isLegatoDestination){const t=n.addElement("Legato");t.attributes.set("origin",e.isLegatoOrigin?"true":"false"),t.attributes.set("destination",e.isLegatoDestination?"true":"false")}if(this.YM(n,e,s),null!==e.preferredBeamDirection)switch(e.preferredBeamDirection){case Wt.Up:n.addElement("TransposedPitchStemOrientation").innerText="Upward",n.addElement("UserTransposedPitchStemOrientation").innerText="Upward";break;case Wt.Down:n.addElement("TransposedPitchStemOrientation").innerText="Downward",n.addElement("UserTransposedPitchStemOrientation").innerText="Downward"}n.addElement("ConcertPitchStemOrientation").innerText="Undefined",e.slashed&&n.addElement("Slashed"),e.deadSlapped&&n.addElement("DeadSlapped"),e.notes.length>0&&(n.addElement("Notes").innerText=e.notes.map(t=>t.id).join(" ")),e.golpe!==bt.None&&(n.addElement("Golpe").innerText=bt[e.golpe]),e.wahPedal!==gt.None&&(n.addElement("Wah").innerText=gt[e.wahPedal]),e.showTimer&&(n.addElement("Timer").innerText=(e.timer??0).toString()),this.KM(n,e),this.QM(n,e),e.lyrics&&e.lyrics.length>0&&this.ZM(n,e.lyrics)}ZM(t,e){const s=t.addElement("Lyrics");for(const t of e){s.addElement("Line").setCData(t)}}QM(t,e){const s=t.addElement("XProperties");switch(e.brushDuration>0&&this.tv(s,"687935489","Int",e.brushDuration.toString()),e.beamingMode){case St.ForceSplitToNext:this.tv(s,"1124204546","Int","2");break;case St.ForceMergeWithNext:this.tv(s,"1124204546","Int","1");break;case St.ForceSplitOnSecondaryToNext:this.tv(s,"1124204552","Int","1")}}KM(t,e){const s=t.addElement("Properties");switch(e.brushType){case h.BrushUp:this.$M(s,"Brush","Direction","Up");break;case h.BrushDown:this.$M(s,"Brush","Direction","Down")}switch(e.pickStroke){case ct.Up:this.$M(s,"PickStroke","Direction","Up");break;case ct.Down:this.$M(s,"PickStroke","Direction","Down")}switch(e.slap&&this.$M(s,"Slapped","Enable",null),e.pop&&this.$M(s,"Popped","Enable",null),e.vibrato){case w.Wide:this.$M(s,"VibratoWTremBar","Strength","Wide");break;case w.Slight:this.$M(s,"VibratoWTremBar","Strength","Slight")}if(e.isBarre)switch(this.$M(s,"BarreFret","Fret",e.barreFret.toString()),e.barreShape){case wt.Full:this.$M(s,"BarreString","String","0");break;case wt.Half:this.$M(s,"BarreString","String","1")}if(e.rasgueado!==yt.None){let t="";switch(e.rasgueado){case yt.Ii:t="ii_1";break;case yt.Mi:t="mi_1";break;case yt.MiiTriplet:t="mii_1";break;case yt.MiiAnapaest:t="mii_2";break;case yt.PmpTriplet:t="pmp_1";break;case yt.PmpAnapaest:t="pmp_2";break;case yt.PeiTriplet:t="pei_1";break;case yt.PeiAnapaest:t="pei_2";break;case yt.PaiTriplet:t="pai_1";break;case yt.PaiAnapaest:t="pai_2";break;case yt.AmiTriplet:t="ami_1";break;case yt.AmiAnapaest:t="ami_2";break;case yt.Ppp:t="ppp_1";break;case yt.Amii:t="amii_1";break;case yt.Amip:t="amip_1";break;case yt.Eami:t="eami_1";break;case yt.Eamii:t="eamii_1";break;case yt.Peami:t="peami_1"}this.$M(s,"Rasgueado","Rasgueado",t)}}YM(t,e,s){const i=`${e.duration}_${e.dots}_${e.tupletNumerator}_${e.tupletDenominator}';`;let n;if(this.MM.has(i))n=this.MM.get(i);else{n=this.MM.size.toString(),this.MM.set(i,n);const t=s.addElement("Rhythm");if(t.attributes.set("id",n),e.hasTuplet){const s=t.addElement("PrimaryTuplet");s.attributes.set("num",e.tupletNumerator.toString()),s.attributes.set("den",e.tupletDenominator.toString())}e.dots>0&&t.addElement("AugmentationDot").attributes.set("count",e.dots.toString());let r="Quarter";switch(e.duration){case c.QuadrupleWhole:r="Long";break;case c.DoubleWhole:r="DoubleWhole";break;case c.Whole:r="Whole";break;case c.Half:r="Half";break;case c.Quarter:r="Quarter";break;case c.Eighth:r="Eighth";break;case c.Sixteenth:r="16th";break;case c.ThirtySecond:r="32nd";break;case c.SixtyFourth:r="64th";break;case c.OneHundredTwentyEighth:r="128th";break;case c.TwoHundredFiftySixth:r="256th"}t.addElement("NoteValue").innerText=r}t.addElement("Rhythm").attributes.set("ref",n)}qM(t,e){e.hasWhammyBar&&e.whammyBarPoints.length<=4&&this.ev(t,e.whammyBarPoints)}ev(t,e){const s=t.addElement("Whammy"),i=e[0],n=e[e.length-1];let r,a;switch(e.length){case 4:r=e[1],a=e[2];break;case 3:r=e[1],a=e[1];break;default:r=new U((i.offset+n.offset)/2,(i.value+n.value)/2),a=r}s.attributes.set("destinationOffset",this.so(n.offset).toString()),s.attributes.set("destinationValue",this.eo(n.value).toString()),s.attributes.set("middleOffset1",this.so(r.offset).toString()),s.attributes.set("middleOffset2",this.so(a.offset).toString()),s.attributes.set("middleValue",this.eo(r.value).toString()),s.attributes.set("originOffset",this.so(i.offset).toString()),s.attributes.set("originValue",this.eo(i.value).toString())}NM(t,e){const s=t.addElement("Score");s.addElement("Title").setCData(e.title),s.addElement("SubTitle").setCData(e.subTitle),s.addElement("Artist").setCData(e.artist),s.addElement("Album").setCData(e.album),s.addElement("Words").setCData(e.words),s.addElement("Music").setCData(e.music),s.addElement("WordsAndMusic").setCData(e.words===e.music?e.words:""),s.addElement("Copyright").setCData(e.copyright),s.addElement("Tabber").setCData(e.tab),s.addElement("Instructions").setCData(e.instructions),s.addElement("Notices").setCData(e.notices),s.addElement("FirstPageHeader").setCData(""),s.addElement("FirstPageFooter").setCData(""),s.addElement("PageHeader").setCData(""),s.addElement("PageFooter").setCData(""),s.addElement("ScoreSystemsDefaultLayout").setCData(e.defaultSystemsLayout.toString()),s.addElement("ScoreSystemsLayout").setCData(e.systemsLayout.join(" ")),s.addElement("ScoreZoomPolicy").innerText="Value",s.addElement("ScoreZoom").innerText="1",s.addElement("MultiVoice").innerText="1>"}PM(t,e){const s=t.addElement("MasterTrack");s.addElement("Tracks").innerText=e.tracks.map(t=>t.index).join(" ");const i=s.addElement("Automations");if(e.masterBars.length>0&&e.masterBars[0].isAnacrusis&&s.addElement("Anacrusis"),0===e.masterBars[0].tempoAutomations.length){const t=i.addElement("Automation");t.addElement("Type").innerText="Tempo",t.addElement("Linear").innerText="false",t.addElement("Bar").innerText="0",t.addElement("Position").innerText="0",t.addElement("Visible").innerText="true",t.addElement("Value").innerText=`${e.tempo} 2`,e.tempoLabel&&(t.addElement("Text").innerText=e.tempoLabel)}const n=e.masterBars[0].syncPoints?e.masterBars[0].syncPoints.find(t=>0===t.ratioPosition&&0===t.syncPointValue.barOccurence):void 0,r=n?n.syncPointValue.millisecondOffset:0;this.IM=r/1e3*$u.Ta*-1|0;const a=new X(()=>Da.buildModifiedTempoLookup(e));for(const t of e.masterBars){for(const e of t.tempoAutomations){const s=i.addElement("Automation");s.addElement("Type").innerText="Tempo",s.addElement("Linear").innerText=e.isLinear?"true":"false",s.addElement("Bar").innerText=t.index.toString(),s.addElement("Position").innerText=e.ratioPosition.toString(),s.addElement("Visible").innerText=e.isVisible?"true":"false",s.addElement("Value").innerText=`${e.value} 2`,e.text&&(s.addElement("Text").innerText=e.text)}if(t.syncPoints)for(const s of t.syncPoints){const n=i.addElement("Automation");n.addElement("Type").innerText="SyncPoint",n.addElement("Linear").innerText="false",n.addElement("Bar").innerText=t.index.toString(),n.addElement("Position").innerText=s.ratioPosition.toString(),n.addElement("Visible").innerText=s.isVisible?"true":"false";const h=n.addElement("Value");h.addElement("BarIndex").innerText=t.index.toString(),h.addElement("BarOccurrence").innerText=s.syncPointValue.barOccurence.toString(),h.addElement("ModifiedTempo").innerText=a.value.get(s).syncBpm.toString(),h.addElement("OriginalTempo").innerText=e.tempo.toString();let o=(s.syncPointValue.millisecondOffset-r)/1e3*$u.Ta;o=Math.floor(o+.5),h.addElement("FrameOffset").innerText=o.toString()}}}EM(t,e){t.addElement("AudioTracks")}FM(t,e){const s=t.addElement("Tracks");for(const t of e.tracks)this.sv(s,t)}sv(t,e){const s=t.addElement("Track");s.attributes.set("id",e.index.toString()),s.addElement("Name").setCData(e.name),s.addElement("ShortName").setCData(e.shortName),s.addElement("Color").innerText=`${e.color.r} ${e.color.g} ${e.color.b}`,s.addElement("SystemsDefautLayout").innerText=e.defaultSystemsLayout.toString(),s.addElement("SystemsLayout").innerText=e.systemsLayout.join(" "),s.addElement("AutoBrush"),s.addElement("PalmMute").innerText="0",s.addElement("PlayingStyle").innerText=ge.isGuitar(e.playbackInfo.program)?"StringedPick":"Default",s.addElement("UseOneChannelPerString"),s.addElement("IconId").innerText=Vu.getIconId(e.playbackInfo).toString(),this.iv(s,e),this.nv(s,e),this.rv(s,e),s.addElement("ForcedSound").innerText="-1",this.av(s,e),e.playbackInfo.isSolo?s.addElement("PlaybackState").innerText="Solo":e.playbackInfo.isMute?s.addElement("PlaybackState").innerText="Mute":s.addElement("PlaybackState").innerText="Default",s.addElement("AudioEngineState").innerText="MIDI",this.hv(s,e),this.ov(s,e),this.cv(s,e)}lv(t,e,s,i,n,r,a,h,o=0){const c=t.addElement("Sound");c.addElement("Name").setCData(s),c.addElement("Label").setCData(s),c.addElement("Path").setCData(i),c.addElement("Role").setCData(n);const l=c.addElement("MIDI"),u=ge.bankToLsbMsb(h);l.addElement("LSB").innerText=u[0].toString(),l.addElement("MSB").innerText=u[1].toString(),l.addElement("Program").innerText=a.toString();const d=e.addElement("Automation");d.addElement("Type").innerText="Sound",d.addElement("Linear").innerText="false",d.addElement("Bar").innerText=r.toString(),d.addElement("Position").innerText=o.toString(),d.addElement("Visible").innerText="true",d.addElement("Value").setCData(`${i};${s};${n}`)}cv(t,e){const s=t.addElement("Sounds"),i=t.addElement("Automations");if(e.staves.length>0&&e.staves[0].bars.length>0){const t=`Track_${e.index}_Initial`,r=`Midi/${e.playbackInfo.program}`,a="Factory";let h=!1,o=e.playbackInfo.bank;for(const c of e.staves)for(const l of c.bars)for(const c of l.voices)for(const u of c.beats){const c=u.getAutomation(n.Instrument),d=0===l.index&&0===u.index,f=u.getAutomation(n.Bank);if(f&&(o=f.value),c){const n=d?t:`ProgramChange_${u.id}`,f=d?r:`Midi/${c.value}`,p=d?a:"User";d||h||(this.lv(s,i,t,r,a,e.staves[0].bars[0].index,e.playbackInfo.program,e.playbackInfo.bank),h=!0),this.lv(s,i,n,f,p,l.index,c.value,o,c.ratioPosition),d&&(h=!0)}}}for(const t of e.staves)for(const e of t.bars)for(const t of e.sustainPedals)if(t.pedalType!==P.Hold){const s=i.addElement("Automation");switch(s.addElement("Type").innerText="SustainPedal",s.addElement("Linear").innerText="false",s.addElement("Bar").innerText=e.index.toString(),s.addElement("Position").innerText=t.ratioPosition.toString(),s.addElement("Visible").innerText="true",t.pedalType){case P.Down:s.addElement("Value").innerText="0 1";break;case P.Up:s.addElement("Value").innerText="0 3"}}}av(t,e){const s=t.addElement("MidiConnection");s.addElement("Port").innerText=e.playbackInfo.port.toString(),s.addElement("PrimaryChannel").innerText=e.playbackInfo.primaryChannel.toString(),s.addElement("SecondaryChannel").innerText=e.playbackInfo.secondaryChannel.toString(),s.addElement("ForeOneChannelPerString").innerText="false"}rv(t,e){const s=t.addElement("RSE").addElement("ChannelStrip");s.attributes.set("version","E56");s.addElement("Parameters").innerText=`0.5 0.5 0.5 0.5 0.5 0.5 0.5 0.5 0.5 1 0.5 ${e.playbackInfo.balance/16} ${e.playbackInfo.volume/16} 0.5 0.5 0.5`}ov(t,e){const s=t.addElement("Staves");for(const t of e.staves)this.uv(s,t)}uv(t,e){const s=t.addElement("Staff").addElement("Properties");if(this.$M(s,"CapoFret","Fret",e.capo.toString()),this.$M(s,"FretCount","Fret","24"),e.tuning.length>0){const t=s.addElement("Property");switch(t.attributes.set("name","Tuning"),t.addElement("Pitches").innerText=e.tuning.slice().reverse().join(" "),t.addElement("Label").setCData(e.tuningName),t.addElement("LabelVisible").innerText=e.tuningName?"true":"false",t.addElement("Flat"),e.tuning.length){case 3:t.addElement("Instrument").innerText="Shamisen";break;case 4:105===e.track.playbackInfo.program?t.addElement("Instrument").innerText="Banjo":42===e.track.playbackInfo.program?t.addElement("Instrument").innerText="Cello":43===e.track.playbackInfo.program?t.addElement("Instrument").innerText="Contrabass":40===e.track.playbackInfo.program?t.addElement("Instrument").innerText="Violin":41===e.track.playbackInfo.program?t.addElement("Instrument").innerText="Viola":t.addElement("Instrument").innerText="Bass";break;case 5:105===e.track.playbackInfo.program?t.addElement("Instrument").innerText="Banjo":t.addElement("Instrument").innerText="Bass";break;case 6:105===e.track.playbackInfo.program?t.addElement("Instrument").innerText="Banjo":e.track.playbackInfo.program<=39?t.addElement("Instrument").innerText="Bass":t.addElement("Instrument").innerText="Guitar";break;case 7:e.track.playbackInfo.program<=39?t.addElement("Instrument").innerText="Bass":t.addElement("Instrument").innerText="Guitar";break;default:t.addElement("Instrument").innerText="Guitar"}}this.$M(s,"PartialCapoFret","Fret","0"),this.$M(s,"PartialCapoStringFlags","Bitset",e.tuning.map(t=>"0").join("")),this.$M(s,"TuningFlat","Enable",null),this.dv(s,e,"DiagramCollection"),this.dv(s,e,"DiagramWorkingSet")}dv(t,e,s){const i=t.addElement("Property");i.attributes.set("name",s);const n=i.addElement("Items"),r=e.chords;if(r)for(const[t,e]of r){const s=n.addElement("Item");s.attributes.set("id",t),s.attributes.set("name",e.name);const i=s.addElement("Diagram");i.attributes.set("stringCount",e.strings.length.toString()),i.attributes.set("fretCount","5"),i.attributes.set("baseFret",(e.firstFret-1).toString()),i.attributes.set("barStates",e.strings.map(t=>"1").join(" "));const r=[],a=new Map;for(let t=0;t<e.strings.length;t++){const s=e.strings[t];if(-1!==s){const n=i.addElement("Fret"),h=e.strings.length-1-t;n.attributes.set("string",h.toString()),n.attributes.set("fret",(s-e.firstFret+1).toString()),a.has(s)||(a.set(s,[]),r.push(s)),a.get(s).push(h)}}r.sort();const h=i.addElement("Fingering");if(e.barreFrets.length>0){const t=[d.LittleFinger,d.AnnularFinger,d.MiddleFinger,d.IndexFinger];for(const s of r){const i=a.get(s);if(i.length>1&&e.barreFrets.indexOf(s)>=0){const n=t.length>0?t.pop():d.IndexFinger;for(const t of i){const i=h.addElement("Position");switch(n){case d.LittleFinger:i.attributes.set("finger","Pinky");break;case d.AnnularFinger:i.attributes.set("finger","Ring");break;case d.MiddleFinger:i.attributes.set("finger","Middle");break;case d.IndexFinger:i.attributes.set("finger","Index")}i.attributes.set("fret",(s-e.firstFret+1).toString()),i.attributes.set("string",t.toString())}}}}const o=i.addElement("Property");o.attributes.set("name","ShowName"),o.attributes.set("type","bool"),o.attributes.set("value",e.showName?"true":"false");const c=i.addElement("Property");c.attributes.set("name","ShowDiagram"),c.attributes.set("type","bool"),c.attributes.set("value",e.showDiagram?"true":"false");const l=i.addElement("Property");l.attributes.set("name","ShowFingering"),l.attributes.set("type","bool"),l.attributes.set("value",e.showFingering?"true":"false");const u=i.addElement("Chord"),f=u.addElement("KeyNote");f.attributes.set("step","C"),f.attributes.set("accidental","Natural");const p=u.addElement("BassNote");p.attributes.set("step","C"),p.attributes.set("accidental","Natural");const b=u.addElement("Degree");b.attributes.set("interval","Third"),b.attributes.set("alteration","Major"),b.attributes.set("omitted","false");const m=u.addElement("Degree");m.attributes.set("interval","Fifth"),m.attributes.set("alteration","Perfect"),m.attributes.set("omitted","false")}}$M(t,e,s,i){const n=t.addElement("Property");n.attributes.set("name",e);const r=n.addElement(s);return null!==i&&(r.innerText=i),n}tv(t,e,s,i){const n=t.addElement("XProperty");n.attributes.set("id",e);const r=n.addElement(s);return null!==i&&(r.innerText=i),n}hv(t,e){const s=t.addElement("Lyrics");s.attributes.set("dispatched","true");const i=[];for(const t of e.staves[0].bars)for(const e of t.voices)if(!e.isEmpty)for(const s of e.beats)if(s.lyrics)for(let e=0;e<s.lyrics.length;e++){for(;e>=i.length;){const e=new Be;e.startBar=t.index,e.text="[Empty]",i.push(e)}const n=i[e];n.text="[Empty]"===n.text?s.lyrics[e]:`${n.text} ${s.lyrics[e].split(" ").join("+")}`}for(let t=0;t<i.length;t++){const e=s.addElement("Line");e.addElement("Text").setCData(i[t].text),e.addElement("Offset").innerText=i[t].startBar.toString()}}nv(t,e){const s=t.addElement("Transpose"),i=Math.floor(e.staves[0].displayTranspositionPitch/12),n=e.staves[0].displayTranspositionPitch-12*i;s.addElement("Chromatic").innerText=n.toString(),s.addElement("Octave").innerText=i.toString()}iv(t,e){const s=Vu.buildInstrumentSet(e),i=t.addElement("InstrumentSet");i.addElement("Name").innerText=s.name,i.addElement("Type").innerText=s.type,i.addElement("LineCount").innerText=s.lineCount.toString();const n=i.addElement("Elements");for(const t of s.elements){const e=n.addElement("Element");e.addElement("Name").innerText=t.name,e.addElement("Type").innerText=t.type,e.addElement("SoundbankName").innerText=t.soundbankName;const s=e.addElement("Articulations");for(const e of t.articulations){const t=s.addElement("Articulation");switch(t.addElement("Name").innerText=e.name,t.addElement("StaffLine").innerText=e.staffLine.toString(),t.addElement("Noteheads").innerText=[this.fv(e.noteHeads[0]),this.fv(e.noteHeads[1]),this.fv(e.noteHeads[2])].join(" "),e.techniqueSymbolPlacement){case ut.Below:t.addElement("TechniquePlacement").innerText="below";break;case ut.Outside:t.addElement("TechniquePlacement").innerText="outside";break;case ut.Inside:t.addElement("TechniquePlacement").innerText="inside";break;case ut.Above:t.addElement("TechniquePlacement").innerText="above"}t.addElement("TechniqueSymbol").innerText=this.fv(e.techniqueSymbol),t.addElement("InputMidiNumbers").innerText=e.inputMidiNumbers.map(t=>t.toString()).join(" "),t.addElement("OutputRSESound").innerText=e.outputRSESound,t.addElement("OutputMidiNumber").innerText=e.outputMidiNumber.toString()}}}fv(t){if(t===lt.None)return"";const e=lt[t];return e.substring(0,1).toLowerCase()+e.substring(1)}AM(t,e){const s=t.addElement("MasterBars");for(const t of e.masterBars)this.pv(s,t)}pv(t,e){const s=t.addElement("MasterBar"),i=s.addElement("Key");let n=e.score.tracks[0].staves[0].bars[e.index].keySignature;const r=e.score.tracks[0].staves[0].bars[e.index].keySignatureType,a=zt.flooredDivision(e.score.tracks[0].staves[0].displayTranspositionPitch,12);n=zt.transposeKey(n,-a),i.addElement("AccidentalCount").innerText=n.toString(),i.addElement("Mode").innerText=N[r],i.addElement("Sharps").innerText="Sharps",s.addElement("Time").innerText=`${e.timeSignatureNumerator}/${e.timeSignatureDenominator}`,e.actualBeamingRules&&this.bv(s,e),e.isFreeTime&&s.addElement("FreeTime");const h=[];for(const t of e.score.tracks)for(const s of t.staves)h.push(s.bars[e.index].id.toString());if(s.addElement("Bars").innerText=h.join(" "),e.isDoubleBar&&s.addElement("DoubleBar"),e.isSectionStart){const t=s.addElement("Section");t.addElement("Letter").setCData(e.section.marker),t.addElement("Text").setCData(e.section.text)}if(e.isRepeatStart||e.isRepeatEnd){const t=s.addElement("Repeat");t.attributes.set("start",e.isRepeatStart?"true":"false"),t.attributes.set("end",e.isRepeatEnd?"true":"false"),e.isRepeatEnd&&t.attributes.set("count",e.repeatCount.toString())}if(e.alternateEndings>0){let t=e.alternateEndings;const i=[];let n=0;for(;t>0;)1==(t>>n&1)&&(i.push(n+1),t&=~(1<<n)),n++;s.addElement("AlternateEndings").innerText=i.join(" ")}if(e.tripletFeel!==F.NoTripletFeel&&(s.addElement("TripletFeel").innerText=F[e.tripletFeel]),e.directions&&e.directions.size>0){const t=s.addElement("Directions");for(const s of e.directions)switch(s){case ze.TargetFine:t.addElement("Target").innerText="Fine";break;case ze.TargetSegno:t.addElement("Target").innerText="Segno";break;case ze.TargetSegnoSegno:t.addElement("Target").innerText="SegnoSegno";break;case ze.TargetCoda:t.addElement("Target").innerText="Coda";break;case ze.TargetDoubleCoda:t.addElement("Target").innerText="DoubleCoda";break;case ze.JumpDaCapo:t.addElement("Jump").innerText="DaCapo";break;case ze.JumpDaCapoAlCoda:t.addElement("Jump").innerText="DaCapoAlCoda";break;case ze.JumpDaCapoAlDoubleCoda:t.addElement("Jump").innerText="DaCapoAlDoubleCoda";break;case ze.JumpDaCapoAlFine:t.addElement("Jump").innerText="DaCapoAlFine";break;case ze.JumpDalSegno:t.addElement("Jump").innerText="DaSegno";break;case ze.JumpDalSegnoAlCoda:t.addElement("Jump").innerText="DaSegnoAlCoda";break;case ze.JumpDalSegnoAlDoubleCoda:t.addElement("Jump").innerText="DaSegnoAlDoubleCoda";break;case ze.JumpDalSegnoAlFine:t.addElement("Jump").innerText="DaSegnoAlFine";break;case ze.JumpDalSegnoSegno:t.addElement("Jump").innerText="DaSegnoSegno";break;case ze.JumpDalSegnoSegnoAlCoda:t.addElement("Jump").innerText="DaSegnoSegnoAlCoda";break;case ze.JumpDalSegnoSegnoAlDoubleCoda:t.addElement("Jump").innerText="DaSegnoSegnoAlDoubleCoda";break;case ze.JumpDalSegnoSegnoAlFine:t.addElement("Jump").innerText="DaSegnoSegnoAlFine";break;case ze.JumpDaCoda:t.addElement("Jump").innerText="DaCoda";break;case ze.JumpDaDoubleCoda:t.addElement("Jump").innerText="DaDoubleCoda"}}this.mv(s,e)}bv(t,e){const s=t.addElement("XProperties"),i=e.actualBeamingRules;if(i){const t=i.findRule(c.Eighth);let e=t[0],n=1;t[0]===c.Quarter&&(e=8,n=2),this.tv(s,"1124139010","Int",e.toString());const r=1124139264;let a=0;for(;a<t[1].length;)this.tv(s,(r+a).toString(),"Int",(t[1][a]*n).toString()),a++}}mv(t,e){const s=e.fermata?.size??0;if(0!==s&&s>0){const s=t.addElement("Fermatas");for(const[t,i]of e.fermata)this.gv(s,t,i)}}gv(t,e,s){let i=-1,n=1;if(e>0)for(;n<10&&(i=e/H.QuarterTime*n,i!==Math.floor(i));)i=-1,n++;else i=0,n=1;if(-1===i)return;const r=t.addElement("Fermata");r.addElement("Type").innerText=At[s.type],r.addElement("Length").innerText=s.length.toString(),r.addElement("Offset").innerText=`${i}/${n}`}LM(t,e){const s=t.addElement("Bar");s.attributes.set("id",e.id.toString()),s.addElement("Voices").innerText=e.voices.map(t=>t.isEmpty?"-1":t.id.toString()).join(" "),s.addElement("Clef").innerText=x[e.clef],e.clefOttava!==b.Regular&&(s.addElement("Ottavia").innerText=b[e.clefOttava].substr(1)),e.simileMark!==M.None&&(s.addElement("SimileMark").innerText=M[e.simileMark])}WM(t,e){if(e.isEmpty)return;const s=t.addElement("Voice");s.attributes.set("id",e.id.toString()),s.addElement("Beats").innerText=e.beats.map(t=>t.id).join(" ")}}class Uu{static wv=Uu.yv();static yv(){const t=new Uint32Array(256);for(let e=0;e<t.length;e++){let s=e;for(let t=0;t<8;t++)s=1&~s?s>>>1:s>>>1^3988292384;t[e]=s}return t}static kv=4294967295;Sv=Uu.kv;get value(){return~this.Sv}constructor(){this.reset()}update(t,e,s){for(let i=0;i<s;i++)this.Sv=Uu.wv[255&(this.Sv^t[e+i])]^this.Sv>>>8}reset(){this.Sv=Uu.kv}}class zu{static maxWbits=15;static wsize=1<<zu.maxWbits;static wmask=zu.wsize-1;static minMatch=3;static maxMatch=258;static defaultMemLevel=8;static pendingBufSize=1<<zu.defaultMemLevel+8;static hashBits=zu.defaultMemLevel+7;static hashSize=1<<zu.hashBits;static hashShift=(zu.hashBits+zu.minMatch-1)/zu.minMatch;static hashMask=zu.hashSize-1;static minLookahead=zu.maxMatch+zu.minMatch+1;static maxDist=zu.wsize-zu.minLookahead}class Xu{static Bv=16;static _v=17;static Tv=18;freqs;length=null;minNumCodes;numCodes=0;xv=null;Mv;vv;Qi;constructor(t,e,s,i){this.Qi=t,this.minNumCodes=s,this.vv=i,this.freqs=new Int16Array(e),this.Mv=new Int32Array(i)}reset(){for(let t=0;t<this.freqs.length;t++)this.freqs[t]=0;this.xv=null,this.length=null}buildTree(){const t=this.freqs.length,e=new Int32Array(t);let s=0,i=0;for(let n=0;n<t;n++){const t=this.freqs[n];if(0!==t){let r=s++;for(;r>0;){const s=Math.floor((r-1)/2);if(!(this.freqs[e[s]]>t))break;e[r]=e[s],r=s}e[r]=n,i=n}}for(;s<2;){const t=i<2?++i:0;e[s++]=t}this.numCodes=Math.max(i+1,this.minNumCodes);const n=s,r=new Int32Array(4*s-2),a=new Int32Array(2*s-1);let h=n;for(let t=0;t<s;t++){const s=e[t];r[2*t]=s,r[2*t+1]=-1,a[t]=this.freqs[s]<<8,e[t]=t}do{const t=e[0];let i=e[--s],n=0,o=1;for(;o<s;)o+1<s&&a[e[o]]>a[e[o+1]]&&o++,e[n]=e[o],n=o,o=2*o+1;let c=a[i];for(;o=n,n>0&&(n=Math.floor((o-1)/2),a[e[n]]>c);)e[o]=e[n];e[o]=i;const l=e[0];i=h++,r[2*i]=t,r[2*i+1]=l;const u=Math.min(255&a[t],255&a[l]);for(c=a[t]+a[l]-u+1,a[i]=c,n=0,o=1;o<s;)o+1<s&&a[e[o]]>a[e[o+1]]&&o++,e[n]=e[o],n=o,o=2*n+1;for(;o=n,o>0&&(n=Math.floor((o-1)/2),a[e[n]]>c);)e[o]=e[n];e[o]=i}while(s>1);this.Nv(r)}Nv(t){this.length=new Uint8Array(this.freqs.length);const e=Math.floor(t.length/2),s=Math.floor((e+1)/2);let i=0;for(let t=0;t<this.vv;t++)this.Mv[t]=0;const n=new Int32Array(e);n[e-1]=0;for(let s=e-1;s>=0;s--)if(-1!==t[2*s+1]){let e=n[s]+1;e>this.vv&&(e=this.vv,i++),n[t[2*s]]=e,n[t[2*s+1]]=e}else{const e=n[s];this.Mv[e-1]++,this.length[t[2*s]]=n[s]}if(0===i)return;let r=this.vv-1;do{for(;0===this.Mv[--r];);do{this.Mv[r]--,this.Mv[++r]++,i-=1<<this.vv-1-r}while(i>0&&r<this.vv-1)}while(i>0);this.Mv[this.vv-1]+=i,this.Mv[this.vv-2]-=i;let a=2*s;for(let e=this.vv;0!==e;e--){let s=this.Mv[e-1];for(;s>0;){const i=2*t[a++];-1===t[i+1]&&(this.length[t[i]]=e,s--)}}}getEncodedLength(){let t=0;for(let e=0;e<this.freqs.length;e++)t+=this.freqs[e]*this.length[e];return t}calcBLFreq(t){let e,s,i,n=-1,r=0;for(;r<this.numCodes;){i=1;const a=this.length[r];for(0===a?(e=138,s=3):(e=6,s=3,n!==a&&(t.freqs[a]++,i=0)),n=a,r++;r<this.numCodes&&n===this.length[r]&&(r++,!(++i>=e)););i<s?t.freqs[n]+=i:0!==n?t.freqs[Xu.Bv]++:i<=10?t.freqs[Xu._v]++:t.freqs[Xu.Tv]++}}setStaticCodes(t,e){this.xv=t,this.length=e}buildCodes(){const t=new Int32Array(this.vv);let e=0;this.xv=new Int16Array(this.freqs.length);for(let s=0;s<this.vv;s++)t[s]=e,e+=this.Mv[s]<<15-s;for(let e=0;e<this.numCodes;e++){const s=this.length[e];s>0&&(this.xv[e]=ju.bitReverse(t[s-1]),t[s-1]+=1<<16-s)}}writeTree(t){let e,s,i,n=-1,r=0;for(;r<this.numCodes;){i=1;const a=this.length[r];for(0===a?(e=138,s=3):(e=6,s=3,n!==a&&(t.writeSymbol(a),i=0)),n=a,r++;r<this.numCodes&&n===this.length[r]&&(r++,!(++i>=e)););if(i<s)for(;i-- >0;)t.writeSymbol(n);else 0!==n?(t.writeSymbol(Xu.Bv),this.Qi.pending.writeBits(i-3,2)):i<=10?(t.writeSymbol(Xu._v),this.Qi.pending.writeBits(i-3,3)):(t.writeSymbol(Xu.Tv),this.Qi.pending.writeBits(i-11,7))}}writeSymbol(t){this.Qi.pending.writeBits(65535&this.xv[t],this.length[t])}}class ju{static Pv=1<<zu.defaultMemLevel+6;static Cv=286;static storedBlock=0;static staticTrees=1;static dynTrees=2;static Ev=30;static Fv=new Int16Array(ju.Cv);static Av=new Uint8Array(ju.Cv);static Dv=new Int16Array(ju.Ev);static Lv=new Uint8Array(ju.Ev);static staticInit(){let t=0;for(;t<144;)ju.Fv[t]=ju.bitReverse(48+t<<8),ju.Av[t++]=8;for(;t<256;)ju.Fv[t]=ju.bitReverse(256+t<<7),ju.Av[t++]=9;for(;t<280;)ju.Fv[t]=ju.bitReverse(-256+t<<9),ju.Av[t++]=7;for(;t<ju.Cv;)ju.Fv[t]=ju.bitReverse(-88+t<<8),ju.Av[t++]=8;for(t=0;t<ju.Ev;t++)ju.Dv[t]=ju.bitReverse(t<<11),ju.Lv[t]=5}static Wv=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];static Ov=new Uint8Array([0,8,4,12,2,10,6,14,1,9,5,13,3,11,7,15]);static bitReverse(t){return ju.Ov[15&t]<<12|ju.Ov[t>>4&15]<<8|ju.Ov[t>>8&15]<<4|ju.Ov[t>>12]}static Rv=19;static Iv=256;pending;Gv;Hv;Vv;$v;Uv;zv=0;Xv=0;constructor(t){this.pending=t,this.Gv=new Xu(this,ju.Cv,257,15),this.Hv=new Xu(this,ju.Ev,1,15),this.Vv=new Xu(this,ju.Rv,4,7),this.$v=new Int16Array(ju.Pv),this.Uv=new Uint8Array(ju.Pv)}isFull(){return this.zv>=ju.Pv}reset(){this.zv=0,this.Xv=0,this.Gv.reset(),this.Hv.reset(),this.Vv.reset()}flushStoredBlock(t,e,s,i){this.pending.writeBits((ju.storedBlock<<1)+(i?1:0),3),this.pending.alignToByte(),this.pending.writeShort(s),this.pending.writeShort(~s),this.pending.writeBlock(t,e,s),this.reset()}flushBlock(t,e,s,i){this.Gv.freqs[ju.Iv]++,this.Gv.buildTree(),this.Hv.buildTree(),this.Gv.calcBLFreq(this.Vv),this.Hv.calcBLFreq(this.Vv),this.Vv.buildTree();let n=4;for(let t=18;t>n;t--)this.Vv.length[ju.Wv[t]]>0&&(n=t+1);let r=14+3*n+this.Vv.getEncodedLength()+this.Gv.getEncodedLength()+this.Hv.getEncodedLength()+this.Xv,a=this.Xv;for(let t=0;t<ju.Cv;t++)a+=this.Gv.freqs[t]*ju.Av[t];for(let t=0;t<ju.Ev;t++)a+=this.Hv.freqs[t]*ju.Lv[t];r>=a&&(r=a),e>=0&&s+4<r>>3?this.flushStoredBlock(t,e,s,i):r===a?(this.pending.writeBits((ju.staticTrees<<1)+(i?1:0),3),this.Gv.setStaticCodes(ju.Fv,ju.Av),this.Hv.setStaticCodes(ju.Dv,ju.Lv),this.compressBlock(),this.reset()):(this.pending.writeBits((ju.dynTrees<<1)+(i?1:0),3),this.sendAllTrees(n),this.compressBlock(),this.reset())}sendAllTrees(t){this.Vv.buildCodes(),this.Gv.buildCodes(),this.Hv.buildCodes(),this.pending.writeBits(this.Gv.numCodes-257,5),this.pending.writeBits(this.Hv.numCodes-1,5),this.pending.writeBits(t-4,4);for(let e=0;e<t;e++)this.pending.writeBits(this.Vv.length[ju.Wv[e]],3);this.Gv.writeTree(this.Vv),this.Hv.writeTree(this.Vv)}compressBlock(){for(let t=0;t<this.zv;t++){const e=255&this.Uv[t];let s=this.$v[t];if(0!==s--){const t=ju.jv(e);this.Gv.writeSymbol(t);let i=Math.floor((t-261)/4);i>0&&i<=5&&this.pending.writeBits(e&(1<<i)-1,i);const n=ju.Jv(s);this.Hv.writeSymbol(n),i=Math.floor(n/2)-1,i>0&&this.pending.writeBits(s&(1<<i)-1,i)}else this.Gv.writeSymbol(e)}this.Gv.writeSymbol(ju.Iv)}tallyDist(t,e){this.$v[this.zv]=t,this.Uv[this.zv++]=e-3;const s=ju.jv(e-3);this.Gv.freqs[s]++,s>=265&&s<285&&(this.Xv+=Math.floor((s-261)/4));const i=ju.Jv(t-1);return this.Hv.freqs[i]++,i>=4&&(this.Xv+=Math.floor(i/2)-1),this.isFull()}tallyLit(t){return this.$v[this.zv]=0,this.Uv[this.zv++]=t,this.Gv.freqs[t]++,this.isFull()}static jv(t){if(255===t)return 285;let e=257;for(;t>=8;)e+=4,t>>=1;return e+t}static Jv(t){let e=0;for(;t>=4;)e+=2,t>>=1;return e+t}}ju.staticInit();class Ju{static qv=4096;Yv;Kv=128;Qv=128;Zv=8;tN=0;eN;cn;_f;sN;iN=0;nN=null;rN=0;aN=0;hN=!1;oN=0;cN=0;lN;Qi;inputCrc;constructor(t){this.lN=t,this.Qi=new ju(t),this.inputCrc=new Uu,this.cn=new Uint8Array(2*zu.wsize),this._f=new Int16Array(zu.hashSize),this.sN=new Int16Array(zu.wsize),this.Yv=1,this.eN=1}reset(){this.Qi.reset(),this.inputCrc.reset(),this.Yv=1,this.eN=1,this.iN=0,this.hN=!1,this.cN=zu.minMatch-1;for(let t=0;t<zu.hashSize;t++)this._f[t]=0;for(let t=0;t<zu.wsize;t++)this.sN[t]=0}uN(){this.tN=this.cn[this.eN]<<zu.hashShift^this.cn[this.eN+1]}needsInput(){return this.aN===this.rN}setInput(t,e,s){const i=e+s;this.nN=t,this.rN=e,this.aN=i}deflate(t,e){let s;do{this.fillWindow();const i=t&&this.rN===this.aN;s=this.dN(i,e)}while(this.lN.isFlushed&&s);return s}dN(t,e){if(this.iN<zu.minLookahead&&!t)return!1;for(;this.iN>=zu.minLookahead||t;){if(0===this.iN)return this.hN&&this.Qi.tallyLit(255&this.cn[this.eN-1]),this.hN=!1,this.Qi.flushBlock(this.cn,this.Yv,this.eN-this.Yv,e),this.Yv=this.eN,!1;this.eN>=2*zu.wsize-zu.minLookahead&&this.fN();const t=this.oN;let s=this.cN;if(this.iN>=zu.minMatch){const t=this.pN();0!==t&&this.eN-t<=zu.maxDist&&this.bN(t)&&this.cN===zu.minMatch&&this.eN-this.oN>Ju.qv&&(this.cN=zu.minMatch-1)}if(s>=zu.minMatch&&this.cN<=s){this.Qi.tallyDist(this.eN-1-t,s),s-=2;do{this.eN++,this.iN--,this.iN>=zu.minMatch&&this.pN()}while(--s>0);this.eN++,this.iN--,this.hN=!1,this.cN=zu.minMatch-1}else this.hN&&this.Qi.tallyLit(255&this.cn[this.eN-1]),this.hN=!0,this.eN++,this.iN--;if(this.Qi.isFull()){let t=this.eN-this.Yv;this.hN&&t--;const s=e&&0===this.iN&&!this.hN;return this.Qi.flushBlock(this.cn,this.Yv,t,s),this.Yv+=t,!s}}return!0}bN(t){let e,s=this.eN;const i=s+Math.min(zu.maxMatch,this.iN)-1,n=Math.max(s-zu.maxDist,0),r=this.cn,a=this.sN;let h=this.Kv;const o=Math.min(this.Qv,this.iN);if(this.cN=Math.max(this.cN,zu.minMatch-1),s+this.cN>i)return!1;let c=r[s+this.cN-1],l=r[s+this.cN];this.cN>=this.Zv&&(h>>=2);do{if(e=t,s=this.eN,r[e+this.cN]===l&&r[e+this.cN-1]===c&&r[e]===r[s]&&r[++e]===r[++s]){switch((i-s)%8){case 1:if(r[++s]===r[++e])break;break;case 2:if(r[++s]===r[++e]&&r[++s]===r[++e])break;break;case 3:if(r[++s]===r[++e]&&r[++s]===r[++e]&&r[++s]===r[++e])break;break;case 4:if(r[++s]===r[++e]&&r[++s]===r[++e]&&r[++s]===r[++e]&&r[++s]===r[++e])break;break;case 5:if(r[++s]===r[++e]&&r[++s]===r[++e]&&r[++s]===r[++e]&&r[++s]===r[++e]&&r[++s]===r[++e])break;break;case 6:if(r[++s]===r[++e]&&r[++s]===r[++e]&&r[++s]===r[++e]&&r[++s]===r[++e]&&r[++s]===r[++e]&&r[++s]===r[++e])break;break;case 7:if(r[++s]===r[++e]&&r[++s]===r[++e]&&r[++s]===r[++e]&&r[++s]===r[++e]&&r[++s]===r[++e]&&r[++s]===r[++e]&&r[++s]===r[++e])break}if(r[s]===r[e])do{if(s===i){++s,++e;break}}while(r[++s]===r[++e]&&r[++s]===r[++e]&&r[++s]===r[++e]&&r[++s]===r[++e]&&r[++s]===r[++e]&&r[++s]===r[++e]&&r[++s]===r[++e]&&r[++s]===r[++e]);if(s-this.eN>this.cN){if(this.oN=t,this.cN=s-this.eN,this.cN>=o)break;c=r[s-1],l=r[s]}t=65535&a[t&zu.wmask]}}while(t>n&&0!==--h);return this.cN>=zu.minMatch}pN(){const t=(this.tN<<zu.hashShift^this.cn[this.eN+(zu.minMatch-1)])&zu.hashMask,e=this._f[t];return this.sN[this.eN&zu.wmask]=e,this._f[t]=this.eN,this.tN=t,65535&e}fillWindow(){if(this.eN>=zu.wsize+zu.maxDist&&this.fN(),this.iN<zu.minLookahead&&this.rN<this.aN){let t=2*zu.wsize-this.iN-this.eN;t>this.aN-this.rN&&(t=this.aN-this.rN),this.cn.set(this.nN.subarray(this.rN,this.rN+t),this.eN+this.iN),this.inputCrc.update(this.nN,this.rN,t),this.rN+=t,this.iN+=t}this.iN>=zu.minMatch&&this.uN()}fN(){this.cn.set(this.cn.subarray(zu.wsize,zu.wsize+zu.wsize),0),this.oN-=zu.wsize,this.eN-=zu.wsize,this.Yv-=zu.wsize;for(let t=0;t<zu.hashSize;++t){const e=65535&this._f[t];this._f[t]=e>=zu.wsize?e-zu.wsize:0}for(let t=0;t<zu.wsize;t++){const e=65535&this.sN[t];this.sN[t]=e>=zu.wsize?e-zu.wsize:0}}}class qu{mi;mN=0;ad=0;Yi=0;bitCount=0;get isFlushed(){return 0===this.ad}constructor(t){this.mi=new Uint8Array(t)}reset(){this.mN=0,this.ad=0,this.bitCount=0}writeShortMSB(t){this.mi[this.ad++]=t>>8&255,this.mi[this.ad++]=255&t}writeShort(t){this.mi[this.ad++]=t,this.mi[this.ad++]=t>>8}writeBlock(t,e,s){this.mi.set(t.subarray(e,e+s),this.ad),this.ad+=s}flush(t,e,s){return this.bitCount>=8&&(this.mi[this.ad++]=255&this.Yi,this.Yi>>=8,this.bitCount-=8),s>this.ad-this.mN?(s=this.ad-this.mN,t.set(this.mi.subarray(this.mN,this.mN+s),e),this.mN=0,this.ad=0):(t.set(this.mi.subarray(this.mN,this.mN+s),e),this.mN+=s),s}writeBits(t,e){this.Yi|=t<<this.bitCount,this.bitCount+=e,this.bitCount>=16&&(this.mi[this.ad++]=255&this.Yi,this.mi[this.ad++]=this.Yi>>8&255,this.Yi>>=16,this.bitCount-=16)}alignToByte(){this.bitCount>0&&(this.mi[this.ad++]=255&this.Yi,this.bitCount>8&&(this.mi[this.ad++]=this.Yi>>8&255)),this.Yi=0,this.bitCount=0}}class Yu{static gN=4;static isFinishing=8;static wN=16;static yN=20;static kN=28;static SN=30;Bi=0;lN;BN;get inputCrc(){return this.BN.inputCrc.value}constructor(){this.lN=new qu(zu.pendingBufSize),this.BN=new Ju(this.lN),this.reset()}get isNeedingInput(){return this.BN.needsInput()}get isFinished(){return this.Bi===Yu.SN&&this.lN.isFlushed}reset(){this.Bi=Yu.wN,this.lN.reset(),this.BN.reset()}setInput(t,e,s){this.BN.setInput(t,e,s)}deflate(t,e,s){const i=s;for(;;){const n=this.lN.flush(t,e,s);if(e+=n,0===(s-=n)||this.Bi===Yu.SN)break;if(!this.BN.deflate(0!==(this.Bi&Yu.gN),0!==(this.Bi&Yu.isFinishing)))switch(this.Bi){case Yu.wN:return i-s;case Yu.yN:let t=8+(7&-this.lN.bitCount);for(;t>0;)this.lN.writeBits(2,10),t-=10;this.Bi=Yu.wN;break;case Yu.kN:this.lN.alignToByte(),this.Bi=Yu.SN}}return i-s}finish(){this.Bi|=Yu.gN|Yu.isFinishing}}class Ku{entry;localHeaderOffset;compressedSize;crc32;compressionMode;constructor(t,e,s,i,n){this.entry=t,this.crc32=e,this.localHeaderOffset=s,this.compressionMode=i,this.compressedSize=n}}class Qu{fu;_N=[];TN=new Yu;constructor(t){this.fu=t}writeEntry(t){const e=ys.CompressionMethodDeflate,s=Fe.empty(),i=this.xN(s,t.data,e),n=s.toArray(),r=new Ku(t,i,this.fu.bytesWritten,e,s.length);this._N.push(r),de.writeInt32LE(this.fu,ys.LocalFileHeaderSignature),de.writeUInt16LE(this.fu,10),de.writeUInt16LE(this.fu,2048),de.writeUInt16LE(this.fu,e),de.writeInt16LE(this.fu,0),de.writeInt16LE(this.fu,0),de.writeInt32LE(this.fu,i),de.writeInt32LE(this.fu,n.length),de.writeInt32LE(this.fu,t.data.length),de.writeInt16LE(this.fu,t.fullName.length),de.writeInt16LE(this.fu,0);const a=de.stringToBytes(t.fullName);this.fu.write(a,0,a.length),this.fu.write(n,0,n.length)}xN(t,e,s){if(s!==ys.CompressionMethodDeflate){const s=new Uu;return s.update(e,0,e.length),t.write(e,0,e.length),s.value}const i=new Uint8Array(512);for(this.TN.reset(),this.TN.setInput(e,0,e.length);!this.TN.isNeedingInput;){const e=this.TN.deflate(i,0,i.length);if(e<=0)break;t.write(i,0,e)}for(this.TN.finish();!this.TN.isFinished;){const e=this.TN.deflate(i,0,i.length);if(e<=0)break;t.write(i,0,e)}return this.TN.inputCrc}end(){const t=this.fu.bytesWritten;for(const t of this._N)this.MN(t);const e=this.fu.bytesWritten;this.vN(t,e)}vN(t,e){de.writeInt32LE(this.fu,ys.EndOfCentralDirSignature),de.writeInt16LE(this.fu,0),de.writeInt16LE(this.fu,0),de.writeInt16LE(this.fu,this._N.length),de.writeInt16LE(this.fu,this._N.length),de.writeInt32LE(this.fu,e-t),de.writeInt32LE(this.fu,t),de.writeInt16LE(this.fu,0)}MN(t){de.writeInt32LE(this.fu,ys.CentralFileHeaderSignature),de.writeUInt16LE(this.fu,10),de.writeUInt16LE(this.fu,10),de.writeUInt16LE(this.fu,2048),de.writeUInt16LE(this.fu,t.compressionMode),de.writeInt16LE(this.fu,0),de.writeInt16LE(this.fu,0),de.writeInt32LE(this.fu,t.crc32),de.writeInt32LE(this.fu,t.compressedSize),de.writeInt32LE(this.fu,t.entry.data.length),de.writeInt16LE(this.fu,t.entry.fullName.length),de.writeInt16LE(this.fu,0),de.writeInt16LE(this.fu,0),de.writeInt16LE(this.fu,0),de.writeInt16LE(this.fu,0),de.writeInt32LE(this.fu,0),de.writeInt32LE(this.fu,t.localHeaderOffset);const e=de.stringToBytes(t.entry.fullName);this.fu.write(e,0,e.length)}}const Zu=Object.freeze(Object.defineProperty({__proto__:null,AlphaTexExporter:class extends Du{Si=Pe.instance;get name(){return"alphaTex"}exportToString(t,e=null){return this.settings=e??new ra,this.scoreToAlphaTexString(t)}writeScore(t){const e=de.stringToBytes(this.scoreToAlphaTexString(t));this.data.write(e,0,e.length)}scoreToAlphaTexString(t){const e=new Wu(this.settings);return e.writeScoreNode(this.De(t)),e.tex}De(t){const e={nodeType:_t.Score,bars:[]};for(const s of t.tracks)this.NN(e,s);return 0===e.bars.length?e.bars.push({nodeType:_t.Bar,metaData:this.Si.buildScoreMetaDataNodes(t),beats:[]}):e.bars[0].metaData=this.Si.buildScoreMetaDataNodes(t).concat(e.bars[0].metaData),e.bars.push({nodeType:_t.Bar,metaData:this.Si.buildSyncPointNodes(t),beats:[]}),e}NN(t,e){for(const s of e.staves)this.kS(t,s)}kS(t,e){const s=Math.max(...e.filledVoices)+1;if(0===e.bars.length){const s={nodeType:_t.Bar,metaData:this.Si.buildBarMetaDataNodes(e,void 0,0,!1),beats:[],pipe:void 0};t.bars.push(s)}else for(let i=0;i<s;i++)this.PN(t,i,e,s>1)}PN(t,e,s,i){for(const n of s.bars)this.We(t,n,e,i)}We(t,e,s,i){const n={nodeType:_t.Bar,metaData:this.Si.buildBarMetaDataNodes(e.staff,e,s,i),beats:[],pipe:void 0};if(e.isEmpty)n.trailingComments=[{multiLine:!1,text:`Bar ${e.index+1} / Voice ${s+1} no contents`}];else{const t=e.voices[s];if(t.isEmpty)n.trailingComments=[{multiLine:!1,text:`Bar ${e.index+1} / Voice ${s+1} no contents`}];else{for(const e of t.beats)n.beats.push(this.Ge(e));n.beats.length>0&&(n.beats[0].leadingComments??=[],n.beats[0].leadingComments.unshift({multiLine:!1,text:`Bar ${e.index+1} / Voice ${s+1} contents`}))}}e.index<e.staff.bars.length-1&&(n.pipe={nodeType:_t.Pipe}),t.bars.push(n)}Ge(t){const e={nodeType:_t.Beat,durationChange:void 0,notes:void 0,rest:void 0,beatEffects:void 0};return t.isRest?e.rest={nodeType:_t.Ident,text:"r"}:e.notes=this.jS(t.notes),e.durationDot={nodeType:_t.Dot},e.durationValue={nodeType:_t.Number,value:t.duration},e.beatEffects=this.Ai(t),e}Ai(t){const e=this.Si.buildBeatEffects(t);return e.length>0?{nodeType:_t.Props,openBrace:{nodeType:_t.LBrace},properties:e,closeBrace:{nodeType:_t.RBrace}}:void 0}jS(t){const e={nodeType:_t.NoteList,openParenthesis:void 0,notes:[],closeParenthesis:void 0};(0===t.length||t.length>1)&&(e.openParenthesis={nodeType:_t.LParen},e.closeParenthesis={nodeType:_t.RParen});for(const s of t)e.notes.push(this.je(s));return e}je(t){const e={nodeType:_t.Note,noteValue:{nodeType:_t.Ident,text:""}};if(t.isPercussion)e.noteValue={nodeType:_t.String,text:Jt.getArticulationName(t)};else if(t.isPiano)e.noteValue={nodeType:_t.Ident,text:Te.getTextForTuning(t.realValueWithoutHarmonic,!0)};else{if(!t.isStringed)throw new Error("What kind of note");{e.noteValue={nodeType:_t.Number,value:t.fret},e.noteStringDot={nodeType:_t.Dot};const s=t.beat.voice.bar.staff.tuning.length-t.string+1;e.noteString={nodeType:_t.Number,value:s}}}return e.noteEffects=this.Di(t),e}Di(t){const e=this.Si.buildNoteEffects(t);return e.length>0?{nodeType:_t.Props,openBrace:{nodeType:_t.LBrace},properties:e,closeBrace:{nodeType:_t.RBrace}}:void 0}},Gp7Exporter:class extends Du{get name(){return"Guitar Pro 7-8"}writeScore(t){J.debug(this.name,"Writing data entries");const e=new $u,s=e.writeXml(t),i=zs.writeForScore(t),n=Qs.writeForScore(t),r=ei.writeForScore(t);J.debug(this.name,"Writing ZIP entries");const a=new Qu(this.data);a.writeEntry(new ys("VERSION",de.stringToBytes("7.0"))),a.writeEntry(new ys("Content/",new Uint8Array(0))),a.writeEntry(new ys("Content/BinaryStylesheet",i)),a.writeEntry(new ys("Content/PartConfiguration",n)),a.writeEntry(new ys("Content/LayoutConfiguration",r)),a.writeEntry(new ys("Content/score.gpif",de.stringToBytes(s))),e.backingTrackAssetFileName&&a.writeEntry(new ys(e.backingTrackAssetFileName,t.backingTrack.rawAudioFile)),a.end()}},ScoreExporter:Du},Symbol.toStringTag,{value:"Module"}));class td extends xi{constructor(){super(0,0,Ye.EndOfTrack)}writeTo(t){throw new I(s.General,"Deprecated event, serialization not supported")}}var ed,sd,id;!function(t){t[t.SequenceNumber=0]="SequenceNumber",t[t.TextEvent=1]="TextEvent",t[t.CopyrightNotice=2]="CopyrightNotice",t[t.SequenceOrTrackName=3]="SequenceOrTrackName",t[t.InstrumentName=4]="InstrumentName",t[t.LyricText=5]="LyricText",t[t.MarkerText=6]="MarkerText",t[t.CuePoint=7]="CuePoint",t[t.PatchName=8]="PatchName",t[t.PortName=9]="PortName",t[t.MidiChannel=32]="MidiChannel",t[t.MidiPort=33]="MidiPort",t[t.EndOfTrack=47]="EndOfTrack",t[t.Tempo=81]="Tempo",t[t.SmpteOffset=84]="SmpteOffset",t[t.TimeSignature=88]="TimeSignature",t[t.KeySignature=89]="KeySignature",t[t.SequencerSpecific=127]="SequencerSpecific"}(ed||(ed={}));class nd extends td{get metaStatus(){return ed.EndOfTrack}}!function(t){t[t.SystemExclusive=240]="SystemExclusive",t[t.MtcQuarterFrame=241]="MtcQuarterFrame",t[t.SongPosition=242]="SongPosition",t[t.SongSelect=243]="SongSelect",t[t.TuneRequest=246]="TuneRequest",t[t.SystemExclusive2=247]="SystemExclusive2"}(sd||(sd={}));class rd extends td{}!function(t){t[t.MetronomeTick=0]="MetronomeTick",t[t.Rest=1]="Rest"}(id||(id={}));const ad=Object.freeze(Object.defineProperty({__proto__:null,AlphaSynthMidiFileHandler:ka,AlphaTabMetronomeEvent:Ni,AlphaTabRestEvent:Pi,AlphaTabSysExEvent:vi,get AlphaTabSystemExclusiveEvents(){return id},BeatTickLookup:Ta,BeatTickLookupItem:_a,ControlChangeEvent:Ai,get ControllerType(){return ns},DeprecatedMidiEvent:td,EndOfTrackEvent:Ri,MasterBarTickLookup:Ma,MasterBarTickLookupTempoChange:xa,MetaDataEvent:class extends nd{data=new Uint8Array},MetaEvent:nd,get MetaEventType(){return ed},MetaNumberEvent:class extends nd{value=0},Midi20PerNotePitchBendEvent:class extends td{noteKey=0;pitch=0},MidiEvent:xi,get MidiEventType(){return Ye},MidiFile:Ti,get MidiFileFormat(){return qe},MidiFileGenerator:Da,MidiTickLookup:Pa,MidiTickLookupFindBeatResult:va,get MidiTickLookupFindBeatResultCursorMode(){return ps},MidiTrack:_i,NoteBendEvent:Oi,NoteEvent:Ci,NoteOffEvent:Fi,NoteOnEvent:Ei,PitchBendEvent:Wi,ProgramChangeEvent:Di,SystemCommonEvent:rd,get SystemCommonType(){return sd},SystemExclusiveEvent:class extends rd{static AlphaTabManufacturerId=125;data=new Uint8Array;get isMetronome(){return!1}get metronomeNumerator(){return-1}get metronomeDurationInTicks(){return-1}get metronomeDurationInMilliseconds(){return-1}get isRest(){return!1}get manufacturerId(){return 0}},TempoChangeEvent:Li,TimeSignatureEvent:Mi},Symbol.toStringTag,{value:"Module"})),hd=Object.freeze(Object.defineProperty({__proto__:null,get AccentuationType(){return u},get AccidentalType(){return T},Automation:$,get AutomationType(){return n},BackingTrack:Xs,Bar:Q,get BarLineStyle(){return E},get BarNumberDisplay(){return O},BarStyle:K,get BarSubElement(){return C},get BarreShape(){return wt},BeamingRules:Z,Beat:ee,get BeatBeamingMode(){return St},BeatStyle:te,get BeatSubElement(){return Bt},BendPoint:U,get BendStyle(){return r},get BendType(){return a},get BracketExtendMode(){return A},get BrushType(){return h},Chord:we,get Clef(){return x},Color:ke,get CrescendoType(){return o},get Direction(){return ze},get Duration(){return c},get DynamicValue(){return i},ElementStyle:q,get FadeType(){return mt},Fermata:Se,get FermataType(){return At},get Fingers(){return d},Font:Vr,get FontStyle(){return rs},get FontWeight(){return as},get GolpeType(){return bt},GraceGroup:it,get GraceType(){return l},get HarmonicType(){return f},HeaderFooterStyle:It,InstrumentArticulation:jt,JsonConverter:aa,get KeySignature(){return v},get KeySignatureType(){return N},Lyrics:Be,MasterBar:tt,get MusicFontSymbol(){return lt},Note:Kt,get NoteAccidentalMode(){return p},get NoteOrnament(){return dt},NoteStyle:Yt,get NoteSubElement(){return ft},get Ottavia(){return b},get PickStroke(){return ct},PlaybackInformation:Me,get Rasgueado(){return yt},RenderStylesheet:et,RepeatGroup:st,Score:Ht,ScoreStyle:Gt,get ScoreSubElement(){return ot},Section:_e,get SimileMark(){return M},get SlideInType(){return m},get SlideOutType(){return g},Staff:xe,SustainPedalMarker:Y,get SustainPedalMarkerType(){return P},SyncPointData:V,get TechniqueSymbolPlacement(){return ut},Track:Ne,get TrackNameMode(){return L},get TrackNameOrientation(){return W},get TrackNamePolicy(){return D},TrackStyle:ve,get TrackSubElement(){return Lt},TremoloPickingEffect:Zt,get TremoloPickingStyle(){return kt},get TripletFeel(){return F},Tuning:Te,TupletGroup:Qt,get VibratoType(){return w},Voice:rt,VoiceStyle:nt,get VoiceSubElement(){return R},get WahPedal(){return gt},get WhammyType(){return pt}},Symbol.toStringTag,{value:"Module"})),od=Object.freeze(Object.defineProperty({__proto__:null,BarBounds:ua,get BeamDirection(){return Wt},BeatBounds:da,Bounds:Us,BoundsLookup:ma,MasterBarBounds:fa,NoteBounds:pa,RenderFinishedEventArgs:la,ScoreRenderer:ga,StaffSystemBounds:ba},Symbol.toStringTag,{value:"Module"})),cd=Object.freeze(Object.defineProperty({__proto__:null,CssFontSvgCanvas:Ch,Cursors:sh,FontSizeDefinition:oa,FontSizes:ca,MeasuredText:Ot,SvgCanvas:Ph,get TextAlign(){return at},get TextBaseline(){return ht}},Symbol.toStringTag,{value:"Module"})),ld=Object.freeze(Object.defineProperty({__proto__:null,ActiveBeatsChangedEventArgs:qa,AlphaSynth:sr,AlphaSynthAudioWorkletOutput:Bi,AlphaSynthBase:er,AlphaSynthScriptProcessorOutput:lh,AlphaSynthWebAudioOutputBase:ki,AlphaSynthWebWorkerApi:uh,AudioExportChunk:tr,AudioExportOptions:Zn,BackingTrackSyncPoint:Gi,CircularSampleBuffer:pi,MidiEventsPlayedEventArgs:Kn,PlaybackRange:Ya,PlaybackRangeChangedEventArgs:Qn,get PlayerState(){return Ke},PlayerStateChangedEventArgs:Ui,PositionChangedEventArgs:zi},Symbol.toStringTag,{value:"Module"})),ud=Object.freeze(Object.defineProperty({__proto__:null},Symbol.toStringTag,{value:"Module"}));export{wh as AlphaTabApi,nh as AlphaTabApiBase,I as AlphaTabError,s as AlphaTabErrorType,j as ConsoleLogger,Cu as CoreSettings,zr as DisplaySettings,Rr as EngravingSettings,Or as EngravingStemInfo,Pu as Environment,na as ExporterSettings,rh as FileLoadError,k as FingeringMode,Mh as FontFileFormat,ye as FormatError,ia as ImporterSettings,Je as LayoutMode,_ as LogLevel,J as Logger,B as NotationElement,S as NotationMode,z as NotationSettings,us as PlayerMode,ls as PlayerOutputMode,Zr as PlayerSettings,gh as ProgressEventArgs,Nu as RenderEngineFactory,Ur as RenderingResources,Ha as ResizeEventArgs,cs as ScrollMode,ra as Settings,Qr as SlidePlaybackSettings,hs as StaveProfile,os as SystemsLayoutMode,y as TabRhythmMode,Kr as VibratoPlaybackSettings,ds as WebPlatform,Zu as exporter,Fu as importer,Au as io,ud as json,G as meta,ad as midi,hd as model,cd as platform,od as rendering,ld as synth};