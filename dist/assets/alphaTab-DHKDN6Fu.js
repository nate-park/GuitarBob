var Qc=Object.defineProperty;var Kc=(n,t,e)=>t in n?Qc(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e;var o=(n,t,e)=>Kc(n,typeof t!="symbol"?t+"":t,e);/*!
 * alphaTab v1.8.1 (, build 30)
 *
 * Copyright © 2026, Daniel Kuschny and Contributors, All rights reserved.
 *
 * This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at http://mozilla.org/MPL/2.0/.
 *
 * Integrated Libraries:
 *
 * Library: TinySoundFont
 * License: MIT
 * Copyright: Copyright (C) 2017, 2018 Bernhard Schelling
 * URL: https://github.com/schellingb/TinySoundFont
 * Purpose: SoundFont loading and Audio Synthesis
 *
 * Library: SFZero
 * License: MIT
 * Copyright: Copyright (C) 2012 Steve Folta ()
 * URL: https://github.com/stevefolta/SFZero
 * Purpose: TinySoundFont is based on SFZEro
 *
 * Library: Haxe Standard Library
 * License: MIT
 * Copyright: Copyright (C)2005-2025 Haxe Foundation
 * URL: https://github.com/HaxeFoundation/haxe/tree/development/std
 * Purpose: XML Parser & Zip Inflate Algorithm
 *
 * Library: SharpZipLib
 * License: MIT
 * Copyright: Copyright © 2000-2018 SharpZipLib Contributors
 * URL: https://github.com/icsharpcode/SharpZipLib
 * Purpose: Zip Deflate Algorithm for writing compressed Zips
 *
 * Library: NVorbis
 * License: MIT
 * Copyright: Copyright (c) 2020 Andrew Ward
 * URL: https://github.com/NVorbis/NVorbis
 * Purpose: Vorbis Stream Decoding
 *
 * Library: libvorbis
 * License: BSD-3-Clause
 * Copyright: Copyright (c) 2002-2020 Xiph.org Foundation
 * URL: https://github.com/xiph/vorbis
 * Purpose: NVorbis adopted some code from libvorbis.
 *
 * @preserve
 * @license
 */class Zc{constructor(t){o(this,"_callback");o(this,"_targets",new Set);this._callback=t,window.addEventListener("resize",this._onWindowResize.bind(this),!1)}observe(t){this._targets.add(t)}unobserve(t){this._targets.delete(t)}disconnect(){this._targets.clear()}_onWindowResize(){const t=[];for(const e of this._targets)t.push({target:e,contentRect:void 0,borderBoxSize:void 0,contentBoxSize:[],devicePixelContentBoxSize:[]});this._callback(t,this)}}class jc{constructor(t){o(this,"_callback");o(this,"_elements",[]);o(this,"_timer",null);this._callback=t,window.addEventListener("resize",()=>this._check,!0),document.addEventListener("scroll",()=>this._check,!0)}_check(){this._timer||(this._timer=setTimeout(()=>{this._doCheck(),this._timer=null},100))}observe(t){this._elements.indexOf(t)>=0||(this._elements.push(t),this._check())}unobserve(t){this._elements=this._elements.filter(e=>e!==t)}_doCheck(){const t=[];for(const e of this._elements){const s=e.getBoundingClientRect();s.top+s.height>=0&&s.top<=window.innerHeight&&s.left+s.width>=0&&s.left<=window.innerWidth&&t.push({target:e,isIntersecting:!0})}t.length&&this._callback(t,this)}}typeof Symbol.dispose>"u"&&(Symbol.dispose=Symbol("Symbol.dispose")),typeof window<"u"&&("ResizeObserver"in globalThis||(globalThis.ResizeObserver=Zc),"IntersectionObserver"in globalThis||(globalThis.IntersectionObserver=jc),"replaceChildren"in Element.prototype||(Element.prototype.replaceChildren=function(...n){this.innerHTML="",this.append(...n)},Document.prototype.replaceChildren=Element.prototype.replaceChildren,DocumentFragment.prototype.replaceChildren=Element.prototype.replaceChildren)),"replaceAll"in String.prototype||(String.prototype.replaceAll=function(n,t){return this.replace(new RegExp(n,"g"),t)});var ze;(function(n){n[n.General=0]="General",n[n.Format=1]="Format",n[n.AlphaTex=2]="AlphaTex"})(ze||(ze={}));class Xe extends Error{constructor(e,s="",i){super(s??"",{cause:i});o(this,"type");this.type=e}}const Ki=class Ki{static print(t){t(`alphaTab ${Ki.version}`),t(`commit: ${Ki.commit}`),t(`build date: ${Ki.date}`)}};o(Ki,"version","1.8.1"),o(Ki,"date","2026-02-01T19:53:46.853Z"),o(Ki,"commit","8a2102fe7ee7dcf4b50c3a4198fbb8c0d5c0fda3");let Va=Ki;var re;(function(n){n[n.PPP=0]="PPP",n[n.PP=1]="PP",n[n.P=2]="P",n[n.MP=3]="MP",n[n.MF=4]="MF",n[n.F=5]="F",n[n.FF=6]="FF",n[n.FFF=7]="FFF",n[n.PPPP=8]="PPPP",n[n.PPPPP=9]="PPPPP",n[n.PPPPPP=10]="PPPPPP",n[n.FFFF=11]="FFFF",n[n.FFFFF=12]="FFFFF",n[n.FFFFFF=13]="FFFFFF",n[n.SF=14]="SF",n[n.SFP=15]="SFP",n[n.SFPP=16]="SFPP",n[n.FP=17]="FP",n[n.RF=18]="RF",n[n.RFZ=19]="RFZ",n[n.SFZ=20]="SFZ",n[n.SFFZ=21]="SFFZ",n[n.FZ=22]="FZ",n[n.N=23]="N",n[n.PF=24]="PF",n[n.SFZP=25]="SFZP"})(re||(re={}));const et=class et{static ticksToMillis(t,e){return t*(6e4/(e*et.QuarterTime))|0}static millisToTicks(t,e){return t/(6e4/(e*et.QuarterTime))|0}static toTicks(t){return et.valueToTicks(t)}static valueToTicks(t){let e=t;return e<0&&(e=1/-e),et.QuarterTime*(4/e)|0}static applyDot(t,e){return e?t+(t/4|0)*3:t+(t/2|0)}static applyTuplet(t,e,s){return t*s/e|0}static removeTuplet(t,e,s){return t*e/s|0}static dynamicToVelocity(t,e=0){let s=1;switch(t){case re.PPP:s=et._minVelocity+0*et.VelocityIncrement;break;case re.PP:s=et._minVelocity+1*et.VelocityIncrement;break;case re.P:s=et._minVelocity+2*et.VelocityIncrement;break;case re.MP:s=et._minVelocity+3*et.VelocityIncrement;break;case re.MF:s=et._minVelocity+4*et.VelocityIncrement;break;case re.F:s=et._minVelocity+5*et.VelocityIncrement;break;case re.FF:s=et._minVelocity+6*et.VelocityIncrement;break;case re.FFF:s=et._minVelocity+7*et.VelocityIncrement;break;case re.PPPP:s=10;break;case re.PPPPP:s=5;break;case re.PPPPPP:s=3;break;case re.FFFF:s=et._minVelocity+8*et.VelocityIncrement;break;case re.FFFFF:s=et._minVelocity+9*et.VelocityIncrement;break;case re.FFFFFF:s=et._minVelocity+10*et.VelocityIncrement;break;case re.SF:case re.SFP:case re.SFZP:case re.SFPP:case re.SFZ:case re.FZ:s=et._minVelocity+6*et.VelocityIncrement;break;case re.FP:s=et._minVelocity+5*et.VelocityIncrement;break;case re.RF:case re.RFZ:case re.SFFZ:s=et._minVelocity+5*et.VelocityIncrement;break;case re.N:s=1;break;case re.PF:s=et._minVelocity+(4.5*et.VelocityIncrement|0);break}return s+=e*et.VelocityIncrement,Math.min(Math.max(s,1),127)}};o(et,"QuarterTime",960),o(et,"_minVelocity",15),o(et,"VelocityIncrement",16);let D=et;var Ve;(function(n){n[n.Tempo=0]="Tempo",n[n.Volume=1]="Volume",n[n.Instrument=2]="Instrument",n[n.Balance=3]="Balance",n[n.SyncPoint=4]="SyncPoint",n[n.Bank=4]="Bank"})(Ve||(Ve={}));class ja{constructor(){o(this,"barOccurence",0);o(this,"millisecondOffset",0)}}class nt{constructor(){o(this,"isLinear",!1);o(this,"type",Ve.Tempo);o(this,"value",0);o(this,"syncPointValue");o(this,"ratioPosition",0);o(this,"text","");o(this,"isVisible",!0)}static buildTempoAutomation(t,e,s,i,r=!0){(i<1||i>5)&&(i=2);const a=new Float32Array([1,.5,1,1.5,2,3]),l=new nt;return l.type=Ve.Tempo,l.isLinear=t,l.ratioPosition=e,l.value=s*a[i],l.isVisible=r,l}static buildInstrumentAutomation(t,e,s){const i=new nt;return i.type=Ve.Instrument,i.isLinear=t,i.ratioPosition=e,i.value=s,i}}class H{constructor(t=0,e=0){o(this,"offset");o(this,"value");this.offset=t,this.value=e}}o(H,"MaxPosition",60),o(H,"MaxValue",12);var tt;(function(n){n[n.Default=0]="Default",n[n.Gradual=1]="Gradual",n[n.Fast=2]="Fast"})(tt||(tt={}));var J;(function(n){n[n.None=0]="None",n[n.Custom=1]="Custom",n[n.Bend=2]="Bend",n[n.Release=3]="Release",n[n.BendRelease=4]="BendRelease",n[n.Hold=5]="Hold",n[n.Prebend=6]="Prebend",n[n.PrebendBend=7]="PrebendBend",n[n.PrebendRelease=8]="PrebendRelease"})(J||(J={}));var Y;(function(n){n[n.None=0]="None",n[n.BrushUp=1]="BrushUp",n[n.BrushDown=2]="BrushDown",n[n.ArpeggioUp=3]="ArpeggioUp",n[n.ArpeggioDown=4]="ArpeggioDown"})(Y||(Y={}));var Jt;(function(n){n[n.None=0]="None",n[n.Crescendo=1]="Crescendo",n[n.Decrescendo=2]="Decrescendo"})(Jt||(Jt={}));var b;(function(n){n[n.QuadrupleWhole=-4]="QuadrupleWhole",n[n.DoubleWhole=-2]="DoubleWhole",n[n.Whole=1]="Whole",n[n.Half=2]="Half",n[n.Quarter=4]="Quarter",n[n.Eighth=8]="Eighth",n[n.Sixteenth=16]="Sixteenth",n[n.ThirtySecond=32]="ThirtySecond",n[n.SixtyFourth=64]="SixtyFourth",n[n.OneHundredTwentyEighth=128]="OneHundredTwentyEighth",n[n.TwoHundredFiftySixth=256]="TwoHundredFiftySixth"})(b||(b={}));var ee;(function(n){n[n.None=0]="None",n[n.OnBeat=1]="OnBeat",n[n.BeforeBeat=2]="BeforeBeat",n[n.BendGrace=3]="BendGrace"})(ee||(ee={}));var mt;(function(n){n[n.None=0]="None",n[n.Normal=1]="Normal",n[n.Heavy=2]="Heavy",n[n.Tenuto=3]="Tenuto"})(mt||(mt={}));var ae;(function(n){n[n.Unknown=-2]="Unknown",n[n.NoOrDead=-1]="NoOrDead",n[n.Thumb=0]="Thumb",n[n.IndexFinger=1]="IndexFinger",n[n.MiddleFinger=2]="MiddleFinger",n[n.AnnularFinger=3]="AnnularFinger",n[n.LittleFinger=4]="LittleFinger"})(ae||(ae={}));var ie;(function(n){n[n.None=0]="None",n[n.Natural=1]="Natural",n[n.Artificial=2]="Artificial",n[n.Pinch=3]="Pinch",n[n.Tap=4]="Tap",n[n.Semi=5]="Semi",n[n.Feedback=6]="Feedback"})(ie||(ie={}));var de;(function(n){n[n.Default=0]="Default",n[n.ForceNone=1]="ForceNone",n[n.ForceNatural=2]="ForceNatural",n[n.ForceSharp=3]="ForceSharp",n[n.ForceDoubleSharp=4]="ForceDoubleSharp",n[n.ForceFlat=5]="ForceFlat",n[n.ForceDoubleFlat=6]="ForceDoubleFlat"})(de||(de={}));var pe;(function(n){n[n._15ma=0]="_15ma",n[n._8va=1]="_8va",n[n.Regular=2]="Regular",n[n._8vb=3]="_8vb",n[n._15mb=4]="_15mb"})(pe||(pe={}));var Et;(function(n){n[n.None=0]="None",n[n.IntoFromBelow=1]="IntoFromBelow",n[n.IntoFromAbove=2]="IntoFromAbove"})(Et||(Et={}));var ge;(function(n){n[n.None=0]="None",n[n.Shift=1]="Shift",n[n.Legato=2]="Legato",n[n.OutUp=3]="OutUp",n[n.OutDown=4]="OutDown",n[n.PickSlideDown=5]="PickSlideDown",n[n.PickSlideUp=6]="PickSlideUp"})(ge||(ge={}));var Ee;(function(n){n[n.None=0]="None",n[n.Slight=1]="Slight",n[n.Wide=2]="Wide"})(Ee||(Ee={}));var Xs;(function(n){n[n.Hidden=0]="Hidden",n[n.ShowWithBeams=1]="ShowWithBeams",n[n.ShowWithBars=2]="ShowWithBars",n[n.Automatic=3]="Automatic"})(Xs||(Xs={}));var di;(function(n){n[n.ScoreDefault=0]="ScoreDefault",n[n.ScoreForcePiano=1]="ScoreForcePiano",n[n.SingleNoteEffectBand=2]="SingleNoteEffectBand",n[n.SingleNoteEffectBandForcePiano=3]="SingleNoteEffectBandForcePiano"})(di||(di={}));var Xt;(function(n){n[n.GuitarPro=0]="GuitarPro",n[n.SongBook=1]="SongBook"})(Xt||(Xt={}));var v;(function(n){n[n.ScoreTitle=0]="ScoreTitle",n[n.ScoreSubTitle=1]="ScoreSubTitle",n[n.ScoreArtist=2]="ScoreArtist",n[n.ScoreAlbum=3]="ScoreAlbum",n[n.ScoreWords=4]="ScoreWords",n[n.ScoreMusic=5]="ScoreMusic",n[n.ScoreWordsAndMusic=6]="ScoreWordsAndMusic",n[n.ScoreCopyright=7]="ScoreCopyright",n[n.GuitarTuning=8]="GuitarTuning",n[n.TrackNames=9]="TrackNames",n[n.ChordDiagrams=10]="ChordDiagrams",n[n.ParenthesisOnTiedBends=11]="ParenthesisOnTiedBends",n[n.TabNotesOnTiedBends=12]="TabNotesOnTiedBends",n[n.ZerosOnDiveWhammys=13]="ZerosOnDiveWhammys",n[n.EffectAlternateEndings=14]="EffectAlternateEndings",n[n.EffectCapo=15]="EffectCapo",n[n.EffectChordNames=16]="EffectChordNames",n[n.EffectCrescendo=17]="EffectCrescendo",n[n.EffectDynamics=18]="EffectDynamics",n[n.EffectFadeIn=19]="EffectFadeIn",n[n.EffectFermata=20]="EffectFermata",n[n.EffectFingering=21]="EffectFingering",n[n.EffectHarmonics=22]="EffectHarmonics",n[n.EffectLetRing=23]="EffectLetRing",n[n.EffectLyrics=24]="EffectLyrics",n[n.EffectMarker=25]="EffectMarker",n[n.EffectOttavia=26]="EffectOttavia",n[n.EffectPalmMute=27]="EffectPalmMute",n[n.EffectPickSlide=28]="EffectPickSlide",n[n.EffectPickStroke=29]="EffectPickStroke",n[n.EffectSlightBeatVibrato=30]="EffectSlightBeatVibrato",n[n.EffectSlightNoteVibrato=31]="EffectSlightNoteVibrato",n[n.EffectTap=32]="EffectTap",n[n.EffectTempo=33]="EffectTempo",n[n.EffectText=34]="EffectText",n[n.EffectTrill=35]="EffectTrill",n[n.EffectTripletFeel=36]="EffectTripletFeel",n[n.EffectWhammyBar=37]="EffectWhammyBar",n[n.EffectWideBeatVibrato=38]="EffectWideBeatVibrato",n[n.EffectWideNoteVibrato=39]="EffectWideNoteVibrato",n[n.EffectLeftHandTap=40]="EffectLeftHandTap",n[n.EffectFreeTime=41]="EffectFreeTime",n[n.EffectSustainPedal=42]="EffectSustainPedal",n[n.EffectGolpe=43]="EffectGolpe",n[n.EffectWahPedal=44]="EffectWahPedal",n[n.EffectBeatBarre=45]="EffectBeatBarre",n[n.EffectNoteOrnament=46]="EffectNoteOrnament",n[n.EffectRasgueado=47]="EffectRasgueado",n[n.EffectDirections=48]="EffectDirections",n[n.EffectBeatTimer=49]="EffectBeatTimer",n[n.EffectWhammyBarLine=50]="EffectWhammyBarLine",n[n.EffectNumberedNotationKeySignature=51]="EffectNumberedNotationKeySignature",n[n.ChordDiagramFretboardNumbers=52]="ChordDiagramFretboardNumbers",n[n.BarNumber=53]="BarNumber",n[n.RepeatCount=54]="RepeatCount",n[n.ScoreBendSlur=55]="ScoreBendSlur"})(v||(v={}));const va=class va{constructor(){o(this,"notationMode",Xt.GuitarPro);o(this,"fingeringMode",di.ScoreDefault);o(this,"elements",new Map);o(this,"rhythmMode",Xs.Automatic);o(this,"rhythmHeight",25);o(this,"transpositionPitches",[]);o(this,"displayTranspositionPitches",[]);o(this,"smallGraceTabNotes",!0);o(this,"extendBendArrowsOnTiedNotes",!0);o(this,"extendLineEffectsToBeatEnd",!1);o(this,"slurHeight",5)}isNotationElementVisible(t){return this.elements.has(t)?this.elements.get(t):va.defaultElements.has(t)?va.defaultElements.get(t):!0}};o(va,"defaultElements",new Map([[v.ZerosOnDiveWhammys,!1]]));let Wo=va;class Kr{constructor(t){o(this,"_factory");o(this,"_value");this._factory=t}get hasValue(){return this._value!==void 0}get value(){return this._value===void 0&&(this._value=this._factory()),this._value}reset(){this._value=void 0}}var oi;(function(n){n[n.None=0]="None",n[n.Debug=1]="Debug",n[n.Info=2]="Info",n[n.Warning=3]="Warning",n[n.Error=4]="Error"})(oi||(oi={}));const gr=class gr{static _format(t,e){return`[AlphaTab][${t}] ${e}`}debug(t,e,...s){console.debug(gr._format(t,e),...s)}warning(t,e,...s){console.warn(gr._format(t,e),...s)}info(t,e,...s){console.info(gr._format(t,e),...s)}error(t,e,...s){console.error(gr._format(t,e),...s)}};o(gr,"logLevel",oi.Info);let Vo=gr;const As=class As{static _shouldLog(t){return As.logLevel!==oi.None&&t>=As.logLevel}static debug(t,e,...s){As._shouldLog(oi.Debug)&&As.log.debug(t,e,...s)}static warning(t,e,...s){As._shouldLog(oi.Warning)&&As.log.warning(t,e,...s)}static info(t,e,...s){As._shouldLog(oi.Info)&&As.log.info(t,e,...s)}static error(t,e,...s){As._shouldLog(oi.Error)&&As.log.error(t,e,...s)}};o(As,"logLevel",oi.Info),o(As,"log",new Vo);let L=As;var he;(function(n){n[n.None=0]="None",n[n.Natural=1]="Natural",n[n.Sharp=2]="Sharp",n[n.Flat=3]="Flat",n[n.NaturalQuarterNoteUp=4]="NaturalQuarterNoteUp",n[n.SharpQuarterNoteUp=5]="SharpQuarterNoteUp",n[n.FlatQuarterNoteUp=6]="FlatQuarterNoteUp",n[n.DoubleSharp=7]="DoubleSharp",n[n.DoubleFlat=8]="DoubleFlat"})(he||(he={}));var Fe;(function(n){n[n.Neutral=0]="Neutral",n[n.C3=1]="C3",n[n.C4=2]="C4",n[n.F4=3]="F4",n[n.G2=4]="G2"})(Fe||(Fe={}));var At;(function(n){n[n.None=0]="None",n[n.Simple=1]="Simple",n[n.FirstOfDouble=2]="FirstOfDouble",n[n.SecondOfDouble=3]="SecondOfDouble"})(At||(At={}));class Mr{constructor(){o(this,"colors",new Map)}}var Ke;(function(n){n[n.Cb=-7]="Cb",n[n.Gb=-6]="Gb",n[n.Db=-5]="Db",n[n.Ab=-4]="Ab",n[n.Eb=-3]="Eb",n[n.Bb=-2]="Bb",n[n.F=-1]="F",n[n.C=0]="C",n[n.G=1]="G",n[n.D=2]="D",n[n.A=3]="A",n[n.E=4]="E",n[n.B=5]="B",n[n.FSharp=6]="FSharp",n[n.CSharp=7]="CSharp"})(Ke||(Ke={}));var cs;(function(n){n[n.Major=0]="Major",n[n.Minor=1]="Minor"})(cs||(cs={}));var lt;(function(n){n[n.Down=0]="Down",n[n.Hold=1]="Hold",n[n.Up=2]="Up"})(lt||(lt={}));class Vi{constructor(){o(this,"ratioPosition",0);o(this,"pedalType",lt.Down);o(this,"bar");o(this,"nextPedalMarker",null);o(this,"previousPedalMarker",null)}}var Ae;(function(n){n[n.StandardNotationRepeats=0]="StandardNotationRepeats",n[n.GuitarTabsRepeats=1]="GuitarTabsRepeats",n[n.SlashRepeats=2]="SlashRepeats",n[n.NumberedRepeats=3]="NumberedRepeats",n[n.StandardNotationBarNumber=4]="StandardNotationBarNumber",n[n.GuitarTabsBarNumber=5]="GuitarTabsBarNumber",n[n.SlashBarNumber=6]="SlashBarNumber",n[n.NumberedBarNumber=7]="NumberedBarNumber",n[n.StandardNotationBarLines=8]="StandardNotationBarLines",n[n.GuitarTabsBarLines=9]="GuitarTabsBarLines",n[n.SlashBarLines=10]="SlashBarLines",n[n.NumberedBarLines=11]="NumberedBarLines",n[n.StandardNotationClef=12]="StandardNotationClef",n[n.GuitarTabsClef=13]="GuitarTabsClef",n[n.StandardNotationKeySignature=14]="StandardNotationKeySignature",n[n.NumberedKeySignature=15]="NumberedKeySignature",n[n.StandardNotationTimeSignature=16]="StandardNotationTimeSignature",n[n.GuitarTabsTimeSignature=17]="GuitarTabsTimeSignature",n[n.SlashTimeSignature=18]="SlashTimeSignature",n[n.NumberedTimeSignature=19]="NumberedTimeSignature",n[n.StandardNotationStaffLine=20]="StandardNotationStaffLine",n[n.GuitarTabsStaffLine=21]="GuitarTabsStaffLine",n[n.SlashStaffLine=22]="SlashStaffLine",n[n.NumberedStaffLine=23]="NumberedStaffLine"})(Ae||(Ae={}));class fc extends Mr{}var Be;(function(n){n[n.Automatic=0]="Automatic",n[n.Dashed=1]="Dashed",n[n.Dotted=2]="Dotted",n[n.Heavy=3]="Heavy",n[n.HeavyHeavy=4]="HeavyHeavy",n[n.HeavyLight=5]="HeavyLight",n[n.LightHeavy=6]="LightHeavy",n[n.LightLight=7]="LightLight",n[n.None=8]="None",n[n.Regular=9]="Regular",n[n.Short=10]="Short",n[n.Tick=11]="Tick"})(Be||(Be={}));const Zi=class Zi{constructor(){o(this,"id",Zi._globalBarId++);o(this,"index",0);o(this,"nextBar",null);o(this,"previousBar",null);o(this,"clef",Fe.G2);o(this,"clefOttava",pe.Regular);o(this,"staff");o(this,"voices",[]);o(this,"simileMark",At.None);o(this,"_filledVoices",new Set([0]));o(this,"displayScale",1);o(this,"displayWidth",-1);o(this,"sustainPedals",[]);o(this,"_isEmpty",!0);o(this,"_isRestOnly",!0);o(this,"barLineLeft",Be.Automatic);o(this,"barLineRight",Be.Automatic);o(this,"keySignature",Ke.C);o(this,"keySignatureType",cs.Major);o(this,"barNumberDisplay");o(this,"shortestDuration",b.DoubleWhole);o(this,"style")}static resetIds(){Zi._globalBarId=0}get isMultiVoice(){return this._filledVoices.size>1}get filledVoices(){return this._filledVoices}get masterBar(){return this.staff.track.score.masterBars[this.index]}get isEmpty(){return this._isEmpty}get hasChanges(){return this.index===0||this.keySignature!==this.previousBar.keySignature||this.keySignatureType!==this.previousBar.keySignatureType||this.clef!==this.previousBar.clef||this.clefOttava!==this.previousBar.clefOttava?!0:this.simileMark!==At.None||this.sustainPedals.length>0||this.barLineLeft!==Be.Automatic||this.barLineRight!==Be.Automatic}get isRestOnly(){return this._isRestOnly}getActualBarLineLeft(t){return Zi._actualBarLine(this,!1,t)}getActualBarLineRight(){return Zi._actualBarLine(this,!0,!1)}static _automaticToActualType(t,e,s){let i;return e?t.isRepeatEnd?i=Be.LightHeavy:t.nextMasterBar?t.isFreeTime?i=Be.Dashed:t.isDoubleBar?i=Be.LightLight:i=Be.Regular:i=Be.LightHeavy:t.isRepeatStart?i=Be.HeavyLight:s?i=Be.Regular:i=Be.None,i}static _actualBarLine(t,e,s){const i=t.masterBar,r=e?t.barLineRight:t.barLineLeft;let a;return r===Be.Automatic?a=Zi._automaticToActualType(i,e,s):a=r,a}addVoice(t){t.bar=this,t.index=this.voices.length,this.voices.push(t)}finish(t,e=null){this._filledVoices.clear(),this._filledVoices.add(0),this._isEmpty=!0,this._isRestOnly=!0,this.shortestDuration=b.DoubleWhole;for(let i=0,r=this.voices.length;i<r;i++){const a=this.voices[i];a.finish(t,e),a.isEmpty||(this._isEmpty=!1,this._filledVoices.add(i),a.shortestDuration>this.shortestDuration&&(this.shortestDuration=a.shortestDuration)),a.isRestOnly||(this._isRestOnly=!1)}const s=this.sustainPedals;if(s.length>0){let i=null;this.sustainPedals=[],this.previousBar&&this.previousBar.sustainPedals.length>0&&(i=this.previousBar.sustainPedals[this.previousBar.sustainPedals.length-1],i.pedalType===lt.Up&&(i=null));const r=i!==null&&i.pedalType!==lt.Up;for(const a of s){if(i&&i.pedalType!==lt.Up){if(i.bar===this&&a.ratioPosition<=i.ratioPosition)continue;i.nextPedalMarker=a,a.previousPedalMarker=i}r&&a.pedalType===lt.Down&&(a.pedalType=lt.Hold),a.bar=this,this.sustainPedals.push(a),i=a}}else if(this.previousBar&&this.previousBar.sustainPedals.length>0){const i=this.previousBar.sustainPedals[this.previousBar.sustainPedals.length-1];if(i.pedalType!==lt.Up){const r=new Vi;r.ratioPosition=0,r.bar=this,r.pedalType=lt.Hold,this.sustainPedals.push(r),i.nextPedalMarker=r,r.previousPedalMarker=i}}}calculateDuration(){let t=0;for(const e of this.voices){const s=e.calculateDuration();s>t&&(t=s)}return t}};o(Zi,"_globalBarId",0);let qs=Zi;var Me;(function(n){n[n.NoTripletFeel=0]="NoTripletFeel",n[n.Triplet16th=1]="Triplet16th",n[n.Triplet8th=2]="Triplet8th",n[n.Dotted16th=3]="Dotted16th",n[n.Dotted8th=4]="Dotted8th",n[n.Scottish16th=5]="Scottish16th",n[n.Scottish8th=6]="Scottish8th"})(Me||(Me={}));class dt{constructor(){o(this,"_singleGroupKey");o(this,"groups",new Map);o(this,"uniqueId","");o(this,"timeSignatureNumerator",0);o(this,"timeSignatureDenominator",0)}static createSimple(t,e,s,i){const r=new dt;return r.timeSignatureNumerator=t,r.timeSignatureDenominator=e,r.groups.set(s,i),r.finish(),r}findRule(t){const e=this._singleGroupKey;if(e)return[e,this.groups.get(e)];if(t<b.Quarter)return[t,[]];let s=t;do{const i=s;if(this.groups.has(i))return[i,this.groups.get(i)];s=s*2}while(s<=b.TwoHundredFiftySixth);s=t/2;do{const i=s;if(this.groups.has(i))return[i,this.groups.get(i)];s=s/2}while(s>b.Half);return[t,[]]}finish(){let t=`${this.timeSignatureNumerator}_${this.timeSignatureDenominator}`;for(const[e,s]of this.groups){t+=`__${e}`;let i=s.length;for(let r=s.length-1;r>=0&&s[r]===0;r--)i=r;i<s.length&&s.splice(i,s.length-i),t+=`_${s.join("_")}`,this.groups.size===1&&(this._singleGroupKey=e)}this.uniqueId=t}}class ii{constructor(){o(this,"alternateEndings",0);o(this,"nextMasterBar",null);o(this,"previousMasterBar",null);o(this,"index",0);o(this,"isDoubleBar",!1);o(this,"isRepeatStart",!1);o(this,"repeatCount",0);o(this,"repeatGroup");o(this,"timeSignatureNumerator",4);o(this,"timeSignatureDenominator",4);o(this,"timeSignatureCommon",!1);o(this,"beamingRules");o(this,"actualBeamingRules");o(this,"isFreeTime",!1);o(this,"tripletFeel",Me.NoTripletFeel);o(this,"section",null);o(this,"tempoAutomations",[]);o(this,"syncPoints");o(this,"score");o(this,"fermata",null);o(this,"start",0);o(this,"isAnacrusis",!1);o(this,"displayScale",1);o(this,"displayWidth",-1);o(this,"directions",null)}get hasChanges(){return this.index===0?!1:this.timeSignatureCommon!==this.previousMasterBar.timeSignatureCommon||this.timeSignatureNumerator!==this.previousMasterBar.timeSignatureNumerator||this.timeSignatureDenominator!==this.previousMasterBar.timeSignatureDenominator||this.tripletFeel!==this.previousMasterBar.tripletFeel?!0:this.alternateEndings!==0||this.isRepeatStart||this.isRepeatEnd||this.isFreeTime||this.isSectionStart||this.tempoAutomations.length>0||this.syncPoints&&this.syncPoints.length>0||this.fermata!==null&&this.fermata.size>0||this.directions!==null&&this.directions.size>0||this.isAnacrusis}get keySignature(){return this.score.tracks[0].staves[0].bars[this.index].keySignature}set keySignature(t){this.score.tracks[0].staves[0].bars[this.index].keySignature=t}get keySignatureType(){return this.score.tracks[0].staves[0].bars[this.index].keySignatureType}set keySignatureType(t){this.score.tracks[0].staves[0].bars[this.index].keySignatureType=t}get isRepeatEnd(){return this.repeatCount>0}get isSectionStart(){return!!this.section}get tempoAutomation(){return this.tempoAutomations.length>0?this.tempoAutomations[0]:null}calculateDuration(t=!0){if(this.isAnacrusis&&t){let e=0;for(const s of this.score.tracks)for(const i of s.staves){const r=this.index<i.bars.length?i.bars[this.index].calculateDuration():0;r>e&&(e=r)}return e}return this.timeSignatureNumerator*D.valueToTicks(this.timeSignatureDenominator)}addFermata(t,e){let s=this.fermata;s===null&&(s=new Map,this.fermata=s),s.set(t,e)}addDirection(t){this.directions==null&&(this.directions=new Set),this.directions.add(t)}getFermata(t){const e=this.fermata;return e===null?null:e.has(t.playbackStart)?e.get(t.playbackStart):t.index===0&&e.has(0)?e.get(0):null}addSyncPoint(t){this.syncPoints||(this.syncPoints=[]),this.syncPoints.push(t)}finish(t){let e=this.beamingRules;if(e&&(e.timeSignatureNumerator=this.timeSignatureNumerator,e.timeSignatureDenominator=this.timeSignatureDenominator,e.finish()),this.index>0){this.start=this.previousMasterBar.start+this.previousMasterBar.calculateDuration();const s=t.has("beamingRules")?t.get("beamingRules"):void 0;s&&s.uniqueId===(e==null?void 0:e.uniqueId)?(this.beamingRules=void 0,e=s):e||(e=s)}this.actualBeamingRules=e,this.beamingRules&&t.set("beamingRules",e)}}o(ii,"MaxAlternateEndings",8);var nr;(function(n){n[n.NoBrackets=0]="NoBrackets",n[n.GroupStaves=1]="GroupStaves",n[n.GroupSimilarInstruments=2]="GroupSimilarInstruments"})(nr||(nr={}));var Tt;(function(n){n[n.Hidden=0]="Hidden",n[n.FirstSystem=1]="FirstSystem",n[n.AllSystems=2]="AllSystems"})(Tt||(Tt={}));var ls;(function(n){n[n.FullName=0]="FullName",n[n.ShortName=1]="ShortName"})(ls||(ls={}));var hs;(function(n){n[n.Horizontal=0]="Horizontal",n[n.Vertical=1]="Vertical"})(hs||(hs={}));var Vt;(function(n){n[n.AllBars=0]="AllBars",n[n.FirstOfSystem=1]="FirstOfSystem",n[n.Hide=2]="Hide"})(Vt||(Vt={}));class pc{constructor(){o(this,"hideDynamics",!1);o(this,"bracketExtendMode",nr.GroupStaves);o(this,"useSystemSignSeparator",!1);o(this,"globalDisplayTuning",!0);o(this,"perTrackDisplayTuning",null);o(this,"globalDisplayChordDiagramsOnTop",!0);o(this,"perTrackChordDiagramsOnTop",null);o(this,"globalDisplayChordDiagramsInScore",!1);o(this,"singleTrackTrackNamePolicy",Tt.FirstSystem);o(this,"multiTrackTrackNamePolicy",Tt.FirstSystem);o(this,"firstSystemTrackNameMode",ls.ShortName);o(this,"otherSystemsTrackNameMode",ls.ShortName);o(this,"firstSystemTrackNameOrientation",hs.Vertical);o(this,"otherSystemsTrackNameOrientation",hs.Vertical);o(this,"multiTrackMultiBarRest",!1);o(this,"perTrackMultiBarRest",null);o(this,"extendBarLines",!1);o(this,"hideEmptyStaves",!1);o(this,"hideEmptyStavesInFirstSystem",!1);o(this,"showSingleStaffBrackets",!1);o(this,"barNumberDisplay",Vt.AllBars)}}class Ho{constructor(){o(this,"masterBars",[]);o(this,"opening",null);o(this,"closings",[]);o(this,"isClosed",!1)}get openings(){const t=this.opening;return t?[t]:[]}get isOpened(){var t;return((t=this.opening)==null?void 0:t.isRepeatStart)===!0}addMasterBar(t){this.opening===null&&(this.opening=t),this.masterBars.push(t),t.repeatGroup=this,t.isRepeatEnd&&(this.closings.push(t),this.isClosed=!0)}}class fn{constructor(){o(this,"beats",[]);o(this,"id","empty");o(this,"isComplete",!1)}addBeat(t){t.graceIndex=this.beats.length,t.graceGroup=this,this.beats.push(t)}finish(){this.beats.length>0&&(this.id=`${this.beats[0].absoluteDisplayStart}_${this.beats[0].voice.index}`)}}var Zr;(function(n){n[n.Glyphs=0]="Glyphs"})(Zr||(Zr={}));class gc extends Mr{}var ar;let Fs=(ar=class{constructor(){o(this,"_beatLookup");o(this,"_isEmpty",!0);o(this,"_isRestOnly",!0);o(this,"id",ar._globalVoiceId++);o(this,"index",0);o(this,"bar");o(this,"beats",[]);o(this,"style");o(this,"shortestDuration",b.DoubleWhole)}static resetIds(){ar._globalVoiceId=0}get isEmpty(){return this._isEmpty}forceNonEmpty(){this._isEmpty=!1}get isRestOnly(){return this._isRestOnly}insertBeat(t,e){e.nextBeat=t.nextBeat,e.nextBeat&&(e.nextBeat.previousBeat=e),e.previousBeat=t,e.voice=this,t.nextBeat=e,this.beats.splice(t.index+1,0,e)}addBeat(t){t.voice=this,t.index=this.beats.length,this.beats.push(t),t.isEmpty||(this._isEmpty=!1),t.isRest||(this._isRestOnly=!1)}_chain(t,e=null){if(this.bar){if(t.index<this.beats.length-1)t.nextBeat=this.beats[t.index+1],t.nextBeat.previousBeat=t;else if(t.isLastOfVoice&&t.voice.bar.nextBar){const s=this.bar.nextBar.voices[this.index];s.beats.length>0&&(t.nextBeat=s.beats[0]),t.nextBeat.previousBeat=t}t.chain(e)}}addGraceBeat(t){if(this.beats.length===0){this.addBeat(t);return}const e=this.beats[this.beats.length-1];this.beats.splice(this.beats.length-1,1),this.addBeat(t),this.addBeat(e),this._isEmpty=!1,this._isRestOnly=!1}getBeatAtPlaybackStart(t){return this._beatLookup.has(t)?this._beatLookup.get(t):null}finish(t,e=null){this._isEmpty=!0,this._isRestOnly=!0,this._beatLookup=new Map;let s=null;for(let a=0;a<this.beats.length;a++){const l=this.beats[a];l.index=a,this._chain(l,e),l.graceType===ee.None?(l.graceGroup=s,s&&(s.isComplete=!0),s=null):(s||(s=new fn),s.addBeat(l)),l.isEmpty||(this._isEmpty=!1),l.isRest||(this._isRestOnly=!1)}let i=0,r=0;this.shortestDuration=b.DoubleWhole;for(let a=0;a<this.beats.length;a++){const l=this.beats[a];if(l.index=a,l.finish(t,e),l.graceType===ee.None){if(l.duration>this.shortestDuration&&(this.shortestDuration=l.duration),l.graceGroup){const h=l.graceGroup.beats[0],c=l.graceGroup.beats[l.graceGroup.beats.length-1];if(h.graceType!==ee.BendGrace){const d=c.playbackStart+c.playbackDuration-h.playbackStart;switch(h.graceType){case ee.BeforeBeat:h.previousBeat?(h.previousBeat.playbackDuration-=d,h.previousBeat.voice===this?r=h.previousBeat.playbackStart+h.previousBeat.playbackDuration:r=-d):r=-d;for(const u of l.graceGroup.beats)this._beatLookup.delete(u.playbackStart),u.playbackStart=r,this._beatLookup.set(u.playbackStart,l),r+=u.playbackDuration;break;case ee.OnBeat:l.playbackDuration-=d,c.voice===this?r=c.playbackStart+c.playbackDuration:r=-d;break}}}l.displayStart=i,l.playbackStart=r,this._beatLookup.set(l.playbackStart,l)}else l.displayStart=i,l.playbackStart=r;l.fermata?this.bar.masterBar.addFermata(l.playbackStart,l.fermata):l.fermata=this.bar.masterBar.getFermata(l),l.finishTuplet(),l.graceGroup&&l.graceGroup.finish(),i+=l.displayDuration,r+=l.playbackDuration}}calculateDuration(){if(this.isEmpty||this.beats.length===0)return 0;const t=this.beats[this.beats.length-1],e=this.beats[0];return t.playbackStart+t.playbackDuration-e.playbackStart}},o(ar,"_globalVoiceId",0),ar);var X;(function(n){n[n.Left=0]="Left",n[n.Center=1]="Center",n[n.Right=2]="Right"})(X||(X={}));var Ue;(function(n){n[n.Top=0]="Top",n[n.Middle=1]="Middle",n[n.Bottom=2]="Bottom",n[n.Alphabetic=3]="Alphabetic"})(Ue||(Ue={}));class en{constructor(t,e){o(this,"width");o(this,"height");this.width=t,this.height=e}}class kt{static fillMusicFontSymbolSafe(t,e,s,i,r,a){t.settings.display.resources.engravingSettings.hasSymbol(r)&&t.fillMusicFontSymbol(e,s,i,r,a)}static fillMusicFontSymbolsSafe(t,e,s,i,r,a){const l=r.filter(h=>t.settings.display.resources.engravingSettings.hasSymbol(h));l.length!==0&&t.fillMusicFontSymbols(e,s,i,l,a)}}var V;(function(n){n[n.Title=0]="Title",n[n.SubTitle=1]="SubTitle",n[n.Artist=2]="Artist",n[n.Album=3]="Album",n[n.Words=4]="Words",n[n.Music=5]="Music",n[n.WordsAndMusic=6]="WordsAndMusic",n[n.Transcriber=7]="Transcriber",n[n.Copyright=8]="Copyright",n[n.CopyrightSecondLine=9]="CopyrightSecondLine",n[n.ChordDiagramList=10]="ChordDiagramList"})(V||(V={}));const oo=class oo{constructor(t="",e=void 0,s=X.Left){o(this,"template");o(this,"isVisible");o(this,"textAlign");this.template=t,this.isVisible=e,this.textAlign=s}static equals(t,e){const s=t.isVisible!==void 0?t.isVisible:!0,i=e.isVisible!==void 0?e.isVisible:!0;return!(s!==i||t.template!==e.template||t.textAlign!==e.textAlign)}buildText(t){let e=!1,s=!1;const i=this.template.replace(oo._placeholderPattern,(r,a)=>{s=!0;let l="";switch(a){case"TITLE":l=t.title;break;case"SUBTITLE":l=t.subTitle;break;case"ARTIST":l=t.artist;break;case"ALBUM":l=t.album;break;case"WORDS":case"WORDSMUSIC":l=t.words;break;case"MUSIC":l=t.music;break;case"TABBER":l=t.tab;break;case"COPYRIGHT":l=t.copyright;break;default:l="";break}return l&&(e=!0),l});return s&&!e?"":i}};o(oo,"_placeholderPattern",/%([^%]+)%/g);let Bs=oo;class Ui extends Mr{constructor(){super(...arguments);o(this,"headerAndFooter",new Map)}}o(Ui,"defaultHeaderAndFooter",new Map([[V.Title,new Bs("%TITLE%",void 0,X.Center)],[V.SubTitle,new Bs("%SUBTITLE%",void 0,X.Center)],[V.Artist,new Bs("%ARTIST%",void 0,X.Center)],[V.Album,new Bs("%ALBUM%",void 0,X.Center)],[V.Words,new Bs("Words by %WORDS%",void 0,X.Left)],[V.Music,new Bs("Music by %MUSIC%",void 0,X.Right)],[V.WordsAndMusic,new Bs("Words & Music by %MUSIC%",void 0,X.Right)],[V.Transcriber,new Bs("Tabbed by %TABBER%",!1,X.Right)],[V.Copyright,new Bs("%COPYRIGHT%",void 0,X.Center)],[V.CopyrightSecondLine,new Bs("All Rights Reserved - International Copyright Secured",!0,X.Center)]]));class gi{constructor(){o(this,"_currentRepeatGroup",null);o(this,"_openedRepeatGroups",[]);o(this,"_properlyOpenedRepeatGroups",0);o(this,"album","");o(this,"artist","");o(this,"copyright","");o(this,"instructions","");o(this,"music","");o(this,"notices","");o(this,"subTitle","");o(this,"title","");o(this,"words","");o(this,"tab","");o(this,"masterBars",[]);o(this,"tracks",[]);o(this,"defaultSystemsLayout",3);o(this,"systemsLayout",[]);o(this,"stylesheet",new pc);o(this,"backingTrack");o(this,"style")}static resetIds(){qs.resetIds(),qt.resetIds(),Fs.resetIds(),Ps.resetIds()}get tempo(){return this.masterBars.length&&this.masterBars[0].tempoAutomations.length>0?this.masterBars[0].tempoAutomations[0].value:120}get tempoLabel(){return this.masterBars.length&&this.masterBars[0].tempoAutomations.length>0?this.masterBars[0].tempoAutomations[0].text:""}rebuildRepeatGroups(){this._currentRepeatGroup=null,this._openedRepeatGroups=[],this._properlyOpenedRepeatGroups=0;for(const t of this.masterBars)this._addMasterBarToRepeatGroups(t)}addMasterBar(t){t.score=this,t.index=this.masterBars.length,this.masterBars.length!==0&&(t.previousMasterBar=this.masterBars[this.masterBars.length-1],t.previousMasterBar.nextMasterBar=t,t.start=t.previousMasterBar.start+(t.previousMasterBar.isAnacrusis?0:t.previousMasterBar.calculateDuration())),this._addMasterBarToRepeatGroups(t),this.masterBars.push(t)}_addMasterBarToRepeatGroups(t){var e;t.isRepeatStart?((e=this._currentRepeatGroup)!=null&&e.isClosed&&(this._openedRepeatGroups.pop(),this._properlyOpenedRepeatGroups--),this._currentRepeatGroup=new Ho,this._openedRepeatGroups.push(this._currentRepeatGroup),this._properlyOpenedRepeatGroups++):this._currentRepeatGroup||(this._currentRepeatGroup=new Ho,this._openedRepeatGroups.push(this._currentRepeatGroup)),this._currentRepeatGroup.addMasterBar(t),t.isRepeatEnd&&this._properlyOpenedRepeatGroups>1&&(this._openedRepeatGroups.pop(),this._properlyOpenedRepeatGroups--,this._currentRepeatGroup=this._openedRepeatGroups.length>0?this._openedRepeatGroups[this._openedRepeatGroups.length-1]:null)}addTrack(t){t.score=this,t.index=this.tracks.length,this.tracks.push(t)}finish(t){const e=new Map;for(let s=0,i=this.tracks.length;s<i;s++)this.tracks[s].finish(t,e);for(const s of this.masterBars)s.finish(e)}applyFlatSyncPoints(t){for(const e of this.masterBars)e.syncPoints=void 0;for(const e of t){const s=new nt;s.ratioPosition=Math.min(1,Math.max(0,e.barPosition)),s.type=Ve.SyncPoint,s.syncPointValue=new ja,s.syncPointValue.millisecondOffset=e.millisecondOffset,s.syncPointValue.barOccurence=e.barOccurence,e.barIndex<this.masterBars.length&&this.masterBars[e.barIndex].addSyncPoint(s)}for(const e of this.masterBars)e.syncPoints&&e.syncPoints.sort((s,i)=>{const r=s.syncPointValue.barOccurence-i.syncPointValue.barOccurence;return r!==0?r:s.ratioPosition-i.ratioPosition})}exportFlatSyncPoints(){const t=[];for(const e of this.masterBars){const s=e.syncPoints;if(s)for(const i of s)t.push({barIndex:e.index,barOccurence:i.syncPointValue.barOccurence,barPosition:i.ratioPosition,millisecondOffset:i.syncPointValue.millisecondOffset})}return t}}const es=class es{};o(es,"DefaultChannelCount",17),o(es,"MetronomeChannel",es.DefaultChannelCount-1),o(es,"MetronomeKey",33),o(es,"AudioChannels",2),o(es,"MinVolume",0),o(es,"MinProgram",0),o(es,"MaxProgram",127),o(es,"MinPlaybackSpeed",.125),o(es,"MaxPlaybackSpeed",8),o(es,"PercussionChannel",9),o(es,"PercussionBank",128),o(es,"MaxPitchWheel",16384),o(es,"MaxPitchWheel20",4294967296),o(es,"DefaultPitchWheel",es.MaxPitchWheel/2),o(es,"MicroBufferCount",32),o(es,"MicroBufferSize",64);let ye=es;class ed{constructor(){o(this,"note",null);o(this,"tone",new mc);o(this,"octave",0)}get realValue(){return this.octave*12+this.tone.noteValue}}class mc{constructor(t=0,e=de.Default){o(this,"noteValue");o(this,"accidentalMode");this.noteValue=t,this.accidentalMode=e}}const Le=class Le{static _buildDurationIndices(){return new Map(Object.values(b).filter(t=>typeof t=="number").map(t=>[t,t<0?0:Math.log2(t)|0]))}static getIndex(t){return Le._durationIndices.get(t)}static keySignatureIsFlat(t){return t<0}static keySignatureIsNatural(t){return t===0}static keySignatureIsSharp(t){return t>0}static applyPitchOffsets(t,e){for(let s=0;s<e.tracks.length;s++){if(s<t.notation.displayTranspositionPitches.length)for(const i of e.tracks[s].staves)i.displayTranspositionPitch=-t.notation.displayTranspositionPitches[s];if(s<t.notation.transpositionPitches.length)for(const i of e.tracks[s].staves)i.transpositionPitch=-t.notation.transpositionPitches[s]}}static isTuning(t){return!!Le.parseTuning(t)}static parseTuning(t){let e="",s="";for(let a=0;a<t.length;a++){const l=t.charCodeAt(a);if(l>=48&&l<=57){if(!e)return null;s+=String.fromCharCode(l)}else if(e.length===0)if(Le.tuningLetters.has(l))e+=String.fromCharCode(l);else return null;else e+=String.fromCharCode(l)}if(!s||!e)return null;const i=new ed;i.octave=Number.parseInt(s,10)+1,i.note=e.toLowerCase();const r=Le.getToneForText(i.note);return r===null?null:(i.tone=r,i.tone.noteValue<0&&(i.octave--,i.tone.noteValue+=12),i)}static getTuningForText(t){const e=Le.parseTuning(t);return e?e.realValue:-1}static getToneForText(t){const e=t.substring(0,1),s=t.substring(1);let i,r;switch(e.toLowerCase()){case"c":i=0;break;case"d":i=2;break;case"e":i=4;break;case"f":i=5;break;case"g":i=7;break;case"a":i=9;break;case"b":i=11;break;default:return null}if(!Le.accidentalModeMapping.has(s))return null;switch(r=Le.parseAccidentalMode(s),r){case de.Default:break;case de.ForceNone:break;case de.ForceNatural:break;case de.ForceSharp:i++;break;case de.ForceDoubleSharp:i+=2;break;case de.ForceFlat:i--;break;case de.ForceDoubleFlat:i-=2;break}return new mc(i,r)}static parseAccidentalMode(t){const e=t.toLowerCase();return Le.accidentalModeMapping.has(e)?Le.accidentalModeMapping.get(e):de.Default}static newGuid(){return`${Math.floor((1+Math.random())*65536).toString(16).substring(1)+Math.floor((1+Math.random())*65536).toString(16).substring(1)}-${Math.floor((1+Math.random())*65536).toString(16).substring(1)}-${Math.floor((1+Math.random())*65536).toString(16).substring(1)}-${Math.floor((1+Math.random())*65536).toString(16).substring(1)}-${Math.floor((1+Math.random())*65536).toString(16).substring(1)}${Math.floor((1+Math.random())*65536).toString(16).substring(1)}${Math.floor((1+Math.random())*65536).toString(16).substring(1)}`}static isAlmostEqualTo(t,e){return Math.abs(t-e)<1e-5}static toHexString(t,e=0){let s="";const i="0123456789ABCDEF";do s=String.fromCharCode(i.charCodeAt(t&15))+s,t=t>>4;while(t>0);for(;s.length<e;)s=`0${s}`;return s}static getAlternateEndingsList(t){const e=[];for(let s=0;s<ii.MaxAlternateEndings;s++)t&1<<s&&e.push(s);return e}static deltaFretToHarmonicValue(t){switch(t){case 2:return 2.4;case 3:return 3.2;case 4:case 5:case 7:case 9:case 12:case 16:case 17:case 19:case 24:return t;case 8:return 8.2;case 10:return 9.6;case 14:case 15:return 14.7;case 21:case 22:return 21.7;default:return 12}}static clamp(t,e,s){return t<=e?e:t>=s?s:t}static buildMultiBarRestInfo(t,e,s){var d;if(!t)return null;const i=t[0].score.stylesheet;if(!(t.length>1?i.multiTrackMultiBarRest:((d=i.perTrackMultiBarRest)==null?void 0:d.has(t[0].index))===!0))return null;const a=new Map,l=t[0].score;let h=e,c=l.tempo;for(;h<=s;){const u=h;let p=null;for(;h<=s;){const g=l.masterBars[h];let m=!1;for(const S of g.tempoAutomations)S.value!==c&&(m=!0),c=S.value;if(g.alternateEndings||g.isRepeatStart&&g.index!==u||g.isFreeTime||g.isAnacrusis||g.section!==null||g.index!==u&&m||g.fermata!==null&&g.fermata.size>0||g.directions!==null&&g.directions.size>0||u>e&&g.previousMasterBar&&(g.timeSignatureCommon!==g.previousMasterBar.timeSignatureCommon||g.timeSignatureNumerator!==g.previousMasterBar.timeSignatureNumerator||g.timeSignatureDenominator!==g.previousMasterBar.timeSignatureDenominator||g.tripletFeel!==g.previousMasterBar.tripletFeel))break;let y=!0;for(const S of t){for(const k of S.staves){const T=k.bars[g.index];if(!T.isRestOnly){y=!1;break}if(T.index>0&&(T.keySignature!==T.previousBar.keySignature||T.keySignatureType!==T.previousBar.keySignatureType)){y=!1;break}}if(!y)break}if(!y||(h++,g.index>u&&(p===null?p=[g.index]:p.push(g.index)),g.isRepeatEnd))break}p?a.set(u,p):h++}return a}static computeFirstDisplayedBarIndex(t,e){let s=e.display.startBar;return s--,s=Math.min(t.masterBars.length-1,Math.max(0,s)),s}static computeLastDisplayedBarIndex(t,e,s){let i=e.display.barCount;return i<0&&(i=t.masterBars.length),i=s+i-1,i=Math.min(t.masterBars.length-1,Math.max(0,i)),i}static getOrCreateHeaderFooterStyle(t,e){let s=t.style;t.style||(s=new Ui,t.style=s);let i;if(s.headerAndFooter.has(e))i=s.headerAndFooter.get(e);else{if(i=new Bs,Ui.defaultHeaderAndFooter.has(e)){const r=Ui.defaultHeaderAndFooter.get(e);i.template=r.template,i.textAlign=r.textAlign}s.headerAndFooter.set(e,i)}return i}static consolidate(t){if(t.masterBars.length===0){const s=new ii;t.addMasterBar(s);const i=new nt;i.isLinear=!1,i.type=Ve.Tempo,i.value=t.tempo,s.tempoAutomations.push(i);const r=new qs;t.tracks[0].staves[0].addBar(r);const a=new Fs;r.addVoice(a);const l=new qt;l.isEmpty=!0,a.addBeat(l);return}const e=new Set([ye.PercussionChannel]);for(const s of t.tracks){if(s.staves.length===1&&s.staves[0].isPercussion)s.playbackInfo.primaryChannel=ye.PercussionChannel,s.playbackInfo.secondaryChannel=ye.PercussionChannel;else{if(s.playbackInfo.primaryChannel!==ye.PercussionChannel)for(;e.has(s.playbackInfo.primaryChannel);)s.playbackInfo.primaryChannel++;if(e.add(s.playbackInfo.primaryChannel),s.playbackInfo.secondaryChannel!==ye.PercussionChannel)for(;e.has(s.playbackInfo.secondaryChannel);)s.playbackInfo.secondaryChannel++;e.add(s.playbackInfo.secondaryChannel)}for(const i of s.staves){for(const a of i.bars)for(const l of a.voices)if(l.isEmpty&&l.beats.length===0){const h=new qt;h.isEmpty=!0,l.addBeat(h)}const r=i.bars.length===0?1:i.bars[0].voices.length;for(;i.bars.length<t.masterBars.length;){const a=new qs;i.addBar(a);const l=a.previousBar;l&&(a.clef=l.clef,a.clefOttava=l.clefOttava,a.keySignature=a.previousBar.keySignature,a.keySignatureType=a.previousBar.keySignatureType);for(let h=0;h<r;h++){const c=new Fs;a.addVoice(c);const d=new qt;d.isEmpty=!0,c.addBeat(d)}}}}if(t.masterBars.length>0&&!t.masterBars[0].tempoAutomations.find(i=>i.type===Ve.Tempo&&i.ratioPosition===0)){const i=new nt;i.isLinear=!1,i.type=Ve.Tempo,i.value=t.tempo,i.text=t.tempoLabel,i.isVisible=!1,t.masterBars[0].tempoAutomations.push(i)}}static trimEmptyBarsAtEnd(t){for(;t.masterBars.length>1;){const e=t.masterBars.length-1,s=t.masterBars[e];if(s.hasChanges)return;for(const i of t.tracks)for(const r of i.staves)if(e<r.bars.length){const a=r.bars[e];if(!a.isEmpty||a.hasChanges)return}for(const i of t.tracks)for(const r of i.staves)if(e<r.bars.length){const a=r.bars[e];r.bars.pop(),a.previousBar.nextBar=null}t.masterBars.pop(),s.previousMasterBar.nextMasterBar=null}}static flooredDivision(t,e){return t-e*Math.floor(t/e)}static _translateKeyTransposeTable(t){const e=[];for(const s of t){const i=[];e.push(i);for(const r of s){const a=Number.parseInt(r.charAt(0),10)*(r.charAt(1)==="b"?-1:1);i.push(a)}}return e}static transposeKey(t,e){if(e===0)return t;if(e<0){const i=Le._keyTransposeTable[-e].indexOf(t);return i===-1?t:i-7}else return Le._keyTransposeTable[e][t+7]}static toArticulationId(t){return t.replace(/[^a-zA-Z0-9]/g,"").toLowerCase()}static minBoundingBox(t,e){return Number.isNaN(t)?e:Number.isNaN(e)||t<e?t:e}static maxBoundingBox(t,e){return Number.isNaN(t)?e:Number.isNaN(e)||t>e?t:e}static getSystemLayout(t,e,s){let i,r;return s.length===1?(i=s[0].defaultSystemsLayout,r=s[0].systemsLayout):(i=t.defaultSystemsLayout,r=t.systemsLayout),e<r.length?r[e]:i}static _buildKeySignatureAccidentalByDegree(){const t=[];for(let e=-7;e<=7;e++){const s=[0,0,0,0,0,0,0];if(e>0)for(let i=0;i<e;i++)s[Le._sharpKeySignatureOrder[i]]=1;else if(e<0)for(let i=0;i<-e;i++)s[Le._flatKeySignatureOrder[i]]=-1;t.push(s)}return t}static getKeySignatureAccidentalOffset(t,e){return Le._keySignatureAccidentalByDegree[t+7][e]}static resolveSpelling(t,e,s){const i=Le.flooredDivision(e,12),r=Le._getPreferredSpellingForKeySignature(t,i),a=Le._forcedAccidentalOffsetByMode.has(s)?Le._forcedAccidentalOffsetByMode.get(s):Number.NaN;let l=r;if(!Number.isNaN(a)){const u=Le._spellingCandidates[i].find(p=>p.accidentalOffset===a);u&&(l=u)}const h=Le._degreeSemitones[l.degree]+l.accidentalOffset,c=Math.floor((e-h)/12)-1;return{degree:l.degree,accidentalOffset:l.accidentalOffset,chroma:i,octave:c}}static computeAccidental(t,e,s,i,r=null){const a=Le.resolveSpelling(t,s,e);return Le.computeAccidentalForSpelling(t,e,a,i,r)}static computeAccidentalForSpelling(t,e,s,i,r=null){if(e===de.ForceNone)return he.None;if(i)return s.accidentalOffset>0?he.SharpQuarterNoteUp:s.accidentalOffset<0?he.FlatQuarterNoteUp:he.NaturalQuarterNoteUp;const a=s.accidentalOffset,l=Le.getKeySignatureAccidentalOffset(t,s.degree);return r===a||r==null&&a===l?he.None:Le.accidentalOffsetToType(a)}static accidentalOffsetToType(t){return Le._accidentalOffsetToType.has(t)?Le._accidentalOffsetToType.get(t):he.None}static _getPreferredSpellingForKeySignature(t,e){const i=Le._spellingCandidates[e].find(a=>Le.getKeySignatureAccidentalOffset(t,a.degree)===a.accidentalOffset);return i||(Le.keySignatureIsFlat(t)?Le._flatPreferredSpellings[e]:Le._sharpPreferredSpellings[e])}static getKeySignatureTonicDegree(t,e){const s=t+7;return e===cs.Minor?Le._minorKeySignatureTonicDegrees[s]:Le._majorKeySignatureTonicDegrees[s]}};o(Le,"_durationIndices",Le._buildDurationIndices()),o(Le,"tuningLetters",new Set([67,68,69,70,71,65,66,99,100,101,102,103,97,98,35])),o(Le,"reverseAccidentalModeMapping",new Map([[de.Default,"d"],[de.ForceNone,"forcenone"],[de.ForceNatural,"forcenatural"],[de.ForceSharp,"#"],[de.ForceDoubleSharp,"x"],[de.ForceFlat,"b"],[de.ForceDoubleFlat,"bb"]])),o(Le,"accidentalModeMapping",new Map([["default",de.Default],["d",de.Default],["",de.Default],["forcenone",de.ForceNone],["-",de.ForceNone],["forcenatural",de.ForceNatural],["n",de.ForceNatural],["forcesharp",de.ForceSharp],["#",de.ForceSharp],["forcedoublesharp",de.ForceDoubleSharp],["##",de.ForceDoubleSharp],["x",de.ForceDoubleSharp],["forceflat",de.ForceFlat],["b",de.ForceFlat],["forcedoubleflat",de.ForceDoubleFlat],["bb",de.ForceDoubleFlat]])),o(Le,"displayTranspositionPitches",new Map([[24,-12],[25,-12],[26,-12],[27,-12],[28,-12],[29,-12],[30,-12],[31,-12],[32,-12],[33,-12],[34,-12],[35,-12],[36,-12],[37,-12],[38,-12],[39,-12],[43,-12]])),o(Le,"_keyTransposeTable",Le._translateKeyTransposeTable([["7b","6b","5b","4b","3b","2b","1b","0#","1#","2#","3#","4#","5#","6#","7#"],["2b","1b","0#","1#","2#","3#","4#","5#","6#","7#","4b","3b","2b","1b","0#"],["3#","4#","7b","6b","5b","4b","3b","2b","1b","0#","1#","2#","3#","4#","5#"],["4b","3b","2b","1b","0#","1#","2#","3#","4#","5#","6#","7#","4b","3b","2b"],["1#","2#","3#","4#","7b","6b","5b","4b","3b","2b","1b","0#","1#","2#","3#"],["6b","5b","4b","3b","2b","1b","0#","1#","2#","3#","4#","5#","6#","7#","4b"],["1b","0#","1#","2#","3#","4#","7b","6#","7#","4b","3b","2b","1b","0#","1#"],["4#","7b","6b","5b","4b","3b","2b","1b","0#","1#","2#","3#","4#","5#","6#"],["3b","2b","1b","0#","1#","2#","3#","4#","5#","6#","7#","4b","3b","2b","1b"],["2#","3#","4#","7b","6b","5b","4b","3b","2b","1b","0#","1#","2#","3#","4#"],["5b","4b","3b","2b","1b","0#","1#","2#","3#","4#","5#","6#","7#","4b","3b"],["0#","1#","2#","3#","4#","7b","6b","6#","4b","3b","2b","1b","0#","1#","2#"]])),o(Le,"_degreeSemitones",[0,2,4,5,7,9,11]),o(Le,"_sharpPreferredSpellings",[{degree:0,accidentalOffset:0},{degree:0,accidentalOffset:1},{degree:1,accidentalOffset:0},{degree:1,accidentalOffset:1},{degree:2,accidentalOffset:0},{degree:3,accidentalOffset:0},{degree:3,accidentalOffset:1},{degree:4,accidentalOffset:0},{degree:4,accidentalOffset:1},{degree:5,accidentalOffset:0},{degree:5,accidentalOffset:1},{degree:6,accidentalOffset:0}]),o(Le,"_flatPreferredSpellings",[{degree:0,accidentalOffset:0},{degree:1,accidentalOffset:-1},{degree:1,accidentalOffset:0},{degree:2,accidentalOffset:-1},{degree:2,accidentalOffset:0},{degree:3,accidentalOffset:0},{degree:4,accidentalOffset:-1},{degree:4,accidentalOffset:0},{degree:5,accidentalOffset:-1},{degree:5,accidentalOffset:0},{degree:6,accidentalOffset:-1},{degree:6,accidentalOffset:0}]),o(Le,"_spellingCandidates",[[{degree:0,accidentalOffset:0},{degree:1,accidentalOffset:-2},{degree:6,accidentalOffset:1}],[{degree:0,accidentalOffset:1},{degree:1,accidentalOffset:-1},{degree:6,accidentalOffset:2}],[{degree:1,accidentalOffset:0},{degree:0,accidentalOffset:2},{degree:2,accidentalOffset:-2}],[{degree:1,accidentalOffset:1},{degree:2,accidentalOffset:-1},{degree:3,accidentalOffset:-2}],[{degree:2,accidentalOffset:0},{degree:1,accidentalOffset:2},{degree:3,accidentalOffset:-1}],[{degree:3,accidentalOffset:0},{degree:2,accidentalOffset:1},{degree:4,accidentalOffset:-2}],[{degree:3,accidentalOffset:1},{degree:4,accidentalOffset:-1},{degree:2,accidentalOffset:2}],[{degree:4,accidentalOffset:0},{degree:3,accidentalOffset:2},{degree:5,accidentalOffset:-2}],[{degree:4,accidentalOffset:1},{degree:5,accidentalOffset:-1}],[{degree:5,accidentalOffset:0},{degree:4,accidentalOffset:2},{degree:6,accidentalOffset:-2}],[{degree:5,accidentalOffset:1},{degree:6,accidentalOffset:-1},{degree:0,accidentalOffset:-2}],[{degree:6,accidentalOffset:0},{degree:5,accidentalOffset:2},{degree:0,accidentalOffset:-1}]]),o(Le,"_sharpKeySignatureOrder",[3,0,4,1,5,2,6]),o(Le,"_flatKeySignatureOrder",[6,2,5,1,4,0,3]),o(Le,"_keySignatureAccidentalByDegree",Le._buildKeySignatureAccidentalByDegree()),o(Le,"_accidentalOffsetToType",new Map([[-2,he.DoubleFlat],[-1,he.Flat],[0,he.Natural],[1,he.Sharp],[2,he.DoubleSharp]])),o(Le,"_forcedAccidentalOffsetByMode",new Map([[de.ForceSharp,1],[de.ForceDoubleSharp,2],[de.ForceFlat,-1],[de.ForceDoubleFlat,-2],[de.ForceNatural,0],[de.ForceNone,0],[de.Default,Number.NaN]])),o(Le,"_majorKeySignatureTonicDegrees",[0,4,1,5,2,6,3,0,4,1,5,2,6,3,0]),o(Le,"_minorKeySignatureTonicDegrees",[5,2,6,3,0,4,1,5,2,6,3,0,4,1,5]);let A=Le;var Ot;(function(n){n[n.None=0]="None",n[n.Up=1]="Up",n[n.Down=2]="Down"})(Ot||(Ot={}));var f;(function(n){n[n.None=-1]="None",n[n.Space=32]="Space",n[n.Brace=57344]="Brace",n[n.BracketTop=57347]="BracketTop",n[n.BracketBottom=57348]="BracketBottom",n[n.SystemDivider=57351]="SystemDivider",n[n.GClef=57424]="GClef",n[n.GClef15mb=57425]="GClef15mb",n[n.GClef8vb=57426]="GClef8vb",n[n.GClef8va=57427]="GClef8va",n[n.GClef15ma=57428]="GClef15ma",n[n.CClef=57436]="CClef",n[n.CClef8vb=57437]="CClef8vb",n[n.FClef=57442]="FClef",n[n.FClef15mb=57443]="FClef15mb",n[n.FClef8vb=57444]="FClef8vb",n[n.FClef8va=57445]="FClef8va",n[n.FClef15ma=57446]="FClef15ma",n[n.UnpitchedPercussionClef1=57449]="UnpitchedPercussionClef1",n[n.SixStringTabClef=57453]="SixStringTabClef",n[n.FourStringTabClef=57454]="FourStringTabClef",n[n.Clef8=57469]="Clef8",n[n.Clef15=57470]="Clef15",n[n.TimeSig0=57472]="TimeSig0",n[n.TimeSig1=57473]="TimeSig1",n[n.TimeSig2=57474]="TimeSig2",n[n.TimeSig3=57475]="TimeSig3",n[n.TimeSig4=57476]="TimeSig4",n[n.TimeSig5=57477]="TimeSig5",n[n.TimeSig6=57478]="TimeSig6",n[n.TimeSig7=57479]="TimeSig7",n[n.TimeSig8=57480]="TimeSig8",n[n.TimeSig9=57481]="TimeSig9",n[n.TimeSigCommon=57482]="TimeSigCommon",n[n.TimeSigCutCommon=57483]="TimeSigCutCommon",n[n.NoteheadDoubleWholeSquare=57505]="NoteheadDoubleWholeSquare",n[n.NoteheadDoubleWhole=57504]="NoteheadDoubleWhole",n[n.NoteheadWhole=57506]="NoteheadWhole",n[n.NoteheadHalf=57507]="NoteheadHalf",n[n.NoteheadBlack=57508]="NoteheadBlack",n[n.NoteheadNull=57509]="NoteheadNull",n[n.NoteheadXOrnate=57514]="NoteheadXOrnate",n[n.NoteheadPlusDoubleWhole=57516]="NoteheadPlusDoubleWhole",n[n.NoteheadPlusWhole=57517]="NoteheadPlusWhole",n[n.NoteheadPlusHalf=57518]="NoteheadPlusHalf",n[n.NoteheadPlusBlack=57519]="NoteheadPlusBlack",n[n.NoteheadSquareWhite=57528]="NoteheadSquareWhite",n[n.NoteheadSquareBlack=57529]="NoteheadSquareBlack",n[n.NoteheadTriangleUpDoubleWhole=57530]="NoteheadTriangleUpDoubleWhole",n[n.NoteheadTriangleUpWhole=57531]="NoteheadTriangleUpWhole",n[n.NoteheadTriangleUpHalf=57532]="NoteheadTriangleUpHalf",n[n.NoteheadTriangleUpBlack=57534]="NoteheadTriangleUpBlack",n[n.NoteheadTriangleRightWhite=57537]="NoteheadTriangleRightWhite",n[n.NoteheadTriangleRightBlack=57538]="NoteheadTriangleRightBlack",n[n.NoteheadTriangleDownDoubleWhole=57548]="NoteheadTriangleDownDoubleWhole",n[n.NoteheadTriangleDownWhole=57540]="NoteheadTriangleDownWhole",n[n.NoteheadTriangleDownHalf=57541]="NoteheadTriangleDownHalf",n[n.NoteheadTriangleDownBlack=57543]="NoteheadTriangleDownBlack",n[n.NoteheadDiamondDoubleWhole=57559]="NoteheadDiamondDoubleWhole",n[n.NoteheadDiamondWhole=57560]="NoteheadDiamondWhole",n[n.NoteheadDiamondHalf=57561]="NoteheadDiamondHalf",n[n.NoteheadDiamondBlack=57563]="NoteheadDiamondBlack",n[n.NoteheadDiamondBlackWide=57564]="NoteheadDiamondBlackWide",n[n.NoteheadDiamondWhite=57565]="NoteheadDiamondWhite",n[n.NoteheadDiamondWhiteWide=57566]="NoteheadDiamondWhiteWide",n[n.NoteheadCircleXDoubleWhole=57520]="NoteheadCircleXDoubleWhole",n[n.NoteheadCircleXWhole=57521]="NoteheadCircleXWhole",n[n.NoteheadCircleXHalf=57522]="NoteheadCircleXHalf",n[n.NoteheadCircleX=57523]="NoteheadCircleX",n[n.NoteheadXDoubleWhole=57510]="NoteheadXDoubleWhole",n[n.NoteheadXWhole=57511]="NoteheadXWhole",n[n.NoteheadXHalf=57512]="NoteheadXHalf",n[n.NoteheadXBlack=57513]="NoteheadXBlack",n[n.NoteheadParenthesis=57550]="NoteheadParenthesis",n[n.NoteheadSlashedBlack1=57551]="NoteheadSlashedBlack1",n[n.NoteheadSlashedBlack2=57552]="NoteheadSlashedBlack2",n[n.NoteheadSlashedHalf1=57553]="NoteheadSlashedHalf1",n[n.NoteheadSlashedHalf2=57554]="NoteheadSlashedHalf2",n[n.NoteheadSlashedWhole1=57555]="NoteheadSlashedWhole1",n[n.NoteheadSlashedWhole2=57556]="NoteheadSlashedWhole2",n[n.NoteheadSlashedDoubleWhole1=57557]="NoteheadSlashedDoubleWhole1",n[n.NoteheadSlashedDoubleWhole2=57558]="NoteheadSlashedDoubleWhole2",n[n.NoteheadCircledBlack=57572]="NoteheadCircledBlack",n[n.NoteheadCircledHalf=57573]="NoteheadCircledHalf",n[n.NoteheadCircledWhole=57574]="NoteheadCircledWhole",n[n.NoteheadCircledDoubleWhole=57575]="NoteheadCircledDoubleWhole",n[n.NoteheadCircleSlash=57591]="NoteheadCircleSlash",n[n.NoteheadHeavyX=57592]="NoteheadHeavyX",n[n.NoteheadHeavyXHat=57593]="NoteheadHeavyXHat",n[n.NoteheadSlashHorizontalEnds=57601]="NoteheadSlashHorizontalEnds",n[n.NoteheadSlashWhiteWhole=57602]="NoteheadSlashWhiteWhole",n[n.NoteheadSlashWhiteHalf=57603]="NoteheadSlashWhiteHalf",n[n.NoteheadRoundWhiteWithDot=57621]="NoteheadRoundWhiteWithDot",n[n.NoteheadSquareBlackLarge=57626]="NoteheadSquareBlackLarge",n[n.NoteheadSquareBlackWhite=57627]="NoteheadSquareBlackWhite",n[n.NoteheadClusterDoubleWhole3rd=57640]="NoteheadClusterDoubleWhole3rd",n[n.NoteheadClusterWhole3rd=57641]="NoteheadClusterWhole3rd",n[n.NoteheadClusterHalf3rd=57642]="NoteheadClusterHalf3rd",n[n.NoteheadClusterQuarter3rd=57643]="NoteheadClusterQuarter3rd",n[n.NoteShapeRoundWhite=57776]="NoteShapeRoundWhite",n[n.NoteShapeRoundBlack=57777]="NoteShapeRoundBlack",n[n.NoteShapeSquareWhite=57778]="NoteShapeSquareWhite",n[n.NoteShapeSquareBlack=57779]="NoteShapeSquareBlack",n[n.NoteShapeTriangleRightWhite=57780]="NoteShapeTriangleRightWhite",n[n.NoteShapeTriangleRightBlack=57781]="NoteShapeTriangleRightBlack",n[n.NoteShapeTriangleLeftWhite=57782]="NoteShapeTriangleLeftWhite",n[n.NoteShapeTriangleLeftBlack=57783]="NoteShapeTriangleLeftBlack",n[n.NoteShapeDiamondWhite=57784]="NoteShapeDiamondWhite",n[n.NoteShapeDiamondBlack=57785]="NoteShapeDiamondBlack",n[n.NoteShapeTriangleUpWhite=57786]="NoteShapeTriangleUpWhite",n[n.NoteShapeTriangleUpBlack=57787]="NoteShapeTriangleUpBlack",n[n.NoteShapeMoonWhite=57788]="NoteShapeMoonWhite",n[n.NoteShapeMoonBlack=57789]="NoteShapeMoonBlack",n[n.NoteShapeTriangleRoundWhite=57790]="NoteShapeTriangleRoundWhite",n[n.NoteShapeTriangleRoundBlack=57791]="NoteShapeTriangleRoundBlack",n[n.NoteQuarterUp=57813]="NoteQuarterUp",n[n.Note8thUp=57815]="Note8thUp",n[n.MetNoteQuarterUp=60581]="MetNoteQuarterUp",n[n.MetNote8thUp=60583]="MetNote8thUp",n[n.MetAugmentationDot=60599]="MetAugmentationDot",n[n.ArrowheadBlackUp=60280]="ArrowheadBlackUp",n[n.ArrowheadBlackDown=60284]="ArrowheadBlackDown",n[n.AugmentationDot=57831]="AugmentationDot",n[n.TextBlackNoteLongStem=57841]="TextBlackNoteLongStem",n[n.TextBlackNoteFrac8thLongStem=57843]="TextBlackNoteFrac8thLongStem",n[n.TextBlackNoteFrac16thLongStem=57845]="TextBlackNoteFrac16thLongStem",n[n.TextBlackNoteFrac32ndLongStem=57846]="TextBlackNoteFrac32ndLongStem",n[n.TextCont8thBeamLongStem=57848]="TextCont8thBeamLongStem",n[n.TextCont16thBeamLongStem=57850]="TextCont16thBeamLongStem",n[n.TextCont32ndBeamLongStem=57851]="TextCont32ndBeamLongStem",n[n.TextAugmentationDot=57852]="TextAugmentationDot",n[n.TextTupletBracketStartLongStem=57857]="TextTupletBracketStartLongStem",n[n.TextTuplet3LongStem=57858]="TextTuplet3LongStem",n[n.TextTupletBracketEndLongStem=57859]="TextTupletBracketEndLongStem",n[n.Tremolo1=57888]="Tremolo1",n[n.Tremolo2=57889]="Tremolo2",n[n.Tremolo3=57890]="Tremolo3",n[n.Tremolo4=57891]="Tremolo4",n[n.Tremolo5=57892]="Tremolo5",n[n.BuzzRoll=57898]="BuzzRoll",n[n.Flag8thUp=57920]="Flag8thUp",n[n.Flag8thDown=57921]="Flag8thDown",n[n.Flag16thUp=57922]="Flag16thUp",n[n.Flag16thDown=57923]="Flag16thDown",n[n.Flag32ndUp=57924]="Flag32ndUp",n[n.Flag32ndDown=57925]="Flag32ndDown",n[n.Flag64thUp=57926]="Flag64thUp",n[n.Flag64thDown=57927]="Flag64thDown",n[n.Flag128thUp=57928]="Flag128thUp",n[n.Flag128thDown=57929]="Flag128thDown",n[n.Flag256thUp=57930]="Flag256thUp",n[n.Flag256thDown=57931]="Flag256thDown",n[n.AccidentalFlat=57952]="AccidentalFlat",n[n.AccidentalNatural=57953]="AccidentalNatural",n[n.AccidentalSharp=57954]="AccidentalSharp",n[n.AccidentalDoubleSharp=57955]="AccidentalDoubleSharp",n[n.AccidentalDoubleFlat=57956]="AccidentalDoubleFlat",n[n.AccidentalQuarterToneFlatArrowUp=57968]="AccidentalQuarterToneFlatArrowUp",n[n.AccidentalQuarterToneSharpNaturalArrowUp=57970]="AccidentalQuarterToneSharpNaturalArrowUp",n[n.AccidentalThreeQuarterTonesSharpArrowUp=57972]="AccidentalThreeQuarterTonesSharpArrowUp",n[n.RepeatDot=57412]="RepeatDot",n[n.Segno=57415]="Segno",n[n.Coda=57416]="Coda",n[n.ArticAccentAbove=58528]="ArticAccentAbove",n[n.ArticAccentBelow=58529]="ArticAccentBelow",n[n.ArticStaccatoAbove=58530]="ArticStaccatoAbove",n[n.ArticStaccatoBelow=58531]="ArticStaccatoBelow",n[n.ArticTenutoAbove=58532]="ArticTenutoAbove",n[n.ArticTenutoBelow=58533]="ArticTenutoBelow",n[n.ArticMarcatoAbove=58540]="ArticMarcatoAbove",n[n.ArticMarcatoBelow=58541]="ArticMarcatoBelow",n[n.FermataAbove=58560]="FermataAbove",n[n.FermataShortAbove=58564]="FermataShortAbove",n[n.FermataLongAbove=58566]="FermataLongAbove",n[n.RestLonga=58593]="RestLonga",n[n.RestDoubleWhole=58594]="RestDoubleWhole",n[n.RestWhole=58595]="RestWhole",n[n.RestHalf=58596]="RestHalf",n[n.RestQuarter=58597]="RestQuarter",n[n.Rest8th=58598]="Rest8th",n[n.Rest16th=58599]="Rest16th",n[n.Rest32nd=58600]="Rest32nd",n[n.Rest64th=58601]="Rest64th",n[n.Rest128th=58602]="Rest128th",n[n.Rest256th=58603]="Rest256th",n[n.RestHBarLeft=58607]="RestHBarLeft",n[n.RestHBarMiddle=58608]="RestHBarMiddle",n[n.RestHBarRight=58609]="RestHBarRight",n[n.Repeat1Bar=58624]="Repeat1Bar",n[n.Repeat2Bars=58625]="Repeat2Bars",n[n.Ottava=58640]="Ottava",n[n.OttavaAlta=58641]="OttavaAlta",n[n.OttavaBassaVb=58652]="OttavaBassaVb",n[n.Quindicesima=58644]="Quindicesima",n[n.QuindicesimaAlta=58645]="QuindicesimaAlta",n[n.DynamicPPPPPP=58663]="DynamicPPPPPP",n[n.DynamicPPPPP=58664]="DynamicPPPPP",n[n.DynamicPPPP=58665]="DynamicPPPP",n[n.DynamicPPP=58666]="DynamicPPP",n[n.DynamicPP=58667]="DynamicPP",n[n.DynamicPiano=58656]="DynamicPiano",n[n.DynamicMP=58668]="DynamicMP",n[n.DynamicMF=58669]="DynamicMF",n[n.DynamicPF=58670]="DynamicPF",n[n.DynamicForte=58658]="DynamicForte",n[n.DynamicFF=58671]="DynamicFF",n[n.DynamicFFF=58672]="DynamicFFF",n[n.DynamicFFFF=58673]="DynamicFFFF",n[n.DynamicFFFFF=58674]="DynamicFFFFF",n[n.DynamicFFFFFF=58675]="DynamicFFFFFF",n[n.DynamicFortePiano=58676]="DynamicFortePiano",n[n.DynamicNiente=58662]="DynamicNiente",n[n.DynamicSforzando1=58678]="DynamicSforzando1",n[n.DynamicSforzandoPiano=58679]="DynamicSforzandoPiano",n[n.DynamicSforzandoPianissimo=58680]="DynamicSforzandoPianissimo",n[n.DynamicSforzato=58681]="DynamicSforzato",n[n.DynamicSforzatoPiano=58682]="DynamicSforzatoPiano",n[n.DynamicSforzatoFF=58683]="DynamicSforzatoFF",n[n.DynamicRinforzando1=58684]="DynamicRinforzando1",n[n.DynamicRinforzando2=58685]="DynamicRinforzando2",n[n.DynamicForzando=58677]="DynamicForzando",n[n.DynamicCrescendoHairpin=58686]="DynamicCrescendoHairpin",n[n.GraceNoteSlashStemUp=58724]="GraceNoteSlashStemUp",n[n.GraceNoteSlashStemDown=58725]="GraceNoteSlashStemDown",n[n.OrnamentTrill=58726]="OrnamentTrill",n[n.OrnamentTurn=58727]="OrnamentTurn",n[n.OrnamentTurnInverted=58728]="OrnamentTurnInverted",n[n.OrnamentShortTrill=58732]="OrnamentShortTrill",n[n.OrnamentMordent=58733]="OrnamentMordent",n[n.StringsDownBow=58896]="StringsDownBow",n[n.StringsUpBow=58898]="StringsUpBow",n[n.KeyboardPedalPed=58960]="KeyboardPedalPed",n[n.KeyboardPedalUp=58965]="KeyboardPedalUp",n[n.PictEdgeOfCymbal=59177]="PictEdgeOfCymbal",n[n.GuitarString0=59443]="GuitarString0",n[n.GuitarString1=59444]="GuitarString1",n[n.GuitarString2=59445]="GuitarString2",n[n.GuitarString3=59446]="GuitarString3",n[n.GuitarString4=59447]="GuitarString4",n[n.GuitarString5=59448]="GuitarString5",n[n.GuitarString6=59449]="GuitarString6",n[n.GuitarString7=59450]="GuitarString7",n[n.GuitarString8=59451]="GuitarString8",n[n.GuitarString9=59452]="GuitarString9",n[n.GuitarOpenPedal=59453]="GuitarOpenPedal",n[n.GuitarClosePedal=59455]="GuitarClosePedal",n[n.GuitarGolpe=59458]="GuitarGolpe",n[n.GuitarFadeIn=59459]="GuitarFadeIn",n[n.GuitarFadeOut=59460]="GuitarFadeOut",n[n.GuitarVolumeSwell=59461]="GuitarVolumeSwell",n[n.FretboardFilledCircle=59480]="FretboardFilledCircle",n[n.FretboardX=59481]="FretboardX",n[n.FretboardO=59482]="FretboardO",n[n.Tuplet0=59520]="Tuplet0",n[n.Tuplet1=59521]="Tuplet1",n[n.Tuplet2=59522]="Tuplet2",n[n.Tuplet3=59523]="Tuplet3",n[n.Tuplet4=59524]="Tuplet4",n[n.Tuplet5=59525]="Tuplet5",n[n.Tuplet6=59526]="Tuplet6",n[n.Tuplet7=59527]="Tuplet7",n[n.Tuplet8=59528]="Tuplet8",n[n.Tuplet9=59529]="Tuplet9",n[n.TupletColon=59530]="TupletColon",n[n.WiggleTrill=60068]="WiggleTrill",n[n.GuitarVibratoStroke=60082]="GuitarVibratoStroke",n[n.GuitarWideVibratoStroke=60083]="GuitarWideVibratoStroke",n[n.WiggleVibratoMediumFast=60126]="WiggleVibratoMediumFast",n[n.WiggleSawtoothNarrow=60090]="WiggleSawtoothNarrow",n[n.WiggleSawtooth=60091]="WiggleSawtooth",n[n.OctaveBaselineM=60565]="OctaveBaselineM",n[n.OctaveBaselineB=60563]="OctaveBaselineB",n[n.GuitarLeftHandTapping=59456]="GuitarLeftHandTapping",n[n.Fingering0=60688]="Fingering0",n[n.Fingering1=60689]="Fingering1",n[n.Fingering2=60690]="Fingering2",n[n.Fingering3=60691]="Fingering3",n[n.Fingering4=60692]="Fingering4",n[n.Fingering5=60693]="Fingering5",n[n.FingeringPLower=60695]="FingeringPLower",n[n.FingeringTLower=60696]="FingeringTLower",n[n.FingeringILower=60697]="FingeringILower",n[n.FingeringMLower=60698]="FingeringMLower",n[n.FingeringALower=60699]="FingeringALower",n[n.FingeringCLower=60700]="FingeringCLower"})(f||(f={}));const _i=class _i{static _initialize(){const t=_i._allMusicFontSymbols;if(t.length===0)for(const e of Object.values(f).filter(s=>typeof s=="number")){const s=e;t.push(s),f[s].toLowerCase().endsWith("black")&&_i._blackNoteHeadGlyphs.add(s)}}static getAllMusicFontSymbols(){return _i._initialize(),_i._allMusicFontSymbols}static isBlackNoteHead(t){return _i._initialize(),_i._blackNoteHeadGlyphs.has(t)}};o(_i,"_allMusicFontSymbols",[]),o(_i,"_blackNoteHeadGlyphs",new Set);let Ha=_i;var Je;(function(n){n[n.Above=0]="Above",n[n.Inside=1]="Inside",n[n.Below=2]="Below",n[n.Outside=3]="Outside"})(Je||(Je={}));class ${constructor(t="",e=0,s=0,i=f.None,r=f.None,a=f.None,l=f.None,h=Je.Inside,c=0){o(this,"id",0);o(this,"elementType");o(this,"staffLine");o(this,"noteHeadDefault");o(this,"noteHeadHalf");o(this,"noteHeadWhole");o(this,"techniqueSymbol");o(this,"techniqueSymbolPlacement");o(this,"outputMidiNumber");this.id=c,this.elementType=t,this.outputMidiNumber=s,this.staffLine=e,this.noteHeadDefault=i,this.noteHeadHalf=r!==f.None?r:i,this.noteHeadWhole=a!==f.None?a:i,this.techniqueSymbol=l,this.techniqueSymbolPlacement=h}get uniqueId(){return`${this.elementType}.${this.id}`}static create(t=0,e="",s=0,i=0,r=f.None,a=f.None,l=f.None,h=f.None,c=Je.Inside){return new $(e,s,i,r,a,l,h,c,t)}getSymbol(t){switch(t){case b.Whole:return this.noteHeadWhole;case b.Half:return this.noteHeadHalf;default:return this.noteHeadDefault}}}const ft=class ft{static articulationFromElementVariation(t,e){return t<ft._gp6ElementAndVariationToArticulation.length?(e>=ft._gp6ElementAndVariationToArticulation.length&&(e=0),ft._gp6ElementAndVariationToArticulation[t][e]):38}static getArticulationName(t){const e=ft.getArticulation(t);if(e){const s=e.uniqueId;for(const[i,r]of ft.instrumentArticulationNames)if(r===s)return i}else{const s=`.${t.percussionArticulation}`;for(const[i,r]of ft.instrumentArticulationNames)if(r.endsWith(s))return i}return"Snare (hit)"}static getArticulation(t){const e=t.percussionArticulation;if(e<0)return null;const s=t.beat.voice.bar.staff.track.percussionArticulations;return e<s.length?s[e]:ft.getArticulationById(e)}static _initArticulationsById(){let t=ft._instrumentArticulationsById;if(!t){t=new Map;for(const e of ft.instrumentArticulations.values())t.set(e.id,e);ft._instrumentArticulationsById=t}return t}static instrumentArticulationIds(){return ft._initArticulationsById().keys()}static getArticulationById(t){const e=ft._initArticulationsById();return e.has(t)?e.get(t):null}static getElementAndVariation(t){const e=ft.getArticulation(t);if(!e)return[-1,-1];for(let s=0;s<ft._gp6ElementAndVariationToArticulation.length;s++){const i=ft._gp6ElementAndVariationToArticulation[s];for(let r=0;r<i.length;r++){const a=ft.getArticulationById(i[r]);if((a==null?void 0:a.outputMidiNumber)===e.outputMidiNumber)return[s,r]}}return[-1,-1]}static _mergeNames(t){const e=new Map(t[0]);for(let s=1;s<t.length;s++)for(const[i,r]of t[s])e.set(i,r);return e}static tryMatchKnownArticulation(t){let e=ft._articulationsByOutputNumber;if(!e){e=new Map;for(const s of ft.instrumentArticulations.values())e.has(s.outputMidiNumber)||e.set(s.outputMidiNumber,s);ft._articulationsByOutputNumber=e}return e.has(t.outputMidiNumber)?e.get(t.outputMidiNumber).id:-1}static getInstrumentArticulationByUniqueId(t){let e=ft._instrumentArticulationsByUniqueId;if(!e){e=new Map;for(const s of ft.instrumentArticulations.values())e.set(s.uniqueId,s);ft._instrumentArticulationsByUniqueId=e}return e.has(t)?e.get(t):void 0}};o(ft,"instrumentArticulations",new Map([$.create(38,"Snare",3,38,f.NoteheadBlack,f.NoteheadHalf,f.NoteheadWhole),$.create(37,"Snare",3,37,f.NoteheadXBlack,f.NoteheadXBlack,f.NoteheadXBlack),$.create(91,"Snare",3,38,f.NoteheadDiamondWhite,f.NoteheadDiamondWhite,f.NoteheadDiamondWhite),$.create(42,"Charley",-1,42,f.NoteheadXBlack,f.NoteheadXBlack,f.NoteheadXBlack),$.create(92,"Charley",-1,46,f.NoteheadCircleSlash,f.NoteheadCircleSlash,f.NoteheadCircleSlash),$.create(46,"Charley",-1,46,f.NoteheadCircleX,f.NoteheadCircleX,f.NoteheadCircleX),$.create(44,"Charley",9,44,f.NoteheadXBlack,f.NoteheadXBlack,f.NoteheadXBlack),$.create(35,"Acoustic Kick Drum",8,35,f.NoteheadBlack,f.NoteheadHalf,f.NoteheadWhole),$.create(36,"Kick Drum",7,36,f.NoteheadBlack,f.NoteheadHalf,f.NoteheadWhole),$.create(50,"Tom Very High",1,50,f.NoteheadBlack,f.NoteheadHalf,f.NoteheadWhole),$.create(48,"Tom High",2,48,f.NoteheadBlack,f.NoteheadHalf,f.NoteheadWhole),$.create(47,"Tom Medium",4,47,f.NoteheadBlack,f.NoteheadHalf,f.NoteheadWhole),$.create(45,"Tom Low",5,45,f.NoteheadBlack,f.NoteheadHalf,f.NoteheadWhole),$.create(43,"Tom Very Low",6,43,f.NoteheadBlack,f.NoteheadHalf,f.NoteheadWhole),$.create(93,"Ride",0,51,f.NoteheadXBlack,f.NoteheadXBlack,f.NoteheadXBlack,f.PictEdgeOfCymbal,Je.Above),$.create(51,"Ride",0,51,f.NoteheadXBlack,f.NoteheadXBlack,f.NoteheadXBlack),$.create(53,"Ride",0,53,f.NoteheadDiamondWhite,f.NoteheadDiamondWhite,f.NoteheadDiamondWhite),$.create(94,"Ride",0,51,f.NoteheadXBlack,f.NoteheadXBlack,f.NoteheadXBlack,f.ArticStaccatoAbove,Je.Outside),$.create(55,"Splash",-2,55,f.NoteheadXBlack,f.NoteheadXBlack,f.NoteheadXBlack),$.create(95,"Splash",-2,55,f.NoteheadXBlack,f.NoteheadXBlack,f.NoteheadXBlack,f.ArticStaccatoAbove,Je.Outside),$.create(52,"China",-3,52,f.NoteheadHeavyXHat,f.NoteheadHeavyXHat,f.NoteheadHeavyXHat),$.create(96,"China",-3,52,f.NoteheadHeavyXHat,f.NoteheadHeavyXHat,f.NoteheadHeavyXHat),$.create(49,"Crash High",-2,49,f.NoteheadHeavyX,f.NoteheadHeavyX,f.NoteheadHeavyX),$.create(97,"Crash High",-2,49,f.NoteheadHeavyX,f.NoteheadHeavyX,f.NoteheadHeavyX,f.ArticStaccatoAbove,Je.Outside),$.create(57,"Crash Medium",-1,57,f.NoteheadHeavyX,f.NoteheadHeavyX,f.NoteheadHeavyX),$.create(98,"Crash Medium",-1,57,f.NoteheadHeavyX,f.NoteheadHeavyX,f.NoteheadHeavyX,f.ArticStaccatoAbove,Je.Outside),$.create(99,"Cowbell Low",1,56,f.NoteheadTriangleUpBlack,f.NoteheadTriangleUpHalf,f.NoteheadTriangleUpWhole),$.create(100,"Cowbell Low",1,56,f.NoteheadXBlack,f.NoteheadXHalf,f.NoteheadXWhole),$.create(56,"Cowbell Medium",0,56,f.NoteheadTriangleUpBlack,f.NoteheadTriangleUpHalf,f.NoteheadTriangleUpWhole),$.create(101,"Cowbell Medium",0,56,f.NoteheadXBlack,f.NoteheadXHalf,f.NoteheadXWhole),$.create(102,"Cowbell High",-1,56,f.NoteheadTriangleUpBlack,f.NoteheadTriangleUpHalf,f.NoteheadTriangleUpWhole),$.create(103,"Cowbell High",-1,56,f.NoteheadXBlack,f.NoteheadXHalf,f.NoteheadXWhole),$.create(77,"Woodblock Low",-9,77,f.NoteheadTriangleUpBlack,f.NoteheadTriangleUpBlack,f.NoteheadTriangleUpBlack),$.create(76,"Woodblock High",-10,76,f.NoteheadTriangleUpBlack,f.NoteheadTriangleUpBlack,f.NoteheadTriangleUpBlack),$.create(60,"Bongo High",-4,60,f.NoteheadBlack,f.NoteheadHalf,f.NoteheadWhole),$.create(104,"Bongo High",-5,60,f.NoteheadBlack,f.NoteheadHalf,f.NoteheadWhole,f.NoteheadParenthesis,Je.Inside),$.create(105,"Bongo High",-6,60,f.NoteheadXBlack,f.NoteheadXBlack,f.NoteheadXBlack),$.create(61,"Bongo Low",-7,61,f.NoteheadBlack,f.NoteheadHalf,f.NoteheadWhole),$.create(106,"Bongo Low",-8,61,f.NoteheadBlack,f.NoteheadHalf,f.NoteheadWhole,f.NoteheadParenthesis,Je.Inside),$.create(107,"Bongo Low",-16,61,f.NoteheadXBlack,f.NoteheadXBlack,f.NoteheadXBlack),$.create(66,"Timbale Low",10,66,f.NoteheadBlack,f.NoteheadHalf,f.NoteheadWhole),$.create(65,"Timbale High",9,65,f.NoteheadBlack,f.NoteheadHalf,f.NoteheadWhole),$.create(68,"Agogo Low",12,68,f.NoteheadBlack,f.NoteheadHalf,f.NoteheadWhole),$.create(67,"Agogo High",11,67,f.NoteheadBlack,f.NoteheadHalf,f.NoteheadWhole),$.create(64,"Conga Low",17,64,f.NoteheadBlack,f.NoteheadHalf,f.NoteheadWhole),$.create(108,"Conga Low",16,64,f.NoteheadXBlack,f.NoteheadXBlack,f.NoteheadXBlack),$.create(109,"Conga Low",15,64,f.NoteheadBlack,f.NoteheadHalf,f.NoteheadWhole,f.NoteheadParenthesis,Je.Inside),$.create(63,"Conga High",14,63,f.NoteheadBlack,f.NoteheadHalf,f.NoteheadWhole),$.create(110,"Conga High",13,63,f.NoteheadXBlack,f.NoteheadXBlack,f.NoteheadXBlack),$.create(62,"Conga High",19,62,f.NoteheadBlack,f.NoteheadHalf,f.NoteheadWhole,f.NoteheadParenthesis,Je.Inside),$.create(72,"Whistle Low",-11,72,f.NoteheadBlack,f.NoteheadHalf,f.NoteheadWhole),$.create(71,"Whistle High",-17,71,f.NoteheadBlack,f.NoteheadHalf,f.NoteheadWhole),$.create(73,"Guiro",38,73,f.NoteheadBlack,f.NoteheadHalf,f.NoteheadWhole),$.create(74,"Guiro",37,74,f.NoteheadBlack,f.NoteheadHalf,f.NoteheadWhole),$.create(86,"Surdo",36,86,f.NoteheadBlack,f.NoteheadHalf,f.NoteheadWhole),$.create(87,"Surdo",35,87,f.NoteheadXBlack,f.NoteheadXBlack,f.NoteheadXBlack,f.NoteheadParenthesis,Je.Inside),$.create(54,"Tambourine",3,54,f.NoteheadTriangleUpBlack,f.NoteheadTriangleUpBlack,f.NoteheadTriangleUpBlack),$.create(111,"Tambourine",2,54,f.NoteheadTriangleUpBlack,f.NoteheadTriangleUpBlack,f.NoteheadTriangleUpBlack,f.StringsUpBow,Je.Above),$.create(112,"Tambourine",1,54,f.NoteheadTriangleUpBlack,f.NoteheadTriangleUpBlack,f.NoteheadTriangleUpBlack,f.StringsDownBow,Je.Above),$.create(113,"Tambourine",-7,54,f.NoteheadXBlack,f.NoteheadXBlack,f.NoteheadXBlack),$.create(79,"Cuica",30,79,f.NoteheadBlack,f.NoteheadHalf,f.NoteheadWhole),$.create(78,"Cuica",29,78,f.NoteheadXBlack,f.NoteheadXBlack,f.NoteheadXBlack),$.create(58,"Vibraslap",28,58,f.NoteheadBlack,f.NoteheadHalf,f.NoteheadWhole),$.create(81,"Triangle",27,81,f.NoteheadBlack,f.NoteheadHalf,f.NoteheadWhole),$.create(80,"Triangle",26,80,f.NoteheadXBlack,f.NoteheadXBlack,f.NoteheadXBlack,f.NoteheadParenthesis,Je.Inside),$.create(114,"Grancassa",25,43,f.NoteheadBlack,f.NoteheadHalf,f.NoteheadWhole),$.create(115,"Piatti",18,49,f.NoteheadBlack,f.NoteheadHalf,f.NoteheadWhole),$.create(116,"Piatti",24,49,f.NoteheadXBlack,f.NoteheadXBlack,f.NoteheadXBlack),$.create(69,"Cabasa",23,69,f.NoteheadBlack,f.NoteheadHalf,f.NoteheadWhole),$.create(117,"Cabasa",22,69,f.NoteheadBlack,f.NoteheadHalf,f.NoteheadWhole,f.StringsUpBow,Je.Outside),$.create(85,"Castanets",21,85,f.NoteheadBlack,f.NoteheadHalf,f.NoteheadWhole),$.create(75,"Claves",20,75,f.NoteheadBlack,f.NoteheadHalf,f.NoteheadWhole),$.create(70,"Left Maraca",-12,70,f.NoteheadBlack,f.NoteheadHalf,f.NoteheadWhole),$.create(118,"Left Maraca",-13,70,f.NoteheadBlack,f.NoteheadHalf,f.NoteheadWhole,f.StringsUpBow,Je.Outside),$.create(119,"Right Maraca",-14,70,f.NoteheadBlack,f.NoteheadHalf,f.NoteheadWhole),$.create(120,"Right Maraca",-15,70,f.NoteheadBlack,f.NoteheadHalf,f.NoteheadWhole,f.StringsUpBow,Je.Outside),$.create(82,"Shaker",-23,82,f.NoteheadBlack,f.NoteheadHalf,f.NoteheadWhole),$.create(122,"Shaker",-24,82,f.NoteheadBlack,f.NoteheadHalf,f.NoteheadWhole,f.StringsUpBow,Je.Outside),$.create(84,"Bell Tree",-18,53,f.NoteheadBlack,f.NoteheadHalf,f.NoteheadWhole),$.create(123,"Bell Tree",-19,53,f.NoteheadBlack,f.NoteheadHalf,f.NoteheadWhole,f.StringsUpBow,Je.Outside),$.create(83,"Jingle Bell",-20,53,f.NoteheadBlack,f.NoteheadHalf,f.NoteheadWhole),$.create(83,"Tinkle Bell",-20,53,f.NoteheadBlack,f.NoteheadHalf,f.NoteheadWhole),$.create(124,"Golpe",-21,62,f.NoteheadNull,f.NoteheadNull,f.NoteheadNull,f.GuitarGolpe,Je.Below),$.create(125,"Golpe",-22,62,f.NoteheadNull,f.NoteheadNull,f.NoteheadNull,f.GuitarGolpe,Je.Above),$.create(39,"Hand Clap",3,39,f.NoteheadBlack,f.NoteheadHalf,f.NoteheadWhole),$.create(40,"Electric Snare",3,40,f.NoteheadBlack,f.NoteheadHalf,f.NoteheadWhole),$.create(31,"Sticks",3,40,f.NoteheadSlashedBlack2,f.NoteheadSlashedBlack2,f.NoteheadSlashedBlack2),$.create(41,"Very Low Floor Tom",5,41,f.NoteheadBlack,f.NoteheadHalf,f.NoteheadWhole),$.create(59,"Ride Cymbal 2",2,59,f.NoteheadXBlack,f.NoteheadXBlack,f.NoteheadXBlack,f.PictEdgeOfCymbal,Je.Above),$.create(126,"Ride Cymbal 2",2,59,f.NoteheadXBlack,f.NoteheadXBlack,f.NoteheadXBlack),$.create(127,"Ride Cymbal 2",2,59,f.NoteheadDiamondWhite,f.NoteheadDiamondWhite,f.NoteheadDiamondWhite),$.create(29,"Ride Cymbal 2",2,59,f.NoteheadXBlack,f.NoteheadXBlack,f.NoteheadXBlack,f.ArticStaccatoAbove,Je.Outside),$.create(30,"Reverse Cymbal",-3,49,f.NoteheadXBlack,f.NoteheadXBlack,f.NoteheadXBlack),$.create(33,"Metronome",3,37,f.NoteheadXBlack,f.NoteheadXBlack,f.NoteheadXBlack),$.create(34,"Metronome",3,38,f.NoteheadBlack,f.NoteheadBlack,f.NoteheadBlack)].map(t=>[t.uniqueId,t]))),o(ft,"_instrumentArticulationNames",new Map([["Snare (hit)","Snare.38"],["Snare (side stick)","Snare.37"],["Snare (rim shot)","Snare.91"],["Hi-Hat (closed)","Charley.42"],["Hi-Hat (half)","Charley.92"],["Hi-Hat (open)","Charley.46"],["Pedal Hi-Hat (hit)","Charley.44"],["Kick (hit)","Acoustic Kick Drum.35"],["Kick (hit) 2","Kick Drum.36"],["High Floor Tom (hit)","Tom Very High.50"],["High Tom (hit)","Tom High.48"],["Mid Tom (hit)","Tom Medium.47"],["Low Tom (hit)","Tom Low.45"],["Very Low Tom (hit)","Tom Very Low.43"],["Ride (edge)","Ride.93"],["Ride (middle)","Ride.51"],["Ride (bell)","Ride.53"],["Ride (choke)","Ride.94"],["Splash (hit)","Splash.55"],["Splash (choke)","Splash.95"],["China (hit)","China.52"],["China (choke)","China.96"],["Crash high (hit)","Crash High.49"],["Crash high (choke)","Crash High.97"],["Crash medium (hit)","Crash Medium.57"],["Crash medium (choke)","Crash Medium.98"],["Cowbell low (hit)","Cowbell Low.99"],["Cowbell low (tip)","Cowbell Low.100"],["Cowbell medium (hit)","Cowbell Medium.56"],["Cowbell medium (tip)","Cowbell Medium.101"],["Cowbell high (hit)","Cowbell High.102"],["Cowbell high (tip)","Cowbell High.103"],["Woodblock low (hit)","Woodblock Low.77"],["Woodblock high (hit)","Woodblock High.76"],["Bongo High (hit)","Bongo High.60"],["Bongo High (mute)","Bongo High.104"],["Bongo High (slap)","Bongo High.105"],["Bongo Low (hit)","Bongo Low.61"],["Bongo Low (mute)","Bongo Low.106"],["Bongo Low (slap)","Bongo Low.107"],["Timbale low (hit)","Timbale Low.66"],["Timbale high (hit)","Timbale High.65"],["Agogo low (hit)","Agogo Low.68"],["Agogo high (hit)","Agogo High.67"],["Conga low (hit)","Conga Low.64"],["Conga low (slap)","Conga Low.108"],["Conga low (mute)","Conga Low.109"],["Conga high (hit)","Conga High.63"],["Conga high (slap)","Conga High.110"],["Conga high (mute)","Conga High.62"],["Whistle low (hit)","Whistle Low.72"],["Whistle high (hit)","Whistle High.71"],["Guiro (hit)","Guiro.73"],["Guiro (scrap-return)","Guiro.74"],["Surdo (hit)","Surdo.86"],["Surdo (mute)","Surdo.87"],["Tambourine (hit)","Tambourine.54"],["Tambourine (return)","Tambourine.111"],["Tambourine (roll)","Tambourine.112"],["Tambourine (hand)","Tambourine.113"],["Cuica (open)","Cuica.79"],["Cuica (mute)","Cuica.78"],["Vibraslap (hit)","Vibraslap.58"],["Triangle (hit)","Triangle.81"],["Triangle (mute)","Triangle.80"],["Grancassa (hit)","Grancassa.114"],["Piatti (hit)","Piatti.115"],["Piatti (hand)","Piatti.116"],["Cabasa (hit)","Cabasa.69"],["Cabasa (return)","Cabasa.117"],["Castanets (hit)","Castanets.85"],["Claves (hit)","Claves.75"],["Left Maraca (hit)","Left Maraca.70"],["Left Maraca (return)","Left Maraca.118"],["Right Maraca (hit)","Right Maraca.119"],["Right Maraca (return)","Right Maraca.120"],["Shaker (hit)","Shaker.82"],["Shaker (return)","Shaker.122"],["Bell Tree (hit)","Bell Tree.84"],["Bell Tree (return)","Bell Tree.123"],["Jingle Bell (hit)","Jingle Bell.83"],["Tinkle Bell (hit)","Tinkle Bell.83"],["Golpe (thumb)","Golpe.124"],["Golpe (finger)","Golpe.125"],["Hand Clap (hit)","Hand Clap.39"],["Electric Snare (hit)","Electric Snare.40"],["Snare (side stick) 2","Sticks.31"],["Low Floor Tom (hit)","Very Low Floor Tom.41"],["Ride (edge) 2","Ride Cymbal 2.59"],["Ride (middle) 2","Ride Cymbal 2.126"],["Ride (bell) 2","Ride Cymbal 2.127"],["Ride (choke) 2","Ride Cymbal 2.29"],["Reverse Cymbal (hit)","Reverse Cymbal.30"],["Metronome (hit)","Metronome.33"],["Metronome (bell)","Metronome.34"]])),o(ft,"_gp6ElementAndVariationToArticulation",[[35,35,35],[38,91,37],[99,100,99],[56,100,56],[102,103,102],[43,43,43],[45,45,45],[47,47,47],[48,48,48],[50,50,50],[42,92,46],[44,44,44],[57,98,57],[49,97,49],[55,95,55],[51,93,127],[52,96,52]]),o(ft,"_instrumentArticulationsById"),o(ft,"instrumentArticulationNames",ft._mergeNames([new Map([["Hand (hit)","Bongo Low.61"],["Tinkle Bell (hat)","Tingle Bell.83"],["Cymbal (hit)","Reverse Cymbal.30"],["Snare (side stick) 3","Snare.37"],["Snare (hit) 2","Snare.38"],["Snare (hit) 3","Snare.40"],["Agogo tow (hit)","Agogo Low.68"],["Triangle (rnute)","Triangle.80"],["Hand (mute)","Bongo High.104"],["Hand (slap)","Bongo High.105"],["Hand (mute) 2","Bongo Low.106"],["Hand (slap) 2","Bongo Low.107"],["Piatti (hat)","Piatti.115"],["Bell Tee (return)","Bell Tree.123"]]),ft._instrumentArticulationNames])),o(ft,"_articulationsByOutputNumber"),o(ft,"_instrumentArticulationsByUniqueId");let jt=ft;var ut;(function(n){n[n.None=0]="None",n[n.InvertedTurn=1]="InvertedTurn",n[n.Turn=2]="Turn",n[n.UpperMordent=3]="UpperMordent",n[n.LowerMordent=4]="LowerMordent"})(ut||(ut={}));class $i{constructor(){o(this,"tieDestinationNoteId",-1);o(this,"tieOriginNoteId",-1);o(this,"slurDestinationNoteId",-1);o(this,"slurOriginNoteId",-1);o(this,"hammerPullDestinationNoteId",-1);o(this,"hammerPullOriginNoteId",-1);o(this,"slideTargetNoteId",-1);o(this,"slideOriginNoteId",-1)}}var ns;(function(n){n[n.Effects=0]="Effects",n[n.StandardNotationNoteHead=1]="StandardNotationNoteHead",n[n.StandardNotationAccidentals=2]="StandardNotationAccidentals",n[n.StandardNotationEffects=3]="StandardNotationEffects",n[n.GuitarTabFretNumber=4]="GuitarTabFretNumber",n[n.GuitarTabEffects=5]="GuitarTabEffects",n[n.SlashNoteHead=6]="SlashNoteHead",n[n.SlashEffects=7]="SlashEffects",n[n.NumberedNumber=8]="NumberedNumber",n[n.NumberedAccidentals=9]="NumberedAccidentals",n[n.NumberedEffects=10]="NumberedEffects"})(ns||(ns={}));class Il extends Mr{constructor(){super(...arguments);o(this,"noteHead");o(this,"noteHeadCenterOnStem")}}const gs=class gs{constructor(){o(this,"id",gs.globalNoteId++);o(this,"index",0);o(this,"accentuated",mt.None);o(this,"bendType",J.None);o(this,"bendStyle",tt.Default);o(this,"bendOrigin",null);o(this,"isContinuedBend",!1);o(this,"bendPoints",null);o(this,"maxBendPoint",null);o(this,"fret",-1);o(this,"string",-1);o(this,"showStringNumber",!1);o(this,"octave",-1);o(this,"tone",-1);o(this,"percussionArticulation",-1);o(this,"isVisible",!0);o(this,"isLeftHandTapped",!1);o(this,"isHammerPullOrigin",!1);o(this,"hammerPullOrigin",null);o(this,"hammerPullDestination",null);o(this,"isSlurDestination",!1);o(this,"slurOrigin",null);o(this,"slurDestination",null);o(this,"harmonicType",ie.None);o(this,"harmonicValue",0);o(this,"isGhost",!1);o(this,"isLetRing",!1);o(this,"letRingDestination",null);o(this,"isPalmMute",!1);o(this,"palmMuteDestination",null);o(this,"isDead",!1);o(this,"isStaccato",!1);o(this,"slideInType",Et.None);o(this,"slideOutType",ge.None);o(this,"slideTarget",null);o(this,"slideOrigin",null);o(this,"vibrato",Ee.None);o(this,"tieOrigin",null);o(this,"tieDestination",null);o(this,"isTieDestination",!1);o(this,"leftHandFinger",ae.Unknown);o(this,"rightHandFinger",ae.Unknown);o(this,"trillValue",-1);o(this,"trillSpeed",b.ThirtySecond);o(this,"durationPercent",1);o(this,"accidentalMode",de.Default);o(this,"beat");o(this,"dynamics",re.F);o(this,"isEffectSlurOrigin",!1);o(this,"hasEffectSlur",!1);o(this,"effectSlurOrigin",null);o(this,"effectSlurDestination",null);o(this,"ornament",ut.None);o(this,"style");o(this,"_noteIdBag",null)}static resetIds(){gs.globalNoteId=0}get hasBend(){return this.bendPoints!==null&&this.bendType!==J.None}get isStringed(){return this.string>=0}get isPiano(){return!this.isStringed&&this.octave>=0&&this.tone>=0}get isPercussion(){return!this.isStringed&&this.percussionArticulation>=0}get element(){return this.isPercussion?jt.getElementAndVariation(this)[0]:-1}get variation(){return this.isPercussion?jt.getElementAndVariation(this)[1]:-1}get isHammerPullDestination(){return!!this.hammerPullOrigin}get isSlurOrigin(){return!!this.slurDestination}get isHarmonic(){return this.harmonicType!==ie.None}get isTieOrigin(){return this.tieDestination!==null}get isFingering(){return this.leftHandFinger!==ae.Unknown||this.rightHandFinger!==ae.Unknown}get trillFret(){return this.trillValue-this.stringTuning}get isTrill(){return this.trillValue>=0}get isEffectSlurDestination(){return!!this.effectSlurOrigin}get stringTuning(){return this.beat.voice.bar.staff.capo+gs.getStringTuning(this.beat.voice.bar.staff,this.string)}static getStringTuning(t,e){return t.tuning.length>0?t.tuning[t.tuning.length-(e-1)-1]:0}get realValue(){return this.calculateRealValue(!0,!0)}get realValueWithoutHarmonic(){return this.calculateRealValue(!0,!1)}calculateRealValue(t,e){const s=t?this.beat.voice.bar.staff.transpositionPitch:0;if(e){let i=this.calculateRealValue(t,!1);return this.isStringed&&(this.harmonicType===ie.Natural?i=this.harmonicPitch+this.stringTuning-s:i+=this.harmonicPitch),i}return this.isPercussion?this.percussionArticulation:this.isStringed?this.fret+this.stringTuning-s:this.isPiano?this.octave*12+this.tone-s:0}get harmonicPitch(){if(this.harmonicType===ie.None||!this.isStringed)return 0;const t=this.harmonicValue;return A.isAlmostEqualTo(t,2.4)?36:A.isAlmostEqualTo(t,2.7)?34:t<3?0:t<=3.5?31:t<=4?28:t<=5?24:t<=6?34:t<=7?19:t<=8.5?36:t<=9?28:t<=10?34:t<=11?0:t<=12?12:t<14?0:t<=15?34:t<=16?28:t<=17?36:t<=18?0:t<=19?19:t<=21?0:t<=22?36:t<=24?24:0}get initialBendValue(){return this.hasBend?Math.floor(this.bendPoints[0].value/2):this.bendOrigin?Math.floor(this.bendOrigin.bendPoints[this.bendOrigin.bendPoints.length-1].value/2):this.isTieDestination&&this.tieOrigin.bendOrigin?Math.floor(this.tieOrigin.bendOrigin.bendPoints[this.tieOrigin.bendOrigin.bendPoints.length-1].value/2):this.beat.hasWhammyBar?Math.floor(this.beat.whammyBarPoints[0].value/2):this.beat.isContinuedWhammy?Math.floor(this.beat.previousBeat.whammyBarPoints[this.beat.previousBeat.whammyBarPoints.length-1].value/2):0}get displayValue(){return this.displayValueWithoutBend+this.initialBendValue}get displayValueWithoutBend(){let t=this.realValue;switch(this.harmonicType!==ie.Natural&&this.harmonicType!==ie.None&&(t-=this.harmonicPitch),this.beat.ottava){case pe._15ma:t-=24;break;case pe._8va:t-=12;break;case pe.Regular:break;case pe._8vb:t+=12;break;case pe._15mb:t+=24;break}switch(this.beat.voice.bar.clefOttava){case pe._15ma:t-=24;break;case pe._8va:t-=12;break;case pe.Regular:break;case pe._8vb:t+=12;break;case pe._15mb:t+=24;break}return t-this.beat.voice.bar.staff.displayTranspositionPitch}get hasQuarterToneOffset(){return this.hasBend?this.bendPoints[0].value%2!==0:this.bendOrigin?this.bendOrigin.bendPoints[this.bendOrigin.bendPoints.length-1].value%2!==0:this.beat.hasWhammyBar?this.beat.whammyBarPoints[0].value%2!==0:this.beat.isContinuedWhammy?this.beat.previousBeat.whammyBarPoints[this.beat.previousBeat.whammyBarPoints.length-1].value%2!==0:!1}addBendPoint(t){let e=this.bendPoints;e===null&&(e=[],this.bendPoints=e),e.push(t),(!this.maxBendPoint||t.value>this.maxBendPoint.value)&&(this.maxBendPoint=t),this.bendType===J.None&&(this.bendType=J.Custom)}finish(t,e=null){const s=new Kr(()=>gs.nextNoteOnSameLine(this)),i=t&&t.notation.notationMode===Xt.SongBook;if(this.isTieDestination&&(this.chain(e),i&&this.tieOrigin&&this.tieOrigin.isLetRing&&(this.isLetRing=!0)),this.isLetRing&&(!s.value||!s.value.isLetRing?this.letRingDestination=this:this.letRingDestination=s.value,i&&this.isTieDestination&&!this.tieOrigin.hasBend&&(this.isVisible=!1)),this.isPalmMute&&(!s.value||!s.value.isPalmMute?this.palmMuteDestination=this:this.palmMuteDestination=s.value),this.isHammerPullOrigin){const h=gs.findHammerPullDestination(this);h?(this.hammerPullDestination=h,h.hammerPullOrigin=this):this.isHammerPullOrigin=!1}switch(this.slideOutType){case ge.Shift:case ge.Legato:this.slideTarget||(this.slideTarget=s.value),this.slideTarget?this.slideTarget.slideOrigin=this:this.slideOutType=ge.None;break}let r=null;this.isHammerPullOrigin&&this.hammerPullDestination?r=this.hammerPullDestination:this.slideOutType===ge.Legato&&this.slideTarget&&(r=this.slideTarget),r&&(this.hasEffectSlur=!0,this.effectSlurOrigin&&this.beat.pickStroke===Ot.None?(this.effectSlurOrigin.effectSlurDestination=r,this.effectSlurOrigin.effectSlurDestination.effectSlurOrigin=this.effectSlurOrigin,this.effectSlurOrigin=null):(this.isEffectSlurOrigin=!0,this.effectSlurDestination=r,this.effectSlurDestination.effectSlurOrigin=this));const a=this.bendPoints,l=a!=null&&a.length>0;if(l){const h=this.isTieDestination&&this.tieOrigin.hasBend;this.isContinuedBend=h}else this.bendType=J.None;if(l&&this.bendType===J.Custom){if(a.length===4){const h=a[0],c=a[1],d=a[2],u=a[3];c.value===d.value?u.value>h.value?c.value>u.value?this.bendType=J.BendRelease:!this.isContinuedBend&&h.value>0?(this.bendType=J.PrebendBend,a.splice(2,1),a.splice(1,1)):(this.bendType=J.Bend,a.splice(2,1),a.splice(1,1)):u.value<h.value?this.isContinuedBend?(this.bendType=J.Release,a.splice(2,1),a.splice(1,1)):(this.bendType=J.PrebendRelease,a.splice(2,1),a.splice(1,1)):c.value>h.value?this.bendType=J.BendRelease:h.value>0&&!this.isContinuedBend?(this.bendType=J.Prebend,a.splice(2,1),a.splice(1,1)):(this.bendType=J.Hold,a.splice(2,1),a.splice(1,1)):L.warning("Model","Unsupported bend type detected, fallback to custom",null)}else if(a.length===3){const h=a[0],c=a[1],d=a[2];d.value>h.value?c.value>d.value?(this.bendType=J.BendRelease,a.splice(1,0,new H(c.offset,c.value))):!this.isContinuedBend&&h.value>0?(this.bendType=J.PrebendBend,a.splice(1,1)):(this.bendType=J.Bend,a.splice(1,1)):d.value<h.value?this.isContinuedBend?(this.bendType=J.Release,a.splice(1,1)):(this.bendType=J.PrebendRelease,a.splice(1,1)):c.value>h.value?(this.bendType=J.BendRelease,a.splice(1,0,new H(c.offset,c.value))):h.value>0&&!this.isContinuedBend?(this.bendType=J.Prebend,a.splice(1,1)):(this.bendType=J.Hold,a.splice(1,1))}else if(a.length===2){const h=a[0],c=a[1];c.value>h.value?!this.isContinuedBend&&h.value>0?this.bendType=J.PrebendBend:this.bendType=J.Bend:c.value<h.value?this.isContinuedBend?this.bendType=J.Release:this.bendType=J.PrebendRelease:h.value>0&&!this.isContinuedBend?this.bendType=J.Prebend:this.bendType=J.Hold}}this.initialBendValue>0&&(this.accidentalMode=de.Default)}static nextNoteOnSameLine(t){let e=t.beat.nextBeat;for(;e&&e.voice.bar.index<=t.beat.voice.bar.index+gs._maxOffsetForSameLineSearch;){const s=e.getNoteOnString(t.string);if(s)return s;e=e.nextBeat}return null}static findHammerPullDestination(t){let e=t.beat.nextBeat;for(;e&&e.voice.bar.index<=t.beat.voice.bar.index+gs._maxOffsetForSameLineSearch;){let s=e.getNoteOnString(t.string);if(s)return s;for(let i=t.string;i>0;i--)if(s=e.getNoteOnString(i),s){if(s.isLeftHandTapped)return s;break}for(let i=t.string;i<=t.beat.voice.bar.staff.tuning.length;i++)if(s=e.getNoteOnString(i),s){if(s.isLeftHandTapped)return s;break}e=e.nextBeat}return null}static findTieOrigin(t){let e=t.beat.previousBeat;for(;e&&e.voice.bar.index>=t.beat.voice.bar.index-gs._maxOffsetForSameLineSearch;){if(t.isStringed){const s=e.getNoteOnString(t.string);if(s)return s}else if(t.octave===-1&&t.tone===-1){if(t.index<e.notes.length)return e.notes[t.index]}else{const s=e.getNoteWithRealValue(t.realValue);if(s)return s}e=e.previousBeat}return null}chain(t=null){if(t!==null)if(this._noteIdBag!==null){let e;t.has(gs._noteIdLookupKey)?e=t.get(gs._noteIdLookupKey):(e=new Map,t.set(gs._noteIdLookupKey,e)),(this._noteIdBag.hammerPullDestinationNoteId!==-1||this._noteIdBag.tieDestinationNoteId!==-1||this._noteIdBag.slurDestinationNoteId!==-1||this._noteIdBag.slideTargetNoteId!==-1)&&e.set(this.id,this),this._noteIdBag.hammerPullOriginNoteId!==-1&&(this.hammerPullOrigin=e.get(this._noteIdBag.hammerPullOriginNoteId),this.hammerPullOrigin.hammerPullDestination=this),this._noteIdBag.tieOriginNoteId!==-1&&(this.tieOrigin=e.get(this._noteIdBag.tieOriginNoteId),this.tieOrigin.tieDestination=this),this._noteIdBag.slurOriginNoteId!==-1&&(this.slurOrigin=e.get(this._noteIdBag.slurOriginNoteId),this.slurOrigin.slurDestination=this),this._noteIdBag.slideOriginNoteId!==-1&&(this.slideOrigin=e.get(this._noteIdBag.slideOriginNoteId),this.slideOrigin.slideTarget=this),this._noteIdBag=null}else{if(!this.isTieDestination&&this.tieOrigin===null)return;const e=this.tieOrigin??gs.findTieOrigin(this);e?(e.tieDestination=this,this.tieOrigin=e,this.fret=e.fret,this.octave=e.octave,this.tone=e.tone,e.hasBend&&(this.bendOrigin=this.tieOrigin)):this.isTieDestination=!1}}toJson(t){this.tieDestination!==null&&t.set("tiedestinationnoteid",this.tieDestination.id),this.tieOrigin!==null&&t.set("tieoriginnoteid",this.tieOrigin.id),this.slurDestination!==null&&t.set("slurdestinationnoteid",this.slurDestination.id),this.slurOrigin!==null&&t.set("sluroriginnoteid",this.slurOrigin.id),this.hammerPullOrigin!==null&&t.set("hammerpulloriginnoteid",this.hammerPullOrigin.id),this.hammerPullDestination!==null&&t.set("hammerpulldestinationnoteid",this.hammerPullDestination.id),this.slideTarget!==null&&t.set("slidetargetnoteid",this.slideTarget.id),this.slideOrigin!==null&&t.set("slideoriginnoteid",this.slideOrigin.id)}setProperty(t,e){switch(t){case"tiedestinationnoteid":return this._noteIdBag==null&&(this._noteIdBag=new $i),this._noteIdBag.tieDestinationNoteId=e,!0;case"tieoriginnoteid":return this._noteIdBag==null&&(this._noteIdBag=new $i),this._noteIdBag.tieOriginNoteId=e,!0;case"slurdestinationnoteid":return this._noteIdBag==null&&(this._noteIdBag=new $i),this._noteIdBag.slurDestinationNoteId=e,!0;case"sluroriginnoteid":return this._noteIdBag==null&&(this._noteIdBag=new $i),this._noteIdBag.slurOriginNoteId=e,!0;case"hammerpulloriginnoteid":return this._noteIdBag==null&&(this._noteIdBag=new $i),this._noteIdBag.hammerPullOriginNoteId=e,!0;case"hammerpulldestinationnoteid":return this._noteIdBag==null&&(this._noteIdBag=new $i),this._noteIdBag.hammerPullDestinationNoteId=e,!0;case"slidetargetnoteid":return this._noteIdBag==null&&(this._noteIdBag=new $i),this._noteIdBag.slideTargetNoteId=e,!0;case"slideoriginnoteid":return this._noteIdBag==null&&(this._noteIdBag=new $i),this._noteIdBag.slideOriginNoteId=e,!0}return!1}};o(gs,"globalNoteId",0),o(gs,"_maxOffsetForSameLineSearch",3),o(gs,"_noteIdLookupKey","NoteIdLookup");let Ps=gs;const ts=class ts{constructor(t){o(this,"_isEqualLengthTuplet",!0);o(this,"totalDuration",0);o(this,"beats",[]);o(this,"voice");o(this,"isFull",!1);this.voice=t}check(t){if(this.beats.length===0)return this.beats.push(t),this.totalDuration+=t.playbackDuration,!0;if(t.graceType!==ee.None)return!0;if(t.voice!==this.voice||this.isFull||t.tupletNumerator!==this.beats[0].tupletNumerator||t.tupletDenominator!==this.beats[0].tupletDenominator)return!1;if(t.displayDuration!==this.beats[0].displayDuration&&(this._isEqualLengthTuplet=!1),this.beats.push(t),this.totalDuration+=t.displayDuration,this._isEqualLengthTuplet)this.beats.length===this.beats[0].tupletNumerator&&(this.isFull=!0);else{const e=this.beats[0].tupletNumerator/this.beats[0].tupletDenominator|0;for(const s of ts._allTicks)if(this.totalDuration===s*e){this.isFull=!0;break}}return!0}};o(ts,"_halfTicks",1920),o(ts,"_quarterTicks",960),o(ts,"_eighthTicks",480),o(ts,"_sixteenthTicks",240),o(ts,"_thirtySecondTicks",120),o(ts,"_sixtyFourthTicks",60),o(ts,"_oneHundredTwentyEighthTicks",30),o(ts,"_twoHundredFiftySixthTicks",15),o(ts,"_allTicks",[ts._halfTicks,ts._quarterTicks,ts._eighthTicks,ts._sixteenthTicks,ts._thirtySecondTicks,ts._sixtyFourthTicks,ts._oneHundredTwentyEighthTicks,ts._twoHundredFiftySixthTicks]);let pn=ts;var De;(function(n){n[n.None=0]="None",n[n.Custom=1]="Custom",n[n.Dive=2]="Dive",n[n.Dip=3]="Dip",n[n.Hold=4]="Hold",n[n.Predive=5]="Predive",n[n.PrediveDive=6]="PrediveDive"})(De||(De={}));var as;(function(n){n[n.None=0]="None",n[n.Thumb=1]="Thumb",n[n.Finger=2]="Finger"})(as||(as={}));var Nt;(function(n){n[n.None=0]="None",n[n.FadeIn=1]="FadeIn",n[n.FadeOut=2]="FadeOut",n[n.VolumeSwell=3]="VolumeSwell"})(Nt||(Nt={}));var ps;(function(n){n[n.None=0]="None",n[n.Open=1]="Open",n[n.Closed=2]="Closed"})(ps||(ps={}));var Hs;(function(n){n[n.None=0]="None",n[n.Full=1]="Full",n[n.Half=2]="Half"})(Hs||(Hs={}));var le;(function(n){n[n.None=0]="None",n[n.Ii=1]="Ii",n[n.Mi=2]="Mi",n[n.MiiTriplet=3]="MiiTriplet",n[n.MiiAnapaest=4]="MiiAnapaest",n[n.PmpTriplet=5]="PmpTriplet",n[n.PmpAnapaest=6]="PmpAnapaest",n[n.PeiTriplet=7]="PeiTriplet",n[n.PeiAnapaest=8]="PeiAnapaest",n[n.PaiTriplet=9]="PaiTriplet",n[n.PaiAnapaest=10]="PaiAnapaest",n[n.AmiTriplet=11]="AmiTriplet",n[n.AmiAnapaest=12]="AmiAnapaest",n[n.Ppp=13]="Ppp",n[n.Amii=14]="Amii",n[n.Amip=15]="Amip",n[n.Eami=16]="Eami",n[n.Eamii=17]="Eamii",n[n.Peami=18]="Peami"})(le||(le={}));var zi;(function(n){n[n.Default=0]="Default",n[n.BuzzRoll=1]="BuzzRoll"})(zi||(zi={}));class Ns{constructor(){o(this,"marks",0);o(this,"style",zi.Default)}getDuration(t){let e=this.marks;e<1&&(e=1);const i=t*Math.pow(2,e);return i<=b.TwoHundredFiftySixth?i:b.TwoHundredFiftySixth}getDurationAsTicks(t){let e=this.marks;e<1&&(e=1);const i=t*Math.pow(2,e);return D.valueToTicks(i)}}o(Ns,"minMarks",0),o(Ns,"maxMarks",5);var ot;(function(n){n[n.Auto=0]="Auto",n[n.ForceSplitToNext=1]="ForceSplitToNext",n[n.ForceMergeWithNext=2]="ForceMergeWithNext",n[n.ForceSplitOnSecondaryToNext=3]="ForceSplitOnSecondaryToNext"})(ot||(ot={}));var ht;(function(n){n[n.Effects=0]="Effects",n[n.StandardNotationStem=1]="StandardNotationStem",n[n.StandardNotationFlags=2]="StandardNotationFlags",n[n.StandardNotationBeams=3]="StandardNotationBeams",n[n.StandardNotationTuplet=4]="StandardNotationTuplet",n[n.StandardNotationEffects=5]="StandardNotationEffects",n[n.StandardNotationRests=6]="StandardNotationRests",n[n.GuitarTabStem=7]="GuitarTabStem",n[n.GuitarTabFlags=8]="GuitarTabFlags",n[n.GuitarTabBeams=9]="GuitarTabBeams",n[n.GuitarTabTuplet=10]="GuitarTabTuplet",n[n.GuitarTabEffects=11]="GuitarTabEffects",n[n.GuitarTabRests=12]="GuitarTabRests",n[n.SlashStem=13]="SlashStem",n[n.SlashFlags=14]="SlashFlags",n[n.SlashBeams=15]="SlashBeams",n[n.SlashTuplet=16]="SlashTuplet",n[n.SlashRests=17]="SlashRests",n[n.SlashEffects=18]="SlashEffects",n[n.NumberedDuration=19]="NumberedDuration",n[n.NumberedEffects=20]="NumberedEffects",n[n.NumberedRests=21]="NumberedRests",n[n.NumberedTuplet=22]="NumberedTuplet"})(ht||(ht={}));class yc extends Mr{}const Ur=class Ur{constructor(){o(this,"id",Ur._globalBeatId++);o(this,"index",0);o(this,"previousBeat",null);o(this,"nextBeat",null);o(this,"voice");o(this,"notes",[]);o(this,"noteStringLookup",new Map);o(this,"noteValueLookup",new Map);o(this,"isEmpty",!1);o(this,"whammyStyle",tt.Default);o(this,"ottava",pe.Regular);o(this,"fermata",null);o(this,"isLegatoOrigin",!1);o(this,"minNote",null);o(this,"maxNote",null);o(this,"maxStringNote",null);o(this,"minStringNote",null);o(this,"duration",b.Quarter);o(this,"isLetRing",!1);o(this,"isPalmMute",!1);o(this,"automations",[]);o(this,"dots",0);o(this,"fade",Nt.None);o(this,"lyrics",null);o(this,"pop",!1);o(this,"slap",!1);o(this,"tap",!1);o(this,"text",null);o(this,"slashed",!1);o(this,"deadSlapped",!1);o(this,"brushType",Y.None);o(this,"brushDuration",0);o(this,"tupletDenominator",-1);o(this,"tupletNumerator",-1);o(this,"tupletGroup",null);o(this,"isContinuedWhammy",!1);o(this,"whammyBarType",De.None);o(this,"whammyBarPoints",null);o(this,"maxWhammyPoint",null);o(this,"minWhammyPoint",null);o(this,"vibrato",Ee.None);o(this,"chordId",null);o(this,"graceType",ee.None);o(this,"graceGroup",null);o(this,"graceIndex",-1);o(this,"pickStroke",Ot.None);o(this,"tremoloPicking");o(this,"crescendo",Jt.None);o(this,"displayStart",0);o(this,"playbackStart",0);o(this,"displayDuration",0);o(this,"playbackDuration",0);o(this,"overrideDisplayDuration");o(this,"golpe",as.None);o(this,"dynamics",re.F);o(this,"invertBeamDirection",!1);o(this,"preferredBeamDirection",null);o(this,"isEffectSlurOrigin",!1);o(this,"effectSlurOrigin",null);o(this,"effectSlurDestination",null);o(this,"beamingMode",ot.Auto);o(this,"wahPedal",ps.None);o(this,"barreFret",-1);o(this,"barreShape",Hs.None);o(this,"rasgueado",le.None);o(this,"showTimer",!1);o(this,"timer",null);o(this,"style")}static resetIds(){Ur._globalBeatId=0}get isLastOfVoice(){return this.index===this.voice.beats.length-1}get isLegatoDestination(){return!!this.previousBeat&&this.previousBeat.isLegatoOrigin}get isRest(){return this.isEmpty||!this.deadSlapped&&this.notes.length===0}get isFullBarRest(){return this.isRest&&this.voice.beats.length===1&&this.duration===b.Whole}get fadeIn(){return this.fade===Nt.FadeIn}set fadeIn(t){this.fade=t?Nt.FadeIn:Nt.None}get hasRasgueado(){return this.rasgueado!==le.None}get hasTuplet(){return!(this.tupletDenominator===-1&&this.tupletNumerator===-1)&&!(this.tupletDenominator===1&&this.tupletNumerator===1)}get hasWhammyBar(){return this.whammyBarPoints!==null&&this.whammyBarType!==De.None}get hasChord(){return!!this.chordId}get chord(){return this.chordId?this.voice.bar.staff.getChord(this.chordId):null}get isTremolo(){return this.tremoloPicking!==void 0}get tremoloSpeed(){const t=this.tremoloPicking;return t?t.getDuration(this.duration):null}set tremoloSpeed(t){if(t===null){this.tremoloPicking=void 0;return}let e=this.tremoloPicking;switch(e===void 0&&(e=new Ns,this.tremoloPicking=e),t){case b.Eighth:e.marks=1;break;case b.Sixteenth:e.marks=2;break;case b.ThirtySecond:e.marks=3;break;case b.SixtyFourth:e.marks=4;break;case b.OneHundredTwentyEighth:e.marks=5;break}}get displayEnd(){return this.displayStart+this.displayDuration}get absoluteDisplayStart(){return this.voice.bar.masterBar.start+this.displayStart}get absolutePlaybackStart(){return this.voice.bar.masterBar.start+this.playbackStart}get isEffectSlurDestination(){return!!this.effectSlurOrigin}get isBarre(){return this.barreShape!==Hs.None&&this.barreFret>=0}addWhammyBarPoint(t){let e=this.whammyBarPoints;e===null&&(e=[],this.whammyBarPoints=e),e.push(t),(!this.maxWhammyPoint||t.value>this.maxWhammyPoint.value)&&(this.maxWhammyPoint=t),(!this.minWhammyPoint||t.value<this.minWhammyPoint.value)&&(this.minWhammyPoint=t),this.whammyBarType===De.None&&(this.whammyBarType=De.Custom)}removeWhammyBarPoint(t){const e=this.whammyBarPoints;if(e===null||t<0||t>=e.length)return;e.splice(t,1);const s=e[t];if(s===this.maxWhammyPoint){this.maxWhammyPoint=null;for(const i of e)(!this.maxWhammyPoint||i.value>this.maxWhammyPoint.value)&&(this.maxWhammyPoint=i)}if(s===this.minWhammyPoint){this.minWhammyPoint=null;for(const i of e)(!this.minWhammyPoint||i.value<this.minWhammyPoint.value)&&(this.minWhammyPoint=i)}}addNote(t){t.beat=this,t.index=this.notes.length,this.notes.push(t),t.isStringed&&this.noteStringLookup.set(t.string,t)}removeNote(t){const e=this.notes.indexOf(t);e>=0&&(this.notes.splice(e,1),t.isStringed&&this.noteStringLookup.delete(t.string))}getAutomation(t){for(let e=0,s=this.automations.length;e<s;e++){const i=this.automations[e];if(i.type===t)return i}return null}getNoteOnString(t){return this.noteStringLookup.has(t)?this.noteStringLookup.get(t):null}_calculateDuration(){if(this.overrideDisplayDuration!==void 0)return this.overrideDisplayDuration;if(this.isFullBarRest)return this.voice.bar.masterBar.calculateDuration();let t=D.toTicks(this.duration);return this.dots===2?t=D.applyDot(t,!0):this.dots===1&&(t=D.applyDot(t,!1)),this.tupletDenominator>0&&this.tupletNumerator>=0&&(t=D.applyTuplet(t,this.tupletNumerator,this.tupletDenominator)),t}updateDurations(){const t=this._calculateDuration();switch(this.playbackDuration=t,this.graceType){case ee.BeforeBeat:case ee.OnBeat:switch(this.duration){case b.Sixteenth:this.playbackDuration=D.toTicks(b.SixtyFourth);break;case b.ThirtySecond:this.playbackDuration=D.toTicks(b.OneHundredTwentyEighth);break;default:this.playbackDuration=D.toTicks(b.ThirtySecond);break}this.displayDuration=0;break;case ee.BendGrace:this.playbackDuration/=2,this.displayDuration=0;break;default:this.displayDuration=t;const e=this.previousBeat;e&&e.graceType===ee.BendGrace&&(this.playbackDuration=e.playbackDuration);break}}finishTuplet(){const t=this.previousBeat;let e=t?t.tupletGroup:null;(this.hasTuplet||this.graceType!==ee.None&&e)&&((!t||!e||!e.check(this))&&(e=new pn(this.voice),e.check(this)),this.tupletGroup=e);const s=this.voice.bar.masterBar.calculateDuration(!1),i=[];for(const r of this.automations)r.ratioPosition===0&&(r.ratioPosition=this.playbackStart/s),r.type!==Ve.Tempo&&i.push(r);this.automations=i}finish(t,e=null){switch(this.getAutomation(Ve.Instrument)===null&&this.index===0&&this.voice.index===0&&this.voice.bar.index===0&&this.voice.bar.staff.index===0&&this.automations.push(nt.buildInstrumentAutomation(!1,0,this.voice.bar.staff.track.playbackInfo.program)),this.graceType){case ee.OnBeat:case ee.BeforeBeat:const u=this.graceGroup.beats.length;u===1?this.duration=b.Eighth:u===2?this.duration=b.Sixteenth:this.duration=b.ThirtySecond;break}this.brushType===Y.None&&(this.brushDuration=0);const s=this.tremoloPicking;s!==void 0&&(s.marks<Ns.minMarks||s.marks>Ns.maxMarks)&&(this.tremoloPicking=void 0);const i=t?t.notation.notationMode:Xt.GuitarPro;let r=this.text==="grad"||this.text==="grad.";r&&i===Xt.SongBook&&(this.text="");let a=!1;this.minNote=null,this.maxNote=null,this.minStringNote=null,this.maxStringNote=null;let l=0,h=!1;for(let u=0,p=this.notes.length;u<p;u++){const g=this.notes[u];if(g.dynamics=this.dynamics,g.finish(t,e),g.isLetRing&&(this.isLetRing=!0),g.isPalmMute&&(this.isPalmMute=!0),i===Xt.SongBook&&g.hasBend&&this.graceType!==ee.BendGrace){if(!g.isTieOrigin)switch(g.bendType){case J.Bend:case J.PrebendRelease:case J.PrebendBend:a=!0;break}r||g.bendStyle===tt.Gradual?(r=!0,g.bendStyle=tt.Gradual,a=!1):g.bendStyle=tt.Fast}g.isVisible&&(l++,(!this.minNote||g.realValue<this.minNote.realValue)&&(this.minNote=g),(!this.maxNote||g.realValue>this.maxNote.realValue)&&(this.maxNote=g),(!this.minStringNote||g.string<this.minStringNote.string)&&(this.minStringNote=g),(!this.maxStringNote||g.string>this.maxStringNote.string)&&(this.maxStringNote=g),g.hasEffectSlur&&(h=!0))}if(h&&(this.effectSlurOrigin?(this.effectSlurOrigin.effectSlurDestination=this.nextBeat,this.effectSlurOrigin.effectSlurDestination&&(this.effectSlurOrigin.effectSlurDestination.effectSlurOrigin=this.effectSlurOrigin),this.effectSlurOrigin=null):(this.isEffectSlurOrigin=!0,this.effectSlurDestination=this.nextBeat,this.effectSlurDestination&&(this.effectSlurDestination.effectSlurOrigin=this))),this.notes.length>0&&l===0&&(this.isEmpty=!0),!this.isRest&&(!this.isLetRing||!this.isPalmMute)){let u=this.previousBeat;for(;u&&u.isRest;)this.isLetRing||(u.isLetRing=!1),this.isPalmMute||(u.isPalmMute=!1),u=u.previousBeat}else this.isRest&&this.previousBeat&&t&&t.notation.notationMode===Xt.GuitarPro&&(this.previousBeat.isLetRing&&(this.isLetRing=!0),this.previousBeat.isPalmMute&&(this.isPalmMute=!0));const c=this.whammyBarPoints,d=c!==null&&c.length>0;if(d){const u=!!this.previousBeat&&this.previousBeat.hasWhammyBar;this.isContinuedWhammy=u}else this.whammyBarType=De.None;if(d&&this.whammyBarType===De.Custom){if(i===Xt.SongBook&&(this.whammyStyle=r?tt.Gradual:tt.Fast),c.length===4){const u=c[0],p=c[1],g=c[2],m=c[3];p.value===g.value&&(u.value<p.value&&p.value<m.value||u.value>p.value&&p.value>m.value?(u.value!==0&&!this.isContinuedWhammy?this.whammyBarType=De.PrediveDive:this.whammyBarType=De.Dive,c.splice(2,1),c.splice(1,1)):u.value>p.value&&p.value<m.value||u.value<p.value&&p.value>m.value?(this.whammyBarType=De.Dip,(p.offset===g.offset||i===Xt.SongBook)&&c.splice(2,1)):u.value===p.value&&p.value===m.value&&(u.value!==0&&!this.isContinuedWhammy?this.whammyBarType=De.Predive:this.whammyBarType=De.Hold,c.splice(2,1),c.splice(1,1)))}else if(c.length===3){const u=c[0],p=c[1],g=c[2];u.value<p.value&&p.value<g.value||u.value>p.value&&p.value>g.value?(u.value!==0&&!this.isContinuedWhammy?this.whammyBarType=De.PrediveDive:this.whammyBarType=De.Dive,c.splice(1,1)):u.value>p.value&&p.value<g.value||u.value<p.value&&p.value>g.value?this.whammyBarType=De.Dip:u.value===p.value&&p.value===g.value&&(u.value!==0&&!this.isContinuedWhammy?this.whammyBarType=De.Predive:this.whammyBarType=De.Hold,c.splice(1,1))}else if(c.length===2){const u=c[0],p=c[1];u.value<p.value||u.value>p.value?u.value!==0&&!this.isContinuedWhammy?this.whammyBarType=De.PrediveDive:this.whammyBarType=De.Dive:u.value===p.value&&(u.value!==0&&!this.isContinuedWhammy?this.whammyBarType=De.Predive:this.whammyBarType=De.Hold)}}if(this.updateDurations(),a){const u=Rl.clone(this);u.id=Ur._globalBeatId++,u.pickStroke=Ot.None;for(let p=0,g=u.notes.length;p<g;p++){const m=u.notes[p],y=this.notes[p];if(m.bendType=J.None,m.maxBendPoint=null,m.bendPoints=null,m.bendStyle=tt.Default,m.id=Ps.globalNoteId++,y.isTieOrigin&&(m.tieDestination=y.tieDestination,y.tieDestination.tieOrigin=m),y.isTieDestination&&(m.tieOrigin=y.tieOrigin?y.tieOrigin:null,y.tieOrigin.tieDestination=m),y.hasBend&&y.isTieOrigin){const S=Ps.findTieOrigin(y);if(S&&S.hasBend){m.bendType=J.Hold;const k=y.bendPoints[y.bendPoints.length-1];m.addBendPoint(new H(0,k.value)),m.addBendPoint(new H(H.MaxPosition,k.value))}}m.isTieDestination=!0}this.graceType=ee.BendGrace,this.graceGroup=new fn,this.graceGroup.addBeat(this),this.graceGroup.isComplete=!0,this.graceGroup.finish(),this.updateDurations(),this.voice.insertBeat(this,u),u.graceGroup=new fn,u.graceGroup.addBeat(this),u.graceGroup.isComplete=!0,u.graceGroup.finish()}}isBefore(t){return this.voice.bar.index<t.voice.bar.index||t.voice.bar.index===this.voice.bar.index&&this.index<t.index}isAfter(t){return this.voice.bar.index>t.voice.bar.index||t.voice.bar.index===this.voice.bar.index&&this.index>t.index}hasNoteOnString(t){return this.noteStringLookup.has(t)}getNoteWithRealValue(t){return this.noteValueLookup.has(t)?this.noteValueLookup.get(t):null}chain(t=null){for(const e of this.notes)this.noteValueLookup.set(e.realValue,e),e.chain(t)}};o(Ur,"_globalBeatId",0);let qt=Ur;class bc{static clone(t){const e=new H;return e.offset=t.offset,e.value=t.value,e}}class Sc{static clone(t){const e=new Ps;if(e.index=t.index,e.accentuated=t.accentuated,e.bendType=t.bendType,e.bendStyle=t.bendStyle,e.isContinuedBend=t.isContinuedBend,t.bendPoints){e.bendPoints=[];for(const s of t.bendPoints)e.addBendPoint(bc.clone(s))}return e.fret=t.fret,e.string=t.string,e.showStringNumber=t.showStringNumber,e.octave=t.octave,e.tone=t.tone,e.percussionArticulation=t.percussionArticulation,e.isVisible=t.isVisible,e.isLeftHandTapped=t.isLeftHandTapped,e.isHammerPullOrigin=t.isHammerPullOrigin,e.isSlurDestination=t.isSlurDestination,e.harmonicType=t.harmonicType,e.harmonicValue=t.harmonicValue,e.isGhost=t.isGhost,e.isLetRing=t.isLetRing,e.isPalmMute=t.isPalmMute,e.isDead=t.isDead,e.isStaccato=t.isStaccato,e.slideInType=t.slideInType,e.slideOutType=t.slideOutType,e.vibrato=t.vibrato,e.isTieDestination=t.isTieDestination,e.leftHandFinger=t.leftHandFinger,e.rightHandFinger=t.rightHandFinger,e.trillValue=t.trillValue,e.trillSpeed=t.trillSpeed,e.durationPercent=t.durationPercent,e.accidentalMode=t.accidentalMode,e.dynamics=t.dynamics,e.ornament=t.ornament,e}}class td{static clone(t){const e=new ja;return e.barOccurence=t.barOccurence,e.millisecondOffset=t.millisecondOffset,e}}class sd{static clone(t){const e=new nt;return e.isLinear=t.isLinear,e.type=t.type,e.value=t.value,e.syncPointValue=t.syncPointValue?td.clone(t.syncPointValue):void 0,e.ratioPosition=t.ratioPosition,e.text=t.text,e.isVisible=t.isVisible,e}}class id{static clone(t){const e=new Ns;return e.marks=t.marks,e.style=t.style,e}}class Rl{static clone(t){const e=new qt;e.index=t.index,e.notes=[];for(const s of t.notes)e.addNote(Sc.clone(s));e.isEmpty=t.isEmpty,e.whammyStyle=t.whammyStyle,e.ottava=t.ottava,e.isLegatoOrigin=t.isLegatoOrigin,e.duration=t.duration,e.isLetRing=t.isLetRing,e.isPalmMute=t.isPalmMute,e.automations=[];for(const s of t.automations)e.automations.push(sd.clone(s));if(e.dots=t.dots,e.fade=t.fade,e.lyrics=t.lyrics?t.lyrics.slice():null,e.pop=t.pop,e.slap=t.slap,e.tap=t.tap,e.text=t.text,e.slashed=t.slashed,e.deadSlapped=t.deadSlapped,e.brushType=t.brushType,e.brushDuration=t.brushDuration,e.tupletDenominator=t.tupletDenominator,e.tupletNumerator=t.tupletNumerator,e.isContinuedWhammy=t.isContinuedWhammy,e.whammyBarType=t.whammyBarType,t.whammyBarPoints){e.whammyBarPoints=[];for(const s of t.whammyBarPoints)e.addWhammyBarPoint(bc.clone(s))}return e.vibrato=t.vibrato,e.chordId=t.chordId,e.graceType=t.graceType,e.pickStroke=t.pickStroke,e.tremoloPicking=t.tremoloPicking?id.clone(t.tremoloPicking):void 0,e.crescendo=t.crescendo,e.displayStart=t.displayStart,e.playbackStart=t.playbackStart,e.displayDuration=t.displayDuration,e.playbackDuration=t.playbackDuration,e.overrideDisplayDuration=t.overrideDisplayDuration,e.golpe=t.golpe,e.dynamics=t.dynamics,e.invertBeamDirection=t.invertBeamDirection,e.preferredBeamDirection=t.preferredBeamDirection,e.isEffectSlurOrigin=t.isEffectSlurOrigin,e.beamingMode=t.beamingMode,e.wahPedal=t.wahPedal,e.barreFret=t.barreFret,e.barreShape=t.barreShape,e.rasgueado=t.rasgueado,e.showTimer=t.showTimer,e.timer=t.timer,e}}const z=class z{static _reverse(t){const e=new Map;for(const[s,i]of t)e.has(i)||e.set(i,s);return e}};o(z,"whammyType",new Map([["custom",1],["dive",2],["dip",3],["hold",4],["predive",5],["predivedive",6]])),o(z,"whammyTypeReversed",z._reverse(z.whammyType)),o(z,"bendStyle",new Map([["default",0],["gradual",1],["fast",2]])),o(z,"bendStyleReversed",z._reverse(z.bendStyle)),o(z,"graceType",new Map([["onbeat",1],["beforebeat",2],["bendgrace",3],["ob",1],["bb",2],["b",3]])),o(z,"graceTypeReversed",z._reverse(z.graceType)),o(z,"fermataType",new Map([["short",0],["medium",1],["long",2]])),o(z,"fermataTypeReversed",z._reverse(z.fermataType)),o(z,"alphaTexAccidentalMode",new Map([["auto",0],["explicit",1]])),o(z,"alphaTexAccidentalModeReversed",z._reverse(z.alphaTexAccidentalMode)),o(z,"alphaTexVoiceMode",new Map([["staffwise",0],["barwise",1]])),o(z,"alphaTexVoiceModeReversed",z._reverse(z.alphaTexVoiceMode)),o(z,"noteAccidentalMode",new Map([["default",0],["forcenone",1],["forcenatural",2],["forcesharp",3],["forcedoublesharp",4],["forceflat",5],["forcedoubleflat",6],["d",0],["-",1],["n",2],["#",3],["##",4],["x",4],["b",5],["bb",6]])),o(z,"noteAccidentalModeReversed",z._reverse(z.noteAccidentalMode)),o(z,"barreShape",new Map([["full",1],["half",2]])),o(z,"barreShapeReversed",z._reverse(z.barreShape)),o(z,"ottavia",new Map([["15ma",0],["8va",1],["regular",2],["8vb",3],["15mb",4],["15ma",0],["8va",1],["8vb",3],["15mb",4]])),o(z,"ottaviaReversed",z._reverse(z.ottavia)),o(z,"rasgueado",new Map([["ii",1],["mi",2],["miitriplet",3],["miianapaest",4],["pmptriplet",5],["pmpanapaest",6],["peitriplet",7],["peianapaest",8],["paitriplet",9],["paianapaest",10],["amitriplet",11],["amianapaest",12],["ppp",13],["amii",14],["amip",15],["eami",16],["eamii",17],["peami",18]])),o(z,"rasgueadoReversed",z._reverse(z.rasgueado)),o(z,"dynamicValue",new Map([["ppp",0],["pp",1],["p",2],["mp",3],["mf",4],["f",5],["ff",6],["fff",7],["pppp",8],["ppppp",9],["pppppp",10],["ffff",11],["fffff",12],["ffffff",13],["sf",14],["sfp",15],["sfpp",16],["fp",17],["rf",18],["rfz",19],["sfz",20],["sffz",21],["fz",22],["n",23],["pf",24],["sfzp",25]])),o(z,"dynamicValueReversed",z._reverse(z.dynamicValue)),o(z,"bracketExtendMode",new Map([["nobrackets",0],["groupstaves",1],["groupsimilarinstruments",2]])),o(z,"bracketExtendModeReversed",z._reverse(z.bracketExtendMode)),o(z,"trackNamePolicy",new Map([["hidden",0],["firstsystem",1],["allsystems",2]])),o(z,"trackNamePolicyReversed",z._reverse(z.trackNamePolicy)),o(z,"trackNameOrientation",new Map([["horizontal",0],["vertical",1]])),o(z,"trackNameOrientationReversed",z._reverse(z.trackNameOrientation)),o(z,"trackNameMode",new Map([["fullname",0],["shortname",1]])),o(z,"trackNameModeReversed",z._reverse(z.trackNameMode)),o(z,"textAlign",new Map([["left",0],["center",1],["right",2]])),o(z,"textAlignReversed",z._reverse(z.textAlign)),o(z,"bendType",new Map([["custom",1],["bend",2],["release",3],["bendrelease",4],["hold",5],["prebend",6],["prebendbend",7],["prebendrelease",8]])),o(z,"bendTypeReversed",z._reverse(z.bendType)),o(z,"keySignature",new Map([["cb",-7],["gb",-6],["db",-5],["ab",-4],["eb",-3],["bb",-2],["f",-1],["c",0],["g",1],["d",2],["a",3],["e",4],["b",5],["f#",6],["c#",7],["cbmajor",-7],["abminor",-7],["gbmajor",-6],["ebminor",-6],["dbmajor",-5],["bbminor",-5],["abmajor",-4],["fminor",-4],["ebmajor",-3],["cminor",-3],["bbmajor",-2],["gminor",-2],["fmajor",-1],["dminor",-1],["cmajor",0],["aminor",0],["gmajor",1],["eminor",1],["dmajor",2],["bminor",2],["amajor",3],["f#minor",3],["emajor",4],["c#minor",4],["bmajor",5],["g#minor",5],["f#major",6],["d#minor",6],["f#",6],["c#major",7],["a#minor",7],["c#",7]])),o(z,"keySignatureReversed",z._reverse(z.keySignature)),o(z,"keySignatureType",new Map([["major",0],["minor",1],["cb",0],["cbmajor",0],["gb",0],["gbmajor",0],["db",0],["dbmajor",0],["ab",0],["abmajor",0],["eb",0],["ebmajor",0],["bb",0],["bbmajor",0],["f",0],["fmajor",0],["c",0],["cmajor",0],["g",0],["gmajor",0],["d",0],["dmajor",0],["a",0],["amajor",0],["e",0],["emajor",0],["b",0],["bmajor",0],["f#",0],["f#major",0],["c#",0],["c#major",0],["abminor",1],["ebminor",1],["bbminor",1],["fminor",1],["cminor",1],["gminor",1],["dminor",1],["aminor",1],["eminor",1],["bminor",1],["f#minor",1],["c#minor",1],["g#minor",1],["d#minor",1],["a#minor",1]])),o(z,"keySignatureTypeReversed",z._reverse(z.keySignatureType)),o(z,"clef",new Map([["neutral",0],["c3",1],["c4",2],["f4",3],["g2",4],["n",0],["alto",1],["tenor",2],["bass",3],["treble",4]])),o(z,"clefReversed",z._reverse(z.clef)),o(z,"tripletFeel",new Map([["none",0],["triplet16th",1],["triplet8th",2],["dotted16th",3],["dotted8th",4],["scottish16th",5],["scottish8th",6],["none",0],["no",0],["notripletfeel",0],["t16",1],["triplet-16th",1],["t8",2],["triplet-8th",2],["d16",3],["dotted-16th",3],["d8",4],["dotted-8th",4],["s16",5],["scottish-16th",5],["s8",6],["scottish-8th",6]])),o(z,"tripletFeelReversed",z._reverse(z.tripletFeel)),o(z,"barLineStyle",new Map([["automatic",0],["dashed",1],["dotted",2],["heavy",3],["heavyheavy",4],["heavylight",5],["lightheavy",6],["lightlight",7],["none",8],["regular",9],["short",10],["tick",11]])),o(z,"barLineStyleReversed",z._reverse(z.barLineStyle)),o(z,"simileMark",new Map([["none",0],["simple",1],["firstofdouble",2],["secondofdouble",3]])),o(z,"simileMarkReversed",z._reverse(z.simileMark)),o(z,"direction",new Map([["fine",0],["segno",1],["segnosegno",2],["coda",3],["doublecoda",4],["dacapo",5],["dacapoalcoda",6],["dacapoaldoublecoda",7],["dacapoalfine",8],["dalsegno",9],["dalsegnoalcoda",10],["dalsegnoaldoublecoda",11],["dalsegnoalfine",12],["dalsegnosegno",13],["dalsegnosegnoalcoda",14],["dalsegnosegnoaldoublecoda",15],["dalsegnosegnoalfine",16],["dacoda",17],["dadoublecoda",18]])),o(z,"directionReversed",z._reverse(z.direction)),o(z,"tremoloPickingStyle",new Map([["default",0],["buzzroll",1]])),o(z,"tremoloPickingStyleReversed",z._reverse(z.tremoloPickingStyle)),o(z,"barNumberDisplay",new Map([["allbars",0],["firstofsystem",1],["hide",2]])),o(z,"barNumberDisplayReversed",z._reverse(z.barNumberDisplay)),o(z,"keySignaturesMinorReversed",new Map([[-7,"abminor"],[-6,"ebminor"],[-5,"bbminor"],[-4,"fminor"],[-3,"cminor"],[-2,"gminor"],[-1,"dminor"],[0,"aminor"],[1,"eminor"],[2,"bminor"],[3,"f#minor"],[4,"c#minor"],[5,"g#minor"],[6,"d#minor"],[7,"a#minor"]])),o(z,"keySignaturesMajorReversed",new Map([[-7,"cb"],[-6,"gb"],[-5,"db"],[-4,"ab"],[-3,"eb"],[-2,"bb"],[-1,"f"],[0,"c"],[1,"g"],[2,"d"],[3,"a"],[4,"e"],[5,"b"],[6,"f#"],[7,"c#"]]));let ue=z;const vt=class vt{static _param(t){return t?{expectedTypes:new Set(t[0]),parseMode:t[1],allowedValues:t.length>2&&t[2]&&t[2].length>0?new Set(t[2]):void 0,reservedIdentifiers:t.length>3&&t[3]&&t[3].length>0?new Set(t[3]):void 0}:null}static _simple(t){return t==null?null:t.map(e=>({isStrict:e.length>0&&e[0]===null,parameters:e.map(vt._param).filter(s=>s!==null)}))}static _metaProps(t){return new Map(t.map(e=>[e[0],e[1]===null?null:new Map(e[1].map(s=>[s[0],vt._simple(s[1])]))]))}static _props(t){return new Map(t.map(e=>[e[0],vt._simple(e[1])]))}static _signatures(t){return new Map(t.map(e=>[e[0],vt._simple(e[1])]))}};o(vt,"scoreMetaDataSignatures",vt._signatures([["title",[[[[17,10],0],[[17],1],[[10,17],1,["left","center","right"]]]]],["subtitle",[[[[17,10],0],[[17],1],[[10,17],1,["left","center","right"]]]]],["artist",[[[[17,10],0],[[17],1],[[10,17],1,["left","center","right"]]]]],["album",[[[[17,10],0],[[17],1],[[10,17],1,["left","center","right"]]]]],["words",[[[[17,10],0],[[17],1],[[10,17],1,["left","center","right"]]]]],["music",[[[[17,10],0],[[17],1],[[10,17],1,["left","center","right"]]]]],["wordsandmusic",[[[[17],0],[[10,17],1,["left","center","right"]]]]],["copyright",[[[[17,10],0],[[17],1],[[10,17],1,["left","center","right"]]]]],["copyright2",[[[[17],0],[[10,17],1,["left","center","right"]]]]],["instructions",[[[[17,10],0]]]],["notices",[[[[17,10],0]]]],["tab",[[[[17,10],0],[[17],1],[[10,17],1,["left","center","right"]]]]],["systemslayout",[[[[16],5]]]],["defaultsystemslayout",[[[[16],0]]]],["showdynamics",null],["hidedynamics",null],["usesystemsignseparator",null],["multibarrest",null],["bracketextendmode",[[[[10,17],0,["nobrackets","groupstaves","groupsimilarinstruments"]]]]],["singletracktracknamepolicy",[[[[10,17],0,["hidden","firstsystem","allsystems"]]]]],["multitracktracknamepolicy",[[[[10,17],0,["hidden","firstsystem","allsystems"]]]]],["firstsystemtracknamemode",[[[[10,17],0,["fullname","shortname"]]]]],["othersystemstracknamemode",[[[[10,17],0,["fullname","shortname"]]]]],["firstsystemtracknameorientation",[[[[10,17],0,["horizontal","vertical"]]]]],["othersystemstracknameorientation",[[[[10,17],0,["horizontal","vertical"]]]]],["extendbarlines",null],["chorddiagramsinscore",[[[[10],1,["true","false"]]]]],["hideemptystaves",null],["hideemptystavesinfirstsystem",null],["showsinglestaffbrackets",null],["defaultbarnumberdisplay",[[[[10,17],0,["allbars","firstofsystem","hide"]]]]]])),o(vt,"staffMetaDataSignatures",vt._signatures([["tuning",[[[[10,17],0,["piano","none","voice"]]],[[[10,17],5]]]],["chord",[[[[17,10],0],[[10,17,16],5]]]],["capo",[[[[16],0]]]],["lyrics",[[[[17],0]],[[[16],0],[[17],0]]]],["articulation",[[[[10],0,["defaults"]]],[[[17,10],0],[[16],0]]]],["displaytranspose",[[[[16],0]]]],["transpose",[[[[16],0]]]],["instrument",[[[[16],0]],[[[17,10],0]],[[[10],0,["percussion"]]]]]])),o(vt,"structuralMetaDataSignatures",vt._signatures([["track",[[[[17],1],[[17],1]]]],["staff",null],["voice",null]])),o(vt,"barMetaDataSignatures",vt._signatures([["ts",[[[[10,17],0,["common"]]],[[[16],0],[[16],0]]]],["ro",null],["rc",[[[[16],0]]]],["ae",[[[[16,13],4]]]],["ks",[[[[10,17],0,["cb","gb","db","ab","eb","bb","f","c","g","d","a","e","b","f#","c#","cbmajor","abminor","gbmajor","ebminor","dbmajor","bbminor","abmajor","fminor","ebmajor","cminor","bbmajor","gminor","fmajor","dminor","cmajor","aminor","gmajor","eminor","dmajor","bminor","amajor","f#minor","emajor","c#minor","bmajor","g#minor","f#major","d#minor","f#","c#major","a#minor","c#"]]]]],["clef",[[[[10,16,17],0,["neutral","c3","c4","f4","g2","n","alto","tenor","bass","treble"]]]]],["ottava",[[[[10,17],0,["15ma","8va","regular","8vb","15mb","15ma","8va","8vb","15mb"]]]]],["tempo",[[[[16],2],[[17],1]],[null,[[16],2],[[17],0],[[16],1],[[10],1,["hide"]]]]],["tf",[[[[10,16,17],0,["none","triplet16th","triplet8th","dotted16th","dotted8th","scottish16th","scottish8th","none","no","notripletfeel","t16","triplet-16th","t8","triplet-8th","d16","dotted-16th","d8","dotted-8th","s16","scottish-16th","s8","scottish-8th"]]]]],["ac",null],["section",[[[[17,10],0]],[[[17,10],0],[[17,10],0,null,["x","-","r"]]]]],["jump",[[[[10,17],0,["fine","segno","segnosegno","coda","doublecoda","dacapo","dacapoalcoda","dacapoaldoublecoda","dacapoalfine","dalsegno","dalsegnoalcoda","dalsegnoaldoublecoda","dalsegnoalfine","dalsegnosegno","dalsegnosegnoalcoda","dalsegnosegnoaldoublecoda","dalsegnosegnoalfine","dacoda","dadoublecoda"]]]]],["ft",null],["simile",[[[[10,17],0,["none","simple","firstofdouble","secondofdouble"]]]]],["barlineleft",[[[[10,17],0,["automatic","dashed","dotted","heavy","heavyheavy","heavylight","lightheavy","lightlight","none","regular","short","tick"]]]]],["barlineright",[[[[10,17],0,["automatic","dashed","dotted","heavy","heavyheavy","heavylight","lightheavy","lightlight","none","regular","short","tick"]]]]],["scale",[[[[16],2]]]],["width",[[[[16],2]]]],["sync",[[[[16],0],[[16],0],[[16],0],[[16],3]]]],["accidentals",[[[[10,17],0,["auto","explicit"]]]]],["spd",[[[[16],2]]]],["sph",[[[[16],2]]]],["spu",[[[[16],2]]]],["db",null],["voicemode",[[[[10,17],0,["staffwise","barwise"]]]]],["barnumberdisplay",[[[[10,17],0,["allbars","firstofsystem","hide"]]]]],["beaming",[[[[16],0],[[16],5]]]]])),o(vt,"metaDataProperties",vt._metaProps([["track",[["color",[[[[17],0]]]],["systemslayout",[[[[16],5]]]],["defaultsystemslayout",[[[[16],0]]]],["solo",null],["mute",null],["volume",[[[[16],0]]]],["balance",[[[[16],0]]]],["instrument",[[[[16],0]],[[[17,10],0]],[[[10],0,["percussion"]]]]],["bank",[[[[16],0]]]],["multibarrest",null]]],["staff",[["score",[[[[16],1]]]],["tabs",null],["slash",null],["numbered",null]]],["voice",null],["title",null],["subtitle",null],["artist",null],["album",null],["words",null],["music",null],["wordsandmusic",null],["copyright",null],["copyright2",null],["instructions",null],["notices",null],["tab",null],["systemslayout",null],["defaultsystemslayout",null],["showdynamics",null],["hidedynamics",null],["usesystemsignseparator",null],["multibarrest",null],["bracketextendmode",null],["singletracktracknamepolicy",null],["multitracktracknamepolicy",null],["firstsystemtracknamemode",null],["othersystemstracknamemode",null],["firstsystemtracknameorientation",null],["othersystemstracknameorientation",null],["extendbarlines",null],["chorddiagramsinscore",null],["hideemptystaves",null],["hideemptystavesinfirstsystem",null],["showsinglestaffbrackets",null],["defaultbarnumberdisplay",null],["tuning",[["hide",null],["label",[[[[17],0]]]]]],["chord",[["firstfret",[[[[16],0]]]],["barre",[[[[16],5]]]],["showdiagram",[[],[[[17],0,["true","false"]]],[[[10],0,["true","false"]]],[[[16],0,["1","0"]]]]],["showfingering",[[],[[[17],0,["true","false"]]],[[[10],0,["true","false"]]],[[[16],0,["1","0"]]]]],["showname",[[],[[[17],0,["true","false"]]],[[[10],0,["true","false"]]],[[[16],0,["1","0"]]]]]]],["capo",null],["lyrics",null],["articulation",null],["displaytranspose",null],["transpose",null],["instrument",null],["ts",null],["ro",null],["rc",null],["ae",null],["ks",null],["clef",null],["ottava",null],["tempo",null],["tf",null],["ac",null],["section",null],["jump",null],["ft",null],["simile",null],["barlineleft",null],["barlineright",null],["scale",null],["width",null],["sync",null],["accidentals",null],["spd",null],["sph",null],["spu",null],["db",null],["voicemode",null],["barnumberdisplay",null],["beaming",null]])),o(vt,"metaDataSignatures",[vt.scoreMetaDataSignatures,vt.staffMetaDataSignatures,vt.structuralMetaDataSignatures,vt.barMetaDataSignatures]),o(vt,"durationChangeProperties",vt._props([["tu",[[[[16],0,["3","5","6","7","9","10","12"]]],[[[16],0],[[16],0]]]]])),o(vt,"beatProperties",vt._props([["f",null],["fo",null],["vs",null],["v",null],["vw",null],["s",null],["p",null],["tt",null],["d",null],["dd",null],["su",null],["sd",null],["cre",null],["dec",null],["spd",null],["sph",null],["spu",null],["spe",null],["slashed",null],["ds",null],["glpf",null],["glpt",null],["waho",null],["wahc",null],["legatoorigin",null],["timer",null],["tu",[[[[16],0,["3","5","6","7","9","10","12"]]],[[[16],0],[[16],0]]]],["txt",[[[[17,10],0]]]],["lyrics",[[[[17],0]],[[[16],0],[[17],0]]]],["tb",[[[[16],5]],[[[10,17],0,["custom","dive","dip","hold","predive","predivedive"]],[[16],5]],[[[10,17],0,["default","gradual","fast"]],[[16],5]],[[[10,17],0,["custom","dive","dip","hold","predive","predivedive"]],[[10,17],0,["default","gradual","fast"]],[[16],5]]]],["tbe",[[[[16],5]],[[[10,17],0,["custom","dive","dip","hold","predive","predivedive"]],[[16],5]],[[[10,17],0,["default","gradual","fast"]],[[16],5]],[[[10,17],0,["custom","dive","dip","hold","predive","predivedive"]],[[10,17],0,["default","gradual","fast"]],[[16],5]]]],["bu",[[[[16],1]]]],["bd",[[[[16],1]]]],["au",[[[[16],1]]]],["ad",[[[[16],1]]]],["ch",[[[[17,10],0]]]],["gr",[[[[10,17],1,["onbeat","beforebeat","bendgrace","ob","bb","b"]]]]],["dy",[[[[10,17],0,["ppp","pp","p","mp","mf","f","ff","fff","pppp","ppppp","pppppp","ffff","fffff","ffffff","sf","sfp","sfpp","fp","rf","rfz","sfz","sffz","fz","n","pf","sfzp"]]]]],["tempo",[[[[16],0],[[10],1,["hide"]]],[[[16],0],[[17],0],[[10],1,["hide"]]]]],["volume",[[[[16],0]]]],["balance",[[[[16],0]]]],["tp",[[[[16],0],[[10,17],1,["default","buzzroll"]]]]],["barre",[[[[16],0],[[10,17],1,["full","half"]]]]],["rasg",[[[[10,17],0,["ii","mi","miitriplet","miianapaest","pmptriplet","pmpanapaest","peitriplet","peianapaest","paitriplet","paianapaest","amitriplet","amianapaest","ppp","amii","amip","eami","eamii","peami"]]]]],["ot",[[[[10,17],0,["15ma","8va","regular","8vb","15mb","15ma","8va","8vb","15mb"]]]]],["instrument",[[[[16],0]],[[[17,10],0]],[[[10],0,["percussion"]]]]],["bank",[[[[16],0]]]],["fermata",[[[[10,17],0,["short","medium","long"]],[[16],3]]]],["beam",[[[[10,17],0,["invert","up","down","auto","split","merge","splitsecondary"]]]]]])),o(vt,"noteProperties",vt._props([["nh",null],["ah",[[[[16],1]]]],["th",[[[[16],1]]]],["ph",[[[[16],1]]]],["sh",[[[[16],1]]]],["fh",[[[[16],1]]]],["v",null],["vw",null],["sl",null],["ss",null],["sib",null],["sia",null],["sou",null],["sod",null],["psu",null],["psd",null],["h",null],["lht",null],["g",null],["ac",null],["hac",null],["ten",null],["tr",[[[[16],0],[[16],1,["16","32","64"]]]]],["pm",null],["st",null],["lr",null],["x",null],["t",null],["turn",null],["iturn",null],["umordent",null],["lmordent",null],["string",null],["hide",null],["b",[[[[16],5]],[[[10,17],0,["custom","bend","release","bendrelease","hold","prebend","prebendbend","prebendrelease"]],[[16],5]],[[[10,17],0,["default","gradual","fast"]],[[16],5]],[[[10,17],0,["custom","bend","release","bendrelease","hold","prebend","prebendbend","prebendrelease"]],[[10,17],0,["default","gradual","fast"]],[[16],5]]]],["be",[[[[16],5]],[[[10,17],0,["custom","bend","release","bendrelease","hold","prebend","prebendbend","prebendrelease"]],[[16],5]],[[[10,17],0,["default","gradual","fast"]],[[16],5]],[[[10,17],0,["custom","bend","release","bendrelease","hold","prebend","prebendbend","prebendrelease"]],[[10,17],0,["default","gradual","fast"]],[[16],5]]]],["lf",[[[[16],0,["1","2","3","4","5"]]]]],["rf",[[[[16],0,["1","2","3","4","5"]]]]],["acc",[[[[10,17],0,["default","forcenone","forcenatural","forcesharp","forcedoublesharp","forceflat","forcedoubleflat","d","-","n","#","##","x","b","bb"]]]]],["slur",[[[[17],0]],[[[10],0]]]],["-",null]]));let St=vt;var C;(function(n){n[n.Dot=0]="Dot",n[n.Backslash=1]="Backslash",n[n.DoubleBackslash=2]="DoubleBackslash",n[n.Pipe=3]="Pipe",n[n.LBrace=4]="LBrace",n[n.RBrace=5]="RBrace",n[n.LParen=6]="LParen",n[n.RParen=7]="RParen",n[n.Colon=8]="Colon",n[n.Asterisk=9]="Asterisk",n[n.Ident=10]="Ident",n[n.Tag=11]="Tag",n[n.Meta=12]="Meta",n[n.Arguments=13]="Arguments",n[n.Props=14]="Props",n[n.Prop=15]="Prop",n[n.Number=16]="Number",n[n.String=17]="String",n[n.Score=18]="Score",n[n.Bar=19]="Bar",n[n.Beat=20]="Beat",n[n.Duration=21]="Duration",n[n.NoteList=22]="NoteList",n[n.Note=23]="Note"})(C||(C={}));var me;(function(n){n[n.Hint=0]="Hint",n[n.Warning=1]="Warning",n[n.Error=2]="Error"})(me||(me={}));var _e;(function(n){n[n.AT001=1]="AT001",n[n.AT002=2]="AT002",n[n.AT003=3]="AT003",n[n.AT004=4]="AT004",n[n.AT005=5]="AT005",n[n.AT006=6]="AT006",n[n.AT200=200]="AT200",n[n.AT201=201]="AT201",n[n.AT202=202]="AT202",n[n.AT203=203]="AT203",n[n.AT204=204]="AT204",n[n.AT205=205]="AT205",n[n.AT206=206]="AT206",n[n.AT207=207]="AT207",n[n.AT208=208]="AT208",n[n.AT209=209]="AT209",n[n.AT210=210]="AT210",n[n.AT211=211]="AT211",n[n.AT212=212]="AT212",n[n.AT213=213]="AT213",n[n.AT214=214]="AT214",n[n.AT215=215]="AT215",n[n.AT216=216]="AT216",n[n.AT217=217]="AT217",n[n.AT218=218]="AT218",n[n.AT219=219]="AT219",n[n.AT220=220]="AT220",n[n.AT300=300]="AT300",n[n.AT301=301]="AT301",n[n.AT302=302]="AT302",n[n.AT303=303]="AT303",n[n.AT304=304]="AT304",n[n.AT305=305]="AT305",n[n.AT306=306]="AT306",n[n.AT400=400]="AT400"})(_e||(_e={}));class yo{constructor(){o(this,"_hasErrors",!1);o(this,"items",[])}get errors(){return this.items.filter(t=>t.severity===me.Error)}get hasErrors(){return this._hasErrors}push(t){this.items.push(t),t.severity===me.Error&&(this._hasErrors=!0)}[Symbol.iterator](){return this.items[Symbol.iterator]()}}var Ga;(function(n){n[n.Auto=0]="Auto",n[n.Explicit=1]="Explicit"})(Ga||(Ga={}));var wi;(function(n){n[n.StaffWise=0]="StaffWise",n[n.BarWise=1]="BarWise"})(wi||(wi={}));var os;(function(n){n[n.Pitched=0]="Pitched",n[n.Fretted=1]="Fretted",n[n.Articulation=2]="Articulation"})(os||(os={}));var Rt;(function(n){n[n.Required=0]="Required",n[n.Optional=1]="Optional",n[n.RequiredAsFloat=2]="RequiredAsFloat",n[n.OptionalAsFloat=3]="OptionalAsFloat",n[n.RequiredAsValueList=4]="RequiredAsValueList",n[n.ValueListWithoutParenthesis=5]="ValueListWithoutParenthesis"})(Rt||(Rt={}));const Bt=class Bt{static float64ToBytes(t){return Bt._dataView.setFloat64(0,t,!0),Bt._conversionByteArray}static bytesToInt64LE(t){Bt._conversionByteArray.set(t,0);const e=Bt._dataView.getBigInt64(0,!0);return e<=Number.MAX_SAFE_INTEGER&&e>=Number.MIN_SAFE_INTEGER?Number(e):Number.MAX_SAFE_INTEGER}static bytesToFloat64LE(t){return Bt._conversionByteArray.set(t,0),Bt._dataView.getFloat64(0,!0)}static bytesToFloat32LE(t){return Bt._conversionByteArray.set(t,0),Bt._dataView.getFloat32(0,!0)}static float32BEToBytes(t){return Bt._dataView.setFloat32(0,t,!1),Bt._conversionByteArray.slice(0,4)}static uint16ToInt16(t){return Bt._dataView.setUint16(0,t,!0),Bt._dataView.getInt16(0,!0)}static int16ToUint32(t){return Bt._dataView.setInt16(0,t,!0),Bt._dataView.getUint32(0,!0)}static int32ToUint16(t){return Bt._dataView.setInt32(0,t,!0),Bt._dataView.getUint16(0,!0)}static int32ToInt16(t){return Bt._dataView.setInt32(0,t,!0),Bt._dataView.getInt16(0,!0)}static int32ToUint32(t){return Bt._dataView.setInt32(0,t,!0),Bt._dataView.getUint32(0,!0)}static uint8ToInt8(t){return Bt._dataView.setUint8(0,t),Bt._dataView.getInt8(0)}};o(Bt,"_conversionBuffer",new ArrayBuffer(8)),o(Bt,"_conversionByteArray",new Uint8Array(Bt._conversionBuffer)),o(Bt,"_dataView",new DataView(Bt._conversionBuffer));let it=Bt;class w{static readInt32BE(t){const e=t.readByte(),s=t.readByte(),i=t.readByte(),r=t.readByte();return e<<24|s<<16|i<<8|r}static readFloat32BE(t){const e=new Uint8Array(4);return t.read(e,0,e.length),e.reverse(),it.bytesToFloat32LE(e)}static readFloat64BE(t){const e=new Uint8Array(8);return t.read(e,0,e.length),e.reverse(),it.bytesToFloat64LE(e)}static readInt32LE(t){const e=t.readByte(),s=t.readByte(),i=t.readByte();return t.readByte()<<24|i<<16|s<<8|e}static readInt64LE(t){const e=new Uint8Array(8);return t.read(e,0,e.length),it.bytesToInt64LE(e)}static readUInt32LE(t){const e=t.readByte(),s=t.readByte(),i=t.readByte();return t.readByte()<<24|i<<16|s<<8|e}static decodeUInt32LE(t,e){const s=t[e],i=t[e+1],r=t[e+2];return t[e+3]<<24|r<<16|i<<8|s}static readUInt16LE(t){const e=t.readByte(),s=t.readByte();return it.int32ToUint16(s<<8|e)}static readInt16LE(t){const e=t.readByte(),s=t.readByte();return it.int32ToInt16(s<<8|e)}static readUInt32BE(t){const e=t.readByte(),s=t.readByte(),i=t.readByte(),r=t.readByte();return it.int32ToUint32(e<<24|s<<16|i<<8|r)}static readUInt16BE(t){const e=t.readByte(),s=t.readByte();return it.int32ToInt16(e<<8|s)}static readInt16BE(t){const e=t.readByte(),s=t.readByte();return it.int32ToInt16(e<<8|s)}static readByteArray(t,e){const s=new Uint8Array(e);return t.read(s,0,e),s}static read8BitChars(t,e){const s=new Uint8Array(e);return t.read(s,0,s.length),w.toString(s,"utf-8")}static read8BitString(t){let e="",s=t.readByte();for(;s!==0;)e+=String.fromCharCode(s),s=t.readByte();return e}static read8BitStringLength(t,e){let s="",i=-1;for(let a=0;a<e;a++){const l=t.readByte();l===0&&i===-1&&(i=a),s+=String.fromCharCode(l)}const r=s;return i>=0?r.substr(0,i):r}static readSInt8(t){const e=t.readByte();return((e&255)>>7)*-256+(e&255)}static readInt24(t,e){let s=t[e]|t[e+1]<<8|t[e+2]<<16;return(s&8388608)===8388608&&(s=s|255<<24),s}static readInt16(t,e){return it.int32ToInt16(t[e]|t[e+1]<<8)}static toString(t,e){const s=w._detectEncoding(t);return s&&(e=s),e||(e="utf-8"),new TextDecoder(e).decode(t.buffer)}static _detectEncoding(t){return t.length>2&&t[0]===254&&t[1]===255?"utf-16be":t.length>2&&t[0]===255&&t[1]===254?"utf-16le":t.length>4&&t[0]===0&&t[1]===0&&t[2]===254&&t[3]===255?"utf-32be":t.length>4&&t[0]===255&&t[1]===254&&t[2]===0&&t[3]===0?"utf-32le":null}static stringToBytes(t){return new TextEncoder().encode(t)}static writeInt32BE(t,e){t.writeByte(e>>24&255),t.writeByte(e>>16&255),t.writeByte(e>>8&255),t.writeByte(e>>0&255)}static writeInt32LE(t,e){t.writeByte(e>>0&255),t.writeByte(e>>8&255),t.writeByte(e>>16&255),t.writeByte(e>>24&255)}static writeUInt16LE(t,e){t.writeByte(e>>0&255),t.writeByte(e>>8&255)}static writeInt16LE(t,e){t.writeByte(e>>0&255),t.writeByte(e>>8&255)}static writeInt16BE(t,e){t.writeByte(e>>8&255),t.writeByte(e>>0&255)}static writeFloat32BE(t,e){const s=it.float32BEToBytes(e);t.write(s,0,s.length)}static*iterateCodepoints(t){let e=0;for(;e<t.length;){let s=t.charCodeAt(e);w.isLeadingSurrogate(s)&&e+1<t.length&&(e++,s=(s-55296)*1024+(t.charCodeAt(e)-56320)+65536),e++,yield s}}static isLeadingSurrogate(t){return t>=55296&&t<=56319}static isTrailingSurrogate(t){return t>=56320&&t<=57343}}const pt=class pt{constructor(t){o(this,"_codepoints");o(this,"_codepoint",pt._eof);o(this,"_offset",0);o(this,"_line",1);o(this,"_col",1);o(this,"fatalError",!1);o(this,"_tokenStart",{line:0,col:0,offset:0});o(this,"_leadingComments");o(this,"_trailingCommentNode");o(this,"_previousToken");o(this,"_peekedToken");o(this,"lexerDiagnostics",new yo);this._codepoints=[...w.iterateCodepoints(t)],this._offset=0,this._line=1,this._col=1,this._codepoint=this._codepoints.length>0?this._codepoints[0]:pt._eof}peekToken(){if(this.fatalError)return;let t=this._peekedToken;return t||(t=this._readToken(),this._peekedToken=t,t)}extendToFloat(t){if(this._codepoint!==46||this._offset+1>=this._codepoints.length||!pt._isDigit(this._codepoints[this._offset+1]))return t;let e=this._offset+2;for(;e<this._codepoints.length&&pt._isDigit(this._codepoints[e]);)e++;if(e<this._codepoints.length&&pt._isIdentifierCharacter(this._codepoints[e]))return t;const s=e-this._offset-1;return this._offset+=s,this._col+=s,this._nextCodepoint(),t.end=this._currentLexerLocation(),t.value=Number.parseFloat(String.fromCodePoint(...this._codepoints.slice(t.start.offset,t.end.offset))),t}advance(){this._previousToken=this._peekedToken,this._peekedToken=void 0}_nextCodepoint(){const t=this._codepoints;let e=this._offset;if(e<t.length-1){t[e]===10?(this._trailingCommentNode=void 0,++this._line,this._col=1):++this._col,++e;const i=t[e];return this._codepoint=i,this._offset=e,i}else this._codepoint!==pt._eof&&(this._codepoint=pt._eof,++this._col,this._offset=t.length);return pt._eof}previousTokenEndLocation(){var t;return((t=this._previousToken)==null?void 0:t.end)??this._currentLexerLocation()}currentTokenLocation(){var t;return((t=this._peekedToken)==null?void 0:t.start)??this._currentLexerLocation()}_currentLexerLocation(){return{line:this._line,col:this._col,offset:this._offset}}_readToken(){for(this._leadingComments=void 0;this._codepoint!==pt._eof&&!this.fatalError;)if(this._tokenStart=this._currentLexerLocation(),pt._terminalTokens.has(this._codepoint)){const t=pt._terminalTokens.get(this._codepoint)(this);if(t)return this._trailingCommentNode=t,t}else if(pt._isIdentifierCharacter(this._codepoint)){const t=this._numberOrIdentifier();return this._trailingCommentNode=t,t}else this._codepoint=this._nextCodepoint()}_comment(){this._codepoint=this._nextCodepoint(),this._codepoint===47?this._singleLineComment():this._codepoint===42?this._multiLineComment():(this.lexerDiagnostics.push({code:_e.AT001,message:`Unexpected character at comment start, expected '//' or '/*' but found '/${String.fromCodePoint(this._codepoint)}'`,severity:me.Error,start:this._tokenStart,end:this._currentLexerLocation()}),this.fatalError=!0)}_metaCommand(){const t=this._currentLexerLocation();this._codepoint=this._nextCodepoint();let e,s;this._codepoint===92?(this._codepoint=this._nextCodepoint(),s=this._currentLexerLocation(),e={nodeType:C.DoubleBackslash,start:t,end:s}):(s=this._currentLexerLocation(),e={nodeType:C.Backslash,start:t,end:s});let i="";for(;pt._isIdentifierCharacter(this._codepoint);)i+=String.fromCodePoint(this._codepoint),this._codepoint=this._nextCodepoint();if(i.length===0){this.lexerDiagnostics.push({code:_e.AT002,message:"Missing identifier after meta data start",severity:me.Error,start:this._tokenStart,end:this._currentLexerLocation()});return}return{nodeType:C.Tag,leadingComments:this._leadingComments,start:this._tokenStart,end:this._currentLexerLocation(),prefix:e,tag:{nodeType:C.Ident,text:i,start:s,end:this._currentLexerLocation()}}}_token(t){return t.leadingComments=this._leadingComments,t.start=this._tokenStart,this._codepoint=this._nextCodepoint(),t.end=this._currentLexerLocation(),t}_string(){const t=this._codepoint;this._codepoint=this._nextCodepoint();let e="",s=-1;for(;this._codepoint!==t&&this._codepoint!==pt._eof;){let r=-1;if(this._codepoint===92)if(this._codepoint=this._nextCodepoint(),this._codepoint===92)r=92;else if(this._codepoint===t)r=t;else if(this._codepoint===82||this._codepoint===114)r=13;else if(this._codepoint===78||this._codepoint===110)r=10;else if(this._codepoint===84||this._codepoint===116)r=9;else if(this._codepoint===117){let a="";for(let l=0;l<4;l++){if(this._codepoint=this._nextCodepoint(),this._codepoint===pt._eof){this.lexerDiagnostics.push({code:_e.AT003,message:"Unexpected end of file. Need 4 hex characters on a \\uXXXX escape sequence",severity:me.Error,start:this._tokenStart,end:this._currentLexerLocation()}),this.fatalError=!0;return}a+=String.fromCodePoint(this._codepoint)}if(r=Number.parseInt(a,16),Number.isNaN(r)){this.lexerDiagnostics.push({code:_e.AT004,message:"Invalid unicode value. Need 4 hex characters on a \\uXXXX escape sequence.",severity:me.Error,start:this._tokenStart,end:this._currentLexerLocation()}),this.fatalError=!0;return}}else{this.lexerDiagnostics.push({code:_e.AT005,message:`Unsupported escape sequence. Expected '\\n', '\\r', '\\t', or '\\uXXXX' but found '\\${String.fromCodePoint(this._codepoint)}'.`,severity:me.Error,start:this._tokenStart,end:this._currentLexerLocation()}),this.fatalError=!0;return}else r=this._codepoint;w.isLeadingSurrogate(s)&&w.isTrailingSurrogate(r)?(r=(s-55296)*1024+(r-56320)+65536,e+=String.fromCodePoint(r)):w.isLeadingSurrogate(r)||(w.isLeadingSurrogate(s)&&(e+=String.fromCodePoint(s)),r>0&&(e+=String.fromCodePoint(r))),s=r,this._codepoint=this._nextCodepoint()}if(this._codepoint===pt._eof){this.lexerDiagnostics.push({code:_e.AT006,message:"Unexpected end of file. String not closed.",severity:me.Error,start:this._tokenStart,end:this._currentLexerLocation()}),this.fatalError=!0;return}const i={nodeType:C.String,text:e,leadingComments:this._leadingComments,start:this._tokenStart,end:this._currentLexerLocation()};return this._codepoint=this._nextCodepoint(),i}_multiLineComment(){const t=this._trailingCommentNode,e={start:this._tokenStart,end:this._currentLexerLocation(),text:"",multiLine:!0};for(;this._codepoint!==pt._eof;)if(this._codepoint===42)if(this._codepoint=this._nextCodepoint(),this._codepoint===47){this._codepoint=this._nextCodepoint();break}else e.text+=`*${String.fromCodePoint(this._codepoint)}`,e.end.line=this._line,e.end.col=this._col,e.end.offset=this._offset;else this._codepoint=this._nextCodepoint(),e.text+=String.fromCodePoint(this._codepoint),e.end.line=this._line,e.end.col=this._col,e.end.offset=this._offset;t?(t.trailingComments??(t.trailingComments=[]),t.trailingComments.push(e)):(this._leadingComments??(this._leadingComments=[]),this._leadingComments.push(e))}_numberOrIdentifier(){let t="",e=!0,s=this._codepoint;s===45&&(t+=String.fromCodePoint(s),s=this._nextCodepoint(),pt._isDigit(s)||(e=!1));let i=!0;do e?pt._isDigit(s)?(t+=String.fromCodePoint(s),s=this._nextCodepoint(),i=!0):pt._isIdentifierCharacter(s)?(e=!1,t+=String.fromCodePoint(s),s=this._nextCodepoint(),i=!0):i=!1:pt._isIdentifierCharacter(s)?(t+=String.fromCodePoint(s),s=this._nextCodepoint(),i=!0):i=!1;while(i);return e?{nodeType:C.Number,leadingComments:this._leadingComments,start:this._tokenStart,end:this._currentLexerLocation(),value:Number.parseInt(t,10)}:{nodeType:C.Ident,leadingComments:this._leadingComments,start:this._tokenStart,end:this._currentLexerLocation(),text:t}}_singleLineComment(){const t=this._trailingCommentNode,e={start:this._tokenStart,end:this._currentLexerLocation(),text:"",multiLine:!1};let s=this._codepoint;for(;s!==pt._eof&&(s=this._nextCodepoint(),s!==10&&s!==pt._eof);)e.text+=String.fromCodePoint(s),e.end.line=this._line,e.end.col=this._col,e.end.offset=this._offset;t?(t.trailingComments??(t.trailingComments=[]),t.trailingComments.push(e)):(this._leadingComments??(this._leadingComments=[]),this._leadingComments.push(e))}_whitespace(){let t=this._codepoint;for(;pt._isWhiteSpace(t);)t===10&&(this._trailingCommentNode=void 0),t=this._nextCodepoint()}static _isDigit(t){return t>=48&&t<=57}static _buildNonIdentifierChars(){const t=new Set;for(const e of pt._terminalTokens.keys())t.add(e);return t.delete(45),t.add(pt._eof),t}static _isIdentifierCharacter(t){return!pt._nonIdentifierChars.has(t)}static _isWhiteSpace(t){return t===32||t===10||t===13||t===9||t===11}};o(pt,"_eof",0),o(pt,"_terminalTokens",new Map([[47,t=>t._comment()],[34,t=>t._string()],[39,t=>t._string()],[45,t=>t._numberOrIdentifier()],[46,t=>t._token({nodeType:C.Dot})],[58,t=>t._token({nodeType:C.Colon})],[40,t=>t._token({nodeType:C.LParen})],[41,t=>t._token({nodeType:C.RParen})],[123,t=>t._token({nodeType:C.LBrace})],[125,t=>t._token({nodeType:C.RBrace})],[124,t=>t._token({nodeType:C.Pipe})],[42,t=>t._token({nodeType:C.Asterisk})],[92,t=>t._metaCommand()],[9,t=>t._whitespace()],[10,t=>t._whitespace()],[11,t=>t._whitespace()],[13,t=>t._whitespace()],[32,t=>t._whitespace()]])),o(pt,"_nonIdentifierChars",pt._buildNonIdentifierChars());let gn=pt;var Cr;(function(n){n[n.ForModelImport=0]="ForModelImport",n[n.Full=1]="Full"})(Cr||(Cr={}));const lo=class lo{constructor(t){o(this,"lexer");o(this,"_scoreNode");o(this,"_metaDataReader",ki.instance);o(this,"mode",Cr.ForModelImport);o(this,"parserDiagnostics",new yo);this.lexer=new gn(t)}get lexerDiagnostics(){return this.lexer.lexerDiagnostics}addParserDiagnostic(t){this.parserDiagnostics.push(t)}unexpectedToken(t,e,s){t?this.addParserDiagnostic({code:_e.AT202,message:`Unexpected '${C[t.nodeType]}' token. Expected one of following: ${e.map(i=>C[i]).join(",")}`,severity:me.Error,start:t.start,end:t.end}):this.addParserDiagnostic({code:_e.AT203,start:this.lexer.currentTokenLocation(),end:this.lexer.currentTokenLocation(),severity:me.Error,message:"Unexpected end of file."}),s&&(this.lexer.fatalError=!0)}read(){return this._score(),this._scoreNode}_score(){this._scoreNode={nodeType:C.Score,bars:[],start:this.lexer.currentTokenLocation()};try{this._bars()}finally{this._scoreNode.end=this.lexer.previousTokenEndLocation()}}_bars(){let t=this.lexer.peekToken();for(;t;)this._bar(),t=this.lexer.peekToken()}_bar(){const t={nodeType:C.Bar,metaData:[],beats:[],pipe:void 0,start:this.lexer.currentTokenLocation()};this._scoreNode.bars.push(t);try{this._barMetaData(t),this._barBeats(t);const e=this.lexer.peekToken();(e==null?void 0:e.nodeType)===C.Pipe&&(t.pipe=e,this.lexer.advance()),(t.metaData.length>0||t.beats.length>0||t.pipe)&&(t.end=this.lexer.previousTokenEndLocation())}finally{t.end=this.lexer.previousTokenEndLocation()}}_barMetaData(t){let e=this.lexer.peekToken();for(;e&&(e.nodeType===C.Tag||e.nodeType===C.Dot);)e.nodeType===C.Dot?(this.lexer.advance(),this.addParserDiagnostic({code:_e.AT400,message:"The dots separating score metadata, score contents and the sync points can be removed.",severity:me.Hint,start:e.start,end:e.end})):this._metaData(t.metaData),e=this.lexer.peekToken()}_barBeats(t){let e=this.lexer.peekToken();for(;e&&e.nodeType!==C.Pipe&&e.nodeType!==C.Dot&&e.nodeType!==C.Tag;){const s=this._beat();s&&t.beats.push(s),e=this.lexer.peekToken()}}_beat(){var e,s;const t={nodeType:C.Beat,durationChange:void 0,notes:void 0,rest:void 0,beatEffects:void 0,beatMultiplier:void 0,beatMultiplierValue:void 0,start:(e=this.lexer.peekToken())==null?void 0:e.start};try{if(this._beatDurationChange(t),this._beatContent(t),!t.notes&&!t.rest)return t;this._beatDuration(t),this._beatMultiplier(t),t.beatEffects=this._properties(i=>this._metaDataReader.readBeatPropertyArguments(this,i)),t.beatMultiplierValue!==void 0&&((s=t.beatEffects)!=null&&s.openBrace)&&this.addParserDiagnostic({code:_e.AT304,message:"The beat multiplier should be specified after the beat effects.",severity:me.Warning,start:t.beatMultiplier.start,end:t.beatMultiplierValue.end}),this._beatMultiplier(t)}finally{t.end=this.lexer.previousTokenEndLocation()}return t}_beatDuration(t){const e=this.lexer.peekToken();if((e==null?void 0:e.nodeType)!==C.Dot)return;t.durationDot=e,this.lexer.advance();const s=this.lexer.peekToken();if((s==null?void 0:s.nodeType)===C.Number){t.durationValue=s,this.lexer.advance();return}else if((s==null?void 0:s.nodeType)===C.Tag){t.durationDot=void 0;return}else if(s)this.unexpectedToken(s,[C.Number],!0);else return}_beatDurationChange(t){const e=this.lexer.peekToken();if((e==null?void 0:e.nodeType)!==C.Colon)return;this.lexer.advance();const s={nodeType:C.Duration,colon:e,value:void 0,properties:void 0,start:e.start};t.durationChange=s;try{const i=this.lexer.peekToken();if(!i||i.nodeType!==C.Number){this.addParserDiagnostic({code:_e.AT201,message:"Missing duration value after ':'.",severity:me.Error,start:e.start,end:e.end});return}this.lexer.advance(),s.value=i,s.properties=this._properties(r=>this._metaDataReader.readDurationChangePropertyArguments(this,r))}finally{s.end=this.lexer.previousTokenEndLocation()}}_beatContent(t){const e=this.lexer.peekToken();if(e)if(e.nodeType===C.Ident&&e.text==="r")t.rest=e,this.lexer.advance();else if(e.nodeType===C.LParen)t.notes=this._noteList(e);else{const s=this._note(e);s&&(t.notes={nodeType:C.NoteList,openParenthesis:void 0,notes:[s],closeParenthesis:void 0,start:s.start,end:s.end})}}_beatMultiplier(t){const e=this.lexer.peekToken();if(!e||e.nodeType!==C.Asterisk)return;this.lexer.advance(),t.beatMultiplier=e;const s=this.lexer.peekToken();if(!s||s.nodeType!==C.Number){this.addParserDiagnostic({code:_e.AT200,message:"Missing beat multiplier value after '*'.",severity:me.Error,start:t.beatMultiplier.start,end:t.beatMultiplier.end});return}t.beatMultiplierValue=s,this.lexer.advance()}_noteList(t){const e={nodeType:C.NoteList,openParenthesis:void 0,notes:[],closeParenthesis:void 0,start:this.lexer.currentTokenLocation()};try{e.openParenthesis=t,this.lexer.advance();let s=this.lexer.peekToken();for(;s&&s.nodeType!==C.RParen;){const r=this._note(s);if(r)e.notes.push(r);else break;s=this.lexer.peekToken()}const i=this.lexer.peekToken();(i==null?void 0:i.nodeType)===C.RParen?(e.closeParenthesis=i,this.lexer.advance()):this.addParserDiagnostic({code:_e.AT206,message:"Unexpected end of file. Group not closed.",severity:me.Error,start:(i==null?void 0:i.start)??this.lexer.currentTokenLocation(),end:(i==null?void 0:i.end)??this.lexer.currentTokenLocation()})}finally{e.end=this.lexer.previousTokenEndLocation()}return e}_note(t){const e={nodeType:C.Note,noteValue:{nodeType:C.Ident,text:""},start:t.start};try{let s=!1;switch(t.nodeType){case C.Number:e.noteValue=t,this.lexer.advance(),s=!0;break;case C.String:switch(e.noteValue=t,this.lexer.advance(),e.noteValue.text){case"x":case"-":s=!0;break}break;case C.Ident:switch(e.noteValue=t,this.lexer.advance(),e.noteValue.text){case"x":case"-":s=!0;break}break;default:this.unexpectedToken(t,[C.Number,C.String,C.Ident],!0);return}if(s){const i=this.lexer.peekToken();if((i==null?void 0:i.nodeType)===C.Dot){const r=i;this.lexer.advance();const a=this.lexer.peekToken();if(!a){this.unexpectedToken(a,[C.Number],!0);return}if(a.nodeType===C.Tag)return e;if(a.nodeType===C.Number)e.noteStringDot=r,e.noteString=a,this.lexer.advance();else{this.unexpectedToken(a,[C.Number],!0);return}}}e.noteEffects=this._properties(i=>this._metaDataReader.readNotePropertyArguments(this,i))}finally{e.end=this.lexer.previousTokenEndLocation()}return e}_metaData(t){var i,r,a,l,h,c;const e=this.lexer.peekToken();if(!e||e.nodeType!==C.Tag)return;const s={nodeType:C.Meta,tag:e,start:e.start,properties:void 0,propertiesBeforeArguments:!1};this.lexer.advance(),t.push(s);try{const d=lo._allowValuesAfterProperties.has(s.tag.tag.text),u=this.lexer.peekToken();d&&(u==null?void 0:u.nodeType)===C.LBrace?(s.propertiesBeforeArguments=!0,s.properties=this._properties(p=>this._metaDataReader.readMetaDataPropertyArguments(this,s.tag,p)),s.arguments=this.argumentList(),s.arguments||(s.arguments=this._metaDataReader.readMetaDataArguments(this,s.tag),s.arguments&&s.arguments.arguments.length>1&&(this.addParserDiagnostic({code:_e.AT301,message:"Metadata arguments should be wrapped into parenthesis.",severity:me.Warning,start:((i=s.arguments)==null?void 0:i.start)??s.start,end:((r=s.arguments)==null?void 0:r.end)??s.end}),this.addParserDiagnostic({code:_e.AT302,message:"Metadata arguments should be placed before metadata properties.",severity:me.Warning,start:((a=s.arguments)==null?void 0:a.start)??s.start,end:((l=s.arguments)==null?void 0:l.end)??s.end})))):(this._metaDataReader.hasMetaDataArguments(s.tag)&&(s.arguments=this.argumentList(),s.arguments||(s.arguments=this._metaDataReader.readMetaDataArguments(this,s.tag),s.arguments&&s.arguments.arguments.length>1&&this.addParserDiagnostic({code:_e.AT301,message:"Metadata arguments should be wrapped into parenthesis.",severity:me.Warning,start:((h=s.arguments)==null?void 0:h.start)??s.start,end:((c=s.arguments)==null?void 0:c.end)??s.end}))),s.properties=this._properties(p=>this._metaDataReader.readMetaDataPropertyArguments(this,s.tag,p)))}finally{s.end=this.lexer.previousTokenEndLocation()}return s}_properties(t){const e=this.lexer.peekToken();if(!e||e.nodeType!==C.LBrace)return;const s={nodeType:C.Props,openBrace:e,properties:[],closeBrace:void 0,start:e.start};this.lexer.advance();try{let i=this.lexer.peekToken();for(;(i==null?void 0:i.nodeType)===C.Ident;)s.properties.push(this._property(i,t)),i=this.lexer.peekToken();const r=this.lexer.peekToken();(r==null?void 0:r.nodeType)===C.RBrace?(s.closeBrace=r,this.lexer.advance()):this.addParserDiagnostic({code:_e.AT206,message:"Unexpected end of file. Group not closed.",severity:me.Error,start:this.lexer.currentTokenLocation(),end:this.lexer.currentTokenLocation()})}finally{s.end=this.lexer.previousTokenEndLocation()}return s}_property(t,e){const s={nodeType:C.Prop,property:t,arguments:void 0};this.lexer.advance(),s.start=s.property.start;try{s.arguments=this.argumentList(),s.arguments||(s.arguments=e(s),s.arguments&&s.arguments.arguments.length>1&&this.addParserDiagnostic({code:_e.AT303,message:"Property args should be wrapped into parenthesis.",severity:me.Warning,start:s.arguments.start,end:s.arguments.end}))}finally{s.end=this.lexer.previousTokenEndLocation()}return s}argumentList(){const t=this.lexer.peekToken();if((t==null?void 0:t.nodeType)!==C.LParen)return;const e={nodeType:C.Arguments,openParenthesis:t,arguments:[],closeParenthesis:void 0,start:t.start};this.lexer.advance();try{let s=this.lexer.peekToken();for(;s&&(s==null?void 0:s.nodeType)!==C.RParen;){switch(s.nodeType){case C.Ident:e.arguments.push(s),this.lexer.advance();break;case C.String:e.arguments.push(s),this.lexer.advance();break;case C.Number:e.arguments.push(this.lexer.extendToFloat(s)),this.lexer.advance();break;default:this.unexpectedToken(s,[C.Ident,C.String,C.Number],!1),this.lexer.advance();break}s=this.lexer.peekToken()}const i=this.lexer.peekToken();(i==null?void 0:i.nodeType)===C.RParen?(e.closeParenthesis=i,this.lexer.advance()):this.addParserDiagnostic({code:_e.AT206,message:"Unexpected end of file. Group not closed.",severity:me.Error,start:this.lexer.currentTokenLocation(),end:this.lexer.currentTokenLocation()})}finally{e.end=this.lexer.previousTokenEndLocation()}return e}};o(lo,"_allowValuesAfterProperties",new Set(["chord"]));let Ua=lo;class _{static ident(t){return{nodeType:C.Ident,text:t}}static string(t){return{nodeType:C.String,text:t}}static number(t){return{nodeType:C.Number,value:t}}static meta(t,e,s){return{nodeType:C.Meta,tag:{nodeType:C.Tag,prefix:{nodeType:C.Backslash},tag:{nodeType:C.Ident,text:t}},arguments:e,properties:s,propertiesBeforeArguments:!1}}static identMeta(t,e){return _.meta(t,_.identValue(e))}static numberMeta(t,e){return _.meta(t,_.numberValue(e))}static args(t,e=void 0){const s={nodeType:C.Arguments,arguments:t.filter(r=>r!==void 0)};if((e===void 0?s.arguments.length>1:e)&&(s.openParenthesis={nodeType:C.LParen},s.closeParenthesis={nodeType:C.RParen}),s.arguments.length!==0)return s}static stringValue(t){return _.args([_.string(t)])}static identValue(t){return _.args([_.ident(t)])}static numberValue(t){return _.args([_.number(t)])}static props(t){const e={nodeType:C.Props,properties:[],openBrace:{nodeType:C.LBrace},closeBrace:{nodeType:C.RBrace}};for(const s of t)s&&e.properties.push({nodeType:C.Prop,property:_.ident(s[0]),arguments:s[1]});return e}static prop(t,e,s){t.push({nodeType:C.Prop,property:_.ident(e),arguments:s})}}const us=class us{hasMetaDataArguments(t){const e=t.tag.text.toLowerCase();for(const s of St.metaDataSignatures)if(s.has(e))return s.get(e)!==null;return!0}readMetaDataArguments(t,e){const s=e.tag.text.toLowerCase();for(const i of St.metaDataSignatures)if(i.has(s)){const r=i.get(s);return r?this._readArguments(t,r):void 0}t.addParserDiagnostic({code:_e.AT204,message:`Unrecognized metadata '${e.tag.text}'.`,severity:me.Error,start:e.start,end:e.end}),t.lexer.fatalError=!0}readMetaDataPropertyArguments(t,e,s){const i=e.tag.text.toLowerCase();if(!St.metaDataProperties.has(i))return;const r=St.metaDataProperties.get(i);return r?this._readPropertyArguments(t,[r],s):this._readPropertyArguments(t,[],s)}readBeatPropertyArguments(t,e){return this._readPropertyArguments(t,[St.beatProperties],e)}readDurationChangePropertyArguments(t,e){return this._readPropertyArguments(t,[St.durationChangeProperties],e)}readNotePropertyArguments(t,e){return this._readPropertyArguments(t,[St.noteProperties,St.beatProperties],e)}_readPropertyArguments(t,e,s){const i=s.property.text.toLowerCase(),r=new Set([C.Ident,C.RBrace]);for(const l of e)if(l.has(i)){const h=l.get(i);if(h)return this._readArguments(t,h,r);this._skipRemainingArguments(t,[],r);return}let a=t.lexer.peekToken();for(;a&&a.nodeType!==C.Ident&&a.nodeType!==C.RBrace;)t.lexer.advance(),a=t.lexer.peekToken();t.addParserDiagnostic({code:_e.AT205,message:`Unrecognized property '${s.property.text}'.`,severity:me.Error,start:s.property.start,end:(a==null?void 0:a.start)??t.lexer.currentTokenLocation()})}_readArguments(t,e,s){var d;if(e.length===1&&e[0].parameters.length===0)return;const i=[],r=(d=t.lexer.peekToken())==null?void 0:d.start,a=s!==void 0,l=new Map(e.map((u,p)=>[p,{signature:u,parameterIndex:0,parameterHasValues:!1,parameterValueMatches:0}])),h=this._filterCandidates(t,l,i,s),c=this._validateArguments(t,l,i,s,e,r);return a&&this._skipRemainingArguments(t,e,s),this._createArgumentList(i,r,t.lexer.previousTokenEndLocation(),c,h)}_validateArguments(t,e,s,i,r,a){const l=t.lexer.peekToken();let h=!1;return e.size!==1&&l===void 0?(t.addParserDiagnostic({code:_e.AT203,start:t.lexer.currentTokenLocation(),end:t.lexer.currentTokenLocation(),severity:me.Error,message:"Unexpected end of file."}),h=!0):e.size===0&&(l!==void 0&&s.length===0&&i&&!i.has(l.nodeType)&&(s.push(t.lexer.peekToken()),t.lexer.advance()),t.addParserDiagnostic({code:_e.AT219,message:`Error parsing arguments: no overload matched arguments ${us.generateSignaturesFromArguments(s)}. Signatures:
${us.generateSignatures(r)}`,severity:me.Error,start:a,end:t.lexer.previousTokenEndLocation()}),h=!0),h}_createArgumentList(t,e,s,i,r){if(t.length===0)return;const a=_.args(t,!1);return a.start=e,a.end=s,a.validated=!i,r&&(r.length>1&&us.sortCandidates(r),a.signatureCandidateIndices=r.map(l=>l[0])),a}_filterCandidates(t,e,s,i){const r=t.mode===Cr.Full,a=(d,u)=>{const p=e.get(u);if(d.nodeType===C.LParen){const g=t.argumentList();if(g)for(const m of g.arguments)r&&(m.parameterIndices||(m.parameterIndices=new Map),m.parameterIndices.set(u,p.parameterIndex)),s.push(m)}else{const g=d;r&&(g.parameterIndices||(g.parameterIndices=new Map),g.parameterIndices.set(u,p.parameterIndex)),(s.length===0||s[s.length-1]!==g)&&(s.push(g),t.lexer.advance())}},l=d=>{t.lexer.extendToFloat(d)},h=us._argumentTypes;for(;e.size>1||e.size>0&&!us._hasExactMatch(e);){const d=t.lexer.peekToken();if(!d||!h.has(d.nodeType)||!us.filterSignatureCandidates(e,d,i!==void 0&&i.has(d.nodeType),a,l))break}const c=t.mode===Cr.Full?Array.from(e.entries()):void 0;return us.filterIncompleteCandidates(e),c}static sortCandidates(t){t.length<2||t.sort((e,s)=>{const i=Math.abs(e[1].parameterIndex-e[1].signature.parameters.length),r=Math.abs(s[1].parameterIndex-s[1].signature.parameters.length);if(i===r){const a=e[1].parameterValueMatches;return s[1].parameterValueMatches-a}return i-r})}_skipRemainingArguments(t,e,s){const i=t.lexer.currentTokenLocation();let r=t.lexer.peekToken(),a=!1;const l=us._argumentTypes;for(;r&&!s.has(r.nodeType);)l.has(r.nodeType)?(t.lexer.advance(),a=!0,r=t.lexer.peekToken()):r=void 0;a&&t.addParserDiagnostic({code:_e.AT220,message:`Error parsing arguments: unexpected additional arguments. Signatures:
${us.generateSignatures(e)}`,severity:me.Error,start:i,end:t.lexer.previousTokenEndLocation()})}static _hasExactMatch(t){for(const e of t.values())if(e.parameterIndex===e.signature.parameters.length)return!0;return!1}static filterIncompleteCandidates(t){const e=new Set;for(const[s,i]of t)for(let r=i.parameterIndex;r<i.signature.parameters.length;r++)switch(i.signature.parameters[r].parseMode){case Rt.Required:case Rt.RequiredAsFloat:e.add(s);break}for(const s of e)t.delete(s)}static generateSignaturesFromArguments(t){return t?`(${t.map(e=>C[e.nodeType]).join(", ")})`:"()"}static generateSignatures(t,e){return t.length===0?"()":t.map((s,i)=>us._generateSignature(s,e!==void 0&&e.size>1&&e.has(i))).join(`
`)}static _generateSignature(t,e){const s=e?" ~":"";return`(${t.parameters.map(us._generateSignatureParameter).join(", ")})${s}`}static _generateSignatureParameter(t,e){const s=Array.from(t.expectedTypes);let i=`v${e}`;switch(t.parseMode){case Rt.Optional:case Rt.OptionalAsFloat:i+="?";break}if(t.allowedValues&&t.allowedValues.size<5){const r=Array.from(t.allowedValues);switch(s[0]){case C.String:i=r.map(a=>`"${a}"`).join("|");break;default:i=r.join("|");break}}else i=Array.from(t.expectedTypes).map(r=>C[r]).join("|");switch(t.parseMode){case Rt.RequiredAsValueList:case Rt.ValueListWithoutParenthesis:i+="[]";break}return i}static filterSignatureCandidates(t,e,s,i,r){const a=new Set;let l=!1;for(const[h,c]of t){let d=!1;for(;!d;){const u=c.parameterIndex<c.signature.parameters.length?c.signature.parameters[c.parameterIndex]:void 0;if(!u)s||a.add(h),d=!0;else if(c.signature.isStrict&&c.parameterIndex>0)a.add(h),d=!0;else if((u.expectedTypes.has(e.nodeType)||us._isValueListMatch(e,u))&&us._checkArgumentMatch(e,u,r))switch(d=!0,l=!0,i(e,h),u.allowedValues&&c.parameterValueMatches++,u.parseMode){case Rt.ValueListWithoutParenthesis:c.parameterHasValues=!0;break;case Rt.RequiredAsValueList:c.parameterIndex++,c.parameterHasValues=!1;break;default:c.parameterIndex++,c.parameterHasValues=!1;break}else switch(u.parseMode){case Rt.ValueListWithoutParenthesis:c.parameterIndex++,c.parameterHasValues=!1;break;case Rt.Required:case Rt.RequiredAsFloat:a.add(h),d=!0;break;case Rt.Optional:case Rt.OptionalAsFloat:c.parameterIndex++,c.parameterHasValues=!1;break;case Rt.RequiredAsValueList:c.parameterIndex++,c.parameterHasValues=!1;break}}}if(l)for(const h of a)t.delete(h);return l}static _checkArgumentMatch(t,e,s){switch(t.nodeType){case C.Ident:const i=t;return e!=null&&e.allowedValues?e.allowedValues.has(i.text.toLowerCase()):e!=null&&e.reservedIdentifiers?!e.reservedIdentifiers.has(i.text.toLowerCase()):!0;case C.String:const r=t;return e!=null&&e.allowedValues?e.allowedValues.has(r.text.toLowerCase()):!0;case C.Number:switch((e==null?void 0:e.parseMode)??Rt.Optional){case Rt.RequiredAsFloat:case Rt.OptionalAsFloat:return s==null||s(t),!0;default:return!0}case C.LParen:return!0}return!1}static _isValueListMatch(t,e){return t.nodeType!==C.LParen?!1:e.expectedTypes.has(C.Arguments)||e.parseMode===Rt.ValueListWithoutParenthesis||e.parseMode===Rt.RequiredAsValueList}};o(us,"instance",new us),o(us,"_argumentTypes",new Set([C.LParen,C.String,C.Ident,C.Number]));let ki=us;var B;(function(n){n[n.Applied=0]="Applied",n[n.NotAppliedSemanticError=1]="NotAppliedSemanticError",n[n.NotAppliedUnrecognizedMarker=2]="NotAppliedUnrecognizedMarker"})(B||(B={}));var li;(function(n){n[n.AppliedNewTrack=0]="AppliedNewTrack",n[n.AppliedNewStaff=1]="AppliedNewStaff",n[n.AppliedNewVoice=2]="AppliedNewVoice",n[n.NotAppliedSemanticError=3]="NotAppliedSemanticError",n[n.NotAppliedUnrecognizedMarker=4]="NotAppliedUnrecognizedMarker"})(li||(li={}));const ji=class ji{static getValue(t){return ji._values||(ji._values=new Map),t=t.toLowerCase().replaceAll(" ",""),ji._values.has(t)?ji._values.get(t):0}static getName(t){for(const[e,s]of ji._values)if(s===t)return e;return t.toString()}static isPiano(t){return t<=7||t>=16&&t<=23}static isGuitar(t){return t>=24&&t<=39||t===105||t===43}static isBass(t){return t>=32&&t<=39}static bankToLsbMsb(t){const e=t&127,s=t>>7&127;return[e,s]}};o(ji,"_values",new Map([["acousticgrandpiano",0],["brightacousticpiano",1],["electricgrandpiano",2],["honkytonkpiano",3],["electricpiano1",4],["electricpiano2",5],["harpsichord",6],["clavinet",7],["celesta",8],["glockenspiel",9],["musicbox",10],["vibraphone",11],["marimba",12],["xylophone",13],["tubularbells",14],["dulcimer",15],["drawbarorgan",16],["percussiveorgan",17],["rockorgan",18],["churchorgan",19],["reedorgan",20],["accordion",21],["harmonica",22],["tangoaccordion",23],["acousticguitarnylon",24],["acousticguitarsteel",25],["electricguitarjazz",26],["electricguitarclean",27],["electricguitarmuted",28],["overdrivenguitar",29],["distortionguitar",30],["guitarharmonics",31],["acousticbass",32],["electricbassfinger",33],["electricbasspick",34],["fretlessbass",35],["slapbass1",36],["slapbass2",37],["synthbass1",38],["synthbass2",39],["violin",40],["viola",41],["cello",42],["contrabass",43],["tremolostrings",44],["pizzicatostrings",45],["orchestralharp",46],["timpani",47],["stringensemble1",48],["stringensemble2",49],["synthstrings1",50],["synthstrings2",51],["choiraahs",52],["voiceoohs",53],["synthvoice",54],["orchestrahit",55],["trumpet",56],["trombone",57],["tuba",58],["mutedtrumpet",59],["frenchhorn",60],["brasssection",61],["synthbrass1",62],["synthbrass2",63],["sopranosax",64],["altosax",65],["tenorsax",66],["baritonesax",67],["oboe",68],["englishhorn",69],["bassoon",70],["clarinet",71],["piccolo",72],["flute",73],["recorder",74],["panflute",75],["blownbottle",76],["shakuhachi",77],["whistle",78],["ocarina",79],["lead1square",80],["lead2sawtooth",81],["lead3calliope",82],["lead4chiff",83],["lead5charang",84],["lead6voice",85],["lead7fifths",86],["lead8bassandlead",87],["pad1newage",88],["pad2warm",89],["pad3polysynth",90],["pad4choir",91],["pad5bowed",92],["pad6metallic",93],["pad7halo",94],["pad8sweep",95],["fx1rain",96],["fx2soundtrack",97],["fx3crystal",98],["fx4atmosphere",99],["fx5brightness",100],["fx6goblins",101],["fx7echoes",102],["fx8scifi",103],["sitar",104],["banjo",105],["shamisen",106],["koto",107],["kalimba",108],["bagpipe",109],["fiddle",110],["shanai",111],["tinklebell",112],["agogo",113],["steeldrums",114],["woodblock",115],["taikodrum",116],["melodictom",117],["synthdrum",118],["reversecymbal",119],["guitarfretnoise",120],["breathnoise",121],["seashore",122],["birdtweet",123],["telephonering",124],["helicopter",125],["applause",126],["gunshot",127]]));let ui=ji;class Yi{constructor(){o(this,"name","");o(this,"firstFret",1);o(this,"strings",[]);o(this,"barreFrets",[]);o(this,"staff");o(this,"showName",!0);o(this,"showDiagram",!0);o(this,"showFingering",!0)}get uniqueId(){return[this.name,this.firstFret.toString(),this.strings.join(","),this.barreFrets.join(","),this.showDiagram.toString(),this.showFingering.toString(),this.showName.toString()].join("|")}}class Kt extends Xe{constructor(t){super(ze.Format,t)}}const js=class js{constructor(t,e,s,i=255){o(this,"raw",0);o(this,"rgba");this.raw=(i&255)<<24|(t&255)<<16|(e&255)<<8|s&255,this.updateRgba()}updateRgba(){this.a===255?this.rgba=`#${A.toHexString(this.r,2)}${A.toHexString(this.g,2)}${A.toHexString(this.b,2)}`:this.rgba=`rgba(${this.r},${this.g},${this.b},${this.a/255})`}get a(){return this.raw>>24&255}get r(){return this.raw>>16&255}get g(){return this.raw>>8&255}get b(){return this.raw&255}static random(t=100){return new js(Math.random()*255|0,Math.random()*255|0,Math.random()*255|0,t)}static fromJson(t){if(t instanceof js)return t;switch(typeof t){case"number":{const e=new js(0,0,0,0);return e.raw=t,e.updateRgba(),e}case"string":{const e=t;if(e.startsWith("#")){if(e.length===4)return new js(Number.parseInt(e[1],16)*17,Number.parseInt(e[2],16)*17,Number.parseInt(e[3],16)*17);if(e.length===5)return new js(Number.parseInt(e[1],16)*17,Number.parseInt(e[2],16)*17,Number.parseInt(e[3],16)*17,Number.parseInt(e[4],16)*17);if(e.length===7)return new js(Number.parseInt(e.substring(1,3),16),Number.parseInt(e.substring(3,5),16),Number.parseInt(e.substring(5,7),16));if(e.length===9)return new js(Number.parseInt(e.substring(1,3),16),Number.parseInt(e.substring(3,5),16),Number.parseInt(e.substring(5,7),16),Number.parseInt(e.substring(7,9),16))}else if(e.startsWith("rgba")||e.startsWith("rgb")){const s=e.indexOf("("),i=e.lastIndexOf(")");if(s===-1||i===-1)throw new Kt("No values specified for rgb/rgba function");const r=e.substring(s+1,i).split(",");if(r.length===3)return new js(Number.parseInt(r[0],10),Number.parseInt(r[1],10),Number.parseInt(r[2],10));if(r.length===4)return new js(Number.parseInt(r[0],10),Number.parseInt(r[1],10),Number.parseInt(r[2],10),Number.parseFloat(r[3])*255)}return null}}throw new Kt("Unsupported format for color")}static toJson(t){return t===null?null:t.raw}};o(js,"BlackRgb","#000000");let qe=js;var Ss;(function(n){n[n.Short=0]="Short",n[n.Medium=1]="Medium",n[n.Long=2]="Long"})(Ss||(Ss={}));class ra{constructor(){o(this,"type",Ss.Short);o(this,"length",0)}}var ds;(function(n){n[n.IgnoreSpaces=0]="IgnoreSpaces",n[n.Begin=1]="Begin",n[n.Text=2]="Text",n[n.Comment=3]="Comment",n[n.Dash=4]="Dash"})(ds||(ds={}));const ss=class ss{constructor(){o(this,"startBar",0);o(this,"text","");o(this,"chunks")}finish(t=!1){this.chunks=[],this._parse(this.text,0,this.chunks,t)}_parse(t,e,s,i){if(!t)return;let r=ds.Begin,a=ds.Begin,l=!1,h=0;for(;e<t.length;){const c=t.charCodeAt(e);switch(r){case ds.IgnoreSpaces:switch(c){case ss._charCodeLF:case ss._charCodeCR:case ss._charCodeTab:break;case ss._charCodeSpace:if(!l){r=a;continue}break;default:l=!1,r=a;continue}break;case ds.Begin:switch(c){case ss._charCodeBrackedOpen:r=ds.Comment;break;default:h=e,r=ds.Text;continue}break;case ds.Comment:switch(c){case ss._charCodeBrackedClose:r=ds.Begin;break}break;case ds.Text:switch(c){case ss._charCodeDash:r=ds.Dash;break;case ss._charCodeCR:case ss._charCodeLF:case ss._charCodeSpace:const d=t.substr(h,e-h);this._addChunk(d,i),r=ds.IgnoreSpaces,a=ds.Begin;break}break;case ds.Dash:switch(c){case ss._charCodeDash:break;default:const d=t.substr(h,e-h);this._addChunk(d,i),l=!0,r=ds.IgnoreSpaces,a=ds.Begin;continue}break}e+=1}r===ds.Text&&e!==h&&this._addChunk(t.substr(h,e-h),i)}_addChunk(t,e){t=this._prepareChunk(t),(!e||t.length>0&&t!=="-")&&this.chunks.push(t)}_prepareChunk(t){const e=t.split("+").join(" ");let s=e.length;for(;s>0&&e.charAt(s-1)==="_";)s--;return s!==e.length?e.substr(0,s):e}};o(ss,"_charCodeLF",10),o(ss,"_charCodeTab",9),o(ss,"_charCodeCR",13),o(ss,"_charCodeSpace",32),o(ss,"_charCodeBrackedClose",93),o(ss,"_charCodeBrackedOpen",91),o(ss,"_charCodeDash",45);let hr=ss;class aa{constructor(){o(this,"marker","");o(this,"text","")}}const W=class W{constructor(t="",e=null,s=!1){o(this,"isStandard");o(this,"name");o(this,"tunings");this.isStandard=s,this.name=t,this.tunings=e??[]}static getTextForTuning(t,e){const s=W.getTextPartsForTuning(t);return e?s.join(""):s[0]}static getTextPartsForTuning(t,e=-1){const s=t/12|0,i=t%12;return[W.noteNames[i],(s+e).toString()]}static getDefaultTuningFor(t){if(W._defaultTunings.has(t)){const e=W._defaultTunings.get(t);return new W(e.name,e.tunings,e.isStandard)}return null}static getPresetsFor(t){switch(t){case 7:return W._sevenStrings;case 6:return W._sixStrings;case 5:return W._fiveStrings;case 4:return W._fourStrings}return[]}static initialize(){W._defaultTunings.set(7,new W("Guitar 7 strings",[64,59,55,50,45,40,35],!0)),W._sevenStrings.push(W._defaultTunings.get(7)),W._defaultTunings.set(6,new W("Guitar Standard Tuning",[64,59,55,50,45,40],!0)),W._sixStrings.push(W._defaultTunings.get(6)),W._sixStrings.push(new W("Guitar Tune down ½ step",[63,58,54,49,44,39],!1)),W._sixStrings.push(new W("Guitar Tune down 1 step",[62,57,53,48,43,38],!1)),W._sixStrings.push(new W("Guitar Tune down 2 step",[60,55,51,46,41,36],!1)),W._sixStrings.push(new W("Guitar Dropped D Tuning",[64,59,55,50,45,38],!1)),W._sixStrings.push(new W("Guitar Dropped D Tuning variant",[64,57,55,50,45,38],!1)),W._sixStrings.push(new W("Guitar Double Dropped D Tuning",[62,59,55,50,45,38],!1)),W._sixStrings.push(new W("Guitar Dropped E Tuning",[66,61,57,52,47,40],!1)),W._sixStrings.push(new W("Guitar Dropped C Tuning",[62,57,53,48,43,36],!1)),W._sixStrings.push(new W("Guitar Open C Tuning",[64,60,55,48,43,36],!1)),W._sixStrings.push(new W("Guitar Open Cm Tuning",[63,60,55,48,43,36],!1)),W._sixStrings.push(new W("Guitar Open C6 Tuning",[64,57,55,48,43,36],!1)),W._sixStrings.push(new W("Guitar Open Cmaj7 Tuning",[64,59,55,52,43,36],!1)),W._sixStrings.push(new W("Guitar Open D Tuning",[62,57,54,50,45,38],!1)),W._sixStrings.push(new W("Guitar Open Dm Tuning",[62,57,53,50,45,38],!1)),W._sixStrings.push(new W("Guitar Open D5 Tuning",[62,57,50,50,45,38],!1)),W._sixStrings.push(new W("Guitar Open D6 Tuning",[62,59,54,50,45,38],!1)),W._sixStrings.push(new W("Guitar Open Dsus4 Tuning",[62,57,55,50,45,38],!1)),W._sixStrings.push(new W("Guitar Open E Tuning",[64,59,56,52,47,40],!1)),W._sixStrings.push(new W("Guitar Open Em Tuning",[64,59,55,52,47,40],!1)),W._sixStrings.push(new W("Guitar Open Esus11 Tuning",[64,59,55,52,45,40],!1)),W._sixStrings.push(new W("Guitar Open F Tuning",[65,60,53,48,45,41],!1)),W._sixStrings.push(new W("Guitar Open G Tuning",[62,59,55,50,43,38],!1)),W._sixStrings.push(new W("Guitar Open Gm Tuning",[62,58,55,50,43,38],!1)),W._sixStrings.push(new W("Guitar Open G6 Tuning",[64,59,55,50,43,38],!1)),W._sixStrings.push(new W("Guitar Open Gsus4 Tuning",[62,60,55,50,43,38],!1)),W._sixStrings.push(new W("Guitar Open A Tuning",[64,61,57,52,45,40],!1)),W._sixStrings.push(new W("Guitar Open Am Tuning",[64,60,57,52,45,40],!1)),W._sixStrings.push(new W("Guitar Nashville Tuning",[64,59,67,62,57,52],!1)),W._sixStrings.push(new W("Bass 6 Strings Tuning",[48,43,38,33,28,23],!1)),W._sixStrings.push(new W("Lute or Vihuela Tuning",[64,59,54,50,45,40],!1)),W._defaultTunings.set(5,new W("Bass 5 Strings Tuning",[43,38,33,28,23],!0)),W._fiveStrings.push(W._defaultTunings.get(5)),W._fiveStrings.push(new W("Banjo Dropped C Tuning",[62,59,55,48,67],!1)),W._fiveStrings.push(new W("Banjo Open D Tuning",[62,57,54,50,69],!1)),W._fiveStrings.push(new W("Banjo Open G Tuning",[62,59,55,50,67],!1)),W._fiveStrings.push(new W("Banjo G Minor Tuning",[62,58,55,50,67],!1)),W._fiveStrings.push(new W("Banjo G Modal Tuning",[62,57,55,50,67],!1)),W._defaultTunings.set(4,new W("Bass Standard Tuning",[43,38,33,28],!0)),W._fourStrings.push(W._defaultTunings.get(4)),W._fourStrings.push(new W("Bass Tune down ½ step",[42,37,32,27],!1)),W._fourStrings.push(new W("Bass Tune down 1 step",[41,36,31,26],!1)),W._fourStrings.push(new W("Bass Tune down 2 step",[39,34,29,24],!1)),W._fourStrings.push(new W("Bass Dropped D Tuning",[43,38,33,26],!1)),W._fourStrings.push(new W("Ukulele C Tuning",[45,40,36,43],!1)),W._fourStrings.push(new W("Ukulele G Tuning",[52,47,43,38],!1)),W._fourStrings.push(new W("Mandolin Standard Tuning",[64,57,50,43],!1)),W._fourStrings.push(new W("Mandolin or Violin Tuning",[76,69,62,55],!1)),W._fourStrings.push(new W("Viola Tuning",[69,62,55,48],!1)),W._fourStrings.push(new W("Cello Tuning",[57,50,43,36],!1))}static findTuning(t){const e=W.getPresetsFor(t.length);for(let s=0,i=e.length;s<i;s++){const r=e[s];let a=!0;for(let l=0,h=t.length;l<h;l++)if(t[l]!==r.tunings[l]){a=!1;break}if(a)return new W(r.name,r.tunings,r.isStandard)}return null}reset(){this.isStandard=!1,this.name="",this.tunings=[]}finish(){const t=W.findTuning(this.tunings);t&&(this.name.length===0&&(this.name=t.name),this.isStandard=t.isStandard)}};o(W,"_sevenStrings",[]),o(W,"_sixStrings",[]),o(W,"_fiveStrings",[]),o(W,"_fourStrings",[]),o(W,"_defaultTunings",new Map),o(W,"noteNames",["C","Db","D","Eb","E","F","Gb","G","Ab","A","Bb","B"]);let Vs=W;Vs.initialize();const ho=class ho{constructor(){o(this,"index",0);o(this,"track");o(this,"bars",[]);o(this,"chords",null);o(this,"capo",0);o(this,"transpositionPitch",0);o(this,"displayTranspositionPitch",0);o(this,"stringTuning",new Vs("",[],!1));o(this,"showSlash",!1);o(this,"showNumbered",!1);o(this,"showTablature",!0);o(this,"showStandardNotation",!0);o(this,"isPercussion",!1);o(this,"standardNotationLineCount",ho.DefaultStandardNotationLineCount);o(this,"_filledVoices",new Set([0]))}get tuning(){return this.stringTuning.tunings}get tuningName(){return this.stringTuning.name}get isStringed(){return this.stringTuning.tunings.length>0}get filledVoices(){return this._filledVoices}finish(t,e=null){this.isPercussion&&(this.stringTuning.tunings=[],this.showTablature=!1,this.displayTranspositionPitch=0),this.stringTuning.finish(),this.stringTuning.tunings.length===0&&(this.showTablature=!1);for(let s=0,i=this.bars.length;s<i;s++){this.bars[s].finish(t,e);for(const r of this.bars[s].filledVoices)this._filledVoices.add(r)}}addChord(t,e){e.staff=this;let s=this.chords;s===null&&(s=new Map,this.chords=s),s.set(t,e)}hasChord(t){var e;return((e=this.chords)==null?void 0:e.has(t))??!1}getChord(t){var e;return((e=this.chords)==null?void 0:e.get(t))??null}addBar(t){const e=this.bars;t.staff=this,t.index=e.length,e.length>0&&(t.previousBar=e[e.length-1],t.previousBar.nextBar=t),e.push(t)}};o(ho,"DefaultStandardNotationLineCount",5);let cr=ho;class Ol{constructor(){o(this,"volume",15);o(this,"balance",8);o(this,"port",1);o(this,"program",0);o(this,"bank",0);o(this,"primaryChannel",0);o(this,"secondaryChannel",0);o(this,"isMute",!1);o(this,"isSolo",!1)}}var fi;(function(n){n[n.TrackName=0]="TrackName",n[n.BracesAndBrackets=1]="BracesAndBrackets",n[n.SystemSeparator=2]="SystemSeparator",n[n.StringTuning=3]="StringTuning"})(fi||(fi={}));class _c extends Mr{}const Da=class Da{constructor(){o(this,"index",0);o(this,"score");o(this,"staves",[]);o(this,"playbackInfo",new Ol);o(this,"color",new qe(200,0,0,255));o(this,"name","");o(this,"isVisibleOnMultiTrack",!0);o(this,"shortName","");o(this,"defaultSystemsLayout",3);o(this,"systemsLayout",[]);o(this,"lineBreaks");o(this,"percussionArticulations",[]);o(this,"style")}get isPercussion(){return this.staves.some(t=>t.isPercussion)}addLineBreaks(t){this.lineBreaks||(this.lineBreaks=new Set),this.lineBreaks.add(t)}ensureStaveCount(t){for(;this.staves.length<t;)this.addStaff(new cr)}addStaff(t){t.index=this.staves.length,t.track=this,this.staves.push(t)}finish(t,e=null){this.shortName||(this.shortName=this.name,this.shortName.length>Da._shortNameMaxLength&&(this.shortName=this.shortName.substr(0,Da._shortNameMaxLength)));for(const s of this.staves)s.finish(t,e),s.isPercussion&&(this.playbackInfo.program=0)}applyLyrics(t){for(const s of t)s.finish();const e=this.staves[0];for(let s=0;s<t.length;s++){const i=t[s];if(i.startBar>=0&&i.startBar<e.bars.length){let r=e.bars[i.startBar].voices[0].beats[0];for(let a=0;a<i.chunks.length&&r;a++){for(;r&&(r.isEmpty||r.isRest);)r=r.nextBeat;r&&(r.lyrics||(r.lyrics=new Array(t.length),r.lyrics.fill("")),r.lyrics[s]=i.chunks[a],r=r.nextBeat)}}}}};o(Da,"_shortNameMaxLength",10);let Ei=Da;var E;(function(n){n[n.Up=0]="Up",n[n.Down=1]="Down"})(E||(E={}));const Z=class Z{constructor(){o(this,"_allKnownBarMetaDataTags");o(this,"_knownScoreMetaDataTags");o(this,"_knownStructuralMetaDataTags");o(this,"_knownBarMetaDataTags");o(this,"_knownStaffMetaDataTags");o(this,"_knownBeatDurationProperties");o(this,"_knownBeatProperties");o(this,"_knownNoteProperties")}applyScoreMetaData(t,e,s){const i=this._checkArgumentTypes(t,[St.scoreMetaDataSignatures],s,s.tag.tag.text.toLowerCase(),s.arguments);if(i!==void 0)return i;switch(s.tag.tag.text.toLowerCase()){case"title":return e.title=s.arguments.arguments[0].text,this._headerFooterStyle(t,e,V.Title,s),B.Applied;case"subtitle":return e.subTitle=s.arguments.arguments[0].text,this._headerFooterStyle(t,e,V.SubTitle,s),B.Applied;case"artist":return e.artist=s.arguments.arguments[0].text,this._headerFooterStyle(t,e,V.Artist,s),B.Applied;case"album":return e.album=s.arguments.arguments[0].text,this._headerFooterStyle(t,e,V.Album,s),B.Applied;case"words":return e.words=s.arguments.arguments[0].text,this._headerFooterStyle(t,e,V.Words,s),B.Applied;case"music":return e.music=s.arguments.arguments[0].text,this._headerFooterStyle(t,e,V.Music,s),B.Applied;case"copyright":return e.copyright=s.arguments.arguments[0].text,this._headerFooterStyle(t,e,V.Copyright,s),B.Applied;case"instructions":return e.instructions=s.arguments.arguments[0].text,B.Applied;case"notices":return e.notices=s.arguments.arguments[0].text,B.Applied;case"tab":return e.tab=s.arguments.arguments[0].text,this._headerFooterStyle(t,e,V.Transcriber,s),B.Applied;case"copyright2":return this._headerFooterStyle(t,e,V.CopyrightSecondLine,s,0),B.Applied;case"wordsandmusic":return this._headerFooterStyle(t,e,V.WordsAndMusic,s,0),B.Applied;case"defaultsystemslayout":return e.defaultSystemsLayout=s.arguments.arguments[0].value,B.Applied;case"systemslayout":for(const g of s.arguments.arguments)e.systemsLayout.push(g.value);return B.Applied;case"hidedynamics":return e.stylesheet.hideDynamics=!0,B.Applied;case"showdynamics":return e.stylesheet.hideDynamics=!1,B.Applied;case"extendbarlines":return e.stylesheet.extendBarLines=!0,B.Applied;case"bracketextendmode":const r=Z._parseEnumValue(t,s.arguments,"bracket extend mode",ue.bracketExtendMode);return r===void 0?B.NotAppliedSemanticError:(e.stylesheet.bracketExtendMode=r,B.Applied);case"usesystemsignseparator":return e.stylesheet.useSystemSignSeparator=!0,B.Applied;case"multibarrest":return e.stylesheet.multiTrackMultiBarRest=!0,B.Applied;case"singletracktracknamepolicy":const a=Z._parseEnumValue(t,s.arguments,"track name policy",ue.trackNamePolicy);return a===void 0?B.NotAppliedSemanticError:(e.stylesheet.singleTrackTrackNamePolicy=a,B.Applied);case"multitracktracknamepolicy":const l=Z._parseEnumValue(t,s.arguments,"track name policy",ue.trackNamePolicy);return l===void 0?B.NotAppliedSemanticError:(e.stylesheet.multiTrackTrackNamePolicy=l,B.Applied);case"firstsystemtracknamemode":const h=Z._parseEnumValue(t,s.arguments,"track name mode",ue.trackNameMode);return h===void 0?B.NotAppliedSemanticError:(e.stylesheet.firstSystemTrackNameMode=h,B.Applied);case"othersystemstracknamemode":const c=Z._parseEnumValue(t,s.arguments,"track name mode",ue.trackNameMode);return c===void 0?B.NotAppliedSemanticError:(e.stylesheet.otherSystemsTrackNameMode=c,B.Applied);case"firstsystemtracknameorientation":const d=Z._parseEnumValue(t,s.arguments,"track name orientation",ue.trackNameOrientation);return d===void 0?B.NotAppliedSemanticError:(e.stylesheet.firstSystemTrackNameOrientation=d,B.Applied);case"othersystemstracknameorientation":const u=Z._parseEnumValue(t,s.arguments,"track name orientation",ue.trackNameOrientation);return u===void 0?B.NotAppliedSemanticError:(e.stylesheet.otherSystemsTrackNameOrientation=u,B.Applied);case"chorddiagramsinscore":return e.stylesheet.globalDisplayChordDiagramsInScore=s.arguments?Z._booleanLikeValue(s.arguments.arguments,0):!0,B.Applied;case"hideemptystaves":return e.stylesheet.hideEmptyStaves=!0,B.Applied;case"hideemptystavesinfirstsystem":return e.stylesheet.hideEmptyStavesInFirstSystem=!0,B.Applied;case"showsinglestaffbrackets":return e.stylesheet.showSingleStaffBrackets=!0,B.Applied;case"defaultbarnumberdisplay":const p=Z._parseEnumValue(t,s.arguments,"bar number display",ue.barNumberDisplay);return p===void 0?B.NotAppliedSemanticError:(e.stylesheet.barNumberDisplay=p,B.Applied);default:return B.NotAppliedUnrecognizedMarker}}_checkArgumentTypes(t,e,s,i,r){const a=e.find(h=>h.has(i));if(!a)return B.NotAppliedUnrecognizedMarker;const l=a.get(i);if(!l){r&&r.arguments.length>0&&t.addSemanticDiagnostic({code:_e.AT300,message:"Expected no arguments, but found some.",start:r.start,end:r.end,severity:me.Warning});return}if(!this._validateArgumentTypes(t,l,s,r))return B.NotAppliedSemanticError}applyStaffMetaData(t,e,s){const i=this._checkArgumentTypes(t,[St.staffMetaDataSignatures],s,s.tag.tag.text.toLowerCase(),s.arguments);if(i!==void 0)return i;switch(s.tag.tag.text.toLowerCase()){case"capo":return e.capo=s.arguments.arguments[0].value,B.Applied;case"tuning":const r=[];let a=!1,l="";for(let p=0;p<s.arguments.arguments.length;p++){const g=s.arguments.arguments[p],m=g.text;switch(m){case"piano":case"none":case"voice":t.applyStaffNoteKind(e,os.Pitched),p=s.arguments.arguments.length;break;case"hide":a=!0,t.addSemanticDiagnostic({code:_e.AT305,message:"This value should be rather specified via the properties.",start:g.start,end:g.end,severity:me.Warning});break;default:const y=A.parseTuning(m);if(y)r.push(y.realValue);else if(p===s.arguments.arguments.length-1&&r.length>0)l=m,t.addSemanticDiagnostic({code:_e.AT305,message:"This value should be rather specified via the properties.",start:g.start,end:g.end,severity:me.Warning});else{const S=Array.from(A.tuningLetters).join(","),k=Array.from(A.accidentalModeMapping.keys()).join(",");t.addSemanticDiagnostic({code:_e.AT209,message:`Unexpected tuning value '${m}', expected: <note><accidental><octave> where <note>=oneOf(${S}) <accidental>=oneOf(${k}), <octave>=number`,start:g.start,end:g.end,severity:me.Error})}break}}return t.state.staffHasExplicitTuning.add(e),t.state.staffTuningApplied.delete(e),e.stringTuning=new Vs,e.stringTuning.tunings=r,e.stringTuning.name=l,this._tuningProperties(t,e,e.stringTuning,s),a&&(e.track.score.stylesheet.perTrackDisplayTuning||(e.track.score.stylesheet.perTrackDisplayTuning=new Map),e.track.score.stylesheet.perTrackDisplayTuning.set(e.track.index,!1)),B.Applied;case"instrument":return t.state.staffTuningApplied.delete(e),this._readTrackInstrument(t,e.track,s.arguments),B.Applied;case"bank":return e.track.playbackInfo.bank=s.arguments.arguments[0].value,B.Applied;case"lyrics":const h=new hr;return h.startBar=0,h.text="",s.arguments.arguments.length===2?(h.startBar=s.arguments.arguments[0].value,h.text=s.arguments.arguments[1].text):h.text=s.arguments.arguments[0].text,t.state.lyrics.get(e.track.index).push(h),B.Applied;case"chord":const c=new Yi;this._chordProperties(t,c,s),c.name=s.arguments.arguments[0].text;for(let p=1;p<s.arguments.arguments.length;p++){const g=s.arguments.arguments[p];if(g.nodeType===C.Number)c.strings.push(g.value);else if(g.nodeType===C.Ident){const m=g.text;m==="x"?c.strings.push(-1):t.addSemanticDiagnostic({code:_e.AT209,message:`Unexpected chord value '${m}', expected: 'x'`,severity:me.Error,start:g.start,end:g.end})}}return e.addChord(Z._getChordId(e,c.name),c),B.Applied;case"articulation":const d=t.state.percussionArticulationNames,u=s.arguments.arguments[0].text;if(u==="defaults"){for(const[p,g]of jt.instrumentArticulationNames)d.set(p.toLowerCase(),g),d.set(A.toArticulationId(p),g);return B.Applied}if(s.arguments.arguments.length===2){const p=s.arguments.arguments[1].value,g=jt.getArticulationById(p);if(g)return d.set(u.toLowerCase(),g.uniqueId),B.Applied;{const m=Array.from(jt.instrumentArticulationIds()).map(y=>`${y}`).join(",");return t.addSemanticDiagnostic({code:_e.AT209,message:`Unexpected articulation value '${p}', expected: ${m}`,start:s.arguments.arguments[1].start,end:s.arguments.arguments[1].end,severity:me.Error}),B.NotAppliedSemanticError}}return B.Applied;case"accidentals":return Z._handleAccidentalMode(t,s.arguments);case"displaytranspose":return e.displayTranspositionPitch=s.arguments.arguments[0].value*-1,t.state.staffHasExplicitDisplayTransposition.add(e),B.Applied;case"transpose":return e.transpositionPitch=s.arguments.arguments[0].value*-1,B.Applied;default:return B.NotAppliedUnrecognizedMarker}}applyBarMetaData(t,e,s){const i=this._checkArgumentTypes(t,[St.barMetaDataSignatures],s,s.tag.tag.text.toLowerCase(),s.arguments);if(i!==void 0)return i;switch(s.tag.tag.text.toLowerCase()){case"sync":const r=this._buildSyncPoint(s);return t.state.syncPoints.push(r),B.Applied;case"tempo":let a=0;const l=s.arguments.arguments[a++].value;let h="",c=!0,d=0;for(;a<s.arguments.arguments.length;){switch(s.arguments.arguments[a].nodeType){case C.Ident:case C.String:const j=s.arguments.arguments[a].text;j==="hide"?c=!1:h=j;break;case C.Number:d=s.arguments.arguments[a].value;break}a++}let u=e.masterBar.tempoAutomations.find(j=>j.ratioPosition===d);return u||(u=new nt,e.masterBar.tempoAutomations.push(u)),u.isLinear=!1,u.type=Ve.Tempo,u.value=l,u.text=h,u.ratioPosition=d,u.isVisible=c,B.Applied;case"rc":return e.masterBar.repeatCount=s.arguments.arguments[0].value,B.Applied;case"ae":for(const j of s.arguments.arguments)if(j.nodeType===C.Number){const Q=j.value;if(Q<1||Q>31)return t.addSemanticDiagnostic({code:_e.AT211,message:"Value is out of valid range. Allowed range: %s, Actual Value: %s",severity:me.Error,start:j.start,end:j.end}),B.NotAppliedSemanticError;e.masterBar.alternateEndings|=1<<Q-1}else t.addSemanticDiagnostic({code:_e.AT202,message:`Unexpected '${C[j.nodeType]}' token. Expected one of following: ${C[C.Number]}`,severity:me.Error,start:j.start,end:j.end});return B.Applied;case"ts":switch(s.arguments.arguments[0].nodeType){case C.Number:if(e.masterBar.timeSignatureNumerator=s.arguments.arguments[0].value|0,(e.masterBar.timeSignatureNumerator<1||e.masterBar.timeSignatureNumerator>32)&&t.addSemanticDiagnostic({code:_e.AT211,message:`Value is out of valid range. Allowed range: 1-32, Actual Value: ${e.masterBar.timeSignatureNumerator}`,start:s.arguments.arguments[0].start,end:s.arguments.arguments[0].end,severity:me.Error}),e.masterBar.timeSignatureDenominator=s.arguments.arguments[1].value|0,!Z._timeSignatureDenominators.has(e.masterBar.timeSignatureDenominator)){const Q=Array.from(Z._timeSignatureDenominators).join(", ");t.addSemanticDiagnostic({code:_e.AT211,message:`Value is out of valid range. Allowed range: ${Q}, Actual Value: ${e.masterBar.timeSignatureDenominator}`,start:s.arguments.arguments[0].start,end:s.arguments.arguments[0].end,severity:me.Error})}break;case C.Ident:case C.String:const j=s.arguments.arguments[0].text;if(j.toLowerCase()==="common")e.masterBar.timeSignatureCommon=!0,e.masterBar.timeSignatureNumerator=4,e.masterBar.timeSignatureDenominator=4;else return t.addSemanticDiagnostic({code:_e.AT209,message:`Unexpected time signature value '${j}', expected: common or two numbers`,severity:me.Error,start:s.arguments.arguments[0].start,end:s.arguments.arguments[0].end}),B.NotAppliedSemanticError;break}return B.Applied;case"beaming":return this._parseBeamingRule(t,s,e.masterBar);case"ks":const p=Z._parseEnumValue(t,s.arguments,"key signature",ue.keySignature);if(p===void 0)return B.NotAppliedSemanticError;const g=Z._parseEnumValue(t,s.arguments,"key signature type",ue.keySignatureType);return g===void 0?B.NotAppliedSemanticError:(e.keySignature=p,e.keySignatureType=g,B.Applied);case"clef":switch(s.arguments.arguments[0].nodeType){case C.Ident:case C.String:const j=Z._parseEnumValue(t,s.arguments,"clef",ue.clef);if(j===void 0)return B.NotAppliedSemanticError;e.clef=j;break;case C.Number:const Q=s.arguments.arguments[0].value;switch(Q){case 0:e.clef=Fe.Neutral;break;case 43:e.clef=Fe.G2;break;case 65:e.clef=Fe.F4;break;case 48:e.clef=Fe.C3;break;case 60:e.clef=Fe.C4;break;default:return t.addSemanticDiagnostic({code:_e.AT209,message:`Unexpected clef value '${Q}', expected: ${Array.from(ue.clef.keys()).join(",")}`,severity:me.Error,start:s.arguments.arguments[0].start,end:s.arguments.arguments[0].end}),B.NotAppliedSemanticError}break}return B.Applied;case"section":const m=new aa;return s.arguments.arguments.length===1?m.text=s.arguments.arguments[0].text:(m.marker=s.arguments.arguments[0].text,m.text=s.arguments.arguments[1].text),e.masterBar.section=m,B.Applied;case"tf":switch(s.arguments.arguments[0].nodeType){case C.Ident:case C.String:const j=Z._parseEnumValue(t,s.arguments,"triplet feel",ue.tripletFeel);if(j===void 0)return B.NotAppliedSemanticError;e.masterBar.tripletFeel=j;break;case C.Number:const Q=s.arguments.arguments[0].value;switch(Q){case 0:e.masterBar.tripletFeel=Me.NoTripletFeel;break;case 1:e.masterBar.tripletFeel=Me.Triplet16th;break;case 2:e.masterBar.tripletFeel=Me.Triplet8th;break;case 3:e.masterBar.tripletFeel=Me.Dotted16th;break;case 4:e.masterBar.tripletFeel=Me.Dotted8th;break;case 5:e.masterBar.tripletFeel=Me.Scottish16th;break;case 6:e.masterBar.tripletFeel=Me.Scottish8th;break;default:return t.addSemanticDiagnostic({code:_e.AT209,message:`Unexpected triplet feel value '${Q}', expected: ${Array.from(ue.tripletFeel.keys()).join(",")}`,severity:me.Error,start:s.arguments.arguments[0].start,end:s.arguments.arguments[0].end}),B.NotAppliedSemanticError}break}return B.Applied;case"barlineleft":const y=Z._parseEnumValue(t,s.arguments,"bar line",ue.barLineStyle);return y===void 0?B.NotAppliedSemanticError:(e.barLineLeft=y,B.Applied);case"barlineright":const S=Z._parseEnumValue(t,s.arguments,"bar line",ue.barLineStyle);return S===void 0?B.NotAppliedSemanticError:(e.barLineRight=S,B.Applied);case"accidentals":return Z._handleAccidentalMode(t,s.arguments);case"voicemode":return Z._handleVoiceMode(t,s.arguments);case"jump":const k=Z._parseEnumValue(t,s.arguments,"direction",ue.direction);return k===void 0?B.NotAppliedSemanticError:(e.masterBar.addDirection(k),B.Applied);case"ottava":const T=Z._parseEnumValue(t,s.arguments,"clef ottava",ue.ottavia);return T===void 0?B.NotAppliedSemanticError:(e.clefOttava=T,B.Applied);case"simile":const N=Z._parseEnumValue(t,s.arguments,"simile mark",ue.simileMark);return N===void 0?B.NotAppliedSemanticError:(e.simileMark=N,B.Applied);case"width":return e.masterBar.displayWidth=s.arguments.arguments[0].value,e.displayWidth=e.masterBar.displayWidth,B.Applied;case"scale":return e.masterBar.displayScale=s.arguments.arguments[0].value,e.displayScale=e.masterBar.displayScale,B.Applied;case"spd":const F=new Vi;return F.pedalType=lt.Down,F.ratioPosition=s.arguments.arguments[0].value,e.sustainPedals.push(F),B.Applied;case"spu":const q=new Vi;return q.pedalType=lt.Up,q.ratioPosition=s.arguments.arguments[0].value,e.sustainPedals.push(q),B.Applied;case"sph":const U=new Vi;return U.pedalType=lt.Hold,U.ratioPosition=s.arguments.arguments[0].value,e.sustainPedals.push(U),B.Applied;case"ft":return e.masterBar.isFreeTime=!0,B.Applied;case"ro":return e.masterBar.isRepeatStart=!0,B.Applied;case"ac":return e.masterBar.isAnacrusis=!0,B.Applied;case"db":return e.masterBar.isDoubleBar=!0,e.barLineRight=Be.LightLight,B.Applied;case"barnumberdisplay":const x=Z._parseEnumValue(t,s.arguments,"bar number display",ue.barNumberDisplay);return x===void 0?B.NotAppliedSemanticError:(e.barNumberDisplay=x,B.Applied);default:return B.NotAppliedUnrecognizedMarker}}_parseBeamingRule(t,e,s){let i=b.Eighth;const r=[],a=e.arguments.arguments[0].value;switch(a){case 4:i=b.QuadrupleWhole;break;case 8:i=b.Eighth;break;case 16:i=b.Sixteenth;break;case 32:i=b.ThirtySecond;break;default:return t.addSemanticDiagnostic({code:_e.AT209,message:`Value is out of valid range. Allowed range: 4,8,16 or 32, Actual Value: ${a}`,severity:me.Error,start:e.arguments.arguments[0].start,end:e.arguments.arguments[0].end}),B.NotAppliedSemanticError}for(let l=1;l<e.arguments.arguments.length;l++){if(e.arguments.arguments[l].value<1)return t.addSemanticDiagnostic({code:_e.AT209,message:`Value is out of valid range. Allowed range: >0, Actual Value: ${a}`,severity:me.Error,start:e.arguments.arguments[l].start,end:e.arguments.arguments[l].end}),B.NotAppliedSemanticError;r.push(e.arguments.arguments[l].value)}return s.beamingRules||(s.beamingRules=new dt),s.beamingRules.groups.set(i,r),B.Applied}static _handleAccidentalMode(t,e){const s=Z._parseEnumValue(t,e,"accidental mode",ue.alphaTexAccidentalMode);return s===void 0?B.NotAppliedSemanticError:(t.state.accidentalMode=s,B.Applied)}static _handleVoiceMode(t,e){const s=Z._parseEnumValue(t,e,"voice mode",ue.alphaTexVoiceMode);return s===void 0?B.NotAppliedSemanticError:(t.state.voiceMode=s,B.Applied)}static _getChordId(t,e){return e.toLowerCase()+t.index+t.track.index}_buildSyncPoint(t){const e=t.arguments.arguments[0].value,s=t.arguments.arguments[1].value,i=t.arguments.arguments[2].value;let r=0;return t.arguments.arguments.length>3&&(r=t.arguments.arguments[3].value),{barIndex:e,barOccurence:s,barPosition:r,millisecondOffset:i}}_validateArgumentTypes(t,e,s,i){if(!i)return e.some(u=>u.parameters.length===0||!u.parameters.some(p=>p.parseMode===Rt.Required||p.parseMode===Rt.RequiredAsFloat||p.parseMode===Rt.RequiredAsValueList))?!0:(t.addSemanticDiagnostic({code:_e.AT219,message:`Error parsing arguments: no overload matched arguments ${ki.generateSignaturesFromArguments(void 0)}. Signatures: ${ki.generateSignatures(e)}`,severity:me.Error,start:s.start,end:s.end}),!1);if(i.validated)return!0;let r=!1;const a=new Map(e.map((d,u)=>[u,{signature:d,parameterIndex:0,parameterValueMatches:0,parameterHasValues:!1}])),l=t.parseMode===Cr.Full,h=l?(d,u)=>{const p=a.get(u),g=d;g.parameterIndices||(g.parameterIndices=new Map),g.parameterIndices.set(u,p.parameterIndex)}:(d,u)=>{};for(const d of i.arguments)if(ki.filterSignatureCandidates(a,d,!1,h),a.size===0)break;const c=l?Array.from(a.entries()):void 0;return ki.filterIncompleteCandidates(a),a.size===0&&(t.addSemanticDiagnostic({code:_e.AT219,message:`Error parsing arguments: no overload matched arguments ${ki.generateSignaturesFromArguments(i.arguments)}. Signatures:
${ki.generateSignatures(e)}`,severity:me.Error,start:i.start,end:i.end}),r=!0),c&&(ki.sortCandidates(c),i.signatureCandidateIndices=c.map(d=>d[0])),!r}_headerFooterStyle(t,e,s,i,r=1){const a=i.arguments.arguments.length-r;if(a<1)return;const l=A.getOrCreateHeaderFooterStyle(e,s);l.isVisible===void 0&&(l.isVisible=!0);const h=i.arguments.arguments[r].text;if(h?l.template=h:l.isVisible=!1,a<2)return;const c=Z._parseEnumValue(t,i.arguments,"textAlign",ue.textAlign,r+1);c!==void 0&&(l.textAlign=c)}_readTrackInstrument(t,e,s){switch(s.arguments[0].nodeType){case C.Number:const i=s.arguments[0].value;i>=0&&i<=127?e.playbackInfo.program=i:t.addSemanticDiagnostic({code:_e.AT211,message:`Value is out of valid range. Allowed range: 0-127, Actual Value: ${i}`,start:s.arguments[0].start,end:s.arguments[0].end,severity:me.Error});break;case C.Ident:case C.String:const r=s.arguments[0].text.toLowerCase();if(r==="percussion"){for(const a of e.staves)t.applyStaffNoteKind(a,os.Articulation);e.playbackInfo.primaryChannel=ye.PercussionChannel,e.playbackInfo.secondaryChannel=ye.PercussionChannel}else e.playbackInfo.program=ui.getValue(r);break}}_chordProperties(t,e,s){if(s.properties){for(const i of s.properties.properties)if(this._checkProperty(t,[St.metaDataProperties.get("chord")],i))switch(i.property.text.toLowerCase()){case"firstfret":e.firstFret=i.arguments.arguments[0].value;break;case"showdiagram":e.showDiagram=Z._booleanLikeValue(i.arguments.arguments,0);break;case"showfingering":e.showFingering=Z._booleanLikeValue(i.arguments.arguments,0);break;case"showname":e.showName=Z._booleanLikeValue(i.arguments.arguments,0);break;case"barre":e.barreFrets=i.arguments.arguments.map(r=>r.value);break}}}_tuningProperties(t,e,s,i){if(i.properties){for(const r of i.properties.properties)if(this._checkProperty(t,[St.metaDataProperties.get("tuning")],r))switch(r.property.text.toLowerCase()){case"hide":e.track.score.stylesheet.perTrackDisplayTuning||(e.track.score.stylesheet.perTrackDisplayTuning=new Map),e.track.score.stylesheet.perTrackDisplayTuning.set(e.track.index,!1);break;case"label":s.name=r.arguments.arguments[0].text;break}}}static _booleanLikeValue(t,e){if(e>=t.length)return!0;const s=t[e];switch(s.nodeType){case C.String:case C.Ident:return s.text!=="false";case C.Number:return s.value!==0;default:return!1}}applyStructuralMetaData(t,e){const s=this._checkArgumentTypes(t,[St.structuralMetaDataSignatures],e,e.tag.tag.text.toLowerCase(),e.arguments);if(s!==void 0)switch(s){case B.NotAppliedSemanticError:return li.NotAppliedSemanticError;case B.NotAppliedUnrecognizedMarker:return li.NotAppliedUnrecognizedMarker}switch(e.tag.tag.text.toLowerCase()){case"staff":const i=t.startNewStaff();return this._staffProperties(t,i,e),li.AppliedNewStaff;case"track":const r=t.startNewTrack();return e.arguments&&e.arguments.arguments.length>0&&(r.name=e.arguments.arguments[0].text,e.arguments.arguments.length>1&&(r.shortName=e.arguments.arguments[1].text)),this._trackProperties(t,r,e),li.AppliedNewTrack;case"voice":return t.startNewVoice(),li.AppliedNewVoice;default:return li.NotAppliedUnrecognizedMarker}}_checkProperty(t,e,s){const i=this._checkArgumentTypes(t,e,s,s.property.text.toLowerCase(),s.arguments);if(i!==void 0)switch(i){case B.Applied:case B.NotAppliedSemanticError:return!1;case B.NotAppliedUnrecognizedMarker:const r=e.flatMap(a=>Array.from(a.keys()));return t.addSemanticDiagnostic({code:_e.AT212,message:`Unrecogized property '${s.property.text}', expected one of ${r}`,severity:me.Error,start:s.start,end:s.end}),!1}return!0}_staffProperties(t,e,s){if(!s.properties)return;let i=!1,r=!1,a=!1,l=!1;for(const h of s.properties.properties)if(this._checkProperty(t,[St.metaDataProperties.get("staff")],h))switch(h.property.text.toLowerCase()){case"score":i=!0,h.arguments&&h.arguments.arguments.length>0&&(e.standardNotationLineCount=h.arguments.arguments[0].value);break;case"tabs":r=!0;break;case"slash":a=!0;break;case"numbered":l=!0;break}(i||r||a||l)&&(e.showStandardNotation=i,e.showTablature=r,e.showSlash=a,e.showNumbered=l)}_trackProperties(t,e,s){if(s.properties){for(const i of s.properties.properties)if(this._checkProperty(t,[St.metaDataProperties.get("track")],i))switch(i.property.text.toLowerCase()){case"color":try{e.color=qe.fromJson(i.arguments.arguments[0].text)}catch{t.addSemanticDiagnostic({code:_e.AT213,message:"Invalid format for color",severity:me.Error,start:i.arguments.arguments[0].start,end:i.arguments.arguments[0].end})}break;case"defaultsystemslayout":e.defaultSystemsLayout=i.arguments.arguments[0].value;break;case"systemslayout":e.systemsLayout=i.arguments.arguments.map(r=>r.value);break;case"volume":e.playbackInfo.volume=i.arguments.arguments[0].value;break;case"balance":e.playbackInfo.balance=i.arguments.arguments[0].value;break;case"mute":e.playbackInfo.isMute=!0;break;case"solo":e.playbackInfo.isSolo=!0;break;case"multibarrest":e.score.stylesheet.perTrackMultiBarRest||(e.score.stylesheet.perTrackMultiBarRest=new Set),e.score.stylesheet.perTrackMultiBarRest.add(e.index);break;case"instrument":this._readTrackInstrument(t,e,i.arguments);break;case"bank":e.playbackInfo.bank=i.arguments.arguments[0].value;break}}}applyBeatDurationProperty(t,e){const s=this._checkArgumentTypes(t,[St.durationChangeProperties],e,e.property.text.toLowerCase(),e.arguments);if(s!==void 0)return s;switch(e.property.text.toLowerCase()){case"tu":if(e.arguments.arguments.length===2)t.state.currentTupletNumerator=e.arguments.arguments[0].value,t.state.currentTupletDenominator=e.arguments.arguments[1].value;else{const i=e.arguments.arguments[0].value;t.state.currentTupletNumerator=i;const r=Z._getTupletDenominator(i);r<0?(t.addSemanticDiagnostic({code:_e.AT209,message:`Unexpected default tuplet value '${i}', expected: 3, 5, 6, 7, 9, 10, 11 or 12`,severity:me.Error,start:e.arguments.arguments[0].start,end:e.arguments.arguments[0].end}),t.state.currentTupletNumerator=-1,t.state.currentTupletDenominator=-1):t.state.currentTupletDenominator=r}return B.Applied}return B.NotAppliedUnrecognizedMarker}static _getTupletDenominator(t){switch(t){case 3:return 2;case 5:return 4;case 6:return 4;case 7:return 4;case 9:return 8;case 10:return 8;case 11:return 8;case 12:return 8;default:return-1}}get allKnownMetaDataTags(){if(!this._allKnownBarMetaDataTags){this._allKnownBarMetaDataTags=new Set;const t=[St.scoreMetaDataSignatures.keys(),St.structuralMetaDataSignatures.keys(),St.staffMetaDataSignatures.keys(),St.barMetaDataSignatures.keys()];for(const e of t)for(const s of e)this._allKnownBarMetaDataTags.add(s)}return this._allKnownBarMetaDataTags}get knownScoreMetaDataTags(){return this._knownScoreMetaDataTags||(this._knownScoreMetaDataTags=new Set(St.scoreMetaDataSignatures.keys())),this._knownScoreMetaDataTags}get knownStructuralMetaDataTags(){return this._knownStructuralMetaDataTags||(this._knownStructuralMetaDataTags=new Set(St.structuralMetaDataSignatures.keys())),this._knownStructuralMetaDataTags}get knownBarMetaDataTags(){return this._knownBarMetaDataTags||(this._knownBarMetaDataTags=new Set(St.barMetaDataSignatures.keys())),this._knownBarMetaDataTags}get knownStaffMetaDataTags(){return this._knownStaffMetaDataTags||(this._knownStaffMetaDataTags=new Set(St.staffMetaDataSignatures.keys())),this._knownStaffMetaDataTags}get knownBeatDurationProperties(){return this._knownBeatDurationProperties||(this._knownBeatDurationProperties=new Set(St.durationChangeProperties.keys())),this._knownBeatDurationProperties}get knownBeatProperties(){return this._knownBeatProperties||(this._knownBeatProperties=new Set(St.beatProperties.keys())),this._knownBeatProperties}get knownNoteProperties(){return this._knownNoteProperties||(this._knownNoteProperties=new Set(St.noteProperties.keys())),this._knownNoteProperties}applyBeatProperty(t,e,s){const i=s.property.text.toLowerCase(),r=this._checkArgumentTypes(t,[St.beatProperties],s,i,s.arguments);if(r!==void 0)return r;switch(i){case"f":return e.fade=Nt.FadeIn,B.Applied;case"fo":return e.fade=Nt.FadeOut,B.Applied;case"vs":return e.fade=Nt.VolumeSwell,B.Applied;case"v":return e.vibrato=Ee.Slight,B.Applied;case"vw":return e.vibrato=Ee.Wide,B.Applied;case"s":return e.slap=!0,B.Applied;case"p":return e.pop=!0,B.Applied;case"tt":return e.tap=!0,B.Applied;case"txt":return e.text=s.arguments.arguments[0].text,B.Applied;case"lyrics":let a=0,l="";for(s.arguments.arguments.length===2?(a=s.arguments.arguments[0].value,l=s.arguments.arguments[1].text):l=s.arguments.arguments[0].text,e.lyrics||(e.lyrics=[]);e.lyrics.length<=a;)e.lyrics.push("");return e.lyrics[a]=l,B.Applied;case"dd":return e.dots=2,B.Applied;case"d":return e.dots=1,B.Applied;case"su":return e.pickStroke=Ot.Up,B.Applied;case"sd":return e.pickStroke=Ot.Down,B.Applied;case"tu":if(s.arguments.arguments.length===2)e.tupletNumerator=s.arguments.arguments[0].value,e.tupletDenominator=s.arguments.arguments[1].value;else{const ce=s.arguments.arguments[0].value;e.tupletNumerator=ce;const rt=Z._getTupletDenominator(ce);if(rt<0)return t.addSemanticDiagnostic({code:_e.AT209,message:`Unexpected default tuplet value '${ce}', expected: 3, 5, 6, 7, 9, 10, 11 or 12`,severity:me.Error,start:s.arguments.arguments[0].start,end:s.arguments.arguments[0].end}),e.tupletNumerator=-1,e.tupletDenominator=-1,B.NotAppliedSemanticError;e.tupletDenominator=rt}return B.Applied;case"tb":case"tbe":let h=0,c=!0,d=!1;for(;c;)switch(s.arguments.arguments[h].nodeType){case C.Ident:case C.String:const ce=s.arguments.arguments[h].text.toLowerCase();if(ue.whammyType.has(ce))e.whammyBarType=ue.whammyType.get(ce),d=!0,h++;else if(ue.bendStyle.has(ce))e.whammyStyle=ue.bendStyle.get(ce),h++;else return d?Z._parseEnumValue(t,s.arguments,"whammy style",ue.bendStyle,h):Z._parseEnumValue(t,s.arguments,"whammy type",ue.whammyType,h),B.NotAppliedSemanticError;break;default:c=!1;break}const u=this._getBendPoints(t,s,h,i==="tbe");if(u)for(const ce of u)e.addWhammyBarPoint(ce);return B.Applied;case"bu":return Z._applyBrush(e,s,Y.BrushUp,.25),B.Applied;case"bd":return Z._applyBrush(e,s,Y.BrushDown,.25),B.Applied;case"au":return Z._applyBrush(e,s,Y.ArpeggioUp,1),B.Applied;case"ad":return Z._applyBrush(e,s,Y.ArpeggioDown,1),B.Applied;case"ch":const p=s.arguments.arguments[0].text,g=Z._getChordId(e.voice.bar.staff,p);if(!e.voice.bar.staff.hasChord(g)){const ce=new Yi;ce.showDiagram=!1,ce.name=p,e.voice.bar.staff.addChord(g,ce)}return e.chordId=g,B.Applied;case"gr":if(s.arguments&&s.arguments.arguments.length>0){const ce=Z._parseEnumValue(t,s.arguments,"whammy style",ue.graceType);if(ce===void 0)return B.NotAppliedSemanticError;e.graceType=ce}else e.graceType=ee.BeforeBeat;return B.Applied;case"dy":const m=Z._parseEnumValue(t,s.arguments,"dynamic",ue.dynamicValue);return m===void 0?B.NotAppliedSemanticError:(e.dynamics=m,t.state.currentDynamics=m,B.Applied);case"cre":return e.crescendo=Jt.Crescendo,B.Applied;case"dec":return e.crescendo=Jt.Decrescendo,B.Applied;case"tempo":const y=s.arguments.arguments[0].value;let S="",k=!0;if(s.arguments.arguments.length>2){S=s.arguments.arguments[1].text;const ce=s.arguments.arguments[2].text;if(ce==="hide")k=!1;else return t.addSemanticDiagnostic({code:_e.AT209,message:`Unexpected third tempo property value '${ce}', expected: 'hide'`,severity:me.Error,start:s.arguments.arguments[2].start,end:s.arguments.arguments[2].end}),B.NotAppliedSemanticError}else s.arguments.arguments.length>1&&(S=s.arguments.arguments[1].text,S==="hide"&&(k=!1,S=""));const T=new nt;return T.isLinear=!1,T.type=Ve.Tempo,T.value=y,T.text=S,T.isVisible=k,e.automations.push(T),e.voice.bar.masterBar.tempoAutomations.push(T),B.Applied;case"volume":const N=new nt;return N.isLinear=!0,N.type=Ve.Volume,N.value=s.arguments.arguments[0].value,e.automations.push(N),B.Applied;case"balance":const F=new nt;return F.isLinear=!0,F.type=Ve.Balance,F.value=A.clamp(s.arguments.arguments[0].value,0,16),e.automations.push(F),B.Applied;case"tp":const q=new Ns;if(e.tremoloPicking=q,s.arguments&&s.arguments.arguments.length>0){if(s.arguments.arguments.length>0){const ce=s.arguments.arguments[0].value;if(ce>=Ns.minMarks&&ce<=Ns.maxMarks)q.marks=ce;else switch(ce){case 8:q.marks=1;break;case 16:q.marks=2;break;case 32:q.marks=3;break;default:return t.addSemanticDiagnostic({code:_e.AT209,message:`Unexpected tremolo marks value '${ce}, expected: ${Ns.minMarks}-${Ns.maxMarks}, or legacy: 8, 16 or 32`,severity:me.Error,start:s.arguments.arguments[0].start,end:s.arguments.arguments[0].end}),B.NotAppliedSemanticError}}if(s.arguments.arguments.length>1){const ce=Z._parseEnumValue(t,s.arguments,"tremolo picking style",ue.tremoloPickingStyle,1);if(ce===void 0)return B.NotAppliedSemanticError;q.style=ce}}return B.Applied;case"spd":return Z._applySustainPedal(t,e,lt.Down),B.Applied;case"sph":return Z._applySustainPedal(t,e,lt.Hold),B.Applied;case"spu":return Z._applySustainPedal(t,e,lt.Up),B.Applied;case"spe":return Z._applySustainPedal(t,e,lt.Up,!0),B.Applied;case"slashed":return e.slashed=!0,B.Applied;case"ds":return e.deadSlapped=!0,e.notes.length===1&&e.notes[0].isDead&&e.removeNote(e.notes[0]),B.Applied;case"glpf":return e.golpe=as.Finger,B.Applied;case"glpt":return e.golpe=as.Thumb,B.Applied;case"waho":return e.wahPedal=ps.Open,B.Applied;case"wahc":return e.wahPedal=ps.Closed,B.Applied;case"barre":if(e.barreFret=s.arguments.arguments[0].value,e.barreShape=Hs.Full,s.arguments.arguments.length>1){const ce=Z._parseEnumValue(t,s.arguments,"barre shape",ue.barreShape,1);if(ce===void 0)return B.NotAppliedSemanticError;e.barreShape=ce}return B.Applied;case"rasg":const U=Z._parseEnumValue(t,s.arguments,"rasgueado pattern",ue.rasgueado);return U===void 0?B.NotAppliedSemanticError:(e.rasgueado=U,B.Applied);case"ot":const x=Z._parseEnumValue(t,s.arguments,"ottava",ue.ottavia);return x===void 0?B.NotAppliedSemanticError:(e.ottava=x,B.Applied);case"legatoorigin":return e.isLegatoOrigin=!0,B.Applied;case"instrument":let j=0;switch(s.arguments.arguments[0].nodeType){case C.Ident:case C.String:j=ui.getValue(s.arguments.arguments[0].text);break;case C.Number:j=s.arguments.arguments[0].value;break}const Q=new nt;return Q.isLinear=!1,Q.type=Ve.Instrument,Q.value=j,e.automations.push(Q),B.Applied;case"bank":const Te=new nt;return Te.isLinear=!1,Te.type=Ve.Bank,Te.value=s.arguments.arguments[0].value,e.automations.push(Te),B.Applied;case"fermata":const te=Z._parseEnumValue(t,s.arguments,"fermata",ue.fermataType);if(te===void 0)return B.NotAppliedSemanticError;const we=new ra;return we.type=te,s.arguments.arguments.length>1&&(we.length=s.arguments.arguments[1].value),e.fermata=we,B.Applied;case"beam":const $e=s.arguments.arguments[0].text;switch($e.toLowerCase()){case"invert":e.invertBeamDirection=!0;break;case"up":e.preferredBeamDirection=E.Up;break;case"down":e.preferredBeamDirection=E.Down;break;case"auto":e.beamingMode=ot.Auto;break;case"split":e.beamingMode=ot.ForceSplitToNext;break;case"merge":e.beamingMode=ot.ForceMergeWithNext;break;case"splitsecondary":e.beamingMode=ot.ForceSplitOnSecondaryToNext;break;default:const ce=["invert","up","down","auto","split","merge","splitsecondary"];return t.addSemanticDiagnostic({code:_e.AT209,message:`Unexpected beam value '${$e}', expected: ${ce.join(",")}`,severity:me.Error,start:s.arguments.arguments[0].start,end:s.arguments.arguments[0].end}),B.NotAppliedSemanticError}return B.Applied;case"timer":return e.showTimer=!0,B.Applied}return B.NotAppliedUnrecognizedMarker}static _applySustainPedal(t,e,s,i=!1){const r=new Vi;r.pedalType=s,i?r.ratioPosition=1:r.ratioPosition=.001*e.voice.bar.sustainPedals.length,t.state.sustainPedalToBeat.set(r,e),e.voice.bar.sustainPedals.push(r)}static _applyBrush(t,e,s,i){t.brushType=s,e.arguments&&e.arguments.arguments.length>0?t.brushDuration=e.arguments.arguments[0].value:(t.updateDurations(),t.brushDuration=t.playbackDuration*i/t.notes.length)}applyNoteProperty(t,e,s){const i=s.property.text.toLowerCase(),r=this._checkArgumentTypes(t,[St.noteProperties],s,i,s.arguments);if(r!==void 0)return r;switch(i){case"b":case"be":let a=0,l=!0,h=!1;for(;l;)switch(s.arguments.arguments[a].nodeType){case C.Ident:case C.String:const y=s.arguments.arguments[a].text.toLowerCase();if(ue.bendType.has(y))e.bendType=ue.bendType.get(y),h=!0,a++;else if(ue.bendStyle.has(y))e.bendStyle=ue.bendStyle.get(y),a++;else return h?Z._parseEnumValue(t,s.arguments,"bend style",ue.bendStyle,a):Z._parseEnumValue(t,s.arguments,"bend type",ue.bendType,a),B.NotAppliedSemanticError;break;default:l=!1;break}const c=this._getBendPoints(t,s,a,i==="be");if(c)for(const y of c)e.addBendPoint(y);return B.Applied;case"nh":return e.harmonicType=ie.Natural,e.harmonicValue=A.deltaFretToHarmonicValue(e.fret),B.Applied;case"ah":return e.harmonicType=ie.Artificial,e.harmonicValue=Z._harmonicValue(s.arguments,e.harmonicValue),B.Applied;case"th":return e.harmonicType=ie.Tap,e.harmonicValue=Z._harmonicValue(s.arguments,e.harmonicValue),B.Applied;case"ph":return e.harmonicType=ie.Pinch,e.harmonicValue=Z._harmonicValue(s.arguments,e.harmonicValue),B.Applied;case"sh":return e.harmonicType=ie.Semi,e.harmonicValue=Z._harmonicValue(s.arguments,e.harmonicValue),B.Applied;case"fh":return e.harmonicType=ie.Feedback,e.harmonicValue=Z._harmonicValue(s.arguments,e.harmonicValue),B.Applied;case"tr":const d=s.arguments.arguments[0].value;let u=b.Sixteenth;if(s.arguments.arguments.length>1){const y=s.arguments.arguments[1].value;switch(y){case 16:u=b.Sixteenth;break;case 32:u=b.ThirtySecond;break;case 64:u=b.SixtyFourth;break;default:return t.addSemanticDiagnostic({code:_e.AT209,message:`Unexpected trill duration value '${y}', expected: 16, 32 or 64`,severity:me.Error,start:s.arguments.arguments[1].start,end:s.arguments.arguments[1].end}),B.NotAppliedSemanticError}}return e.trillValue=d+e.stringTuning,e.trillSpeed=u,B.Applied;case"v":return e.vibrato=Ee.Slight,B.Applied;case"vw":return e.vibrato=Ee.Wide,B.Applied;case"sl":return e.slideOutType=ge.Legato,B.Applied;case"ss":return e.slideOutType=ge.Shift,B.Applied;case"sib":return e.slideInType=Et.IntoFromBelow,B.Applied;case"sia":return e.slideInType=Et.IntoFromAbove,B.Applied;case"sou":return e.slideOutType=ge.OutUp,B.Applied;case"sod":return e.slideOutType=ge.OutDown,B.Applied;case"psd":return e.slideOutType=ge.PickSlideDown,B.Applied;case"psu":return e.slideOutType=ge.PickSlideUp,B.Applied;case"h":return e.isHammerPullOrigin=!0,B.Applied;case"lht":return e.isLeftHandTapped=!0,B.Applied;case"g":return e.isGhost=!0,B.Applied;case"ac":return e.accentuated=mt.Normal,B.Applied;case"hac":return e.accentuated=mt.Heavy,B.Applied;case"ten":return e.accentuated=mt.Tenuto,B.Applied;case"pm":return e.isPalmMute=!0,B.Applied;case"st":return e.isStaccato=!0,B.Applied;case"lr":return e.isLetRing=!0,B.Applied;case"x":return e.isDead=!0,B.Applied;case"-":case"t":return e.isTieDestination=!0,B.Applied;case"lf":let p=ae.Thumb;if(s.arguments&&s.arguments.arguments.length>0){const y=Z._toFinger(t,s.arguments);if(y===void 0)return B.NotAppliedSemanticError;p=y}return e.leftHandFinger=p,B.Applied;case"rf":let g=ae.Thumb;if(s.arguments&&s.arguments.arguments.length>0){const y=Z._toFinger(t,s.arguments);if(y===void 0)return B.NotAppliedSemanticError;g=y}return e.rightHandFinger=g,B.Applied;case"acc":return e.accidentalMode=A.parseAccidentalMode(s.arguments.arguments[0].text),B.Applied;case"turn":return e.ornament=ut.Turn,B.Applied;case"iturn":return e.ornament=ut.InvertedTurn,B.Applied;case"umordent":return e.ornament=ut.UpperMordent,B.Applied;case"lmordent":return e.ornament=ut.LowerMordent,B.Applied;case"string":return e.showStringNumber=!0,B.Applied;case"hide":return e.isVisible=!1,B.Applied;case"slur":const m=s.arguments.arguments[0].text;if(t.state.slurs.has(m)){const y=t.state.slurs.get(m);y.slurDestination=e,e.slurOrigin=y,e.isSlurDestination=!0}else t.state.slurs.set(m,e);return B.Applied;default:return this.applyBeatProperty(t,e.beat,s)}return B.NotAppliedUnrecognizedMarker}static _toFinger(t,e){const s=e.arguments[0].value;switch(s){case 1:return ae.Thumb;case 2:return ae.IndexFinger;case 3:return ae.MiddleFinger;case 4:return ae.AnnularFinger;case 5:return ae.LittleFinger;default:t.addSemanticDiagnostic({code:_e.AT211,message:`Value is out of valid range. Allowed range: 1-5, Actual Value: ${s}`,start:e.arguments[0].start,end:e.arguments[0].end,severity:me.Error});return}}static _harmonicValue(t,e){return t&&(e=t.arguments[0].value),e}_getBendPoints(t,e,s,i){let r=e.arguments.arguments,a=r.length-s,l=e.arguments;a>0&&r[s].nodeType===C.Arguments&&(r=r[s].arguments,s=0,a=r.length,l=r[s]);const h=i?2:1;if(a%h!==0){const u=Math.ceil(a/h),p=u*h;t.addSemanticDiagnostic({code:_e.AT214,message:`The '${e.property.text}' effect needs ${h} arguments per item. With ${u} points, ${p} arguments are needed, only ${a} arguments found.`,severity:me.Error,start:l.end,end:l.end});return}const c=[];let d=s;for(;d<r.length;){let u=0,p=0;i?(u=r[d++].value,p=r[d++].value):(u=0,p=r[d++].value),c.push(new H(u,p))}if(c.length>0){if(c.length>60&&c.splice(60,c.length-60),i)c.sort((u,p)=>u.offset-p.offset);else{const u=c.length,p=H.MaxPosition/(u-1)|0;let g=0;for(;g<u;)c[g].offset=Math.min(H.MaxPosition,g*p),g++}return c}else return}static _parseEnumValue(t,e,s,i,r=0){if(r>=e.arguments.length)return;const a=e.arguments[r].text;if(i.has(a.toLowerCase()))return i.get(a.toLowerCase());t.addSemanticDiagnostic({code:_e.AT209,message:`Unexpected ${s} value '${a}', expected: ${Array.from(i.keys()).join(",")}`,severity:me.Error,start:e.arguments[r].start,end:e.arguments[r].end})}buildScoreMetaDataNodes(t){const e=[];return Z._buildScoreInfoMeta(e,"album",t,t.album,V.Album),Z._buildScoreInfoMeta(e,"artist",t,t.artist,V.Artist),Z._buildScoreInfoMeta(e,"copyright",t,t.copyright,V.Copyright),Z._buildScoreInfoMeta(e,"copyright2",t,void 0,V.CopyrightSecondLine),Z._buildScoreInfoMeta(e,"wordsandmusic",t,void 0,V.WordsAndMusic,!0),Z._buildScoreInfoMeta(e,"instructions",t,t.instructions,void 0),Z._buildScoreInfoMeta(e,"music",t,t.music,V.Music),Z._buildScoreInfoMeta(e,"notices",t,t.notices,void 0),Z._buildScoreInfoMeta(e,"subtitle",t,t.subTitle,V.SubTitle),Z._buildScoreInfoMeta(e,"title",t,t.title,V.Title),Z._buildScoreInfoMeta(e,"words",t,t.words,V.Words),Z._buildScoreInfoMeta(e,"tab",t,t.tab,V.Transcriber),t.defaultSystemsLayout!==Z._defaultScore.defaultSystemsLayout&&e.push(_.numberMeta("defaultSystemsLayout",t.defaultSystemsLayout)),t.systemsLayout.length>0&&e.push(_.meta("systemsLayout",_.args(t.systemsLayout.map(s=>_.number(s))))),Z._buildStyleSheetMetaData(e,t.stylesheet),e.length>0&&(e[0].leadingComments=[{text:"Score Metadata",multiLine:!1}]),e}static _buildStyleSheetMetaData(t,e){const s=t.length;e.hideDynamics&&t.push(_.meta("hideDynamics")),e.bracketExtendMode!==Z._defaultScore.stylesheet.bracketExtendMode&&t.push(_.identMeta("bracketExtendMode",ue.bracketExtendModeReversed.get(e.bracketExtendMode))),e.useSystemSignSeparator&&t.push(_.meta("useSystemSignSeparator")),e.multiTrackMultiBarRest&&t.push(_.meta("multiBarRest")),e.singleTrackTrackNamePolicy!==Z._defaultScore.stylesheet.singleTrackTrackNamePolicy&&t.push(_.identMeta("singleTrackTrackNamePolicy",ue.trackNamePolicyReversed.get(e.singleTrackTrackNamePolicy))),e.multiTrackTrackNamePolicy!==Z._defaultScore.stylesheet.multiTrackTrackNamePolicy&&t.push(_.identMeta("multiTrackTrackNamePolicy",ue.trackNamePolicyReversed.get(e.multiTrackTrackNamePolicy))),e.firstSystemTrackNameMode!==Z._defaultScore.stylesheet.firstSystemTrackNameMode&&t.push(_.identMeta("firstSystemTrackNameMode",ue.trackNameModeReversed.get(e.firstSystemTrackNameMode))),e.otherSystemsTrackNameMode!==Z._defaultScore.stylesheet.otherSystemsTrackNameMode&&t.push(_.identMeta("otherSystemsTrackNameMode",ue.trackNameModeReversed.get(e.otherSystemsTrackNameMode))),e.firstSystemTrackNameOrientation!==Z._defaultScore.stylesheet.firstSystemTrackNameOrientation&&t.push(_.identMeta("firstSystemTrackNameOrientation",ue.trackNameOrientationReversed.get(e.firstSystemTrackNameOrientation))),e.otherSystemsTrackNameOrientation!==Z._defaultScore.stylesheet.otherSystemsTrackNameOrientation&&t.push(_.identMeta("otherSystemsTrackNameOrientation",ue.trackNameOrientationReversed.get(e.otherSystemsTrackNameOrientation))),e.extendBarLines&&t.push(_.meta("extendBarLines")),e.globalDisplayChordDiagramsInScore&&t.push(_.meta("chordDiagramsInScore")),e.hideEmptyStaves&&t.push(_.meta("hideEmptyStaves")),e.hideEmptyStavesInFirstSystem&&t.push(_.meta("hideEmptyStavesInFirstSystem")),e.showSingleStaffBrackets&&t.push(_.meta("showSingleStaffBrackets")),e.barNumberDisplay!==Vt.AllBars&&t.push(_.identMeta("defaultBarNumberDisplay",Vt[e.barNumberDisplay])),s<t.length&&(t[s].leadingComments=[{multiLine:!1,text:"Score Stylesheet"}])}static _buildScoreInfoMeta(t,e,s,i,r,a=!1){if(i!==void 0&&i.length===0&&!a)return;const l=[];if(i!==void 0&&l.push(_.string(i)),r!==void 0){const h=s.style&&s.style.headerAndFooter.has(r)?s.style.headerAndFooter.get(r):void 0,c=Ui.defaultHeaderAndFooter.has(r)?Ui.defaultHeaderAndFooter.get(r):void 0;h&&(!c||!Bs.equals(c,h))&&(l.push(_.string(h.isVisible===!1?"":h.template)),l.push(_.ident(ue.textAlignReversed.get(h.textAlign))))}i===void 0&&l.length===0||i!==void 0&&i.length===0&&l.length===1||t.push(_.meta(e,_.args(l)))}buildSyncPointNodes(t){const e=[],s=t.exportFlatSyncPoints();for(const i of s)e.push(_.meta("sync",_.args([_.number(i.barIndex),_.number(i.barOccurence),_.number(i.millisecondOffset),i.barPosition>0?_.number(i.barPosition):void 0])));return e}buildBarMetaDataNodes(t,e,s,i){var l,h,c;const r=[];if(Z._buildStructuralMetaDataNodes(e,t,r,i,s),!e)return r;s===0&&t.index===0&&t.track.index===0&&Z._buildMasterBarMetaDataNodes(r,e.masterBar);const a=r.length;s===0&&e.index===0&&t.index===0&&t.track.index===0&&r.push(_.identMeta("accidentals","auto")),(e.index===0||e.clef!==((l=e.previousBar)==null?void 0:l.clef))&&r.push(_.identMeta("clef",ue.clefReversed.get(e.clef))),(e.index===0&&e.clefOttava!==pe.Regular||e.clefOttava!==((h=e.previousBar)==null?void 0:h.clefOttava))&&r.push(_.identMeta("ottava",ue.ottaviaReversed.get(e.clefOttava))),(e.index===0&&e.simileMark!==At.None||e.simileMark!==((c=e.previousBar)==null?void 0:c.simileMark))&&r.push(_.identMeta("simile",ue.simileMarkReversed.get(e.simileMark))),e.displayScale!==1&&r.push(_.numberMeta("scale",e.displayScale)),e.displayWidth>0&&r.push(_.numberMeta("width",e.displayWidth));for(const d of e.sustainPedals){let u="";switch(d.pedalType){case lt.Down:u="spd";break;case lt.Hold:u="sph";break;case lt.Up:u="spu";break}u&&r.push(_.numberMeta(u,d.ratioPosition))}if(e.barLineLeft!==Be.Automatic&&r.push(_.identMeta("barLineLeft",ue.barLineStyleReversed.get(e.barLineLeft))),e.barLineRight!==Be.Automatic&&r.push(_.identMeta("barLineRight",ue.barLineStyleReversed.get(e.barLineRight))),e.index===0||e.keySignature!==e.previousBar.keySignature||e.keySignatureType!==e.previousBar.keySignatureType){let d="";e.keySignatureType===cs.Minor?d=ue.keySignaturesMinorReversed.get(e.keySignature):d=ue.keySignaturesMajorReversed.get(e.keySignature),r.push(_.identMeta("ks",d))}return a<r.length&&(r[a].leadingComments=[{multiLine:!1,text:`Bar ${e.index+1} Metadata`}]),e.barNumberDisplay!==void 0&&r.push(_.identMeta("barNumberDisplay",Vt[e.barNumberDisplay])),r}static _buildStaffMetaDataNodes(t,e){const s=t.length;if(e.capo!==0&&t.push(_.numberMeta("capo",e.capo)),e.isPercussion)t.push(_.identMeta("articulation","defaults"));else if(e.isStringed){const r=_.meta("tuning",_.args(e.stringTuning.tunings.map(a=>_.ident(Vs.getTextForTuning(a,!0)))));t.push(r),e.track.score.stylesheet.perTrackDisplayTuning&&e.track.score.stylesheet.perTrackDisplayTuning.has(e.track.index)&&(r.properties=_.props([["hide",void 0]])),e.stringTuning.name.length>0&&(r.properties??(r.properties=_.props([])),_.prop(r.properties.properties,"label",_.stringValue(e.stringTuning.name)))}e.transpositionPitch!==0&&t.push(_.numberMeta("transpose",-e.transpositionPitch));const i=A.displayTranspositionPitches.has(e.track.playbackInfo.program)?A.displayTranspositionPitches.get(e.track.playbackInfo.program):0;if(e.displayTranspositionPitch!==i&&t.push(_.numberMeta("displaytranspose",-e.displayTranspositionPitch)),e.chords!=null)for(const[r,a]of e.chords)t.push(Z._buildChordNode(a));s<t.length&&(t[s].leadingComments=[{multiLine:!1,text:`Staff ${e.index+1} Metadata`}])}static _buildChordNode(t){const e=_.meta("chord",_.args([_.string(t.name)],!0),_.props([t.firstFret>=0?["firstfret",_.numberValue(t.firstFret)]:void 0,["showdiagram",_.identValue(t.showDiagram?"true":"false")],["showfingering",_.identValue(t.showFingering?"true":"false")],["showname",_.identValue(t.showName?"true":"false")],t.barreFrets.length>0?["barre",_.args(t.barreFrets.map(s=>_.number(s)))]:void 0]));for(let s=0;s<t.staff.tuning.length;s++)s<t.strings.length&&t.strings[s]>=0?e.arguments.arguments.push(_.number(t.strings[s])):e.arguments.arguments.push(_.ident("x"));return e}static _buildMasterBarMetaDataNodes(t,e){var i,r;const s=t.length;if(e.alternateEndings!==0&&t.push(_.meta("ae",_.args(A.getAlternateEndingsList(e.alternateEndings).map(a=>_.number(a+1))))),e.isRepeatStart&&t.push(_.meta("ro")),e.isRepeatEnd&&t.push(_.numberMeta("rc",e.repeatCount)),(e.index===0||e.timeSignatureCommon!==((i=e.previousMasterBar)==null?void 0:i.timeSignatureCommon)||e.timeSignatureNumerator!==e.previousMasterBar.timeSignatureNumerator||e.timeSignatureDenominator!==e.previousMasterBar.timeSignatureDenominator)&&(e.timeSignatureCommon?t.push(_.identMeta("ts","common")):t.push(_.meta("ts",_.args([_.number(e.timeSignatureNumerator),_.number(e.timeSignatureDenominator)])))),e.beamingRules)for(const[a,l]of e.beamingRules.groups){const h=_.args([_.number(a)],!0);for(const c of l)h.arguments.push(_.number(c));t.push(_.meta("beaming",h))}if((e.index>0&&e.tripletFeel!==((r=e.previousMasterBar)==null?void 0:r.tripletFeel)||e.index===0&&e.tripletFeel!==Me.NoTripletFeel)&&t.push(_.identMeta("tf",ue.tripletFeelReversed.get(e.tripletFeel))),e.isFreeTime&&t.push(_.meta("ft")),e.section!=null&&t.push(_.meta("section",_.args([_.string(e.section.marker),_.string(e.section.text)]))),e.isAnacrusis&&t.push(_.meta("ac")),e.displayScale!==1&&t.push(_.numberMeta("scale",e.displayScale)),e.displayWidth>0&&t.push(_.numberMeta("width",e.displayWidth)),e.directions)for(const a of e.directions)t.push(_.identMeta("jump",ue.directionReversed.get(a)));for(const a of e.tempoAutomations){const l=_.meta("tempo",_.args([_.number(a.value),a.text?_.string(a.text):void 0,a.ratioPosition>0?_.number(a.ratioPosition):void 0,a.isVisible?void 0:_.ident("hide")]));l.arguments.arguments.length===1&&(l.arguments.openParenthesis=void 0,l.arguments.closeParenthesis=void 0),t.push(l)}s<t.length&&(t[s].leadingComments=[{multiLine:!1,text:`Masterbar ${e.index+1} Metadata`}])}static _buildStructuralMetaDataNodes(t,e,s,i,r){if((t===void 0||t.index===0)&&(r===0&&(e.index===0&&s.push(Z._buildNewTrackNode(e.track)),s.push(Z._buildNewStaffNode(e)),Z._buildStaffMetaDataNodes(s,e)),i)){const a=_.meta("voice");a.trailingComments=[{multiLine:!0,text:`Voice ${r+1}`}],s.push(a)}}static _buildNewStaffNode(t){const e=_.meta("staff",void 0,_.props([t.showStandardNotation?["score",_.args([t.standardNotationLineCount!==cr.DefaultStandardNotationLineCount?_.number(t.standardNotationLineCount):void 0])]:void 0,t.showTablature?["tabs",void 0]:void 0,t.showSlash?["slash",void 0]:void 0,t.showNumbered?["numbered",void 0]:void 0]));return e.properties&&e.properties.properties.length>0&&(e.properties.properties[0].leadingComments=[{multiLine:!1,text:"Staff Properties"}]),e}static _buildNewTrackNode(t){const e=_.meta("track",_.args([_.string(t.name),t.shortName.length>0?_.string(t.shortName):void 0]),_.props([t.color.rgba!==Z._defaultTrack.color.rgba?["color",_.stringValue(t.color.rgba)]:void 0,t.defaultSystemsLayout!==Z._defaultTrack.defaultSystemsLayout?["defaultSystemsLayout",_.numberValue(t.defaultSystemsLayout)]:void 0,t.systemsLayout.length?["systemsLayout",_.args(t.systemsLayout.map(s=>_.number(s)))]:void 0,["volume",_.numberValue(t.playbackInfo.volume)],["balance",_.numberValue(t.playbackInfo.balance)],t.playbackInfo.isMute?["mute",void 0]:void 0,t.playbackInfo.isSolo?["solo",void 0]:void 0,t.score.stylesheet.perTrackMultiBarRest&&t.score.stylesheet.perTrackMultiBarRest.has(t.index)?["multiBarRest",void 0]:void 0,["instrument",_.identValue(t.isPercussion?"percussion":ui.getName(t.playbackInfo.program))],t.playbackInfo.bank>0?["bank",_.numberValue(t.playbackInfo.bank)]:void 0]));return e.properties&&e.properties.properties.length>0&&(e.properties.properties[0].leadingComments=[{multiLine:!1,text:"Track Properties"}]),e}buildNoteEffects(t){const e=[];if(t.hasBend){const r=_.args([_.ident(ue.bendTypeReversed.get(t.bendType)),t.bendStyle!==tt.Default?_.ident(ue.bendStyleReversed.get(t.bendStyle)):void 0],!0);for(const a of t.bendPoints)r.arguments.push(_.number(a.offset)),r.arguments.push(_.number(a.value));_.prop(e,"be",r)}let s="";switch(t.harmonicType){case ie.Natural:_.prop(e,"nh");break;case ie.Artificial:s="ah";break;case ie.Pinch:s="ph";break;case ie.Tap:s="th";break;case ie.Semi:s="sh";break;case ie.Feedback:s="fh";break}switch(s&&_.prop(e,s,_.numberValue(t.harmonicValue)),t.showStringNumber&&_.prop(e,"string"),t.isTrill&&_.prop(e,"tr",_.args([_.number(t.trillFret),_.number(t.trillSpeed)])),t.vibrato){case Ee.Slight:_.prop(e,"v");break;case Ee.Wide:_.prop(e,"vw");break}switch(t.slideInType){case Et.IntoFromBelow:_.prop(e,"sib");break;case Et.IntoFromAbove:_.prop(e,"sia");break}switch(t.slideOutType){case ge.Shift:_.prop(e,"ss");break;case ge.Legato:_.prop(e,"sl");break;case ge.OutUp:_.prop(e,"sou");break;case ge.OutDown:_.prop(e,"sod");break;case ge.PickSlideDown:_.prop(e,"psd");break;case ge.PickSlideUp:_.prop(e,"psu");break}switch(t.isHammerPullOrigin&&_.prop(e,"h"),t.isLeftHandTapped&&_.prop(e,"lht"),t.isGhost&&_.prop(e,"g"),t.accentuated){case mt.Normal:_.prop(e,"ac");break;case mt.Heavy:_.prop(e,"hac");break;case mt.Tenuto:_.prop(e,"ten");break}if(t.isPalmMute&&_.prop(e,"pm"),t.isStaccato&&_.prop(e,"st"),t.isLetRing&&_.prop(e,"lr"),t.isDead&&_.prop(e,"x"),t.isTieDestination&&_.prop(e,"t"),t.leftHandFinger>=ae.Thumb&&_.prop(e,"lf",_.numberValue(t.leftHandFinger+1)),t.rightHandFinger>=ae.Thumb&&_.prop(e,"rf",_.numberValue(t.rightHandFinger+1)),t.isVisible||_.prop(e,"hide"),t.isSlurOrigin){const r=`s${t.id}`;_.prop(e,"slur",_.identValue(r))}if(t.isSlurDestination){const r=`s${t.slurOrigin.id}`;_.prop(e,"slur",_.identValue(r))}switch(t.accidentalMode===de.Default||t.beat.voice.bar.keySignature===Ke.C&&t.accidentalMode===de.ForceNatural||_.prop(e,"acc",_.identValue(A.reverseAccidentalModeMapping.get(t.accidentalMode))),t.ornament){case ut.InvertedTurn:_.prop(e,"iturn");break;case ut.Turn:_.prop(e,"turn");break;case ut.UpperMordent:_.prop(e,"umordent");break;case ut.LowerMordent:_.prop(e,"lmordent");break}return e}buildBeatEffects(t){var a;const e=[];switch(t.fade){case Nt.FadeIn:_.prop(e,"f");break;case Nt.FadeOut:_.prop(e,"fo");break;case Nt.VolumeSwell:_.prop(e,"vs");break}if(t.vibrato===Ee.Slight?_.prop(e,"v"):t.vibrato===Ee.Wide&&_.prop(e,"vw"),t.slap&&_.prop(e,"s"),t.pop&&_.prop(e,"p"),t.tap&&_.prop(e,"tt"),t.dots>=2?_.prop(e,"dd"):t.dots>0&&_.prop(e,"d"),t.pickStroke===Ot.Up?_.prop(e,"su"):t.pickStroke===Ot.Down&&_.prop(e,"sd"),t.hasTuplet&&_.prop(e,"tu",_.args([_.number(t.tupletNumerator),_.number(t.tupletDenominator)])),t.hasWhammyBar){const l=_.args([_.ident(ue.whammyTypeReversed.get(t.whammyBarType)),_.ident(ue.bendStyleReversed.get(t.whammyStyle))],!0);for(const h of t.whammyBarPoints)l.arguments.push(_.number(h.offset)),l.arguments.push(_.number(h.value));_.prop(e,"tbe",l)}let s="";switch(t.brushType){case Y.BrushUp:s="bu";break;case Y.BrushDown:s="bd";break;case Y.ArpeggioUp:s="au";break;case Y.ArpeggioDown:s="ad";break}if(s&&_.prop(e,s,_.numberValue(t.brushDuration)),t.chord!=null&&_.prop(e,"ch",_.stringValue(t.chord.name)),t.ottava!==pe.Regular&&_.prop(e,"ot",_.identValue(ue.ottaviaReversed.get(t.ottava))),t.hasRasgueado&&_.prop(e,"rasg",_.identValue(ue.rasgueadoReversed.get(t.rasgueado))),t.text!=null&&_.prop(e,"txt",_.stringValue(t.text)),t.lyrics!=null&&t.lyrics.length>0)if(t.lyrics.length>1)for(let l=0;l<t.lyrics.length;l++)_.prop(e,"lyrics",_.args([_.number(l),_.string(t.lyrics[l])]));else _.prop(e,"lyrics",_.stringValue(t.lyrics[0]));if(t.graceType!==ee.None&&_.prop(e,"gr",t.graceType===ee.BeforeBeat?void 0:_.identValue(ue.graceTypeReversed.get(t.graceType))),t.isTremolo){const l=[_.number(t.tremoloPicking.marks)];t.tremoloPicking.style!==zi.Default&&l.push(_.ident(zi[t.tremoloPicking.style])),_.prop(e,"tp",_.args(l))}switch(t.crescendo){case Jt.Crescendo:_.prop(e,"cre");break;case Jt.Decrescendo:_.prop(e,"dec");break}(t.voice.bar.index===0&&t.index===0||t.dynamics!==((a=t.previousBeat)==null?void 0:a.dynamics))&&_.prop(e,"dy",_.identValue(ue.dynamicValueReversed.get(t.dynamics))),t.fermata!=null&&_.prop(e,"fermata",_.args([_.ident(ue.fermataTypeReversed.get(t.fermata.type)),_.number(t.fermata.length)])),t.isLegatoOrigin&&_.prop(e,"legatoorigin");for(const l of t.automations)switch(l.type){case Ve.Tempo:_.prop(e,"tempo",_.args([_.number(l.value),l.text.length===0?void 0:_.string(l.text)]));break;case Ve.Volume:_.prop(e,"volume",_.numberValue(l.value));break;case Ve.Instrument:t.voice.bar.staff.isPercussion||_.prop(e,"instrument",_.identValue(ui.getName(l.value)));break;case Ve.Balance:_.prop(e,"balance",_.numberValue(l.value));break}switch(t.wahPedal){case ps.Open:_.prop(e,"waho");break;case ps.Closed:_.prop(e,"wahc");break}switch(t.isBarre&&_.prop(e,"barre",_.args([_.number(t.barreFret),_.ident(ue.barreShapeReversed.get(t.barreShape))])),t.slashed&&_.prop(e,"slashed"),t.deadSlapped&&_.prop(e,"ds"),t.golpe){case as.Thumb:_.prop(e,"glpt");break;case as.Finger:_.prop(e,"glpf");break}t.invertBeamDirection?_.prop(e,"beam",_.identValue("invert")):t.preferredBeamDirection!==null&&_.prop(e,"beam",_.identValue(E[t.preferredBeamDirection]));let r="";switch(t.beamingMode){case ot.ForceSplitToNext:r="split";break;case ot.ForceMergeWithNext:r="merge";break;case ot.ForceSplitOnSecondaryToNext:r="splitsecondary";break}return r&&_.prop(e,"beam",_.identValue(r)),t.showTimer&&_.prop(e,"timer"),e}};o(Z,"instance",new Z),o(Z,"_timeSignatureDenominators",new Set([1,2,4,8,16,32,64,128])),o(Z,"_defaultScore",new gi),o(Z,"_defaultTrack",new Ei);let mn=Z;class Fr{constructor(){o(this,"data");o(this,"settings")}init(t,e){this.data=t,this.settings=e,gi.resetIds()}}class Mt extends Xe{constructor(t=null,e){super(ze.Format,t??"Unsupported format",e)}}class wt{constructor(){o(this,"_buffer");o(this,"length",0);o(this,"position",0)}get bytesWritten(){return this.position}getBuffer(){return this._buffer}static empty(){return wt.withCapacity(0)}static withCapacity(t){const e=new wt;return e._buffer=new Uint8Array(t),e}static fromBuffer(t){const e=new wt;return e._buffer=t,e.length=t.length,e}static fromString(t){const e=w.stringToBytes(t);return wt.fromBuffer(e)}reset(){this.position=0}skip(t){this.position+=t}readByte(){return this.length-this.position<=0?-1:this._buffer[this.position++]}read(t,e,s){let i=this.length-this.position;return i>s&&(i=s),i<=0?0:(t.set(this._buffer.subarray(this.position,this.position+i),e),this.position+=i,i)}writeByte(t){const e=this.position+1;this._ensureCapacity(e),this._buffer[this.position]=t&255,e>this.length&&(this.length=e),this.position=e}write(t,e,s){const i=this.position+s;this._ensureCapacity(i);const r=Math.min(s,t.length-e);this._buffer.set(t.subarray(e,e+r),this.position),i>this.length&&(this.length=i),this.position=i}_ensureCapacity(t){if(t>this._buffer.length){let e=t;e<256&&(e=256),e<this._buffer.length*2&&(e=this._buffer.length*2);const s=new Uint8Array(e);this.length>0&&s.set(this._buffer.subarray(0,0+this.length),0),this._buffer=s}}readAll(){return this.toArray()}toArray(){const t=new Uint8Array(this.length);return t.set(this._buffer.subarray(0,0+this.length),0),t}copyTo(t){t.write(this._buffer,0,this.length)}}class ir extends Xe{constructor(e,s,i,r){super(ze.AlphaTex,e);o(this,"lexerDiagnostics");o(this,"parserDiagnostics");o(this,"semanticDiagnostics");this.lexerDiagnostics=s,this.parserDiagnostics=i,this.semanticDiagnostics=r}*iterateDiagnostics(){if(this.lexerDiagnostics)for(const e of this.lexerDiagnostics.items)yield e;if(this.parserDiagnostics)for(const e of this.parserDiagnostics.items)yield e;if(this.semanticDiagnostics)for(const e of this.semanticDiagnostics.items)yield e}toString(){return[this.message,"lexer diagnostics:",ir._diagnosticsToString(this.lexerDiagnostics,"  "),"parser diagnostics:",ir._diagnosticsToString(this.parserDiagnostics,"  "),"semantic diagnostics:",ir._diagnosticsToString(this.semanticDiagnostics,"  ")].join(`
`)}static _diagnosticsToString(e,s){return e?e.items.map(i=>`${s}${me[i.severity]} AT${i.code.toString().padStart(3,"0")}${ir._locationToString(i)}: ${i.message}`).join(`
`):`${s}none`}static _locationToString(e){let s="";return e.start&&(s+=`(${e.start.line},${e.start.col})`),e.end&&(s.length>0&&(s+="->"),s+=`(${e.end.line},${e.end.col})`),s}}class Dh{constructor(){o(this,"trackChannel",0);o(this,"score");o(this,"currentTrack");o(this,"currentStaff");o(this,"barIndex",0);o(this,"voiceIndex",0);o(this,"ignoredInitialVoice",!1);o(this,"ignoredInitialStaff",!1);o(this,"ignoredInitialTrack",!1);o(this,"currentDuration",b.Quarter);o(this,"articulationUniqueIdToIndex",new Map);o(this,"hasAnyProperData",!1);o(this,"percussionArticulationNames",new Map);o(this,"slurs",new Map);o(this,"lyrics",new Map);o(this,"sustainPedalToBeat",new Map);o(this,"staffTuningApplied",new Set);o(this,"staffNoteKind",new Map);o(this,"staffHasExplicitTuning",new Set);o(this,"staffHasExplicitDisplayTransposition",new Set);o(this,"staffDisplayTranspositionApplied",new Set);o(this,"staffInitialClef",new Map);o(this,"syncPoints",[]);o(this,"currentDynamics",re.F);o(this,"accidentalMode",Ga.Explicit);o(this,"voiceMode",wi.StaffWise);o(this,"currentTupletNumerator",-1);o(this,"currentTupletDenominator",-1);o(this,"scoreNode")}}class bo extends Fr{constructor(){super(...arguments);o(this,"_parser");o(this,"_handler",mn.instance);o(this,"_state",new Dh);o(this,"logErrors",!1);o(this,"semanticDiagnostics",new yo)}get state(){return this._state}get scoreNode(){return this._state.scoreNode}get name(){return"AlphaTex"}get lexerDiagnostics(){return this._parser.lexerDiagnostics}get parserDiagnostics(){return this._parser.parserDiagnostics}get parser(){return this._parser}get parseMode(){return this._parser.mode}addSemanticDiagnostic(e){this.semanticDiagnostics.push(e)}initFromString(e,s){this.data=wt.empty(),this._parser=new Ua(e),this.settings=s,gi.resetIds()}readScore(){this._state=new Dh,this._createDefaultScore(),this.data.length>0&&(this._parser=new Ua(w.toString(this.data.readAll(),this.settings.importer.encoding)));let e;try{e=this._parser.read(),this._state.scoreNode=e}catch(s){throw this.logErrors&&L.error("AlphaTex",`Error while parsing alphaTex: ${s.toString()}`),new Mt("Error parsing alphaTex, check inner error for details",s)}if(this._parser.parserDiagnostics.hasErrors||this._parser.lexer.lexerDiagnostics.hasErrors){const s=new ir("There are errors in the parsed alphaTex, check the diagnostics for details",this.lexerDiagnostics,this.parserDiagnostics,this.semanticDiagnostics);throw this.logErrors&&L.error("AlphaTex",`Error while parsing alphaTex: ${s.toString()}`),new Mt("Error parsing alphaTex, check diagnostics on inner error for details",s)}if(this._bars(e),this.semanticDiagnostics.hasErrors)if(this._state.hasAnyProperData){const s=new ir("There are errors in the parsed alphaTex, check the diagnostics for details",this.lexerDiagnostics,this.parserDiagnostics,this.semanticDiagnostics);throw this.logErrors&&L.error("AlphaTex",`Error while parsing alphaTex: ${s.toString()}`),s}else throw new Mt("No alphaTex data found");A.consolidate(this._state.score),this._state.score.finish(this.settings),A.trimEmptyBarsAtEnd(this._state.score),this._state.score.rebuildRepeatGroups(),this._state.score.applyFlatSyncPoints(this._state.syncPoints);for(const[s,i]of this._state.lyrics)this._state.score.tracks[s].applyLyrics(i);for(const[s,i]of this._state.sustainPedalToBeat)if(s.ratioPosition<1){const r=i.voice.bar.masterBar.calculateDuration();s.ratioPosition=i.playbackStart/r}return this._state.score}_createDefaultScore(){this._state.score=new gi,this._newTrack()}_newTrack(){this._state.currentTrack=new Ei,this._state.currentTrack.ensureStaveCount(1),this._state.currentTrack.playbackInfo.program=25,this._state.currentTrack.playbackInfo.primaryChannel=this._state.trackChannel++,this._state.currentTrack.playbackInfo.secondaryChannel=this._state.trackChannel++;const e=this._state.currentTrack.staves[0];e.displayTranspositionPitch=0,e.stringTuning=Vs.getDefaultTuningFor(6),this._state.articulationUniqueIdToIndex.clear(),this._beginStaff(e),this._state.score.addTrack(this._state.currentTrack),this._state.lyrics.set(this._state.currentTrack.index,[]),this._state.currentDynamics=re.F,this._state.currentTupletDenominator=-1,this._state.currentTupletNumerator=-1}_beginStaff(e){this._state.currentStaff&&(this._detectTuningForStaff(this._state.currentStaff),this._handleTransposition(this._state.currentStaff)),this._state.currentStaff=e,this._state.slurs.clear(),this._state.barIndex=0,this._state.voiceIndex=0}_bars(e){if(e.bars.length>0){let s=!1;for(const i of e.bars)switch(this._bar(i,s),this.state.voiceMode){case wi.StaffWise:this._state.barIndex++,s=!0;break;case wi.BarWise:i.pipe&&(this._state.barIndex++,this._state.voiceIndex=0,this._state.ignoredInitialVoice=!1,s=!0);break}}else this._getBar(this._state.currentStaff),this._detectTuningForStaff(this._state.currentStaff),this._handleTransposition(this._state.currentStaff)}_bar(e,s){const i=this._barMeta(e,s);this._detectTuningForStaff(this._state.currentStaff),this._handleTransposition(this._state.currentStaff),i.index===0&&this._state.staffInitialClef.has(this._state.currentStaff)&&(i.clef=this._state.staffInitialClef.get(this._state.currentStaff));const r=i.voices[this._state.voiceIndex];for(const a of e.beats)this._beat(r,a);if(r.beats.length===0){const a=new qt;a.isEmpty=!0,r.addBeat(a)}}_beat(e,s){if(s.durationChange&&this._beatDuration(s.durationChange),!s.notes&&!s.rest)return;const i=new qt;if(e.addBeat(i),s.notes)for(const a of s.notes.notes)this._note(i,a);else s.rest;s.durationValue&&(this._state.currentDuration=this._parseDuration(s.durationValue)),i.duration=this._state.currentDuration,i.dynamics=this._state.currentDynamics,this._state.currentTupletNumerator!==-1&&!i.hasTuplet&&(i.tupletNumerator=this._state.currentTupletNumerator,i.tupletDenominator=this._state.currentTupletDenominator);let r=1;s.beatMultiplierValue!==void 0&&(r=s.beatMultiplierValue.value),s.beatEffects&&this._beatEffects(i,s.beatEffects);for(let a=0;a<r-1;a++)e.addBeat(Rl.clone(i))}_beatEffects(e,s){for(const i of s.properties)switch(this._handler.applyBeatProperty(this,e,i)){case B.Applied:case B.NotAppliedSemanticError:this._state.hasAnyProperData=!0;break;case B.NotAppliedUnrecognizedMarker:const a=Array.from(this._handler.knownBeatProperties).join(",");this.addSemanticDiagnostic({code:_e.AT212,message:`Unrecogized property '${i.property.text}', expected one of ${a}`,severity:me.Error,start:i.start,end:i.end});break}}_beatDuration(e){if(e.value&&(this._state.currentDuration=this._parseDuration(e.value)),this._state.currentTupletNumerator=-1,this._state.currentTupletDenominator=-1,e.properties)for(const s of e.properties.properties)switch(this._handler.applyBeatDurationProperty(this,s)){case B.Applied:case B.NotAppliedSemanticError:this._state.hasAnyProperData=!0;break;case B.NotAppliedUnrecognizedMarker:const r=Array.from(this._handler.knownBeatDurationProperties).join(",");this.addSemanticDiagnostic({code:_e.AT212,message:`Unrecogized property '${s.property.text}', expected one of ${r}`,severity:me.Error,start:s.start,end:s.end});break}}_parseDuration(e){switch(e.value){case-4:return b.QuadrupleWhole;case-2:return b.DoubleWhole;case 1:return b.Whole;case 2:return b.Half;case 4:return b.Quarter;case 8:return b.Eighth;case 16:return b.Sixteenth;case 32:return b.ThirtySecond;case 64:return b.SixtyFourth;case 128:return b.OneHundredTwentyEighth;case 256:return b.TwoHundredFiftySixth;default:return this.addSemanticDiagnostic({code:_e.AT209,message:`Unexpected duration value '${e.value}', expected: -4, -2, 1, 2, 4, 8, 16, 32, 64, 128 or 256`,severity:me.Error,start:e.start,end:e.end}),this._state.currentDuration}}_note(e,s){let i=!1,r=!1,a=-1,l="",h=-1,c=-1,d=de.Default;const u=s.noteValue;let p,g=this._state.staffNoteKind.has(this._state.currentStaff)?this._state.staffNoteKind.get(this._state.currentStaff):void 0;switch(u.nodeType){case C.Number:a=u.value,s.noteString!==void 0?p=os.Fretted:p=os.Articulation;break;case C.String:case C.Ident:const y=u.text;if(i=y==="x",r=y==="-",r||i)a=0,s.noteStringDot&&s.noteString?p=os.Fretted:p=void 0;else{const S=A.parseTuning(y);if(S)p=os.Pitched,h=S.octave,c=S.tone.noteValue,this._state.accidentalMode===Ga.Explicit&&(d=S.tone.accidentalMode);else{p=os.Articulation;const k=y.toLowerCase(),T=this._state.percussionArticulationNames;if(g===void 0&&T.size===0)for(const[N,F]of jt.instrumentArticulationNames)jt.getInstrumentArticulationByUniqueId(F)&&(T.set(N.toLowerCase(),F),T.set(A.toArticulationId(N),F));if(T.has(k))l=T.get(k);else{this.addSemanticDiagnostic({code:_e.AT209,message:`Unexpected percussion articulation value '${k}', expected: oneOf(${Array.from(this._state.percussionArticulationNames.keys()).join(",")}).`,severity:me.Error,start:u.start,end:u.end}),l=Array.from(jt.instrumentArticulationNames.values())[0];return}}}break}p!==void 0?g===void 0?(g=p,this.applyStaffNoteKind(this._state.currentStaff,g)):g!==p&&this.addSemanticDiagnostic({code:_e.AT218,message:`Wrong note kind '${os[p]}' for staff with note kind ''${os[g]}'. Do not mix incompatible staves and notes.`,severity:me.Error,start:u.start,end:u.end}):g!==void 0&&(p=g);const m=new Ps;if(m.isDead=i,(i||r)&&(m.fret=a),m.isTieDestination=r,p!==void 0&&p===g)switch(p){case os.Pitched:m.octave=h,m.tone=c,m.accidentalMode=d;break;case os.Fretted:if(!s.noteString){this.addSemanticDiagnostic({code:_e.AT207,message:"Missing string for fretted note.",severity:me.Error,start:u.end,end:u.end});return}const y=s.noteString.value;if(y<1||y>this._state.currentStaff.tuning.length){this.addSemanticDiagnostic({code:_e.AT208,message:`Note string is out of range. Available range: 1-${this._state.currentStaff.tuning.length}`,severity:me.Error,start:u.end,end:u.end});return}m.string=this._state.currentStaff.tuning.length-(y-1),r||(m.fret=a);break;case os.Articulation:let S=0;if(l.length===0&&a>0){const k=jt.getArticulationById(a);k&&(l=k.uniqueId)}if(this._state.articulationUniqueIdToIndex.has(l))S=this._state.articulationUniqueIdToIndex.get(l);else{S=this._state.currentTrack.percussionArticulations.length;const k=jt.getInstrumentArticulationByUniqueId(l);if(k===null){this.addSemanticDiagnostic({code:_e.AT209,message:`Unexpected articulation value '${a}', expected: oneOf(${Array.from(jt.instrumentArticulations.keys()).join(",")}).`,severity:me.Error,start:u.end,end:u.end});return}this._state.currentTrack.percussionArticulations.push(k),this._state.articulationUniqueIdToIndex.set(l,S)}m.percussionArticulation=S;break}e.addNote(m),this._state.hasAnyProperData=!0,s.noteEffects&&this._noteEffects(m,s.noteEffects)}getStaffNoteKind(e){return this._state.staffNoteKind.has(e)?this._state.staffNoteKind.get(e):void 0}applyStaffNoteKind(e,s){switch(this._state.staffNoteKind.set(e,s),s){case os.Pitched:e.isPercussion=!1,e.stringTuning.reset(),this._state.staffHasExplicitDisplayTransposition.has(e)||(e.displayTranspositionPitch=0);break;case os.Fretted:e.isPercussion=!1,this._detectTuningForStaff(e),this._handleTransposition(e);break;case os.Articulation:e.isPercussion=!0,e.stringTuning.reset(),this._state.staffHasExplicitDisplayTransposition.has(e)||(e.displayTranspositionPitch=0);break}}_noteEffects(e,s){for(const i of s.properties){let r=this._handler.applyNoteProperty(this,e,i);switch(r===B.NotAppliedUnrecognizedMarker&&(r=this._handler.applyBeatProperty(this,e.beat,i)),r){case B.Applied:case B.NotAppliedSemanticError:break;case B.NotAppliedUnrecognizedMarker:const a=Array.from(this._handler.knownNoteProperties).concat(Array.from(this._handler.knownBeatProperties)).join(",");this.addSemanticDiagnostic({code:_e.AT212,message:`Unrecogized property '${i.property.text}', expected one of ${a}`,severity:me.Error,start:i.start,end:i.end});break}}}_handleTransposition(e){if(!this._state.staffDisplayTranspositionApplied.has(e)&&!this._state.staffHasExplicitDisplayTransposition.has(e)){const s=e.track.playbackInfo.program;A.displayTranspositionPitches.has(s)?e.displayTranspositionPitch=A.displayTranspositionPitches.get(s):this._state.currentStaff.displayTranspositionPitch=0,this._state.staffDisplayTranspositionApplied.add(e)}}_detectTuningForStaff(e){const s=e.track.playbackInfo.program;!this._state.staffTuningApplied.has(e)&&!this._state.staffHasExplicitTuning.has(e)&&(e.stringTuning.reset(),s===15||s>=24&&s<=31?e.stringTuning.tunings=Vs.getDefaultTuningFor(6).tunings:s>=32&&s<=39?(e.stringTuning.tunings=[43,38,33,28],this._state.staffInitialClef.set(e,Fe.F4)):s===40||s===44||s===45||s===48||s===49||s===50||s===51?e.stringTuning.tunings=[52,57,50,43]:s===41?e.stringTuning.tunings=[57,50,43,36]:s===42?e.stringTuning.tunings=[45,38,31,24]:s===43?e.stringTuning.tunings=[43,38,33,28]:s===105?e.stringTuning.tunings=[50,47,43,38,55]:s===106?e.stringTuning.tunings=[57,52,45]:s===107?e.stringTuning.tunings=[52,45,38,31]:s===110?e.stringTuning.tunings=[64,57,50,43]:this._state.staffNoteKind.has(e)&&this._state.staffNoteKind.get(e)===os.Fretted&&(e.stringTuning=Vs.getDefaultTuningFor(6)),this._state.staffTuningApplied.add(e))}_barMeta(e,s){let i=this._state.score.masterBars.length>0?void 0:[],r=this._state.currentStaff,a=!1,l=!1,h=!1,c=!1;const d=()=>{i&&(i=void 0,r=this._state.currentStaff,a=!1,l=!1,h=!1,c=!1)},u=new Kr(()=>{!h&&!s&&this._state.barIndex++;const p=this._getBar(this._state.currentStaff);if(i){for(const g of i)this._handler.applyBarMetaData(this,p,g);d()}return p});for(const p of e.metaData){const g=p.tag.tag.text.toLowerCase();if(this._handler.knownStructuralMetaDataTags.has(g)){switch(this._state.hasAnyProperData=!0,this._handler.applyStructuralMetaData(this,p)){case li.AppliedNewTrack:l||a?c=!0:(a=!0,r=this._state.currentStaff),u.reset();break;case li.AppliedNewStaff:l?c=!0:(l=!0,r=this._state.currentStaff),u.reset();break;case li.AppliedNewVoice:h=!0;break}if(i&&c)if(r.bars.length===0){const y=new qs;r.addBar(y);const S=new Fs;if(y.addVoice(S),r.bars.length>this._state.score.masterBars.length){const k=new ii;this._state.score.addMasterBar(k)}for(const k of i)this._handler.applyBarMetaData(this,y,k);d()}else throw new Xe(ze.AlphaTex,"Unexpected internal error, didn't expect a filled staff after multiple \\track and/or \\staff tags. Please report this problem providing the input alphaTex.")}else if(this._handler.knownScoreMetaDataTags.has(p.tag.tag.text.toLowerCase()))this._state.hasAnyProperData=!0,this._handler.applyScoreMetaData(this,this._state.score,p);else if(this._handler.knownStaffMetaDataTags.has(p.tag.tag.text.toLowerCase()))this._state.hasAnyProperData=!0,this._handler.applyStaffMetaData(this,this._state.currentStaff,p);else if(this._handler.knownBarMetaDataTags.has(p.tag.tag.text.toLowerCase()))this._state.hasAnyProperData=!0,i?i.push(p):this._handler.applyBarMetaData(this,u.value,p);else{const m=Array.from(this._handler.allKnownMetaDataTags).join(",");this.addSemanticDiagnostic({code:_e.AT204,message:`Unrecognized metadata '${p.tag.tag.text}', expected one of: ${m}`,severity:me.Error,start:p.tag.start,end:p.tag.end})}}return u.value}_getBar(e){if(this._state.barIndex<e.bars.length)return e.bars[this._state.barIndex];const s=e.bars.length===0?this._state.voiceIndex+1:e.bars[0].voices.length,i=new qs;e.addBar(i),i.previousBar&&(i.clef=i.previousBar.clef,i.clefOttava=i.previousBar.clefOttava,i.keySignature=i.previousBar.keySignature,i.keySignatureType=i.previousBar.keySignatureType),this._state.barIndex=i.index,i.index>0&&(i.clef=i.previousBar.clef);for(let r=0;r<s;r++){const a=new Fs;i.addVoice(a)}if(this._state.currentStaff.bars.length>this._state.score.masterBars.length){const r=new ii;this._state.score.addMasterBar(r),r.index>0&&(r.timeSignatureDenominator=r.previousMasterBar.timeSignatureDenominator,r.timeSignatureNumerator=r.previousMasterBar.timeSignatureNumerator,r.tripletFeel=r.previousMasterBar.tripletFeel)}return i}startNewStaff(){if(this._state.ignoredInitialVoice=!1,this._state.ignoredInitialStaff||this._state.currentTrack.staves[0].bars.length>0){const e=this._state.currentStaff.isPercussion;this._state.currentTrack.ensureStaveCount(this._state.currentTrack.staves.length+1);const s=this._state.currentTrack.staves[this._state.currentTrack.staves.length-1];this._beginStaff(s),e&&this.applyPercussionStaff(this._state.currentStaff),this._state.currentDynamics=re.F}else this._state.ignoredInitialStaff=!0;return this._state.currentStaff}applyPercussionStaff(e){e.isPercussion=!0,e.showTablature=!1,e.track.playbackInfo.program=0}startNewTrack(){return this._state.ignoredInitialVoice=!1,this._state.ignoredInitialStaff=!1,this._state.ignoredInitialTrack||this._state.score.masterBars.length>0?this._newTrack():this._state.ignoredInitialTrack=!0,this._state.currentTrack}startNewVoice(){let e=this._state.voiceIndex===0&&!this._state.ignoredInitialVoice;if(e)if(this._state.currentStaff.bars.length===0)e=!0;else switch(this._state.voiceMode){case wi.StaffWise:e=this._state.currentStaff.bars.length===1&&this._state.currentStaff.bars[0].isEmpty;break;case wi.BarWise:this._state.barIndex<this._state.currentStaff.bars.length?e=this._state.currentStaff.bars[this._state.barIndex].voices[0].isEmpty:e=!0;break}if(e){this._state.ignoredInitialVoice=!0;return}switch(this._state.voiceMode){case wi.StaffWise:this._state.voiceIndex++,this._state.barIndex=0,this._state.currentTupletDenominator=-1,this._state.currentTupletNumerator=-1;break;case wi.BarWise:this._state.voiceIndex++,this._state.currentTupletDenominator=-1,this._state.currentTupletNumerator=-1;break}for(const s of this._state.currentStaff.bars)for(;s.voices.length<=this._state.voiceIndex;)s.addVoice(new Fs)}}let Wl=class{};class dn extends Wl{constructor(e){super();o(this,"n");this.n=e}}class fr extends Wl{constructor(e,s){super();o(this,"left");o(this,"right");this.left=e,this.right=s}}class Go extends Wl{constructor(e,s){super();o(this,"n");o(this,"table");this.n=e,this.table=s}}class rs{static make(t,e,s,i){const r=[],a=[];if(i>32)throw new Kt("Invalid huffman");for(let c=0;c<i;c++)r.push(0),a.push(0);for(let c=0;c<s;c++){const d=t[c+e];if(d>=i)throw new Kt("Invalid huffman");r[d]++}let l=0;for(let c=1;c<i-1;c++)l=l+r[c]<<1,a[c]=l;const h=new Map;for(let c=0;c<s;c++){const d=t[c+e];if(d!==0){const u=a[d-1];a[d-1]=u+1,h.set(u<<5|d,c)}}return rs._treeCompress(new fr(rs._treeMake(h,i,0,1),rs._treeMake(h,i,1,1)))}static _treeMake(t,e,s,i){if(i>e)throw new Kt("Invalid huffman");const r=s<<5|i;return t.has(r)?new dn(t.get(r)):(s=s<<1,i+=1,new fr(rs._treeMake(t,e,s,i),rs._treeMake(t,e,s|1,i)))}static _treeCompress(t){const e=rs._treeDepth(t);if(e===0)return t;if(e===1){if(t instanceof fr)return new fr(rs._treeCompress(t.left),rs._treeCompress(t.right));throw new Kt("assert")}const s=1<<e,i=[];for(let r=0;r<s;r++)i.push(new dn(-1));return rs._treeWalk(i,0,0,e,t),new Go(e,i)}static _treeWalk(t,e,s,i,r){r instanceof fr&&i>0?(rs._treeWalk(t,e,s+1,i-1,r.left),rs._treeWalk(t,e|1<<s,s+1,i-1,r.right)):t[e]=rs._treeCompress(r)}static _treeDepth(t){if(t instanceof dn)return 0;if(t instanceof Go)throw new Kt("assert");if(t instanceof fr){const e=rs._treeDepth(t.left),s=rs._treeDepth(t.right);return 1+(e<s?e:s)}return 0}}var Wt;(function(n){n[n.Head=0]="Head",n[n.Block=1]="Block",n[n.CData=2]="CData",n[n.Flat=3]="Flat",n[n.Crc=4]="Crc",n[n.Dist=5]="Dist",n[n.DistOne=6]="DistOne",n[n.Done=7]="Done"})(Wt||(Wt={}));const ai=class ai{constructor(){o(this,"buffer",new Uint8Array(ai._bufferSize));o(this,"pos",0)}slide(){const t=new Uint8Array(ai._bufferSize);this.pos-=ai._size,t.set(this.buffer.subarray(ai._size,ai._size+this.pos),0),this.buffer=t}addBytes(t,e,s){this.pos+s>ai._bufferSize&&this.slide(),this.buffer.set(t.subarray(e,e+s),this.pos),this.pos+=s}addByte(t){this.pos===ai._bufferSize&&this.slide(),this.buffer[this.pos]=t,this.pos++}getLastChar(){return this.buffer[this.pos-1]}available(){return this.pos}};o(ai,"_size",32768),o(ai,"_bufferSize",65536);let Uo=ai;const ms=class ms{constructor(t){o(this,"_nbits",0);o(this,"_bits",0);o(this,"_state",Wt.Block);o(this,"_isFinal",!1);o(this,"_huffman",ms._fixedHuffman);o(this,"_huffdist",null);o(this,"_len",0);o(this,"_dist",0);o(this,"_needed",0);o(this,"_output",null);o(this,"_outpos",0);o(this,"_input");o(this,"_lengths",[]);o(this,"_window",new Uo);this._input=t;for(let e=0;e<19;e++)this._lengths.push(-1)}static _buildFixedHuffman(){const t=[];for(let e=0;e<288;e++)t.push(e<=143?8:e<=255?9:e<=279?7:8);return rs.make(t,0,288,10)}readBytes(t,e,s){if(this._needed=s,this._outpos=e,this._output=t,s>0)for(;this._inflateLoop(););return s-this._needed}_inflateLoop(){switch(this._state){case Wt.Head:const t=this._input.readByte();if((t&15)!==8)throw new Kt("Invalid data");const s=this._input.readByte(),i=(s&32)!==0;if(((t<<8)+s)%31!==0)throw new Kt("Invalid data");if(i)throw new Kt("Unsupported dictionary");return this._state=Wt.Block,!0;case Wt.Crc:return this._state=Wt.Done,!0;case Wt.Done:return!1;case Wt.Block:switch(this._isFinal=this._getBit(),this._getBits(2)){case 0:if(this._len=w.readUInt16LE(this._input),w.readUInt16LE(this._input)!==65535-this._len)throw new Kt("Invalid data");this._state=Wt.Flat;const d=this._inflateLoop();return this._resetBits(),d;case 1:return this._huffman=ms._fixedHuffman,this._huffdist=null,this._state=Wt.CData,!0;case 2:const u=this._getBits(5)+257,p=this._getBits(5)+1,g=this._getBits(4)+4;for(let y=0;y<g;y++)this._lengths[ms._codeLengthsPos[y]]=this._getBits(3);for(let y=g;y<19;y++)this._lengths[ms._codeLengthsPos[y]]=0;this._huffman=rs.make(this._lengths,0,19,8);const m=[];for(let y=0;y<u+p;y++)m.push(0);return this._inflateLengths(m,u+p),this._huffdist=rs.make(m,u,p,16),this._huffman=rs.make(m,0,u,16),this._state=Wt.CData,!0;default:throw new Kt("Invalid data")}case Wt.Flat:{const c=this._len<this._needed?this._len:this._needed,d=w.readByteArray(this._input,c);return this._len-=c,this._addBytes(d,0,c),this._len===0&&(this._state=this._isFinal?Wt.Crc:Wt.Block),this._needed>0}case Wt.DistOne:{const c=this._len<this._needed?this._len:this._needed;return this._addDistOne(c),this._len-=c,this._len===0&&(this._state=Wt.CData),this._needed>0}case Wt.Dist:for(;this._len>0&&this._needed>0;){const c=this._len<this._dist?this._len:this._dist,d=this._needed<c?this._needed:c;this._addDist(this._dist,d),this._len-=d}return this._len===0&&(this._state=Wt.CData),this._needed>0;case Wt.CData:let r=this._applyHuffman(this._huffman);if(r<256)return this._addByte(r),this._needed>0;if(r===256)return this._state=this._isFinal?Wt.Crc:Wt.Block,!0;r=r-257&255;let a=ms._lenExtraBitsTbl[r];if(a===-1)throw new Kt("Invalid data");this._len=ms._lenBaseValTbl[r]+this._getBits(a);const l=this._huffdist,h=l?this._applyHuffman(l):this._getRevBits(5);if(a=ms._distExtraBitsTbl[h],a===-1)throw new Kt("Invalid data");if(this._dist=ms._distBaseValTbl[h]+this._getBits(a),this._dist>this._window.available())throw new Kt("Invalid data");return this._state=this._dist===1?Wt.DistOne:Wt.Dist,!0}return!1}_addDistOne(t){const e=this._window.getLastChar();for(let s=0;s<t;s++)this._addByte(e)}_addByte(t){this._window.addByte(t),this._output[this._outpos]=t,this._needed--,this._outpos++}_addDist(t,e){this._addBytes(this._window.buffer,this._window.pos-t,e)}_getBit(){this._nbits===0&&(this._nbits=8,this._bits=this._input.readByte());const t=(this._bits&1)===1;return this._nbits--,this._bits=this._bits>>1,t}_getBits(t){for(;this._nbits<t;)this._bits=this._bits|this._input.readByte()<<this._nbits,this._nbits+=8;const e=this._bits&(1<<t)-1;return this._nbits-=t,this._bits=this._bits>>t,e}_getRevBits(t){return t===0?0:this._getBit()?1<<t-1|this._getRevBits(t-1):this._getRevBits(t-1)}_resetBits(){this._bits=0,this._nbits=0}_addBytes(t,e,s){this._window.addBytes(t,e,s),this._output.set(t.subarray(e,e+s),this._outpos),this._needed-=s,this._outpos+=s}_inflateLengths(t,e){let s=0,i=0;for(;s<e;){const r=this._applyHuffman(this._huffman);switch(r){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:case 8:case 9:case 10:case 11:case 12:case 13:case 14:case 15:i=r,t[s]=r,s++;break;case 16:const a=s+3+this._getBits(2);if(a>e)throw new Kt("Invalid data");for(;s<a;)t[s]=i,s++;break;case 17:if(s+=3+this._getBits(3),s>e)throw new Kt("Invalid data");break;case 18:if(s+=11+this._getBits(7),s>e)throw new Kt("Invalid data");break;default:throw new Kt("Invalid data")}}}_applyHuffman(t){if(t instanceof dn)return t.n;if(t instanceof fr)return this._applyHuffman(this._getBit()?t.right:t.left);if(t instanceof Go)return this._applyHuffman(t.table[this._getBits(t.n)]);throw new Kt("Invalid data")}};o(ms,"_lenExtraBitsTbl",[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,-1,-1]),o(ms,"_lenBaseValTbl",[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258]),o(ms,"_distExtraBitsTbl",[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,-1,-1]),o(ms,"_distBaseValTbl",[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577]),o(ms,"_codeLengthsPos",[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),o(ms,"_fixedHuffman",ms._buildFixedHuffman());let zo=ms;class Zt{constructor(t,e){o(this,"fullName");o(this,"fileName");o(this,"data");this.fullName=t;const s=t.lastIndexOf("/");this.fileName=s===-1||s===t.length-1?this.fullName:t.substr(s+1),this.data=e}}o(Zt,"OptionalDataDescriptorSignature",134695760),o(Zt,"CompressionMethodDeflate",8),o(Zt,"LocalFileHeaderSignature",67324752),o(Zt,"CentralFileHeaderSignature",33639248),o(Zt,"EndOfCentralDirSignature",101010256);class Vl{constructor(t){o(this,"_readable");this._readable=t}read(){const t=[];for(;;){const e=this._readEntry();if(!e)break;t.push(e)}return t}_readEntry(){const t=this._readable;if(w.readInt32LE(t)!==Zt.LocalFileHeaderSignature)return null;w.readUInt16LE(t);const s=w.readUInt16LE(t),i=w.readUInt16LE(t),r=i!==0;if(r&&i!==Zt.CompressionMethodDeflate)return null;w.readInt16LE(this._readable),w.readInt16LE(this._readable),w.readInt32LE(t),w.readInt32LE(t);const a=w.readInt32LE(t),l=w.readInt16LE(t),h=w.readInt16LE(t),c=w.toString(w.readByteArray(t,l),"utf-8");t.skip(h);let d;if(r){const u=wt.empty(),p=new zo(this._readable),g=new Uint8Array(65536);for(;;){const m=p.readBytes(g,0,g.length);if(u.write(g,0,m),m<g.length)break}d=u.toArray()}else d=w.readByteArray(this._readable,a);return s&8&&(w.readInt32LE(this._readable)===Zt.OptionalDataDescriptorSignature&&w.readInt32LE(this._readable),w.readInt32LE(this._readable),w.readInt32LE(this._readable)),new Zt(c,d)}}var gt;(function(n){n[n.None=0]="None",n[n.Element=1]="Element",n[n.Text=2]="Text",n[n.CDATA=3]="CDATA",n[n.Document=4]="Document",n[n.DocumentType=5]="DocumentType",n[n.Comment=6]="Comment"})(gt||(gt={}));class ei{constructor(){o(this,"nodeType",gt.None);o(this,"localName",null);o(this,"value",null);o(this,"childNodes",[]);o(this,"attributes",new Map);o(this,"firstChild",null);o(this,"firstElement",null)}*childElements(){for(const t of this.childNodes)t.nodeType===gt.Element&&(yield t)}addChild(t){this.childNodes.push(t),this.firstChild=t,(t.nodeType===gt.Element||t.nodeType===gt.CDATA)&&(this.firstElement=t)}getAttribute(t,e=""){return this.attributes.has(t)?this.attributes.get(t):e}getElementsByTagName(t,e=!1){const s=[];return this._searchElementsByTagName(this.childNodes,s,t,e),s}_searchElementsByTagName(t,e,s,i=!1){for(const r of t)r&&r.nodeType===gt.Element&&r.localName===s&&e.push(r),i&&this._searchElementsByTagName(r.childNodes,e,s,!0)}findChildElement(t){for(const e of this.childNodes)if(e&&e.nodeType===gt.Element&&e.localName===t)return e;return null}addElement(t){const e=new ei;return e.nodeType=gt.Element,e.localName=t,this.addChild(e),e}get innerText(){var t;if(this.nodeType===gt.Element||this.nodeType===gt.Document){if(this.firstElement&&this.firstElement.nodeType===gt.CDATA)return this.firstElement.innerText;let e="";for(const i of this.childNodes)e+=(t=i.innerText)==null?void 0:t.toString();return e.trim()}return this.value??""}set innerText(t){const e=new ei;e.nodeType=gt.Text,e.value=t,this.childNodes=[e]}setCData(t){const e=new ei;e.nodeType=gt.CDATA,e.value=t,this.childNodes=[e]}}class Us extends Xe{constructor(e,s,i){super(ze.Format,e);o(this,"xml");o(this,"pos",0);this.xml=s,this.pos=i}}var ke;(function(n){n[n.IgnoreSpaces=0]="IgnoreSpaces",n[n.Begin=1]="Begin",n[n.BeginNode=2]="BeginNode",n[n.TagName=3]="TagName",n[n.Body=4]="Body",n[n.AttribName=5]="AttribName",n[n.Equals=6]="Equals",n[n.AttvalBegin=7]="AttvalBegin",n[n.AttribVal=8]="AttribVal",n[n.Childs=9]="Childs",n[n.Close=10]="Close",n[n.WaitEnd=11]="WaitEnd",n[n.WaitEndRet=12]="WaitEndRet",n[n.Pcdata=13]="Pcdata",n[n.Header=14]="Header",n[n.Comment=15]="Comment",n[n.Doctype=16]="Doctype",n[n.Cdata=17]="Cdata",n[n.Escape=18]="Escape"})(ke||(ke={}));const se=class se{static parse(t,e,s){var m;let i=t.charCodeAt(e),r=ke.Begin,a=ke.Begin,l=0,h="",c=ke.Begin,d=null,u=null,p=0,g=0;for(;e<t.length;){switch(i=t.charCodeAt(e),r){case ke.IgnoreSpaces:switch(i){case se.CharCodeLF:case se.CharCodeCR:case se.CharCodeTab:case se.CharCodeSpace:break;default:r=a;continue}break;case ke.Begin:switch(i){case se.CharCodeLowerThan:r=ke.IgnoreSpaces,a=ke.BeginNode;break;default:l=e,r=ke.Pcdata;continue}break;case ke.Pcdata:if(i===se.CharCodeLowerThan){h+=t.substr(l,e-l);const y=new ei;y.nodeType=gt.Text,y.value=h,h="",s.addChild(y),r=ke.IgnoreSpaces,a=ke.BeginNode}else i===se.CharCodeAmp&&(h+=t.substr(l,e-l),r=ke.Escape,c=ke.Pcdata,l=e+1);break;case ke.Cdata:if(i===se.CharCodeBrackedClose&&t.charCodeAt(e+1)===se.CharCodeBrackedClose&&t.charCodeAt(e+2)===se.CharCodeGreaterThan){const y=new ei;y.nodeType=gt.CDATA,y.value=t.substr(l,e-l),s.addChild(y),e+=2,r=ke.Begin}break;case ke.BeginNode:switch(i){case se.CharCodeExclamation:if(t.charCodeAt(e+1)===se.CharCodeBrackedOpen){if(e+=2,t.substr(e,6).toUpperCase()!=="CDATA[")throw new Us("Expected <![CDATA[",t,e);e+=5,r=ke.Cdata,l=e+1}else if(t.charCodeAt(e+1)===se.CharCodeUpperD||t.charCodeAt(e+1)===se.CharCodeLowerD){if(t.substr(e+2,6).toUpperCase()!=="OCTYPE")throw new Us("Expected <!DOCTYPE",t,e);e+=8,r=ke.Doctype,l=e+1}else{if(t.charCodeAt(e+1)!==se.CharCodeMinus||t.charCodeAt(e+2)!==se.CharCodeMinus)throw new Us("Expected <!--",t,e);e+=2,r=ke.Comment,l=e+1}break;case se.CharCodeQuestion:r=ke.Header,l=e;break;case se.CharCodeSlash:if(!s)throw new Us("Expected node name",t,e);l=e+1,r=ke.IgnoreSpaces,a=ke.Close;break;default:r=ke.TagName,l=e;continue}break;case ke.TagName:if(!se._isValidChar(i)){if(e===l)throw new Us("Expected node name",t,e);d=new ei,d.nodeType=gt.Element,d.localName=t.substr(l,e-l),s.addChild(d),r=ke.IgnoreSpaces,a=ke.Body;continue}break;case ke.Body:switch(i){case se.CharCodeSlash:r=ke.WaitEnd;break;case se.CharCodeGreaterThan:r=ke.Childs;break;default:r=ke.AttribName,l=e;continue}break;case ke.AttribName:if(!se._isValidChar(i)){if(l===e)throw new Us("Expected attribute name",t,e);if(u=t.substr(l,e-l),d.attributes.has(u))throw new Us(`Duplicate attribute [${u}]`,t,e);r=ke.IgnoreSpaces,a=ke.Equals;continue}break;case ke.Equals:switch(i){case se.CharCodeEquals:r=ke.IgnoreSpaces,a=ke.AttvalBegin;break;default:throw new Us("Expected =",t,e)}break;case ke.AttvalBegin:switch(i){case se.CharCodeDoubleQuote:case se.CharCodeSingleQuote:h="",r=ke.AttribVal,l=e+1,g=i;break}break;case ke.AttribVal:switch(i){case se.CharCodeAmp:h+=t.substr(l,e-l),r=ke.Escape,c=ke.AttribVal,l=e+1;break;default:if(i===g){h+=t.substr(l,e-l);const y=h;h="",d.attributes.set(u,y),r=ke.IgnoreSpaces,a=ke.Body}break}break;case ke.Childs:e=se.parse(t,e,d),l=e,r=ke.Begin;break;case ke.WaitEnd:switch(i){case se.CharCodeGreaterThan:r=ke.Begin;break;default:throw new Us("Expected >",t,e)}break;case ke.WaitEndRet:switch(i){case se.CharCodeGreaterThan:return e;default:throw new Us("Expected >",t,e)}case ke.Close:if(!se._isValidChar(i)){if(l===e)throw new Us("Expected node name",t,e);if(t.substr(l,e-l)!==s.localName)throw new Us(`Expected </${s.localName}>`,t,e);r=ke.IgnoreSpaces,a=ke.WaitEndRet;continue}break;case ke.Comment:i===se.CharCodeMinus&&t.charCodeAt(e+1)===se.CharCodeMinus&&t.charCodeAt(e+2)===se.CharCodeGreaterThan&&(e+=2,r=ke.Begin);break;case ke.Doctype:if(i===se.CharCodeBrackedOpen)p++;else if(i===se.CharCodeBrackedClose)p--;else if(i===se.CharCodeGreaterThan&&p===0){const y=new ei;y.nodeType=gt.DocumentType,y.value=t.substr(l,e-l),s.addChild(y),r=ke.Begin}break;case ke.Header:i===se.CharCodeQuestion&&t.charCodeAt(e+1)===se.CharCodeGreaterThan&&(e++,r=ke.Begin);break;case ke.Escape:if(i===se.CharCodeSemi){const y=t.substr(l,e-l);if(y.charCodeAt(0)===se.CharCodeSharp){const S=y.charCodeAt(1)===se.CharCodeLowerX?Number.parseInt(`0${y.substr(1,y.length-1)}`,10):Number.parseInt(y.substr(1,y.length-1),10);h+=String.fromCharCode(S)}else se._escapes.has(y)?h+=se._escapes.get(y):h+=(m=`&${y};`)==null?void 0:m.toString();l=e+1,r=c}else!se._isValidChar(i)&&i!==se.CharCodeSharp&&(h+="&",h+=t.substr(l,e-l),e--,l=e+1,r=c);break}e++}if(r===ke.Begin&&(l=e,r=ke.Pcdata),r===ke.Pcdata){if(e!==l){h+=t.substr(l,e-l);const y=new ei;y.nodeType=gt.Text,y.value=h,s.addChild(y)}return e}if(r===ke.Escape&&c===ke.Pcdata){h+="&",h+=t.substr(l,e-l);const y=new ei;return y.nodeType=gt.Text,y.value=h,s.addChild(y),e}throw new Us("Unexpected end",t,e)}static _isValidChar(t){return t>=se.CharCodeLowerA&&t<=se.CharCodeLowerZ||t>=se.CharCodeUpperA&&t<=se.CharCodeUpperZ||t>=se.CharCode0&&t<=se.CharCode9||t===se.CharCodeColon||t===se.CharCodeDot||t===se.CharCodeUnderscore||t===se.CharCodeMinus}};o(se,"CharCodeLF",10),o(se,"CharCodeTab",9),o(se,"CharCodeCR",13),o(se,"CharCodeSpace",32),o(se,"CharCodeLowerThan",60),o(se,"CharCodeAmp",38),o(se,"CharCodeBrackedClose",93),o(se,"CharCodeBrackedOpen",91),o(se,"CharCodeGreaterThan",62),o(se,"CharCodeExclamation",33),o(se,"CharCodeUpperD",68),o(se,"CharCodeLowerD",100),o(se,"CharCodeMinus",45),o(se,"CharCodeQuestion",63),o(se,"CharCodeSlash",47),o(se,"CharCodeEquals",61),o(se,"CharCodeDoubleQuote",34),o(se,"CharCodeSingleQuote",39),o(se,"CharCodeSharp",35),o(se,"CharCodeLowerX",120),o(se,"CharCodeLowerA",97),o(se,"CharCodeLowerZ",122),o(se,"CharCodeUpperA",65),o(se,"CharCodeUpperZ",90),o(se,"CharCode0",48),o(se,"CharCode9",57),o(se,"CharCodeColon",58),o(se,"CharCodeDot",46),o(se,"CharCodeUnderscore",95),o(se,"CharCodeSemi",59),o(se,"_escapes",new Map([["lt","<"],["gt",">"],["amp","&"],["quot",'"'],["apos","'"]]));let Yo=se;class Hl{constructor(t,e){o(this,"_result",[]);o(this,"_indention");o(this,"_xmlHeader");o(this,"_isStartOfLine");o(this,"_currentIndention");this._indention=t,this._xmlHeader=e,this._currentIndention="",this._isStartOfLine=!0}writeNode(t){switch(t.nodeType){case gt.None:break;case gt.Element:this._result.length>0&&this._writeLine(),this._write(`<${t.localName}`);for(const[e,s]of t.attributes)this._write(` ${e}="`),this._writeAttributeValue(s),this._write('"');if(t.childNodes.length===0)this._write("/>");else{if(this._write(">"),t.childNodes.length===1&&!t.firstElement)this.writeNode(t.childNodes[0]);else{this._indent();for(const e of t.childNodes)(e.nodeType===gt.Element||e.nodeType===gt.Comment)&&this.writeNode(e);this._unindend(),this._writeLine()}this._write(`</${t.localName}>`)}break;case gt.Text:t.value&&this._write(t.value);break;case gt.CDATA:t.value!==null&&this._write(`<![CDATA[${t.value}]]>`);break;case gt.Document:this._xmlHeader&&this._write('<?xml version="1.0" encoding="utf-8"?>');for(const e of t.childNodes)this.writeNode(e);break;case gt.DocumentType:this._write(`<!DOCTYPE ${t.value}>`);break;case gt.Comment:this._write(`<!-- ${t.value} -->`);break}}_unindend(){this._currentIndention=this._currentIndention.substr(0,this._currentIndention.length-this._indention.length)}_indent(){this._currentIndention+=this._indention}_writeAttributeValue(t){for(let e=0;e<t.length;e++){const s=t.charAt(e);switch(s){case"<":this._result.push("&lt;");break;case">":this._result.push("&gt;");break;case"&":this._result.push("&amp;");break;case"'":this._result.push("&apos;");break;case'"':this._result.push("&quot;");break;default:this._result.push(s);break}}}static write(t,e,s){const i=new Hl(e,s);return i.writeNode(t),i.toString()}_write(t){this._isStartOfLine&&this._result.push(this._currentIndention),this._result.push(t),this._isStartOfLine=!1}_writeLine(t=null){t&&this._write(t),this._indention.length>0&&!this._isStartOfLine&&(this._result.push(`
`),this._isStartOfLine=!0)}toString(){return this._result.join("").trimRight()}}class za extends ei{constructor(){super(),this.nodeType=gt.Document}parse(t){Yo.parse(t,0,this)}toString(){return this.toFormattedString()}toFormattedString(t="",e=!1){return Hl.write(this,t,e)}}class Xi{constructor(){o(this,"noteRange",1);o(this,"x",0);o(this,"y",0)}}var kr;(function(n){n[n.None=0]="None",n[n.Rectangle=1]="Rectangle",n[n.Ellipse=2]="Ellipse",n[n.Circle=3]="Circle"})(kr||(kr={}));class Do extends Xi{constructor(){super(...arguments);o(this,"align",X.Left);o(this,"frame",kr.None);o(this,"text","");o(this,"fontFace","");o(this,"weight",0);o(this,"height",0)}}class Lh extends Xi{constructor(){super(...arguments);o(this,"chord",new Yi)}}class Mh extends Xi{}class Fh extends Xi{}class rd extends Xi{constructor(){super(...arguments);o(this,"number",0)}}class Ah extends Xi{constructor(){super(...arguments);o(this,"decrescendo",!1)}}class Lo extends Xi{constructor(){super(...arguments);o(this,"allNumbers",!1);o(this,"firstNumber",0);o(this,"lastNumber",0)}}class ad extends Xi{constructor(){super(...arguments);o(this,"octave",1)}}class nd extends Xi{}class od{constructor(){o(this,"defaultClef",Fe.G2);o(this,"description","");o(this,"percussion",!1);o(this,"instrument",0);o(this,"volume",0);o(this,"transpose",0);o(this,"index",0)}}class ld{constructor(){o(this,"from",0);o(this,"to",0);o(this,"curly",!1)}}class hd{constructor(){o(this,"currentBarIndex",-1);o(this,"currentBarComplete",!0);o(this,"currentBarDuration",0);o(this,"currentPosition",0);o(this,"voiceStemDir",null);o(this,"repeatCount",0);o(this,"repeatEnd",null)}}class yn{constructor(){o(this,"score");o(this,"_trackChannel",0);o(this,"_beamingMode",ot.Auto);o(this,"_galleryObjects");o(this,"_voiceCounts");o(this,"_isFirstSystem",!0);o(this,"_initialTempo",-1);o(this,"_staffLookup",new Map);o(this,"_brackets",[]);o(this,"_staffLayoutLookup",new Map);o(this,"_staffLayouts",[]);o(this,"_timeSignature",new ii);o(this,"_currentStaffLayout");o(this,"_voiceStates",new Map);o(this,"_currentVoiceState");o(this,"_currentBar");o(this,"_currentVoice");o(this,"_tieStarts");o(this,"_tieStartIds");o(this,"_slurs");o(this,"_crescendo")}parseXml(t,e){this._galleryObjects=new Map,this._tieStarts=[],this._tieStartIds=new Map,this._voiceCounts=new Map,this._slurs=new Map,this._crescendo=new Map,this._isFirstSystem=!0;const s=new za;try{s.parse(t)}catch(i){throw new Mt("Could not parse XML",i)}this._parseDom(s),this._consolidate(),this.score.finish(e)}_consolidate(){A.consolidate(this.score),yn._applyEffectRange(this._slurs,(t,e)=>{e.isLegatoOrigin=!0}),yn._applyEffectRange(this._crescendo,(t,e)=>{e.crescendo=t.decrescendo?Jt.Decrescendo:Jt.Crescendo})}static _applyEffectRange(t,e){for(const[s,i]of t){const r=i.noteRange;let a=s;for(let l=0;l<r;l++)if(e(i,a),a.index+1<a.voice.beats.length)a=a.voice.beats[a.index+1];else if(a.voice.bar.index+1<a.voice.bar.staff.bars.length)a=a.voice.bar.staff.bars[a.voice.bar.index+1].voices[a.voice.index].beats[0];else break}}_parseDom(t){const e=t.firstElement;if(!e)throw new Mt("No valid XML");if(e.localName==="score"){this.score=new gi;for(const s of e.childElements())switch(s.localName){case"info":this._parseInfo(s);break;case"layout":this._parseLayout(s);break;case"gallery":this._parseGallery(s);break;case"pageObjects":this._parsePageObjects(s);break;case"systems":this._parseSystems(s);break}}else throw new Mt('Root node of XML was not "score"')}_parseLayout(t){for(const r of t.childElements())switch(r.localName){case"staves":this._parseLayoutStaves(r);break;case"brackets":this._parseBrackets(r);break}const e=this._brackets.filter(r=>!!r.curly);e.sort((r,a)=>r.from-a.from);let s=0,i=null;for(let r=0;r<this._staffLayouts.length;r++){const a=this._staffLayouts[r];for(;s<e.length&&r>e[s].to;)s++;i&&s<e.length&&r>e[s].from&&r<=e[s].to?i.ensureStaveCount(i.staves.length+1):(i=new Ei,i.ensureStaveCount(1),i.name=a.description,i.playbackInfo.volume=Math.floor(a.volume/128*16),i.playbackInfo.program=a.instrument,a.percussion?(i.playbackInfo.primaryChannel=9,i.playbackInfo.secondaryChannel=9):(i.playbackInfo.primaryChannel=this._trackChannel++,i.playbackInfo.secondaryChannel=this._trackChannel++),this.score.addTrack(i));const l=i.staves[i.staves.length-1];l.isPercussion=a.percussion,l.transpositionPitch=a.transpose,l.displayTranspositionPitch=0,l.showTablature=!1,this._staffLookup.set(a.index,l)}}_parseBrackets(t){for(const e of t.childElements())switch(e.localName){case"bracket":this._parseBracket(e);break}}_parseBracket(t){const e=new ld;e.from=Number.parseInt(t.getAttribute("from"),10),e.to=Number.parseInt(t.getAttribute("to"),10),t.attributes.has("curly")&&(e.curly=t.attributes.get("curly")==="true"),this._brackets.push(e)}_parseLayoutStaves(t){for(const e of t.childElements())switch(e.localName){case"staffLayout":this._parseStaffLayout(e);break}}_parseStaffLayout(t){const e=new od;e.description=t.getAttribute("description");for(const s of t.childElements())switch(s.localName){case"notation":s.attributes.has("defaultClef")&&(e.defaultClef=this._parseClef(s.attributes.get("defaultClef")));break;case"sound":s.attributes.has("percussion")&&(e.percussion=s.attributes.get("percussion")==="true"),s.attributes.has("instr")&&(e.instrument=Number.parseInt(s.attributes.get("instr"),10)),s.attributes.has("volume")&&(e.volume=Number.parseInt(s.attributes.get("volume"),10)),s.attributes.has("transpose")&&(e.transpose=Number.parseInt(s.attributes.get("transpose"),10));break}this._staffLayoutLookup.set(e.description,e),e.index=this._staffLayouts.length,this._staffLayouts.push(e)}_parseClef(t){switch(t){case"treble":return Fe.G2;case"bass":return Fe.F4;case"alto":return Fe.C4;case"tenor":return Fe.C4}return Fe.G2}_parseClefOttava(t){return t.endsWith("-")?pe._8vb:t.endsWith("+")?pe._8va:pe.Regular}_parseSystems(t){for(const e of t.childElements())switch(e.localName){case"system":this._parseSystem(e);break}}_parseSystem(t){t.attributes.has("tempo")&&this.score.masterBars.length===0&&(this._initialTempo=Number.parseInt(t.attributes.get("tempo"),10)),t.getAttribute("beamGrouping")==="0"&&(this._beamingMode=ot.ForceSplitToNext);for(const e of t.childElements())switch(e.localName){case"staves":this._parseStaves(t,e);break}this._isFirstSystem=!1}_parseStaves(t,e){const s=this.score.masterBars.length;for(const i of e.childElements())switch(i.localName){case"staff":this._parseStaff(t,s,i);break}}_parseStaff(t,e,s){const i=s.getAttribute("layout");this._currentStaffLayout=this._staffLayoutLookup.get(i),this._timeSignature.timeSignatureNumerator=4,this._timeSignature.timeSignatureDenominator=4,this._timeSignature.timeSignatureCommon=!1,this._parseTime(s.getAttribute("defaultTime"));const r=this._staffLookup.get(this._currentStaffLayout.index);for(;r.bars.length<e;)this._addNewBar(r);for(const a of s.childElements())switch(a.localName){case"voices":this._parseVoices(i,r,t,e,a);break}}_parseTime(t){switch(t){case"allaBreve":case"C":this._timeSignature.timeSignatureNumerator=2,this._timeSignature.timeSignatureDenominator=2,this._timeSignature.timeSignatureCommon=!0;break;case"longAllaBreve":this._timeSignature.timeSignatureNumerator=4,this._timeSignature.timeSignatureDenominator=4,this._timeSignature.timeSignatureCommon=!0;break;default:if(t.indexOf("/")>0){const e=t.split("/");this._timeSignature.timeSignatureNumerator=Number.parseInt(e[0],10),this._timeSignature.timeSignatureDenominator=Number.parseInt(e[1],10),this._timeSignature.timeSignatureCommon=!1}break}}_parseVoices(t,e,s,i,r){let a=0;for(const l of r.childElements())switch(l.localName){case"voice":this._parseVoice(t,e,s,a,i,l),a++;break}}_getOrCreateBar(t,e){return e<t.bars.length?t.bars[e]:this._addNewBar(t)}_addNewBar(t){const e=new qs;if(t.bars.length>0?(e.clef=t.bars[t.bars.length-1].clef,e.clefOttava=t.bars[t.bars.length-1].clefOttava,e.keySignature=t.bars[t.bars.length-1].keySignature,e.keySignatureType=t.bars[t.bars.length-1].keySignatureType):e.clef=this._currentStaffLayout.defaultClef,t.addBar(e),t.bars.length>this.score.masterBars.length){const s=new ii;this.score.addMasterBar(s),s.index>0?s.tripletFeel=s.previousMasterBar.tripletFeel:this._initialTempo>0&&s.tempoAutomations.push(nt.buildTempoAutomation(!1,0,this._initialTempo,0)),s.timeSignatureDenominator=this._timeSignature.timeSignatureDenominator,s.timeSignatureNumerator=this._timeSignature.timeSignatureNumerator,s.timeSignatureCommon=this._timeSignature.timeSignatureCommon}return e}_newBar(t,e){this._currentVoiceState.currentBarIndex++,this._currentBar=this._getOrCreateBar(t,this._currentVoiceState.currentBarIndex),this._currentVoiceState.currentBarDuration=this._currentBar.masterBar.calculateDuration(!1),this._currentVoiceState.currentBarComplete=!1,this._currentVoiceState.currentPosition=0,this._ensureVoice(t,e)}_parseVoice(t,e,s,i,r,a){const l=`${t}_${i}`;if(this._currentVoiceState&&!this._currentVoiceState.currentBarComplete&&(this._currentBar.masterBar.isAnacrusis=!0),this._voiceStates.has(l)?(this._currentVoiceState=this._voiceStates.get(l),this._currentBar=this._getOrCreateBar(e,this._currentVoiceState.currentBarIndex),this._ensureVoice(e,i)):(this._currentVoiceState=new hd,this._currentVoiceState.currentBarIndex=r-1,this._voiceStates.set(l,this._currentVoiceState),this._newBar(e,i)),a.attributes.has("stemDir"))switch(a.attributes.get("stemDir")){case"up":this._currentVoiceState.voiceStemDir=E.Up;break;case"down":this._currentVoiceState.voiceStemDir=E.Down;break;default:this._currentVoiceState.voiceStemDir=null;break}else this._currentVoiceState.voiceStemDir=null;const h=a.findChildElement("noteObjects");if(s.attributes.has("tempo")){const c=new nt;c.isLinear=!0,c.type=Ve.Tempo,c.value=Number.parseInt(s.attributes.get("tempo"),10),c.ratioPosition=this._currentVoiceState.currentPosition/this._currentVoiceState.currentBarDuration,this._currentBar.masterBar.tempoAutomations.push(c)}if(h)for(const c of h.childElements())switch(this._currentVoiceState.currentBarComplete&&c.localName!=="barline"&&this._newBar(e,i),c.localName){case"clefSign":this._currentBar.clef=this._parseClef(c.getAttribute("clef")),this._currentBar.clefOttava=this._parseClefOttava(c.getAttribute("clef"));break;case"keySign":this._currentBar.keySignature=Number.parseInt(c.getAttribute("fifths"),10);break;case"timeSign":this._parseTime(c.getAttribute("time")),this._currentBar.masterBar.timeSignatureDenominator=this._timeSignature.timeSignatureDenominator,this._currentBar.masterBar.timeSignatureNumerator=this._timeSignature.timeSignatureNumerator,this._currentBar.masterBar.timeSignatureCommon=this._timeSignature.timeSignatureCommon,this._currentVoiceState.currentPosition=0,this._currentVoiceState.currentBarDuration=this._currentBar.masterBar.calculateDuration(!1);break;case"barline":switch(c.getAttribute("type")){case"double":this._currentBar.barLineRight=Be.LightLight,this._currentVoiceState.currentBarComplete||(this._currentBar.masterBar.isAnacrusis=!0),this._currentVoiceState.currentBarComplete=!0;break;case"end":this._currentVoiceState.currentBarComplete||(this._currentBar.masterBar.isAnacrusis=!0);break;case"repEnd":this._currentVoiceState.repeatEnd=this._currentBar.masterBar,this._currentBar.masterBar.repeatCount<this._currentVoiceState.repeatCount&&(this._currentBar.masterBar.repeatCount=this._currentVoiceState.repeatCount),this._parseBarDrawObject(c),this._currentVoiceState.currentBarComplete||(this._currentBar.masterBar.isAnacrusis=!0),this._currentVoiceState.currentBarComplete=!0;break;case"repBegin":this._newBar(e,i),this._currentBar.masterBar.isRepeatStart=!0,this._currentVoiceState.repeatEnd=null,this._currentVoiceState.repeatCount=0;break;case"repEndBegin":this._currentVoiceState.repeatEnd=this._currentBar.masterBar,this._currentBar.masterBar.repeatCount<this._currentVoiceState.repeatCount&&(this._currentBar.masterBar.repeatCount=this._currentVoiceState.repeatCount),this._parseBarDrawObject(c),this._newBar(e,i),this._currentBar.masterBar.isRepeatStart=!0;break;case"dashed":this._currentVoiceState.currentBarComplete||(this._currentBar.masterBar.isAnacrusis=!0),this._currentVoiceState.currentBarComplete=!0;break;default:this._currentVoiceState.currentBarComplete||(this._currentBar.masterBar.isAnacrusis=!0),this._currentVoiceState.currentBarComplete=!0;break}break;case"chord":const d=new qt;this._initFromPreviousBeat(d,this._currentVoice),d.beamingMode=this._beamingMode,this._currentVoiceState.voiceStemDir&&(d.preferredBeamDirection=this._currentVoiceState.voiceStemDir),this._parseDuration(d,c.findChildElement("duration")),d.updateDurations(),this._currentVoiceState.currentPosition+=d.playbackDuration,this._currentVoice.addBeat(d),this._parseChord(d,c),this._currentVoiceState.currentPosition>=this._currentVoiceState.currentBarDuration&&(this._currentVoiceState.currentBarComplete=!0);break;case"rest":const u=this._parseRestDurations(c.findChildElement("duration"));u&&(this._initFromPreviousBeat(u,this._currentVoice),u.updateDurations(),this._currentVoiceState.currentPosition+=u.playbackDuration,this._currentVoice.addBeat(u),this._currentVoiceState.currentPosition>=this._currentVoiceState.currentBarDuration&&(this._currentVoiceState.currentBarComplete=!0));break}}_initFromPreviousBeat(t,e){const s=this._getLastBeat(e);s&&(t.dynamics=s.dynamics)}_getLastBeat(t){if(t.beats.length>0)return t.beats[t.beats.length-1];if(t.bar.index>0){const e=t.bar.staff.bars[t.bar.index-1];if(t.index<e.voices.length){const s=e.voices[t.index];return this._getLastBeat(s)}}return null}_ensureVoice(t,e){for(;this._currentBar.voices.length<e+1;)this._currentBar.addVoice(new Fs);(!this._voiceCounts.has(t.track.index)||this._voiceCounts.get(t.track.index)<this._currentBar.voices.length)&&this._voiceCounts.set(t.track.index,this._currentBar.voices.length),this._currentVoice=this._currentBar.voices[e]}_parseChord(t,e){const s=new Ps;for(const i of e.childElements())switch(i.localName){case"stem":switch(i.getAttribute("dir")){case"up":t.preferredBeamDirection=E.Up;break;case"down":t.preferredBeamDirection=E.Down;break}break;case"articulation":switch(i.getAttribute("type")){case"staccato":s.isStaccato=!0;break;case"normalAccent":s.accentuated=mt.Normal;break;case"strongAccent":s.accentuated=mt.Heavy;break}break;case"lyric":this._parseLyric(t,i);break;case"drawObjects":this._parseBeatDrawObject(t,i);break;case"heads":this._parseHeads(t,s,i);break;case"beam":switch(i.getAttribute("group")){case"force":t.beamingMode=ot.ForceMergeWithNext;break;case"divide":t.beamingMode=ot.ForceSplitToNext;break}break}}_parseHeads(t,e,s){for(const i of s.childElements())switch(i.localName){case"head":this._parseHead(t,e,i);break}}_parseHead(t,e,s){const i=new Ps,r=A.parseTuning(s.getAttribute("pitch"));i.octave=r.octave-1,i.tone=r.tone.noteValue,i.isStaccato=e.isStaccato,i.accentuated=e.accentuated,t.addNote(i);for(const a of s.childElements())switch(a.localName){case"alter":a.attributes.has("step")&&(i.tone+=Number.parseInt(a.attributes.get("step"),10));break;case"tie":a.attributes.has("begin")?this._tieStartIds.has(i.id)||(this._tieStartIds.set(i.id,!0),this._tieStarts.push(i)):a.attributes.has("end")&&this._tieStarts.length>0&&!i.isTieDestination&&(i.isTieDestination=!0,i.tieOrigin=this._tieStarts[0],this._tieStarts.splice(0,1),this._tieStartIds.delete(i.id));break}}_parseBeatDrawObject(t,e){for(const s of e.childElements())switch(s.localName){case"drawObj":const i=this._parseDrawObj(s);if(i){if(i instanceof Do)i.fontFace.startsWith("capella")?i.text==="u"?(t.fermata=new ra,t.fermata.type=Ss.Medium):i.text==="f"?t.dynamics=re.F:i.text==="j"&&(t.dynamics=re.MF):this._isFirstSystem&&this.score.title===""&&i.align===X.Center&&i.height>16&&i.weight>400?this.score.title=i.text:this._isFirstSystem&&this.score.artist===""&&i.align===X.Center&&i.y<0?this.score.artist=i.text:this._isFirstSystem&&this.score.music===""&&i.align===X.Right&&i.y<0?this.score.music=i.text:i.text.startsWith("by capella")||(t.text=i.text);else if(!(i instanceof Lh))if(i instanceof Fh)t.vibrato=Ee.Slight;else if(i instanceof Ah)t.crescendo=i.decrescendo?Jt.Decrescendo:Jt.Crescendo,i.noteRange++,this._crescendo.set(t,i);else if(i instanceof Mh){const r=i;this._slurs.set(t,r)}else i instanceof Lo&&this._applyVolta(i)}break}}_parseBarDrawObject(t){for(const e of t.childElements())switch(e.localName){case"drawObj":const s=this._parseDrawObj(e);s&&s instanceof Lo&&this._applyVolta(s);break}}_applyVolta(t){if(t.lastNumber>0?(this._currentVoiceState.repeatCount=t.lastNumber,this._currentVoiceState.repeatEnd&&this._currentVoiceState.repeatEnd.repeatCount<this._currentVoiceState.repeatCount&&(this._currentVoiceState.repeatEnd.repeatCount=this._currentVoiceState.repeatCount)):t.firstNumber>0&&(this._currentVoiceState.repeatCount=t.firstNumber,this._currentVoiceState.repeatEnd&&this._currentVoiceState.repeatEnd.repeatCount<this._currentVoiceState.repeatCount&&(this._currentVoiceState.repeatEnd.repeatCount=this._currentVoiceState.repeatCount)),t.lastNumber>0&&t.firstNumber>0){let e=0;for(let s=t.firstNumber;s<=t.lastNumber;s++)e=e|1<<s-1;this._currentBar.masterBar.alternateEndings=e}else t.lastNumber>0?this._currentBar.masterBar.alternateEndings=1<<t.lastNumber-1:t.firstNumber>0&&(this._currentBar.masterBar.alternateEndings=1<<t.firstNumber-1)}_parseLyric(t,e){for(const s of e.childElements())switch(s.localName){case"verse":t.lyrics||(t.lyrics=[]);let i=s.innerText;s.getAttribute("hyphen")==="true"&&(i+="-"),t.lyrics.push(i);break}}_parseRestDurations(t){const e=t.getAttribute("base");if(e.indexOf("/")!==-1){const i=new qt;return i.beamingMode=this._beamingMode,this._parseDuration(i,t),i}if(Number.parseInt(e,10)===1){const i=new qt;return i.beamingMode=this._beamingMode,i.duration=b.Whole,i}return L.warning("Importer","Multi-Bar rests are not supported"),null}_parseDurationValue(t){switch(t){case"2/1":return b.DoubleWhole;case"1/1":return b.Whole;case"1/2":return b.Half;case"1/4":return b.Quarter;case"1/8":return b.Eighth;case"1/16":return b.Sixteenth;case"1/32":return b.ThirtySecond;case"1/64":return b.SixtyFourth;case"1/128":return b.OneHundredTwentyEighth;default:return L.warning("Importer","Unsupported duration"),b.Quarter}}_parseDuration(t,e){const s=e.getAttribute("base");t.duration=this._parseDurationValue(s),e.attributes.has("dots")&&(t.dots=Number.parseInt(e.attributes.get("dots"),10));const i=e.findChildElement("tuplet");if(i){t.tupletNumerator=Number.parseInt(i.getAttribute("count"),10);const r=i.getAttribute("tripartite")==="true"?3:1,a=i.getAttribute("prolong")==="true"?0:1;let l=0;for(;r*Math.pow(2,l+a)<t.tupletNumerator;)l++;t.tupletDenominator=r*Math.pow(2,l)}}_parsePageObjects(t){for(const e of t.childElements())switch(e.localName){case"drawObj":const s=this._parseDrawObj(e);if(s&&s instanceof Do)switch(s.align){case X.Center:this.score.title?this.score.subTitle||(this.score.subTitle=e.innerText):this.score.title=e.innerText;break;case X.Right:this.score.artist||(this.score.artist=e.innerText);break}break}}_parseGallery(t){for(const e of t.childElements())switch(e.localName){case"drawObj":const s=this._parseDrawObj(e);s&&this._galleryObjects.set(e.getAttribute("name"),s);break}}_parseDrawObj(t){let e=null,s=1;for(const i of t.childElements())switch(i.localName){case"text":e=this._parseText(i);break;case"guitar":e=this._parseGuitar(i);break;case"slur":e=this._parseSlur(i);break;case"wavyLine":e=this._parseWavyLine(i);break;case"bracket":e=this._parseTupletBracket(i);break;case"wedge":e=this._parseWedge(i);break;case"volta":e=this._parseVolta(i);break;case"octaveClef":e=this._parseOctaveClef(i);break;case"trill":e=this._parseTrill(i);break;case"basic":i.attributes.has("noteRange")&&(s=Number.parseInt(i.attributes.get("noteRange"),10));break}return e&&(e.noteRange=s),e}_parseTrill(t){return new nd}_parseOctaveClef(t){const e=new ad;return t.attributes.has("octave")&&(e.octave=Number.parseInt(t.attributes.get("octave"),10)),e}_parseVolta(t){const e=new Lo;return e.allNumbers=t.attributes.get("allNumbers")==="true",t.attributes.has("firstNumber")&&(e.firstNumber=Number.parseInt(t.attributes.get("firstNumber"),10)),t.attributes.has("lastNumber")&&(e.lastNumber=Number.parseInt(t.attributes.get("lastNumber"),10)),e}_parseWedge(t){const e=new Ah;return e.decrescendo=t.attributes.get("decrescendo")==="true",e}_parseTupletBracket(t){const e=new rd;return t.attributes.has("number")&&(e.number=Number.parseInt(t.attributes.get("number"),10)),e}_parseWavyLine(t){return new Fh}_parseSlur(t){return new Mh}_parseGuitar(t){const e=new Lh,s=t.innerText.trim();for(let i=0;i<s.length;i++)s.charAt(i)==="/"?e.chord.strings.push(0):e.chord.strings.push(Number.parseInt(s.charAt(i),10));return e}_parseText(t){const e=new Do;switch(t.attributes.has("x")&&(e.x=Number.parseFloat(t.attributes.get("x"))),t.attributes.has("x")&&(e.y=Number.parseFloat(t.attributes.get("y"))),t.getAttribute("align")){case"left":e.align=X.Left;break;case"center":e.align=X.Center;break;case"right":e.align=X.Right;break}switch(t.getAttribute("frame")){case"rectangle":e.frame=kr.Rectangle;break;case"ellipse":e.frame=kr.Ellipse;break;case"circle":e.frame=kr.Circle;break;case"none":e.frame=kr.None;break}if(t.firstElement)for(const s of t.childElements())switch(s.localName){case"font":e.fontFace=s.getAttribute("face"),s.attributes.has("weight")&&(e.weight=Number.parseInt(s.attributes.get("weight"),10)),s.attributes.has("height")&&(e.height=Number.parseInt(s.attributes.get("height"),10));break;case"content":e.text=s.innerText;break}else e.text=t.innerText;return e}_parseInfo(t){for(const e of t.childElements())switch(e.localName){case"author":this.score.tab=e.firstChild.innerText;break;case"comment":this.score.notices=e.firstChild.innerText;break}}}class cd extends Fr{get name(){return"Capella"}readScore(){L.debug(this.name,"Loading ZIP entries");const t=new Vl(this.data);let e,s=null;if(e=t.read(),L.debug(this.name,"Zip entries loaded"),e.length>0)for(const i of e)switch(i.fileName){case"score.xml":s=w.toString(i.data,this.settings.importer.encoding);break}else this.data.reset(),s=w.toString(this.data.readAll(),this.settings.importer.encoding);if(!s)throw new Mt("No valid capella file");L.debug(this.name,"Start Parsing score.xml");try{const i=new yn;return i.parseXml(s,this.settings),L.debug(this.name,"score.xml parsed"),i.score}catch(i){throw new Mt("Failed to parse CapXML",i)}}}var G;(function(n){n[n.TargetFine=0]="TargetFine",n[n.TargetSegno=1]="TargetSegno",n[n.TargetSegnoSegno=2]="TargetSegnoSegno",n[n.TargetCoda=3]="TargetCoda",n[n.TargetDoubleCoda=4]="TargetDoubleCoda",n[n.JumpDaCapo=5]="JumpDaCapo",n[n.JumpDaCapoAlCoda=6]="JumpDaCapoAlCoda",n[n.JumpDaCapoAlDoubleCoda=7]="JumpDaCapoAlDoubleCoda",n[n.JumpDaCapoAlFine=8]="JumpDaCapoAlFine",n[n.JumpDalSegno=9]="JumpDalSegno",n[n.JumpDalSegnoAlCoda=10]="JumpDalSegnoAlCoda",n[n.JumpDalSegnoAlDoubleCoda=11]="JumpDalSegnoAlDoubleCoda",n[n.JumpDalSegnoAlFine=12]="JumpDalSegnoAlFine",n[n.JumpDalSegnoSegno=13]="JumpDalSegnoSegno",n[n.JumpDalSegnoSegnoAlCoda=14]="JumpDalSegnoSegnoAlCoda",n[n.JumpDalSegnoSegnoAlDoubleCoda=15]="JumpDalSegnoSegnoAlDoubleCoda",n[n.JumpDalSegnoSegnoAlFine=16]="JumpDalSegnoSegnoAlFine",n[n.JumpDaCoda=17]="JumpDaCoda",n[n.JumpDaDoubleCoda=18]="JumpDaDoubleCoda"})(G||(G={}));const _s=class _s extends Fr{constructor(){super(...arguments);o(this,"_versionNumber",0);o(this,"_score");o(this,"_globalTripletFeel",Me.NoTripletFeel);o(this,"_lyricsTrack",0);o(this,"_lyrics",[]);o(this,"_barCount",0);o(this,"_trackCount",0);o(this,"_playbackInfos",[]);o(this,"_doubleBars",new Set);o(this,"_clefsPerTrack",new Map);o(this,"_keySignatures",new Map);o(this,"_beatTextChunksByTrack",new Map);o(this,"_directionLookup",new Map);o(this,"_initialTempo")}get name(){return"Guitar Pro 3-5"}readScore(){if(this._directionLookup.clear(),this.readVersion(),this._score=new gi,this.readScoreInformation(),this._versionNumber<500&&(this._globalTripletFeel=Re.gpReadBool(this.data)?Me.Triplet8th:Me.NoTripletFeel),this._versionNumber>=400&&this.readLyrics(),this._versionNumber>=510&&this.data.skip(19),this._initialTempo=nt.buildTempoAutomation(!1,0,0,0),this._versionNumber>=500&&(this.readPageSetup(),this._initialTempo.text=Re.gpReadStringIntByte(this.data,this.settings.importer.encoding)),this._initialTempo.value=w.readInt32LE(this.data),this._versionNumber>=510&&Re.gpReadBool(this.data),w.readInt32LE(this.data),this._versionNumber>=400&&this.data.readByte(),this.readPlaybackInfos(),this._versionNumber>=500&&(this._readDirection(G.TargetCoda),this._readDirection(G.TargetDoubleCoda),this._readDirection(G.TargetSegno),this._readDirection(G.TargetSegnoSegno),this._readDirection(G.TargetFine),this._readDirection(G.JumpDaCapo),this._readDirection(G.JumpDaCapoAlCoda),this._readDirection(G.JumpDaCapoAlDoubleCoda),this._readDirection(G.JumpDaCapoAlFine),this._readDirection(G.JumpDalSegno),this._readDirection(G.JumpDalSegnoAlCoda),this._readDirection(G.JumpDalSegnoAlDoubleCoda),this._readDirection(G.JumpDalSegnoAlFine),this._readDirection(G.JumpDalSegnoSegno),this._readDirection(G.JumpDalSegnoSegnoAlCoda),this._readDirection(G.JumpDalSegnoSegnoAlDoubleCoda),this._readDirection(G.JumpDalSegnoSegnoAlFine),this._readDirection(G.JumpDaCoda),this._readDirection(G.JumpDaDoubleCoda),this.data.skip(4)),this._barCount=w.readInt32LE(this.data),this._trackCount=w.readInt32LE(this.data),this.readMasterBars(),this.readTracks(),this.readBars(),this._score.masterBars.length>0){const e=nt.buildTempoAutomation(!1,0,this._score.tempo,2);e.text=this._score.tempoLabel,this._score.masterBars[0].tempoAutomations.push(e)}return A.consolidate(this._score),this._score.finish(this.settings),this._lyrics&&this._lyricsTrack>=0&&this._score.tracks[this._lyricsTrack].applyLyrics(this._lyrics),this._score}_readDirection(e){let s=w.readInt16LE(this.data);if(s===-1)return;s--;let i;this._directionLookup.has(s)?i=this._directionLookup.get(s):(i=[],this._directionLookup.set(s,i)),i.push(e)}readVersion(){let e=Re.gpReadStringByteLength(this.data,30,this.settings.importer.encoding);if(!e.startsWith(_s._versionString))throw new Mt("Unsupported format");e=e.substr(_s._versionString.length+1);const s=e.indexOf(".");this._versionNumber=100*Number.parseInt(e.substr(0,s),10)+Number.parseInt(e.substr(s+1),10),L.debug(this.name,`Guitar Pro version ${e} detected`)}readScoreInformation(){var i;this._score.title=Re.gpReadStringIntUnused(this.data,this.settings.importer.encoding),this._score.subTitle=Re.gpReadStringIntUnused(this.data,this.settings.importer.encoding),this._score.artist=Re.gpReadStringIntUnused(this.data,this.settings.importer.encoding),this._score.album=Re.gpReadStringIntUnused(this.data,this.settings.importer.encoding),this._score.words=Re.gpReadStringIntUnused(this.data,this.settings.importer.encoding),this._score.music=this._versionNumber>=500?Re.gpReadStringIntUnused(this.data,this.settings.importer.encoding):this._score.words,this._score.copyright=Re.gpReadStringIntUnused(this.data,this.settings.importer.encoding),this._score.tab=Re.gpReadStringIntUnused(this.data,this.settings.importer.encoding),this._score.instructions=Re.gpReadStringIntUnused(this.data,this.settings.importer.encoding);const e=w.readInt32LE(this.data);let s="";for(let r=0;r<e;r++)r>0&&(s+=`\r
`),s+=(i=Re.gpReadStringIntUnused(this.data,this.settings.importer.encoding))==null?void 0:i.toString();this._score.notices=s}readLyrics(){this._lyrics=[],this._lyricsTrack=w.readInt32LE(this.data)-1;for(let e=0;e<5;e++){const s=new hr;s.startBar=w.readInt32LE(this.data)-1,s.text=Re.gpReadStringInt(this.data,this.settings.importer.encoding),this._lyrics.push(s)}}readPageSetup(){this.data.skip(28);const e=w.readInt16LE(this.data);A.getOrCreateHeaderFooterStyle(this._score,V.Title).isVisible=(e&1)!==0,A.getOrCreateHeaderFooterStyle(this._score,V.Title).template=Re.gpReadStringIntByte(this.data,this.settings.importer.encoding),A.getOrCreateHeaderFooterStyle(this._score,V.SubTitle).isVisible=(e&2)!==0,A.getOrCreateHeaderFooterStyle(this._score,V.SubTitle).template=Re.gpReadStringIntByte(this.data,this.settings.importer.encoding),A.getOrCreateHeaderFooterStyle(this._score,V.Artist).isVisible=(e&4)!==0,A.getOrCreateHeaderFooterStyle(this._score,V.Artist).template=Re.gpReadStringIntByte(this.data,this.settings.importer.encoding),A.getOrCreateHeaderFooterStyle(this._score,V.Album).isVisible=(e&8)!==0,A.getOrCreateHeaderFooterStyle(this._score,V.Album).template=Re.gpReadStringIntByte(this.data,this.settings.importer.encoding),A.getOrCreateHeaderFooterStyle(this._score,V.Words).isVisible=(e&16)!==0,A.getOrCreateHeaderFooterStyle(this._score,V.Words).template=Re.gpReadStringIntByte(this.data,this.settings.importer.encoding),A.getOrCreateHeaderFooterStyle(this._score,V.Music).isVisible=(e&32)!==0,A.getOrCreateHeaderFooterStyle(this._score,V.Music).template=Re.gpReadStringIntByte(this.data,this.settings.importer.encoding),A.getOrCreateHeaderFooterStyle(this._score,V.WordsAndMusic).isVisible=(e&64)!==0,A.getOrCreateHeaderFooterStyle(this._score,V.WordsAndMusic).template=Re.gpReadStringIntByte(this.data,this.settings.importer.encoding),A.getOrCreateHeaderFooterStyle(this._score,V.Copyright).isVisible=(e&128)!==0,A.getOrCreateHeaderFooterStyle(this._score,V.Copyright).template=Re.gpReadStringIntByte(this.data,this.settings.importer.encoding),A.getOrCreateHeaderFooterStyle(this._score,V.CopyrightSecondLine).isVisible=(e&128)!==0,A.getOrCreateHeaderFooterStyle(this._score,V.CopyrightSecondLine).template=Re.gpReadStringIntByte(this.data,this.settings.importer.encoding),Re.gpReadStringIntByte(this.data,this.settings.importer.encoding)}readPlaybackInfos(){this._playbackInfos=[];let e=0;for(let s=0;s<64;s++){const i=new Ol;i.primaryChannel=e++,i.secondaryChannel=e++,i.program=w.readInt32LE(this.data),i.volume=this.data.readByte(),i.balance=this.data.readByte(),this.data.skip(6),this._playbackInfos.push(i)}}readMasterBars(){for(let e=0;e<this._barCount;e++)this.readMasterBar()}readMasterBar(){let e=null;this._score.masterBars.length>0&&(e=this._score.masterBars[this._score.masterBars.length-1]);const s=new ii;!e&&this._initialTempo.value>0&&s.tempoAutomations.push(this._initialTempo);const i=this.data.readByte();if(i&1?s.timeSignatureNumerator=this.data.readByte():e&&(s.timeSignatureNumerator=e.timeSignatureNumerator),i&2?s.timeSignatureDenominator=this.data.readByte():e&&(s.timeSignatureDenominator=e.timeSignatureDenominator),s.isRepeatStart=(i&4)!==0,i&8&&(s.repeatCount=this.data.readByte()+(this._versionNumber>=500?0:1)),i&16&&this._versionNumber<500){let l=e,h=0;for(;l&&!(l.isRepeatEnd&&l!==e||l.isRepeatStart);)h=h|l.alternateEndings,l=l.previousMasterBar;let c=0;const d=this.data.readByte();for(let u=0;u<8;u++){const p=1<<u;d>u&&!(h&p)&&(c=c|p)}s.alternateEndings=c}if(i&32){const l=new aa;l.text=Re.gpReadStringIntByte(this.data,this.settings.importer.encoding),l.marker="",Re.gpReadColor(this.data,!1),s.section=l}if(i&64&&this._keySignatures.set(this._score.masterBars.length,[w.readSInt8(this.data),this.data.readByte()]),this._versionNumber>=500&&i&3&&this.data.skip(4),this._versionNumber>=500&&(s.alternateEndings=this.data.readByte()),this._versionNumber>=500){switch(this.data.readByte()){case 1:s.tripletFeel=Me.Triplet8th;break;case 2:s.tripletFeel=Me.Triplet16th;break}this.data.readByte()}else s.tripletFeel=this._globalTripletFeel;const r=(i&128)!==0;s.isDoubleBar=r;const a=this._score.masterBars.length;if(this._directionLookup.has(a))for(const l of this._directionLookup.get(a))s.addDirection(l);this._score.addMasterBar(s),r&&this._doubleBars.add(s.index)}readTracks(){for(let e=0;e<this._trackCount;e++)this.readTrack()}readTrack(){const e=new Ei;e.ensureStaveCount(1),this._score.addTrack(e);const s=e.staves[0],i=this.data.readByte();e.name=Re.gpReadStringByteLength(this.data,40,this.settings.importer.encoding),i&1&&(s.isPercussion=!0),this._versionNumber>=500&&(e.isVisibleOnMultiTrack=(i&8)!==0),this._score.stylesheet.perTrackDisplayTuning===null&&(this._score.stylesheet.perTrackDisplayTuning=new Map),this._score.stylesheet.perTrackDisplayTuning.set(e.index,(i&128)!==0);const r=w.readInt32LE(this.data),a=[];for(let d=0;d<7;d++){const u=w.readInt32LE(this.data);r>d&&a.push(u)}s.stringTuning.tunings=a;const l=w.readInt32LE(this.data),h=w.readInt32LE(this.data)-1,c=w.readInt32LE(this.data)-1;if(this.data.skip(4),h>=0&&h<this._playbackInfos.length){const d=this._playbackInfos[h];d.port=l,d.isSolo=(i&16)!==0,d.isMute=(i&32)!==0,d.secondaryChannel=c,ui.isGuitar(d.program)&&(s.displayTranspositionPitch=-12),e.playbackInfo=d}if(s.capo=w.readInt32LE(this.data),e.color=Re.gpReadColor(this.data,!1),this._versionNumber>=500){const d=this.data.readByte();s.showTablature=(d&1)!==0,s.showStandardNotation=(d&2)!==0;const u=(d&100)!==0;this._score.stylesheet.perTrackChordDiagramsOnTop===null&&(this._score.stylesheet.perTrackChordDiagramsOnTop=new Map),this._score.stylesheet.perTrackChordDiagramsOnTop.set(e.index,u),this.data.readByte(),this.data.readByte(),e.playbackInfo.bank=this.data.readByte(),this.data.readByte(),w.readInt32LE(this.data)===12||a[a.length-1]<_s._bassClefTuningThreshold?this._clefsPerTrack.set(e.index,Fe.F4):this._clefsPerTrack.set(e.index,Fe.G2),w.readInt32LE(this.data),w.readInt32LE(this.data),this.data.skip(10),this.data.readByte(),this.data.readByte(),this._readRseBank(),this._versionNumber>=510&&(this.data.skip(4),Re.gpReadStringIntByte(this.data,this.settings.importer.encoding),Re.gpReadStringIntByte(this.data,this.settings.importer.encoding))}else a[a.length-1]<_s._bassClefTuningThreshold?this._clefsPerTrack.set(e.index,Fe.F4):this._clefsPerTrack.set(e.index,Fe.G2)}readBars(){for(let e=0;e<this._barCount;e++)for(let s=0;s<this._trackCount;s++)this.readBar(this._score.tracks[s])}readBar(e){const s=new qs,i=e.staves[0];if(i.isPercussion?s.clef=Fe.Neutral:this._clefsPerTrack.has(e.index)&&(s.clef=this._clefsPerTrack.get(e.index)),i.addBar(s),this._keySignatures.has(s.index)){const a=this._keySignatures.get(s.index);s.keySignature=a[0],s.keySignatureType=a[1]}else s.index>0&&(s.keySignature=s.previousBar.keySignature,s.keySignatureType=s.previousBar.keySignatureType);this._doubleBars.has(s.index)&&(s.barLineRight=Be.LightLight);let r=1;this._versionNumber>=500&&(this.data.readByte(),r=2);for(let a=0;a<r;a++)this.readVoice(e,s)}readVoice(e,s){const i=w.readInt32LE(this.data);if(i===0)return;const r=new Fs;s.addVoice(r);for(let a=0;a<i;a++)this.readBeat(e,s,r)}readBeat(e,s,i){const r=new qt,a=this.data.readByte();if(a&1&&(r.dots=1),a&64){const u=this.data.readByte();r.isEmpty=(u&2)===0}switch(i.addBeat(r),w.readSInt8(this.data)){case-2:r.duration=b.Whole;break;case-1:r.duration=b.Half;break;case 0:r.duration=b.Quarter;break;case 1:r.duration=b.Eighth;break;case 2:r.duration=b.Sixteenth;break;case 3:r.duration=b.ThirtySecond;break;case 4:r.duration=b.SixtyFourth;break;default:r.duration=b.Quarter;break}if(a&32)switch(r.tupletNumerator=w.readInt32LE(this.data),r.tupletNumerator){case 1:r.tupletDenominator=1;break;case 3:r.tupletDenominator=2;break;case 5:case 6:case 7:r.tupletDenominator=4;break;case 9:case 10:case 11:case 12:case 13:r.tupletDenominator=8;break;case 2:case 4:case 8:break;default:r.tupletNumerator=1,r.tupletDenominator=1;break}a&2&&this.readChord(r);const h=this.settings.importer.beatTextAsLyrics&&e.index!==this._lyricsTrack;if(a&4){const u=Re.gpReadStringIntUnused(this.data,this.settings.importer.encoding);if(h){const p=new hr;p.text=u.trim(),p.finish(!0);const g=[];for(let m=p.chunks.length-1;m>=0;m--)g.push(p.chunks[m]);this._beatTextChunksByTrack.set(e.index,g)}else r.text=u}let c=ie.None;a&8&&(c=this.readBeatEffects(r)),a&16&&this.readMixTableChange(r);const d=this.data.readByte();for(let u=6;u>=0;u--)if(d&1<<u&&6-u<s.staff.tuning.length){const p=this.readNote(e,s,i,r,6-u);c!==ie.None&&(p.harmonicType=c,p.harmonicType===ie.Natural&&(p.harmonicValue=A.deltaFretToHarmonicValue(p.fret)))}if(this._versionNumber>=500){const u=w.readInt16LE(this.data);if(u&1&&r.index>0&&(i.beats[r.index-1].beamingMode=ot.ForceSplitToNext),u&2&&(r.preferredBeamDirection=E.Down),u&4&&r.index>0&&(i.beats[r.index-1].beamingMode=ot.ForceMergeWithNext),u&8&&(r.preferredBeamDirection=E.Up),u&16&&(r.ottava=pe._8va),u&32&&(r.ottava=pe._8vb),u&64&&(r.ottava=pe._15ma),u&256&&(r.ottava=pe._15mb),u&2048){const p=this.data.readByte()!==0;r.index>0&&p&&(i.beats[r.index-1].beamingMode=ot.ForceSplitOnSecondaryToNext)}}h&&!r.isRest&&this._beatTextChunksByTrack.has(e.index)&&this._beatTextChunksByTrack.get(e.index).length>0&&(r.lyrics=[this._beatTextChunksByTrack.get(e.index).pop()])}readChord(e){const s=new Yi,i=A.newGuid();if(this._versionNumber>=500){this.data.skip(17),s.name=Re.gpReadStringByteLength(this.data,21,this.settings.importer.encoding),this.data.skip(4),s.firstFret=w.readInt32LE(this.data);for(let l=0;l<7;l++){const h=w.readInt32LE(this.data);l<e.voice.bar.staff.tuning.length&&s.strings.push(h)}const r=this.data.readByte(),a=new Uint8Array(5);this.data.read(a,0,a.length);for(let l=0;l<r;l++)s.barreFrets.push(a[l]);this.data.skip(26)}else if(this.data.readByte()!==0)if(this._versionNumber>=400){this.data.skip(16),s.name=Re.gpReadStringByteLength(this.data,21,this.settings.importer.encoding),this.data.skip(4),s.firstFret=w.readInt32LE(this.data);for(let l=0;l<7;l++){const h=w.readInt32LE(this.data);l<e.voice.bar.staff.tuning.length&&s.strings.push(h)}const r=this.data.readByte(),a=new Uint8Array(5);this.data.read(a,0,a.length);for(let l=0;l<r;l++)s.barreFrets.push(a[l]);this.data.skip(26)}else{this.data.skip(25),s.name=Re.gpReadStringByteLength(this.data,34,this.settings.importer.encoding),s.firstFret=w.readInt32LE(this.data);for(let r=0;r<6;r++){const a=w.readInt32LE(this.data);r<e.voice.bar.staff.tuning.length&&s.strings.push(a)}this.data.skip(36)}else{const r=this._versionNumber>=406?7:6;if(s.name=Re.gpReadStringIntByte(this.data,this.settings.importer.encoding),s.firstFret=w.readInt32LE(this.data),s.firstFret>0)for(let a=0;a<r;a++){const l=w.readInt32LE(this.data);a<e.voice.bar.staff.tuning.length&&s.strings.push(l)}}s.name&&(e.chordId=i,e.voice.bar.staff.addChord(e.chordId,s))}readBeatEffects(e){const s=this.data.readByte();let i=0;if(this._versionNumber>=400&&(i=this.data.readByte()),s&16&&(e.fade=Nt.FadeIn),(this._versionNumber<400&&s&1||s&2)&&(e.vibrato=Ee.Slight),i&1&&(e.rasgueado=le.Ii),s&32&&this._versionNumber>=400)switch(w.readSInt8(this.data)){case 1:e.tap=!0;break;case 2:e.slap=!0;break;case 3:e.pop=!0;break}else if(s&32){switch(w.readSInt8(this.data)){case 1:e.tap=!0;break;case 2:e.slap=!0;break;case 3:e.pop=!0;break}this.data.skip(4)}if(i&4&&this.readTremoloBarEffect(e),s&64){let r=0,a=0;this._versionNumber<500?(a=this.data.readByte(),r=this.data.readByte()):(r=this.data.readByte(),a=this.data.readByte()),r>0?(e.brushType=Y.BrushUp,e.brushDuration=_s._toStrokeValue(r)):a>0&&(e.brushType=Y.BrushDown,e.brushDuration=_s._toStrokeValue(a))}if(i&2)switch(w.readSInt8(this.data)){case 0:e.pickStroke=Ot.None;break;case 1:e.pickStroke=Ot.Up;break;case 2:e.pickStroke=Ot.Down;break}if(this._versionNumber<400){if(s&4)return ie.Natural;if(s&8)return ie.Artificial}return ie.None}readTremoloBarEffect(e){this.data.readByte(),w.readInt32LE(this.data);const s=w.readInt32LE(this.data);if(s>0)for(let i=0;i<s;i++){const r=new H(0,0);r.offset=w.readInt32LE(this.data),r.value=w.readInt32LE(this.data)/_s._bendStep|0,Re.gpReadBool(this.data),e.addWhammyBarPoint(r)}}static _toStrokeValue(e){switch(e){case 1:return 30;case 2:return 30;case 3:return 60;case 4:return 120;case 5:return 240;case 6:return 480;default:return 0}}_readRseBank(){this.data.skip(4),this.data.skip(4),this.data.skip(4),this.data.skip(4)}readMixTableChange(e){const s=new dd;s.instrument=w.readSInt8(this.data),this._versionNumber>=500&&this._readRseBank(),s.volume=w.readSInt8(this.data),s.balance=w.readSInt8(this.data);const i=w.readSInt8(this.data),r=w.readSInt8(this.data),a=w.readSInt8(this.data),l=w.readSInt8(this.data);if(this._versionNumber>=500&&(s.tempoName=Re.gpReadStringIntByte(this.data,this.settings.importer.encoding)),s.tempo=w.readInt32LE(this.data),s.volume>=0&&this.data.readByte(),s.balance>=0&&this.data.readByte(),i>=0&&this.data.readByte(),r>=0&&this.data.readByte(),a>=0&&this.data.readByte(),l>=0&&this.data.readByte(),s.tempo>=0&&(s.duration=w.readSInt8(this.data),this._versionNumber>=510&&this.data.readByte()),this._versionNumber>=400&&this.data.readByte(),this._versionNumber>=500){const h=w.readSInt8(this.data);h>=100?e.wahPedal=ps.Closed:h>=0&&(e.wahPedal=ps.Open)}if(this._versionNumber>=510&&(Re.gpReadStringIntByte(this.data,this.settings.importer.encoding),Re.gpReadStringIntByte(this.data,this.settings.importer.encoding)),s.volume>=0){const h=new nt;h.isLinear=!0,h.type=Ve.Volume,h.value=s.volume,e.automations.push(h)}if(s.balance>=0){const h=new nt;h.isLinear=!0,h.type=Ve.Balance,h.value=s.balance,e.automations.push(h)}if(s.instrument>=0){const h=new nt;h.isLinear=!0,h.type=Ve.Instrument,h.value=s.instrument,e.automations.push(h)}if(s.tempo>=0){const h=new nt;h.isLinear=!0,h.type=Ve.Tempo,h.value=s.tempo,e.automations.push(h),e.voice.bar.masterBar.tempoAutomations.some(c=>c.ratioPosition===h.ratioPosition&&c.value===h.value)||e.voice.bar.masterBar.tempoAutomations.push(h)}}readNote(e,s,i,r,a){const l=new Ps;l.string=s.staff.tuning.length-a;const h=this.data.readByte();if(h&2?l.accentuated=mt.Heavy:h&64&&(l.accentuated=mt.Normal),l.isGhost=(h&4)!==0,h&32){const d=this.data.readByte();d===3?l.isDead=!0:d===2&&(l.isTieDestination=!0)}if(h&1&&this._versionNumber<500&&(this.data.readByte(),this.data.readByte()),h&16){const d=w.readSInt8(this.data);l.dynamics=this.toDynamicValue(d),r.dynamics=l.dynamics}h&32&&(l.fret=w.readSInt8(this.data)),h&128&&(l.leftHandFinger=w.readSInt8(this.data),l.rightHandFinger=w.readSInt8(this.data));let c=!1;if(this._versionNumber>=500&&(h&1&&(l.durationPercent=w.readFloat64BE(this.data)),c=(this.data.readByte()&2)!==0),r.addNote(l),h&8&&this.readNoteEffects(e,i,r,l),s.staff.isPercussion&&(l.percussionArticulation=_s._gp5PercussionInstrumentMap.has(l.fret)?_s._gp5PercussionInstrumentMap.get(l.fret):l.fret,l.string=-1,l.fret=-1),c){const d=A.computeAccidental(s.keySignature,de.Default,l.realValueWithoutHarmonic,!1);d===he.Sharp?l.accidentalMode=de.ForceFlat:d===he.Flat&&(l.accidentalMode=de.ForceSharp)}return l}toDynamicValue(e){switch(e){case 1:return re.PPP;case 2:return re.PP;case 3:return re.P;case 4:return re.MP;case 5:return re.MF;case 6:return re.F;case 7:return re.FF;case 8:return re.FFF;default:return re.F}}readNoteEffects(e,s,i,r){const a=this.data.readByte();let l=0;this._versionNumber>=400&&(l=this.data.readByte()),a&1&&this.readBend(r),a&16&&this.readGrace(s,r),l&4&&this.readTremoloPicking(i),l&8?this.readSlide(r):this._versionNumber<400&&a&4&&(r.slideOutType=ge.Shift),l&16&&this.readArtificialHarmonic(r),l&32&&this.readTrill(r),r.isLetRing=(a&8)!==0,r.isHammerPullOrigin=(a&2)!==0,l&64&&(r.vibrato=Ee.Slight),r.isPalmMute=(l&2)!==0,r.isStaccato=(l&1)!==0}readBend(e){this.data.readByte(),w.readInt32LE(this.data);const s=w.readInt32LE(this.data);if(s>0)for(let i=0;i<s;i++){const r=new H(0,0);r.offset=w.readInt32LE(this.data),r.value=w.readInt32LE(this.data)/_s._bendStep|0,Re.gpReadBool(this.data),e.addBendPoint(r)}}readGrace(e,s){const i=new qt,r=new Ps;switch(r.string=s.string,r.fret=w.readSInt8(this.data),i.duration=b.ThirtySecond,i.dynamics=this.toDynamicValue(w.readSInt8(this.data)),w.readSInt8(this.data)){case 0:break;case 1:r.slideOutType=ge.Legato,r.slideTarget=s;break;case 2:break;case 3:r.isHammerPullOrigin=!0;break}if(r.dynamics=i.dynamics,this.data.skip(1),this._versionNumber<500)i.graceType=ee.BeforeBeat;else{const l=this.data.readByte();r.isDead=(l&1)!==0,i.graceType=l&2?ee.OnBeat:ee.BeforeBeat}e.addGraceBeat(i),i.addNote(r)}readTremoloPicking(e){const s=new Ns;e.tremoloPicking=s,s.marks=this.data.readByte()}readSlide(e){if(this._versionNumber>=500){const s=w.readSInt8(this.data);s&1?e.slideOutType=ge.Shift:s&2?e.slideOutType=ge.Legato:s&4?e.slideOutType=ge.OutDown:s&8&&(e.slideOutType=ge.OutUp),s&16?e.slideInType=Et.IntoFromBelow:s&32&&(e.slideInType=Et.IntoFromAbove)}else switch(w.readSInt8(this.data)){case 1:e.slideOutType=ge.Shift;break;case 2:e.slideOutType=ge.Legato;break;case 3:e.slideOutType=ge.OutDown;break;case 4:e.slideOutType=ge.OutUp;break;case-1:e.slideInType=Et.IntoFromBelow;break;case-2:e.slideInType=Et.IntoFromAbove;break}}readArtificialHarmonic(e){const s=this.data.readByte();if(this._versionNumber>=500)switch(s){case 1:e.harmonicType=ie.Natural,e.harmonicValue=A.deltaFretToHarmonicValue(e.fret);break;case 2:this.data.readByte(),this.data.readByte(),this.data.readByte(),e.harmonicType=ie.Artificial;break;case 3:e.harmonicType=ie.Tap,e.harmonicValue=A.deltaFretToHarmonicValue(this.data.readByte());break;case 4:e.harmonicType=ie.Pinch,e.harmonicValue=12;break;case 5:e.harmonicType=ie.Semi,e.harmonicValue=12;break}else if(this._versionNumber>=400)switch(s){case 1:e.harmonicType=ie.Natural;break;case 3:e.harmonicType=ie.Tap;break;case 4:e.harmonicType=ie.Pinch;break;case 5:e.harmonicType=ie.Semi;break;case 15:e.harmonicType=ie.Artificial;break;case 17:e.harmonicType=ie.Artificial;break;case 22:e.harmonicType=ie.Artificial;break}}readTrill(e){switch(e.trillValue=this.data.readByte()+e.stringTuning,this.data.readByte()){case 1:e.trillSpeed=b.Sixteenth;break;case 2:e.trillSpeed=b.ThirtySecond;break;case 3:e.trillSpeed=b.SixtyFourth;break}}};o(_s,"_versionString","FICHIER GUITAR PRO "),o(_s,"_gp5PercussionInstrumentMap",new Map([[27,42],[28,60],[29,29],[30,30],[32,31]])),o(_s,"_bassClefTuningThreshold",A.parseTuning("B1").realValue),o(_s,"_bendStep",25);let Xo=_s;class Re{static gpReadColor(t,e=!1){const s=t.readByte(),i=t.readByte(),r=t.readByte();let a=255;return e?a=t.readByte():t.skip(1),new qe(s,i,r,a)}static gpReadBool(t){return t.readByte()!==0}static gpReadStringIntUnused(t,e){return t.skip(4),Re.gpReadString(t,t.readByte(),e)}static gpReadStringInt(t,e){return Re.gpReadString(t,w.readInt32LE(t),e)}static gpReadStringIntByte(t,e){const s=w.readInt32LE(t)-1;return t.readByte(),Re.gpReadString(t,s,e)}static gpReadString(t,e,s){const i=new Uint8Array(e);return t.read(i,0,i.length),w.toString(i,s)}static gpWriteString(t,e){const s=w.stringToBytes(e);t.writeByte(e.length),t.write(s,0,s.length)}static gpReadStringByteLength(t,e,s){const i=t.readByte(),r=Re.gpReadString(t,i,s);return i<e&&t.skip(e-i),r}}class dd{constructor(){o(this,"volume",-1);o(this,"balance",-1);o(this,"instrument",-1);o(this,"tempoName","");o(this,"tempo",-1);o(this,"duration",-1)}}class Pt{constructor(t=0,e=0,s=0,i=0){o(this,"x");o(this,"y");o(this,"w");o(this,"h");this.x=t,this.y=e,this.h=i,this.w=s}scaleWith(t){this.x*=t,this.y*=t,this.w*=t,this.h*=t}}var Ie;(function(n){n[n.Boolean=0]="Boolean",n[n.Integer=1]="Integer",n[n.Float=2]="Float",n[n.String=3]="String",n[n.Point=4]="Point",n[n.Size=5]="Size",n[n.Rectangle=6]="Rectangle",n[n.Color=7]="Color"})(Ie||(Ie={}));class Ls{constructor(t){o(this,"_types",new Map);o(this,"raw",new Map);t&&this._read(t)}_read(t){const e=wt.fromBuffer(t),s=w.readInt32BE(e);for(let i=0;i<s;i++){const r=Re.gpReadString(e,e.readByte(),"utf-8"),a=e.readByte();switch(this._types.set(r,a),a){case Ie.Boolean:const l=e.readByte()===1;this.addValue(r,l);break;case Ie.Integer:const h=w.readInt32BE(e);this.addValue(r,h);break;case Ie.Float:const c=w.readFloat32BE(e);this.addValue(r,c);break;case Ie.String:const d=Re.gpReadString(e,w.readInt16BE(e),"utf-8");this.addValue(r,d);break;case Ie.Point:const u=w.readInt32BE(e),p=w.readInt32BE(e);this.addValue(r,new H(u,p));break;case Ie.Size:const g=w.readInt32BE(e),m=w.readInt32BE(e);this.addValue(r,new H(g,m));break;case Ie.Rectangle:const y=new Pt;y.x=w.readInt32BE(e),y.y=w.readInt32BE(e),y.w=w.readInt32BE(e),y.h=w.readInt32BE(e),this.addValue(r,y);break;case Ie.Color:const S=Re.gpReadColor(e,!0);this.addValue(r,S);break}}}apply(t){for(const[e,s]of this.raw)switch(e){case"StandardNotation/hideDynamics":t.stylesheet.hideDynamics=s;break;case"System/bracketExtendMode":t.stylesheet.bracketExtendMode=s;break;case"Global/useSystemSignSeparator":t.stylesheet.useSystemSignSeparator=s;break;case"Global/DisplayTuning":t.stylesheet.globalDisplayTuning=s;break;case"Global/DrawChords":t.stylesheet.globalDisplayChordDiagramsOnTop=s;break;case"System/drawChordInScore":t.stylesheet.globalDisplayChordDiagramsInScore=s;break;case"System/showTrackNameSingle":s||(t.stylesheet.singleTrackTrackNamePolicy=Tt.Hidden);break;case"System/showTrackNameMulti":s||(t.stylesheet.multiTrackTrackNamePolicy=Tt.Hidden);break;case"System/trackNameModeSingle":if(t.stylesheet.singleTrackTrackNamePolicy!==Tt.Hidden)switch(s){case 0:t.stylesheet.singleTrackTrackNamePolicy=Tt.FirstSystem;break;case 1:t.stylesheet.singleTrackTrackNamePolicy=Tt.FirstSystem;break;case 2:t.stylesheet.singleTrackTrackNamePolicy=Tt.AllSystems;break}break;case"System/trackNameModeMulti":if(t.stylesheet.multiTrackTrackNamePolicy!==Tt.Hidden)switch(s){case 0:t.stylesheet.multiTrackTrackNamePolicy=Tt.FirstSystem;break;case 1:t.stylesheet.multiTrackTrackNamePolicy=Tt.FirstSystem;break;case 2:t.stylesheet.multiTrackTrackNamePolicy=Tt.AllSystems;break}break;case"System/shortTrackNameOnFirstSystem":s?t.stylesheet.firstSystemTrackNameMode=ls.ShortName:t.stylesheet.firstSystemTrackNameMode=ls.FullName;break;case"System/shortTrackNameOnOtherSystems":s?t.stylesheet.otherSystemsTrackNameMode=ls.ShortName:t.stylesheet.otherSystemsTrackNameMode=ls.FullName;break;case"System/horizontalTrackNameOnFirstSystem":s?t.stylesheet.firstSystemTrackNameOrientation=hs.Horizontal:t.stylesheet.firstSystemTrackNameOrientation=hs.Vertical;break;case"System/horizontalTrackNameOnOtherSystems":s?t.stylesheet.otherSystemsTrackNameOrientation=hs.Horizontal:t.stylesheet.otherSystemsTrackNameOrientation=hs.Vertical;break;case"System/ExtendedBarLines":t.stylesheet.extendBarLines=s;break;case"Header/Title":A.getOrCreateHeaderFooterStyle(t,V.Title).template=s;break;case"Header/TitleAlignment":A.getOrCreateHeaderFooterStyle(t,V.Title).textAlign=this._toTextAlign(s);break;case"Header/drawTitle":A.getOrCreateHeaderFooterStyle(t,V.Title).isVisible=s;break;case"Header/Subtitle":A.getOrCreateHeaderFooterStyle(t,V.SubTitle).template=s;break;case"Header/SubtitleAlignment":A.getOrCreateHeaderFooterStyle(t,V.SubTitle).textAlign=this._toTextAlign(s);break;case"Header/drawSubtitle":A.getOrCreateHeaderFooterStyle(t,V.SubTitle).isVisible=s;break;case"Header/Artist":A.getOrCreateHeaderFooterStyle(t,V.Artist).template=s;break;case"Header/ArtistAlignment":A.getOrCreateHeaderFooterStyle(t,V.Artist).textAlign=this._toTextAlign(s);break;case"Header/drawArtist":A.getOrCreateHeaderFooterStyle(t,V.Artist).isVisible=s;break;case"Header/Album":A.getOrCreateHeaderFooterStyle(t,V.Album).template=s;break;case"Header/AlbumAlignment":A.getOrCreateHeaderFooterStyle(t,V.Album).textAlign=this._toTextAlign(s);break;case"Header/drawAlbum":A.getOrCreateHeaderFooterStyle(t,V.Album).isVisible=s;break;case"Header/Words":A.getOrCreateHeaderFooterStyle(t,V.Words).template=s;break;case"Header/WordsAlignment":A.getOrCreateHeaderFooterStyle(t,V.Words).textAlign=this._toTextAlign(s);break;case"Header/drawWords":A.getOrCreateHeaderFooterStyle(t,V.Words).isVisible=s;break;case"Header/Music":A.getOrCreateHeaderFooterStyle(t,V.Music).template=s;break;case"Header/MusicAlignment":A.getOrCreateHeaderFooterStyle(t,V.Music).textAlign=this._toTextAlign(s);break;case"Header/drawMusic":A.getOrCreateHeaderFooterStyle(t,V.Music).isVisible=s;break;case"Header/WordsAndMusic":A.getOrCreateHeaderFooterStyle(t,V.WordsAndMusic).template=s;break;case"Header/WordsAndMusicAlignment":A.getOrCreateHeaderFooterStyle(t,V.WordsAndMusic).textAlign=this._toTextAlign(s);break;case"Header/drawWordsAndMusic":A.getOrCreateHeaderFooterStyle(t,V.WordsAndMusic).isVisible=s;break;case"Header/Tabber":A.getOrCreateHeaderFooterStyle(t,V.Transcriber).template=s;break;case"Header/TabberAlignment":A.getOrCreateHeaderFooterStyle(t,V.Transcriber).textAlign=this._toTextAlign(s);break;case"Header/drawTabber":A.getOrCreateHeaderFooterStyle(t,V.Transcriber).isVisible=s;break;case"Footer/Copyright":A.getOrCreateHeaderFooterStyle(t,V.Copyright).template=s;break;case"Footer/CopyrightAlignment":A.getOrCreateHeaderFooterStyle(t,V.Copyright).textAlign=this._toTextAlign(s);break;case"Footer/drawCopyright":A.getOrCreateHeaderFooterStyle(t,V.Copyright).isVisible=s;break;case"Footer/Copyright2":A.getOrCreateHeaderFooterStyle(t,V.CopyrightSecondLine).template=s;break;case"Footer/Copyright2Alignment":A.getOrCreateHeaderFooterStyle(t,V.CopyrightSecondLine).textAlign=this._toTextAlign(s);break;case"Footer/drawCopyright2":A.getOrCreateHeaderFooterStyle(t,V.CopyrightSecondLine).isVisible=s;break;case"System/barIndexDrawType":switch(s){case 0:t.stylesheet.barNumberDisplay=Vt.AllBars;break;case 1:t.stylesheet.barNumberDisplay=Vt.FirstOfSystem;break;case 2:t.stylesheet.barNumberDisplay=Vt.Hide;break}break}}_toTextAlign(t){switch(t){case 0:return X.Left;case 1:return X.Center;case 2:return X.Right}return X.Left}addValue(t,e,s){this.raw.set(t,e),s!==void 0&&this._types.set(t,s)}writeTo(t){w.writeInt32BE(t,this.raw.size);for(const[e,s]of this.raw){const i=this._getDataType(e,s);switch(Re.gpWriteString(t,e),t.writeByte(i),i){case Ie.Boolean:t.writeByte(s?1:0);break;case Ie.Integer:w.writeInt32BE(t,s);break;case Ie.Float:w.writeFloat32BE(t,s);break;case Ie.String:const r=w.stringToBytes(s);w.writeInt16BE(t,r.length),t.write(r,0,r.length);break;case Ie.Point:w.writeInt32BE(t,s.offset),w.writeInt32BE(t,s.value);break;case Ie.Size:w.writeInt32BE(t,s.offset),w.writeInt32BE(t,s.value);break;case Ie.Rectangle:w.writeInt32BE(t,s.x),w.writeInt32BE(t,s.y),w.writeInt32BE(t,s.w),w.writeInt32BE(t,s.h);break;case Ie.Color:t.writeByte(s.r),t.writeByte(s.g),t.writeByte(s.b),t.writeByte(s.a);break}}}_getDataType(t,e){if(this._types.has(t))return this._types.get(t);const s=typeof e;switch(typeof e){case"string":return Ie.String;case"number":const i=e|0;return e===i?Ie.Integer:Ie.Float;case"object":if(e instanceof H)return Ie.Point;if(e instanceof Pt)return Ie.Rectangle;if(e instanceof qe)return Ie.Color;break}throw new Xe(ze.General,`Unknown value type in BinaryStylesheet: ${s}`)}static writeForScore(t){const e=new Ls;switch(e.addValue("StandardNotation/hideDynamics",t.stylesheet.hideDynamics,Ie.Boolean),e.addValue("System/bracketExtendMode",t.stylesheet.bracketExtendMode,Ie.Integer),e.addValue("Global/useSystemSignSeparator",t.stylesheet.useSystemSignSeparator,Ie.Boolean),e.addValue("Global/DisplayTuning",t.stylesheet.globalDisplayTuning,Ie.Boolean),e.addValue("Global/DrawChords",t.stylesheet.globalDisplayChordDiagramsOnTop,Ie.Boolean),e.addValue("System/drawChordInScore",t.stylesheet.globalDisplayChordDiagramsInScore,Ie.Boolean),t.stylesheet.singleTrackTrackNamePolicy){case Tt.Hidden:e.addValue("System/showTrackNameSingle",!1,Ie.Boolean);break;case Tt.FirstSystem:e.addValue("System/trackNameModeSingle",0,Ie.Integer);break;case Tt.AllSystems:e.addValue("System/trackNameModeSingle",2,Ie.Integer);break}switch(t.stylesheet.multiTrackTrackNamePolicy){case Tt.Hidden:e.addValue("System/showTrackNameMulti",!1,Ie.Boolean);break;case Tt.FirstSystem:e.addValue("System/trackNameModeMulti",0,Ie.Integer);break;case Tt.AllSystems:e.addValue("System/trackNameModeMulti",2,Ie.Integer);break}switch(t.stylesheet.firstSystemTrackNameMode){case ls.FullName:e.addValue("System/shortTrackNameOnFirstSystem",!1,Ie.Boolean);break;case ls.ShortName:e.addValue("System/shortTrackNameOnFirstSystem",!0,Ie.Boolean);break}switch(t.stylesheet.otherSystemsTrackNameMode){case ls.FullName:e.addValue("System/shortTrackNameOnOtherSystems",!1,Ie.Boolean);break;case ls.ShortName:e.addValue("System/shortTrackNameOnOtherSystems",!0,Ie.Boolean);break}switch(t.stylesheet.firstSystemTrackNameOrientation){case hs.Horizontal:e.addValue("System/horizontalTrackNameOnFirstSystem",!0,Ie.Boolean);break;case hs.Vertical:e.addValue("System/horizontalTrackNameOnFirstSystem",!1,Ie.Boolean);break}switch(t.stylesheet.otherSystemsTrackNameOrientation){case hs.Horizontal:e.addValue("System/horizontalTrackNameOnOtherSystems",!0,Ie.Boolean);break;case hs.Vertical:e.addValue("System/horizontalTrackNameOnOtherSystems",!1,Ie.Boolean);break}e.addValue("System/ExtendedBarLines",t.stylesheet.extendBarLines,Ie.Boolean);const s=t.style;if(s)for(const[r,a]of s.headerAndFooter)switch(r){case V.Title:Ls._addHeaderAndFooter(e,a,"Header/","Title");break;case V.SubTitle:Ls._addHeaderAndFooter(e,a,"Header/","Subtitle");break;case V.Artist:Ls._addHeaderAndFooter(e,a,"Header/","Artist");break;case V.Album:Ls._addHeaderAndFooter(e,a,"Header/","Album");break;case V.Words:Ls._addHeaderAndFooter(e,a,"Header/","Words");break;case V.Music:Ls._addHeaderAndFooter(e,a,"Header/","Music");break;case V.WordsAndMusic:Ls._addHeaderAndFooter(e,a,"Header/","WordsAndMusic");break;case V.Transcriber:Ls._addHeaderAndFooter(e,a,"Header/","Tabber");break;case V.Copyright:Ls._addHeaderAndFooter(e,a,"Footer/","Copyright");break;case V.CopyrightSecondLine:Ls._addHeaderAndFooter(e,a,"Footer/","Copyright2");break}switch(t.stylesheet.barNumberDisplay){case Vt.AllBars:e.addValue("System/barIndexDrawType",0,Ie.Integer);break;case Vt.FirstOfSystem:e.addValue("System/barIndexDrawType",1,Ie.Integer);break;case Vt.Hide:e.addValue("System/barIndexDrawType",2,Ie.Integer);break}const i=wt.withCapacity(128);return e.writeTo(i),i.toArray()}static _addHeaderAndFooter(t,e,s,i){t.addValue(`${s}${i}`,e.template,Ie.String),t.addValue(`${s}${i}Alignment`,e.textAlign,Ie.Integer),e.isVisible!==void 0&&t.addValue(`${s}draw${i}`,e.isVisible,Ie.Boolean)}}class Gl{constructor(){o(this,"rawAudioFile")}}class ud{constructor(){o(this,"id","");o(this,"dots",0);o(this,"tupletDenominator",-1);o(this,"tupletNumerator",-1);o(this,"value",b.Quarter)}}class fd{constructor(){o(this,"name","");o(this,"path","");o(this,"role","");o(this,"program",0);o(this,"bank",0)}get uniqueId(){return`${this.path};${this.name};${this.role}`}}const R=class R{constructor(){o(this,"score");o(this,"_backingTrackAssetId");o(this,"_masterTrackAutomations");o(this,"_automationsPerTrackIdAndBarIndex");o(this,"_sustainPedalsPerTrackIdAndBarIndex");o(this,"_tracksMapping");o(this,"_tracksById");o(this,"_masterBars");o(this,"_barsOfMasterBar");o(this,"_barsById");o(this,"_voicesOfBar");o(this,"_voiceById");o(this,"_beatsOfVoice");o(this,"_rhythmOfBeat");o(this,"_beatById");o(this,"_rhythmById");o(this,"_noteById");o(this,"_notesOfBeat");o(this,"_tappedNotes");o(this,"_lyricsByTrack");o(this,"_soundsByTrack");o(this,"_hasAnacrusis",!1);o(this,"_articulationByName");o(this,"_skipApplyLyrics",!1);o(this,"_backingTrackPadding",0);o(this,"_doubleBars",new Set);o(this,"_keySignatures",new Map);o(this,"loadAsset");o(this,"_transposeKeySignaturePerTrack",new Map)}parseXml(t,e){this._masterTrackAutomations=new Map,this._automationsPerTrackIdAndBarIndex=new Map,this._sustainPedalsPerTrackIdAndBarIndex=new Map,this._tracksMapping=[],this._tracksById=new Map,this._masterBars=[],this._barsOfMasterBar=[],this._voicesOfBar=new Map,this._barsById=new Map,this._voiceById=new Map,this._beatsOfVoice=new Map,this._beatById=new Map,this._rhythmOfBeat=new Map,this._rhythmById=new Map,this._notesOfBeat=new Map,this._noteById=new Map,this._tappedNotes=new Map,this._lyricsByTrack=new Map,this._soundsByTrack=new Map,this._skipApplyLyrics=!1;const s=new za;try{s.parse(t)}catch(i){throw new Mt("Could not parse XML",i)}if(this._parseDom(s),this._buildModel(),A.consolidate(this.score),this.score.finish(e),!this._skipApplyLyrics&&this._lyricsByTrack.size>0)for(const[i,r]of this._lyricsByTrack)this._tracksById.get(i).applyLyrics(r)}_parseDom(t){const e=t.firstElement;if(e)if(e.localName==="GPIF"){this.score=new gi;for(const s of e.childElements())switch(s.localName){case"Score":this._parseScoreNode(s);break;case"MasterTrack":this._parseMasterTrackNode(s);break;case"BackingTrack":this._parseBackingTrackNode(s);break;case"Tracks":this._parseTracksNode(s);break;case"MasterBars":this._parseMasterBarsNode(s);break;case"Bars":this._parseBars(s);break;case"Voices":this._parseVoices(s);break;case"Beats":this._parseBeats(s);break;case"Notes":this._parseNotes(s);break;case"Rhythms":this._parseRhythms(s);break;case"Assets":this._parseAssets(s);break}}else throw new Mt("Root node of XML was not GPIF")}_parseAssets(t){for(const e of t.childElements())switch(e.localName){case"Asset":e.getAttribute("id")===this._backingTrackAssetId&&this._parseBackingTrackAsset(e);break}}_parseBackingTrackAsset(t){let e="";for(const i of t.childElements())switch(i.localName){case"EmbeddedFilePath":e=i.innerText;break}const s=this.loadAsset;if(s){const i=s(e);i?this.score.backingTrack.rawAudioFile=i:this.score.backingTrack=void 0}}_parseScoreNode(t){for(const e of t.childElements())switch(e.localName){case"Title":this.score.title=e.innerText;break;case"SubTitle":this.score.subTitle=e.innerText;break;case"Artist":this.score.artist=e.innerText;break;case"Album":this.score.album=e.innerText;break;case"Words":this.score.words=e.innerText;break;case"Music":this.score.music=e.innerText;break;case"WordsAndMusic":const s=e.innerText;s!==""&&(s&&!this.score.words&&(this.score.words=s),s&&!this.score.music&&(this.score.music=s));break;case"Copyright":this.score.copyright=e.innerText;break;case"Tabber":this.score.tab=e.innerText;break;case"Instructions":this.score.instructions=e.innerText;break;case"Notices":this.score.notices=e.innerText;break;case"ScoreSystemsDefaultLayout":this.score.defaultSystemsLayout=R._parseIntSafe(e.innerText,4);break;case"ScoreSystemsLayout":this.score.systemsLayout=R._splitSafe(e.innerText).map(i=>R._parseIntSafe(i,4));break}}static _parseIntSafe(t,e){if(!t)return e;const s=Number.parseInt(t,10);return Number.isNaN(s)?e:s}static _parseFloatSafe(t,e){if(!t)return e;const s=Number.parseFloat(t);return Number.isNaN(s)?e:s}static _splitSafe(t,e=" "){return t?t.split(e).map(s=>s.trim()).filter(s=>s.length>0):[]}_parseBackingTrackNode(t){const e=new Gl;let s=!1,i="",r="";for(const a of t.childElements())switch(a.localName){case"Enabled":s=a.innerText==="true";break;case"Source":i=a.innerText;break;case"AssetId":r=a.innerText;break;case"FramePadding":this._backingTrackPadding=R._parseIntSafe(a.innerText,0)/R._sampleRate*1e3;break}s&&i==="Local"&&(this.score.backingTrack=e,this._backingTrackAssetId=r)}_parseMasterTrackNode(t){for(const e of t.childElements())switch(e.localName){case"Automations":this._parseAutomations(e,this._masterTrackAutomations,null,null);break;case"Tracks":this._tracksMapping=R._splitSafe(e.innerText);break;case"Anacrusis":this._hasAnacrusis=!0;break}}_parseAutomations(t,e,s,i){for(const r of t.childElements())switch(r.localName){case"Automation":this._parseAutomation(r,e,s,i);break}}_parseAutomation(t,e,s,i){let r=null,a=!1,l=-1,h=0,c=0,d=null,u=0,p=null,g,m=!0;for(const S of t.childElements())switch(S.localName){case"Type":r=S.innerText;break;case"Linear":a=S.innerText.toLowerCase()==="true";break;case"Bar":l=R._parseIntSafe(S.innerText,0);break;case"Position":h=R._parseFloatSafe(S.innerText,0);break;case"Value":if(S.firstElement&&S.firstElement.nodeType===gt.CDATA)d=S.innerText;else if(S.firstElement&&S.firstElement.nodeType===gt.Element&&r==="SyncPoint"){g=new ja;for(const k of S.childElements())switch(k.localName){case"BarIndex":l=R._parseIntSafe(k.innerText,0);break;case"BarOccurrence":g.barOccurence=R._parseIntSafe(k.innerText,0);break;case"FrameOffset":const T=R._parseFloatSafe(k.innerText,0);g.millisecondOffset=T/R._sampleRate*1e3;break}}else{const k=R._splitSafe(S.innerText);k.length===1?(c=R._parseFloatSafe(k[0],0),u=1):(c=R._parseFloatSafe(k[0],0),u=R._parseIntSafe(k[1],0))}break;case"Text":p=S.innerText;break;case"Visible":m=S.innerText.toLowerCase()==="true";break}if(!r)return;const y=[];switch(r){case"Tempo":y.push(nt.buildTempoAutomation(a,h,c,u,m));break;case"SyncPoint":const S=new nt;S.type=Ve.SyncPoint,S.isLinear=a,S.ratioPosition=h,S.syncPointValue=g,S.isVisible=m,y.push(S);break;case"Sound":if(d&&s&&s.has(d)){const k=new nt;k.type=Ve.Bank,k.ratioPosition=h,k.value=s.get(d).bank,k.isVisible=m,y.push(k);const T=nt.buildInstrumentAutomation(a,h,s.get(d).program);y.push(T)}break;case"SustainPedal":if(i){let k;i.has(l)?k=i.get(l):(k=[],i.set(l,k));const T=new Vi;switch(T.ratioPosition=h,u){case 1:T.pedalType=lt.Down;break;case 3:T.pedalType=lt.Up;break}k.push(T)}break}if(y.length){if(p)for(const S of y)S.text=p;if(l>=0){e.has(l)||e.set(l,[]);for(const S of y)e.get(l).push(S)}}}_parseTracksNode(t){for(const e of t.childElements())switch(e.localName){case"Track":this._parseTrack(e);break}}_parseTrack(t){this._articulationByName=new Map;const e=new Ei;e.ensureStaveCount(1);const s=e.staves[0];s.showStandardNotation=!0;const i=t.getAttribute("id");for(const r of t.childElements())switch(r.localName){case"Name":e.name=r.innerText;break;case"Color":const a=R._splitSafe(r.innerText);if(a.length>=3){const c=R._parseIntSafe(a[0],0),d=R._parseIntSafe(a[1],0),u=R._parseIntSafe(a[2],0);e.color=new qe(c,d,u,255)}break;case"Instrument":const l=r.getAttribute("ref");(l.endsWith("-gs")||l.endsWith("GrandStaff"))&&(e.ensureStaveCount(2),e.staves[1].showStandardNotation=!0);break;case"InstrumentSet":this._parseInstrumentSet(e,r);break;case"NotationPatch":this._parseNotationPatch(e,r);break;case"ShortName":e.shortName=r.innerText;break;case"SystemsDefautLayout":e.defaultSystemsLayout=R._parseIntSafe(r.innerText,4);break;case"SystemsLayout":e.systemsLayout=R._splitSafe(r.innerText).map(c=>R._parseIntSafe(c,4));break;case"Lyrics":this._parseLyrics(i,r);break;case"Properties":this._parseTrackProperties(e,r);break;case"GeneralMidi":case"MidiConnection":case"MIDISettings":this._parseGeneralMidi(e,r);break;case"Sounds":this._parseSounds(i,e,r);break;case"PlaybackState":const h=r.innerText;e.playbackInfo.isSolo=h==="Solo",e.playbackInfo.isMute=h==="Mute";break;case"PartSounding":this._parsePartSounding(i,e,r);break;case"Staves":this._parseStaves(e,r);break;case"Transpose":this._parseTranspose(i,e,r);break;case"RSE":this._parseRSE(e,r);break;case"Automations":this._parseTrackAutomations(i,r);break}this._tracksById.set(i,e)}_parseTrackAutomations(t,e){const s=new Map;this._automationsPerTrackIdAndBarIndex.set(t,s);const i=new Map;this._sustainPedalsPerTrackIdAndBarIndex.set(t,i),this._parseAutomations(e,s,this._soundsByTrack.get(t),i)}_parseNotationPatch(t,e){for(const s of e.childElements())switch(s.localName){case"LineCount":const i=R._parseIntSafe(s.innerText,5);for(const r of t.staves)r.standardNotationLineCount=i;break;case"Elements":this._parseElements(t,s,!1);break}}_parseInstrumentSet(t,e){for(const s of e.childElements())switch(s.localName){case"Type":if(s.innerText==="drumKit")for(const r of t.staves)r.isPercussion=!0;break;case"Elements":this._parseElements(t,s,!0);break;case"LineCount":const i=R._parseIntSafe(s.innerText,5);for(const r of t.staves)r.standardNotationLineCount=i;break}}_parseElements(t,e,s){for(const i of e.childElements())switch(i.localName){case"Element":this._parseElement(t,i,s);break}}_parseElement(t,e,s){var r;const i=((r=e.findChildElement("Name"))==null?void 0:r.innerText)??"";for(const a of e.childElements())switch(a.localName){case"Name":case"Articulations":this._parseArticulations(t,a,s,i);break}}_parseArticulations(t,e,s,i){for(const r of e.childElements())switch(r.localName){case"Articulation":this._parseArticulation(t,r,s,i);break}}_parseArticulation(t,e,s,i){const r=new $;r.outputMidiNumber=-1,r.elementType=i;let a="";for(const h of e.childElements()){const c=h.innerText;switch(h.localName){case"Name":a=h.innerText;break;case"InputMidiNumbers":r.id=R._parseIntSafe(c.split(" ")[0],0);break;case"OutputMidiNumber":r.outputMidiNumber=R._parseIntSafe(c,0);break;case"TechniqueSymbol":r.techniqueSymbol=R.parseTechniqueSymbol(c);break;case"TechniquePlacement":r.techniqueSymbolPlacement=R.parseTechniqueSymbolPlacement(c);break;case"Noteheads":const d=R._splitSafe(c);d.length>=1&&(r.noteHeadDefault=R.parseNoteHead(d[0])),d.length>=2&&(r.noteHeadHalf=R.parseNoteHead(d[1])),d.length>=3&&(r.noteHeadWhole=R.parseNoteHead(d[2])),r.noteHeadHalf===f.None&&(r.noteHeadHalf=r.noteHeadDefault),r.noteHeadWhole===f.None&&(r.noteHeadWhole=r.noteHeadDefault);break;case"StaffLine":r.staffLine=R._parseIntSafe(c,0);break}}const l=`${i}.${a}`;s?(t.percussionArticulations.push(r),this._articulationByName.set(l,r)):this._articulationByName.has(l)&&(this._articulationByName.get(l).staffLine=r.staffLine)}static parseTechniqueSymbol(t){switch(t){case"pictEdgeOfCymbal":return f.PictEdgeOfCymbal;case"articStaccatoAbove":return f.ArticStaccatoAbove;case"noteheadParenthesis":return f.NoteheadParenthesis;case"stringsUpBow":return f.StringsUpBow;case"stringsDownBow":return f.StringsDownBow;case"guitarGolpe":return f.GuitarGolpe;default:return f.None}}static parseTechniqueSymbolPlacement(t){switch(t){case"outside":return Je.Outside;case"inside":return Je.Inside;case"above":return Je.Above;case"below":return Je.Below;default:return Je.Outside}}static parseNoteHead(t){switch(t){case"noteheadDoubleWholeSquare":return f.NoteheadDoubleWholeSquare;case"noteheadDoubleWhole":return f.NoteheadDoubleWhole;case"noteheadWhole":return f.NoteheadWhole;case"noteheadHalf":return f.NoteheadHalf;case"noteheadBlack":return f.NoteheadBlack;case"noteheadNull":return f.NoteheadNull;case"noteheadXOrnate":return f.NoteheadXOrnate;case"noteheadTriangleUpWhole":return f.NoteheadTriangleUpWhole;case"noteheadTriangleUpHalf":return f.NoteheadTriangleUpHalf;case"noteheadTriangleUpBlack":return f.NoteheadTriangleUpBlack;case"noteheadDiamondBlackWide":return f.NoteheadDiamondBlackWide;case"noteheadDiamondWhite":return f.NoteheadDiamondWhite;case"noteheadDiamondWhiteWide":return f.NoteheadDiamondWhiteWide;case"noteheadCircleX":return f.NoteheadCircleX;case"noteheadXWhole":return f.NoteheadXWhole;case"noteheadXHalf":return f.NoteheadXHalf;case"noteheadXBlack":return f.NoteheadXBlack;case"noteheadParenthesis":return f.NoteheadParenthesis;case"noteheadSlashedBlack2":return f.NoteheadSlashedBlack2;case"noteheadCircleSlash":return f.NoteheadCircleSlash;case"noteheadHeavyX":return f.NoteheadHeavyX;case"noteheadHeavyXHat":return f.NoteheadHeavyXHat;default:return L.warning("GPIF","Unknown notehead symbol",t),f.None}}_parseStaves(t,e){let s=0;for(const i of e.childElements())switch(i.localName){case"Staff":t.ensureStaveCount(s+1);const r=t.staves[s];this._parseStaff(r,i),s++;break}}_parseStaff(t,e){for(const s of e.childElements())switch(s.localName){case"Properties":this._parseStaffProperties(t,s);break}}_parseStaffProperties(t,e){for(const s of e.childElements())switch(s.localName){case"Property":this._parseStaffProperty(t,s);break}}_parseStaffProperty(t,e){var i,r;switch(e.getAttribute("name")){case"Tuning":for(const l of e.childElements())switch(l.localName){case"Pitches":const h=R._splitSafe((i=e.findChildElement("Pitches"))==null?void 0:i.innerText),c=new Array(h.length);for(let d=0;d<c.length;d++)c[c.length-1-d]=R._parseIntSafe(h[d],0);t.stringTuning.tunings=c;break;case"Label":t.stringTuning.name=l.innerText;break}t.isPercussion||(t.showTablature=!0);break;case"DiagramCollection":case"ChordCollection":this._parseDiagramCollectionForStaff(t,e);break;case"CapoFret":const a=R._parseIntSafe((r=e.findChildElement("Fret"))==null?void 0:r.innerText,0);t.capo=a;break}}_parseLyrics(t,e){const s=[];for(const i of e.childElements())switch(i.localName){case"Line":s.push(this._parseLyricsLine(i));break}this._lyricsByTrack.set(t,s)}_parseLyricsLine(t){const e=new hr;for(const s of t.childElements())switch(s.localName){case"Offset":e.startBar=R._parseIntSafe(s.innerText,0);break;case"Text":e.text=s.innerText;break}return e}_parseDiagramCollectionForTrack(t,e){const s=e.findChildElement("Items");if(s)for(const i of s.childElements())switch(i.localName){case"Item":this._parseDiagramItemForTrack(t,i);break}}_parseDiagramCollectionForStaff(t,e){const s=e.findChildElement("Items");if(s)for(const i of s.childElements())switch(i.localName){case"Item":this._parseDiagramItemForStaff(t,i);break}}_parseDiagramItemForTrack(t,e){const s=new Yi,i=e.getAttribute("id");for(const r of t.staves)r.addChord(i,s);this._parseDiagramItemForChord(s,e)}_parseDiagramItemForStaff(t,e){const s=new Yi,i=e.getAttribute("id");t.addChord(i,s),this._parseDiagramItemForChord(s,e)}_parseDiagramItemForChord(t,e){t.name=e.getAttribute("name");const s=e.findChildElement("Diagram");if(!s){t.showDiagram=!1,t.showFingering=!1;return}const i=R._parseIntSafe(s.getAttribute("stringCount"),6),r=R._parseIntSafe(s.getAttribute("baseFret"),0);t.firstFret=r+1;for(let a=0;a<i;a++)t.strings.push(-1);for(const a of s.childElements())switch(a.localName){case"Fret":const l=R._parseIntSafe(a.getAttribute("string"),0);t.strings[i-l-1]=r+R._parseIntSafe(a.getAttribute("fret"),0);break;case"Fingering":const h=new Map;for(const c of a.childElements())switch(c.localName){case"Position":let d=ae.Unknown;const u=r+R._parseIntSafe(c.getAttribute("fret"),0);switch(c.getAttribute("finger")){case"Index":d=ae.IndexFinger;break;case"Middle":d=ae.MiddleFinger;break;case"Rank":d=ae.AnnularFinger;break;case"Pinky":d=ae.LittleFinger;break;case"Thumb":d=ae.Thumb;break}d!==ae.Unknown&&(h.has(d)?t.barreFrets.push(u):h.set(d,!0));break}break;case"Property":switch(a.getAttribute("name")){case"ShowName":t.showName=a.getAttribute("value")==="true";break;case"ShowDiagram":t.showDiagram=a.getAttribute("value")==="true";break;case"ShowFingering":t.showFingering=a.getAttribute("value")==="true";break}break}}_parseTrackProperties(t,e){for(const s of e.childElements())switch(s.localName){case"Property":this._parseTrackProperty(t,s);break}}_parseTrackProperty(t,e){var i,r;switch(e.getAttribute("name")){case"Tuning":const a=R._splitSafe((i=e.findChildElement("Pitches"))==null?void 0:i.innerText),l=new Array(a.length);for(let c=0;c<l.length;c++)l[l.length-1-c]=R._parseIntSafe(a[c],0);for(const c of t.staves)c.stringTuning.tunings=l,c.showStandardNotation=!0,c.showTablature=!0;break;case"DiagramCollection":case"ChordCollection":this._parseDiagramCollectionForTrack(t,e);break;case"CapoFret":const h=R._parseIntSafe((r=e.findChildElement("Fret"))==null?void 0:r.innerText,0);for(const c of t.staves)c.capo=h;break}}_parseGeneralMidi(t,e){for(const i of e.childElements())switch(i.localName){case"Program":t.playbackInfo.program=R._parseIntSafe(i.innerText,0);break;case"Port":t.playbackInfo.port=R._parseIntSafe(i.innerText,0);break;case"PrimaryChannel":t.playbackInfo.primaryChannel=R._parseIntSafe(i.innerText,0);break;case"SecondaryChannel":t.playbackInfo.secondaryChannel=R._parseIntSafe(i.innerText,0);break}if(e.getAttribute("table")==="Percussion")for(const i of t.staves)i.isPercussion=!0}_parseSounds(t,e,s){for(const i of s.childElements())switch(i.localName){case"Sound":this._parseSound(t,e,i);break}}_parseSound(t,e,s){const i=new fd;for(const r of s.childElements())switch(r.localName){case"Name":i.name=r.innerText;break;case"Path":i.path=r.innerText;break;case"Role":i.role=r.innerText;break;case"MIDI":this._parseSoundMidi(i,r);break}this._soundsByTrack.has(t)||(this._soundsByTrack.set(t,new Map),e.playbackInfo.program=i.program,e.playbackInfo.bank=i.bank),this._soundsByTrack.get(t).set(i.uniqueId,i)}_parseSoundMidi(t,e){let s=0,i=0;for(const r of e.childElements())switch(r.localName){case"Program":t.program=R._parseIntSafe(r.innerText,0);break;case"MSB":s=R._parseIntSafe(r.innerText,0);break;case"LSB":i=R._parseIntSafe(r.innerText,0);break}t.bank=(s&127)<<7|i}_parsePartSounding(t,e,s){for(const i of s.childElements())switch(i.localName){case"TranspositionPitch":for(const a of e.staves)a.displayTranspositionPitch=R._parseIntSafe(i.innerText,0);break;case"NominalKey":const r=Math.max(0,Vs.noteNames.indexOf(i.innerText));this._transposeKeySignaturePerTrack.set(t,r);break}}_parseTranspose(t,e,s){let i=0,r=0;for(const h of s.childElements())switch(h.localName){case"Chromatic":r=R._parseIntSafe(h.innerText,0);break;case"Octave":i=R._parseIntSafe(h.innerText,0);break}const a=i*12+r;for(const h of e.staves)h.displayTranspositionPitch=a;const l=A.flooredDivision(a,12);this._transposeKeySignaturePerTrack.set(t,l)}_parseRSE(t,e){for(const s of e.childElements())switch(s.localName){case"ChannelStrip":this._parseChannelStrip(t,s);break}}_parseChannelStrip(t,e){for(const s of e.childElements())switch(s.localName){case"Parameters":this._parseChannelStripParameters(t,s);break}}_parseChannelStripParameters(t,e){if(e.firstChild&&e.firstChild.value){const s=R._splitSafe(e.firstChild.value);s.length>=12&&(t.playbackInfo.balance=Math.floor(R._parseFloatSafe(s[11],.5)*16),t.playbackInfo.volume=Math.floor(R._parseFloatSafe(s[12],.9)*16))}}_parseMasterBarsNode(t){for(const e of t.childElements())switch(e.localName){case"MasterBar":this._parseMasterBar(e);break}}_parseMasterBar(t){var s,i,r;const e=new ii;this._masterBars.length===0&&this._hasAnacrusis&&(e.isAnacrusis=!0);for(const a of t.childElements())switch(a.localName){case"Time":const l=a.innerText.split("/");e.timeSignatureNumerator=R._parseIntSafe(l[0],4),e.timeSignatureDenominator=R._parseIntSafe(l[1],4);break;case"FreeTime":e.isFreeTime=!0;break;case"DoubleBar":e.isDoubleBar=!0,this._doubleBars.add(e);break;case"Section":e.section=new aa,e.section.marker=((s=a.findChildElement("Letter"))==null?void 0:s.innerText)??"",e.section.text=((i=a.findChildElement("Text"))==null?void 0:i.innerText)??"";break;case"Repeat":a.getAttribute("start").toLowerCase()==="true"&&(e.isRepeatStart=!0),a.getAttribute("end").toLowerCase()==="true"&&a.getAttribute("count")&&(e.repeatCount=R._parseIntSafe(a.getAttribute("count"),1));break;case"AlternateEndings":const h=R._splitSafe(a.innerText);let c=0;for(let g=0;g<h.length;g++)c=c|1<<-1+R._parseIntSafe(h[g],0);e.alternateEndings=c;break;case"Bars":this._barsOfMasterBar.push(R._splitSafe(a.innerText));break;case"TripletFeel":switch(a.innerText){case"NoTripletFeel":e.tripletFeel=Me.NoTripletFeel;break;case"Triplet8th":e.tripletFeel=Me.Triplet8th;break;case"Triplet16th":e.tripletFeel=Me.Triplet16th;break;case"Dotted8th":e.tripletFeel=Me.Dotted8th;break;case"Dotted16th":e.tripletFeel=Me.Dotted16th;break;case"Scottish8th":e.tripletFeel=Me.Scottish8th;break;case"Scottish16th":e.tripletFeel=Me.Scottish16th;break}break;case"Key":const d=R._parseIntSafe((r=a.findChildElement("AccidentalCount"))==null?void 0:r.innerText,0),u=a.findChildElement("Mode");let p=cs.Major;if(u)switch(u.innerText.toLowerCase()){case"major":p=cs.Major;break;case"minor":p=cs.Minor;break}this._keySignatures.set(this._masterBars.length,[d,p]);break;case"Fermatas":this._parseFermatas(e,a);break;case"XProperties":this._parseMasterBarXProperties(e,a);break;case"Directions":this._parseDirections(e,a);break}this._masterBars.push(e)}_parseDirections(t,e){for(const s of e.childElements())switch(s.localName){case"Target":switch(s.innerText){case"Coda":t.addDirection(G.TargetCoda);break;case"DoubleCoda":t.addDirection(G.TargetDoubleCoda);break;case"Segno":t.addDirection(G.TargetSegno);break;case"SegnoSegno":t.addDirection(G.TargetSegnoSegno);break;case"Fine":t.addDirection(G.TargetFine);break}break;case"Jump":switch(s.innerText){case"DaCapo":t.addDirection(G.JumpDaCapo);break;case"DaCapoAlCoda":t.addDirection(G.JumpDaCapoAlCoda);break;case"DaCapoAlDoubleCoda":t.addDirection(G.JumpDaCapoAlDoubleCoda);break;case"DaCapoAlFine":t.addDirection(G.JumpDaCapoAlFine);break;case"DaSegno":t.addDirection(G.JumpDalSegno);break;case"DaSegnoAlCoda":t.addDirection(G.JumpDalSegnoAlCoda);break;case"DaSegnoAlDoubleCoda":t.addDirection(G.JumpDalSegnoAlDoubleCoda);break;case"DaSegnoAlFine":t.addDirection(G.JumpDalSegnoAlFine);break;case"DaSegnoSegno":t.addDirection(G.JumpDalSegnoSegno);break;case"DaSegnoSegnoAlCoda":t.addDirection(G.JumpDalSegnoSegnoAlCoda);break;case"DaSegnoSegnoAlDoubleCoda":t.addDirection(G.JumpDalSegnoSegnoAlDoubleCoda);break;case"DaSegnoSegnoAlFine":t.addDirection(G.JumpDalSegnoSegnoAlFine);break;case"DaCoda":t.addDirection(G.JumpDaCoda);break;case"DaDoubleCoda":t.addDirection(G.JumpDaDoubleCoda);break}break}}_parseFermatas(t,e){for(const s of e.childElements())switch(s.localName){case"Fermata":this._parseFermata(t,s);break}}_parseFermata(t,e){let s=0;const i=new ra;for(const r of e.childElements())switch(r.localName){case"Type":switch(r.innerText){case"Short":i.type=Ss.Short;break;case"Medium":i.type=Ss.Medium;break;case"Long":i.type=Ss.Long;break}break;case"Length":i.length=R._parseFloatSafe(r.innerText,0);break;case"Offset":const a=r.innerText.split("/");if(a.length===2){const l=R._parseIntSafe(a[0],4),h=R._parseIntSafe(a[1],4);s=l/h*D.QuarterTime|0}break}t.addFermata(s,i)}_parseBars(t){for(const e of t.childElements())switch(e.localName){case"Bar":this._parseBar(e);break}}_parseBar(t){const e=new qs,s=t.getAttribute("id");for(const i of t.childElements())switch(i.localName){case"Voices":this._voicesOfBar.set(s,R._splitSafe(i.innerText));break;case"Clef":switch(i.innerText){case"Neutral":e.clef=Fe.Neutral;break;case"G2":e.clef=Fe.G2;break;case"F4":e.clef=Fe.F4;break;case"C4":e.clef=Fe.C4;break;case"C3":e.clef=Fe.C3;break}break;case"Ottavia":switch(i.innerText){case"8va":e.clefOttava=pe._8va;break;case"15ma":e.clefOttava=pe._15ma;break;case"8vb":e.clefOttava=pe._8vb;break;case"15mb":e.clefOttava=pe._15mb;break}break;case"SimileMark":switch(i.innerText){case"Simple":e.simileMark=At.Simple;break;case"FirstOfDouble":e.simileMark=At.FirstOfDouble;break;case"SecondOfDouble":e.simileMark=At.SecondOfDouble;break}break;case"XProperties":this._parseBarXProperties(i,e);break}this._barsById.set(s,e)}_parseVoices(t){for(const e of t.childElements())switch(e.localName){case"Voice":this._parseVoice(e);break}}_parseVoice(t){const e=new Fs,s=t.getAttribute("id");for(const i of t.childElements())switch(i.localName){case"Beats":this._beatsOfVoice.set(s,R._splitSafe(i.innerText));break}this._voiceById.set(s,e)}_parseBeats(t){for(const e of t.childElements())switch(e.localName){case"Beat":this._parseBeat(e);break}}_parseBeat(t){const e=new qt,s=t.getAttribute("id");for(const i of t.childElements())switch(i.localName){case"Notes":this._notesOfBeat.set(s,R._splitSafe(i.innerText));break;case"Rhythm":this._rhythmOfBeat.set(s,i.getAttribute("ref"));break;case"Fadding":switch(i.innerText){case"FadeIn":e.fade=Nt.FadeIn;break;case"FadeOut":e.fade=Nt.FadeOut;break;case"VolumeSwell":e.fade=Nt.VolumeSwell;break}break;case"Tremolo":const r=new Ns;switch(e.tremoloPicking=r,i.innerText){case"1/2":r.marks=1;break;case"1/4":r.marks=2;break;case"1/8":r.marks=3;break}break;case"Chord":e.chordId=i.innerText;break;case"Hairpin":switch(i.innerText){case"Crescendo":e.crescendo=Jt.Crescendo;break;case"Decrescendo":e.crescendo=Jt.Decrescendo;break}break;case"Arpeggio":i.innerText==="Up"?e.brushType=Y.ArpeggioUp:e.brushType=Y.ArpeggioDown;break;case"Properties":this._parseBeatProperties(i,e);break;case"XProperties":this._parseBeatXProperties(i,e);break;case"FreeText":e.text=i.innerText;break;case"TransposedPitchStemOrientation":switch(i.innerText){case"Upward":e.preferredBeamDirection=E.Up;break;case"Downward":e.preferredBeamDirection=E.Down;break}break;case"Dynamic":switch(i.innerText){case"PPP":e.dynamics=re.PPP;break;case"PP":e.dynamics=re.PP;break;case"P":e.dynamics=re.P;break;case"MP":e.dynamics=re.MP;break;case"MF":e.dynamics=re.MF;break;case"F":e.dynamics=re.F;break;case"FF":e.dynamics=re.FF;break;case"FFF":e.dynamics=re.FFF;break}break;case"GraceNotes":switch(i.innerText){case"OnBeat":e.graceType=ee.OnBeat;break;case"BeforeBeat":e.graceType=ee.BeforeBeat;break}break;case"Legato":i.getAttribute("origin")==="true"&&(e.isLegatoOrigin=!0);break;case"Whammy":const a=new H(0,0);a.value=this._toBendValue(R._parseFloatSafe(i.getAttribute("originValue"),0)),a.offset=this._toBendOffset(R._parseFloatSafe(i.getAttribute("originOffset"),0)),e.addWhammyBarPoint(a);const l=new H(0,0);l.value=this._toBendValue(R._parseFloatSafe(i.getAttribute("middleValue"),0)),l.offset=this._toBendOffset(R._parseFloatSafe(i.getAttribute("middleOffset1"),0)),e.addWhammyBarPoint(l);const h=new H(0,0);h.value=this._toBendValue(R._parseFloatSafe(i.getAttribute("middleValue"),0)),h.offset=this._toBendOffset(R._parseFloatSafe(i.getAttribute("middleOffset2"),0)),e.addWhammyBarPoint(h);const c=new H(0,0);c.value=this._toBendValue(R._parseFloatSafe(i.getAttribute("destinationValue"),0)),c.offset=this._toBendOffset(R._parseFloatSafe(i.getAttribute("destinationOffset"),0)),e.addWhammyBarPoint(c);break;case"Ottavia":switch(i.innerText){case"8va":e.ottava=pe._8va;break;case"8vb":e.ottava=pe._8vb;break;case"15ma":e.ottava=pe._15ma;break;case"15mb":e.ottava=pe._15mb;break}break;case"Lyrics":e.lyrics=this._parseBeatLyrics(i),this._skipApplyLyrics=!0;break;case"Slashed":e.slashed=!0;break;case"DeadSlapped":e.deadSlapped=!0;break;case"Golpe":switch(i.innerText){case"Finger":e.golpe=as.Finger;break;case"Thumb":e.golpe=as.Thumb;break}break;case"Wah":switch(i.innerText){case"Open":e.wahPedal=ps.Open;break;case"Closed":e.wahPedal=ps.Closed;break}break;case"UserTransposedPitchStemOrientation":switch(i.innerText){case"Downward":e.preferredBeamDirection=E.Down;break;case"Upward":e.preferredBeamDirection=E.Up;break}break;case"Timer":e.showTimer=!0,e.timer=R._parseIntSafe(i.innerText,-1),e.timer<0&&(e.timer=null);break}this._beatById.set(s,e)}_parseBeatLyrics(t){const e=[];for(const s of t.childElements())switch(s.localName){case"Line":e.push(s.innerText);break}return e}_parseBeatXProperties(t,e){var s,i,r,a;for(const l of t.childElements())switch(l.localName){case"XProperty":const h=l.getAttribute("id");let c=0;switch(h){case"1124204546":switch(c=R._parseIntSafe((s=l.findChildElement("Int"))==null?void 0:s.innerText,0),c){case 1:e.beamingMode=ot.ForceMergeWithNext;break;case 2:e.beamingMode=ot.ForceSplitToNext;break}break;case"1124204552":switch(c=R._parseIntSafe((i=l.findChildElement("Int"))==null?void 0:i.innerText,0),c){case 1:e.beamingMode!==ot.ForceSplitToNext&&(e.beamingMode=ot.ForceSplitOnSecondaryToNext);break}break;case"1124204545":c=R._parseIntSafe((r=l.findChildElement("Int"))==null?void 0:r.innerText,0),e.invertBeamDirection=c===1;break;case"687935489":c=R._parseIntSafe((a=l.findChildElement("Int"))==null?void 0:a.innerText,0),e.brushDuration=c;break}break}}_parseBarXProperties(t,e){for(const s of t.childElements())switch(s.localName){case"XProperty":switch(s.getAttribute("id")){case"1124139520":const r=s.findChildElement("Double")??s.findChildElement("Float");e.displayScale=R._parseFloatSafe(r==null?void 0:r.innerText,1);break}break}}_parseMasterBarXProperties(t,e){var r,a,l;let s=Number.NaN,i;for(const h of e.childElements())switch(h.localName){case"XProperty":const c=h.getAttribute("id");switch(c){case"1124073984":t.displayScale=R._parseFloatSafe((r=h.findChildElement("Double"))==null?void 0:r.innerText,1);break;case"1124139010":s=R._parseIntSafe((a=h.findChildElement("Int"))==null?void 0:a.innerText,Number.NaN);break;default:const d=R._parseIntSafe(c,0);if(d>=1124139264&&d<=1124139295){const u=d-1124139264,p=R._parseIntSafe((l=h.findChildElement("Int"))==null?void 0:l.innerText,Number.NaN);for(i===void 0&&(i=[]);i.length<u+1;)i.push(0);i[u]=p}break}break}if(!Number.isNaN(s)&&i){const h=new dt;h.groups.set(s,i),t.beamingRules=h}}_parseBeatProperties(t,e){var c,d,u,p,g,m,y,S,k,T,N,F,q;let s=!1,i=null,r=null,a=null,l=null,h=null;for(const U of t.childElements())switch(U.localName){case"Property":switch(U.getAttribute("name")){case"Brush":((c=U.findChildElement("Direction"))==null?void 0:c.innerText)==="Up"?e.brushType=Y.BrushUp:e.brushType=Y.BrushDown;break;case"PickStroke":((d=U.findChildElement("Direction"))==null?void 0:d.innerText)==="Up"?e.pickStroke=Ot.Up:e.pickStroke=Ot.Down;break;case"Slapped":U.findChildElement("Enable")&&(e.slap=!0);break;case"Popped":U.findChildElement("Enable")&&(e.pop=!0);break;case"VibratoWTremBar":switch((u=U.findChildElement("Strength"))==null?void 0:u.innerText){case"Wide":e.vibrato=Ee.Wide;break;case"Slight":e.vibrato=Ee.Slight;break}break;case"WhammyBar":s=!0;break;case"WhammyBarExtend":break;case"WhammyBarOriginValue":i||(i=new H(0,0)),i.value=this._toBendValue(R._parseFloatSafe((p=U.findChildElement("Float"))==null?void 0:p.innerText,0));break;case"WhammyBarOriginOffset":i||(i=new H(0,0)),i.offset=this._toBendOffset(R._parseFloatSafe((g=U.findChildElement("Float"))==null?void 0:g.innerText,0));break;case"WhammyBarMiddleValue":r=this._toBendValue(R._parseFloatSafe((m=U.findChildElement("Float"))==null?void 0:m.innerText,0));break;case"WhammyBarMiddleOffset1":a=this._toBendOffset(R._parseFloatSafe((y=U.findChildElement("Float"))==null?void 0:y.innerText,0));break;case"WhammyBarMiddleOffset2":l=this._toBendOffset(R._parseFloatSafe((S=U.findChildElement("Float"))==null?void 0:S.innerText,0));break;case"WhammyBarDestinationValue":h||(h=new H(H.MaxPosition,0)),h.value=this._toBendValue(R._parseFloatSafe((k=U.findChildElement("Float"))==null?void 0:k.innerText,0));break;case"WhammyBarDestinationOffset":h||(h=new H(0,0)),h.offset=this._toBendOffset(R._parseFloatSafe((T=U.findChildElement("Float"))==null?void 0:T.innerText,0));break;case"BarreFret":e.barreFret=R._parseIntSafe((N=U.findChildElement("Fret"))==null?void 0:N.innerText,0);break;case"BarreString":switch((F=U.findChildElement("String"))==null?void 0:F.innerText){case"0":e.barreShape=Hs.Full;break;case"1":e.barreShape=Hs.Half;break}break;case"Rasgueado":switch((q=U.findChildElement("Rasgueado"))==null?void 0:q.innerText){case"ii_1":e.rasgueado=le.Ii;break;case"mi_1":e.rasgueado=le.Mi;break;case"mii_1":e.rasgueado=le.MiiTriplet;break;case"mii_2":e.rasgueado=le.MiiAnapaest;break;case"pmp_1":e.rasgueado=le.PmpTriplet;break;case"pmp_2":e.rasgueado=le.PmpAnapaest;break;case"pei_1":e.rasgueado=le.PeiTriplet;break;case"pei_2":e.rasgueado=le.PeiAnapaest;break;case"pai_1":e.rasgueado=le.PaiTriplet;break;case"pai_2":e.rasgueado=le.PaiAnapaest;break;case"ami_1":e.rasgueado=le.AmiTriplet;break;case"ami_2":e.rasgueado=le.AmiAnapaest;break;case"ppp_1":e.rasgueado=le.Ppp;break;case"amii_1":e.rasgueado=le.Amii;break;case"amip_1":e.rasgueado=le.Amip;break;case"eami_1":e.rasgueado=le.Eami;break;case"eamii_1":e.rasgueado=le.Eamii;break;case"peami_1":e.rasgueado=le.Peami;break}break}break}s&&(i||(i=new H(0,0)),h||(h=new H(H.MaxPosition,0)),e.addWhammyBarPoint(i),a&&r&&e.addWhammyBarPoint(new H(a,r)),l&&r&&e.addWhammyBarPoint(new H(l,r)),!a&&!l&&r&&e.addWhammyBarPoint(new H(H.MaxPosition/2|0,r)),e.addWhammyBarPoint(h))}_parseNotes(t){for(const e of t.childElements())switch(e.localName){case"Note":this._parseNote(e);break}}_parseNote(t){const e=new Ps,s=t.getAttribute("id");for(const i of t.childElements())switch(i.localName){case"Properties":this._parseNoteProperties(i,e,s);break;case"AntiAccent":i.innerText.toLowerCase()==="normal"&&(e.isGhost=!0);break;case"LetRing":e.isLetRing=!0;break;case"Trill":e.trillValue=R._parseIntSafe(i.innerText,-1),e.trillSpeed=b.Sixteenth;break;case"Accent":const r=R._parseIntSafe(i.innerText,0);r&1&&(e.isStaccato=!0),r&4&&(e.accentuated=mt.Heavy),r&8&&(e.accentuated=mt.Normal),r&16&&(e.accentuated=mt.Tenuto);break;case"Tie":i.getAttribute("destination").toLowerCase()==="true"&&(e.isTieDestination=!0);break;case"Vibrato":switch(i.innerText){case"Slight":e.vibrato=Ee.Slight;break;case"Wide":e.vibrato=Ee.Wide;break}break;case"LeftFingering":switch(i.innerText){case"P":e.leftHandFinger=ae.Thumb;break;case"I":e.leftHandFinger=ae.IndexFinger;break;case"M":e.leftHandFinger=ae.MiddleFinger;break;case"A":e.leftHandFinger=ae.AnnularFinger;break;case"C":e.leftHandFinger=ae.LittleFinger;break}break;case"RightFingering":switch(i.innerText){case"P":e.rightHandFinger=ae.Thumb;break;case"I":e.rightHandFinger=ae.IndexFinger;break;case"M":e.rightHandFinger=ae.MiddleFinger;break;case"A":e.rightHandFinger=ae.AnnularFinger;break;case"C":e.rightHandFinger=ae.LittleFinger;break}break;case"InstrumentArticulation":e.percussionArticulation=R._parseIntSafe(i.innerText,0);break;case"Ornament":switch(i.innerText){case"Turn":e.ornament=ut.Turn;break;case"InvertedTurn":e.ornament=ut.InvertedTurn;break;case"UpperMordent":e.ornament=ut.UpperMordent;break;case"LowerMordent":e.ornament=ut.LowerMordent;break}break}this._noteById.set(s,e)}_parseNoteProperties(t,e,s){var g,m,y,S,k,T,N,F,q,U,x,j,Q,Te;let i=!1,r=null,a=null,l=null,h=null,c=null,d=-1,u=-1,p=!1;for(const te of t.childElements())switch(te.localName){case"Property":switch(te.getAttribute("name")){case"ShowStringNumber":te.findChildElement("Enable")&&(e.showStringNumber=!0);break;case"String":e.string=R._parseIntSafe((g=te.findChildElement("String"))==null?void 0:g.innerText,0)+1;break;case"Fret":e.fret=R._parseIntSafe((m=te.findChildElement("Fret"))==null?void 0:m.innerText,0);break;case"Element":d=R._parseIntSafe((y=te.findChildElement("Element"))==null?void 0:y.innerText,0);break;case"Variation":u=R._parseIntSafe((S=te.findChildElement("Variation"))==null?void 0:S.innerText,0);break;case"Tapped":this._tappedNotes.set(s,!0);break;case"HarmonicType":const $e=te.findChildElement("HType");if($e)switch($e.innerText){case"NoHarmonic":e.harmonicType=ie.None;break;case"Natural":e.harmonicType=ie.Natural;break;case"Artificial":e.harmonicType=ie.Artificial;break;case"Pinch":e.harmonicType=ie.Pinch;break;case"Tap":e.harmonicType=ie.Tap;break;case"Semi":e.harmonicType=ie.Semi;break;case"Feedback":e.harmonicType=ie.Feedback;break}break;case"HarmonicFret":const ce=te.findChildElement("HFret");ce&&(e.harmonicValue=R._parseFloatSafe(ce.innerText,0));break;case"Muted":te.findChildElement("Enable")&&(e.isDead=!0);break;case"PalmMuted":te.findChildElement("Enable")&&(e.isPalmMute=!0);break;case"Octave":e.octave=R._parseIntSafe((k=te.findChildElement("Number"))==null?void 0:k.innerText,0),e.tone===-1&&(e.tone=0);break;case"Tone":e.tone=R._parseIntSafe((T=te.findChildElement("Step"))==null?void 0:T.innerText,0);break;case"ConcertPitch":p||this._parseConcertPitch(te,e);break;case"TransposedPitch":e.accidentalMode=de.Default,this._parseConcertPitch(te,e),p=!0;break;case"Bended":i=!0;break;case"BendOriginValue":r||(r=new H(0,0)),r.value=this._toBendValue(R._parseFloatSafe((N=te.findChildElement("Float"))==null?void 0:N.innerText,0));break;case"BendOriginOffset":r||(r=new H(0,0)),r.offset=this._toBendOffset(R._parseFloatSafe((F=te.findChildElement("Float"))==null?void 0:F.innerText,0));break;case"BendMiddleValue":a=this._toBendValue(R._parseFloatSafe((q=te.findChildElement("Float"))==null?void 0:q.innerText,0));break;case"BendMiddleOffset1":l=this._toBendOffset(R._parseFloatSafe((U=te.findChildElement("Float"))==null?void 0:U.innerText,0));break;case"BendMiddleOffset2":h=this._toBendOffset(R._parseFloatSafe((x=te.findChildElement("Float"))==null?void 0:x.innerText,0));break;case"BendDestinationValue":c||(c=new H(H.MaxPosition,0)),c.value=this._toBendValue(R._parseFloatSafe((j=te.findChildElement("Float"))==null?void 0:j.innerText,0));break;case"BendDestinationOffset":c||(c=new H(0,0)),c.offset=this._toBendOffset(R._parseFloatSafe((Q=te.findChildElement("Float"))==null?void 0:Q.innerText,0));break;case"HopoOrigin":te.findChildElement("Enable")&&(e.isHammerPullOrigin=!0);break;case"HopoDestination":break;case"LeftHandTapped":e.isLeftHandTapped=!0;break;case"Slide":const rt=R._parseIntSafe((Te=te.findChildElement("Flags"))==null?void 0:Te.innerText,0);rt&1?e.slideOutType=ge.Shift:rt&2?e.slideOutType=ge.Legato:rt&4?e.slideOutType=ge.OutDown:rt&8&&(e.slideOutType=ge.OutUp),rt&16?e.slideInType=Et.IntoFromBelow:rt&32&&(e.slideInType=Et.IntoFromAbove),rt&64?e.slideOutType=ge.PickSlideDown:rt&128&&(e.slideOutType=ge.PickSlideUp);break}break}i&&(r||(r=new H(0,0)),c||(c=new H(H.MaxPosition,0)),e.addBendPoint(r),l&&a&&e.addBendPoint(new H(l,a)),h&&a&&e.addBendPoint(new H(h,a)),!l&&!h&&a&&e.addBendPoint(new H(H.MaxPosition/2|0,a)),e.addBendPoint(c)),d!==-1&&u!==-1&&(e.percussionArticulation=jt.articulationFromElementVariation(d,u))}_parseConcertPitch(t,e){const s=t.findChildElement("Pitch");if(s)for(const i of s.childElements())switch(i.localName){case"Accidental":switch(i.innerText){case"":e.accidentalMode=de.ForceNatural;break;case"x":e.accidentalMode=de.ForceDoubleSharp;break;case"#":e.accidentalMode=de.ForceSharp;break;case"b":e.accidentalMode=de.ForceFlat;break;case"bb":e.accidentalMode=de.ForceDoubleFlat;break}break}}_toBendValue(t){return t*R._bendPointValueFactor|0}_toBendOffset(t){return t*R._bendPointPositionFactor}_parseRhythms(t){for(const e of t.childElements())switch(e.localName){case"Rhythm":this._parseRhythm(e);break}}_parseRhythm(t){const e=new ud,s=t.getAttribute("id");e.id=s;for(const i of t.childElements())switch(i.localName){case"NoteValue":switch(i.innerText){case"Long":e.value=b.QuadrupleWhole;break;case"DoubleWhole":e.value=b.DoubleWhole;break;case"Whole":e.value=b.Whole;break;case"Half":e.value=b.Half;break;case"Quarter":e.value=b.Quarter;break;case"Eighth":e.value=b.Eighth;break;case"16th":e.value=b.Sixteenth;break;case"32nd":e.value=b.ThirtySecond;break;case"64th":e.value=b.SixtyFourth;break;case"128th":e.value=b.OneHundredTwentyEighth;break;case"256th":e.value=b.TwoHundredFiftySixth;break}break;case"PrimaryTuplet":e.tupletNumerator=R._parseIntSafe(i.getAttribute("num"),-1),e.tupletDenominator=R._parseIntSafe(i.getAttribute("den"),-1);break;case"AugmentationDot":e.dots=R._parseIntSafe(i.getAttribute("count"),0);break}this._rhythmById.set(s,e)}_buildModel(){for(let i=0,r=this._masterBars.length;i<r;i++){const a=this._masterBars[i];this.score.addMasterBar(a)}const t=this._masterBars[this._masterBars.length-1];this._doubleBars.has(t)&&(this._doubleBars.delete(t),t.isDoubleBar=!1);const e=[];for(const i of this._tracksMapping){if(!i)continue;const r=this._tracksById.get(i);this.score.addTrack(r),e.push(i)}let s;for(const i of this._barsOfMasterBar){let r=0,a=0;s=[Ke.C,cs.Major],this._transposeKeySignaturePerTrack.has(e[0])&&(s=[A.transposeKey(s[0],this._transposeKeySignaturePerTrack.get(e[0])),s[1]]);for(let l=0;l<i.length&&a<this.score.tracks.length;l++){const h=i[l];if(h!==R._invalidId){const c=this._barsById.get(h),d=this.score.tracks[a],u=d.staves[r];u.addBar(c);const p=u.bars.length-1;if(this._keySignatures.has(p)&&(s=this._keySignatures.get(p),this._transposeKeySignaturePerTrack.has(e[a])&&(s=[A.transposeKey(s[0],this._transposeKeySignaturePerTrack.get(e[a])),s[1]])),c.keySignature=s[0],c.keySignatureType=s[1],this._doubleBars.has(c.masterBar)&&(c.barLineRight=Be.LightLight),this._voicesOfBar.has(h))for(const g of this._voicesOfBar.get(h))if(g!==R._invalidId){const m=this._voiceById.get(g);if(c.addVoice(m),this._beatsOfVoice.has(g)){for(const y of this._beatsOfVoice.get(g))if(y!==R._invalidId){const S=Rl.clone(this._beatById.get(y));m.addBeat(S);const k=this._rhythmOfBeat.get(y),T=this._rhythmById.get(k);if(S.duration=T.value,S.dots=T.dots,S.tupletNumerator=T.tupletNumerator,S.tupletDenominator=T.tupletDenominator,this._notesOfBeat.has(y)){for(const N of this._notesOfBeat.get(y))if(N!==R._invalidId){const F=Sc.clone(this._noteById.get(N));u.isPercussion?(F.fret=-1,F.string=-1):F.percussionArticulation=-1,S.addNote(F),this._tappedNotes.has(N)&&(S.tap=!0)}}}}}else{const m=new Fs;c.addVoice(m);const y=new qt;y.isEmpty=!0,y.duration=b.Quarter,m.addBeat(y)}r===d.staves.length-1?(a++,r=0):r++,s=[Ke.C,cs.Major],a<e.length&&this._transposeKeySignaturePerTrack.has(e[a])&&(s=[A.transposeKey(s[0],this._transposeKeySignaturePerTrack.get(e[a])),s[1]])}else a++}}for(const i of this._tracksMapping){if(!i)continue;const r=this._tracksById.get(i);let a=!1;for(const l of r.staves)if(l.isPercussion){a=!0;break}if(a||(r.percussionArticulations=[]),this._automationsPerTrackIdAndBarIndex.has(i)){const l=this._automationsPerTrackIdAndBarIndex.get(i);for(const[h,c]of l)if(r.staves.length>0&&h<r.staves[0].bars.length){const d=r.staves[0].bars[h];if(d.voices.length>0&&d.voices[0].beats.length>0){const u=d.voices[0].beats[0];for(const p of c)p.type===Ve.Bank&&p.value===0&&d.index===0||u.automations.push(p)}}}if(this._sustainPedalsPerTrackIdAndBarIndex.has(i)){const l=this._sustainPedalsPerTrackIdAndBarIndex.get(i);for(const[h,c]of l)if(r.staves.length>0&&h<r.staves[0].bars.length){const d=r.staves[0].bars[h];d.sustainPedals=c}}}for(const[i,r]of this._masterTrackAutomations){const a=this.score.masterBars[i];for(let l=0,h=r.length;l<h;l++){const c=r[l];switch(c.type){case Ve.Tempo:a.tempoAutomations.push(c);break;case Ve.SyncPoint:c.syncPointValue.millisecondOffset-=this._backingTrackPadding,a.addSyncPoint(c);break}}}}};o(R,"_invalidId","-1"),o(R,"_bendPointPositionFactor",H.MaxPosition/100),o(R,"_bendPointValueFactor",1/25),o(R,"_sampleRate",44100);let bn=R;class Mo{constructor(){o(this,"isMultiRest",!1);o(this,"trackViewGroups",[])}}class Ih{constructor(){o(this,"showNumbered",!1);o(this,"showSlash",!1);o(this,"showStandardNotation",!1);o(this,"showTablature",!1)}}class Ul{constructor(t){o(this,"scoreViews",[]);const e=wt.fromBuffer(t),s=w.readInt32BE(e);for(let i=0;i<s;i++){const r=new Mo;this.scoreViews.push(r),r.isMultiRest=Re.gpReadBool(e);const a=w.readInt32BE(e);for(let l=0;l<a;l++){let h=e.readByte();h===0&&(h=1);const c=new Ih;c.showStandardNotation=(h&1)!==0,c.showTablature=(h&2)!==0,c.showSlash=(h&4)!==0,c.showNumbered=(h&8)!==0,r.trackViewGroups.push(c)}}}apply(t){if(this.scoreViews.length>0){let e=0;t.stylesheet.multiTrackMultiBarRest=this.scoreViews[0].isMultiRest;for(const s of this.scoreViews[0].trackViewGroups){if(e<t.tracks.length){const i=t.tracks[e];for(const r of i.staves)r.isPercussion||(r.showTablature=s.showTablature),r.showStandardNotation=s.showStandardNotation,r.showSlash=s.showSlash,r.showNumbered=s.showNumbered}e++}for(let s=1;s<this.scoreViews.length;s++)this.scoreViews[s].isMultiRest&&(t.stylesheet.perTrackMultiBarRest||(t.stylesheet.perTrackMultiBarRest=new Set),e=s-1,t.stylesheet.perTrackMultiBarRest.add(e))}}static writeForScore(t){var i;const e=wt.withCapacity(128),s=[new Mo];s[0].isMultiRest=t.stylesheet.multiTrackMultiBarRest;for(const r of t.tracks){const a=new Ih;a.showStandardNotation=r.staves[0].showStandardNotation,a.showTablature=r.staves[0].showTablature,a.showSlash=r.staves[0].showSlash,a.showNumbered=r.staves[0].showNumbered,s[0].trackViewGroups.push(a);const l=new Mo;l.isMultiRest=((i=t.stylesheet.perTrackMultiBarRest)==null?void 0:i.has(r.index))===!0,l.trackViewGroups.push(a),s.push(l)}w.writeInt32BE(e,s.length);for(const r of s){e.writeByte(r.isMultiRest?1:0),w.writeInt32BE(e,r.trackViewGroups.length);for(const a of r.trackViewGroups){let l=0;a.showStandardNotation&&(l=l|1),a.showTablature&&(l=l|2),a.showSlash&&(l=l|4),a.showNumbered&&(l=l|8),e.writeByte(l)}}return w.writeInt32BE(e,1),e.toArray()}}class pd{constructor(){o(this,"trackViewGroups",[])}}class gd{constructor(){o(this,"isVisible",!1)}}var $o;(function(n){n[n.PageVertical=0]="PageVertical",n[n.PageGrid=1]="PageGrid",n[n.PageParchment=2]="PageParchment",n[n.ScreenVertical=3]="ScreenVertical",n[n.ScreenHorizontal=4]="ScreenHorizontal",n[n.PageHorizontal=5]="PageHorizontal"})($o||($o={}));class zl{constructor(t,e){o(this,"zoomLevel",4);o(this,"view",$o.PageVertical);o(this,"muiltiVoiceCursor",!1);o(this,"scoreViews",[]);const s=wt.fromBuffer(e);this.zoomLevel=w.readInt32BE(s),this.view=s.readByte(),this.muiltiVoiceCursor=s.readByte()!==0;const i=t.scoreViews.length;for(let r=0;r<i;r++){const a=new pd;this.scoreViews.push(a);const l=t.scoreViews[r];for(let h=0;h<l.trackViewGroups.length;h++){const c=new gd;c.isVisible=s.readByte()!==0,a.trackViewGroups.push(c)}}}apply(t){if(this.scoreViews.length>0){let e=0;for(const s of this.scoreViews[0].trackViewGroups){if(e<t.tracks.length){const i=t.tracks[e];i.isVisibleOnMultiTrack=s.isVisible}e++}}}static writeForScore(t){const e=wt.withCapacity(128);w.writeInt32BE(e,4),e.writeByte(0);const s=t.tracks.length>0&&t.tracks[0].staves[0].bars[0].isMultiVoice;e.writeByte(s?255:0);for(const i of t.tracks)e.writeByte(i.isVisibleOnMultiTrack?255:0);for(const i of t.tracks)e.writeByte(255);return e.toArray()}}class md extends Fr{get name(){return"Guitar Pro 7-8"}readScore(){L.debug(this.name,"Loading ZIP entries");const t=new Vl(this.data);let e;try{e=t.read()}catch(u){throw new Mt("No Zip archive",u)}L.debug(this.name,"Zip entries loaded");let s=null,i=null,r=null,a=null;const l=new Map;for(const u of e)switch(l.set(u.fullName,u),u.fileName){case"score.gpif":s=w.toString(u.data,this.settings.importer.encoding);break;case"BinaryStylesheet":i=u.data;break;case"PartConfiguration":r=u.data;break;case"LayoutConfiguration":a=u.data;break}if(!s)throw new Mt("No score.gpif found in zip archive");L.debug(this.name,"Start Parsing score.gpif");const h=new bn;h.loadAsset=u=>{if(l.has(u))return l.get(u).data},h.parseXml(s,this.settings),L.debug(this.name,"score.gpif parsed");const c=h.score;i&&(L.debug(this.name,"Start Parsing BinaryStylesheet"),new Ls(i).apply(c),L.debug(this.name,"BinaryStylesheet parsed"));let d=null;return r&&(L.debug(this.name,"Start Parsing Part Configuration"),d=new Ul(r),d.apply(c),L.debug(this.name,"Part Configuration parsed")),a&&d!=null&&(L.debug(this.name,"Start Parsing Layout Configuration"),new zl(d,a).apply(c),L.debug(this.name,"Layout Configuration parsed")),c}}class Jo extends Xe{constructor(){super(ze.Format,"Unexpected end of data within reader")}}const La=class La{constructor(t){o(this,"_currentByte",0);o(this,"_position",La._byteSize);o(this,"_source");this._source=t}readByte(){return this.readBits(8)}readBytes(t){const e=new Uint8Array(t);for(let s=0;s<t;s++)e[s]=this.readByte()&255;return e}readBits(t){let e=0,s=t-1;for(;s>=0;)e=e|this.readBit()<<s,s--;return e}readBitsReversed(t){let e=0;for(let s=0;s<t;s++)e=e|this.readBit()<<s;return e}readBit(){if(this._position>=8){if(this._currentByte=this._source.readByte(),this._currentByte===-1)throw new Jo;this._position=0}const t=this._currentByte>>La._byteSize-this._position-1&1;return this._position++,t}readAll(){const t=wt.empty();try{for(;;)t.writeByte(this.readByte()&255)}catch(e){if(!(e instanceof Jo))throw e}return t.toArray()}};o(La,"_byteSize",8);let qo=La;class yd{constructor(){o(this,"fileName","");o(this,"fileSize",0);o(this,"data",null)}}class Qo{constructor(){o(this,"fileFilter");o(this,"files",[]);this.files=[],this.fileFilter=t=>!0}load(t){const e=new qo(t);this._readBlock(e)}readHeader(t){return this._getString(t.readBytes(4),0,4)}decompress(t,e=!1){const s=wt.empty();let i;const r=this._getInteger(t.readBytes(4),0);try{for(;s.length<r;)if(t.readBits(1)===1){const u=t.readBits(4),p=t.readBitsReversed(u),g=t.readBitsReversed(u),m=s.length-p,y=Math.min(p,g);i=s.getBuffer(),s.write(i,m,y)}else{const u=t.readBitsReversed(2);for(let p=0;p<u;p++)s.writeByte(t.readByte())}}catch(d){if(!(d instanceof Jo))throw d}i=s.getBuffer();const a=e?4:0,l=s.length-a,h=new Uint8Array(l),c=l;return h.set(i.subarray(a,a+c),0),h}_readBlock(t){const e=this.readHeader(t);if(e==="BCFZ")this._readUncompressedBlock(this.decompress(t,!0));else if(e==="BCFS")this._readUncompressedBlock(t.readAll());else throw new Mt("Unsupported format")}_readUncompressedBlock(t){let s=4096;for(;s+3<t.length;){if(this._getInteger(t,s)===2){const r=new yd;r.fileName=this._getString(t,s+4,127),r.fileSize=this._getInteger(t,s+140);const a=!this.fileFilter||this.fileFilter(r.fileName);a&&this.files.push(r);const l=s+148;let h=0,c=0;const d=a?wt.withCapacity(r.fileSize):null;for(;h=this._getInteger(t,l+4*c++),h!==0;)s=h*4096,a&&d.write(t,s,4096);if(a){r.data=new Uint8Array(Math.min(r.fileSize,d.length));const u=d.toArray();r.data.set(u.subarray(0,0+r.data.length),0)}}s+=4096}}_getString(t,e,s){let i="";for(let r=0;r<s;r++){const a=t[e+r]&255;if(a===0)break;i+=String.fromCharCode(a)}return i}_getInteger(t,e){return t[e+3]<<24|t[e+2]<<16|t[e+1]<<8|t[e]}}o(Qo,"HeaderBcFs","BCFS"),o(Qo,"HeaderBcFz","BCFZ");class bd extends Fr{get name(){return"Guitar Pro 6"}readScore(){L.debug(this.name,"Loading GPX filesystem");const t=new Qo;t.fileFilter=c=>c.endsWith("score.gpif")||c.endsWith("BinaryStylesheet")||c.endsWith("PartConfiguration")||c.endsWith("LayoutConfiguration"),t.load(this.data),L.debug(this.name,"GPX filesystem loaded");let e=null,s=null,i=null,r=null;for(const c of t.files)switch(c.fileName){case"score.gpif":e=w.toString(c.data,this.settings.importer.encoding);break;case"BinaryStylesheet":s=c.data;break;case"PartConfiguration":i=c.data;break;case"LayoutConfiguration":r=c.data;break}if(!e)throw new Mt("No score.gpif found in GPX");L.debug(this.name,"Start Parsing score.gpif");const a=new bn;a.parseXml(e,this.settings),L.debug(this.name,"score.gpif parsed");const l=a.score;s&&(L.debug(this.name,"Start Parsing BinaryStylesheet"),new Ls(s).apply(l),L.debug(this.name,"BinaryStylesheet parsed"));let h=null;return i&&(L.debug(this.name,"Start Parsing Part Configuration"),h=new Ul(i),h.apply(l),L.debug(this.name,"Part Configuration parsed")),r&&h!=null&&(L.debug(this.name,"Start Parsing Layout Configuration"),new zl(h,r).apply(l),L.debug(this.name,"Layout Configuration parsed")),l}}class Sd{constructor(){o(this,"maxSteps",-1e3);o(this,"maxStepsNote",null);o(this,"minSteps",-1e3);o(this,"minStepsNote",null)}}const Is=class Is{constructor(t){o(this,"_bar");o(this,"_barRenderer");o(this,"_registeredAccidentals",new Map);o(this,"_appliedScoreSteps",new Map);o(this,"_appliedScoreStepsByValue",new Map);o(this,"_notesByValue",new Map);o(this,"_beatSteps",new Map);o(this,"maxStepsBeat",null);o(this,"minStepsBeat",null);o(this,"maxSteps",-1e3);o(this,"minSteps",-1e3);this._barRenderer=t,this._bar=t.bar}static getPercussionSteps(t){var e;return((e=jt.getArticulation(t))==null?void 0:e.staffLine)??0}static getNoteValue(t){return t.displayValue}applyAccidental(t){const e=Is.getNoteValue(t),s=t.hasQuarterToneOffset;return this._getAccidental(e,s,t.beat,!1,t)}applyAccidentalForValue(t,e,s,i){return this._getAccidental(e,s,t,i,null)}static computeStepsWithoutAccidentals(t,e){let s=0;const i=Is.getNoteValue(e);if(e.isPercussion)s=Is.getPercussionSteps(e);else{const r=A.resolveSpelling(t.keySignature,i,e.accidentalMode);s=Is.calculateNoteSteps(t.clef,r)}return s}_getAccidental(t,e,s,i,r=null){var c;let a=0,l=he.None;if(r!=null?r.isPercussion:!1)a=Is.getPercussionSteps(r);else{const d=r?r.accidentalMode:de.Default,u=A.resolveSpelling(this._bar.keySignature,t,d);a=Is.calculateNoteSteps(this._bar.clef,u);const p=this._registeredAccidentals.has(a)?this._registeredAccidentals.get(a):null;l=A.computeAccidentalForSpelling(this._bar.keySignature,d,u,e,p);let g=!1;switch(l){case he.NaturalQuarterNoteUp:case he.SharpQuarterNoteUp:case he.FlatQuarterNoteUp:break;default:if(r&&r.isTieDestination&&r.beat.index===0){const y=(c=this._barRenderer.scoreRenderer.layout)==null?void 0:c.getRendererForBar(this._barRenderer.staff.staffId,r.tieOrigin.beat.voice.bar);y&&y.staff===this._barRenderer.staff&&y.accidentalHelper.getNoteSteps(r.tieOrigin)===a&&(g=!0)}g&&(l=he.None);break}!e&&l!==he.None&&this._registeredAccidentals.set(a,u.accidentalOffset)}return r?(this._appliedScoreSteps.set(r.id,a),this._notesByValue.set(t,r)):this._appliedScoreStepsByValue.set(t,a),(this.minSteps===-1e3||this.minSteps<a)&&(this.minSteps=a,this.minStepsBeat=s),(this.maxSteps===-1e3||this.maxSteps>a)&&(this.maxSteps=a,this.maxStepsBeat=s),i||this._registerSteps(s,a,r),l}_registerSteps(t,e,s){let i;this._beatSteps.has(t.id)?i=this._beatSteps.get(t.id):(i=new Sd,this._beatSteps.set(t.id,i)),(i.minSteps===-1e3||e<i.minSteps)&&(i.minSteps=e,i.minStepsNote=s),(i.minSteps===-1e3||e>i.maxSteps)&&(i.maxSteps=e,i.maxStepsNote=s)}getMaxSteps(t){return this._beatSteps.has(t.id)?this._beatSteps.get(t.id).maxSteps:0}getMaxStepsNote(t){return this._beatSteps.has(t.id)?this._beatSteps.get(t.id).maxStepsNote:null}getMinSteps(t){return this._beatSteps.has(t.id)?this._beatSteps.get(t.id).minSteps:0}getMinStepsNote(t){return this._beatSteps.has(t.id)?this._beatSteps.get(t.id).minStepsNote:null}static calculateNoteSteps(t,e){const s=t;let i=Is._octaveSteps[s];return i-=e.octave*Is._stepsPerOctave,i-=Is._diatonicSteps[e.degree],i}getNoteSteps(t){return this._appliedScoreSteps.get(t.id)}getNoteStepsForValue(t,e=!1){return this._appliedScoreStepsByValue.has(t)?this._appliedScoreStepsByValue.get(t):e&&this._notesByValue.has(t)?this.getNoteSteps(this._notesByValue.get(t)):0}};o(Is,"_stepsPerOctave",7),o(Is,"_octaveSteps",[38,32,30,26,38]),o(Is,"_diatonicSteps",[0,1,2,3,4,5,6]);let Er=Is;class _d{constructor(){o(this,"slurStarts");o(this,"currentDynamics",re.F);o(this,"tieStarts");o(this,"tieStartIds");o(this,"slideOrigins",new Map);o(this,"transpose",0);o(this,"isExplicitlyBeamed",!1);this.tieStarts=new Set,this.tieStartIds=new Map,this.slideOrigins=new Map,this.slurStarts=new Map}}class kd extends ${constructor(){super(...arguments);o(this,"outputMidiChannel",-1);o(this,"outputMidiProgram",-1);o(this,"outputMidiBank",-1);o(this,"outputVolume",-1);o(this,"outputBalance",-1)}}const co=class co{constructor(t){o(this,"track");o(this,"firstArticulation");o(this,"instruments",new Map);o(this,"_instrumentIdToArticulationIndex",new Map);o(this,"_lyricsLine",0);o(this,"_lyricsLines",new Map);this.track=t}getLyricLine(t){if(this._lyricsLines.has(t))return this._lyricsLines.get(t);const e=this._lyricsLine;return this._lyricsLines.set(t,e),this._lyricsLine++,e}getOrCreateArticulation(t,e){const s=e.octave*12+e.tone,i=`${t}_${s}`;if(this._instrumentIdToArticulationIndex.has(i))return this._instrumentIdToArticulationIndex.get(i);let r;this.instruments.has(t)?r=this.instruments.get(t):r=co._defaultNoteArticulation;const a=this.track.percussionArticulations.length,l=e.beat.voice.bar;let h;if(s===0)h=4;else{const m=A.resolveSpelling(l.keySignature,s,de.Default);h=Er.calculateNoteSteps(l.clef,m)}const c=e.beat.voice.bar.staff.standardNotationLineCount*2-1,u=5*2-1-c,p=h-u,g=$.create(r.id,r.elementType,p,r.outputMidiNumber,r.noteHeadDefault,r.noteHeadHalf,r.noteHeadWhole,r.techniqueSymbol,r.techniqueSymbolPlacement);return this._instrumentIdToArticulationIndex.set(i,a),this.track.percussionArticulations.push(g),a}};o(co,"_defaultNoteArticulation",$.create(0,"Default",0,0,f.NoteheadBlack,f.NoteheadHalf,f.NoteheadWhole));let Ko=co;const Qe=class Qe extends Fr{constructor(){super(...arguments);o(this,"_score");o(this,"_idToTrackInfo",new Map);o(this,"_indexToTrackInfo",new Map);o(this,"_staffToContext",new Map);o(this,"_currentBarNumberDisplayPart");o(this,"_currentBarNumberDisplayBar");o(this,"_divisionsPerQuarterNote",1);o(this,"_currentDynamics",re.F);o(this,"_musicalPosition",0);o(this,"_lastBeat",null);o(this,"_nextMasterBarRepeatEnding",0);o(this,"_nextBeatAutomations",null);o(this,"_nextBeatChord",null);o(this,"_nextBeatCrescendo",null);o(this,"_nextBeatLetRing",!1);o(this,"_nextBeatPalmMute",!1);o(this,"_nextBeatOttavia",null);o(this,"_nextBeatText",null);o(this,"_simileMarkAllStaves",null);o(this,"_simileMarkPerStaff",null);o(this,"_isBeatSlash",!1);o(this,"_keyAllStaves",null);o(this,"_currentTrillStep",-1)}get name(){return"MusicXML"}readScore(){const e=this._extractMusicXml(),s=new za;try{s.parse(e)}catch(i){throw new Mt("Unsupported format",i)}return this._score=new gi,this._score.stylesheet.hideDynamics=!0,this._parseDom(s),A.consolidate(this._score),this._score.finish(this.settings),this._score.rebuildRepeatGroups(),this._score}_extractMusicXml(){const e=new Vl(this.data);let s;try{s=e.read()}catch{s=[]}if(s.length===0)return this.data.reset(),w.toString(this.data.readAll(),this.settings.importer.encoding);const i=s.find(d=>d.fullName==="META-INF/container.xml");if(!i)throw new Mt("No compressed MusicXML");const r=new za;try{r.parse(w.toString(i.data,this.settings.importer.encoding))}catch(d){throw new Mt("Malformed container.xml, could not parse as XML",d)}const a=r.firstElement;if(!a||a.localName!=="container")throw new Mt("Malformed container.xml, root element not 'container'");const l=a.findChildElement("rootfiles");if(!l)throw new Mt("Malformed container.xml, 'container/rootfiles' not found");let h="";for(const d of l.childElements())if(d.localName==="rootfile"){h=d.getAttribute("full-path");break}if(!h)throw new Mt("Unsupported compressed MusicXML, missing rootfile");const c=s.find(d=>d.fullName===h);if(!c)throw new Mt(`Malformed container.xml, '${h}' not contained in zip`);return w.toString(c.data,this.settings.importer.encoding)}_parseDom(e){const s=e.firstElement;if(!s)throw new Mt("Unsupported format");switch(s.localName){case"score-partwise":this._parsePartwise(s);break;case"score-timewise":this._parseTimewise(s);break;default:throw new Mt("Unsupported format")}}_parsePartwise(e){for(const s of e.childElements())switch(s.localName){case"credit":this._parseCredit(s);break;case"identification":this._parseIdentification(s);break;case"movement-title":this._parseMovementTitle(s);break;case"part":this._parsePartwisePart(s);break;case"part-list":this._parsePartList(s);break;case"work":this._parseWork(s);break}}_parseTimewise(e){let s=0;for(const i of e.childElements())switch(i.localName){case"credit":this._parseCredit(i);break;case"identification":this._parseIdentification(i);break;case"movement-title":this._parseMovementTitle(i);break;case"part-list":this._parsePartList(i);break;case"work":this._parseWork(i);break;case"measure":this._parseTimewiseMeasure(i,s),s++;break}}_parseCredit(e){if(e.getAttribute("page","1")!=="1")return;const s=[];let i=null,r="";for(const a of e.childElements())switch(a.localName){case"credit-type":s.push(a.innerText);break;case"credit-words":i===null&&(i=a),r+=a.innerText;break}if(s.length>0)for(const a of s)switch(a){case"title":this._score.title=Qe._sanitizeDisplay(r);break;case"subtitle":this._score.subTitle=Qe._sanitizeDisplay(r);break;case"composer":this._score.artist=Qe._sanitizeDisplay(r);break;case"arranger":this._score.artist=Qe._sanitizeDisplay(r);break;case"lyricist":this._score.words=Qe._sanitizeDisplay(r);break;case"rights":this._score.copyright=Qe._sanitizeDisplay(r);break}else if(i){const a=i.getAttribute("font-size","0"),l=i.getAttribute("font-size","top"),h=i.getAttribute("halign","left");if(l==="top"){if(r.includes("copyright")||r.includes("Copyright")||r.includes("©")||r.includes("(c)")||r.includes("(C)")){this._score.copyright=Qe._sanitizeDisplay(r);return}if(h==="center"||a==="center"){if(this._score.title.length===0){this._score.title=Qe._sanitizeDisplay(r);return}if(this._score.subTitle.length===0){this._score.subTitle=Qe._sanitizeDisplay(r);return}if(this._score.album.length===0){this._score.album=Qe._sanitizeDisplay(r);return}}else if((h==="right"||a==="right")&&this._score.music.length===0){this._score.music=Qe._sanitizeDisplay(r);return}if(this._score.artist.length===0){this._score.artist=Qe._sanitizeDisplay(r);return}if(this._score.words.length===0){this._score.words=Qe._sanitizeDisplay(r);return}}}}static _sanitizeDisplay(e){return e.replaceAll("\r","").replaceAll(`
`," ").replaceAll("	","  ").replaceAll(" "," ")}_parseIdentification(e){for(const s of e.childElements())switch(s.localName){case"creator":if(s.attributes.has("type"))switch(s.attributes.get("type")){case"composer":this._score.artist=Qe._sanitizeDisplay(s.innerText);break;case"lyricist":this._score.words=Qe._sanitizeDisplay(s.innerText);break;case"arranger":this._score.music=Qe._sanitizeDisplay(s.innerText);break}else this._score.artist=Qe._sanitizeDisplay(s.innerText);break;case"rights":this._score.copyright.length>0&&(this._score.copyright+=", "),this._score.copyright+=s.innerText,s.attributes.has("type")&&(this._score.copyright+=` (${s.attributes.get("type")})`);break;case"encoding":this._parseEncoding(s);break}}_parseEncoding(e){for(const s of e.childElements())switch(s.localName){case"encoder":this._score.tab.length>0&&(this._score.tab+=", "),this._score.tab+=s.innerText,s.attributes.has("type")&&(this._score.tab+=` (${s.attributes.get("type")})`);break;case"encoding-description":this._score.notices+=Qe._sanitizeDisplay(s.innerText);break}}_parseMovementTitle(e){this._score.title.length===0?this._score.title=Qe._sanitizeDisplay(e.innerText):this._score.subTitle=Qe._sanitizeDisplay(e.innerText)}_parsePartList(e){for(const s of e.childElements())switch(s.localName){case"score-part":this._parseScorePart(s);break}}_parseScorePart(e){const s=new Ei;s.ensureStaveCount(1),this._score.addTrack(s);const i=e.attributes.get("id"),r=new Ko(s);this._idToTrackInfo.set(i,r),this._indexToTrackInfo.set(s.index,r);for(const a of e.childElements())switch(a.localName){case"part-name":s.name=Qe._sanitizeDisplay(a.innerText);break;case"part-name-display":s.name=this._parsePartDisplayAsText(a);break;case"part-abbreviation":s.shortName=Qe._sanitizeDisplay(a.innerText);break;case"part-abbreviation-display":s.shortName=this._parsePartDisplayAsText(a);break;case"score-instrument":this._parseScoreInstrument(a,r);break;case"midi-device":a.attributes.has("port")&&(s.playbackInfo.port=Number.parseInt(a.attributes.get("port"),10));break;case"midi-instrument":this._parseScorePartMidiInstrument(a,r);break}r.firstArticulation&&(r.firstArticulation.outputMidiProgram>=0&&(s.playbackInfo.program=r.firstArticulation.outputMidiProgram),r.firstArticulation.outputMidiBank>=0&&(s.playbackInfo.bank=r.firstArticulation.outputMidiBank),r.firstArticulation.outputBalance>=0&&(s.playbackInfo.balance=r.firstArticulation.outputBalance),r.firstArticulation.outputVolume>=0&&(s.playbackInfo.volume=r.firstArticulation.outputVolume),r.firstArticulation.outputMidiChannel>=0&&(s.playbackInfo.primaryChannel=r.firstArticulation.outputMidiChannel,s.playbackInfo.secondaryChannel=r.firstArticulation.outputMidiChannel))}_parseScoreInstrument(e,s){const i=new kd;s.firstArticulation||(s.firstArticulation=i),s.instruments.set(e.getAttribute("id",""),i)}_parseScorePartMidiInstrument(e,s){const i=e.getAttribute("id","");if(!s.instruments.has(i))return;const r=s.instruments.get(i);for(const a of e.childElements())switch(a.localName){case"midi-channel":r.outputMidiChannel=Number.parseInt(a.innerText,10)-1;break;case"midi-bank":r.outputMidiBank=Number.parseInt(a.innerText,10)-1;break;case"midi-program":r.outputMidiProgram=Number.parseInt(a.innerText,10)-1;break;case"midi-unpitched":r.outputMidiNumber=Number.parseInt(a.innerText,10)-1;break;case"volume":r.outputVolume=Qe._interpolatePercent(Number.parseFloat(a.innerText));break;case"pan":r.outputBalance=Qe._interpolatePan(Number.parseFloat(a.innerText));break}r.id=jt.tryMatchKnownArticulation(r),r.id<0&&(r.id=0)}static _interpolatePercent(e){return Qe._interpolate(0,100,0,16,e)|0}static _interpolatePan(e){return Qe._interpolate(-90,90,0,16,e)|0}static _interpolate(e,s,i,r,a){const l=(a-e)/(s-e);return i+(r-i)*l}_parsePartDisplayAsText(e){let s="";for(const i of e.childElements())switch(i.localName){case"display-text":s+=i.innerText;break;case"accidental-text":switch(i.innerText){case"sharp":s+="♯";break;case"natural":s+="♮";break;case"flat":s+="♭";break;case"double-sharp":s+="𝄪";break;case"sharp-sharp":s+="♯♯";break;case"flat-flat":s+="𝄫";break;case"natural-sharp":s+="♮♯";break;case"natural-flat":s+="♮♭";break;case"sharp-down":s+="𝄱";break;case"sharp-up":s+="𝄰";break;case"natural-down":s+="𝄯";break;case"natural-up":s+="𝄮";break;case"flat-down":s+="𝄭";break;case"flat-up":s+="𝄬";break;case"arrow-down":s+="↓";break;case"arrow-up":s+="↑";break;case"triple-sharp":s+="♯𝄪";break;case"triple-flat":s+="𝄬𝄬𝄬";break;case"sharp-1":s+="♯¹";break;case"sharp-2":s+="♯²";break;case"sharp-3":s+="♯³";break;case"sharp-4":s+="♯⁴";break;case"sharp-5":s+="♯⁵";break;case"flat-1":s+="♭¹";break;case"flat-2":s+="♭²";break;case"flat-3":s+="♭³";break;case"flat-4":s+="♭⁴";break;case"flat-5":s+="♭⁵";break}break}return Qe._sanitizeDisplay(s)}_parseWork(e){for(const s of e.childElements())switch(s.localName){case"work-title":this._score.title=Qe._sanitizeDisplay(s.innerText);break}}_parsePartwisePart(e){const s=e.attributes.get("id");if(!s||!this._idToTrackInfo.has(s))return;const i=this._idToTrackInfo.get(s).track;let r=0;for(const a of e.childElements())switch(a.localName){case"measure":this._parsePartwiseMeasure(a,i,r),r++;break}this._currentBarNumberDisplayPart=void 0}_parsePartwiseMeasure(e,s,i){const r=this._getOrCreateMasterBar(e,i),a=e.attributes.get("implicit")==="yes";this._parsePartMeasure(e,r,s,a,!0),this._currentBarNumberDisplayBar=void 0}_parseTimewiseMeasure(e,s){const i=this._getOrCreateMasterBar(e,s),r=e.attributes.get("implicit")==="yes";for(const a of e.childElements())switch(a.localName){case"part":this._parseTimewisePart(a,i,r),this._currentBarNumberDisplayPart=void 0;break;case"print":this._parsePrint(a,i,void 0,!0);break}this._currentBarNumberDisplayBar=void 0}_getOrCreateMasterBar(e,s){const i=e.attributes.get("implicit")==="yes";for(;this._score.masterBars.length<=s;){const a=new ii;i&&(a.isAnacrusis=!0),this._score.addMasterBar(a),a.index>0&&(a.timeSignatureDenominator=a.previousMasterBar.timeSignatureDenominator,a.timeSignatureNumerator=a.previousMasterBar.timeSignatureNumerator,a.tripletFeel=a.previousMasterBar.tripletFeel)}return this._score.masterBars[s]}_parseTimewisePart(e,s,i){const r=e.attributes.get("id");if(!r||!this._idToTrackInfo.has(r))return;const a=this._idToTrackInfo.get(r).track;this._parsePartMeasure(e,s,a,i,!1)}_parsePartMeasure(e,s,i,r,a){this._musicalPosition=0,this._lastBeat=null,s.alternateEndings=this._nextMasterBarRepeatEnding;const l=[];for(const d of e.childElements())switch(d.localName){case"note":this._parseNote(d,s,i);break;case"backup":this._parseBackup(d);break;case"forward":this._parseForward(d);break;case"direction":this._parseDirection(d,s,i);break;case"attributes":this._parseAttributes(d,s,i);break;case"harmony":this._parseHarmony(d,i);break;case"print":this._parsePrint(d,s,i,!0);break;case"sound":this._parseSound(d,s,i);break;case"barline":l.push(d);break}for(const d of l)this._parseBarLine(d,s,i);this._applySimileMarks(s,i);const h=this._getOrCreateStaff(i,0),c=this._getOrCreateBar(h,s);r?c.barNumberDisplay=Vt.Hide:a?c.barNumberDisplay=this._currentBarNumberDisplayBar??this._currentBarNumberDisplayPart:c.barNumberDisplay=this._currentBarNumberDisplayPart??this._currentBarNumberDisplayBar,this._keyAllStaves=null}_parsePrint(e,s,i,r){i!==void 0&&(e.getAttribute("new-system","no")==="yes"||e.getAttribute("new-page","no")==="yes")&&i.addLineBreaks(s.index);let a;for(const l of e.childElements())switch(l.localName){case"measure-numbering":switch(l.innerText){case"none":a=Vt.Hide;break;case"measure":a=Vt.AllBars;break;case"system":a=Vt.FirstOfSystem;break}break}r?this._currentBarNumberDisplayBar=a:this._currentBarNumberDisplayPart=a}_applySimileMarks(e,s){if(this._simileMarkAllStaves!==null){for(const i of s.staves){const r=this._getOrCreateBar(i,e);r.simileMark=this._simileMarkAllStaves,r.simileMark!==At.None&&this._clearBar(r)}this._simileMarkAllStaves===At.FirstOfDouble?this._simileMarkAllStaves=At.SecondOfDouble:this._simileMarkAllStaves=null}if(this._simileMarkPerStaff!==null){const i=Array.from(this._simileMarkPerStaff.keys());for(const r of i){const a=this._getOrCreateStaff(s,r),l=this._getOrCreateBar(a,e);l.simileMark=this._simileMarkPerStaff.get(r),l.simileMark!==At.None&&this._clearBar(l),l.simileMark===At.FirstOfDouble?this._simileMarkPerStaff.set(r,At.SecondOfDouble):this._simileMarkPerStaff.delete(r)}this._simileMarkPerStaff.size===0&&(this._simileMarkPerStaff=null)}}_clearBar(e){for(const s of e.voices){const i=new qt;i.isEmpty=!0,s.addBeat(i)}}_parseBarLine(e,s,i){for(const r of e.childElements())switch(r.localName){case"bar-style":this._parseBarStyle(r,s,i,e.getAttribute("location","right"));break;case"ending":this._parseEnding(r,s);break;case"repeat":this._parseRepeat(r,s);break}}_parseRepeat(e,s){const i=e.getAttribute("direction");let r=Number.parseInt(e.getAttribute("times"),10);(r<0||Number.isNaN(r))&&(r=2),i==="backward"?s.repeatCount=r:i==="forward"&&(s.isRepeatStart=!0)}_parseEnding(e,s){const i=e.getAttribute("number").split(",").map(a=>Number.parseInt(a,10));let r=0;for(const a of i)r=r|1<<a-1&255;switch(s.alternateEndings=r,e.getAttribute("type","")){case"start":this._nextMasterBarRepeatEnding=this._nextMasterBarRepeatEnding|r;break;case"stop":case"discontinue":this._nextMasterBarRepeatEnding=this._nextMasterBarRepeatEnding&~r;break}}_parseBarStyle(e,s,i,r){let a=Be.Automatic;switch(e.innerText){case"dashed":a=Be.Dashed;break;case"dotted":a=Be.Dotted;break;case"heavy":a=Be.Heavy;break;case"heavy-heavy":a=Be.HeavyHeavy;break;case"heavy-light":a=Be.HeavyLight;break;case"light-heavy":a=Be.LightHeavy;break;case"light-light":a=Be.LightLight;break;case"none":a=Be.None;break;case"regular":a=Be.Regular;break;case"short":a=Be.Short;break;case"tick":a=Be.Tick;break}for(const l of i.staves){const h=this._getOrCreateBar(l,s);switch(r){case"left":h.barLineLeft=a;break;case"right":h.barLineRight=a;break}}}_parseSound(e,s,i){for(const r of e.childElements())switch(r.localName){case"midi-instrument":this._parseSoundMidiInstrument(r,s);break;case"swing":this._parseSwing(r,s);break}if(e.attributes.has("coda")&&s.addDirection(G.TargetCoda),e.attributes.has("tocoda")&&s.addDirection(G.JumpDaCoda),e.attributes.has("dacapo")&&s.addDirection(G.JumpDaCapo),e.attributes.has("dalsegno")&&s.addDirection(G.JumpDalSegno),e.attributes.has("fine")&&s.addDirection(G.TargetFine),e.attributes.has("segno")&&s.addDirection(G.TargetSegno),e.attributes.has("pan")){this._nextBeatAutomations||(this._nextBeatAutomations=[]);const r=new nt;r.type=Ve.Balance,r.value=Qe._interpolatePan(Number.parseFloat(e.attributes.get("pan"))),this._nextBeatAutomations.push(r)}if(e.attributes.has("tempo")){this._nextBeatAutomations||(this._nextBeatAutomations=[]);const r=new nt;r.type=Ve.Tempo,r.value=Qe._interpolatePercent(Number.parseFloat(e.attributes.get("tempo"))),this._nextBeatAutomations.push(r)}}_parseSwing(e,s){let i=0,r=0,a=null;for(const l of e.childElements())switch(l.localName){case"straight":s.tripletFeel=Me.NoTripletFeel;return;case"first":i=Number.parseInt(l.innerText,10);break;case"second":r=Number.parseInt(l.innerText,10);break;case"swing-type":a=this._parseBeatDuration(l);break}a||(a=b.Eighth),a===b.Eighth?i===2&&r===1?s.tripletFeel=Me.Triplet8th:i===3&&r===1?s.tripletFeel=Me.Dotted8th:i===1&&r===3&&(s.tripletFeel=Me.Scottish8th):a===b.Sixteenth&&(i===2&&r===1?s.tripletFeel=Me.Triplet16th:i===3&&r===1?s.tripletFeel=Me.Dotted16th:i===1&&r===3&&(s.tripletFeel=Me.Scottish16th))}_parseSoundMidiInstrument(e,s){let i;for(const r of e.childElements())switch(r.localName){case"midi-bank":this._nextBeatAutomations||(this._nextBeatAutomations=[]),i=new nt,i.type=Ve.Bank,i.value=Number.parseInt(r.innerText,10)-1,this._nextBeatAutomations.push(i);break;case"midi-program":this._nextBeatAutomations||(this._nextBeatAutomations=[]),i=new nt,i.type=Ve.Instrument,i.value=Number.parseInt(r.innerText,10)-1,this._nextBeatAutomations.push(i);break;case"volume":this._nextBeatAutomations||(this._nextBeatAutomations=[]),i=new nt,i.type=Ve.Volume,i.value=Qe._interpolatePercent(Number.parseFloat(r.innerText)),this._nextBeatAutomations.push(i);break;case"pan":this._nextBeatAutomations||(this._nextBeatAutomations=[]),i=new nt,i.type=Ve.Balance,i.value=Qe._interpolatePan(Number.parseFloat(r.innerText)),this._nextBeatAutomations.push(i);break}}_parseHarmony(e,s){const i=new Yi;let r=!1,a="";for(const l of e.childElements())switch(l.localName){case"root":i.name=this._parseHarmonyRoot(l);break;case"kind":i.name=i.name+this._parseHarmonyKind(l),l.getAttribute("parentheses-degrees","no")==="yes"&&(r=!0);break;case"frame":this._parseHarmonyFrame(l,i);break;case"degree":a+=this._parseDegree(l);break}a&&(i.name+=r?`(${a})`:a),e.getAttribute("print-frame","no")==="yes"&&(i.showDiagram=!0,this._score.stylesheet.globalDisplayChordDiagramsInScore=!0),e.getAttribute("print-object","yes")==="yes"&&(i.showDiagram=!0),this._nextBeatChord===null&&(this._nextBeatChord=i)}_parseDegree(e){let s="",i="",r="";for(const a of e.childElements())switch(a.localName){case"degree-value":s=a.innerText;break;case"degree-alter":switch(a.innerText){case"-1":i="♭";break;case"1":i="♯";break}break;case"degree-type":r+=a.getAttribute("text","");break}return`${r}${i}${s}`}_parseHarmonyRoot(e){let s="",i="";for(const r of e.childElements())switch(r.localName){case"root-step":s=r.innerText;break;case"root-alter":switch(Number.parseFloat(r.innerText)){case-2:i="bb";break;case-1:i="b";break;case 0:i="";break;case 1:i="#";break;case 2:i="##";break}break}return s+i}_parseHarmonyKind(e){const s=e.getAttribute("text");let i="";if(s)i=s;else{const r=e.innerText;switch(r){case"major":i="";break;case"minor":i="m";break;case"augmented":i="+";break;case"diminished":i="○";break;case"dominant":i="7";break;case"major-seventh":i="7M";break;case"minor-seventh":i="m7";break;case"diminished-seventh":i="○7";break;case"augmented-seventh":i="+7";break;case"half-diminished":i="⍉";break;case"major-minor":i="mMaj";break;case"major-sixth":i="maj6";break;case"minor-sixth":i="m6";break;case"dominant-ninth":i="9";break;case"major-ninth":i="maj9";break;case"minor-ninth":i="m9";break;case"dominant-11th":i="11";break;case"major-11th":i="maj11";break;case"minor-11th":i="m11";break;case"dominant-13th":i="13";break;case"major-13th":i="maj13";break;case"minor-13th":i="m13";break;case"suspended-second":i="sus2";break;case"suspended-fourth":i="sus4";break;case"Neapolitan":i="♭II";break;case"Italian":i="It⁺⁶";break;case"French":i="Fr⁺⁶";break;case"German":i="Fr⁺⁶";break;default:i=r;break}}return i}_parseHarmonyFrame(e,s){for(const i of e.childElements())switch(i.localName){case"frame-strings":const r=Number.parseInt(i.innerText,10);s.strings=new Array(r);for(let h=0;h<r;h++)s.strings[h]=-1;break;case"first-fret":s.firstFret=Number.parseInt(i.innerText,10);break;case"frame-note":let a=null,l=null;for(const h of i.childElements())switch(h.localName){case"string":a=Number.parseInt(h.innerText,10);break;case"fret":l=Number.parseInt(h.innerText,10),a&&l>=0&&(s.strings[a-1]=l);break;case"barre":a&&l&&h.getAttribute("type")==="start"&&s.barreFrets.push(l);break}break}}_parseAttributes(e,s,i){let r,a,l;if(this._lastBeat==null)for(const h of e.childElements())switch(h.localName){case"divisions":this._divisionsPerQuarterNote=Number.parseFloat(h.innerText);break;case"key":this._parseKey(h,s,i);break;case"time":this._parseTime(h,s);break;case"staves":i.ensureStaveCount(Number.parseInt(h.innerText,10));break;case"clef":r=Number.parseInt(h.getAttribute("number","1"),10)-1,a=this._getOrCreateStaff(i,r),l=this._getOrCreateBar(a,s),this._parseClef(h,l);break;case"staff-details":r=Number.parseInt(h.getAttribute("number","1"),10)-1,a=this._getOrCreateStaff(i,r),this._parseStaffDetails(h,a);break;case"transpose":this._parseTranspose(h,i);break;case"measure-style":this._parseMeasureStyle(h,i,!1);break}else for(const h of e.childElements())switch(h.localName){case"divisions":this._divisionsPerQuarterNote=Number.parseFloat(h.innerText);break;case"measure-style":this._parseMeasureStyle(h,i,!0);break}}_parseMeasureStyle(e,s,i){for(const r of e.childElements())switch(r.localName){case"measure-repeat":if(!i){let a=null;switch(r.getAttribute("type")){case"start":switch(Number.parseInt(r.getAttribute("slashes","1"),10)){case 1:a=At.Simple;break;case 2:a=At.FirstOfDouble;break}break;case"stop":a=null;break}if(e.attributes.has("number")){this._simileMarkPerStaff=this._simileMarkPerStaff??new Map;const l=Number.parseInt(e.attributes.get("number"),10)-1;a==null?this._simileMarkPerStaff.delete(l):this._simileMarkPerStaff.set(l,a)}else this._simileMarkAllStaves=a}break;case"slash":switch(r.getAttribute("type")){case"start":this._isBeatSlash=!0;break;case"stop":this._isBeatSlash=!1;break}break}}_parseTranspose(e,s){let i=0;for(const r of e.childElements())switch(r.localName){case"chromatic":i+=Number.parseFloat(r.innerText);break;case"octave-change":i+=Number.parseFloat(r.innerText)*12;break}if(e.attributes.has("number")){const r=this._getOrCreateStaff(s,Number.parseInt(e.attributes.get("number"),10)-1);this._getStaffContext(r).transpose=i,r.displayTranspositionPitch=i}else for(const r of s.staves)this._getStaffContext(r).transpose=i,r.displayTranspositionPitch=i}_parseStaffDetails(e,s){for(const i of e.childElements())switch(i.localName){case"staff-lines":s.standardNotationLineCount=Number.parseInt(i.innerText,10);break;case"staff-tuning":this._parseStaffTuning(i,s);break;case"capo":s.capo=Number.parseInt(i.innerText,10);break}}_parseStaffTuning(e,s){s.stringTuning.tunings.length===0&&(s.showTablature=!0,s.showStandardNotation=!1,s.stringTuning.tunings=new Array(s.standardNotationLineCount).fill(0));const i=Number.parseInt(e.getAttribute("line"),10);let r="C",a="",l=0;for(const c of e.childElements())switch(c.localName){case"tuning-step":r=c.innerText;break;case"tuning-alter":l=Number.parseFloat(c.innerText);break;case"tuning-octave":a=c.innerText;break}const h=A.getTuningForText(r+a)+l;s.tuning[s.tuning.length-i]=h}_parseClef(e,s){let i="s",r=0;for(const a of e.childElements())switch(a.localName){case"sign":i=a.innerText.toLowerCase();break;case"line":r=Number.parseInt(a.innerText,10);break;case"clef-octave-change":switch(Number.parseInt(a.innerText,10)){case-2:s.clefOttava=pe._15mb;break;case-1:s.clefOttava=pe._8vb;break;case 1:s.clefOttava=pe._8va;break;case 2:s.clefOttava=pe._15mb;break}break}switch(i){case"g":s.clef=Fe.G2;break;case"f":s.clef=Fe.F4;break;case"c":r===3?s.clef=Fe.C3:s.clef=Fe.C4;break;case"percussion":s.clef=Fe.Neutral,s.staff.isPercussion=!0;break;case"tab":s.clef=Fe.G2,s.staff.showTablature=!0;break;default:s.clef=Fe.G2;break}}_parseTime(e,s){let i=!1,r=!1;for(const a of e.childElements()){const l=a.innerText;switch(a.localName){case"beats":i||(l.indexOf("+")===-1?s.timeSignatureNumerator=Number.parseInt(l,10):s.timeSignatureNumerator=l.split("+").map(h=>Number.parseInt(h,10)).reduce((h,c)=>c+h,0),i=!0);break;case"beat-type":r||(l.indexOf("+")===-1?s.timeSignatureDenominator=Number.parseInt(l,10):s.timeSignatureDenominator=l.split("+").map(h=>Number.parseInt(h,10)).reduce((h,c)=>c+h,0),r=!0);break}}switch(e.getAttribute("symbol","")){case"common":case"cut":s.timeSignatureCommon=!0;break}}_parseKey(e,s,i){let r=-Ke.C,a="";for(const c of e.childElements())switch(c.localName){case"fifths":r=Number.parseInt(c.innerText,10);break;case"mode":a=c.innerText;break}let l;-7<=r&&r<=7?l=r:l=Ke.C;let h;if(a==="minor"?h=cs.Minor:h=cs.Major,e.attributes.has("number")){const c=this._getOrCreateStaff(i,Number.parseInt(e.attributes.get("number"),10)-1),d=this._getOrCreateBar(c,s);d.keySignature=l,d.keySignatureType=h}else{this._keyAllStaves=[l,h];for(const c of i.staves)c.bars.length>s.index&&(c.bars[s.index].keySignature=l,c.bars[s.index].keySignatureType=h)}}_parseDirection(e,s,i){const r=[];let a=null,l=-1,h=-1;for(const g of e.childElements())switch(g.localName){case"direction-type":const m=g.firstElement;m&&r.push(m);break;case"offset":a=Number.parseFloat(g.innerText);break;case"voice":break;case"staff":l=Number.parseInt(g.innerText,10)-1;break;case"sound":g.attributes.has("tempo")&&(h=Number.parseFloat(g.attributes.get("tempo")));break}let c=null;l>=0?c=this._getOrCreateStaff(i,l):this._lastBeat!==null?c=this._lastBeat.voice.bar.staff:c=this._getOrCreateStaff(i,0);const d=c?this._getOrCreateBar(c,s):null,u=()=>{let g=this._musicalPosition;a!==null&&(g+=a);const m=s.calculateDuration(!1);return g/m};if(h>0){const g=new nt;g.type=Ve.Tempo,g.value=h,g.ratioPosition=u(),this._hasSameTempo(s,g)||s.tempoAutomations.push(g)}let p="";for(const g of r)switch(g.localName){case"rehearsal":s.section=new aa,s.section.marker=g.innerText;break;case"segno":s.addDirection(G.TargetSegno);break;case"coda":s.addDirection(G.TargetCoda);break;case"words":p=g.innerText;break;case"wedge":switch(g.getAttribute("type")){case"crescendo":this._nextBeatCrescendo=Jt.Crescendo;break;case"diminuendo":this._nextBeatCrescendo=Jt.Decrescendo;break;case"stop":this._nextBeatCrescendo=null;break}break;case"dynamics":const m=this._parseDynamics(g);m!==null&&(this._currentDynamics=m,this._score.stylesheet.hideDynamics=!1);break;case"dashes":const y=g.getAttribute("type","start");switch(p){case"LetRing":this._nextBeatLetRing=y==="start"||y==="continue";break;case"P.M.":this._nextBeatPalmMute=y==="start"||y==="continue";break}p="";break;case"pedal":const S=this._parsePedal(g);if(S&&d){S.ratioPosition=u();const k=d.sustainPedals.length>0&&d.sustainPedals[d.sustainPedals.length-1].pedalType!==lt.Up;(S.pedalType!==lt.Up||k)&&d.sustainPedals.push(S)}break;case"metronome":this._parseMetronome(g,s,u());break;case"octave-shift":this._nextBeatOttavia=this._parseOctaveShift(g);break}p&&(this._nextBeatText=p)}_parseOctaveShift(e){const s=e.getAttribute("type");switch(Number.parseInt(e.getAttribute("size","8"),10)){case 15:switch(s){case"up":return pe._15mb;case"down":return pe._15ma;case"stop":return pe.Regular;case"continue":return this._nextBeatOttavia}break;case 8:switch(s){case"up":return pe._8vb;case"down":return pe._8va;case"stop":return pe.Regular;case"continue":return this._nextBeatOttavia}break}return null}_parseMetronome(e,s,i){let r=null,a=-1;for(const l of e.childElements())switch(l.localName){case"beat-unit":r=this._parseBeatDuration(l);break;case"per-minute":a=Number.parseFloat(l.innerText);break}if(r!==null&&a>0){const l=new nt;l.type=Ve.Tempo,l.value=a*(r/4),l.ratioPosition=i,this._hasSameTempo(s,l)||s.tempoAutomations.push(l)}}_hasSameTempo(e,s){for(const i of e.tempoAutomations)if(s.ratioPosition===i.ratioPosition&&s.value===i.value)return!0;return!1}_parsePedal(e){const s=new Vi;switch(e.getAttribute("type")){case"start":s.pedalType=lt.Down;break;case"stop":s.pedalType=lt.Up;break;case"continue":s.pedalType=lt.Hold;break;default:return null}return s}_parseDynamics(e){for(const s of e.childElements()){const i=s.localName.toUpperCase();switch(i){case"PPP":case"PP":case"P":case"MP":case"MF":case"F":case"FF":case"FFF":case"PPPP":case"PPPPP":case"PPPPPP":case"FFFF":case"FFFFF":case"FFFFFF":case"SF":case"SFP":case"SFPP":case"FP":case"RF":case"RFZ":case"SFZ":case"SFFZ":case"FZ":case"N":case"PF":case"SFZP":return re[i]}}return null}_parseForward(e){for(const s of e.childElements())switch(s.localName){case"duration":this._musicalPosition+=this._musicXmlDivisionsToAlphaTabTicks(Number.parseFloat(s.innerText));break}}_parseBackup(e){for(const s of e.childElements())switch(s.localName){case"duration":if(this._lastBeat){let r=this._musicalPosition;r-=this._musicXmlDivisionsToAlphaTabTicks(Number.parseFloat(s.innerText)),r<0&&(r=0),this._musicalPosition=r}break}}_getOrCreateStaff(e,s){for(;e.staves.length<=s;){const i=new cr;e.addStaff(i),this._score.masterBars.length>0&&this._getOrCreateBar(i,this._score.masterBars[this._score.masterBars.length-1])}return e.staves[s]}_getOrCreateBar(e,s){const i=e.bars.length===0?1:e.bars[0].voices.length;for(;e.bars.length<=s.index;){const r=new qs;e.addBar(r),r.previousBar&&(r.clef=r.previousBar.clef,r.clefOttava=r.previousBar.clefOttava,r.keySignature=r.previousBar.keySignature,r.keySignatureType=r.previousBar.keySignatureType),this._keyAllStaves!=null&&(r.keySignature=this._keyAllStaves[0],r.keySignatureType=this._keyAllStaves[1]);for(let a=0;a<i;a++){const l=new Fs;r.addVoice(l)}}return e.bars[s.index]}_getOrCreateVoice(e,s){let i=!1;for(;e.voices.length<=s;)e.addVoice(new Fs),i=!0;if(i)for(const r of e.staff.bars)for(;r.voices.length<=s;)r.addVoice(new Fs);return e.voices[s]}_parseNote(e,s,i){let r=null,a=ee.None,l=0,h=null,c=!1,d=0,u=0,p=-1,g=null,m=0,y=-1,S=-1,k=null,T=null,N=!1,F=null;const q=e.getAttribute("print-object","yes")!=="no",U=()=>{if(r!==null)return;c&&!this._lastBeat&&(L.warning("MusicXML","Malformed MusicXML, <chord /> cannot be set on the first note of a measure"),c=!1),c&&!T&&(L.warning("MusicXML","Cannot mix <chord /> and <rest />"),c=!1);const x=this._getOrCreateStaff(i,d);if(c){r=this._lastBeat,r.addNote(T);return}const j=this._getOrCreateBar(x,s),Q=this._getOrCreateVoice(j,u),Te=Q.beats.length===0?0:Q.beats[Q.beats.length-1].displayEnd;let te=this._musicalPosition-Te;if(te>0){if(this._lastBeat&&this._lastBeat.beamingMode===ot.ForceMergeWithNext&&this._lastBeat.voice.bar.staff.index!==d&&Q.beats.length>0&&Q.beats[Q.beats.length-1].beamingMode===ot.ForceMergeWithNext){const _t=Q.beats[Q.beats.length-1].duration;for(;te>0;){const Gs=this._createRestForGap(te,_t);if(Gs!==null)this._insertBeatToVoice(Gs,Q),te-=Gs.playbackDuration;else break}}if(te>0){const _t=new qt;_t.dynamics=this._currentDynamics,_t.isEmpty=!0,_t.duration=b.TwoHundredFiftySixth,_t.overrideDisplayDuration=te,_t.updateDurations(),this._insertBeatToVoice(_t,Q)}}else te<0&&L.error("MusicXML","Unsupported forward/backup detected. Cannot fill new beats into already filled area of voice");p<0&&g!==null&&(p=D.toTicks(g),m>0&&(p=D.applyDot(p,m===2)));const we=new qt;r=we,h===null?we.beamingMode=this._getStaffContext(x).isExplicitlyBeamed?ot.ForceSplitToNext:ot.Auto:(we.beamingMode=h,this._getStaffContext(x).isExplicitlyBeamed=!0),we.isEmpty=!1,we.dynamics=this._currentDynamics,this._isBeatSlash&&(we.slashed=!0);const $e=this._nextBeatAutomations;if(this._nextBeatAutomations=null,$e!==null)for(const _t of $e)we.automations.push(_t);const ce=this._nextBeatChord;this._nextBeatChord=null,ce!==null&&(we.chordId=ce.uniqueId,Q.bar.staff.hasChord(ce.uniqueId)||Q.bar.staff.addChord(we.chordId,ce));const rt=this._nextBeatCrescendo;rt!==null&&(we.crescendo=rt);const Es=this._nextBeatOttavia;if(Es!==null&&(we.ottava=Es),we.isLetRing=this._nextBeatLetRing,we.isPalmMute=this._nextBeatPalmMute,this._nextBeatText&&(we.text=this._nextBeatText,this._nextBeatText=null),T!==null&&we.addNote(T),this._insertBeatToVoice(we,Q),T!==null){T.isVisible=q;const _t=this._indexToTrackInfo.get(i.index);F!==null?T.percussionArticulation=_t.getOrCreateArticulation(F,T):N||(T.percussionArticulation=_t.getOrCreateArticulation("",T))}a!==ee.None?(we.graceType=a,this._applyBeatDurationFromTicks(we,l,null,!1)):(we.tupletNumerator=y,we.tupletDenominator=S,we.dots=m,we.preferredBeamDirection=k,this._applyBeatDurationFromTicks(we,p,g,!0)),this._musicalPosition=we.displayEnd,this._lastBeat=we};for(const x of e.childElements())switch(x.localName){case"grace":const j=Number.parseFloat(x.getAttribute("make-time","-1"));j>=0?(l=this._musicXmlDivisionsToAlphaTabTicks(j),a=ee.BeforeBeat):a=ee.OnBeat,x.getAttribute("slash")==="yes"&&(a=ee.BeforeBeat);break;case"chord":c=!0;break;case"cue":return;case"pitch":T=this._parsePitch(x),N=!0;break;case"unpitched":T=this._parseUnpitched(x,i);break;case"rest":T=null,g===null&&(g=b.Whole);break;case"duration":p=this._parseDuration(x);break;case"instrument":F=x.getAttribute("id","");break;case"voice":u=Number.parseInt(x.innerText,10),Number.isNaN(u)?(L.warning("MusicXML","Voices need to be specified as numbers"),u=0):u=u-1;break;case"type":g=this._parseBeatDuration(x);break;case"dot":m++;break;case"accidental":T===null?L.warning("MusicXML","Malformed MusicXML, missing pitch or unpitched for note"):this._parseAccidental(x,T);break;case"time-modification":for(const Q of x.childElements())switch(Q.localName){case"actual-notes":y=Number.parseInt(Q.innerText,10);break;case"normal-notes":S=Number.parseInt(Q.innerText,10);break}break;case"stem":k=this._parseStem(x);break;case"notehead":T===null?L.warning("MusicXML","Malformed MusicXML, missing pitch or unpitched for note"):this._parseNoteHead(x,T,g??b.Quarter,k??this._estimateBeamDirection(T));break;case"staff":d=Number.parseInt(x.innerText,10)-1;break;case"beam":if(x.getAttribute("number","1")==="1")switch(x.innerText){case"begin":h=ot.ForceMergeWithNext;break;case"continue":h=ot.ForceMergeWithNext;break;case"end":h=ot.ForceSplitToNext;break}break;case"notations":U(),this._parseNotations(x,T,r);break;case"lyric":U(),this._parseLyric(x,r,i);break;case"play":this._parsePlay(x,T);break}if(N){const x=this._getOrCreateStaff(i,d),j=this._getStaffContext(x).transpose;if(j!==0){const Q=T.octave*12+T.tone+j;T.octave=Q/12|0,T.tone=Q-T.octave*12}}U()}_parsePlay(e,s){for(const i of e.childElements())switch(i.localName){case"mute":s&&i.innerText==="palm"&&(s.isPalmMute=!0);break}}_estimateBeamDirection(e){return e.calculateRealValue(!1,!1)<Qe._b4Value?E.Down:E.Up}_parseNoteHead(e,s,i,r){e.getAttribute("parentheses","no")==="yes"&&(s.isGhost=!0);const a=e.getAttribute("filled","");let l;switch(a==="yes"?l=!0:a==="no"&&(l=!1),s.style=new Il,e.innerText){case"arrow down":s.style.noteHeadCenterOnStem=!0,this._applyNoteHead(s,i,l,f.NoteheadTriangleDownDoubleWhole,f.NoteheadTriangleDownWhole,f.NoteheadTriangleDownHalf,f.NoteheadTriangleDownBlack);break;case"arrow up":s.style.noteHeadCenterOnStem=!0,this._applyNoteHead(s,i,l,f.NoteheadTriangleUpDoubleWhole,f.NoteheadTriangleUpWhole,f.NoteheadTriangleUpHalf,f.NoteheadTriangleUpBlack);break;case"back slashed":this._applyNoteHead(s,i,l,f.NoteheadSlashedDoubleWhole2,f.NoteheadSlashedWhole2,f.NoteheadSlashedHalf2,f.NoteheadSlashedBlack2);break;case"circle dot":s.style.noteHead=f.NoteheadRoundWhiteWithDot;break;case"circle-x":this._applyNoteHead(s,i,l,f.NoteheadCircleXDoubleWhole,f.NoteheadCircleXWhole,f.NoteheadCircleXHalf,f.NoteheadCircleX);break;case"circled":this._applyNoteHead(s,i,l,f.NoteheadCircledDoubleWhole,f.NoteheadCircledWhole,f.NoteheadCircledHalf,f.NoteheadCircledBlack);break;case"cluster":this._applyNoteHead(s,i,l,f.NoteheadClusterDoubleWhole3rd,f.NoteheadClusterWhole3rd,f.NoteheadClusterHalf3rd,f.NoteheadClusterQuarter3rd);break;case"cross":this._applyNoteHead(s,i,l,f.NoteheadPlusDoubleWhole,f.NoteheadPlusWhole,f.NoteheadPlusHalf,f.NoteheadPlusBlack);break;case"diamond":this._applyNoteHead(s,i,l,f.NoteheadDiamondDoubleWhole,f.NoteheadDiamondWhole,f.NoteheadDiamondHalf,f.NoteheadDiamondBlack);break;case"do":this._applyNoteHead(s,i,l,f.NoteShapeTriangleUpWhite,f.NoteShapeTriangleUpWhite,f.NoteShapeTriangleUpWhite,f.NoteShapeTriangleUpBlack);break;case"fa":r===E.Up?this._applyNoteHead(s,i,l,f.NoteShapeTriangleRightWhite,f.NoteShapeTriangleRightWhite,f.NoteShapeTriangleRightWhite,f.NoteShapeTriangleRightBlack):this._applyNoteHead(s,i,l,f.NoteShapeTriangleLeftWhite,f.NoteShapeTriangleLeftWhite,f.NoteShapeTriangleLeftWhite,f.NoteShapeTriangleLeftBlack);break;case"fa up":this._applyNoteHead(s,i,l,f.NoteShapeTriangleLeftWhite,f.NoteShapeTriangleLeftWhite,f.NoteShapeTriangleLeftWhite,f.NoteShapeTriangleLeftBlack);break;case"inverted triangle":this._applyNoteHead(s,i,l,f.NoteheadTriangleDownDoubleWhole,f.NoteheadTriangleDownWhole,f.NoteheadTriangleDownHalf,f.NoteheadTriangleDownBlack);break;case"la":this._applyNoteHead(s,i,l,f.NoteShapeSquareWhite,f.NoteShapeSquareWhite,f.NoteShapeSquareWhite,f.NoteShapeSquareBlack);break;case"left triangle":this._applyNoteHead(s,i,l,f.NoteheadTriangleRightWhite,f.NoteheadTriangleRightWhite,f.NoteheadTriangleRightWhite,f.NoteheadTriangleRightBlack);break;case"mi":this._applyNoteHead(s,i,l,f.NoteShapeDiamondWhite,f.NoteShapeDiamondWhite,f.NoteShapeDiamondWhite,f.NoteShapeDiamondBlack);break;case"none":s.style.noteHead=f.NoteheadNull;break;case"normal":this._applyNoteHead(s,i,l,f.NoteheadDoubleWhole,f.NoteheadWhole,f.NoteheadHalf,f.NoteheadBlack);break;case"re":this._applyNoteHead(s,i,l,f.NoteShapeMoonWhite,f.NoteShapeMoonWhite,f.NoteShapeMoonWhite,f.NoteShapeMoonBlack);break;case"rectangle":this._applyNoteHead(s,i,l,f.NoteheadSquareWhite,f.NoteheadSquareWhite,f.NoteheadSquareWhite,f.NoteheadSquareBlack);break;case"slash":this._applyNoteHead(s,i,l,f.NoteheadSlashWhiteWhole,f.NoteheadSlashWhiteWhole,f.NoteheadSlashWhiteHalf,f.NoteheadSlashHorizontalEnds);break;case"slashed":this._applyNoteHead(s,i,l,f.NoteheadSlashedDoubleWhole1,f.NoteheadSlashedWhole1,f.NoteheadSlashedHalf1,f.NoteheadSlashedBlack1);break;case"so":this._applyNoteHead(s,i,l,f.NoteShapeRoundWhite,f.NoteShapeRoundWhite,f.NoteShapeRoundWhite,f.NoteShapeRoundBlack);break;case"square":this._applyNoteHead(s,i,l,f.NoteShapeSquareWhite,f.NoteShapeSquareWhite,f.NoteShapeSquareWhite,f.NoteShapeSquareBlack);break;case"ti":this._applyNoteHead(s,i,l,f.NoteShapeTriangleRoundWhite,f.NoteShapeTriangleRoundWhite,f.NoteShapeTriangleRoundWhite,f.NoteShapeTriangleRoundBlack);break;case"triangle":this._applyNoteHead(s,i,l,f.NoteheadTriangleUpDoubleWhole,f.NoteheadTriangleUpWhole,f.NoteheadTriangleUpHalf,f.NoteheadTriangleUpBlack);break;case"x":this._applyNoteHead(s,i,l,f.NoteheadXDoubleWhole,f.NoteheadXWhole,f.NoteheadXHalf,f.NoteheadXBlack);break}}_createRestForGap(e,s){let i=D.toTicks(s);for(;i>e;){if(s===b.TwoHundredFiftySixth)return null;s=s*2,i=D.toTicks(s)}const r=new qt;return r.dynamics=this._currentDynamics,r.isEmpty=!1,r.duration=s,r.overrideDisplayDuration=i,r.updateDurations(),r}_insertBeatToVoice(e,s){if(s.beats.length>0){const i=s.beats[s.beats.length-1];i.nextBeat=e,e.previousBeat=i;let r=i;for(;r!==null&&r.graceType!==ee.None;)r.index>0?r=r.previousBeat:r=null;r!==null&&(e.displayStart=r.displayEnd)}s.addBeat(e)}_musicXmlDivisionsToAlphaTabTicks(e){return e*D.QuarterTime/this._divisionsPerQuarterNote}_parseBeatDuration(e){switch(e.innerText){case"1024th":return b.TwoHundredFiftySixth;case"512th":return b.TwoHundredFiftySixth;case"256th":return b.TwoHundredFiftySixth;case"128th":return b.OneHundredTwentyEighth;case"64th":return b.SixtyFourth;case"32nd":return b.ThirtySecond;case"16th":return b.Sixteenth;case"eighth":return b.Eighth;case"quarter":return b.Quarter;case"half":return b.Half;case"whole":return b.Whole;case"breve":return b.DoubleWhole;case"long":return b.QuadrupleWhole}return null}_applyBeatDurationFromTicks(e,s,i,r){if(!i)for(let a=0;a<Qe._allDurations.length;a++){const l=Qe._allDurationTicks[a];if(s>=l)i=Qe._allDurations[a];else break}e.duration=i??b.Sixteenth,r&&(e.overrideDisplayDuration=s),e.updateDurations()}_parseLyric(e,s,i){const a=this._indexToTrackInfo.get(i.index).getLyricLine(e.getAttribute("number",""));for(s.lyrics===null&&(s.lyrics=[]);s.lyrics.length<=a;)s.lyrics.push("");for(const l of e.childElements())switch(l.localName){case"text":s.lyrics[a]?s.lyrics[a]+=` ${l.innerText}`:s.lyrics[a]=l.innerText;break;case"elision":s.lyrics[a]+=l.innerText;break}}_parseNotations(e,s,i){for(const r of e.childElements())switch(r.localName){case"tied":s&&this._parseTied(r,s,i.voice.bar.staff);break;case"slur":s&&this._parseSlur(r,s);break;case"glissando":s&&this._parseGlissando(r,s);break;case"slide":s&&this._parseSlide(r,s);break;case"ornaments":s&&this._parseOrnaments(r,s);break;case"technical":this._parseTechnical(r,s,i);break;case"articulations":s&&this._parseArticulations(r,s);break;case"dynamics":const a=this._parseDynamics(r);a!==null&&(i.dynamics=a,this._currentDynamics=a);break;case"fermata":this._parseFermata(r,i);break;case"arpeggiate":this._parseArpeggiate(r,i);break}}_getStaffContext(e){if(!this._staffToContext.has(e)){const s=new _d;return this._staffToContext.set(e,s),s}return this._staffToContext.get(e)}_parseGlissando(e,s){const i=e.getAttribute("type"),r=e.getAttribute("number","1"),a=this._getStaffContext(s.beat.voice.bar.staff);switch(i){case"start":a.slideOrigins.set(r,s);break;case"stop":if(a.slideOrigins.has(r)){const l=a.slideOrigins.get(r);l.slideTarget=s,s.slideOrigin=l,l.slideOutType=ge.Shift}break}}_parseSlur(e,s){const i=e.getAttribute("number","1"),r=this._getStaffContext(s.beat.voice.bar.staff);switch(e.getAttribute("type")){case"start":r.slurStarts.set(i,s);break;case"stop":if(r.slurStarts.has(i)){s.isSlurDestination=!0;const a=r.slurStarts.get(i);a.slurDestination=s,s.slurOrigin=a,r.slurStarts.delete(i)}break}}_parseArpeggiate(e,s){switch(e.getAttribute("direction","down")){case"down":s.brushType=Y.ArpeggioDown;break;case"up":s.brushType=Y.ArpeggioUp;break}}_parseFermata(e,s){let i;switch(e.innerText){case"normal":i=Ss.Medium;break;case"angled":i=Ss.Short;break;case"square":i=Ss.Long;break;default:i=Ss.Medium;break}s.fermata=new ra,s.fermata.type=i}_parseArticulations(e,s){for(const i of e.childElements())switch(i.localName){case"accent":s.accentuated=mt.Normal;break;case"strong-accent":s.accentuated=mt.Heavy;break;case"staccato":s.isStaccato=!0;break;case"tenuto":s.accentuated=mt.Tenuto;break}}_parseTechnical(e,s,i){const r=[];for(const a of e.childElements())switch(a.localName){case"up-bow":i.pickStroke=Ot.Up;break;case"down-bow":i.pickStroke=Ot.Down;break;case"harmonic":break;case"fingering":s&&(s.leftHandFinger=this._parseFingering(a));break;case"pluck":s&&(s.rightHandFinger=this._parseFingering(a));break;case"fret":s&&(s.fret=Number.parseInt(a.innerText,10));break;case"string":s&&(s.string=i.voice.bar.staff.tuning.length-Number.parseInt(a.innerText,10)+1);break;case"hammer-on":case"pull-off":s&&(s.isHammerPullOrigin=!0);break;case"bend":r.push(a);break;case"tap":i.tap=!0;break;case"smear":s&&(s.vibrato=Ee.Slight);break;case"golpe":switch(a.getAttribute("placement","above")){case"above":i.golpe=as.Finger;break;case"below":i.golpe=as.Thumb;break}break}s&&r.length>0&&this._parseBends(r,s)}_parseBends(e,s){const i=H.MaxPosition/e.length;let r=0,a=0,l=!0;for(const h of e){const c=h.findChildElement("bend-alter");if(c){const d=Math.round(Math.abs(Number.parseFloat(c.innerText))*2);h.findChildElement("pre-bend")?l?(r+=d,s.addBendPoint(new H(a,r)),a+=i,s.addBendPoint(new H(a,r)),l=!1):a+=i:h.findChildElement("release")?(l&&(r+=d),s.addBendPoint(new H(a,r)),a+=i,r-=d,s.addBendPoint(new H(a,r)),l=!1):(s.addBendPoint(new H(a,r)),r+=d,a+=i,s.addBendPoint(new H(a,r)),l=!1)}}}_parseFingering(e){switch(e.innerText){case"0":return ae.NoOrDead;case"1":case"p":case"t":return ae.Thumb;case"2":case"i":return ae.IndexFinger;case"3":case"m":return ae.MiddleFinger;case"4":case"a":return ae.AnnularFinger;case"5":case"c":return ae.LittleFinger}return ae.Unknown}_parseOrnaments(e,s){let i=-1;for(const r of e.childElements())switch(r.localName){case"trill-mark":i=Number.parseInt(r.getAttribute("trill-step","2"),10),s.isStringed?s.trillValue=s.stringTuning+i:s.isPercussion||(s.trillValue=s.calculateRealValue(!1,!1)+i);break;case"turn":s.ornament=ut.Turn;break;case"inverted-turn":s.ornament=ut.InvertedTurn;break;case"wavy-line":i>0?r.getAttribute("type")==="start"&&(this._currentTrillStep=i):this._currentTrillStep>0?r.getAttribute("type")==="stop"?this._currentTrillStep=-1:s.isStringed?s.trillValue=s.stringTuning+this._currentTrillStep:s.isPercussion||(s.trillValue=s.calculateRealValue(!1,!1)+this._currentTrillStep):s.vibrato=Ee.Slight;break;case"mordent":s.ornament=ut.LowerMordent;break;case"inverted-mordent":s.ornament=ut.UpperMordent;break;case"tremolo":const a=new Ns;s.beat.tremoloPicking=a,a.marks=Number.parseInt(r.innerText,10),(r.getAttribute("type","")==="unmeasured"&&a.marks===0||r.getAttribute("smufl","")==="buzzRoll")&&(a.style=zi.BuzzRoll);break}}_parseSlide(e,s){const i=e.getAttribute("type"),r=e.getAttribute("number","1"),a=this._getStaffContext(s.beat.voice.bar.staff);switch(i){case"start":a.slideOrigins.set(r,s);break;case"stop":if(a.slideOrigins.has(r)){const l=a.slideOrigins.get(r);l.slideTarget=s,s.slideOrigin=l,l.slideOutType=ge.Shift}break}}_parseTied(e,s,i){const r=e.getAttribute("type"),a=e.getAttribute("number",""),l=this._getStaffContext(i);if(r==="start"){if(a){if(l.tieStartIds.has(a)){const h=l.tieStartIds.get(a);l.tieStarts.delete(h)}l.tieStartIds.set(a,s)}l.tieStarts.add(s)}else if(r==="stop"&&!s.isTieDestination){let h=null;if(a){if(!l.tieStartIds.has(a))return;h=l.tieStartIds.get(a),l.tieStartIds.delete(a),l.tieStarts.delete(s)}else{const c=this._calculatePitchedNoteValue(s);for(const d of l.tieStarts)if(this._calculatePitchedNoteValue(d)===c){h=d,l.tieStarts.delete(h);break}}if(!h)return;s.isTieDestination=!0,s.tieOrigin=h}}_parseStem(e){switch(e.innerText){case"down":return E.Down;case"up":return E.Up;default:return null}}_parseAccidental(e,s){switch(e.innerText){case"sharp":s.accidentalMode=de.ForceSharp;break;case"natural":s.accidentalMode=de.ForceNatural;break;case"flat":s.accidentalMode=de.ForceFlat;break;case"double-sharp":s.accidentalMode=de.ForceDoubleSharp;break;case"flat-flat":s.accidentalMode=de.ForceDoubleFlat;break}}_calculatePitchedNoteValue(e){return e.octave*12+e.tone}_parseDuration(e){return this._musicXmlDivisionsToAlphaTabTicks(Number.parseFloat(e.innerText))}_parseUnpitched(e,s){var l;let i="",r=0;for(const h of e.childElements())switch(h.localName){case"display-step":i=h.innerText;break;case"display-octave":r=Number.parseInt(h.innerText,10)+1;break}const a=new Ps;if(i==="")a.octave=0,a.tone=0;else{const h=r*12+(((l=A.getToneForText(i))==null?void 0:l.noteValue)??0);a.octave=h/12|0,a.tone=h-a.octave*12}return a}_parsePitch(e){var h;let s="",i=0,r=0;for(const c of e.childElements())switch(c.localName){case"step":s=c.innerText;break;case"alter":i=Number.parseFloat(c.innerText),Number.isNaN(i)&&(i=0);break;case"octave":r=Number.parseInt(c.innerText,10)+1;break}i=i|0;const a=r*12+(((h=A.getToneForText(s))==null?void 0:h.noteValue)??0)+i,l=new Ps;return l.octave=a/12|0,l.tone=a-l.octave*12,l}_applyNoteHead(e,s,i,r,a,l,h){if(i===void 0)switch(s){case b.QuadrupleWhole:case b.DoubleWhole:e.style.noteHead=r;break;case b.Whole:e.style.noteHead=a;break;case b.Half:e.style.noteHead=l;break;default:e.style.noteHead=h;break}else if(i===!0)e.style.noteHead=h;else switch(s){case b.QuadrupleWhole:case b.DoubleWhole:e.style.noteHead=r;break;case b.Whole:e.style.noteHead=a;break;case b.Half:e.style.noteHead=l;break;default:e.style.noteHead=l;break}}};o(Qe,"_b4Value",71),o(Qe,"_allDurations",[b.TwoHundredFiftySixth,b.OneHundredTwentyEighth,b.SixtyFourth,b.ThirtySecond,b.Sixteenth,b.Eighth,b.Quarter,b.Half,b.Whole,b.DoubleWhole,b.QuadrupleWhole]),o(Qe,"_allDurationTicks",Qe._allDurations.map(e=>D.toTicks(e)));let Zo=Qe;var Ti;(function(n){n[n.Page=0]="Page",n[n.Horizontal=1]="Horizontal",n[n.Parchment=2]="Parchment"})(Ti||(Ti={}));class Yl{constructor(t){o(this,"_buffer");o(this,"_writePosition",0);o(this,"_readPosition",0);o(this,"count",0);this._buffer=new Float32Array(t)}clear(){this._readPosition=0,this._writePosition=0,this.count=0,this._buffer=new Float32Array(this._buffer.length)}write(t,e,s){let i=0;s>this._buffer.length-this.count&&(s=this._buffer.length-this.count);const r=Math.min(this._buffer.length-this._writePosition,s);return this._buffer.set(t.subarray(e,e+r),this._writePosition),this._writePosition+=r,this._writePosition%=this._buffer.length,i+=r,i<s&&(this._buffer.set(t.subarray(e+i,e+i+s-i),this._writePosition),this._writePosition+=s-i,i=s),this.count+=i,i}read(t,e,s){s>this.count&&(s=this.count);let i=0;const r=Math.min(this._buffer.length-this._readPosition,s);return t.set(this._buffer.subarray(this._readPosition,this._readPosition+r),e),i+=r,this._readPosition+=r,this._readPosition%=this._buffer.length,i<s&&(t.set(this._buffer.subarray(this._readPosition,this._readPosition+s-i),e+i),this._readPosition+=s-i,i=s),this.count-=i,i}}class Ct{constructor(t=void 0){o(this,"_listeners",[]);o(this,"_fireOnRegister");this._fireOnRegister=t}on(t){var e;return this._listeners.push(t),(e=this._fireOnRegister)!=null&&e.call(this)&&t(),()=>{this.off(t)}}off(t){this._listeners=this._listeners.filter(e=>e!==t)}trigger(){for(const t of this._listeners)t()}}class xe{constructor(t=void 0){o(this,"_listeners",[]);o(this,"_fireOnRegister");this._fireOnRegister=t}on(t){if(this._listeners.push(t),this._fireOnRegister){const e=this._fireOnRegister();e!==null&&t(e)}return()=>{this.off(t)}}off(t){this._listeners=this._listeners.filter(e=>e!==t)}trigger(t){for(const e of this._listeners)e(t)}}const Qt=class Qt{constructor(){o(this,"_worker");o(this,"ready",new Ct);o(this,"samplesPlayed",new xe);o(this,"sampleRequest",new Ct)}get sampleRate(){return Qt.preferredSampleRate}open(){L.debug("AlphaSynth","Initializing synth worker"),this._worker=fe.globalThis,this._worker.addEventListener("message",this._handleMessage.bind(this)),this.ready.trigger()}destroy(){this._worker.postMessage({cmd:"alphaSynth.output.destroy"})}_handleMessage(t){const e=t.data;switch(e.cmd){case Qt.CmdOutputSampleRequest:this.sampleRequest.trigger();break;case Qt.CmdOutputSamplesPlayed:this.samplesPlayed.trigger(e.samples);break}}addSamples(t){this._worker.postMessage({cmd:"alphaSynth.output.addSamples",samples:fe.prepareForPostMessage(t)})}play(){this._worker.postMessage({cmd:"alphaSynth.output.play"})}pause(){this._worker.postMessage({cmd:"alphaSynth.output.pause"})}resetSamples(){this._worker.postMessage({cmd:"alphaSynth.output.resetSamples"})}activate(){}async enumerateOutputDevices(){return[]}async setOutputDevice(t){}async getOutputDevice(){return null}};o(Qt,"CmdOutputPrefix","alphaSynth.output."),o(Qt,"CmdOutputAddSamples",`${Qt.CmdOutputPrefix}addSamples`),o(Qt,"CmdOutputPlay",`${Qt.CmdOutputPrefix}play`),o(Qt,"CmdOutputPause",`${Qt.CmdOutputPrefix}pause`),o(Qt,"CmdOutputResetSamples",`${Qt.CmdOutputPrefix}resetSamples`),o(Qt,"CmdOutputStop",`${Qt.CmdOutputPrefix}stop`),o(Qt,"CmdOutputSampleRequest",`${Qt.CmdOutputPrefix}sampleRequest`),o(Qt,"CmdOutputSamplesPlayed",`${Qt.CmdOutputPrefix}samplesPlayed`),o(Qt,"preferredSampleRate",0);let Ws=Qt;class wd{constructor(t){o(this,"device");o(this,"isDefault",!1);this.device=t}get deviceId(){return this.device.deviceId}get label(){return this.device.label}}const mr=class mr{static findKnownDevice(t){return mr._knownDevices.find(e=>e.deviceId===t)}static createAudioContext(){if("AudioContext"in fe.globalThis)return new AudioContext;if("webkitAudioContext"in fe.globalThis)return new webkitAudioContext;throw new Xe(ze.General,"AudioContext not found")}static async checkSinkIdSupport(){return"setSinkId"in mr.createAudioContext()?!0:(L.warning("WebAudio","Browser does not support changing the output device"),!1)}static async enumerateOutputDevices(){try{if(!await mr.checkSinkIdSupport())return[];try{await navigator.mediaDevices.getUserMedia({audio:!0})}catch(l){L.warning("WebAudio","Output device permission rejected",l)}const t=await navigator.mediaDevices.enumerateDevices();let e="",s="";const i=new Map;for(const l of t)l.kind==="audiooutput"&&(i.set(l.groupId,new wd(l)),(l.deviceId==="default"||l.deviceId==="")&&(e=l.groupId,s=l.deviceId));const r=Array.from(i.values());let a=r.find(l=>l.deviceId===s);return a||(a=r.find(l=>l.device.groupId===e)),!a&&r.length>0&&(a=r[0]),a&&(a.isDefault=!0),mr._knownDevices=r,r}catch(t){return L.error("WebAudio","Failed to enumerate output devices",t),[]}}};o(mr,"_knownDevices",[]);let $s=mr;const yr=class yr{constructor(){o(this,"context",null);o(this,"buffer",null);o(this,"source",null);o(this,"_resumeHandler");o(this,"ready",new Ct);o(this,"samplesPlayed",new xe);o(this,"sampleRequest",new Ct)}get sampleRate(){return this.context?this.context.sampleRate:yr.PreferredSampleRate}activate(t){this.context||(this.context=$s.createAudioContext()),(this.context.state==="suspended"||this.context.state==="interrupted")&&(L.debug("WebAudio","Audio Context is suspended, trying resume"),this.context.resume().then(()=>{var e,s;L.debug("WebAudio",`Audio Context resume success: state=${(e=this.context)==null?void 0:e.state}, sampleRate:${(s=this.context)==null?void 0:s.sampleRate}`),t&&t()},e=>{var s,i;L.warning("WebAudio",`Audio Context resume failed: state=${(s=this.context)==null?void 0:s.state}, sampleRate:${(i=this.context)==null?void 0:i.sampleRate}, reason=${e}`)}))}_patchIosSampleRate(){const t=navigator.userAgent;if(t.indexOf("iPhone")!==-1||t.indexOf("iPad")!==-1){const e=$s.createAudioContext(),s=e.createBuffer(1,1,yr.PreferredSampleRate),i=e.createBufferSource();i.buffer=s,i.connect(e.destination),i.start(0),i.disconnect(0),e.close()}}open(t){this._patchIosSampleRate(),this.context=$s.createAudioContext(),this.context.state==="suspended"&&this._registerResumeHandler()}_registerResumeHandler(){this._resumeHandler=(()=>{this.activate(()=>{this._unregisterResumeHandler()})}).bind(this),document.body.addEventListener("touchend",this._resumeHandler,!1),document.body.addEventListener("click",this._resumeHandler,!1)}_unregisterResumeHandler(){const t=this._resumeHandler;t&&(document.body.removeEventListener("touchend",t,!1),document.body.removeEventListener("click",t,!1))}play(){const t=this.context;this.activate(),this.buffer=t.createBuffer(2,yr.BufferSize,t.sampleRate),this.source=t.createBufferSource(),this.source.buffer=this.buffer,this.source.loop=!0}pause(){this.source&&(this.source.stop(0),this.source.disconnect()),this.source=null}destroy(){var t;this.pause(),(t=this.context)==null||t.close(),this.context=null,this._unregisterResumeHandler()}onSamplesPlayed(t){this.samplesPlayed.trigger(t)}onSampleRequest(){this.sampleRequest.trigger()}onReady(){this.ready.trigger()}enumerateOutputDevices(){return $s.enumerateOutputDevices()}async setOutputDevice(t){await $s.checkSinkIdSupport()&&(t?await this.context.setSinkId(t.deviceId):await this.context.setSinkId(""))}async getOutputDevice(){if(!await $s.checkSinkIdSupport())return null;const t=this.context.sinkId;if(typeof t!="string"||t===""||t==="default")return null;let e=$s.findKnownDevice(t);if(e)return e;const s=await this.enumerateOutputDevices();return e=s.find(i=>i.deviceId===t),e||(L.warning("WebAudio","Could not find output device in device list",t,s),null)}};o(yr,"BufferSize",4096),o(yr,"PreferredSampleRate",44100);let Ri=yr;const Ma=class Ma{static init(){var t;Ma._isRegistered||(Ma._isRegistered=!0,registerProcessor("alphatab",(t=class extends AudioWorkletProcessor{constructor(i){super(i);o(this,"_outputBuffer",new Float32Array(0));o(this,"_circularBuffer");o(this,"_bufferCount",0);o(this,"_requestedBufferCount",0);o(this,"_isStopped",!1);L.debug("WebAudio","creating processor"),this._bufferCount=Math.floor(i.processorOptions.bufferTimeInMilliseconds*sampleRate/1e3/t.BufferSize),this._circularBuffer=new Yl(t.BufferSize*this._bufferCount),this.port.onmessage=this._handleMessage.bind(this)}_handleMessage(i){const r=i.data;switch(r.cmd){case Ws.CmdOutputAddSamples:const l=r.samples;this._circularBuffer.write(l,0,l.length),this._requestedBufferCount--;break;case Ws.CmdOutputResetSamples:this._circularBuffer.clear();break;case Ws.CmdOutputStop:this._isStopped=!0;break}}process(i,r,a){if(r.length!==1&&r[0].length!==2)return!1;const l=r[0][0],h=r[0][1];if(!l||!h)return!0;const c=l.length+h.length;let d=this._outputBuffer;d.length!==c&&(d=new Float32Array(c),this._outputBuffer=d);const u=this._circularBuffer.read(d,0,Math.min(d.length,this._circularBuffer.count));let p=0;const g=Math.min(l.length,u);for(let m=0;m<g;m++)l[m]=d[p++],h[m]=d[p++];if(u<l.length)for(let m=u;m<l.length;m++)l[m]=0,h[m]=0;return this.port.postMessage({cmd:Ws.CmdOutputSamplesPlayed,samples:u/ye.AudioChannels}),this._requestBuffers(),this._circularBuffer.count>0||!this._isStopped}_requestBuffers(){const i=this._bufferCount/2|0,r=i*t.BufferSize;if(this._circularBuffer.count+this._requestedBufferCount*t.BufferSize<r){for(let l=0;l<i;l++)this.port.postMessage({cmd:Ws.CmdOutputSampleRequest});this._requestedBufferCount+=i}}},o(t,"BufferSize",4096),t)))}};o(Ma,"_isRegistered",!1);let jo=Ma;class kc extends Ri{constructor(e){super();o(this,"_worklet",null);o(this,"_bufferTimeInMilliseconds",0);o(this,"_settings");this._settings=e}open(e){super.open(e),this._bufferTimeInMilliseconds=e,this.onReady()}play(){super.play();const e=this.context;fe.createAudioWorklet(e,this._settings).then(()=>{this._worklet=new AudioWorkletNode(e,"alphatab",{numberOfOutputs:1,outputChannelCount:[2],processorOptions:{bufferTimeInMilliseconds:this._bufferTimeInMilliseconds}}),this._worklet.port.onmessage=this._handleMessage.bind(this),this.source.connect(this._worklet),this.source.start(0),this._worklet.connect(e.destination)},s=>{L.error("WebAudio",`Audio Worklet creation failed: reason=${s}`)})}_handleMessage(e){const s=e.data;switch(s.cmd){case Ws.CmdOutputSamplesPlayed:this.onSamplesPlayed(s.samples);break;case Ws.CmdOutputSampleRequest:this.onSampleRequest();break}}pause(){super.pause(),this._worklet&&(this._worklet.port.postMessage({cmd:Ws.CmdOutputStop}),this._worklet.port.onmessage=null,this._worklet.disconnect()),this._worklet=null}addSamples(e){var s;(s=this._worklet)==null||s.port.postMessage({cmd:Ws.CmdOutputAddSamples,samples:fe.prepareForPostMessage(e)})}resetSamples(){var e;(e=this._worklet)==null||e.port.postMessage({cmd:Ws.CmdOutputResetSamples})}}var vr;(function(n){n[n.SingleTrackMultiChannel=0]="SingleTrackMultiChannel",n[n.MultiTrack=1]="MultiTrack"})(vr||(vr={}));class Xl{constructor(){o(this,"events",[])}addEvent(t){if(this.events.length===0||t.tick>=this.events[this.events.length-1].tick)this.events.push(t);else{let e=this.events.length;for(;e>0&&this.events[e-1].tick>t.tick;)e--;this.events.splice(e,0,t)}}writeTo(t){const e=wt.empty();let s=0;for(const a of this.events){const l=a.tick-s;xi.writeVariableInt(e,l),a.writeTo(e),s=a.tick}const i=new Uint8Array([77,84,114,107]);t.write(i,0,i.length);const r=e.toArray();w.writeInt32BE(t,r.length),t.write(r,0,r.length)}}class xi{constructor(){o(this,"format",vr.SingleTrackMultiChannel);o(this,"division",D.QuarterTime);o(this,"tickShift",0);o(this,"tracks",[])}get events(){if(this.tracks.length===1)return this.tracks[0].events;const t=[];for(const e of this.tracks)this.events.push(...e.events);return t.sort((e,s)=>e.tick-s.tick),t}_ensureTracks(t){for(;this.tracks.length<t;)this.tracks.push(new Xl)}addEvent(t){this.format===vr.SingleTrackMultiChannel?(this._ensureTracks(1),this.tracks[0].addEvent(t)):(this._ensureTracks(t.track+1),this.tracks[t.track].addEvent(t))}toBinary(){const t=wt.empty();return this.writeTo(t),t.toArray()}writeTo(t){const e=new Uint8Array([77,84,104,100]);t.write(e,0,e.length),w.writeInt32BE(t,6),w.writeInt16BE(t,this.format),w.writeInt16BE(t,this.tracks.length),w.writeInt16BE(t,this.division);for(const s of this.tracks)s.writeTo(t)}static writeVariableInt(t,e){const s=new Uint8Array(4);let i=0;do s[i++]=e&127,e>>=7;while(e>0);for(;i>0;)i--,i>0?t.writeByte(s[i]|128):t.writeByte(s[i])}}var We;(function(n){n[n.TimeSignature=88]="TimeSignature",n[n.NoteOn=128]="NoteOn",n[n.NoteOff=144]="NoteOff",n[n.ControlChange=176]="ControlChange",n[n.ProgramChange=192]="ProgramChange",n[n.TempoChange=81]="TempoChange",n[n.PitchBend=224]="PitchBend",n[n.PerNotePitchBend=96]="PerNotePitchBend",n[n.EndOfTrack=47]="EndOfTrack",n[n.AlphaTabRest=241]="AlphaTabRest",n[n.AlphaTabMetronome=242]="AlphaTabMetronome",n[n.SystemExclusive=240]="SystemExclusive",n[n.SystemExclusive2=247]="SystemExclusive2",n[n.Meta=255]="Meta"})(We||(We={}));class yi{constructor(t,e,s){o(this,"track");o(this,"tick");o(this,"type");this.track=t,this.tick=e,this.type=s}get command(){return this.type}get message(){return 0}get data1(){return 0}get data2(){return 0}}class $l extends yi{constructor(e,s,i,r,a,l){super(e,s,We.TimeSignature);o(this,"numerator");o(this,"denominatorIndex");o(this,"midiClocksPerMetronomeClick");o(this,"thirtySecondNodesInQuarter");this.track=e,this.tick=s,this.numerator=i,this.denominatorIndex=r,this.midiClocksPerMetronomeClick=a,this.thirtySecondNodesInQuarter=l}writeTo(e){e.writeByte(255),e.writeByte(88),xi.writeVariableInt(e,4),e.writeByte(this.numerator&255),e.writeByte(this.denominatorIndex&255),e.writeByte(this.midiClocksPerMetronomeClick&255),e.writeByte(this.thirtySecondNodesInQuarter&255)}}const zr=class zr extends yi{writeTo(t){t.writeByte(240);const e=wt.withCapacity(16);e.writeByte(zr.AlphaTabManufacturerId),this.writeEventData(e),e.writeByte(247),xi.writeVariableInt(t,e.length),e.copyTo(t)}};o(zr,"AlphaTabManufacturerId",125),o(zr,"MetronomeEventId",0),o(zr,"RestEventId",1);let Dr=zr;class Jl extends Dr{constructor(e,s,i,r,a){super(e,s,We.AlphaTabMetronome);o(this,"metronomeNumerator");o(this,"metronomeDurationInTicks");o(this,"metronomeDurationInMilliseconds");o(this,"isMetronome",!0);this.metronomeNumerator=i,this.metronomeDurationInMilliseconds=a,this.metronomeDurationInTicks=r}writeEventData(e){e.writeByte(Dr.MetronomeEventId),e.writeByte(this.metronomeNumerator),w.writeInt32LE(e,this.metronomeDurationInTicks),w.writeInt32LE(e,this.metronomeDurationInMilliseconds)}}class ql extends Dr{constructor(e,s,i){super(e,s,We.AlphaTabRest);o(this,"channel");this.channel=i}writeEventData(e){e.writeByte(Dr.RestEventId),e.writeByte(this.channel)}}class Ql extends yi{constructor(e,s,i,r,a,l){super(e,s,i);o(this,"channel");o(this,"noteKey");o(this,"noteVelocity");this.channel=r,this.noteKey=a,this.noteVelocity=l}get data1(){return this.noteKey}get data2(){return this.noteVelocity}}class Kl extends Ql{constructor(t,e,s,i,r){super(t,e,We.NoteOn,s,i,r)}writeTo(t){t.writeByte(this.channel&15|144),t.writeByte(this.noteKey&255),t.writeByte(this.noteVelocity&255)}}class Zl extends Ql{constructor(t,e,s,i,r){super(t,e,We.NoteOff,s,i,r)}writeTo(t){t.writeByte(this.channel&15|128),t.writeByte(this.noteKey&255),t.writeByte(this.noteVelocity&255)}}class jl extends yi{constructor(e,s,i,r,a){super(e,s,We.ControlChange);o(this,"channel");o(this,"controller");o(this,"value");this.channel=i,this.controller=r,this.value=a}writeTo(e){e.writeByte(this.channel&15|176),e.writeByte(this.controller&255),e.writeByte(this.value&255)}get data1(){return this.controller}get data2(){return this.value}}class eh extends yi{constructor(e,s,i,r){super(e,s,We.ProgramChange);o(this,"channel");o(this,"program");this.channel=i,this.program=r}writeTo(e){e.writeByte(this.channel&15|192),e.writeByte(this.program&255)}get data1(){return this.program}}class th extends yi{constructor(e,s){super(0,e,We.TempoChange);o(this,"beatsPerMinute",0);this.microSecondsPerQuarterNote=s}get microSecondsPerQuarterNote(){return 6e7/this.beatsPerMinute}set microSecondsPerQuarterNote(e){this.beatsPerMinute=6e7/e}writeTo(e){e.writeByte(255),e.writeByte(81),e.writeByte(3),e.writeByte(this.microSecondsPerQuarterNote>>16&255),e.writeByte(this.microSecondsPerQuarterNote>>8&255),e.writeByte(this.microSecondsPerQuarterNote&255)}}class sh extends yi{constructor(e,s,i,r){super(e,s,We.PitchBend);o(this,"channel");o(this,"value");this.channel=i,this.value=r}writeTo(e){e.writeByte(this.channel&15|224),e.writeByte(this.value&127),e.writeByte(this.value>>7&127)}get data1(){return this.value&127}get data2(){return this.value>>7&127}}class ih extends yi{constructor(e,s,i,r,a){super(e,s,We.PerNotePitchBend);o(this,"channel");o(this,"noteKey");o(this,"value");this.channel=i,this.noteKey=r,this.value=a}writeTo(e){throw new Xe(ze.General,"Note Bend (Midi2.0) events cannot be exported to SMF1.0")}}class rh extends yi{constructor(t,e){super(t,e,We.EndOfTrack)}writeTo(t){t.writeByte(255),t.writeByte(47),t.writeByte(0)}}class ua{constructor(t,e){o(this,"eventIndex");o(this,"event");o(this,"isMetronome");o(this,"time",0);this.eventIndex=t,this.event=e,this.isMetronome=this.event.type===We.AlphaTabMetronome}static newMetronomeEvent(t,e,s,i,r){const a=new Jl(0,e,s,i,r);return new ua(t,a)}}class Wr{constructor(){o(this,"masterBarIndex",0);o(this,"masterBarOccurence",0);o(this,"synthBpm",0);o(this,"synthTime",0);o(this,"synthTick",0);o(this,"syncTime",0);o(this,"syncBpm",0)}updateSyncBpm(t,e){const s=t-this.synthTime,i=e-this.syncTime,r=s/i*this.synthBpm;this.syncBpm=r}}class Rh{constructor(t,e,s){o(this,"bpm");o(this,"ticks");o(this,"time");this.bpm=t,this.ticks=e,this.time=s}}class Fo{constructor(){o(this,"tempoChanges",[]);o(this,"tempoChangeIndex",0);o(this,"syncPoints",[]);o(this,"firstProgramEventPerChannel",new Map);o(this,"firstTimeSignatureNumerator",0);o(this,"firstTimeSignatureDenominator",0);o(this,"synthData",[]);o(this,"division",D.QuarterTime);o(this,"eventIndex",0);o(this,"currentTime",0);o(this,"syncPointIndex",0);o(this,"playbackRange",null);o(this,"playbackRangeStartTime",0);o(this,"playbackRangeEndTime",0);o(this,"endTick",0);o(this,"endTime",0);o(this,"currentTempo",0);o(this,"syncPointTempo",0)}}class wr{constructor(t){o(this,"_synthesizer");o(this,"_currentState");o(this,"_mainState");o(this,"_oneTimeState",null);o(this,"_countInState",null);o(this,"isLooping",!1);o(this,"playbackSpeed",1);o(this,"instrumentPrograms",new Set);o(this,"percussionKeys",new Set);this._synthesizer=t,this._mainState=new Fo,this._currentState=this._mainState}get isPlayingMain(){return this._currentState===this._mainState}get isPlayingOneTimeMidi(){return this._currentState===this._oneTimeState}get isPlayingCountIn(){return this._currentState===this._countInState}get mainPlaybackRange(){return this._mainState.playbackRange}set mainPlaybackRange(t){this._mainState.playbackRange=t,t&&(this._mainState.playbackRangeStartTime=this._tickPositionToTimePositionWithSpeed(this._mainState,t.startTick,1),this._mainState.playbackRangeEndTime=this._tickPositionToTimePositionWithSpeed(this._mainState,t.endTick,1))}get currentTime(){return this._currentState.currentTime/this.playbackSpeed}get currentEndTick(){return this._currentState.endTick}get currentEndTime(){return this._currentState.endTime/this.playbackSpeed}get currentTempo(){return this._currentState.currentTempo}get modifiedTempo(){return this._currentState.syncPointTempo*this.playbackSpeed}get syncPointTempo(){return this._currentState.syncPointTempo}get currentSyncPoints(){return this._currentState.syncPoints}mainSeek(t){if(t*=this.playbackSpeed,this.mainPlaybackRange&&(t<this._mainState.playbackRangeStartTime?t=this._mainState.playbackRangeStartTime:t>this._mainState.playbackRangeEndTime&&(t=this._mainState.playbackRangeEndTime)),t>this._mainState.currentTime)this._mainSilentProcess(t-this._mainState.currentTime);else if(t<this._mainState.currentTime){if(this._mainState.currentTime=0,this._mainState.eventIndex=0,this._mainState.syncPointIndex=0,this._mainState.tempoChangeIndex=0,this._mainState.currentTempo=this._mainState.tempoChanges[0].bpm,this._mainState.syncPointTempo=this._mainState.syncPoints.length>0?this._mainState.syncPoints[0].syncBpm:this._mainState.currentTempo,this.isPlayingMain){const e=this._synthesizer.metronomeVolume;this._synthesizer.noteOffAll(!0),this._synthesizer.resetSoft(),this._synthesizer.setupMetronomeChannel(e)}this._mainSilentProcess(t)}}_mainSilentProcess(t){if(t<=0)return;const e=Date.now(),s=this._mainState.currentTime+t;if(this.isPlayingMain)for(;this._mainState.currentTime<s;)this._fillMidiEventQueueLimited(s-this._mainState.currentTime)&&this._synthesizer.synthesizeSilent(ye.MicroBufferSize);this._mainState.currentTime=s;const i=Date.now()-e;L.debug("Sequencer",`Silent seek finished in ${i}ms (main)`)}loadOneTimeMidi(t){this._oneTimeState=this.createStateFromFile(t),this._currentState=this._oneTimeState}loadMidi(t){this.instrumentPrograms.clear(),this.percussionKeys.clear(),this._mainState=this.createStateFromFile(t),this._currentState=this._mainState}createStateFromFile(t){const e=new Fo;this.percussionKeys.add(ye.MetronomeKey),e.tempoChanges=[],e.division=t.division,e.eventIndex=0,e.currentTime=0,e.synthData=[];let s=120,i=0,r=0,a=0,l=0,h=0,c=t.tickShift,d=0,u=0;for(const p of t.events){const g=new ua(e.synthData.length,p);e.synthData.push(g);const m=p.tick-u;if(i+=m,r+=m*(6e4/(s*t.division)),g.time=r,u=p.tick,l>0)for(;c<i;){const y=ua.newMetronomeEvent(e.synthData.length,c,Math.floor(c/l)%a,l,h);e.synthData.push(y),y.time=d,c+=l,d+=h}if(p.type===We.TempoChange){const y=p;s=wr._sanitizeBpm(y.beatsPerMinute),e.tempoChanges.push(new Rh(s,i,r)),h=l*(6e4/(s*t.division))}else if(p.type===We.TimeSignature){const y=p,S=Math.pow(2,y.denominatorIndex);a=y.numerator,l=e.division*(4/S)|0,h=l*(6e4/(s*t.division)),e.firstTimeSignatureDenominator===0&&(e.firstTimeSignatureNumerator=y.numerator,e.firstTimeSignatureDenominator=S)}else if(p.type===We.ProgramChange){const y=p,S=y.channel;e.firstProgramEventPerChannel.has(S)||e.firstProgramEventPerChannel.set(S,g),S===ye.PercussionChannel||this.instrumentPrograms.add(y.program)}else if(p.type===We.NoteOn){const y=p;y.channel===ye.PercussionChannel&&this.percussionKeys.add(y.noteKey)}}return e.currentTempo=e.tempoChanges.length>0?e.tempoChanges[0].bpm:s,e.syncPointTempo=e.currentTempo,e.synthData.sort((p,g)=>p.time>g.time?1:p.time<g.time?-1:p.eventIndex-g.eventIndex),e.endTime=r,e.endTick=i,e}fillMidiEventQueue(){return this._fillMidiEventQueueLimited(-1)}fillMidiEventQueueToEndTime(t){for(;this._mainState.currentTime<t;)this._fillMidiEventQueueLimited(t-this._mainState.currentTime)&&this._synthesizer.synthesizeSilent(ye.MicroBufferSize);let e=!1;for(this._currentState.currentTime=t;this._currentState.eventIndex<this._currentState.synthData.length&&this._currentState.synthData[this._currentState.eventIndex].time<this._currentState.currentTime;){const s=this._currentState.synthData[this._currentState.eventIndex];this._synthesizer.dispatchEvent(s),this._currentState.eventIndex++,e=!0}return e}_fillMidiEventQueueLimited(t){let e=ye.MicroBufferSize/this._synthesizer.outSampleRate*1e3*this.playbackSpeed,s=this._internalEndTime;t>0&&(t<e&&(e=t),s=Math.min(this._internalEndTime,this._currentState.currentTime+t));let i=!1;for(this._currentState.currentTime+=e;this._currentState.eventIndex<this._currentState.synthData.length&&this._currentState.synthData[this._currentState.eventIndex].time<this._currentState.currentTime&&this._currentState.currentTime<s;)this._synthesizer.dispatchEvent(this._currentState.synthData[this._currentState.eventIndex]),this._currentState.eventIndex++,i=!0;return i}mainTickPositionToTimePosition(t){return this._tickPositionToTimePositionWithSpeed(this._mainState,t,this.playbackSpeed)}mainUpdateSyncPoints(t){const e=this._mainState;if(t.sort((s,i)=>s.synthTick-i.synthTick),e.syncPoints=[],t.length>=0){let s=120,i=0,r=0,a=0;for(let l=0;l<t.length;l++){const h=t[l];let c=0,d,u,p;if(l===0)d=s,u=0,p=0;else{const g=t[l-1];d=wr._sanitizeBpm(g.syncBpm),u=g.syncTime,p=g.synthTick}for(;a<e.tempoChanges.length&&e.tempoChanges[a].ticks<=h.synthTick;){if(c=e.tempoChanges[a].ticks-i,c>0){i+=c,r+=c*(6e4/(s*e.division));const g=(h.syncTime-u)/(h.synthTick-p),m=(i-p)*g+u,y=new Wr;y.synthTick=i,y.synthBpm=s,y.synthTime=r,y.syncTime=m,y.syncBpm=d}s=wr._sanitizeBpm(e.tempoChanges[a].bpm),a++}c=h.synthTick-i,i+=c,r+=c*(6e4/(s*e.division)),e.syncPoints.push(h)}}e.syncPointIndex=0,e.syncPointTempo=e.syncPoints.length>0?e.syncPoints[0].syncBpm:e.currentTempo}currentTimePositionToTickPosition(t){const e=this._currentState;if(e.tempoChanges.length===0)return 0;t*=this.playbackSpeed,this._updateCurrentTempo(e,t);const s=e.tempoChanges[e.tempoChangeIndex],r=(t-s.time)/(6e4/(wr._sanitizeBpm(s.bpm)*e.division))|0;return s.ticks+r+1}static _sanitizeBpm(t){return Math.max(t,1)}currentUpdateCurrentTempo(t){this._updateCurrentTempo(this._mainState,t*this.playbackSpeed)}_updateCurrentTempo(t,e){let s=t.tempoChangeIndex;for(e<t.tempoChanges[s].time&&(s=0);s+1<t.tempoChanges.length&&t.tempoChanges[s+1].time<=e;)s++;s!==t.tempoChangeIndex&&(t.tempoChangeIndex=s,t.currentTempo=t.tempoChanges[t.tempoChangeIndex].bpm,t.syncPoints.length===0&&(t.syncPointTempo=t.currentTempo))}currentUpdateSyncPoints(t){this._updateSyncPoints(this._mainState,t)}_updateSyncPoints(t,e){const s=t.syncPoints;if(s.length>0){let i=Math.min(t.syncPointIndex,s.length-1);for(e<s[i].syncTime&&(i=0);i+1<s.length&&s[i+1].syncTime<=e;)i++;i!==t.syncPointIndex&&(t.syncPointIndex=i,t.syncPointTempo=s[i].syncBpm)}else t.syncPointTempo=t.currentTempo}mainTimePositionFromBackingTrack(t,e){const s=this._mainState,i=s.syncPoints;if(t<0||i.length===0)return t;this._updateSyncPoints(this._mainState,t);const r=Math.min(s.syncPointIndex,i.length-1),a=i[r],l=t-a.syncTime;let h;if(r+1<i.length){const c=i[r+1],d=l/(c.syncTime-a.syncTime);h=(c.synthTime-a.synthTime)*d}else{const c=l/(e-a.syncTime);h=(s.endTime-a.synthTime)*c}return(a.synthTime+h)/this.playbackSpeed}mainTimePositionToBackingTrack(t,e){const s=this._mainState,i=s.syncPoints;if(t<0||i.length===0)return t;t*=this.playbackSpeed;let r=Math.min(s.syncPointIndex,i.length-1);for(t<i[r].synthTime&&(r=0);r+1<i.length&&i[r+1].synthTime<=t;)r++;const a=i[r],l=t-a.synthTime;let h;if(r+1<i.length){const c=i[r+1],d=l/(c.synthTime-a.synthTime),u=c.syncTime-a.syncTime;h=a.syncTime+u*d}else{const c=l/(s.endTime-a.synthTime),d=e-a.syncTime;h=a.syncTime+d*c}return h}_tickPositionToTimePositionWithSpeed(t,e,s){let i=0,r=120,a=0;for(const l of t.tempoChanges){if(e<l.ticks)break;i=l.time,r=l.bpm,a=l.ticks}return e-=a,i+=e*(6e4/(r*t.division)),i/s}get _internalEndTime(){return this.isPlayingMain?this.mainPlaybackRange?this._currentState.playbackRangeEndTime:this._currentState.endTime:this._currentState.endTime}get isFinished(){return this._currentState.currentTime>=this._internalEndTime}stop(){this.isPlayingMain&&this.mainPlaybackRange?this._currentState.currentTime=this.mainPlaybackRange.startTick:this._currentState.currentTime=0,this._currentState.eventIndex=0}resetOneTimeMidi(){this._oneTimeState=null,this._currentState=this._mainState}resetCountIn(){this._countInState=null,this._currentState=this._mainState}startCountIn(){this.generateCountInMidi(),this._currentState=this._countInState,this.stop(),this._synthesizer.noteOffAll(!0)}generateCountInMidi(){const t=new Fo;t.division=this._mainState.division;let e=120,s=4,i=4;this._mainState.eventIndex===0?(e=this._mainState.tempoChanges[0].bpm,s=this._mainState.firstTimeSignatureNumerator,i=this._mainState.firstTimeSignatureDenominator):(e=this._synthesizer.currentTempo,s=this._synthesizer.timeSignatureNumerator,i=this._synthesizer.timeSignatureDenominator),t.tempoChanges.push(new Rh(e,0,0));const r=t.division*(4/i)|0,a=r*(6e4/(e*this._mainState.division));let l=0,h=0;for(let c=0;c<s;c++){const d=ua.newMetronomeEvent(t.synthData.length,l,c,r,a);t.synthData.push(d),d.time=h,l+=r,h+=a}t.synthData.sort((c,d)=>c.time>d.time?1:c.time<d.time?-1:c.eventIndex-d.eventIndex),t.endTime=h,t.endTick=l,t.currentTempo=e,t.syncPointTempo=e,this._countInState=t}}var Ut;(function(n){n[n.Paused=0]="Paused",n[n.Playing=1]="Playing"})(Ut||(Ut={}));class Br{constructor(t,e){o(this,"state");o(this,"stopped");this.state=t,this.stopped=e}}class ci{constructor(t,e,s,i,r,a,l){o(this,"currentTime");o(this,"endTime");o(this,"currentTick");o(this,"endTick");o(this,"isSeek");o(this,"originalTempo",0);o(this,"modifiedTempo",0);this.currentTime=t,this.endTime=e,this.currentTick=s,this.endTick=i,this.isSeek=r,this.originalTempo=a,this.modifiedTempo=l}}const br=class br{constructor(){o(this,"id","");o(this,"size",0)}static load(t,e,s){if(t&&br.HeaderSize>t.size||s.position+br.HeaderSize>=s.length||(e.id=w.read8BitStringLength(s,4),e.id.charCodeAt(0)<=32||e.id.charCodeAt(0)>=122)||(e.size=w.readUInt32LE(s),t&&br.HeaderSize+e.size>t.size))return!1;t&&(t.size-=br.HeaderSize+e.size);const i=e.id==="RIFF",r=e.id==="LIST";return i&&t?!1:!i&&!r?!0:(e.id=w.read8BitStringLength(s,4),e.id.charCodeAt(0)<=32||e.id.charCodeAt(0)>=122?!1:(e.size-=4,!0))}};o(br,"HeaderSize",8);let Li=br;class Bd{constructor(t,e,s,i){o(this,"packetData");o(this,"isBeginningOfStream");o(this,"isEndOfStream");o(this,"granulePosition");this.packetData=t,this.isBeginningOfStream=e,this.isEndOfStream=s,this.granulePosition=s?i:null}addData(t){const e=this.packetData,s=new Uint8Array(e.length+t.length);s.set(e,0),s.set(t,e.length)}}var fa;(function(n){n[n.ContinuesPacket=1]="ContinuesPacket",n[n.BeginningOfStream=2]="BeginningOfStream",n[n.EndOfStream=4]="EndOfStream"})(fa||(fa={}));class Td{constructor(t){o(this,"_readable");this._readable=t}read(){const t=[];for(;this._findAndReadPage(t););return t}_findAndReadPage(t){return this._seekPageHeader()?this._readPage(t):!1}_seekPageHeader(){for(let t=0;t<65536;t++){if(w.readInt32LE(this._readable)===1399285583)return!0;this._readable.position-=3}return!1}_readPage(t){const e=this._readable.readByte();if(e===-1||e!==0)return!1;const s=this._readable.readByte(),i=w.readInt64LE(this._readable);this._readable.skip(4),this._readable.skip(4),this._readable.skip(4);const r=this._readable.readByte();if(r===-1)return!1;const a=[];let l=0;for(let h=0;h<r;h++){const c=this._readable.readByte();l===a.length&&a.push(0),a[l]+=c,c<255&&l++}for(let h=0;h<a.length;h++){const c=new Uint8Array(a[h]);if(this._readable.read(c,0,c.length)!==c.length)return!1;if(s&fa.ContinuesPacket){if(t.length===0)throw new Xe(ze.Format,"OGG: Continuation page without any previous packets");t[t.length-1].addData(c)}else{const u=new Bd(c,(s&fa.BeginningOfStream)!==0&&h===0,(s&fa.EndOfStream)!==0&&h===a.length-1,i);t.push(u)}}return!0}}class xd{constructor(){o(this,"audioChannels",0);o(this,"audioSampleRate",0);o(this,"samples",new Float32Array(0));o(this,"bitrateMaximum",0);o(this,"bitrateNominal",0);o(this,"bitrateMinimum",0);o(this,"blocksize0",0);o(this,"blocksize1",0)}}class Oh{constructor(){o(this,"value",0);o(this,"bitsRead",0)}}const uo=class uo{constructor(t){o(this,"_source");o(this,"_bitBucket",0n);o(this,"_bitCount",0n);o(this,"_overflowBits",0n);this._source=t}readByte(){return this.readBits(uo._byteSize)}readBit(){return this.readBits(1)===1}readBytes(t){const e=new Uint8Array(t);for(let s=0;s<t;s++)e[s]=this.readByte()&255;return e}readBits(t){if(t===0)return 0;const e=this.tryPeekBits(t);return this.skipBits(t),e.value}tryPeekBits(t){if(t<0||t>32)throw new Xe(ze.General,"IO: Cannot read more than 32 bits in one go");if(t===0)return new Oh;const e=new Oh;for(;this._bitCount<t;){const i=BigInt(this._source.readByte());if(i===-1n)return e.bitsRead=Number(this._bitCount),e.value=Number(this._bitBucket),this._bitBucket=0n,this._bitCount=0n,e;this._bitBucket=(i&0xffn)<<this._bitCount|this._bitBucket,this._bitCount+=8n,this._bitCount>32&&(this._overflowBits=i>>40n-this._bitCount&0xffn)}let s=this._bitBucket;return t<64&&(s=s&(1n<<BigInt(t))-1n),e.value=Number(s),e.bitsRead=t,e}skipBits(t){let e=BigInt(t);if(t!==0)if(this._bitCount>e){if(t>31?this._bitBucket=0n:this._bitBucket=this._bitBucket>>e,this._bitCount>32){const s=this._bitCount-32n;this._bitBucket=this._bitBucket|this._overflowBits<<this._bitCount-e-s,s>t&&(this._overflowBits=this._overflowBits>>e&0xffn)}this._bitCount-=e}else if(this._bitCount===e)this._bitBucket=0n,this._bitCount=0n;else{for(e-=this._bitCount,this._bitCount=0n,this._bitBucket=0n;e>8;){if(this._source.readByte()===-1){e=0n;break}e-=8n}if(e>0){const s=BigInt(this._source.readByte());s===-1n||(this._bitBucket=s>>e,this._bitCount=8n-e)}}}};o(uo,"_byteSize",8);let Sn=uo;class Nd{constructor(){o(this,"codebooks",[]);o(this,"timeDomainTransforms",[]);o(this,"floors",[]);o(this,"residues",[]);o(this,"mappings",[]);o(this,"modes",[])}}class Ni{static ilog(t){let e=0;for(;t>0;)++e,t>>=1;return e}static bitReverse(t,e=32){let s=BigInt(t);return s=(s&BigInt(2863311530))>>1n|(s&BigInt(1431655765))<<1n,s=(s&BigInt(3435973836))>>2n|(s&BigInt(858993459))<<2n,s=(s&BigInt(4042322160))>>4n|(s&BigInt(252645135))<<4n,s=(s&BigInt(4278255360))>>8n|(s&BigInt(16711935))<<8n,s=(s>>16n|s<<16n)>>32n-BigInt(e),Number(BigInt.asUintN(32,s))}static convertFromVorbisFloat32(t){const e=BigInt(t);let s=e&BigInt(2097151);const i=e&BigInt(2147483648),r=(e&BigInt(2145386496))>>21n;return i!==0n&&(s=-s),Number(s)*Math.pow(2,Number(r)-788)}}class Pd{constructor(t){o(this,"_data");this._data=t}get(t){return this._data[t]}}const fo=class fo{get(t){return t}};o(fo,"instance",new fo);let el=fo;class Cd{constructor(t,e){o(this,"_lengths");o(this,"_maxBits",0);o(this,"_overflowList",null);o(this,"_prefixList",null);o(this,"_prefixBitLength",0);o(this,"_lookupTable");o(this,"dimensions",0);o(this,"entries",0);o(this,"mapType",0);if(t.readBits(24)!==5653314)throw new Xe(ze.Format,"Vorbis: Book header had invalid signature!");this.dimensions=t.readBits(16),this.entries=t.readBits(24),this._lengths=new Int32Array(this.entries),this._initTree(t,e),this._initLookupTable(t)}get(t,e){return this._lookupTable[t*this.dimensions+e]}decodeScalar(t){let e=t.tryPeekBits(this._prefixBitLength);if(e.bitsRead===0)return-1;let s=this._prefixList[e.value];if(s!=null)return t.skipBits(s.length),s.value;if(e=t.tryPeekBits(this._maxBits),this._overflowList!==null)for(let i=0;i<this._overflowList.length;i++){s=this._overflowList[i];const r=e.value&s.mask;if(s.bits===r)return t.skipBits(s.length),s.value}return-1}_initTree(t,e){let s,i=0,r;if(t.readBit()){let a=t.readBits(5)+1;for(let l=0;l<this.entries;){let h=t.readBits(Ni.ilog(this.entries-l));for(;--h>=0;)this._lengths[l++]=a;++a}i=0,s=!1,r=a}else{r=-1,s=t.readBit();for(let a=0;a<this.entries;a++)!s||t.readBit()?(this._lengths[a]=t.readBits(5)+1,++i):this._lengths[a]=-1,this._lengths[a]>r&&(r=this._lengths[a])}if(this._maxBits=r,r>-1){let a=null;s&&i>=this.entries>>2&&(a=new Int32Array(this.entries),a.set(this._lengths.subarray(0,this.entries),0),s=!1);let l;s?l=i:l=0;let h=null,c=null;if(s?l!==0&&(a=new Int32Array(l),c=new Int32Array(l),h=new Int32Array(l)):c=new Int32Array(this.entries),!this._computeCodewords(s,c,a,this._lengths,this.entries,h))throw new Xe(ze.Format,"Vorbis: Failed to compute codewords");const d=h==null?el.instance:new Pd(h);e.generateTable(d,a??this._lengths,c),this._prefixList=e.prefixTree,this._prefixBitLength=e.tableBits,this._overflowList=e.overflowList}}_computeCodewords(t,e,s,i,r,a){const l=new Uint32Array(32);let h=0,c=0;for(h=0;h<r&&!(i[h]>0);++h);if(h===r)return!0;this._addEntry(t,e,s,0,h,c++,i[h],a);for(let d=1;d<=i[h];++d)l[d]=1<<32-d;for(let d=h+1;d<r;++d){let u=i[d];if(u<=0)continue;for(;u>0&&l[u]===0;)--u;if(u===0)return!1;const p=l[u];if(l[u]=0,this._addEntry(t,e,s,Ni.bitReverse(p),d,c++,i[d],a),u!==i[d])for(let g=i[d];g>u;--g)l[g]=p+(1<<32-g)}return!0}_addEntry(t,e,s,i,r,a,l,h){t?(e[a]=i,s[a]=l,h[a]=r):e[r]=i}_initLookupTable(t){if(this.mapType=t.readBits(4),this.mapType===0)return;const e=Ni.convertFromVorbisFloat32(t.readBits(32)),s=Ni.convertFromVorbisFloat32(t.readBits(32)),i=t.readBits(4)+1,r=t.readBit();let a=this.entries*this.dimensions;const l=new Float32Array(a);this.mapType===1&&(a=this._lookup1Values());const h=new Uint32Array(a);for(let c=0;c<a;c++)h[c]=t.readBits(i);if(this.mapType===1)for(let c=0;c<this.entries;c++){let d=0,u=1;for(let p=0;p<this.dimensions;p++){const g=c/u%a|0,m=h[g]*s+e+d;l[c*this.dimensions+p]=m,r&&(d=m),u*=a}}else for(let c=0;c<this.entries;c++){let d=0,u=c*this.dimensions;for(let p=0;p<this.dimensions;p++){const g=h[u]*s+e+d;l[c*this.dimensions+p]=g,r&&(d=g),++u}}this._lookupTable=l}_lookup1Values(){let t=Math.floor(Math.exp(Math.log(this.entries)/this.dimensions));return Math.floor(Math.pow(t+1,this.dimensions))<=this.entries&&++t,t}}class Ed{constructor(){o(this,"value",0);o(this,"length",0);o(this,"bits",0);o(this,"mask",0)}}const Fa=class Fa{constructor(){o(this,"tableBits",0);o(this,"prefixTree",[]);o(this,"overflowList",null)}generateTable(t,e,s){const i=new Array(e.length);let r=0;for(let c=0;c<i.length;c++){const d=new Ed;d.value=t.get(c),d.length=e[c]<=0?99999:e[c],d.bits=s[c],d.mask=(1<<e[c])-1,i[c]=d,e[c]>0&&r<e[c]&&(r=e[c])}i.sort((c,d)=>{const u=c.length-d.length;return u===0?c.bits-d.bits:u});const a=r>Fa.maxTableBits?Fa.maxTableBits:r,l=[];let h=null;for(let c=0;c<i.length&&i[c].length<99999;c++){const d=i[c].length;if(d>a)for(h=[];c<i.length&&i[c].length<99999;c++)h.push(i[c]);else{const u=1<<a-d,p=i[c];for(let g=0;g<u;g++){const m=g<<d|p.bits;for(;l.length<=m;)l.push(null);l[m]=p}}}for(;l.length<1<<a;)l.push(null);this.tableBits=a,this.prefixTree=l,this.overflowList=h}};o(Fa,"maxTableBits",10);let tl=Fa;class vd{constructor(t){t.readBits(16)}}class Dd{constructor(t){o(this,"coeff");o(this,"amp",0);o(this,"forceEnergy",!1);o(this,"forceNoEnergy",!1);this.coeff=t}get executeChannel(){return(this.forceEnergy||this.amp>0)&&!this.forceNoEnergy}}class _n{constructor(t,e,s,i){o(this,"_order");o(this,"_rate");o(this,"_barkMapSize");o(this,"_ampBits");o(this,"_ampOfs");o(this,"_ampDiv");o(this,"_books");o(this,"_bookBits");o(this,"_wMap");o(this,"_barkMaps");if(this._order=t.readBits(8),this._rate=t.readBits(16),this._barkMapSize=t.readBits(16),this._ampBits=t.readBits(6),this._ampOfs=t.readBits(8),this._books=new Array(t.readBits(4)+1),this._order<1||this._rate<1||this._barkMapSize<1||this._books.length===0)throw new Xe(ze.Format,"Vorbis: Invalid Floor0 Data");this._ampDiv=(1<<this._ampBits)-1;for(let r=0;r<this._books.length;r++){const a=t.readBits(8);if(a<0||a>=i.length)throw new Xe(ze.Format,"Vorbis: Invalid Floor0 Data");const l=i[a];if(l.mapType===0||l.dimensions<1)throw new Xe(ze.Format,"Vorbis: Invalid Floor0 Data");this._books[r]=l}this._bookBits=Ni.ilog(this._books.length),this._barkMaps=new Map([[e,this._synthesizeBarkCurve(e/2)],[s,this._synthesizeBarkCurve(s/2)]]),this._wMap=new Map([[e,this._synthesizeWDelMap(e/2)],[s,this._synthesizeWDelMap(s/2)]])}_synthesizeBarkCurve(t){const e=this._barkMapSize/_n._toBARK(this._rate/2),s=new Int32Array(t+1);for(let i=0;i<t-1;i++)s[i]=Math.min(this._barkMapSize-1,Math.floor(_n._toBARK(this._rate/2/t*i)*e));return s[t]=-1,s}static _toBARK(t){return 13.1*Math.atan(74e-5*t)+2.24*Math.atan(185e-10*t*t)+1e-4*t}_synthesizeWDelMap(t){const e=Math.PI/this._barkMapSize,s=new Float32Array(t);for(let i=0;i<t;i++)s[i]=2*Math.cos(e*i);return s}unpack(t,e,s){const i=new Dd(new Float32Array(this._order+1));if(i.amp=t.readBits(this._ampBits),i.amp>0){i.amp=i.amp/this._ampDiv*this._ampOfs;const r=t.readBits(this._bookBits);if(r>=this._books.length)return i.amp=0,i;const a=this._books[r];for(let h=0;h<this._order;){const c=a.decodeScalar(t);if(c===-1)return i.amp=0,i;for(let d=0;h<this._order&&d<a.dimensions;d++,h++)i.coeff[h]=a.get(c,d)}let l=0;for(let h=0;h<this._order;){for(let c=0;h<this._order&&c<a.dimensions;h++,c++)i.coeff[h]+=l;l=i.coeff[h-1]}}return i}apply(t,e,s){const i=t,r=e/2;if(i.amp>0){const a=this._barkMaps.get(e),l=this._wMap.get(e);let h=0;for(h=0;h<this._order;h++)i.coeff[h]=2*Math.cos(i.coeff[h]);for(h=0;h<r;){let c=0;const d=a[h];let u=.5,p=.5;const g=l[d];for(c=1;c<this._order;c+=2)p*=g-i.coeff[c-1],u*=g-i.coeff[c];for(c===this._order?(p*=g-i.coeff[c-1],u*=u*(4-g*g),p*=p):(u*=u*(2-g),p*=p*(2+g)),p=i.amp/Math.sqrt(u+p)-this._ampOfs,p=Math.exp(p*.11512925),s[h]*=p;a[++h]===d;)s[h]*=p}}else s.fill(0,0,r)}}class Ld{constructor(){o(this,"posts",new Int32Array(64));o(this,"postCount",0);o(this,"forceEnergy",!1);o(this,"forceNoEnergy",!1)}get executeChannel(){return(this.forceEnergy||this.postCount>0)&&!this.forceNoEnergy}}const Mi=class Mi{constructor(t,e){o(this,"_partitionClass");o(this,"_classDimensions");o(this,"_classSubclasses");o(this,"_xList");o(this,"_classMasterBookIndex");o(this,"_hNeigh");o(this,"_lNeigh");o(this,"_sortIdx");o(this,"_multiplier");o(this,"_range");o(this,"_yBits");o(this,"_classMasterbooks");o(this,"_subclassBooks");o(this,"_subclassBookIndex");let s=-1;this._partitionClass=new Int32Array(t.readBits(5));for(let a=0;a<this._partitionClass.length;a++)this._partitionClass[a]=t.readBits(4),this._partitionClass[a]>s&&(s=this._partitionClass[a]);++s,this._classDimensions=new Int32Array(s),this._classSubclasses=new Int32Array(s),this._classMasterbooks=new Array(s),this._classMasterBookIndex=new Int32Array(s),this._subclassBooks=new Array(s),this._subclassBookIndex=new Array(s);for(let a=0;a<s;a++){this._classDimensions[a]=t.readBits(3)+1,this._classSubclasses[a]=t.readBits(2),this._classSubclasses[a]>0&&(this._classMasterBookIndex[a]=t.readBits(8),this._classMasterbooks[a]=e[this._classMasterBookIndex[a]]),this._subclassBooks[a]=new Array(1<<this._classSubclasses[a]),this._subclassBookIndex[a]=new Int32Array(this._subclassBooks[a].length);for(let l=0;l<this._subclassBooks[a].length;l++){const h=t.readBits(8)-1;h>=0&&(this._subclassBooks[a][l]=e[h]),this._subclassBookIndex[a][l]=h}}this._multiplier=t.readBits(2),this._range=Mi._rangeLookup[this._multiplier],this._yBits=Mi._yBitsLookup[this._multiplier],++this._multiplier;const i=t.readBits(4),r=[];r.push(0),r.push(1<<i);for(let a=0;a<this._partitionClass.length;a++){const l=this._partitionClass[a];for(let h=0;h<this._classDimensions[l];h++)r.push(t.readBits(i))}this._xList=new Int32Array(r),this._lNeigh=new Int32Array(r.length),this._hNeigh=new Int32Array(r.length),this._sortIdx=new Int32Array(r.length),this._sortIdx[0]=0,this._sortIdx[1]=1;for(let a=2;a<this._lNeigh.length;a++){this._lNeigh[a]=0,this._hNeigh[a]=1,this._sortIdx[a]=a;for(let l=2;l<a;l++){const h=this._xList[l];h<this._xList[a]?h>this._xList[this._lNeigh[a]]&&(this._lNeigh[a]=l):h<this._xList[this._hNeigh[a]]&&(this._hNeigh[a]=l)}}for(let a=0;a<this._sortIdx.length-1;a++)for(let l=a+1;l<this._sortIdx.length;l++){if(this._xList[a]===this._xList[l])throw new Xe(ze.Format,"Vorbis: Invalid Floor1 Data");if(this._xList[this._sortIdx[a]]>this._xList[this._sortIdx[l]]){const h=this._sortIdx[a];this._sortIdx[a]=this._sortIdx[l],this._sortIdx[l]=h}}}unpack(t,e,s){const i=new Ld;if(t.readBit()){let r=2;i.posts[0]=t.readBits(this._yBits),i.posts[1]=t.readBits(this._yBits);for(let a=0;a<this._partitionClass.length;a++){const l=this._partitionClass[a],h=this._classDimensions[l],c=this._classSubclasses[l],d=(1<<c)-1;let u=0;if(c>0&&(u=this._classMasterbooks[l].decodeScalar(t),u===-1)){r=0;break}for(let p=0;p<h;p++){const g=this._subclassBooks[l][u&d];if(u=u>>c,g!=null&&(i.posts[r]=g.decodeScalar(t),i.posts[r]===-1)){r=0,a=this._partitionClass.length;break}++r}}i.postCount=r}return i}apply(t,e,s){const i=t,r=e/2;if(i.postCount>0){const a=this._unwrapPosts(i);let l=0,h=i.posts[0]*this._multiplier;for(let c=1;c<i.postCount;c++){const d=this._sortIdx[c];if(a[d]){const u=this._xList[d],p=i.posts[d]*this._multiplier;l<r&&this._renderLineMulti(l,h,Math.min(u,r),p,s),l=u,h=p}if(l>=r)break}l<r&&this._renderLineMulti(l,h,r,h,s)}else s.fill(0,0,r)}_unwrapPosts(t){const e=new Array(64);e.fill(!1),e[0]=!0,e[1]=!0;const s=new Int32Array(64);s[0]=t.posts[0],s[1]=t.posts[1];for(let i=2;i<t.postCount;i++){const r=this._lNeigh[i],a=this._hNeigh[i],l=this._renderPoint(this._xList[r],s[r],this._xList[a],s[a],this._xList[i]),h=t.posts[i],c=this._range-l,d=l;let u;c<d?u=c*2:u=d*2,h!==0?(e[r]=!0,e[a]=!0,e[i]=!0,h>=u?c>d?s[i]=h-d+l:s[i]=l-h+c-1:h%2===1?s[i]=l-(h+1)/2:s[i]=l+h/2):(e[i]=!1,s[i]=l)}for(let i=0;i<t.postCount;i++)t.posts[i]=s[i];return e}_renderPoint(t,e,s,i,r){const a=i-e,l=s-t,d=Math.abs(a)*(r-t)/l|0;return a<0?e-d:e+d}_renderLineMulti(t,e,s,i,r){const a=i-e,l=s-t;let h=Math.abs(a);const c=1-(a>>31&1)*2,d=a/l|0;let u=t,p=e,g=-l;for(r[t]*=Mi._inverseDbTable[e],h-=Math.abs(d)*l;++u<s;)p+=d,g+=h,g>=0&&(g-=l,p+=c),r[u]*=Mi._inverseDbTable[p]}};o(Mi,"_rangeLookup",[256,128,86,64]),o(Mi,"_yBitsLookup",[8,7,7,6]),o(Mi,"_inverseDbTable",new Float32Array([10649863e-14,11341951e-14,12079015e-14,12863978e-14,13699951e-14,14590251e-14,15538408e-14,16548181e-14,17623575e-14,18768855e-14,19988561e-14,2128753e-13,22670913e-14,24144197e-14,25713223e-14,27384213e-14,29163793e-14,31059021e-14,33077411e-14,35226968e-14,37516214e-14,39954229e-14,4255068e-13,45315863e-14,48260743e-14,51396998e-14,54737065e-14,58294187e-14,62082472e-14,66116941e-14,70413592e-14,74989464e-14,79862701e-14,8505263e-13,90579828e-14,96466216e-14,10273513e-13,10941144e-13,11652161e-13,12409384e-13,13215816e-13,14074654e-13,14989305e-13,15963394e-13,17000785e-13,18105592e-13,19282195e-13,20535261e-13,21869758e-13,23290978e-13,24804557e-13,26416497e-13,2813319e-12,29961443e-13,31908506e-13,33982101e-13,36190449e-13,38542308e-13,41047004e-13,4371447e-12,46555282e-13,49580707e-13,5280274e-12,5623416e-12,59888572e-13,63780469e-13,67925283e-13,72339451e-13,77040476e-13,82047e-10,87378876e-13,93057248e-13,99104632e-13,10554501e-12,11240392e-12,11970856e-12,12748789e-12,13577278e-12,14459606e-12,15399272e-12,16400004e-12,17465768e-12,18600792e-12,19809576e-12,21096914e-12,22467911e-12,23928002e-12,25482978e-12,27139006e-12,28902651e-12,30780908e-12,32781225e-12,34911534e-12,37180282e-12,39596466e-12,42169667e-12,4491009e-11,47828601e-12,50936773e-12,54246931e-12,57772202e-12,61526565e-12,65524908e-12,69783085e-12,74317983e-12,79147585e-12,8429104e-11,89768747e-12,95602426e-12,.00010181521,.00010843174,.00011547824,.00012298267,.00013097477,.00013948625,.00014855085,.00015820453,.00016848555,.00017943469,.00019109536,.00020351382,.00021673929,.00023082423,.00024582449,.00026179955,.00027881276,.00029693158,.00031622787,.00033677814,.00035866388,.00038197188,.00040679456,.00043323036,.00046138411,.00049136745,.00052329927,.00055730621,.00059352311,.00063209358,.00067317058,716917e-9,.0007635063,.00081312324,.00086596457,.00092223983,.00098217216,.0010459992,.0011139742,.0011863665,.0012634633,.0013455702,.0014330129,.0015261382,.0016253153,.0017309374,.0018434235,.0019632195,.0020908006,.0022266726,.0023713743,.0025254795,.0026895994,.0028643847,.0030505286,.0032487691,.0034598925,.0036847358,.0039241906,.0041792066,.004450795,.0047400328,.0050480668,.0053761186,.0057254891,.0060975636,.0064938176,.0069158225,.0073652516,.0078438871,.0083536271,.0088964928,.009474637,.010090352,.01074608,.011444421,.012188144,.012980198,.013823725,.014722068,.015678791,.016697687,.017782797,.018938423,.020169149,.021479854,.022875735,.02436233,.025945531,.027631618,.029427276,.031339626,.033376252,.035545228,.037855157,.040315199,.042935108,.045725273,.048696758,.051861348,.055231591,.05882085,.062643361,.066714279,.071049749,.075666962,.080584227,.085821044,.091398179,.097337747,.1036633,.11039993,.11757434,.12521498,.13335215,.14201813,.15124727,.16107617,.1715438,.18269168,.19456402,.20720788,.22067342,.23501402,.25028656,.26655159,.28387361,.30232132,.32196786,.34289114,.36517414,.38890521,.41417847,.44109412,.4697589,.50028648,.53279791,.56742212,.6042964,.64356699,.68538959,.72993007,.77736504,.8278826,.88168307,.9389798,1]));let sl=Mi;class Md{constructor(t,e,s,i){o(this,"floor");const r=t.readBits(16);switch(r){case 0:this.floor=new _n(t,e,s,i);break;case 1:this.floor=new sl(t,i);break;default:throw new Xe(ze.Format,`Vorbis: Invalid Floor type: ${r}`)}}apply(t,e,s){this.floor.apply(t,e,s)}unpack(t,e,s){return this.floor.unpack(t,e,s)}}class tn{constructor(t,e,s){o(this,"_channels");o(this,"_begin");o(this,"_end");o(this,"_partitionSize");o(this,"_classifications");o(this,"_maxStages");o(this,"_books");o(this,"_classBook");o(this,"_cascade");o(this,"_decodeMap");this._begin=t.readBits(24),this._end=t.readBits(24),this._partitionSize=t.readBits(24)+1,this._classifications=t.readBits(6)+1,this._classBook=s[t.readBits(8)],this._cascade=new Int32Array(this._classifications);let i=0;for(let u=0;u<this._classifications;u++){const p=t.readBits(3);t.readBit()?this._cascade[u]=t.readBits(5)<<3|p:this._cascade[u]=p,i+=tn._icount(this._cascade[u])}const r=new Int32Array(i);for(let u=0;u<i;u++)if(r[u]=t.readBits(8),s[r[u]].mapType===0)throw new Xe(ze.Format,"Vorbis: Invalid Residue 0");const a=this._classBook.entries;let l=this._classBook.dimensions,h=1;for(;l>0;){if(h*=this._classifications,h>a)throw new Xe(ze.Format,"Vorbis: Invalid Residue 0");--l}this._books=new Array(this._classifications),i=0;let c=0,d;for(let u=0;u<this._classifications;u++)if(d=Ni.ilog(this._cascade[u]),this._books[u]=new Array(d),d>0){c=Math.max(c,d);for(let p=0;p<d;p++)(this._cascade[u]&1<<p)>0&&(this._books[u][p]=s[r[i++]])}this._maxStages=c,this._decodeMap=new Array(h);for(let u=0;u<h;u++){let p=u,g=h/this._classifications|0;this._decodeMap[u]=new Int32Array(this._classBook.dimensions);for(let m=0;m<this._classBook.dimensions;m++){const y=p/g|0;p-=y*g,g=g/this._classifications|0,this._decodeMap[u][m]=y}}this._channels=e}static _icount(t){let e=0;for(;t!==0;)e+=t&1,t>>=1;return e}decode(t,e,s,i){const a=(this._end<s/2?this._end:s/2)-this._begin;if(a>0&&e.indexOf(!1)!==-1){const l=a/this._partitionSize,h=(l+this._classBook.dimensions-1)/this._classBook.dimensions|0,c=[];for(let d=0;d<this._channels;d++)c.push(new Array(h));for(let d=0;d<this._maxStages;d++)for(let u=0,p=0;u<l;p++){if(d===0)for(let g=0;g<this._channels;g++){const m=this._classBook.decodeScalar(t);if(m>=0&&m<this._decodeMap.length)c[g][p]=this._decodeMap[m];else{u=l,d=this._maxStages;break}}for(let g=0;u<l&&g<this._classBook.dimensions;g++,u++){const m=this._begin+u*this._partitionSize;for(let y=0;y<this._channels;y++){const S=c[y][p][g];if(this._cascade[S]&1<<d){const k=this._books[S][d];if(k&&this.writeVectors(k,t,i,y,m,this._partitionSize)){u=l,d=this._maxStages;break}}}}}}}writeVectors(t,e,s,i,r,a){const l=s[i],h=a/t.dimensions,c=new Int32Array(h);for(let d=0;d<h;d++)if(c[d]=t.decodeScalar(e),c[d]===-1)return!0;for(let d=0;d<t.dimensions;d++)for(let u=0;u<h;u++,r++)l[r]+=t.get(c[u],d);return!1}}class Fd extends tn{writeVectors(t,e,s,i,r,a){const l=s[i];for(let h=0;h<a;){const c=t.decodeScalar(e);if(c===-1)return!0;for(let d=0;d<t.dimensions;h++,d++)l[r+h]+=t.get(c,d)}return!1}}class Ad extends tn{constructor(e,s,i){super(e,1,i);o(this,"_realChannels");this._realChannels=s}decode(e,s,i,r){super.decode(e,s,i*this._realChannels,r)}writeVectors(e,s,i,r,a,l){let h=0;a/=this._realChannels;for(let c=0;c<l;){const d=e.decodeScalar(s);if(d===-1)return!0;for(let u=0;u<e.dimensions;u++,c++)i[h][a]+=e.get(d,u),++h===this._realChannels&&(h=0,a++)}return!1}}class Id{constructor(t,e,s){o(this,"residue");const i=t.readBits(16);switch(i){case 0:this.residue=new tn(t,e,s);break;case 1:this.residue=new Fd(t,e,s);break;case 2:this.residue=new Ad(t,e,s);break;default:throw new Xe(ze.Format,`Vorbis: Invalid Residue type: ${i}`)}}decode(t,e,s,i){this.residue.decode(t,e,s,i)}}class Rd{constructor(t,e,s,i,r){o(this,"_mdct");o(this,"_couplingAngle");o(this,"_couplingMangitude");o(this,"_submapFloor");o(this,"_submapResidue");o(this,"_channelFloor");o(this,"_channelResidue");if(t.readBits(16)!==0)throw new Xe(ze.Format,"Vorbis: Invalid mapping type!");let l=1;t.readBit()&&(l+=t.readBits(4));let h=0;t.readBit()&&(h=t.readBits(8)+1);const c=Ni.ilog(e-1);this._couplingAngle=new Int32Array(h),this._couplingMangitude=new Int32Array(h);for(let u=0;u<h;u++){const p=t.readBits(c),g=t.readBits(c);if(p===g||p>e-1||g>e-1)throw new Xe(ze.Format,"Vorbis: Invalid magnitude or angle in mapping header!");this._couplingAngle[u]=g,this._couplingMangitude[u]=p}if(t.readBits(2)!==0)throw new Xe(ze.Format,"Vorbis: Reserved bits not 0 in mapping header.");const d=new Int32Array(e);if(l>1){for(let u=0;u<e;u++)if(d[u]=t.readBits(4),d[u]>l)throw new Xe(ze.Format,"Vorbis: Invalid channel mux submap index in mapping header!")}this._submapFloor=new Array(l),this._submapResidue=new Array(l);for(let u=0;u<l;u++){t.skipBits(8);const p=t.readBits(8);if(p>=s.length)throw new Xe(ze.Format,"Vorbis: Invalid floor number in mapping header!");const g=t.readBits(8);if(g>=i.length)throw new Xe(ze.Format,"Vorbis: Invalid residue number in mapping header!");this._submapFloor[u]=s[p],this._submapResidue[u]=i[g]}this._channelFloor=new Array(e),this._channelResidue=new Array(e);for(let u=0;u<e;u++)this._channelFloor[u]=this._submapFloor[d[u]],this._channelResidue[u]=this._submapResidue[d[u]];this._mdct=r}decodePacket(t,e,s){const i=e>>1,r=new Array(this._channelFloor.length),a=new Array(this._channelFloor.length);a.fill(!1);for(let l=0;l<this._channelFloor.length;l++)r[l]=this._channelFloor[l].unpack(t,e,l),a[l]=!r[l].executeChannel,s[l].fill(0,0,i);for(let l=0;l<this._couplingAngle.length;l++)(r[this._couplingAngle[l]].executeChannel||r[this._couplingMangitude[l]].executeChannel)&&(r[this._couplingAngle[l]].forceEnergy=!0,r[this._couplingMangitude[l]].forceEnergy=!0);for(let l=0;l<this._submapFloor.length;l++){for(let h=0;h<this._channelFloor.length;h++)(this._submapFloor[l]!==this._channelFloor[h]||this._submapResidue[l]!==this._channelResidue[h])&&(r[h].forceNoEnergy=!0);this._submapResidue[l].decode(t,a,e,s)}for(let l=this._couplingAngle.length-1;l>=0;l--)if(r[this._couplingAngle[l]].executeChannel||r[this._couplingMangitude[l]].executeChannel){const h=s[this._couplingMangitude[l]],c=s[this._couplingAngle[l]];for(let d=0;d<i;d++){let u,p;const g=h[d],m=c[d];g>0?m>0?(u=g,p=g-m):(p=g,u=g+m):m>0?(u=g,p=g+m):(p=g,u=g-m),h[d]=u,c[d]=p}}for(let l=0;l<this._channelFloor.length;l++)r[l].executeChannel?(this._channelFloor[l].apply(r[l],e,s[l]),this._mdct.reverse(s[l],e)):s[l].fill(0,i,i*2)}}class wc{constructor(){o(this,"packetStartIndex",0);o(this,"packetTotalLength",0);o(this,"packetValidLength",0)}}class Od{constructor(){o(this,"overlapInfo",new wc);o(this,"windowIndex",0)}}class Wd{constructor(t=null){o(this,"samplePosition",null);this.samplePosition=t}}const ks=class ks{constructor(t,e,s,i,r){o(this,"_channels");o(this,"_blockFlag");o(this,"_blockSize");o(this,"_mapping");o(this,"_windows");o(this,"_overlapInfo",null);if(this._channels=e,this._blockFlag=t.readBit(),t.readBits(32)!==0)throw new Xe(ze.Format,"Vorbis: Mode header had invalid window or transform type!");const a=t.readBits(8);if(a>=r.length)throw new Xe(ze.Format,"Vorbis: Mode header had invalid mapping index!");this._mapping=r[a],this._blockFlag?(this._blockSize=i,this._windows=[ks._calcWindow(s,i,s),ks._calcWindow(i,i,s),ks._calcWindow(s,i,i),ks._calcWindow(i,i,i)],this._overlapInfo=[ks._calcOverlap(s,i,s),ks._calcOverlap(i,i,s),ks._calcOverlap(s,i,i),ks._calcOverlap(i,i,i)]):(this._blockSize=s,this._windows=[ks._calcWindow(s,s,s)])}decode(t,e){const s=this._getPacketInfo(t);this._mapping.decodePacket(t,this._blockSize,e);const i=this._windows[s.windowIndex];for(let r=0;r<this._blockSize;r++)for(let a=0;a<this._channels;a++)e[a][r]*=i[r];return s.overlapInfo}_getPacketInfo(t){const e=new Od;if(this._blockFlag){const s=t.readBit(),i=t.readBit();e.windowIndex=(s?1:0)+(i?2:0);const r=this._overlapInfo[e.windowIndex];e.overlapInfo.packetStartIndex=r.packetStartIndex,e.overlapInfo.packetValidLength=r.packetValidLength,e.overlapInfo.packetTotalLength=r.packetTotalLength}else e.windowIndex=0,e.overlapInfo.packetStartIndex=0,e.overlapInfo.packetValidLength=this._blockSize/2,e.overlapInfo.packetTotalLength=this._blockSize;return e}static _calcWindow(t,e,s){const i=new Float32Array(e),r=t/2,a=e,l=s/2,h=a/4-r/2,c=a-a/4-l/2;for(let d=0;d<r;d++){let u=Math.sin((d+.5)/r*ks._piHalf);u*=u,i[h+d]=Math.sin(u*ks._piHalf)}for(let d=h+r;d<c;d++)i[d]=1;for(let d=0;d<l;d++){let u=Math.sin((l-d-.5)/l*ks._piHalf);u*=u,i[c+d]=Math.sin(u*ks._piHalf)}return i}static _calcOverlap(t,e,s){const i=t/4,r=s/4,a=e/4-i,l=e/4*3+r,h=l-r*2,c=new wc;return c.packetStartIndex=a,c.packetValidLength=h,c.packetTotalLength=l,c}};o(ks,"_piHalf",3.1415926539/2);let il=ks;const Fi=class Fi{constructor(t){o(this,"_n");o(this,"_n2");o(this,"_n4");o(this,"_n8");o(this,"_ld");o(this,"_a");o(this,"_b");o(this,"_c");o(this,"_bitrev");this._n=t,this._n2=t>>1,this._n4=this._n2>>1,this._n8=this._n4>>1,this._ld=Ni.ilog(t)-1,this._a=new Float32Array(this._n2),this._b=new Float32Array(this._n2),this._c=new Float32Array(this._n4);let e=0,s=0;for(;e<this._n4;++e,s+=2)this._a[s]=Math.cos(4*e*Fi._pi/t),this._a[s+1]=-Math.sin(4*e*Fi._pi/t),this._b[s]=Math.cos((s+1)*Fi._pi/t/2)*.5,this._b[s+1]=Math.sin((s+1)*Fi._pi/t/2)*.5;for(e=0,s=0;e<this._n8;++e,s+=2)this._c[s]=Math.cos(2*(s+1)*Fi._pi/t),this._c[s+1]=-Math.sin(2*(s+1)*Fi._pi/t);this._bitrev=new Uint16Array(this._n8);for(let i=0;i<this._n8;++i)this._bitrev[i]=it.int32ToUint16(Ni.bitReverse(i,this._ld-3)<<2)}calcReverse(t){let e,s;const i=new Float32Array(this._n2);{let a=this._n2-2,l=0,h=0;const c=this._n2;for(;h!==c;)i[a+1]=t[h]*this._a[l]-t[h+2]*this._a[l+1],i[a]=t[h]*this._a[l+1]+t[h+2]*this._a[l],a-=2,l+=2,h+=4;for(h=this._n2-3;a>=0;)i[a+1]=-t[h+2]*this._a[l]- -t[h]*this._a[l+1],i[a]=-t[h+2]*this._a[l+1]+-t[h]*this._a[l],a-=2,l+=2,h-=4}e=t,s=i;{let a=this._n2-8,l=this._n4,h=0,c=this._n4,d=0;for(;a>=0;){let u,p;p=s[l+1]-s[h+1],u=s[l]-s[h],e[c+1]=s[l+1]+s[h+1],e[c]=s[l]+s[h],e[d+1]=p*this._a[a+4]-u*this._a[a+5],e[d]=u*this._a[a+4]+p*this._a[a+5],p=s[l+3]-s[h+3],u=s[l+2]-s[h+2],e[c+3]=s[l+3]+s[h+3],e[c+2]=s[l+2]+s[h+2],e[d+3]=p*this._a[a]-u*this._a[a+1],e[d+2]=u*this._a[a]+p*this._a[a+1],a-=8,c+=4,d+=4,l+=4,h+=4}}this._step3Iter0Loop(this._n>>4,e,this._n2-1-this._n4*0,-this._n8),this._step3Iter0Loop(this._n>>4,e,this._n2-1-this._n4*1,-this._n8),this._step3InnerRLoop(this._n>>5,e,this._n2-1-this._n8*0,-(this._n>>4),16),this._step3InnerRLoop(this._n>>5,e,this._n2-1-this._n8*1,-(this._n>>4),16),this._step3InnerRLoop(this._n>>5,e,this._n2-1-this._n8*2,-(this._n>>4),16),this._step3InnerRLoop(this._n>>5,e,this._n2-1-this._n8*3,-(this._n>>4),16);let r=2;for(;r<this._ld-3>>1;++r){const a=this._n>>r+2,l=a>>1,h=1<<r+1;for(let c=0;c<h;++c)this._step3InnerRLoop(this._n>>r+4,e,this._n2-1-a*c,-l,1<<r+3)}for(;r<this._ld-6;++r){const a=this._n>>r+2,l=1<<r+3,h=a>>1,c=this._n>>r+6,d=1<<r+1;let u=this._n2-1,p=0;for(let g=c;g>0;--g)this._step3InnerSLoop(d,e,u,-h,p,l,a),p+=l*4,u-=8}this._step3InnerSLoopLd654(this._n>>5,e,this._n2-1,this._n);{let a=0,l=this._n4-4,h=this._n2-4;for(;l>=0;){let c;c=this._bitrev[a],s[h+3]=e[c],s[h+2]=e[c+1],s[l+3]=e[c+2],s[l+2]=e[c+3],c=this._bitrev[a+1],s[h+1]=e[c],s[h]=e[c+1],s[l+1]=e[c+2],s[l]=e[c+3],l-=4,h-=4,a+=2}}{let a=0,l=0,h=this._n2-4;for(;l<h;){let c,d,u,p,g,m;c=s[l]-s[h+2],d=s[l+1]+s[h+3],u=this._c[a+1]*c+this._c[a]*d,p=this._c[a+1]*d-this._c[a]*c,g=s[l]+s[h+2],m=s[l+1]-s[h+3],s[l]=g+u,s[l+1]=m+p,s[h+2]=g-u,s[h+3]=p-m,c=s[l+2]-s[h],d=s[l+3]+s[h+1],u=this._c[a+3]*c+this._c[a+2]*d,p=this._c[a+3]*d-this._c[a+2]*c,g=s[l+2]+s[h],m=s[l+3]-s[h+1],s[l+2]=g+u,s[l+3]=m+p,s[h]=g-u,s[h+1]=p-m,a+=4,l+=4,h-=4}}{let a=this._n2-8,l=this._n2-8,h=0,c=this._n2-4,d=this._n2,u=this._n-4;for(;l>=0;){let p,g,m,y;y=i[l+6]*this._b[a+7]-i[l+7]*this._b[a+6],m=-i[l+6]*this._b[a+6]-i[l+7]*this._b[a+7],t[h]=y,t[c+3]=-y,t[d]=m,t[u+3]=m,g=i[l+4]*this._b[a+5]-i[l+5]*this._b[a+4],p=-i[l+4]*this._b[a+4]-i[l+5]*this._b[a+5],t[h+1]=g,t[c+2]=-g,t[d+1]=p,t[u+2]=p,y=i[l+2]*this._b[a+3]-i[l+3]*this._b[a+2],m=-i[l+2]*this._b[a+2]-i[l+3]*this._b[a+3],t[h+2]=y,t[c+1]=-y,t[d+2]=m,t[u+1]=m,g=i[l]*this._b[a+1]-i[l+1]*this._b[a],p=-i[l]*this._b[a]-i[l+1]*this._b[a+1],t[h+3]=g,t[c]=-g,t[d+3]=p,t[u]=p,a-=8,l-=8,h+=4,d+=4,c-=4,u-=4}}}_step3InnerRLoop(t,e,s,i,r){let a,l,h=s,c=h+i,d=0;for(let u=t>>2;u>0;--u)a=e[h]-e[c],l=e[h-1]-e[c-1],e[h]+=e[c],e[h-1]+=e[c-1],e[c]=a*this._a[d]-l*this._a[d+1],e[c-1]=l*this._a[d]+a*this._a[d+1],d+=r,a=e[h-2]-e[c-2],l=e[h-3]-e[c-3],e[h-2]+=e[c-2],e[h-3]+=e[c-3],e[c-2]=a*this._a[d]-l*this._a[d+1],e[c-3]=l*this._a[d]+a*this._a[d+1],d+=r,a=e[h-4]-e[c-4],l=e[h-5]-e[c-5],e[h-4]+=e[c-4],e[h-5]+=e[c-5],e[c-4]=a*this._a[d]-l*this._a[d+1],e[c-5]=l*this._a[d]+a*this._a[d+1],d+=r,a=e[h-6]-e[c-6],l=e[h-7]-e[c-7],e[h-6]+=e[c-6],e[h-7]+=e[c-7],e[c-6]=a*this._a[d]-l*this._a[d+1],e[c-7]=l*this._a[d]+a*this._a[d+1],d+=r,h-=8,c-=8}_step3Iter0Loop(t,e,s,i){let r=s,a=r+i,l=0;for(let h=t>>2;h>0;--h){let c,d;c=e[r]-e[a],d=e[r-1]-e[a-1],e[r]+=e[a],e[r-1]+=e[a-1],e[a]=c*this._a[l]-d*this._a[l+1],e[a-1]=d*this._a[l]+c*this._a[l+1],l+=8,c=e[r-2]-e[a-2],d=e[r-3]-e[a-3],e[r-2]+=e[a-2],e[r-3]+=e[a-3],e[a-2]=c*this._a[l]-d*this._a[l+1],e[a-3]=d*this._a[l]+c*this._a[l+1],l+=8,c=e[r-4]-e[a-4],d=e[r-5]-e[a-5],e[r-4]+=e[a-4],e[r-5]+=e[a-5],e[a-4]=c*this._a[l]-d*this._a[l+1],e[a-5]=d*this._a[l]+c*this._a[l+1],l+=8,c=e[r-6]-e[a-6],d=e[r-7]-e[a-7],e[r-6]+=e[a-6],e[r-7]+=e[a-7],e[a-6]=c*this._a[l]-d*this._a[l+1],e[a-7]=d*this._a[l]+c*this._a[l+1],l+=8,r-=8,a-=8}}_step3InnerSLoop(t,e,s,i,r,a,l){const h=this._a[r],c=this._a[r+1],d=this._a[r+a],u=this._a[r+a+1],p=this._a[r+a*2],g=this._a[r+a*2+1],m=this._a[r+a*3],y=this._a[r+a*3+1];let S,k,T=s,N=T+i;for(let F=t;F>0;--F)S=e[T]-e[N],k=e[T-1]-e[N-1],e[T]+=e[N],e[T-1]+=e[N-1],e[N]=S*h-k*c,e[N-1]=k*h+S*c,S=e[T-2]-e[N-2],k=e[T-3]-e[N-3],e[T-2]+=e[N-2],e[T-3]+=e[N-3],e[N-2]=S*d-k*u,e[N-3]=k*d+S*u,S=e[T-4]-e[N-4],k=e[T-5]-e[N-5],e[T-4]+=e[N-4],e[T-5]+=e[N-5],e[N-4]=S*p-k*g,e[N-5]=k*p+S*g,S=e[T-6]-e[N-6],k=e[T-7]-e[N-7],e[T-6]+=e[N-6],e[T-7]+=e[N-7],e[N-6]=S*m-k*y,e[N-7]=k*m+S*y,T-=l,N-=l}_step3InnerSLoopLd654(t,e,s,i){const r=i>>3,a=this._a[r];let l=s;const h=l-16*t;for(;l>h;){let c,d;c=e[l]-e[l-8],d=e[l-1]-e[l-9],e[l]+=e[l-8],e[l-1]+=e[l-9],e[l-8]=c,e[l-9]=d,c=e[l-2]-e[l-10],d=e[l-3]-e[l-11],e[l-2]+=e[l-10],e[l-3]+=e[l-11],e[l-10]=(c+d)*a,e[l-11]=(d-c)*a,c=e[l-12]-e[l-4],d=e[l-5]-e[l-13],e[l-4]+=e[l-12],e[l-5]+=e[l-13],e[l-12]=d,e[l-13]=c,c=e[l-14]-e[l-6],d=e[l-7]-e[l-15],e[l-6]+=e[l-14],e[l-7]+=e[l-15],e[l-14]=(c+d)*a,e[l-15]=(c-d)*a,this._iter54(e,l),this._iter54(e,l-8),l-=16}}_iter54(t,e){const s=t[e]-t[e-4],i=t[e]+t[e-4],r=t[e-2]+t[e-6],a=t[e-2]-t[e-6];t[e]=i+r,t[e-2]=i-r;const l=t[e-3]-t[e-7];t[e-4]=s+l,t[e-6]=s-l;const h=t[e-1]-t[e-5],c=t[e-1]+t[e-5],d=t[e-3]+t[e-7];t[e-1]=c+d,t[e-3]=c-d,t[e-5]=h-a,t[e-7]=h+a}};o(Fi,"_pi",3.141592653589793);let rl=Fi;class Vd{constructor(){o(this,"_setupCache",new Map)}reverse(t,e){let s;this._setupCache.has(e)?s=this._setupCache.get(e):(s=new rl(e),this._setupCache.set(e,s)),s.calcReverse(t)}}class ah{constructor(t,e,s){o(this,"_stream");o(this,"_setup");o(this,"_packets");o(this,"_packetIndex",0);o(this,"_nextPacketBuf");o(this,"_prevPacketBuf");o(this,"_prevPacketStart");o(this,"_prevPacketEnd");o(this,"_prevPacketStop");o(this,"_currentPosition");o(this,"_hasPosition");o(this,"_eosFound");o(this,"_modeFieldBits");this._stream=t,this._setup=e,this._packets=s,this._currentPosition=0,this._prevPacketBuf=null,this._prevPacketStart=0,this._prevPacketEnd=0,this._prevPacketStop=0,this._nextPacketBuf=null,this._eosFound=!1,this._hasPosition=!1,this._modeFieldBits=Ni.ilog(e.modes.length-1)}decode(){let t=new Float32Array(this._packets[this._packets.length-1].granulePosition*this._stream.audioChannels);const e=new Float32Array(.2*this._stream.audioSampleRate*this._stream.audioChannels);let s=0,i=0;for(;s=this.read(e,0,e.length),s!==0;){if(i+s>=t.length){const r=new Float32Array(t.length+e.length);r.set(t,0),t=r}t.set(e.subarray(0,s),i),i+=s}return t.subarray(0,i)}read(t,e,s){if(s===0)return 0;let i=e;const r=e+s;for(;i<r;){if(this._prevPacketStart===this._prevPacketEnd){if(this._eosFound){this._nextPacketBuf=null,this._prevPacketBuf=null;break}const l=this._readNextPacket((i-e)/this._stream.audioChannels);l===null&&(this._prevPacketEnd=this._prevPacketStop),l!==null&&l.samplePosition!==null&&!this._hasPosition&&(this._hasPosition=!0,this._currentPosition=l.samplePosition-(this._prevPacketEnd-this._prevPacketStart)-(i-e)/this._stream.audioChannels)}const a=Math.min((r-i)/this._stream.audioChannels,this._prevPacketEnd-this._prevPacketStart);a>0&&(i+=this._copyBuffer(t,i,a))}return s=i-e,this._currentPosition+=s/this._stream.audioChannels,s}_copyBuffer(t,e,s){let i=e;for(;s>0;this._prevPacketStart++,s--)for(let r=0;r<this._stream.audioChannels;r++)t[i++]=this._prevPacketBuf[r][this._prevPacketStart];return i-e}_readNextPacket(t){const e=this._decodeNextPacket();if(this._eosFound=this._eosFound||e.isEndOfStream,e.curPacket==null)return null;if(e.samplePosition!==null&&e.isEndOfStream){const s=this._currentPosition+t+e.validLen-e.startIndex,i=e.samplePosition-s;i<0&&(e.validLen+=i,e.validLen<0&&(e.validLen=0))}return this._prevPacketEnd>0?(ah._overlapBuffers(this._prevPacketBuf,e.curPacket,this._prevPacketStart,this._prevPacketStop,e.startIndex,this._stream.audioChannels),this._prevPacketStart=e.startIndex):this._prevPacketBuf==null&&(this._prevPacketStart=e.validLen),this._nextPacketBuf=this._prevPacketBuf,this._prevPacketEnd=e.validLen,this._prevPacketStop=e.totalLen,this._prevPacketBuf=e.curPacket,new Wd(e.samplePosition)}static _overlapBuffers(t,e,s,i,r,a){for(;s<i;s++,r++)for(let l=0;l<a;l++)e[l][r]+=t[l][s]}_decodeNextPacket(){const t=new Hd;let e=null;if(this._packetIndex>=this._packets.length)t.isEndOfStream=!0;else{e=this._packets[this._packetIndex++];const s=new Sn(wt.fromBuffer(e.packetData));if(t.isEndOfStream=e.isEndOfStream,!s.readBit()){const i=this._setup.modes[s.readBits(this._modeFieldBits)];if(this._nextPacketBuf==null){this._nextPacketBuf=new Array(this._stream.audioChannels);for(let a=0;a<this._stream.audioChannels;a++)this._nextPacketBuf[a]=new Float32Array(this._stream.blocksize1)}const r=i.decode(s,this._nextPacketBuf);return t.startIndex=r.packetStartIndex,t.validLen=r.packetValidLength,t.totalLen=r.packetTotalLength,t.samplePosition=e.granulePosition,t.curPacket=this._nextPacketBuf,t}}return t}}class Hd{constructor(){o(this,"curPacket",null);o(this,"startIndex",0);o(this,"validLen",0);o(this,"totalLen",0);o(this,"isEndOfStream",!1);o(this,"samplePosition",null)}}var pa;(function(n){n[n.IdentificationHeader=1]="IdentificationHeader",n[n.Comment=3]="Comment",n[n.SetupHeader=5]="SetupHeader"})(pa||(pa={}));const Ai=class Ai{constructor(t){o(this,"_packets");o(this,"_packetIndex");this._packetIndex=-1,this._packets=t}read(){let t;for(;;){if(t=this._nextPacket(),t==null)return null;if(t.isBeginningOfStream){const e=this._readStream(t);if(e!=null)return e}}}_nextPacket(){return this._packetIndex++,this._packetIndex<this._packets.length?this._packets[this._packetIndex]:null}_readStream(t){const e=new xd;if(!this._readIdentificationHeader(e,t)||!this._readComments(this._nextPacket()))return null;const s=new Nd;if(!this._readSetupHeader(e,s,this._nextPacket()))return null;const i=[];let r;for(;r=this._nextPacket(),!(r==null||(i.push(r),r.isEndOfStream)););const a=new ah(e,s,i);return e.samples=a.decode(),e}_commonHeaderDecode(t,e){const s=new Uint8Array(7);if(e.read(s,0,s.length),s[0]!==t)return!1;for(let i=0;i<Ai.vorbisHeaderMarker.length;i++)if(s[1+i]!==Ai.vorbisHeaderMarker[i])return!1;return!0}_commonHeaderDecodeBit(t,e){const s=e.readBytes(7);if(s[0]!==t)return!1;for(let i=0;i<Ai.vorbisHeaderMarker.length;i++)if(s[1+i]!==Ai.vorbisHeaderMarker[i])return!1;return!0}_readIdentificationHeader(t,e){const s=wt.fromBuffer(e.packetData);if(!this._commonHeaderDecode(pa.IdentificationHeader,s)||w.readUInt32LE(s)!==0||(t.audioChannels=s.readByte(),t.audioSampleRate=w.readUInt32LE(s),t.audioChannels<=0||t.audioSampleRate<=0))return!1;t.bitrateMaximum=w.readInt32LE(s),t.bitrateNominal=w.readInt32LE(s),t.bitrateMinimum=w.readInt32LE(s);const r=s.readByte();return t.blocksize0=1<<(r&15),t.blocksize1=1<<(r>>4),!(t.blocksize0>t.blocksize1||!Ai._isAllowedBlockSize(t.blocksize0)||!Ai._isAllowedBlockSize(t.blocksize0)||s.readByte()===0)}static _isAllowedBlockSize(t){switch(t){case 64:case 128:case 256:case 512:case 1024:case 2048:case 4096:case 8192:return!0;default:return!1}}_readComments(t){if(t==null)return!1;const e=wt.fromBuffer(t.packetData);if(!this._commonHeaderDecode(pa.Comment,e))return!1;const s=w.readUInt32LE(e);e.skip(s);const i=w.readUInt32LE(e);for(let a=0;a<i;a++){const l=w.readUInt32LE(e);e.skip(l)}return e.readByte()!==0}_readSetupHeader(t,e,s){if(s==null)return!1;const i=new Sn(wt.fromBuffer(s.packetData)),r=new Vd,a=new tl;if(!this._commonHeaderDecodeBit(pa.SetupHeader,i))return!1;let l=i.readByte()+1;for(let h=0;h<l;h++)e.codebooks.push(new Cd(i,a));l=i.readBits(6)+1;for(let h=0;h<l;h++)e.timeDomainTransforms.push(new vd(i));l=i.readBits(6)+1;for(let h=0;h<l;h++)e.floors.push(new Md(i,t.blocksize0,t.blocksize1,e.codebooks));l=i.readBits(6)+1;for(let h=0;h<l;h++)e.residues.push(new Id(i,t.audioChannels,e.codebooks));l=i.readBits(6)+1;for(let h=0;h<l;h++)e.mappings.push(new Rd(i,t.audioChannels,e.floors,e.residues,r));l=i.readBits(6)+1;for(let h=0;h<l;h++)e.modes.push(new il(i,t.audioChannels,t.blocksize0,t.blocksize1,e.mappings));return!!i.readBit()}};o(Ai,"vorbisHeaderMarker",new Uint8Array([118,111,114,98,105,115]));let al=Ai;class Gd{constructor(t){o(this,"streams",[]);const s=new Td(t).read(),i=new al(s);for(;;){const r=i.read();if(r==null)break;this.streams.push(r)}}}class Bc{constructor(){o(this,"phdrs",[]);o(this,"pbags",[]);o(this,"pmods",[]);o(this,"pgens",[]);o(this,"insts",[]);o(this,"ibags",[]);o(this,"imods",[]);o(this,"igens",[]);o(this,"sHdrs",[]);o(this,"sampleData",new Uint8Array(0));o(this,"_sampleCache",new Map)}decodeSamples(t,e,s){const i=`${t}_${e}_${s}`;if(!this._sampleCache.has(i)){let r;const a=this.sampleData.slice(t,e);if(s)r=new Gd(wt.fromBuffer(a)).streams[0].samples;else{const l=new DataView(a.buffer,a.byteOffset,a.length);r=new Float32Array(a.length/2);for(let h=0;h<r.length;h++)r[h]=l.getInt16(h*2,!0)/32767}return this._sampleCache.set(i,r),r}return this._sampleCache.get(i)}load(t){const e=new Li,s=new Li;if(!Li.load(null,e,t)||e.id!=="sfbk")throw new Kt("Soundfont is not a valid Soundfont2 file");for(;Li.load(e,s,t);){const i=new Li;if(s.id==="pdta")for(;Li.load(s,i,t);)switch(i.id){case"phdr":for(let r=0,a=i.size/dl.SizeInFile|0;r<a;r++)this.phdrs.push(new dl(t));break;case"pbag":for(let r=0,a=i.size/cl.SizeInFile|0;r<a;r++)this.pbags.push(new cl(t));break;case"pmod":for(let r=0,a=i.size/ul.SizeInFile|0;r<a;r++)this.pmods.push(new ul(t));break;case"pgen":for(let r=0,a=i.size/Os.SizeInFile|0;r<a;r++)this.pgens.push(new Os(t));break;case"inst":for(let r=0,a=i.size/hl.SizeInFile|0;r<a;r++)this.insts.push(new hl(t));break;case"ibag":for(let r=0,a=i.size/nl.SizeInFile|0;r<a;r++)this.ibags.push(new nl(t));break;case"imod":for(let r=0,a=i.size/ol.SizeInFile|0;r<a;r++)this.imods.push(new ol(t));break;case"igen":for(let r=0,a=i.size/ll.SizeInFile|0;r<a;r++)this.igens.push(new ll(t));break;case"shdr":for(let r=0,a=i.size/fl.SizeInFile|0;r<a;r++)this.sHdrs.push(new fl(t));break;default:t.position+=i.size;break}else if(s.id==="sdta")for(;Li.load(s,i,t);)switch(i.id){case"smpl":this.sampleData=new Uint8Array(i.size),t.read(this.sampleData,0,i.size);break;default:t.position+=i.size;break}else t.position+=s.size}}}class nl{constructor(t){o(this,"instGenNdx");o(this,"instModNdx");this.instGenNdx=w.readUInt16LE(t),this.instModNdx=w.readUInt16LE(t)}}o(nl,"SizeInFile",4);class ol{constructor(t){o(this,"modSrcOper");o(this,"modDestOper");o(this,"modAmount");o(this,"modAmtSrcOper");o(this,"modTransOper");this.modSrcOper=w.readUInt16LE(t),this.modDestOper=w.readUInt16LE(t),this.modAmount=w.readInt16LE(t),this.modAmtSrcOper=w.readUInt16LE(t),this.modTransOper=w.readUInt16LE(t)}}o(ol,"SizeInFile",10);class ll{constructor(t){o(this,"genOper");o(this,"genAmount");this.genOper=w.readUInt16LE(t),this.genAmount=new Tc(t)}}o(ll,"SizeInFile",4);class hl{constructor(t){o(this,"instName");o(this,"instBagNdx");this.instName=w.read8BitStringLength(t,20),this.instBagNdx=w.readUInt16LE(t)}}o(hl,"SizeInFile",22);class cl{constructor(t){o(this,"genNdx");o(this,"modNdx");this.genNdx=w.readUInt16LE(t),this.modNdx=w.readUInt16LE(t)}}o(cl,"SizeInFile",4);class Os{constructor(t){o(this,"genOper");o(this,"genAmount");this.genOper=w.readUInt16LE(t),this.genAmount=new Tc(t)}}o(Os,"SizeInFile",4),o(Os,"GenInstrument",41),o(Os,"GenKeyRange",43),o(Os,"GenVelRange",44),o(Os,"GenSampleId",53);class dl{constructor(t){o(this,"presetName");o(this,"preset");o(this,"bank");o(this,"presetBagNdx");o(this,"library");o(this,"genre");o(this,"morphology");this.presetName=w.read8BitStringLength(t,20),this.preset=w.readUInt16LE(t),this.bank=w.readUInt16LE(t),this.presetBagNdx=w.readUInt16LE(t),this.library=w.readUInt32LE(t),this.genre=w.readUInt32LE(t),this.morphology=w.readUInt32LE(t)}}o(dl,"SizeInFile",38);class ul{constructor(t){o(this,"modSrcOper");o(this,"modDestOper");o(this,"modAmount");o(this,"modAmtSrcOper");o(this,"modTransOper");this.modSrcOper=w.readUInt16LE(t),this.modDestOper=w.readUInt16LE(t),this.modAmount=w.readUInt16LE(t),this.modAmtSrcOper=w.readUInt16LE(t),this.modTransOper=w.readUInt16LE(t)}}o(ul,"SizeInFile",10);class fl{constructor(t){o(this,"sampleName");o(this,"start");o(this,"end");o(this,"startLoop");o(this,"endLoop");o(this,"sampleRate");o(this,"originalPitch");o(this,"pitchCorrection");o(this,"sampleLink");o(this,"sampleType");this.sampleName=w.read8BitStringLength(t,20),this.start=w.readUInt32LE(t),this.end=w.readUInt32LE(t),this.startLoop=w.readUInt32LE(t),this.endLoop=w.readUInt32LE(t),this.sampleRate=w.readUInt32LE(t),this.originalPitch=t.readByte(),this.pitchCorrection=w.readSInt8(t),this.sampleLink=w.readUInt16LE(t),this.sampleType=w.readUInt16LE(t)}}o(fl,"SizeInFile",46);class Tc{constructor(t){o(this,"wordAmount");this.wordAmount=w.readUInt16LE(t)}get shortAmount(){return it.uint16ToInt16(this.wordAmount)}get lowByteAmount(){return this.wordAmount&255}get highByteAmount(){return(this.wordAmount&65280)>>8&255}}class Ud{constructor(){o(this,"presetIndex",0);o(this,"bank",0);o(this,"pitchWheel",0);o(this,"perNotePitchWheel",new Map);o(this,"midiPan",0);o(this,"midiVolume",0);o(this,"midiExpression",0);o(this,"midiRpn",0);o(this,"midiData",0);o(this,"panOffset",0);o(this,"gainDb",0);o(this,"pitchRange",0);o(this,"tuning",0);o(this,"mixVolume",0);o(this,"mute",!1);o(this,"solo",!1)}}class zd{constructor(){o(this,"activeChannel",0);o(this,"channelList",[])}setupVoice(t,e){const s=this.channelList[this.activeChannel],i=e.region.pan+s.panOffset;e.playingChannel=this.activeChannel,e.mixVolume=s.mixVolume,e.noteGainDb+=s.gainDb,e.updatePitchRatio(s,t.outSampleRate),i<=-.5?(e.panFactorLeft=1,e.panFactorRight=0):i>=.5?(e.panFactorLeft=0,e.panFactorRight=1):(e.panFactorLeft=Math.sqrt(.5-i),e.panFactorRight=Math.sqrt(.5+i))}}var Oi;(function(n){n[n.None=0]="None",n[n.Continuous=1]="Continuous",n[n.Sustain=2]="Sustain"})(Oi||(Oi={}));var Tr;(function(n){n[n.StereoInterleaved=0]="StereoInterleaved",n[n.StereoUnweaved=1]="StereoUnweaved",n[n.Mono=2]="Mono"})(Tr||(Tr={}));class Yd{constructor(){o(this,"name","");o(this,"presetNumber",0);o(this,"bank",0);o(this,"regions",null)}}class Yt{static timecents2Secs(t){return Math.pow(2,t/1200)}static decibelsToGain(t){return t>-100?Math.pow(10,t*.05):0}static gainToDecibels(t){return t<=1e-5?-100:20*Math.log10(t)}static cents2Hertz(t){return 8.176*Math.pow(2,t/1200)}}class ca{constructor(t){o(this,"delay",0);o(this,"attack",0);o(this,"hold",0);o(this,"decay",0);o(this,"sustain",0);o(this,"release",0);o(this,"keynumToHold",0);o(this,"keynumToDecay",0);t&&(this.delay=t.delay,this.attack=t.attack,this.hold=t.hold,this.decay=t.decay,this.sustain=t.sustain,this.release=t.release,this.keynumToHold=t.keynumToHold,this.keynumToDecay=t.keynumToDecay)}clear(){this.delay=0,this.attack=0,this.hold=0,this.decay=0,this.sustain=0,this.release=0,this.keynumToHold=0,this.keynumToDecay=0}envToSecs(t){this.delay=this.delay<-11950?0:Yt.timecents2Secs(this.delay),this.attack=this.attack<-11950?0:Yt.timecents2Secs(this.attack),this.release=this.release<-11950?0:Yt.timecents2Secs(this.release),this.keynumToHold===0&&(this.hold=this.hold<-11950?0:Yt.timecents2Secs(this.hold)),this.keynumToDecay===0&&(this.decay=this.decay<-11950?0:Yt.timecents2Secs(this.decay)),this.sustain<0?this.sustain=0:t?this.sustain=Yt.decibelsToGain(-this.sustain/10):this.sustain=1-this.sustain/1e3}}var He;(function(n){n[n.StartAddrsOffset=0]="StartAddrsOffset",n[n.EndAddrsOffset=1]="EndAddrsOffset",n[n.StartloopAddrsOffset=2]="StartloopAddrsOffset",n[n.EndloopAddrsOffset=3]="EndloopAddrsOffset",n[n.StartAddrsCoarseOffset=4]="StartAddrsCoarseOffset",n[n.ModLfoToPitch=5]="ModLfoToPitch",n[n.VibLfoToPitch=6]="VibLfoToPitch",n[n.ModEnvToPitch=7]="ModEnvToPitch",n[n.InitialFilterFc=8]="InitialFilterFc",n[n.InitialFilterQ=9]="InitialFilterQ",n[n.ModLfoToFilterFc=10]="ModLfoToFilterFc",n[n.ModEnvToFilterFc=11]="ModEnvToFilterFc",n[n.EndAddrsCoarseOffset=12]="EndAddrsCoarseOffset",n[n.ModLfoToVolume=13]="ModLfoToVolume",n[n.Unused1=14]="Unused1",n[n.ChorusEffectsSend=15]="ChorusEffectsSend",n[n.ReverbEffectsSend=16]="ReverbEffectsSend",n[n.Pan=17]="Pan",n[n.Unused2=18]="Unused2",n[n.Unused3=19]="Unused3",n[n.Unused4=20]="Unused4",n[n.DelayModLFO=21]="DelayModLFO",n[n.FreqModLFO=22]="FreqModLFO",n[n.DelayVibLFO=23]="DelayVibLFO",n[n.FreqVibLFO=24]="FreqVibLFO",n[n.DelayModEnv=25]="DelayModEnv",n[n.AttackModEnv=26]="AttackModEnv",n[n.HoldModEnv=27]="HoldModEnv",n[n.DecayModEnv=28]="DecayModEnv",n[n.SustainModEnv=29]="SustainModEnv",n[n.ReleaseModEnv=30]="ReleaseModEnv",n[n.KeynumToModEnvHold=31]="KeynumToModEnvHold",n[n.KeynumToModEnvDecay=32]="KeynumToModEnvDecay",n[n.DelayVolEnv=33]="DelayVolEnv",n[n.AttackVolEnv=34]="AttackVolEnv",n[n.HoldVolEnv=35]="HoldVolEnv",n[n.DecayVolEnv=36]="DecayVolEnv",n[n.SustainVolEnv=37]="SustainVolEnv",n[n.ReleaseVolEnv=38]="ReleaseVolEnv",n[n.KeynumToVolEnvHold=39]="KeynumToVolEnvHold",n[n.KeynumToVolEnvDecay=40]="KeynumToVolEnvDecay",n[n.Instrument=41]="Instrument",n[n.Reserved1=42]="Reserved1",n[n.KeyRange=43]="KeyRange",n[n.VelRange=44]="VelRange",n[n.StartloopAddrsCoarseOffset=45]="StartloopAddrsCoarseOffset",n[n.Keynum=46]="Keynum",n[n.Velocity=47]="Velocity",n[n.InitialAttenuation=48]="InitialAttenuation",n[n.Reserved2=49]="Reserved2",n[n.EndloopAddrsCoarseOffset=50]="EndloopAddrsCoarseOffset",n[n.CoarseTune=51]="CoarseTune",n[n.FineTune=52]="FineTune",n[n.SampleID=53]="SampleID",n[n.SampleModes=54]="SampleModes",n[n.Reserved3=55]="Reserved3",n[n.ScaleTuning=56]="ScaleTuning",n[n.ExclusiveClass=57]="ExclusiveClass",n[n.OverridingRootKey=58]="OverridingRootKey",n[n.Unused5=59]="Unused5",n[n.EndOper=60]="EndOper"})(He||(He={}));const Aa=class Aa{constructor(t){o(this,"loopMode",Oi.None);o(this,"samples",Aa._noSamples);o(this,"sampleRate",0);o(this,"loKey",0);o(this,"hiKey",0);o(this,"loVel",0);o(this,"hiVel",0);o(this,"group",0);o(this,"offset",0);o(this,"end",0);o(this,"loopStart",0);o(this,"loopEnd",0);o(this,"transpose",0);o(this,"tune",0);o(this,"pitchKeyCenter",0);o(this,"pitchKeyTrack",0);o(this,"attenuation",0);o(this,"pan",0);o(this,"ampEnv",new ca);o(this,"modEnv",new ca);o(this,"initialFilterQ",0);o(this,"initialFilterFc",0);o(this,"modEnvToPitch",0);o(this,"modEnvToFilterFc",0);o(this,"modLfoToFilterFc",0);o(this,"modLfoToVolume",0);o(this,"delayModLFO",0);o(this,"freqModLFO",0);o(this,"modLfoToPitch",0);o(this,"delayVibLFO",0);o(this,"freqVibLFO",0);o(this,"vibLfoToPitch",0);t&&(this.loopMode=t.loopMode,this.samples=t.samples,this.sampleRate=t.sampleRate,this.loKey=t.loKey,this.hiKey=t.hiKey,this.loVel=t.loVel,this.hiVel=t.hiVel,this.group=t.group,this.offset=t.offset,this.end=t.end,this.loopStart=t.loopStart,this.loopEnd=t.loopEnd,this.transpose=t.transpose,this.tune=t.tune,this.pitchKeyCenter=t.pitchKeyCenter,this.pitchKeyTrack=t.pitchKeyTrack,this.attenuation=t.attenuation,this.pan=t.pan,this.ampEnv=new ca(t.ampEnv),this.modEnv=new ca(t.modEnv),this.initialFilterQ=t.initialFilterQ,this.initialFilterFc=t.initialFilterFc,this.modEnvToPitch=t.modEnvToPitch,this.modEnvToFilterFc=t.modEnvToFilterFc,this.modLfoToFilterFc=t.modLfoToFilterFc,this.modLfoToVolume=t.modLfoToVolume,this.delayModLFO=t.delayModLFO,this.freqModLFO=t.freqModLFO,this.modLfoToPitch=t.modLfoToPitch,this.delayVibLFO=t.delayVibLFO,this.freqVibLFO=t.freqVibLFO,this.vibLfoToPitch=t.vibLfoToPitch)}clear(t){this.loopMode=Oi.None,this.samples=Aa._noSamples,this.sampleRate=0,this.loKey=0,this.hiKey=0,this.loVel=0,this.hiVel=0,this.group=0,this.offset=0,this.end=0,this.loopStart=0,this.loopEnd=0,this.transpose=0,this.tune=0,this.pitchKeyCenter=0,this.pitchKeyTrack=0,this.attenuation=0,this.pan=0,this.ampEnv.clear(),this.modEnv.clear(),this.initialFilterQ=0,this.initialFilterFc=0,this.modEnvToPitch=0,this.modEnvToFilterFc=0,this.modLfoToFilterFc=0,this.modLfoToVolume=0,this.delayModLFO=0,this.freqModLFO=0,this.modLfoToPitch=0,this.delayVibLFO=0,this.freqVibLFO=0,this.vibLfoToPitch=0,this.hiKey=127,this.hiVel=127,this.pitchKeyCenter=60,!t&&(this.pitchKeyTrack=100,this.pitchKeyCenter=-1,this.ampEnv.delay=-12e3,this.ampEnv.attack=-12e3,this.ampEnv.hold=-12e3,this.ampEnv.decay=-12e3,this.ampEnv.release=-12e3,this.modEnv.delay=-12e3,this.modEnv.attack=-12e3,this.modEnv.hold=-12e3,this.modEnv.decay=-12e3,this.modEnv.release=-12e3,this.initialFilterFc=13500,this.delayModLFO=-12e3,this.delayVibLFO=-12e3)}operator(t,e){switch(t){case He.StartAddrsOffset:this.offset+=it.int16ToUint32(e.shortAmount);break;case He.EndAddrsOffset:this.end+=it.int16ToUint32(e.shortAmount);break;case He.StartloopAddrsOffset:this.loopStart+=it.int16ToUint32(e.shortAmount);break;case He.EndloopAddrsOffset:this.loopEnd+=it.int16ToUint32(e.shortAmount);break;case He.StartAddrsCoarseOffset:this.offset+=it.int16ToUint32(e.shortAmount)*32768;break;case He.ModLfoToPitch:this.modLfoToPitch=e.shortAmount;break;case He.VibLfoToPitch:this.vibLfoToPitch=e.shortAmount;break;case He.ModEnvToPitch:this.modEnvToPitch=e.shortAmount;break;case He.InitialFilterFc:this.initialFilterFc=e.shortAmount;break;case He.InitialFilterQ:this.initialFilterQ=e.shortAmount;break;case He.ModLfoToFilterFc:this.modLfoToFilterFc=e.shortAmount;break;case He.ModEnvToFilterFc:this.modEnvToFilterFc=e.shortAmount;break;case He.EndAddrsCoarseOffset:this.end+=it.int16ToUint32(e.shortAmount)*32768;break;case He.ModLfoToVolume:this.modLfoToVolume=e.shortAmount;break;case He.Pan:this.pan=e.shortAmount/1e3;break;case He.DelayModLFO:this.delayModLFO=e.shortAmount;break;case He.FreqModLFO:this.freqModLFO=e.shortAmount;break;case He.DelayVibLFO:this.delayVibLFO=e.shortAmount;break;case He.FreqVibLFO:this.freqVibLFO=e.shortAmount;break;case He.DelayModEnv:this.modEnv.delay=e.shortAmount;break;case He.AttackModEnv:this.modEnv.attack=e.shortAmount;break;case He.HoldModEnv:this.modEnv.hold=e.shortAmount;break;case He.DecayModEnv:this.modEnv.decay=e.shortAmount;break;case He.SustainModEnv:this.modEnv.sustain=e.shortAmount;break;case He.ReleaseModEnv:this.modEnv.release=e.shortAmount;break;case He.KeynumToModEnvHold:this.modEnv.keynumToHold=e.shortAmount;break;case He.KeynumToModEnvDecay:this.modEnv.keynumToDecay=e.shortAmount;break;case He.DelayVolEnv:this.ampEnv.delay=e.shortAmount;break;case He.AttackVolEnv:this.ampEnv.attack=e.shortAmount;break;case He.HoldVolEnv:this.ampEnv.hold=e.shortAmount;break;case He.DecayVolEnv:this.ampEnv.decay=e.shortAmount;break;case He.SustainVolEnv:this.ampEnv.sustain=e.shortAmount;break;case He.ReleaseVolEnv:this.ampEnv.release=e.shortAmount;break;case He.KeynumToVolEnvHold:this.ampEnv.keynumToHold=e.shortAmount;break;case He.KeynumToVolEnvDecay:this.ampEnv.keynumToDecay=e.shortAmount;break;case He.KeyRange:this.loKey=e.lowByteAmount,this.hiKey=e.highByteAmount;break;case He.VelRange:this.loVel=e.lowByteAmount,this.hiVel=e.highByteAmount;break;case He.StartloopAddrsCoarseOffset:this.loopStart+=it.int16ToUint32(e.shortAmount)*32768;break;case He.InitialAttenuation:this.attenuation+=e.shortAmount*.1;break;case He.EndloopAddrsCoarseOffset:this.loopEnd+=it.int16ToUint32(e.shortAmount)*32768;break;case He.CoarseTune:this.transpose+=e.shortAmount;break;case He.FineTune:this.tune+=e.shortAmount;break;case He.SampleModes:this.loopMode=(e.wordAmount&3)===3?Oi.Sustain:(e.wordAmount&3)===1?Oi.Continuous:Oi.None;break;case He.ScaleTuning:this.pitchKeyTrack=e.shortAmount;break;case He.ExclusiveClass:this.group=e.wordAmount;break;case He.OverridingRootKey:this.pitchKeyCenter=e.shortAmount;break}}};o(Aa,"_noSamples",new Float32Array(0));let qi=Aa;var ct;(function(n){n[n.None=0]="None",n[n.Delay=1]="Delay",n[n.Attack=2]="Attack",n[n.Hold=3]="Hold",n[n.Decay=4]="Decay",n[n.Sustain=5]="Sustain",n[n.Release=6]="Release",n[n.Done=7]="Done"})(ct||(ct={}));const po=class po{constructor(){o(this,"level",0);o(this,"slope",0);o(this,"samplesUntilNextSegment",0);o(this,"segment",ct.None);o(this,"midiVelocity",0);o(this,"parameters",null);o(this,"segmentIsExponential",!1);o(this,"isAmpEnv",!1)}nextSegment(t,e){if(this.parameters)for(;;)switch(t){case ct.None:if(this.samplesUntilNextSegment=this.parameters.delay*e|0,this.samplesUntilNextSegment>0){this.segment=ct.Delay,this.segmentIsExponential=!1,this.level=0,this.slope=0;return}t=ct.Delay;break;case ct.Delay:if(this.samplesUntilNextSegment=this.parameters.attack*e|0,this.samplesUntilNextSegment>0){this.isAmpEnv||(this.samplesUntilNextSegment=this.parameters.attack*((145-this.midiVelocity)/144)*e|0),this.segment=ct.Attack,this.segmentIsExponential=!1,this.level=0,this.slope=1/this.samplesUntilNextSegment;return}t=ct.Attack;break;case ct.Attack:if(this.samplesUntilNextSegment=this.parameters.hold*e|0,this.samplesUntilNextSegment>0){this.segment=ct.Hold,this.segmentIsExponential=!1,this.level=1,this.slope=0;return}t=ct.Hold;break;case ct.Hold:if(this.samplesUntilNextSegment=this.parameters.decay*e|0,this.samplesUntilNextSegment>0){if(this.segment=ct.Decay,this.level=1,this.isAmpEnv){const s=-9.226/this.samplesUntilNextSegment;this.slope=Math.exp(s),this.segmentIsExponential=!0,this.parameters.sustain>0&&(this.samplesUntilNextSegment=Math.log(this.parameters.sustain)/s|0)}else this.slope=-1/this.samplesUntilNextSegment,this.samplesUntilNextSegment=this.parameters.decay*(1-this.parameters.sustain)*e|0,this.segmentIsExponential=!1;return}t=ct.Decay;break;case ct.Decay:this.segment=ct.Sustain,this.level=this.parameters.sustain,this.slope=0,this.samplesUntilNextSegment=2147483647,this.segmentIsExponential=!1;return;case ct.Sustain:if(this.segment=ct.Release,this.samplesUntilNextSegment=(this.parameters.release<=0?po._fastReleaseTime:this.parameters.release)*e|0,this.isAmpEnv){const s=-9.226/this.samplesUntilNextSegment;this.slope=Math.exp(s),this.segmentIsExponential=!0}else this.slope=-this.level/this.samplesUntilNextSegment,this.segmentIsExponential=!1;return;default:this.segment=ct.Done,this.segmentIsExponential=!1,this.level=0,this.slope=0,this.samplesUntilNextSegment=134217727;return}}setup(t,e,s,i,r){this.parameters=new ca(t),this.parameters.keynumToHold>0&&(this.parameters.hold+=this.parameters.keynumToHold*(60-e),this.parameters.hold=this.parameters.hold<-1e4?0:Yt.timecents2Secs(this.parameters.hold)),this.parameters.keynumToDecay>0&&(this.parameters.decay+=this.parameters.keynumToDecay*(60-e),this.parameters.decay=this.parameters.decay<-1e4?0:Yt.timecents2Secs(this.parameters.decay)),this.midiVelocity=s|0,this.isAmpEnv=i,this.nextSegment(ct.None,r)}process(t,e){this.slope>0&&(this.segmentIsExponential?this.level*=Math.pow(this.slope,t):this.level+=this.slope*t),this.samplesUntilNextSegment-=t,this.samplesUntilNextSegment<=0&&this.nextSegment(this.segment,e)}};o(po,"_fastReleaseTime",.01);let kn=po;class Wh{constructor(){o(this,"samplesUntil",0);o(this,"level",0);o(this,"delta",0)}setup(t,e,s){this.samplesUntil=t*s|0,this.delta=4*Yt.cents2Hertz(e)/s,this.level=0}process(t){if(this.samplesUntil>t){this.samplesUntil-=t;return}this.level+=this.delta*t,this.level>1?(this.delta=-this.delta,this.level=2-this.level):this.level<-1&&(this.delta=-this.delta,this.level=-2-this.level)}}class Vh{constructor(t){o(this,"qInv",0);o(this,"a0",0);o(this,"a1",0);o(this,"b1",0);o(this,"b2",0);o(this,"z1",0);o(this,"z2",0);o(this,"active",!1);t&&(this.qInv=t.qInv,this.a0=t.a0,this.a1=t.a1,this.b1=t.b1,this.b2=t.b2,this.z1=t.z1,this.z2=t.z2,this.active=t.active)}setup(t){const e=Math.tan(Math.PI*t),s=e*e,i=1/(1+e*this.qInv+s);this.a0=s*i,this.a1=2*this.a0,this.b1=2*(s-1)*i,this.b2=(1-e*this.qInv+s)*i}process(t){const e=t*this.a0+this.z1;return this.z1=t*this.a1+this.z2-this.b1*e,this.z2=t*this.a0-this.b2*e,e}}const Ia=class Ia{constructor(){o(this,"playingPreset",0);o(this,"playingKey",0);o(this,"playingChannel",0);o(this,"region",null);o(this,"pitchInputTimecents",0);o(this,"pitchOutputFactor",0);o(this,"sourceSamplePosition",0);o(this,"noteGainDb",0);o(this,"panFactorLeft",0);o(this,"panFactorRight",0);o(this,"playIndex",0);o(this,"loopStart",0);o(this,"loopEnd",0);o(this,"ampEnv",new kn);o(this,"modEnv",new kn);o(this,"lowPass",new Vh);o(this,"modLfo",new Wh);o(this,"vibLfo",new Wh);o(this,"mixVolume",0);o(this,"mute",!1)}updatePitchRatio(t,e){let s=t.pitchWheel;t.perNotePitchWheel.has(this.playingKey)&&(s+=t.perNotePitchWheel.get(this.playingKey)-8192);const i=s===8192?t.tuning:s/16383*t.pitchRange*2-t.pitchRange+t.tuning;this.calcPitchRatio(i,e)}calcPitchRatio(t,e){if(!this.region)return;const s=this.playingKey+this.region.transpose+this.region.tune/100;let i=this.region.pitchKeyCenter+(s-this.region.pitchKeyCenter)*(this.region.pitchKeyTrack/100);t!==0&&(i+=t),this.pitchInputTimecents=i*100,this.pitchOutputFactor=this.region.sampleRate/(Yt.timecents2Secs(this.region.pitchKeyCenter*100)*e)}end(t){this.region&&(this.ampEnv.nextSegment(ct.Sustain,t),this.modEnv.nextSegment(ct.Sustain,t),this.region.loopMode===Oi.Sustain&&(this.loopEnd=this.loopStart))}endQuick(t){this.ampEnv.parameters.release=0,this.ampEnv.nextSegment(ct.Sustain,t),this.modEnv.parameters.release=0,this.modEnv.nextSegment(ct.Sustain,t)}render(t,e,s,i,r){if(!this.region)return;const a=this.region,l=a.samples;let h=0,c=t.outputMode===Tr.StereoUnweaved?i:-1;const d=a.modEnvToPitch!==0||a.modEnvToFilterFc!==0,u=this.modLfo.delta>0&&(a.modLfoToPitch!==0||a.modLfoToFilterFc!==0||a.modLfoToVolume!==0),p=this.vibLfo.delta>0&&a.vibLfoToPitch!==0,g=this.loopStart<this.loopEnd,m=this.loopStart,y=this.loopEnd,S=a.end,k=y+1;let T=this.sourceSamplePosition;const N=new Vh(this.lowPass),F=a.modLfoToFilterFc!==0||a.modEnvToFilterFc!==0;let q=0,U=0,x=0,j=0;const Q=a.modLfoToPitch!==0||a.modEnvToPitch!==0||a.vibLfoToPitch!==0;let Te=0,te=0,we=0,$e=0;const ce=a.modLfoToVolume!==0;let rt=0,Es=0;for(F?(q=t.outSampleRate,U=a.initialFilterFc,x=a.modLfoToFilterFc,j=a.modEnvToFilterFc):(q=0,U=0,x=0,j=0),Q?(Te=0,te=a.modLfoToPitch,we=a.vibLfoToPitch,$e=a.modEnvToPitch):(Te=Yt.timecents2Secs(this.pitchInputTimecents)*this.pitchOutputFactor,te=0,we=0,$e=0),ce?Es=a.modLfoToVolume*.1:(rt=Yt.decibelsToGain(this.noteGainDb),Es=0);i>0;){let _t,Gs,bi=0,Qs=i>Ia.renderEffectSampleBlock?Ia.renderEffectSampleBlock:i;if(i-=Qs,F){const $t=U+this.modLfo.level*x+this.modEnv.level*j;N.active=$t<=13500,N.active&&N.setup(Yt.cents2Hertz($t)/q)}switch(Q&&(Te=Yt.timecents2Secs(this.pitchInputTimecents+(this.modLfo.level*te+this.vibLfo.level*we+this.modEnv.level*$e))*this.pitchOutputFactor),ce&&(rt=Yt.decibelsToGain(this.noteGainDb+this.modLfo.level*Es)),_t=rt*this.ampEnv.level,r?_t=0:_t*=this.mixVolume,this.ampEnv.process(Qs,t.outSampleRate),d&&this.modEnv.process(Qs,t.outSampleRate),u&&this.modLfo.process(Qs),p&&this.vibLfo.process(Qs),t.outputMode){case Tr.StereoInterleaved:for(Gs=_t*this.panFactorLeft,bi=_t*this.panFactorRight;Qs-- >0&&T<S;){const $t=T|0,Di=$t>=y&&g?m:$t+1,Ks=T-$t;let vs=l[$t]*(1-Ks)+l[Di]*Ks;N.active&&(vs=N.process(vs)),e[s+h]+=vs*Gs,h++,e[s+h]+=vs*bi,h++,T+=Te,T>=k&&g&&(T-=y-m+1)}break;case Tr.StereoUnweaved:for(Gs=_t*this.panFactorLeft,bi=_t*this.panFactorRight;Qs-- >0&&T<S;){const $t=T|0,Di=$t>=y&&g?m:$t+1,Ks=T-$t;let vs=l[$t]*(1-Ks)+l[Di]*Ks;N.active&&(vs=N.process(vs)),e[s+h]+=vs*Gs,h++,e[s+c]+=vs*bi,c++,T+=Te,T>=k&&g&&(T-=y-m+1)}break;case Tr.Mono:for(;Qs-- >0&&T<S;){const $t=T|0,Di=$t>=y&&g?m:$t+1,Ks=T-$t;let vs=l[$t]*(1-Ks)+l[Di]*Ks;N.active&&(vs=N.process(vs)),e[s+h]=vs*_t,h++,T+=Te,T>=k&&g&&(T-=y-m+1)}break}if(T>=S||this.ampEnv.segment===ct.Done){this.kill();return}}this.sourceSamplePosition=T,(N.active||F)&&(this.lowPass=N)}kill(){this.playingPreset=-1}};o(Ia,"renderEffectSampleBlock",ye.MicroBufferSize);let pl=Ia;class Hh{constructor(t){o(this,"value");o(this,"next");this.value=t}}class nh{constructor(){o(this,"_head");o(this,"_tail")}get isEmpty(){return this._head===void 0}clear(){this._head=void 0,this._tail=void 0}enqueue(t){const e=new Hh(t);this._tail?(this._tail.next=e,this._tail=e):(this._head=e,this._tail=e)}enqueueFront(t){const e=new Hh(t);e.next=this._head,this._head?this._head=e:(this._head=e,this._tail=e)}peek(){const t=this._head;if(t)return t.value}dequeue(){const t=this._head;if(!t)return;const e=t.next;return this._head=e,e||(this._tail=void 0),t.value}}var at;(function(n){n[n.BankSelectCoarse=0]="BankSelectCoarse",n[n.ModulationCoarse=1]="ModulationCoarse",n[n.DataEntryCoarse=6]="DataEntryCoarse",n[n.VolumeCoarse=7]="VolumeCoarse",n[n.PanCoarse=10]="PanCoarse",n[n.ExpressionControllerCoarse=11]="ExpressionControllerCoarse",n[n.BankSelectFine=32]="BankSelectFine",n[n.ModulationFine=33]="ModulationFine",n[n.DataEntryFine=38]="DataEntryFine",n[n.VolumeFine=39]="VolumeFine",n[n.PanFine=42]="PanFine",n[n.ExpressionControllerFine=43]="ExpressionControllerFine",n[n.HoldPedal=64]="HoldPedal",n[n.LegatoPedal=68]="LegatoPedal",n[n.NonRegisteredParameterFine=98]="NonRegisteredParameterFine",n[n.NonRegisteredParameterCourse=99]="NonRegisteredParameterCourse",n[n.RegisteredParameterFine=100]="RegisteredParameterFine",n[n.RegisteredParameterCourse=101]="RegisteredParameterCourse",n[n.AllSoundOff=120]="AllSoundOff",n[n.ResetControllers=121]="ResetControllers",n[n.AllNotesOff=123]="AllNotesOff"})(at||(at={}));class So{constructor(t){o(this,"_midiEventQueue",new nh);o(this,"_mutedChannels",new Map);o(this,"_soloChannels",new Map);o(this,"_isAnySolo",!1);o(this,"_transpositionPitches",new Map);o(this,"_liveTranspositionPitches",new Map);o(this,"currentTempo",0);o(this,"timeSignatureNumerator",0);o(this,"timeSignatureDenominator",0);o(this,"presets",null);o(this,"_voices",[]);o(this,"_channels",null);o(this,"_voicePlayIndex",0);o(this,"outputMode",Tr.StereoInterleaved);o(this,"outSampleRate",0);o(this,"globalGainDb",0);this.outSampleRate=t}synthesize(t,e,s){return this._fillWorkingBuffer(t,e,s)}synthesizeSilent(t){this._fillWorkingBuffer(null,0,t)}channelGetMixVolume(t){return this._channels&&t<this._channels.channelList.length?this._channels.channelList[t].mixVolume:1}channelSetMixVolume(t,e){const s=this._channelInit(t);for(const i of this._voices)i.playingChannel===t&&i.playingPreset!==-1&&(i.mixVolume=e);s.mixVolume=e}channelSetMute(t,e){e?this._mutedChannels.set(t,!0):this._mutedChannels.delete(t)}channelSetSolo(t,e){e?this._soloChannels.set(t,!0):this._soloChannels.delete(t),this._isAnySolo=this._soloChannels.size>0}resetChannelStates(){this._mutedChannels=new Map,this._soloChannels=new Map,this._liveTranspositionPitches=new Map,this.applyTranspositionPitches(new Map),this._isAnySolo=!1}setChannelTranspositionPitch(t,e){let s=0;this._liveTranspositionPitches.has(t)&&(s=this._liveTranspositionPitches.get(t)),e===0?this._liveTranspositionPitches.delete(t):this._liveTranspositionPitches.set(t,e);for(const i of this._voices)if(i.playingChannel===t&&i.playingChannel!==9){let r=0;r-=s,r+=e,i.playingKey+=r,this._channels&&i.updatePitchRatio(this._channels.channelList[i.playingChannel],this.outSampleRate)}}applyTranspositionPitches(t){const e=this._transpositionPitches;for(const s of this._voices)if(s.playingChannel>=0&&s.playingChannel!==9){let i=0;e.has(s.playingChannel)&&(i-=e.get(s.playingChannel)),t.has(s.playingChannel)&&(i+=t.get(s.playingChannel)),s.playingKey+=i,this._channels&&s.updatePitchRatio(this._channels.channelList[s.playingChannel],this.outSampleRate)}this._transpositionPitches=t}dispatchEvent(t){this._midiEventQueue.enqueue(t)}_fillWorkingBuffer(t,e,s){const i=this._isAnySolo,r=[];for(;!this._midiEventQueue.isEmpty;){const a=this._midiEventQueue.dequeue();a.isMetronome&&this.metronomeVolume>0?(this.channelNoteOff(ye.MetronomeChannel,ye.MetronomeKey),this.channelNoteOn(ye.MetronomeChannel,ye.MetronomeKey,95/127)):a.event&&this.processMidiMessage(a.event),r.push(a)}for(const a of this._voices)if(a.playingPreset!==-1){const l=a.playingChannel,h=this._mutedChannels.has(l)||i&&l!==ye.MetronomeChannel&&!this._soloChannels.has(l);t?a.render(this,t,e,s,h):a.kill()}return r}processMidiMessage(t){switch(t.type){case We.TimeSignature:const s=t;this.timeSignatureNumerator=s.numerator,this.timeSignatureDenominator=Math.pow(2,s.denominatorIndex);break;case We.NoteOn:const i=t;this.channelNoteOn(i.channel,i.noteKey,i.noteVelocity/127);break;case We.NoteOff:const r=t;this.channelNoteOff(r.channel,r.noteKey);break;case We.ControlChange:const a=t;this.channelMidiControl(a.channel,a.controller,a.value);break;case We.ProgramChange:const l=t;this.channelSetPresetNumber(l.channel,l.program,l.channel===9);break;case We.TempoChange:const h=t;this.currentTempo=h.beatsPerMinute;break;case We.PitchBend:const c=t;this.channelSetPitchWheel(c.channel,c.value);break;case We.PerNotePitchBend:const d=t;let u=d.value;u=u*ye.MaxPitchWheel/ye.MaxPitchWheel20,this.channelSetPerNotePitchWheel(d.channel,d.noteKey,u);break}}get metronomeVolume(){return this.channelGetMixVolume(ye.MetronomeChannel)}set metronomeVolume(t){this.setupMetronomeChannel(t)}setupMetronomeChannel(t){this.channelSetMixVolume(ye.MetronomeChannel,t),t>0&&(this.channelSetVolume(ye.MetronomeChannel,1),this.channelSetPresetNumber(ye.MetronomeChannel,0,!0))}get masterVolume(){return Yt.decibelsToGain(this.globalGainDb)}set masterVolume(t){const e=Yt.gainToDecibels(t),s=e-this.globalGainDb;if(s!==0){for(const i of this._voices)i.playingPreset!==-1&&(i.noteGainDb+=s);this.globalGainDb=e}}resetSoft(){for(const t of this._voices)t.playingPreset!==-1&&(t.ampEnv.segment<ct.Release||t.ampEnv.parameters.release!==0)&&t.endQuick(this.outSampleRate);if(this._channels)for(const t of this._channels.channelList)t.presetIndex=0,t.bank=0,t.pitchWheel=8192,t.midiPan=8192,t.perNotePitchWheel.clear(),t.midiVolume=16383,t.midiExpression=16383,t.midiRpn=65535,t.midiData=0,t.panOffset=0,t.gainDb=0,t.pitchRange=2,t.tuning=0}get presetCount(){var t;return((t=this.presets)==null?void 0:t.length)??0}reset(){for(const t of this._voices)t.playingPreset!==-1&&(t.ampEnv.segment<ct.Release||t.ampEnv.parameters.release!==0)&&t.endQuick(this.outSampleRate);this._channels=null}setOutput(t,e,s){this.outputMode=t,this.outSampleRate=e>=1?e:44100,this.globalGainDb=s}noteOn(t,e,s){if(!this.presets)return;const i=s*127|0;if(t<0||t>=this.presets.length)return;if(s<=0){this.noteOff(t,e);return}const r=this._voicePlayIndex++;for(const a of this.presets[t].regions){if(e<a.loKey||e>a.hiKey||i<a.loVel||i>a.hiVel)continue;let l=null;if(a.group!==0)for(const d of this._voices)d.playingPreset===t&&d.region.group===a.group?d.endQuick(this.outSampleRate):d.playingPreset===-1&&!l&&(l=d);else for(const d of this._voices)d.playingPreset===-1&&(l=d);if(!l){for(let d=0;d<4;d++){const u=new pl;u.playingPreset=-1,this._voices.push(u)}l=this._voices[this._voices.length-4]}l.region=a,l.playingPreset=t,l.playingKey=e,l.playIndex=r,l.noteGainDb=this.globalGainDb-a.attenuation-Yt.gainToDecibels(1/s),this._channels?this._channels.setupVoice(this,l):(l.calcPitchRatio(0,this.outSampleRate),l.panFactorLeft=Math.sqrt(.5-a.pan),l.panFactorRight=Math.sqrt(.5+a.pan)),l.sourceSamplePosition=a.offset;const h=a.loopMode!==Oi.None&&a.loopStart<a.loopEnd;l.loopStart=h?a.loopStart:0,l.loopEnd=h?a.loopEnd:0,l.ampEnv.setup(a.ampEnv,e,i,!0,this.outSampleRate),l.modEnv.setup(a.modEnv,e,i,!1,this.outSampleRate);const c=a.initialFilterQ/10;l.lowPass.qInv=1/Math.pow(10,c/20),l.lowPass.z1=0,l.lowPass.z2=0,l.lowPass.active=a.initialFilterFc<=13500,l.lowPass.active&&l.lowPass.setup(Yt.cents2Hertz(a.initialFilterFc)/this.outSampleRate),l.modLfo.setup(a.delayModLFO,a.freqModLFO,this.outSampleRate),l.vibLfo.setup(a.delayVibLFO,a.freqVibLFO,this.outSampleRate)}}bankNoteOn(t,e,s,i){const r=this._getPresetIndex(t,e);return r===-1?!1:(this.noteOn(r,s,i),!0)}noteOff(t,e){let s=null,i=null;const r=[];for(const a of this._voices)a.playingPreset!==t||a.playingKey!==e||a.ampEnv.segment>=ct.Release||(!s||a.playIndex<s.playIndex?(s=a,i=a,r.push(a)):a.playIndex===s.playIndex&&(i=a,r.push(a)));if(s)for(const a of r)a!==s&&a!==i&&(a.playIndex!==s.playIndex||a.playingPreset!==t||a.playingKey!==e||a.ampEnv.segment>=ct.Release)||a.end(this.outSampleRate)}bankNoteOff(t,e,s){const i=this._getPresetIndex(t,e);return i===-1?!1:(this.noteOff(i,s),!0)}noteOffAll(t){for(const e of this._voices)e.playingPreset!==-1&&(t?e.endQuick(this.outSampleRate):e.ampEnv.segment<ct.Release&&e.end(this.outSampleRate))}get activeVoiceCount(){let t=0;for(const e of this._voices)e.playingPreset!==-1&&t++;return t}_channelInit(t){if(this._channels&&t<this._channels.channelList.length)return this._channels.channelList[t];this._channels||(this._channels=new zd);for(let e=this._channels.channelList.length;e<=t;e++){const s=new Ud;s.presetIndex=0,s.bank=0,s.pitchWheel=8192,s.midiPan=8192,s.midiVolume=16383,s.midiExpression=16383,s.midiRpn=65535,s.midiData=0,s.panOffset=0,s.gainDb=0,s.pitchRange=2,s.tuning=0,s.mixVolume=1,this._channels.channelList.push(s)}return this._channels.channelList[t]}_getPresetIndex(t,e){if(!this.presets)return-1;for(let s=this.presets.length-1;s>=0;s--){const i=this.presets[s];if(i.presetNumber===e&&i.bank===t)return s}return-1}getPresetName(t){return this.presets?t<0||t>=this.presets.length?null:this.presets[t].name:null}bankGetPresetName(t,e){return this.getPresetName(this._getPresetIndex(t,e))}channelNoteOn(t,e,s){!this._channels||t>this._channels.channelList.length||(this._transpositionPitches.has(t)&&(e+=this._transpositionPitches.get(t)),this._liveTranspositionPitches.has(t)&&(e+=this._liveTranspositionPitches.get(t)),this._channels.activeChannel=t,this.noteOn(this._channels.channelList[t].presetIndex,e,s))}channelNoteOff(t,e){this._transpositionPitches.has(t)&&(e+=this._transpositionPitches.get(t)),this._liveTranspositionPitches.has(t)&&(e+=this._liveTranspositionPitches.get(t));const s=[];let i=null,r=null;for(const l of this._voices)l.playingPreset===-1||l.playingChannel!==t||l.playingKey!==e||l.ampEnv.segment>=ct.Release||(!i||l.playIndex<i.playIndex?(i=l,r=l,s.push(l)):l.playIndex===i.playIndex&&(r=l,s.push(l)));if(this._channelInit(t).perNotePitchWheel.delete(e),!!i)for(const l of s)l!==i&&l!==r&&(l.playIndex!==i.playIndex||l.playingPreset===-1||l.playingChannel!==t||l.playingKey!==e||l.ampEnv.segment>=ct.Release)||l.end(this.outSampleRate)}channelNoteOffAll(t){this._channelInit(t).perNotePitchWheel.clear();for(const s of this._voices)s.playingPreset!==-1&&s.playingChannel===t&&s.ampEnv.segment<ct.Release&&s.end(this.outSampleRate)}channelSoundsOffAll(t){this._channelInit(t).perNotePitchWheel.clear();for(const s of this._voices)s.playingPreset!==-1&&s.playingChannel===t&&(s.ampEnv.segment<ct.Release||s.ampEnv.parameters.release===0)&&s.endQuick(this.outSampleRate)}channelSetPresetIndex(t,e){this._channelInit(t).presetIndex=it.int32ToUint16(e)}channelSetPresetNumber(t,e,s=!1){const i=this._channelInit(t);let r=0;return s?(r=this._getPresetIndex(128|i.bank&32767,e),r===-1&&(r=this._getPresetIndex(128,e)),r===-1&&(r=this._getPresetIndex(128,0)),r===-1&&(r=this._getPresetIndex(i.bank&2047,e))):r=this._getPresetIndex(i.bank&2047,e),i.presetIndex=r,r!==-1}channelSetBank(t,e){this._channelInit(t).bank=it.int32ToUint16(e)}channelSetBankPreset(t,e,s){const i=this._channelInit(t),r=this._getPresetIndex(e,s);return r===-1?!1:(i.presetIndex=it.int32ToUint16(r),i.bank=it.int32ToUint16(e),!0)}channelSetPan(t,e){for(const s of this._voices)if(s.playingChannel===t&&s.playingPreset!==-1){const i=s.region.pan+e-.5;i<=-.5?(s.panFactorLeft=1,s.panFactorRight=0):i>=.5?(s.panFactorLeft=0,s.panFactorRight=1):(s.panFactorLeft=Math.sqrt(.5-i),s.panFactorRight=Math.sqrt(.5+i))}this._channelInit(t).panOffset=e-.5}channelSetVolume(t,e){const s=this._channelInit(t),i=Yt.gainToDecibels(e),r=i-s.gainDb;if(r!==0){for(const a of this._voices)a.playingChannel===t&&a.playingPreset!==-1&&(a.noteGainDb+=r);s.gainDb=i}}channelSetPitchWheel(t,e){const s=this._channelInit(t);s.pitchWheel!==e&&(s.pitchWheel=it.int32ToUint16(e),this._channelApplyPitch(t,s))}channelSetPerNotePitchWheel(t,e,s){this._transpositionPitches.has(t)&&(e+=this._transpositionPitches.get(t)),this._liveTranspositionPitches.has(t)&&(e+=this._liveTranspositionPitches.get(t));const i=this._channelInit(t);i.perNotePitchWheel.has(e)&&i.perNotePitchWheel.get(e)===s||(i.perNotePitchWheel.set(e,s),this._channelApplyPitch(t,i,e))}_channelApplyPitch(t,e,s=-1){for(const i of this._voices)i.playingChannel===t&&i.playingPreset!==-1&&(s===-1||i.playingKey===s)&&i.updatePitchRatio(e,this.outSampleRate)}channelSetPitchRange(t,e){const s=this._channelInit(t);s.pitchRange!==e&&(s.pitchRange=e,s.pitchWheel!==8192&&this._channelApplyPitch(t,s))}channelSetTuning(t,e){const s=this._channelInit(t);s.tuning!==e&&(s.tuning=e,this._channelApplyPitch(t,s))}channelMidiControl(t,e,s){const i=this._channelInit(t);switch(e){case at.DataEntryFine:i.midiData=it.int32ToUint16(i.midiData&16256|s),i.midiRpn===0?this.channelSetPitchRange(t,(i.midiData>>7)+.01*(i.midiData&127)):i.midiRpn===1?this.channelSetTuning(t,(i.tuning|0)+(i.midiData-8192)/8192):i.midiRpn===2&&this.channelSetTuning(t,s-64+(i.tuning-(i.tuning|0)));return;case at.VolumeCoarse:i.midiVolume=it.int32ToUint16(i.midiVolume&127|s<<7),this.channelSetVolume(t,Math.pow(i.midiVolume/16383*(i.midiExpression/16383),3));return;case at.VolumeFine:i.midiVolume=it.int32ToUint16(i.midiVolume&16256|s),this.channelSetVolume(t,Math.pow(i.midiVolume/16383*(i.midiExpression/16383),3));return;case at.ExpressionControllerCoarse:i.midiExpression=it.int32ToUint16(i.midiExpression&127|s<<7),this.channelSetVolume(t,Math.pow(i.midiVolume/16383*(i.midiExpression/16383),3));return;case at.ExpressionControllerFine:i.midiExpression=it.int32ToUint16(i.midiExpression&16256|s),this.channelSetVolume(t,Math.pow(i.midiVolume/16383*(i.midiExpression/16383),3));return;case at.PanCoarse:i.midiPan=it.int32ToUint16(i.midiPan&127|s<<7),this.channelSetPan(t,i.midiPan/16383);return;case at.PanFine:i.midiPan=it.int32ToUint16(i.midiPan&16256|s),this.channelSetPan(t,i.midiPan/16383);return;case at.DataEntryCoarse:i.midiData=it.int32ToUint16(i.midiData&127|s<<7),i.midiRpn===0?this.channelSetPitchRange(t,(i.midiData>>7)+.01*(i.midiData&127)):i.midiRpn===1?this.channelSetTuning(t,(i.tuning|0)+(i.midiData-8192)/8192):i.midiRpn===2&&e===at.DataEntryCoarse&&this.channelSetTuning(t,s-64+(i.tuning-(i.tuning|0)));return;case at.BankSelectCoarse:i.bank=it.int32ToUint16(32768|s);return;case at.BankSelectFine:i.bank=it.int32ToUint16((i.bank&32768?(i.bank&127)<<7:0)|s);return;case at.RegisteredParameterCourse:i.midiRpn=it.int32ToUint16((i.midiRpn===65535?0:i.midiRpn)&127|s<<7);return;case at.RegisteredParameterFine:i.midiRpn=it.int32ToUint16((i.midiRpn===65535?0:i.midiRpn)&16256|s);return;case at.NonRegisteredParameterFine:i.midiRpn=65535;return;case at.NonRegisteredParameterCourse:i.midiRpn=65535;return;case at.AllSoundOff:this.channelSoundsOffAll(t);return;case at.AllNotesOff:this.channelNoteOffAll(t);return;case at.ResetControllers:i.midiVolume=16383,i.midiExpression=16383,i.midiPan=8192,i.bank=0,this.channelSetVolume(t,1),this.channelSetPan(t,.5),this.channelSetPitchRange(t,2);return}}channelGetPresetIndex(t){return this._channels&&t<this._channels.channelList.length?this._channels.channelList[t].presetIndex:0}channelGetPresetBank(t){return this._channels&&t<this._channels.channelList.length?this._channels.channelList[t].bank&32767:0}channelGetPan(t){return this._channels&&t<this._channels.channelList.length?this._channels.channelList[t].panOffset-.5:.5}channelGetVolume(t){return this._channels&&t<this._channels.channelList.length?Yt.decibelsToGain(this._channels.channelList[t].gainDb):1}channelGetPitchWheel(t){return this._channels&&t<this._channels.channelList.length?this._channels.channelList[t].pitchWheel:8192}channelGetPitchRange(t){return this._channels&&t<this._channels.channelList.length?this._channels.channelList[t].pitchRange:2}channelGetTuning(t){return this._channels&&t<this._channels.channelList.length?this._channels.channelList[t].tuning:0}resetPresets(){this.presets=[]}loadPresets(t,e,s,i){const r=[];for(let a=0;a<t.phdrs.length-1;a++){const l=t.phdrs[a];let h=0;const c=new Yd;r.push(c),c.name=l.presetName,c.bank=l.bank,c.presetNumber=l.preset;let d=0;for(let p=l.presetBagNdx;p<t.phdrs[a+1].presetBagNdx;p++){const g=t.pbags[p];let m=0,y=127,S=0,k=127;for(let T=g.genNdx;T<t.pbags[p+1].genNdx;T++){const N=t.pgens[T];if(N.genOper===Os.GenKeyRange){m=N.genAmount.lowByteAmount,y=N.genAmount.highByteAmount;continue}if(N.genOper===Os.GenVelRange){S=N.genAmount.lowByteAmount,k=N.genAmount.highByteAmount;continue}if(N.genOper!==Os.GenInstrument||N.genAmount.wordAmount>=t.insts.length)continue;const F=t.insts[N.genAmount.wordAmount];for(let q=F.instBagNdx;q<t.insts[N.genAmount.wordAmount+1].instBagNdx;q++){const U=t.ibags[q];let x=0,j=127,Q=0,Te=127;for(let te=U.instGenNdx;te<t.ibags[q+1].instGenNdx;te++){const we=t.igens[te];if(we.genOper===Os.GenKeyRange){x=we.genAmount.lowByteAmount,j=we.genAmount.highByteAmount;continue}if(we.genOper===Os.GenVelRange){Q=we.genAmount.lowByteAmount,Te=we.genAmount.highByteAmount;continue}we.genOper===53&&j>=m&&x<=y&&Te>=S&&Q<=k&&d++}}}}c.regions=new Array(d);let u=new qi;u.clear(!0);for(let p=l.presetBagNdx;p<t.phdrs[a+1].presetBagNdx;p++){const g=t.pbags[p],m=new qi(u);let y=!1;for(let S=g.genNdx;S<t.pbags[p+1].genNdx;S++){const k=t.pgens[S];if(k.genOper===Os.GenInstrument){const T=k.genAmount.wordAmount;if(T>=t.insts.length)continue;let N=new qi;N.clear(!1);const F=t.insts[T];for(let q=F.instBagNdx;q<t.insts[T+1].instBagNdx;q++){const U=t.ibags[q],x=new qi(N);let j=!1;for(let Q=U.instGenNdx;Q<t.ibags[q+1].instGenNdx;Q++){const Te=t.igens[Q];if(Te.genOper===Os.GenSampleId){if(x.hiKey<m.loKey||x.loKey>m.hiKey||x.hiVel<m.loVel||x.loVel>m.hiVel)continue;m.loKey>x.loKey&&(x.loKey=m.loKey),m.hiKey<x.hiKey&&(x.hiKey=m.hiKey),m.loVel>x.loVel&&(x.loVel=m.loVel),m.hiVel<x.hiVel&&(x.hiVel=m.hiVel),x.offset+=m.offset,x.end+=m.end,x.loopStart+=m.loopStart,x.loopEnd+=m.loopEnd,x.transpose+=m.transpose,x.tune+=m.tune,x.pitchKeyTrack+=m.pitchKeyTrack,x.attenuation+=m.attenuation,x.pan+=m.pan,x.ampEnv.delay+=m.ampEnv.delay,x.ampEnv.attack+=m.ampEnv.attack,x.ampEnv.hold+=m.ampEnv.hold,x.ampEnv.decay+=m.ampEnv.decay,x.ampEnv.sustain+=m.ampEnv.sustain,x.ampEnv.release+=m.ampEnv.release,x.modEnv.delay+=m.modEnv.delay,x.modEnv.attack+=m.modEnv.attack,x.modEnv.hold+=m.modEnv.hold,x.modEnv.decay+=m.modEnv.decay,x.modEnv.sustain+=m.modEnv.sustain,x.modEnv.release+=m.modEnv.release,x.initialFilterQ+=m.initialFilterQ,x.initialFilterFc+=m.initialFilterFc,x.modEnvToPitch+=m.modEnvToPitch,x.modEnvToFilterFc+=m.modEnvToFilterFc,x.delayModLFO+=m.delayModLFO,x.freqModLFO+=m.freqModLFO,x.modLfoToPitch+=m.modLfoToPitch,x.modLfoToFilterFc+=m.modLfoToFilterFc,x.modLfoToVolume+=m.modLfoToVolume,x.delayVibLFO+=m.delayVibLFO,x.freqVibLFO+=m.freqVibLFO,x.vibLfoToPitch+=m.vibLfoToPitch,x.ampEnv.envToSecs(!0),x.modEnv.envToSecs(!1),x.delayModLFO=x.delayModLFO<-11950?0:Yt.timecents2Secs(x.delayModLFO),x.delayVibLFO=x.delayVibLFO<-11950?0:Yt.timecents2Secs(x.delayVibLFO),x.pan<-.5?x.pan=-.5:x.pan>.5&&(x.pan=.5),(x.initialFilterQ<1500||x.initialFilterQ>13500)&&(x.initialFilterQ=0);const te=t.sHdrs[Te.genAmount.wordAmount];x.offset+=te.start,x.end+=te.end,x.loopStart+=te.startLoop,x.loopEnd+=te.endLoop,te.endLoop>0&&(x.loopEnd-=1),x.pitchKeyCenter===-1&&(x.pitchKeyCenter=te.originalPitch),x.tune+=te.pitchCorrection,x.sampleRate=te.sampleRate;const we=l.bank===ye.PercussionBank;we&&So._setContainsRange(s,x.loKey,x.hiKey)||!we&&e.has(l.preset)?te.sampleType&1?(L.debug("AlphaSynth",`Loading of used sample ${te.sampleName} for preset ${l.presetName} (bank ${c.bank} program ${c.presetNumber})`),(te.sampleType&16)!==0?x.samples=t.decodeSamples(te.start,te.end,!0):(x.samples=t.decodeSamples(x.offset*2,x.end*2,!1),x.loopStart>0&&(x.loopStart-=x.offset),x.loopEnd>0&&(x.loopEnd-=x.offset)),x.offset=0,x.end=x.samples.length-1):(L.warning("AlphaSynth",`Skipping load of unsupported sample ${te.sampleName} for preset ${l.presetName}, sample type ${te.sampleType} is not supported (bank ${c.bank} program ${c.presetNumber})`),x.samples=new Float32Array(0)):(L.debug("AlphaSynth",`Skipping load of unused sample ${te.sampleName} for preset ${l.presetName} (bank ${c.bank} program ${c.presetNumber})`),x.samples=new Float32Array(0)),c.regions[h]=new qi(x),h++,j=!0}else x.operator(Te.genOper,Te.genAmount)}U===t.ibags[F.instBagNdx]&&!j&&(N=new qi(x))}y=!0}else m.operator(k.genOper,k.genAmount)}g===t.pbags[l.presetBagNdx]&&!y&&(u=m)}}if(!i||!this.presets)this.presets=r;else for(const a of r)this.presets.push(a)}static _setContainsRange(t,e,s){for(let i=e;i<=s;i++)if(t.has(i))return!0;return!1}hasSamplesForProgram(t){const e=this.presets;if(!e)return!1;for(const s of e)if(s.presetNumber===t){for(const i of s.regions)if(i.samples.length>0)return!0}return!1}hasSamplesForPercussion(t){const e=this.presets;if(!e)return!1;for(const s of e)if(s.bank===ye.PercussionBank){for(const i of s.regions)if(i.loKey>=t&&i.hiKey<=t&&i.samples.length>0)return!0}return!1}}class oh{constructor(t){o(this,"events");this.events=t}}class jr{constructor(t){o(this,"playbackRange");this.playbackRange=t}}class xc{constructor(){o(this,"soundFonts");o(this,"sampleRate",44100);o(this,"useSyncPoints",!1);o(this,"masterVolume",1);o(this,"metronomeVolume",0);o(this,"playbackRange");o(this,"trackVolume",new Map);o(this,"trackTranspositionPitches",new Map)}}class Nc{constructor(){o(this,"samples");o(this,"currentTime",0);o(this,"endTime",0);o(this,"currentTick",0);o(this,"endTick",0)}}class lh{constructor(t,e,s){o(this,"sequencer");o(this,"synthesizer");o(this,"isSoundFontLoaded",!1);o(this,"_isMidiLoaded",!1);o(this,"_tickPosition",0);o(this,"_timePosition",0);o(this,"_metronomeVolume",0);o(this,"_countInVolume",0);o(this,"playedEventsQueue",new nh);o(this,"midiEventsPlayedFilterSet",new Set);o(this,"_notPlayedSamples",0);o(this,"_synthStopping",!1);o(this,"_output");o(this,"_loadedMidiInfo");o(this,"_currentPosition",new ci(0,0,0,0,!1,120,120));o(this,"isReady",!1);o(this,"state",Ut.Paused);o(this,"_loadedSoundFonts",[]);o(this,"ready");o(this,"readyForPlayback",new Ct);o(this,"finished",new Ct);o(this,"soundFontLoaded",new Ct);o(this,"soundFontLoadFailed",new xe);o(this,"midiLoaded");o(this,"midiLoadFailed",new xe);o(this,"stateChanged");o(this,"positionChanged");o(this,"midiEventsPlayed",new xe);o(this,"playbackRangeChanged");L.debug("AlphaSynth","Initializing player"),this.state=Ut.Paused,this.ready=new Ct(()=>this.isReady),this.readyForPlayback=new Ct(()=>this.isReadyForPlayback),this.midiLoaded=new xe(()=>this._loadedMidiInfo?this._loadedMidiInfo:null),this.stateChanged=new xe(()=>new Br(this.state,!1)),this.positionChanged=new xe(()=>this._currentPosition),this.playbackRangeChanged=new xe(()=>this.playbackRange?new jr(this.playbackRange):null),L.debug("AlphaSynth","Creating output"),this._output=t,L.debug("AlphaSynth","Creating synthesizer"),this.synthesizer=e,this.sequencer=new wr(this.synthesizer),L.debug("AlphaSynth","Opening output"),this.output.ready.on(()=>{this.isReady=!0,this.ready.trigger(),this._checkReadyForPlayback()}),this.output.sampleRequest.on(()=>{this.onSampleRequest()}),this.output.samplesPlayed.on(this._onSamplesPlayed.bind(this)),this.output.open(s)}get output(){return this._output}get isReadyForPlayback(){return this.isReady&&this.isSoundFontLoaded&&this._isMidiLoaded}get logLevel(){return L.logLevel}set logLevel(t){L.logLevel=t}get masterVolume(){return this.synthesizer.masterVolume}set masterVolume(t){t=Math.max(t,ye.MinVolume),this.updateMasterVolume(t)}updateMasterVolume(t){this.synthesizer.masterVolume=t}get metronomeVolume(){return this._metronomeVolume}set metronomeVolume(t){t=Math.max(t,ye.MinVolume),this._metronomeVolume=t,this.synthesizer.metronomeVolume=t}get countInVolume(){return this._countInVolume}set countInVolume(t){t=Math.max(t,ye.MinVolume),this._countInVolume=t}get midiEventsPlayedFilter(){return Array.from(this.midiEventsPlayedFilterSet)}set midiEventsPlayedFilter(t){this.midiEventsPlayedFilterSet=new Set(t)}get playbackSpeed(){return this.sequencer.playbackSpeed}set playbackSpeed(t){t=A.clamp(t,ye.MinPlaybackSpeed,ye.MaxPlaybackSpeed),this.updatePlaybackSpeed(t)}updatePlaybackSpeed(t){const e=this.sequencer.playbackSpeed;this.sequencer.playbackSpeed=t,this.timePosition=this.timePosition*(e/t)}get loadedMidiInfo(){return this._loadedMidiInfo}get currentPosition(){return this._currentPosition}get tickPosition(){return this._tickPosition}set tickPosition(t){this.timePosition=this.sequencer.mainTickPositionToTimePosition(t)}get timePosition(){return this._timePosition}set timePosition(t){L.debug("AlphaSynth",`Seeking to position ${t}ms (main)`),this.sequencer.mainSeek(t),this.updateTimePosition(t,!0),this.sequencer.isPlayingMain&&(this._notPlayedSamples=0,this.output.resetSamples())}get playbackRange(){return this.sequencer.mainPlaybackRange}set playbackRange(t){this.sequencer.mainPlaybackRange=t,t&&(this.tickPosition=t.startTick),this.playbackRangeChanged.trigger(new jr(t))}get isLooping(){return this.sequencer.isLooping}set isLooping(t){this.sequencer.isLooping=t}destroy(){L.debug("AlphaSynth","Destroying player"),this.stop(),this.output.destroy()}onSampleRequest(){if(this.state===Ut.Playing&&(!this.sequencer.isFinished||this.synthesizer.activeVoiceCount>0)){let t=new Float32Array(ye.MicroBufferSize*ye.MicroBufferCount*ye.AudioChannels),e=0;for(let s=0;s<ye.MicroBufferCount;s++){this.sequencer.fillMidiEventQueue();const i=this.synthesizer.synthesize(t,e,ye.MicroBufferSize);e+=ye.MicroBufferSize*ye.AudioChannels;for(const r of i)this.midiEventsPlayedFilterSet.has(r.event.type)&&this.playedEventsQueue.enqueue(r);if(this.sequencer.isFinished)break}e<t.length&&(t=t.subarray(0,e)),this._notPlayedSamples+=t.length,this.output.addSamples(t)}else{const t=new Float32Array(0);this.output.addSamples(t)}}play(){return this.state!==Ut.Paused||!this._isMidiLoaded?!1:(this.output.activate(),this._playInternal(),this._countInVolume>0&&(L.debug("AlphaSynth","Starting countin"),this.sequencer.startCountIn(),this.synthesizer.setupMetronomeChannel(this._countInVolume),this.updateTimePosition(0,!0)),this.output.play(),!0)}_playInternal(){this.sequencer.isPlayingOneTimeMidi&&(L.debug("AlphaSynth","Cancelling one time midi"),this._stopOneTimeMidi()),L.debug("AlphaSynth","Starting playback"),this.synthesizer.setupMetronomeChannel(this.metronomeVolume),this._synthStopping=!1,this.state=Ut.Playing,this.stateChanged.trigger(new Br(this.state,!1))}pause(){this.state===Ut.Paused||!this._isMidiLoaded||(L.debug("AlphaSynth","Pausing playback"),this.state=Ut.Paused,this.stateChanged.trigger(new Br(this.state,!1)),this.output.pause(),this.synthesizer.noteOffAll(!1))}playPause(){this.state!==Ut.Paused||!this._isMidiLoaded?this.pause():this.play()}stop(){this._isMidiLoaded&&(L.debug("AlphaSynth","Stopping playback"),this.state=Ut.Paused,this.output.pause(),this._notPlayedSamples=0,this.sequencer.stop(),this.synthesizer.noteOffAll(!0),this.tickPosition=this.sequencer.mainPlaybackRange?this.sequencer.mainPlaybackRange.startTick:0,this.stateChanged.trigger(new Br(this.state,!0)))}playOneTimeMidiFile(t){this.sequencer.isPlayingOneTimeMidi?this._stopOneTimeMidi():this.pause(),this.sequencer.loadOneTimeMidi(t),this.synthesizer.noteOffAll(!0),this.updateTimePosition(0,!0),this._notPlayedSamples=0,this.output.resetSamples(),this.output.play()}resetSoundFonts(){this.stop(),this.synthesizer.resetPresets(),this._loadedSoundFonts=[],this.isSoundFontLoaded=!1,this.soundFontLoaded.trigger()}loadSoundFont(t,e){this.pause();const s=wt.fromBuffer(t);try{L.debug("AlphaSynth","Loading soundfont from bytes");const i=new Bc;i.load(s),e||(this._loadedSoundFonts=[]),this._loadedSoundFonts.push(i),this.isSoundFontLoaded=!0,this.soundFontLoaded.trigger(),L.debug("AlphaSynth","soundFont successfully loaded"),this._checkReadyForPlayback()}catch(i){L.error("AlphaSynth",`Could not load soundfont from bytes ${i}`),this.soundFontLoadFailed.trigger(i)}}_checkReadyForPlayback(){if(this.isReadyForPlayback){this.synthesizer.setupMetronomeChannel(this.metronomeVolume);const t=this.sequencer.instrumentPrograms,e=this.sequencer.percussionKeys;let s=!1;for(const i of this._loadedSoundFonts)this.synthesizer.loadPresets(i,t,e,s),s=!0;this.readyForPlayback.trigger()}}loadMidiFile(t){this.stop();try{L.debug("AlphaSynth","Loading midi from model"),this.sequencer.loadMidi(t),this._isMidiLoaded=!0,this._loadedMidiInfo=new ci(0,this.sequencer.currentEndTime,0,this.sequencer.currentEndTick,!1,this.sequencer.currentTempo,this.sequencer.modifiedTempo),this.midiLoaded.trigger(this._loadedMidiInfo),L.debug("AlphaSynth","Midi successfully loaded"),this._checkReadyForPlayback(),this.tickPosition=0}catch(e){L.error("AlphaSynth",`Could not load midi from model ${e}`),this.midiLoadFailed.trigger(e)}}applyTranspositionPitches(t){this.synthesizer.applyTranspositionPitches(t)}setChannelTranspositionPitch(t,e){this.synthesizer.setChannelTranspositionPitch(t,e)}setChannelMute(t,e){this.synthesizer.channelSetMute(t,e)}resetChannelStates(){this.synthesizer.resetChannelStates()}setChannelSolo(t,e){this.synthesizer.channelSetSolo(t,e)}setChannelVolume(t,e){e=Math.max(e,ye.MinVolume),this.synthesizer.channelSetMixVolume(t,e)}_onSamplesPlayed(t){if(t===0)return;const e=t/this.synthesizer.outSampleRate*1e3;this._notPlayedSamples-=t*ye.AudioChannels,this.updateTimePosition(this._timePosition+e,!1),this.checkForFinish()}checkForFinish(){let t=0,e=0;this.playbackRange&&this.sequencer.isPlayingMain?(t=this.playbackRange.startTick,e=this.playbackRange.endTick):e=this.sequencer.currentEndTick,this._tickPosition>=e&&(this._notPlayedSamples<=0?(this._notPlayedSamples=0,this.sequencer.isPlayingCountIn?(L.debug("AlphaSynth","Finished playback (count-in)"),this.sequencer.resetCountIn(),this.timePosition=this.sequencer.currentTime,this._playInternal(),this.output.resetSamples()):this.sequencer.isPlayingOneTimeMidi?(L.debug("AlphaSynth","Finished playback (one time)"),this.output.resetSamples(),this.state=Ut.Paused,this._stopOneTimeMidi()):this.isLooping?(L.debug("AlphaSynth","Finished playback (main looping)"),this.finished.trigger(),this.tickPosition=t,this._synthStopping=!1):this.synthesizer.activeVoiceCount>0?this._synthStopping||(L.debug("AlphaSynth","Signaling synth to stop all voices (all samples played)"),this.synthesizer.noteOffAll(!0),this._synthStopping=!0):(this._synthStopping=!1,L.debug("AlphaSynth","Finished playback (main)"),this.finished.trigger(),this.stop())):this._synthStopping||(L.debug("AlphaSynth","Signaling synth to stop all voices (not all samples played)"),this.synthesizer.noteOffAll(!0),this._synthStopping=!0))}_stopOneTimeMidi(){this.output.pause(),this.synthesizer.noteOffAll(!0),this.sequencer.resetOneTimeMidi(),this.timePosition=this.sequencer.currentTime}_createPositionChangedEventArgs(t){let e=this._timePosition,s=this.sequencer.currentTimePositionToTickPosition(e);const i=this.sequencer.currentEndTime,r=this.sequencer.currentEndTick;return e>i&&(e=i,s=r),new ci(e,i,s,r,t,this.sequencer.currentTempo,this.sequencer.modifiedTempo)}updateTimePosition(t,e){this._timePosition=t;const s=this._createPositionChangedEventArgs(e);this._tickPosition=s.currentTick;const i=this.sequencer.isPlayingMain?"main":this.sequencer.isPlayingCountIn?"count-in":"one-time";if(L.debug("AlphaSynth",`Position changed: (time: ${s.currentTime}/${s.endTime}, tick: ${s.currentTick}/${s.endTick}, Active Voices: ${this.synthesizer.activeVoiceCount} (${i}), Tempo original: ${this.sequencer.currentTempo}, Tempo modified: ${this.sequencer.modifiedTempo})`),this.sequencer.isPlayingMain&&(this._currentPosition=s,this.positionChanged.trigger(s)),e)this.playedEventsQueue.clear();else{const r=[];for(;!this.playedEventsQueue.isEmpty&&this.playedEventsQueue.peek().time<s.currentTime;){const a=this.playedEventsQueue.dequeue();r.push(a.event)}r.length>0&&(r.reverse(),this.midiEventsPlayed.trigger(new oh(r)))}}hasSamplesForProgram(t){return this.synthesizer.hasSamplesForProgram(t)}hasSamplesForPercussion(t){return this.synthesizer.hasSamplesForPercussion(t)}loadBackingTrack(t){}updateSyncPoints(t){}}class Pc extends lh{constructor(t,e){super(t,new So(t.sampleRate),e)}exportAudio(t,e,s,i){const r=new Xd(t);r.loadMidiFile(e),t.useSyncPoints&&r.updateSyncPoints(s),r.applyTranspositionPitches(i);for(const[a,l]of t.trackTranspositionPitches)r.setChannelTranspositionPitch(a,l);for(const[a,l]of t.trackVolume)r.channelSetMixVolume(a,l);if(t.soundFonts)for(const a of t.soundFonts)r.loadSoundFont(a);else r.loadPresets(this.synthesizer.presets);return t.playbackRange&&r.limitExport(t.playbackRange),r.setup(),r}}class Xd{constructor(t){o(this,"_synth");o(this,"_sequencer");o(this,"_generatedAudioCurrentTime",0);o(this,"_generatedAudioEndTime",0);this._synth=new So(t.sampleRate),this._sequencer=new wr(this._synth),this._synth.masterVolume=Math.max(t.masterVolume,ye.MinVolume),this._synth.metronomeVolume=Math.max(t.metronomeVolume,ye.MinVolume)}loadSoundFont(t){const e=wt.fromBuffer(t),s=new Bc;s.load(e);const i=this._sequencer.instrumentPrograms,r=this._sequencer.percussionKeys;this._synth.loadPresets(s,i,r,!0)}loadPresets(t){this._synth.presets=t}limitExport(t){this._sequencer.mainPlaybackRange=t,this._sequencer.mainSeek(this._sequencer.mainTickPositionToTimePosition(t.startTick))}setChannelTranspositionPitch(t,e){this._synth.setChannelTranspositionPitch(t,e)}applyTranspositionPitches(t){this._synth.applyTranspositionPitches(t)}loadMidiFile(t){this._sequencer.loadMidi(t)}updateSyncPoints(t){this._sequencer.mainUpdateSyncPoints(t)}channelSetMixVolume(t,e){e=Math.max(e,ye.MinVolume),this._synth.channelSetMixVolume(t,e)}setup(){this._synth.setupMetronomeChannel(this._synth.metronomeVolume);const t=this._sequencer.currentSyncPoints,e=this._sequencer.currentEndTime;if(t.length===0)this._generatedAudioEndTime=e;else{const s=t[t.length-1];let i=s.syncTime;const r=this._sequencer.currentEndTick-s.synthTick;r>0&&(i+=D.ticksToMillis(r,s.syncBpm)),this._generatedAudioEndTime=i}}render(t){if(this._sequencer.isFinished)return;const e=ye.MicroBufferSize*1e3/this._synth.outSampleRate,s=Math.ceil(t/e);let i=new Float32Array(ye.MicroBufferSize*s*ye.AudioChannels);const r=this._sequencer.currentSyncPoints;let a=0,l=this._generatedAudioCurrentTime;for(let c=0;c<s;c++){if(r.length>0){this._sequencer.currentUpdateSyncPoints(l),this._sequencer.currentUpdateCurrentTempo(this._sequencer.currentTime);const d=this._sequencer.syncPointTempo/this._sequencer.currentTempo;this._sequencer.playbackSpeed!==d&&(this._sequencer.playbackSpeed=d)}if(this._sequencer.fillMidiEventQueue(),this._synth.synthesize(i,a,ye.MicroBufferSize),a+=ye.MicroBufferSize*ye.AudioChannels,l+=e,this._sequencer.isFinished)break}a<i.length&&(i=i.subarray(0,a));const h=new Nc;return h.currentTime=this._generatedAudioCurrentTime,h.endTime=this._generatedAudioEndTime,h.currentTick=this._sequencer.currentTimePositionToTickPosition(this._sequencer.currentTime),h.endTick=this._sequencer.currentEndTick,this._generatedAudioCurrentTime+=t,h.samples=i,this._sequencer.isFinished&&this._synth.noteOffAll(!0),h}}class P{static parseEnum(t,e){switch(typeof t){case"string":const s=Number.parseInt(t,10);return Number.isNaN(s)?e[Object.keys(e).find(i=>i.toLowerCase()===t.toLowerCase())]:s;case"number":return t;case"undefined":case"object":return}throw new Xe(ze.Format,`Could not parse enum value '${t}'`)}static parseEnumExact(t,e){if(t in e)return e[t]}static forEach(t,e){if(t instanceof Map)t.forEach(e);else if(typeof t=="object")for(const s in t)e(t[s],s)}static getValue(t,e){return t instanceof Map?t.get(e):typeof t=="object"?t[e]:null}}class wn{static fromJson(t,e){e&&P.forEach(e,(s,i)=>wn.setProperty(t,i,s))}static toJson(t){if(!t)return null;const e=new Map;{const s=new Map;e.set("groups",s);for(const[i,r]of t.groups)s.set(i.toString(),r)}return e}static setProperty(t,e,s){switch(e){case"groups":return t.groups=new Map,P.forEach(s,(i,r)=>{t.groups.set(P.parseEnum(r,b),i)}),!0}return!1}}class Bn{static fromJson(t,e){e&&P.forEach(e,(s,i)=>Bn.setProperty(t,i,s))}static toJson(t){if(!t)return null;const e=new Map;return e.set("marker",t.marker),e.set("text",t.text),e}static setProperty(t,e,s){switch(e){case"marker":return t.marker=s,!0;case"text":return t.text=s,!0}return!1}}class Tn{static fromJson(t,e){e&&P.forEach(e,(s,i)=>Tn.setProperty(t,i,s))}static toJson(t){if(!t)return null;const e=new Map;return e.set("baroccurence",t.barOccurence),e.set("millisecondoffset",t.millisecondOffset),e}static setProperty(t,e,s){switch(e){case"baroccurence":return t.barOccurence=s,!0;case"millisecondoffset":return t.millisecondOffset=s,!0}return!1}}class rr{static fromJson(t,e){e&&P.forEach(e,(s,i)=>rr.setProperty(t,i,s))}static toJson(t){if(!t)return null;const e=new Map;return e.set("islinear",t.isLinear),e.set("type",t.type),e.set("value",t.value),t.syncPointValue&&e.set("syncpointvalue",Tn.toJson(t.syncPointValue)),e.set("ratioposition",t.ratioPosition),e.set("text",t.text),e.set("isvisible",t.isVisible),e}static setProperty(t,e,s){switch(e){case"islinear":return t.isLinear=s,!0;case"type":return t.type=P.parseEnum(s,Ve),!0;case"value":return t.value=s,!0;case"syncpointvalue":return s?(t.syncPointValue=new ja,Tn.fromJson(t.syncPointValue,s)):t.syncPointValue=void 0,!0;case"ratioposition":return t.ratioPosition=s,!0;case"text":return t.text=s,!0;case"isvisible":return t.isVisible=s,!0}return!1}}class xn{static fromJson(t,e){e&&P.forEach(e,(s,i)=>xn.setProperty(t,i,s))}static toJson(t){if(!t)return null;const e=new Map;return e.set("type",t.type),e.set("length",t.length),e}static setProperty(t,e,s){switch(e){case"type":return t.type=P.parseEnum(s,Ss),!0;case"length":return t.length=s,!0}return!1}}class Nn{static fromJson(t,e){e&&P.forEach(e,(s,i)=>Nn.setProperty(t,i,s))}static toJson(t){var s;if(!t)return null;const e=new Map;if(e.set("alternateendings",t.alternateEndings),e.set("isdoublebar",t.isDoubleBar),e.set("isrepeatstart",t.isRepeatStart),e.set("repeatcount",t.repeatCount),e.set("timesignaturenumerator",t.timeSignatureNumerator),e.set("timesignaturedenominator",t.timeSignatureDenominator),e.set("timesignaturecommon",t.timeSignatureCommon),t.beamingRules&&e.set("beamingrules",wn.toJson(t.beamingRules)),e.set("isfreetime",t.isFreeTime),e.set("tripletfeel",t.tripletFeel),t.section&&e.set("section",Bn.toJson(t.section)),e.set("tempoautomations",t.tempoAutomations.map(i=>rr.toJson(i))),t.syncPoints!==void 0&&e.set("syncpoints",(s=t.syncPoints)==null?void 0:s.map(i=>rr.toJson(i))),t.fermata!==null){const i=new Map;e.set("fermata",i);for(const[r,a]of t.fermata)i.set(r.toString(),xn.toJson(a))}if(e.set("start",t.start),e.set("isanacrusis",t.isAnacrusis),e.set("displayscale",t.displayScale),e.set("displaywidth",t.displayWidth),t.directions!==null){const i=[];e.set("directions",i);for(const r of t.directions)i.push(r)}return e}static setProperty(t,e,s){switch(e){case"alternateendings":return t.alternateEndings=s,!0;case"isdoublebar":return t.isDoubleBar=s,!0;case"isrepeatstart":return t.isRepeatStart=s,!0;case"repeatcount":return t.repeatCount=s,!0;case"timesignaturenumerator":return t.timeSignatureNumerator=s,!0;case"timesignaturedenominator":return t.timeSignatureDenominator=s,!0;case"timesignaturecommon":return t.timeSignatureCommon=s,!0;case"beamingrules":return s?(t.beamingRules=new dt,wn.fromJson(t.beamingRules,s)):t.beamingRules=void 0,!0;case"isfreetime":return t.isFreeTime=s,!0;case"tripletfeel":return t.tripletFeel=P.parseEnum(s,Me),!0;case"section":return s?(t.section=new aa,Bn.fromJson(t.section,s)):t.section=null,!0;case"tempoautomations":t.tempoAutomations=[];for(const i of s){const r=new nt;rr.fromJson(r,i),t.tempoAutomations.push(r)}return!0;case"syncpoints":if(s){t.syncPoints=[];for(const i of s){const r=new nt;rr.fromJson(r,i),t.addSyncPoint(r)}}return!0;case"fermata":return t.fermata=new Map,P.forEach(s,(i,r)=>{const a=new ra;xn.fromJson(a,i),t.addFermata(Number.parseInt(r),a)}),!0;case"start":return t.start=s,!0;case"isanacrusis":return t.isAnacrusis=s,!0;case"displayscale":return t.displayScale=s,!0;case"displaywidth":return t.displayWidth=s,!0;case"directions":for(const i of s)t.addDirection(P.parseEnum(i,G));return!0}return!1}}class ea{static fromJson(t,e){e&&P.forEach(e,(s,i)=>ea.setProperty(t,i,s))}static toJson(t){if(!t)return null;const e=new Map;return e.set("offset",t.offset),e.set("value",t.value),e}static setProperty(t,e,s){switch(e){case"offset":return t.offset=s,!0;case"value":return t.value=s,!0}return!1}}class Pn{static fromJson(t,e){e&&P.forEach(e,(s,i)=>Pn.setProperty(t,i,s))}static toJson(t){if(!t)return null;const e=new Map;e.set("notehead",t.noteHead),e.set("noteheadcenteronstem",t.noteHeadCenterOnStem);{const s=new Map;e.set("colors",s);for(const[i,r]of t.colors)s.set(i.toString(),qe.toJson(r))}return e}static setProperty(t,e,s){switch(e){case"notehead":return t.noteHead=P.parseEnum(s,f),!0;case"noteheadcenteronstem":return t.noteHeadCenterOnStem=s,!0;case"colors":return t.colors=new Map,P.forEach(s,(i,r)=>{t.colors.set(P.parseEnum(r,ns),qe.fromJson(i))}),!0}return!1}}class Cn{static fromJson(t,e){e&&P.forEach(e,(s,i)=>Cn.setProperty(t,i,s))}static toJson(t){var s;if(!t)return null;const e=new Map;return e.set("id",t.id),e.set("accentuated",t.accentuated),e.set("bendtype",t.bendType),e.set("bendstyle",t.bendStyle),e.set("iscontinuedbend",t.isContinuedBend),t.bendPoints!==null&&e.set("bendpoints",(s=t.bendPoints)==null?void 0:s.map(i=>ea.toJson(i))),e.set("fret",t.fret),e.set("string",t.string),e.set("showstringnumber",t.showStringNumber),e.set("octave",t.octave),e.set("tone",t.tone),e.set("percussionarticulation",t.percussionArticulation),e.set("isvisible",t.isVisible),e.set("islefthandtapped",t.isLeftHandTapped),e.set("ishammerpullorigin",t.isHammerPullOrigin),e.set("isslurdestination",t.isSlurDestination),e.set("harmonictype",t.harmonicType),e.set("harmonicvalue",t.harmonicValue),e.set("isghost",t.isGhost),e.set("isletring",t.isLetRing),e.set("ispalmmute",t.isPalmMute),e.set("isdead",t.isDead),e.set("isstaccato",t.isStaccato),e.set("slideintype",t.slideInType),e.set("slideouttype",t.slideOutType),e.set("vibrato",t.vibrato),e.set("istiedestination",t.isTieDestination),e.set("lefthandfinger",t.leftHandFinger),e.set("righthandfinger",t.rightHandFinger),e.set("trillvalue",t.trillValue),e.set("trillspeed",t.trillSpeed),e.set("durationpercent",t.durationPercent),e.set("accidentalmode",t.accidentalMode),e.set("dynamics",t.dynamics),e.set("ornament",t.ornament),t.style&&e.set("style",Pn.toJson(t.style)),t.toJson(e),e}static setProperty(t,e,s){switch(e){case"id":return t.id=s,!0;case"accentuated":return t.accentuated=P.parseEnum(s,mt),!0;case"bendtype":return t.bendType=P.parseEnum(s,J),!0;case"bendstyle":return t.bendStyle=P.parseEnum(s,tt),!0;case"iscontinuedbend":return t.isContinuedBend=s,!0;case"bendpoints":if(s){t.bendPoints=[];for(const i of s){const r=new H;ea.fromJson(r,i),t.addBendPoint(r)}}return!0;case"fret":return t.fret=s,!0;case"string":return t.string=s,!0;case"showstringnumber":return t.showStringNumber=s,!0;case"octave":return t.octave=s,!0;case"tone":return t.tone=s,!0;case"percussionarticulation":return t.percussionArticulation=s,!0;case"isvisible":return t.isVisible=s,!0;case"islefthandtapped":return t.isLeftHandTapped=s,!0;case"ishammerpullorigin":return t.isHammerPullOrigin=s,!0;case"isslurdestination":return t.isSlurDestination=s,!0;case"harmonictype":return t.harmonicType=P.parseEnum(s,ie),!0;case"harmonicvalue":return t.harmonicValue=s,!0;case"isghost":return t.isGhost=s,!0;case"isletring":return t.isLetRing=s,!0;case"ispalmmute":return t.isPalmMute=s,!0;case"isdead":return t.isDead=s,!0;case"isstaccato":return t.isStaccato=s,!0;case"slideintype":return t.slideInType=P.parseEnum(s,Et),!0;case"slideouttype":return t.slideOutType=P.parseEnum(s,ge),!0;case"vibrato":return t.vibrato=P.parseEnum(s,Ee),!0;case"istiedestination":return t.isTieDestination=s,!0;case"lefthandfinger":return t.leftHandFinger=P.parseEnum(s,ae),!0;case"righthandfinger":return t.rightHandFinger=P.parseEnum(s,ae),!0;case"trillvalue":return t.trillValue=s,!0;case"trillspeed":return t.trillSpeed=P.parseEnum(s,b),!0;case"durationpercent":return t.durationPercent=s,!0;case"accidentalmode":return t.accidentalMode=P.parseEnum(s,de),!0;case"dynamics":return t.dynamics=P.parseEnum(s,re),!0;case"ornament":return t.ornament=P.parseEnum(s,ut),!0;case"style":return s?(t.style=new Il,Pn.fromJson(t.style,s)):t.style=void 0,!0}return t.setProperty(e,s)}}class En{static fromJson(t,e){e&&P.forEach(e,(s,i)=>En.setProperty(t,i,s))}static toJson(t){if(!t)return null;const e=new Map;return e.set("marks",t.marks),e.set("style",t.style),e}static setProperty(t,e,s){switch(e){case"marks":return t.marks=s,!0;case"style":return t.style=P.parseEnum(s,zi),!0}return!1}}class vn{static fromJson(t,e){e&&P.forEach(e,(s,i)=>vn.setProperty(t,i,s))}static toJson(t){if(!t)return null;const e=new Map;{const s=new Map;e.set("colors",s);for(const[i,r]of t.colors)s.set(i.toString(),qe.toJson(r))}return e}static setProperty(t,e,s){switch(e){case"colors":return t.colors=new Map,P.forEach(s,(i,r)=>{t.colors.set(P.parseEnum(r,ht),qe.fromJson(i))}),!0}return!1}}class Dn{static fromJson(t,e){e&&P.forEach(e,(s,i)=>Dn.setProperty(t,i,s))}static toJson(t){var s;if(!t)return null;const e=new Map;return e.set("id",t.id),e.set("notes",t.notes.map(i=>Cn.toJson(i))),e.set("isempty",t.isEmpty),e.set("whammystyle",t.whammyStyle),e.set("ottava",t.ottava),e.set("islegatoorigin",t.isLegatoOrigin),e.set("duration",t.duration),e.set("automations",t.automations.map(i=>rr.toJson(i))),e.set("dots",t.dots),e.set("fade",t.fade),e.set("lyrics",t.lyrics),e.set("pop",t.pop),e.set("slap",t.slap),e.set("tap",t.tap),e.set("text",t.text),e.set("slashed",t.slashed),e.set("deadslapped",t.deadSlapped),e.set("brushtype",t.brushType),e.set("brushduration",t.brushDuration),e.set("tupletdenominator",t.tupletDenominator),e.set("tupletnumerator",t.tupletNumerator),e.set("iscontinuedwhammy",t.isContinuedWhammy),e.set("whammybartype",t.whammyBarType),t.whammyBarPoints!==null&&e.set("whammybarpoints",(s=t.whammyBarPoints)==null?void 0:s.map(i=>ea.toJson(i))),e.set("vibrato",t.vibrato),e.set("chordid",t.chordId),e.set("gracetype",t.graceType),e.set("pickstroke",t.pickStroke),t.tremoloPicking&&e.set("tremolopicking",En.toJson(t.tremoloPicking)),e.set("crescendo",t.crescendo),e.set("displaystart",t.displayStart),e.set("playbackstart",t.playbackStart),e.set("displayduration",t.displayDuration),e.set("playbackduration",t.playbackDuration),e.set("overridedisplayduration",t.overrideDisplayDuration),e.set("golpe",t.golpe),e.set("dynamics",t.dynamics),e.set("invertbeamdirection",t.invertBeamDirection),e.set("preferredbeamdirection",t.preferredBeamDirection),e.set("beamingmode",t.beamingMode),e.set("wahpedal",t.wahPedal),e.set("barrefret",t.barreFret),e.set("barreshape",t.barreShape),e.set("rasgueado",t.rasgueado),e.set("showtimer",t.showTimer),e.set("timer",t.timer),t.style&&e.set("style",vn.toJson(t.style)),e}static setProperty(t,e,s){switch(e){case"id":return t.id=s,!0;case"notes":t.notes=[];for(const i of s){const r=new Ps;Cn.fromJson(r,i),t.addNote(r)}return!0;case"isempty":return t.isEmpty=s,!0;case"whammystyle":return t.whammyStyle=P.parseEnum(s,tt),!0;case"ottava":return t.ottava=P.parseEnum(s,pe),!0;case"islegatoorigin":return t.isLegatoOrigin=s,!0;case"duration":return t.duration=P.parseEnum(s,b),!0;case"automations":t.automations=[];for(const i of s){const r=new nt;rr.fromJson(r,i),t.automations.push(r)}return!0;case"dots":return t.dots=s,!0;case"fade":return t.fade=P.parseEnum(s,Nt),!0;case"lyrics":return t.lyrics=s,!0;case"pop":return t.pop=s,!0;case"slap":return t.slap=s,!0;case"tap":return t.tap=s,!0;case"text":return t.text=s,!0;case"slashed":return t.slashed=s,!0;case"deadslapped":return t.deadSlapped=s,!0;case"brushtype":return t.brushType=P.parseEnum(s,Y),!0;case"brushduration":return t.brushDuration=s,!0;case"tupletdenominator":return t.tupletDenominator=s,!0;case"tupletnumerator":return t.tupletNumerator=s,!0;case"iscontinuedwhammy":return t.isContinuedWhammy=s,!0;case"whammybartype":return t.whammyBarType=P.parseEnum(s,De),!0;case"whammybarpoints":if(s){t.whammyBarPoints=[];for(const i of s){const r=new H;ea.fromJson(r,i),t.addWhammyBarPoint(r)}}return!0;case"vibrato":return t.vibrato=P.parseEnum(s,Ee),!0;case"chordid":return t.chordId=s,!0;case"gracetype":return t.graceType=P.parseEnum(s,ee),!0;case"pickstroke":return t.pickStroke=P.parseEnum(s,Ot),!0;case"tremolopicking":return s?(t.tremoloPicking=new Ns,En.fromJson(t.tremoloPicking,s)):t.tremoloPicking=void 0,!0;case"crescendo":return t.crescendo=P.parseEnum(s,Jt),!0;case"displaystart":return t.displayStart=s,!0;case"playbackstart":return t.playbackStart=s,!0;case"displayduration":return t.displayDuration=s,!0;case"playbackduration":return t.playbackDuration=s,!0;case"overridedisplayduration":return t.overrideDisplayDuration=s,!0;case"golpe":return t.golpe=P.parseEnum(s,as),!0;case"dynamics":return t.dynamics=P.parseEnum(s,re),!0;case"invertbeamdirection":return t.invertBeamDirection=s,!0;case"preferredbeamdirection":return t.preferredBeamDirection=P.parseEnum(s,E)??null,!0;case"beamingmode":return t.beamingMode=P.parseEnum(s,ot),!0;case"wahpedal":return t.wahPedal=P.parseEnum(s,ps),!0;case"barrefret":return t.barreFret=s,!0;case"barreshape":return t.barreShape=P.parseEnum(s,Hs),!0;case"rasgueado":return t.rasgueado=P.parseEnum(s,le),!0;case"showtimer":return t.showTimer=s,!0;case"timer":return t.timer=s,!0;case"style":return s?(t.style=new yc,vn.fromJson(t.style,s)):t.style=void 0,!0}return!1}}class Ln{static fromJson(t,e){e&&P.forEach(e,(s,i)=>Ln.setProperty(t,i,s))}static toJson(t){if(!t)return null;const e=new Map;{const s=new Map;e.set("colors",s);for(const[i,r]of t.colors)s.set(i.toString(),qe.toJson(r))}return e}static setProperty(t,e,s){switch(e){case"colors":return t.colors=new Map,P.forEach(s,(i,r)=>{t.colors.set(P.parseEnum(r,Zr),qe.fromJson(i))}),!0}return!1}}class Mn{static fromJson(t,e){e&&P.forEach(e,(s,i)=>Mn.setProperty(t,i,s))}static toJson(t){if(!t)return null;const e=new Map;return e.set("id",t.id),e.set("beats",t.beats.map(s=>Dn.toJson(s))),t.style&&e.set("style",Ln.toJson(t.style)),e}static setProperty(t,e,s){switch(e){case"id":return t.id=s,!0;case"beats":t.beats=[];for(const i of s){const r=new qt;Dn.fromJson(r,i),t.addBeat(r)}return!0;case"style":return s?(t.style=new gc,Ln.fromJson(t.style,s)):t.style=void 0,!0}return!1}}class Fn{static fromJson(t,e){e&&P.forEach(e,(s,i)=>Fn.setProperty(t,i,s))}static toJson(t){if(!t)return null;const e=new Map;return e.set("ratioposition",t.ratioPosition),e.set("pedaltype",t.pedalType),e}static setProperty(t,e,s){switch(e){case"ratioposition":return t.ratioPosition=s,!0;case"pedaltype":return t.pedalType=P.parseEnum(s,lt),!0}return!1}}class An{static fromJson(t,e){e&&P.forEach(e,(s,i)=>An.setProperty(t,i,s))}static toJson(t){if(!t)return null;const e=new Map;{const s=new Map;e.set("colors",s);for(const[i,r]of t.colors)s.set(i.toString(),qe.toJson(r))}return e}static setProperty(t,e,s){switch(e){case"colors":return t.colors=new Map,P.forEach(s,(i,r)=>{t.colors.set(P.parseEnum(r,Ae),qe.fromJson(i))}),!0}return!1}}class In{static fromJson(t,e){e&&P.forEach(e,(s,i)=>In.setProperty(t,i,s))}static toJson(t){if(!t)return null;const e=new Map;return e.set("id",t.id),e.set("clef",t.clef),e.set("clefottava",t.clefOttava),e.set("voices",t.voices.map(s=>Mn.toJson(s))),e.set("similemark",t.simileMark),e.set("displayscale",t.displayScale),e.set("displaywidth",t.displayWidth),e.set("sustainpedals",t.sustainPedals.map(s=>Fn.toJson(s))),e.set("barlineleft",t.barLineLeft),e.set("barlineright",t.barLineRight),e.set("keysignature",t.keySignature),e.set("keysignaturetype",t.keySignatureType),e.set("barnumberdisplay",t.barNumberDisplay),t.style&&e.set("style",An.toJson(t.style)),e}static setProperty(t,e,s){switch(e){case"id":return t.id=s,!0;case"clef":return t.clef=P.parseEnum(s,Fe),!0;case"clefottava":return t.clefOttava=P.parseEnum(s,pe),!0;case"voices":t.voices=[];for(const i of s){const r=new Fs;Mn.fromJson(r,i),t.addVoice(r)}return!0;case"similemark":return t.simileMark=P.parseEnum(s,At),!0;case"displayscale":return t.displayScale=s,!0;case"displaywidth":return t.displayWidth=s,!0;case"sustainpedals":t.sustainPedals=[];for(const i of s){const r=new Vi;Fn.fromJson(r,i),t.sustainPedals.push(r)}return!0;case"barlineleft":return t.barLineLeft=P.parseEnum(s,Be),!0;case"barlineright":return t.barLineRight=P.parseEnum(s,Be),!0;case"keysignature":return t.keySignature=P.parseEnum(s,Ke),!0;case"keysignaturetype":return t.keySignatureType=P.parseEnum(s,cs),!0;case"barnumberdisplay":return t.barNumberDisplay=P.parseEnum(s,Vt),!0;case"style":return s?(t.style=new fc,An.fromJson(t.style,s)):t.style=void 0,!0}return!1}}class Rn{static fromJson(t,e){e&&P.forEach(e,(s,i)=>Rn.setProperty(t,i,s))}static toJson(t){if(!t)return null;const e=new Map;return e.set("name",t.name),e.set("firstfret",t.firstFret),e.set("strings",t.strings),e.set("barrefrets",t.barreFrets),e.set("showname",t.showName),e.set("showdiagram",t.showDiagram),e.set("showfingering",t.showFingering),e}static setProperty(t,e,s){switch(e){case"name":return t.name=s,!0;case"firstfret":return t.firstFret=s,!0;case"strings":return t.strings=s,!0;case"barrefrets":return t.barreFrets=s,!0;case"showname":return t.showName=s,!0;case"showdiagram":return t.showDiagram=s,!0;case"showfingering":return t.showFingering=s,!0}return!1}}class On{static fromJson(t,e){e&&P.forEach(e,(s,i)=>On.setProperty(t,i,s))}static toJson(t){if(!t)return null;const e=new Map;return e.set("isstandard",t.isStandard),e.set("name",t.name),e.set("tunings",t.tunings),e}static setProperty(t,e,s){switch(e){case"isstandard":return t.isStandard=s,!0;case"name":return t.name=s,!0;case"tunings":return t.tunings=s,!0}return!1}}class Wn{static fromJson(t,e){e&&P.forEach(e,(s,i)=>Wn.setProperty(t,i,s))}static toJson(t){if(!t)return null;const e=new Map;if(e.set("bars",t.bars.map(s=>In.toJson(s))),t.chords!==null){const s=new Map;e.set("chords",s);for(const[i,r]of t.chords)s.set(i.toString(),Rn.toJson(r))}return e.set("capo",t.capo),e.set("transpositionpitch",t.transpositionPitch),e.set("displaytranspositionpitch",t.displayTranspositionPitch),e.set("stringtuning",On.toJson(t.stringTuning)),e.set("showslash",t.showSlash),e.set("shownumbered",t.showNumbered),e.set("showtablature",t.showTablature),e.set("showstandardnotation",t.showStandardNotation),e.set("ispercussion",t.isPercussion),e.set("standardnotationlinecount",t.standardNotationLineCount),e}static setProperty(t,e,s){switch(e){case"bars":t.bars=[];for(const i of s){const r=new qs;In.fromJson(r,i),t.addBar(r)}return!0;case"chords":return t.chords=new Map,P.forEach(s,(i,r)=>{const a=new Yi;Rn.fromJson(a,i),t.addChord(r,a)}),!0;case"capo":return t.capo=s,!0;case"transpositionpitch":return t.transpositionPitch=s,!0;case"displaytranspositionpitch":return t.displayTranspositionPitch=s,!0;case"stringtuning":return On.fromJson(t.stringTuning,s),!0;case"showslash":return t.showSlash=s,!0;case"shownumbered":return t.showNumbered=s,!0;case"showtablature":return t.showTablature=s,!0;case"showstandardnotation":return t.showStandardNotation=s,!0;case"ispercussion":return t.isPercussion=s,!0;case"standardnotationlinecount":return t.standardNotationLineCount=s,!0}return!1}}class Vn{static fromJson(t,e){e&&P.forEach(e,(s,i)=>Vn.setProperty(t,i,s))}static toJson(t){if(!t)return null;const e=new Map;return e.set("volume",t.volume),e.set("balance",t.balance),e.set("port",t.port),e.set("program",t.program),e.set("bank",t.bank),e.set("primarychannel",t.primaryChannel),e.set("secondarychannel",t.secondaryChannel),e.set("ismute",t.isMute),e.set("issolo",t.isSolo),e}static setProperty(t,e,s){switch(e){case"volume":return t.volume=s,!0;case"balance":return t.balance=s,!0;case"port":return t.port=s,!0;case"program":return t.program=s,!0;case"bank":return t.bank=s,!0;case"primarychannel":return t.primaryChannel=s,!0;case"secondarychannel":return t.secondaryChannel=s,!0;case"ismute":return t.isMute=s,!0;case"issolo":return t.isSolo=s,!0}return!1}}class Hn{static fromJson(t,e){e&&P.forEach(e,(s,i)=>Hn.setProperty(t,i,s))}static toJson(t){if(!t)return null;const e=new Map;return e.set("id",t.id),e.set("elementtype",t.elementType),e.set("staffline",t.staffLine),e.set("noteheaddefault",t.noteHeadDefault),e.set("noteheadhalf",t.noteHeadHalf),e.set("noteheadwhole",t.noteHeadWhole),e.set("techniquesymbol",t.techniqueSymbol),e.set("techniquesymbolplacement",t.techniqueSymbolPlacement),e.set("outputmidinumber",t.outputMidiNumber),e}static setProperty(t,e,s){switch(e){case"id":return t.id=s,!0;case"elementtype":return t.elementType=s,!0;case"staffline":return t.staffLine=s,!0;case"noteheaddefault":return t.noteHeadDefault=P.parseEnum(s,f),!0;case"noteheadhalf":return t.noteHeadHalf=P.parseEnum(s,f),!0;case"noteheadwhole":return t.noteHeadWhole=P.parseEnum(s,f),!0;case"techniquesymbol":return t.techniqueSymbol=P.parseEnum(s,f),!0;case"techniquesymbolplacement":return t.techniqueSymbolPlacement=P.parseEnum(s,Je),!0;case"outputmidinumber":return t.outputMidiNumber=s,!0}return!1}}class Gn{static fromJson(t,e){e&&P.forEach(e,(s,i)=>Gn.setProperty(t,i,s))}static toJson(t){if(!t)return null;const e=new Map;{const s=new Map;e.set("colors",s);for(const[i,r]of t.colors)s.set(i.toString(),qe.toJson(r))}return e}static setProperty(t,e,s){switch(e){case"colors":return t.colors=new Map,P.forEach(s,(i,r)=>{t.colors.set(P.parseEnum(r,fi),qe.fromJson(i))}),!0}return!1}}class Un{static fromJson(t,e){e&&P.forEach(e,(s,i)=>Un.setProperty(t,i,s))}static toJson(t){if(!t)return null;const e=new Map;if(e.set("staves",t.staves.map(s=>Wn.toJson(s))),e.set("playbackinfo",Vn.toJson(t.playbackInfo)),e.set("color",qe.toJson(t.color)),e.set("name",t.name),e.set("isvisibleonmultitrack",t.isVisibleOnMultiTrack),e.set("shortname",t.shortName),e.set("defaultsystemslayout",t.defaultSystemsLayout),e.set("systemslayout",t.systemsLayout),t.lineBreaks!==void 0){const s=[];e.set("linebreaks",s);for(const i of t.lineBreaks)s.push(i)}return e.set("percussionarticulations",t.percussionArticulations.map(s=>Hn.toJson(s))),t.style&&e.set("style",Gn.toJson(t.style)),e}static setProperty(t,e,s){switch(e){case"staves":t.staves=[];for(const i of s){const r=new cr;Wn.fromJson(r,i),t.addStaff(r)}return!0;case"playbackinfo":return Vn.fromJson(t.playbackInfo,s),!0;case"color":return t.color=qe.fromJson(s),!0;case"name":return t.name=s,!0;case"isvisibleonmultitrack":return t.isVisibleOnMultiTrack=s,!0;case"shortname":return t.shortName=s,!0;case"defaultsystemslayout":return t.defaultSystemsLayout=s,!0;case"systemslayout":return t.systemsLayout=s,!0;case"linebreaks":for(const i of s)t.addLineBreaks(i);return!0;case"percussionarticulations":t.percussionArticulations=[];for(const i of s){const r=new $;Hn.fromJson(r,i),t.percussionArticulations.push(r)}return!0;case"style":return s?(t.style=new _c,Gn.fromJson(t.style,s)):t.style=void 0,!0}return!1}}class zn{static fromJson(t,e){e&&P.forEach(e,(s,i)=>zn.setProperty(t,i,s))}static toJson(t){if(!t)return null;const e=new Map;if(e.set("hidedynamics",t.hideDynamics),e.set("bracketextendmode",t.bracketExtendMode),e.set("usesystemsignseparator",t.useSystemSignSeparator),e.set("globaldisplaytuning",t.globalDisplayTuning),t.perTrackDisplayTuning!==null){const s=new Map;e.set("pertrackdisplaytuning",s);for(const[i,r]of t.perTrackDisplayTuning)s.set(i.toString(),r)}if(e.set("globaldisplaychorddiagramsontop",t.globalDisplayChordDiagramsOnTop),t.perTrackChordDiagramsOnTop!==null){const s=new Map;e.set("pertrackchorddiagramsontop",s);for(const[i,r]of t.perTrackChordDiagramsOnTop)s.set(i.toString(),r)}if(e.set("globaldisplaychorddiagramsinscore",t.globalDisplayChordDiagramsInScore),e.set("singletracktracknamepolicy",t.singleTrackTrackNamePolicy),e.set("multitracktracknamepolicy",t.multiTrackTrackNamePolicy),e.set("firstsystemtracknamemode",t.firstSystemTrackNameMode),e.set("othersystemstracknamemode",t.otherSystemsTrackNameMode),e.set("firstsystemtracknameorientation",t.firstSystemTrackNameOrientation),e.set("othersystemstracknameorientation",t.otherSystemsTrackNameOrientation),e.set("multitrackmultibarrest",t.multiTrackMultiBarRest),t.perTrackMultiBarRest!==null){const s=[];e.set("pertrackmultibarrest",s);for(const i of t.perTrackMultiBarRest)s.push(i)}return e.set("extendbarlines",t.extendBarLines),e.set("hideemptystaves",t.hideEmptyStaves),e.set("hideemptystavesinfirstsystem",t.hideEmptyStavesInFirstSystem),e.set("showsinglestaffbrackets",t.showSingleStaffBrackets),e.set("barnumberdisplay",t.barNumberDisplay),e}static setProperty(t,e,s){switch(e){case"hidedynamics":return t.hideDynamics=s,!0;case"bracketextendmode":return t.bracketExtendMode=P.parseEnum(s,nr),!0;case"usesystemsignseparator":return t.useSystemSignSeparator=s,!0;case"globaldisplaytuning":return t.globalDisplayTuning=s,!0;case"pertrackdisplaytuning":return t.perTrackDisplayTuning=new Map,P.forEach(s,(i,r)=>{t.perTrackDisplayTuning.set(Number.parseInt(r),i)}),!0;case"globaldisplaychorddiagramsontop":return t.globalDisplayChordDiagramsOnTop=s,!0;case"pertrackchorddiagramsontop":return t.perTrackChordDiagramsOnTop=new Map,P.forEach(s,(i,r)=>{t.perTrackChordDiagramsOnTop.set(Number.parseInt(r),i)}),!0;case"globaldisplaychorddiagramsinscore":return t.globalDisplayChordDiagramsInScore=s,!0;case"singletracktracknamepolicy":return t.singleTrackTrackNamePolicy=P.parseEnum(s,Tt),!0;case"multitracktracknamepolicy":return t.multiTrackTrackNamePolicy=P.parseEnum(s,Tt),!0;case"firstsystemtracknamemode":return t.firstSystemTrackNameMode=P.parseEnum(s,ls),!0;case"othersystemstracknamemode":return t.otherSystemsTrackNameMode=P.parseEnum(s,ls),!0;case"firstsystemtracknameorientation":return t.firstSystemTrackNameOrientation=P.parseEnum(s,hs),!0;case"othersystemstracknameorientation":return t.otherSystemsTrackNameOrientation=P.parseEnum(s,hs),!0;case"multitrackmultibarrest":return t.multiTrackMultiBarRest=s,!0;case"pertrackmultibarrest":return t.perTrackMultiBarRest=new Set(s),!0;case"extendbarlines":return t.extendBarLines=s,!0;case"hideemptystaves":return t.hideEmptyStaves=s,!0;case"hideemptystavesinfirstsystem":return t.hideEmptyStavesInFirstSystem=s,!0;case"showsinglestaffbrackets":return t.showSingleStaffBrackets=s,!0;case"barnumberdisplay":return t.barNumberDisplay=P.parseEnum(s,Vt),!0}return!1}}class Yn{static fromJson(t,e){e&&P.forEach(e,(s,i)=>Yn.setProperty(t,i,s))}static toJson(t){return t?new Map:null}static setProperty(t,e,s){return!1}}class Xn{static fromJson(t,e){e&&P.forEach(e,(s,i)=>Xn.setProperty(t,i,s))}static toJson(t){if(!t)return null;const e=new Map;return e.set("template",t.template),e.set("isvisible",t.isVisible),e.set("textalign",t.textAlign),e}static setProperty(t,e,s){switch(e){case"template":return t.template=s,!0;case"isvisible":return t.isVisible=s,!0;case"textalign":return t.textAlign=P.parseEnum(s,X),!0}return!1}}class $n{static fromJson(t,e){e&&P.forEach(e,(s,i)=>$n.setProperty(t,i,s))}static toJson(t){if(!t)return null;const e=new Map;{const s=new Map;e.set("headerandfooter",s);for(const[i,r]of t.headerAndFooter)s.set(i.toString(),Xn.toJson(r))}{const s=new Map;e.set("colors",s);for(const[i,r]of t.colors)s.set(i.toString(),qe.toJson(r))}return e}static setProperty(t,e,s){switch(e){case"headerandfooter":return t.headerAndFooter=new Map,P.forEach(s,(i,r)=>{const a=new Bs;Xn.fromJson(a,i),t.headerAndFooter.set(P.parseEnum(r,V),a)}),!0;case"colors":return t.colors=new Map,P.forEach(s,(i,r)=>{t.colors.set(P.parseEnum(r,V),qe.fromJson(i))}),!0}return!1}}class Jn{static fromJson(t,e){e&&P.forEach(e,(s,i)=>Jn.setProperty(t,i,s))}static toJson(t){if(!t)return null;const e=new Map;return e.set("album",t.album),e.set("artist",t.artist),e.set("copyright",t.copyright),e.set("instructions",t.instructions),e.set("music",t.music),e.set("notices",t.notices),e.set("subtitle",t.subTitle),e.set("title",t.title),e.set("words",t.words),e.set("tab",t.tab),e.set("masterbars",t.masterBars.map(s=>Nn.toJson(s))),e.set("tracks",t.tracks.map(s=>Un.toJson(s))),e.set("defaultsystemslayout",t.defaultSystemsLayout),e.set("systemslayout",t.systemsLayout),e.set("stylesheet",zn.toJson(t.stylesheet)),t.backingTrack&&e.set("backingtrack",Yn.toJson(t.backingTrack)),t.style&&e.set("style",$n.toJson(t.style)),e}static setProperty(t,e,s){switch(e){case"album":return t.album=s,!0;case"artist":return t.artist=s,!0;case"copyright":return t.copyright=s,!0;case"instructions":return t.instructions=s,!0;case"music":return t.music=s,!0;case"notices":return t.notices=s,!0;case"subtitle":return t.subTitle=s,!0;case"title":return t.title=s,!0;case"words":return t.words=s,!0;case"tab":return t.tab=s,!0;case"masterbars":t.masterBars=[];for(const i of s){const r=new ii;Nn.fromJson(r,i),t.addMasterBar(r)}return!0;case"tracks":t.tracks=[];for(const i of s){const r=new Ei;Un.fromJson(r,i),t.addTrack(r)}return!0;case"defaultsystemslayout":return t.defaultSystemsLayout=s,!0;case"systemslayout":return t.systemsLayout=s,!0;case"stylesheet":return zn.fromJson(t.stylesheet,s),!0;case"backingtrack":return s?(t.backingTrack=new Gl,Yn.fromJson(t.backingTrack,s)):t.backingTrack=void 0,!0;case"style":return s?(t.style=new Ui,$n.fromJson(t.style,s)):t.style=void 0,!0}return!1}}class ga{static fromJson(t,e){e&&P.forEach(e,(s,i)=>ga.setProperty(t,i.toLowerCase(),s))}static toJson(t){if(!t)return null;const e=new Map;if(e.set("scriptfile",t.scriptFile),e.set("fontdirectory",t.fontDirectory),t.smuflFontSources!==null){const s=new Map;e.set("smuflfontsources",s);for(const[i,r]of t.smuflFontSources)s.set(i.toString(),r)}return e.set("file",t.file),e.set("tex",t.tex),e.set("tracks",t.tracks),e.set("enablelazyloading",t.enableLazyLoading),e.set("engine",t.engine),e.set("loglevel",t.logLevel),e.set("useworkers",t.useWorkers),e.set("includenotebounds",t.includeNoteBounds),e}static setProperty(t,e,s){switch(e){case"scriptfile":return t.scriptFile=s,!0;case"fontdirectory":return t.fontDirectory=s,!0;case"smuflfontsources":return t.smuflFontSources=new Map,P.forEach(s,(i,r)=>{t.smuflFontSources.set(P.parseEnum(r,ti),i)}),!0;case"file":return t.file=s,!0;case"tex":return t.tex=s,!0;case"tracks":return t.tracks=s,!0;case"enablelazyloading":return t.enableLazyLoading=s,!0;case"engine":return t.engine=s,!0;case"loglevel":return t.logLevel=P.parseEnum(s,oi),!0;case"useworkers":return t.useWorkers=s,!0;case"includenotebounds":return t.includeNoteBounds=s,!0}return!1}}class Vr{static fromJson(t,e){e&&P.forEach(e,(s,i)=>Vr.setProperty(t,i.toLowerCase(),s))}static toJson(t){if(!t)return null;const e=new Map;return e.set("topy",t.topY),e.set("bottomy",t.bottomY),e.set("x",t.x),e}static setProperty(t,e,s){switch(e){case"topy":return t.topY=s,!0;case"bottomy":return t.bottomY=s,!0;case"x":return t.x=s,!0}return!1}}class $d{static clone(t){const e=new Ze;return e.musicFontSize=t.musicFontSize,e.oneStaffSpace=t.oneStaffSpace,e.tabLineSpacing=t.tabLineSpacing,e.arrowShaftThickness=t.arrowShaftThickness,e.barlineSeparation=t.barlineSeparation,e.beamSpacing=t.beamSpacing,e.beamThickness=t.beamThickness,e.bracketThickness=t.bracketThickness,e.dashedBarlineDashLength=t.dashedBarlineDashLength,e.dashedBarlineGapLength=t.dashedBarlineGapLength,e.dashedBarlineThickness=t.dashedBarlineThickness,e.hairpinThickness=t.hairpinThickness,e.legerLineThickness=t.legerLineThickness,e.legerLineExtension=t.legerLineExtension,e.octaveLineThickness=t.octaveLineThickness,e.pedalLineThickness=t.pedalLineThickness,e.repeatBarlineDotSeparation=t.repeatBarlineDotSeparation,e.repeatEndingLineThickness=t.repeatEndingLineThickness,e.slurMidpointThickness=t.slurMidpointThickness,e.staffLineThickness=t.staffLineThickness,e.stemThickness=t.stemThickness,e.thickBarlineThickness=t.thickBarlineThickness,e.thinBarlineThickness=t.thinBarlineThickness,e.thinThickBarlineSeparation=t.thinThickBarlineSeparation,e.tieMidpointThickness=t.tieMidpointThickness,e.tupletBracketThickness=t.tupletBracketThickness,e.stemUp=new Map(t.stemUp),e.stemDown=new Map(t.stemDown),e.repeatOffsetX=new Map(t.repeatOffsetX),e.standardStemLength=t.standardStemLength,e.stemFlagOffsets=new Map(t.stemFlagOffsets),e.glyphTop=new Map(t.glyphTop),e.glyphBottom=new Map(t.glyphBottom),e.glyphWidths=new Map(t.glyphWidths),e.glyphHeights=new Map(t.glyphHeights),e.numberedBarRendererBarSize=t.numberedBarRendererBarSize,e.numberedBarRendererBarSpacing=t.numberedBarRendererBarSpacing,e.numberedDashGlyphPadding=t.numberedDashGlyphPadding,e.numberedDashGlyphWidth=t.numberedDashGlyphWidth,e.lineRangedGlyphDashGap=t.lineRangedGlyphDashGap,e.lineRangedGlyphDashSize=t.lineRangedGlyphDashSize,e.preNoteEffectPadding=t.preNoteEffectPadding,e.postNoteEffectPadding=t.postNoteEffectPadding,e.onNoteEffectPadding=t.onNoteEffectPadding,e.stringNumberCirclePadding=t.stringNumberCirclePadding,e.rowContainerPadding=t.rowContainerPadding,e.rowContainerGap=t.rowContainerGap,e.alternateEndingsPadding=t.alternateEndingsPadding,e.sustainPedalLinePadding=t.sustainPedalLinePadding,e.tieHeight=t.tieHeight,e.beatTimerPadding=t.beatTimerPadding,e.bendNoteHeadElementPadding=t.bendNoteHeadElementPadding,e.ghostParenthesisWidth=t.ghostParenthesisWidth,e.ghostParenthesisPadding=t.ghostParenthesisPadding,e.brokenBeamWidth=t.brokenBeamWidth,e.tabWhammyTextPadding=t.tabWhammyTextPadding,e.tabWhammyPerHalfHeight=t.tabWhammyPerHalfHeight,e.tabWhammyDashSize=t.tabWhammyDashSize,e.songBookWhammyDipHeight=t.songBookWhammyDipHeight,e.deadSlappedLineWidth=t.deadSlappedLineWidth,e.leftHandTabTieWidth=t.leftHandTabTieWidth,e.tabBendDashSize=t.tabBendDashSize,e.tabBendStaffPadding=t.tabBendStaffPadding,e.tabBendPerValueHeight=t.tabBendPerValueHeight,e.tabBendLabelPadding=t.tabBendLabelPadding,e.simpleSlideWidth=t.simpleSlideWidth,e.simpleSlideHeight=t.simpleSlideHeight,e.chordDiagramPaddingX=t.chordDiagramPaddingX,e.chordDiagramPaddingY=t.chordDiagramPaddingY,e.chordDiagramStringSpacing=t.chordDiagramStringSpacing,e.chordDiagramFretSpacing=t.chordDiagramFretSpacing,e.chordDiagramNutHeight=t.chordDiagramNutHeight,e.chordDiagramFretHeight=t.chordDiagramFretHeight,e.chordDiagramLineWidth=t.chordDiagramLineWidth,e.tripletFeelBracketPadding=t.tripletFeelBracketPadding,e.accidentalPadding=t.accidentalPadding,e.preBeatGlyphSpacing=t.preBeatGlyphSpacing,e.tempoNoteScale=t.tempoNoteScale,e.tuningGlyphCircleNumberScale=t.tuningGlyphCircleNumberScale,e.tuningGlyphStringColumnScale=t.tuningGlyphStringColumnScale,e.tuningGlyphStringRowPadding=t.tuningGlyphStringRowPadding,e.directionsScale=t.directionsScale,e.multiVoiceDisplacedNoteHeadSpacing=t.multiVoiceDisplacedNoteHeadSpacing,e.stemFlagHeight=new Map(t.stemFlagHeight),e}}class qn{constructor(){o(this,"topY",0);o(this,"bottomY",0);o(this,"x",0)}}const Rs=class Rs{constructor(){o(this,"musicFontSize",0);o(this,"oneStaffSpace",0);o(this,"tabLineSpacing",0);o(this,"arrowShaftThickness",0);o(this,"barlineSeparation",0);o(this,"beamSpacing",0);o(this,"beamThickness",0);o(this,"bracketThickness",0);o(this,"dashedBarlineDashLength",0);o(this,"dashedBarlineGapLength",0);o(this,"dashedBarlineThickness",0);o(this,"hairpinThickness",0);o(this,"legerLineThickness",0);o(this,"legerLineExtension",0);o(this,"octaveLineThickness",0);o(this,"pedalLineThickness",0);o(this,"repeatBarlineDotSeparation",0);o(this,"repeatEndingLineThickness",0);o(this,"slurMidpointThickness",0);o(this,"staffLineThickness",0);o(this,"stemThickness",0);o(this,"thickBarlineThickness",0);o(this,"thinBarlineThickness",0);o(this,"thinThickBarlineSeparation",0);o(this,"tieMidpointThickness",0);o(this,"tupletBracketThickness",0);o(this,"stemUp",new Map);o(this,"stemDown",new Map);o(this,"repeatOffsetX",new Map);o(this,"standardStemLength",0);o(this,"stemFlagOffsets",new Map);o(this,"glyphTop",new Map);o(this,"glyphBottom",new Map);o(this,"glyphWidths",new Map);o(this,"glyphHeights",new Map);o(this,"numberedBarRendererBarSize",0);o(this,"numberedBarRendererBarSpacing",0);o(this,"numberedDashGlyphPadding",0);o(this,"numberedDashGlyphWidth",0);o(this,"lineRangedGlyphDashGap",0);o(this,"lineRangedGlyphDashSize",0);o(this,"preNoteEffectPadding",0);o(this,"postNoteEffectPadding",0);o(this,"onNoteEffectPadding",0);o(this,"stringNumberCirclePadding",0);o(this,"rowContainerPadding",0);o(this,"rowContainerGap",0);o(this,"alternateEndingsPadding",0);o(this,"sustainPedalLinePadding",0);o(this,"tieHeight",0);o(this,"beatTimerPadding",0);o(this,"bendNoteHeadElementPadding",0);o(this,"ghostParenthesisWidth",0);o(this,"ghostParenthesisPadding",0);o(this,"brokenBeamWidth",0);o(this,"tabWhammyTextPadding",0);o(this,"tabWhammyPerHalfHeight",0);o(this,"tabWhammyDashSize",0);o(this,"songBookWhammyDipHeight",0);o(this,"deadSlappedLineWidth",0);o(this,"leftHandTabTieWidth",0);o(this,"tabBendDashSize",0);o(this,"tabBendStaffPadding",0);o(this,"tabBendPerValueHeight",0);o(this,"tabBendLabelPadding",0);o(this,"simpleSlideWidth",0);o(this,"simpleSlideHeight",0);o(this,"chordDiagramPaddingX",0);o(this,"chordDiagramPaddingY",0);o(this,"chordDiagramStringSpacing",0);o(this,"chordDiagramFretSpacing",0);o(this,"chordDiagramNutHeight",0);o(this,"chordDiagramFretHeight",0);o(this,"chordDiagramLineWidth",0);o(this,"tripletFeelBracketPadding",0);o(this,"accidentalPadding",0);o(this,"preBeatGlyphSpacing",0);o(this,"tempoNoteScale",.7);o(this,"tuningGlyphCircleNumberScale",.7);o(this,"tuningGlyphStringColumnScale",1.5);o(this,"tuningGlyphStringRowPadding",0);o(this,"directionsScale",.6);o(this,"multiVoiceDisplacedNoteHeadSpacing",0);o(this,"stemFlagHeight",new Map)}static get bravuraDefaults(){let t=Rs._bravuraDefaults;return t||(t=new Rs,t.fillFromSmufl(Rs.bravuraMetadata),Rs._bravuraDefaults=t),$d.clone(t)}hasSymbol(t){return this.glyphWidths.get(t)>0&&this.glyphHeights.get(t)>0}fillFromSmufl(t,e=36){this.musicFontSize=e,this.oneStaffSpace=e/4,this.tabLineSpacing=Math.floor(this.oneStaffSpace*1.5),this.arrowShaftThickness=t.engravingDefaults.arrowShaftThickness*this.oneStaffSpace,this.barlineSeparation=t.engravingDefaults.barlineSeparation*this.oneStaffSpace,this.beamSpacing=t.engravingDefaults.beamSpacing*this.oneStaffSpace,this.beamThickness=t.engravingDefaults.beamThickness*this.oneStaffSpace,this.bracketThickness=t.engravingDefaults.bracketThickness*this.oneStaffSpace,this.dashedBarlineDashLength=t.engravingDefaults.dashedBarlineDashLength*this.oneStaffSpace,this.dashedBarlineGapLength=t.engravingDefaults.dashedBarlineGapLength*this.oneStaffSpace,this.dashedBarlineThickness=t.engravingDefaults.dashedBarlineThickness*this.oneStaffSpace,this.hairpinThickness=t.engravingDefaults.hairpinThickness*this.oneStaffSpace,this.legerLineExtension=t.engravingDefaults.legerLineExtension*this.oneStaffSpace,this.legerLineThickness=t.engravingDefaults.legerLineThickness*this.oneStaffSpace,this.octaveLineThickness=t.engravingDefaults.octaveLineThickness*this.oneStaffSpace,this.pedalLineThickness=t.engravingDefaults.pedalLineThickness*this.oneStaffSpace,this.repeatBarlineDotSeparation=t.engravingDefaults.repeatBarlineDotSeparation*this.oneStaffSpace,this.repeatEndingLineThickness=t.engravingDefaults.repeatEndingLineThickness*this.oneStaffSpace,this.slurMidpointThickness=t.engravingDefaults.slurMidpointThickness*this.oneStaffSpace,this.staffLineThickness=t.engravingDefaults.staffLineThickness*this.oneStaffSpace,this.stemThickness=t.engravingDefaults.stemThickness*this.oneStaffSpace,this.thickBarlineThickness=t.engravingDefaults.thickBarlineThickness*this.oneStaffSpace,this.thinBarlineThickness=t.engravingDefaults.thinBarlineThickness*this.oneStaffSpace,typeof t.engravingDefaults.thinThickBarlineSeparation=="number"?this.thinThickBarlineSeparation=t.engravingDefaults.thinThickBarlineSeparation*this.oneStaffSpace:this.thinThickBarlineSeparation=t.engravingDefaults.barlineSeparation*this.oneStaffSpace,this.tieMidpointThickness=t.engravingDefaults.tieMidpointThickness*this.oneStaffSpace,this.tupletBracketThickness=t.engravingDefaults.tupletBracketThickness*this.oneStaffSpace;const s=3*this.oneStaffSpace;this.standardStemLength=s,this.stemFlagOffsets.set(b.QuadrupleWhole,0),this.stemFlagOffsets.set(b.DoubleWhole,0),this.stemFlagOffsets.set(b.Whole,0),this.stemFlagOffsets.set(b.Half,0),this.stemFlagOffsets.set(b.Quarter,0),this.stemFlagOffsets.set(b.Eighth,0),this.stemFlagOffsets.set(b.Sixteenth,0),this.stemFlagOffsets.set(b.ThirtySecond,0),this.stemFlagOffsets.set(b.SixtyFourth,0),this.stemFlagOffsets.set(b.OneHundredTwentyEighth,0),this.stemFlagOffsets.set(b.TwoHundredFiftySixth,0),this.stemFlagHeight.set(b.QuadrupleWhole,0),this.stemFlagHeight.set(b.DoubleWhole,0),this.stemFlagHeight.set(b.Whole,0),this.stemFlagHeight.set(b.Half,0),this.stemFlagHeight.set(b.Quarter,0),this.stemFlagHeight.set(b.Eighth,1*this.oneStaffSpace),this.stemFlagHeight.set(b.Sixteenth,1.5*this.oneStaffSpace),this.stemFlagHeight.set(b.ThirtySecond,2*this.oneStaffSpace),this.stemFlagHeight.set(b.SixtyFourth,3*this.oneStaffSpace),this.stemFlagHeight.set(b.OneHundredTwentyEighth,3.5*this.oneStaffSpace),this.stemFlagHeight.set(b.TwoHundredFiftySixth,4.2*this.oneStaffSpace);for(const[l,h]of Object.entries(t.glyphsWithAnchors)){const c=Rs._smuflNameToMusicFontSymbol(l);if(c){if(h.stemDownNW){const d=new qn;d.x=h.stemDownNW[0]*this.oneStaffSpace,d.topY=h.stemDownNW[1]*this.oneStaffSpace,h.stemDownSW?d.bottomY=h.stemDownSW[1]*this.oneStaffSpace:d.bottomY=0,this.stemDown.set(c,d)}if(h.stemUpSE){const d=new qn,u=h.stemUpSE[0]*this.oneStaffSpace;d.bottomY=h.stemUpSE[1]*this.oneStaffSpace,h.stemUpNW?(d.x=h.stemUpNW[0]*this.oneStaffSpace,d.topY=h.stemUpNW[1]*this.oneStaffSpace):(d.x=u-this.stemThickness,d.topY=0),this.stemUp.set(c,d)}if(h.repeatOffset&&this.repeatOffsetX.set(c,h.repeatOffset[0]*this.oneStaffSpace),h.stemUpNW){const d=h.stemUpNW[1]*this.oneStaffSpace;switch(c){case f.Flag8thUp:this.stemFlagOffsets.set(b.Eighth,d);break;case f.Flag16thUp:this.stemFlagOffsets.set(b.Sixteenth,d);break;case f.Flag32ndUp:this.stemFlagOffsets.set(b.ThirtySecond,d);break;case f.Flag64thUp:this.stemFlagOffsets.set(b.SixtyFourth,d);break;case f.Flag128thUp:this.stemFlagOffsets.set(b.OneHundredTwentyEighth,d);break;case f.Flag256thUp:this.stemFlagOffsets.set(b.TwoHundredFiftySixth,d);break}}}}const i=new Set,r=t.glyphBBoxes;if(r)for(const[l,h]of Object.entries(r)){const c=Rs._smuflNameToMusicFontSymbol(l);c&&(i.add(c),this.glyphTop.set(c,h.bBoxNE[1]*this.oneStaffSpace),this.glyphBottom.set(c,h.bBoxSW[1]*this.oneStaffSpace),this.glyphWidths.set(c,(h.bBoxNE[0]-h.bBoxSW[0])*this.oneStaffSpace),this.glyphHeights.set(c,(h.bBoxNE[1]-h.bBoxSW[1])*this.oneStaffSpace))}const a=new Set([f.None,f.Space,f.NoteheadNull]);for(const l of Ha.getAllMusicFontSymbols())i.has(l)||(a.has(l)||L.warning("SmuFL",`The provided SmuFL font is missing the glyph ${f[l]} needed by alphaTab, the music notation might not show all details`),this.glyphTop.set(l,0),this.glyphBottom.set(l,0),this.glyphWidths.set(l,0),this.glyphHeights.set(l,0));this.numberedBarRendererBarSize=this.staffLineThickness*2,this.numberedBarRendererBarSpacing=this.beamSpacing,this.preNoteEffectPadding=.4*this.oneStaffSpace,this.postNoteEffectPadding=.2*this.oneStaffSpace,this.lineRangedGlyphDashGap=.5*this.oneStaffSpace,this.lineRangedGlyphDashSize=1*this.oneStaffSpace,this.numberedDashGlyphPadding=.3*this.oneStaffSpace,this.numberedDashGlyphPadding=.3*this.oneStaffSpace,this.stringNumberCirclePadding=.3*this.oneStaffSpace,this.rowContainerPadding=Math.ceil(.3*this.oneStaffSpace),this.rowContainerGap=Math.ceil(1*this.oneStaffSpace),this.onNoteEffectPadding=.2*this.oneStaffSpace,this.alternateEndingsPadding=.3*this.oneStaffSpace,this.sustainPedalLinePadding=.5*this.oneStaffSpace,this.tieHeight=1.2*this.oneStaffSpace,this.beatTimerPadding=.22*this.oneStaffSpace,this.bendNoteHeadElementPadding=.22*this.oneStaffSpace,this.ghostParenthesisWidth=.6*this.oneStaffSpace,this.ghostParenthesisPadding=.3*this.oneStaffSpace,this.brokenBeamWidth=1*this.oneStaffSpace,this.tabWhammyTextPadding=.4*this.oneStaffSpace,this.tabWhammyDashSize=.4*this.oneStaffSpace,this.tabBendDashSize=.4*this.oneStaffSpace,this.songBookWhammyDipHeight=.6*this.oneStaffSpace,this.tabWhammyPerHalfHeight=.6*this.oneStaffSpace,this.tabBendStaffPadding=.5*this.oneStaffSpace,this.tabBendPerValueHeight=.6*this.oneStaffSpace,this.tabBendLabelPadding=.3*this.oneStaffSpace,this.leftHandTabTieWidth=2.2*this.oneStaffSpace,this.numberedDashGlyphWidth=1.5*this.oneStaffSpace,this.deadSlappedLineWidth=.25*this.oneStaffSpace,this.simpleSlideWidth=1.3*this.oneStaffSpace,this.simpleSlideHeight=.3*this.oneStaffSpace,this.chordDiagramPaddingX=Math.ceil(.5*this.oneStaffSpace),this.chordDiagramPaddingY=Math.ceil(.2*this.oneStaffSpace),this.chordDiagramStringSpacing=Math.ceil(1.1*this.oneStaffSpace),this.chordDiagramFretSpacing=Math.ceil(1.3*this.oneStaffSpace),this.chordDiagramNutHeight=Math.ceil(.33*this.oneStaffSpace),this.chordDiagramFretHeight=Math.ceil(.1*this.oneStaffSpace),this.chordDiagramLineWidth=Math.ceil(.11*this.oneStaffSpace),this.tripletFeelBracketPadding=.2*this.oneStaffSpace,this.accidentalPadding=.1*this.oneStaffSpace,this.preBeatGlyphSpacing=.5*this.oneStaffSpace,this.multiVoiceDisplacedNoteHeadSpacing=.2*this.oneStaffSpace,this.tuningGlyphStringRowPadding=.2*this.oneStaffSpace}static _smuflNameToMusicFontSymbol(t){const e=Rs.smuflNameToGlyphNameMapping.has(t)?Rs.smuflNameToGlyphNameMapping.get(t):t.substring(0,1).toUpperCase()+t.substring(1);return P.parseEnumExact(e,f)}getStemLength(t,e){return this.standardStemLength+(e?this.stemFlagOffsets.get(t):0)}};o(Rs,"_bravuraDefaults"),o(Rs,"GraceScale",.75),o(Rs,"smuflNameToGlyphNameMapping",new Map([["4stringTabClef","FourStringTabClef"],["6stringTabClef","SixStringTabClef"]])),o(Rs,"bravuraMetadata",{engravingDefaults:{arrowShaftThickness:.16,barlineSeparation:.4,beamSpacing:.25,beamThickness:.5,bracketThickness:.5,dashedBarlineDashLength:.5,dashedBarlineGapLength:.25,dashedBarlineThickness:.16,hairpinThickness:.16,legerLineExtension:.4,legerLineThickness:.16,lyricLineThickness:.16,octaveLineThickness:.16,pedalLineThickness:.16,repeatBarlineDotSeparation:.16,repeatEndingLineThickness:.16,slurEndpointThickness:.1,slurMidpointThickness:.22,staffLineThickness:.13,stemThickness:.12,subBracketThickness:.16,textEnclosureThickness:.16,thickBarlineThickness:.5,thinBarlineThickness:.16,tieEndpointThickness:.1,tieMidpointThickness:.22,thinThickBarlineSeparation:.4,tupletBracketThickness:.16},glyphBBoxes:{FourStringTabClef:{bBoxNE:[1.088,2.016],bBoxSW:[-.012,-2.032]},SixStringTabClef:{bBoxNE:[1.632,3.056],bBoxSW:[-.012,-2.992]},accidentalDoubleFlat:{bBoxNE:[1.644,1.748],bBoxSW:[0,-.7]},accidentalDoubleSharp:{bBoxNE:[.988,.508],bBoxSW:[0,-.5]},accidentalFlat:{bBoxNE:[.904,1.756],bBoxSW:[0,-.7]},accidentalNatural:{bBoxNE:[.672,1.364],bBoxSW:[0,-1.34]},accidentalQuarterToneFlatArrowUp:{bBoxNE:[.992,2.316],bBoxSW:[-.168,-.708]},accidentalQuarterToneSharpNaturalArrowUp:{bBoxNE:[.848,2.188],bBoxSW:[-.104,-1.36]},accidentalSharp:{bBoxNE:[.996,1.4],bBoxSW:[0,-1.392]},accidentalThreeQuarterTonesSharpArrowUp:{bBoxNE:[1.1,2.12],bBoxSW:[0,-1.388]},arrowheadBlackDown:{bBoxNE:[.912,1.196],bBoxSW:[0,0]},arrowheadBlackUp:{bBoxNE:[.912,1.196],bBoxSW:[0,0]},articAccentAbove:{bBoxNE:[1.356,.98],bBoxSW:[0,.004]},articAccentBelow:{bBoxNE:[1.356,0],bBoxSW:[0,-.976]},articMarcatoAbove:{bBoxNE:[.94,1.012],bBoxSW:[-.004,-.004]},articMarcatoBelow:{bBoxNE:[.94,0],bBoxSW:[-.004,-1.016]},articStaccatoAbove:{bBoxNE:[.336,.336],bBoxSW:[0,0]},articStaccatoBelow:{bBoxNE:[.336,0],bBoxSW:[0,-.336]},articTenutoAbove:{bBoxNE:[1.352,.192],bBoxSW:[-.004,0]},articTenutoBelow:{bBoxNE:[1.352,0],bBoxSW:[-.004,-.192]},augmentationDot:{bBoxNE:[.4,.2],bBoxSW:[0,-.2]},brace:{bBoxNE:[.328,3.988],bBoxSW:[.008,0]},bracketBottom:{bBoxNE:[1.876,0],bBoxSW:[0,-1.18]},bracketTop:{bBoxNE:[1.876,1.18],bBoxSW:[0,0]},buzzRoll:{bBoxNE:[.624,.464],bBoxSW:[-.62,-.464]},cClef:{bBoxNE:[2.796,2.024],bBoxSW:[0,-2.024]},cClef8vb:{bBoxNE:[2.796,2.024],bBoxSW:[0,-2.964]},clef15:{bBoxNE:[1.436,1.02],bBoxSW:[0,-.012]},clef8:{bBoxNE:[.82,.988],bBoxSW:[0,0]},coda:{bBoxNE:[3.82,3.592],bBoxSW:[-.016,-.632]},dynamicCrescendoHairpin:{bBoxNE:[2.944,1.424],bBoxSW:[.016,.372]},dynamicFF:{bBoxNE:[2.44,1.776],bBoxSW:[-.54,-.608]},dynamicFFF:{bBoxNE:[3.32,1.776],bBoxSW:[-.62,-.608]},dynamicFFFF:{bBoxNE:[4.28,1.776],bBoxSW:[-.62,-.608]},dynamicFFFFF:{bBoxNE:[5.24,1.776],bBoxSW:[-.62,-.608]},dynamicFFFFFF:{bBoxNE:[6.2,1.776],bBoxSW:[-.62,-.608]},dynamicForte:{bBoxNE:[1.456,1.776],bBoxSW:[-.564,-.608]},dynamicFortePiano:{bBoxNE:[2.476,1.776],bBoxSW:[-.564,-.608]},dynamicForzando:{bBoxNE:[1.988,1.776],bBoxSW:[-.564,-.608]},dynamicMF:{bBoxNE:[3.272,1.724],bBoxSW:[-.08,-.66]},dynamicMP:{bBoxNE:[3.3,1.096],bBoxSW:[-.08,-.568]},dynamicNiente:{bBoxNE:[1.232,1.096],bBoxSW:[-.092,-.04]},dynamicPF:{bBoxNE:[3.08,1.776],bBoxSW:[-.288,-.608]},dynamicPP:{bBoxNE:[2.912,1.096],bBoxSW:[-.328,-.568]},dynamicPPP:{bBoxNE:[4.292,1.096],bBoxSW:[-.368,-.568]},dynamicPPPP:{bBoxNE:[5.672,1.096],bBoxSW:[-.408,-.568]},dynamicPPPPP:{bBoxNE:[7.092,1.096],bBoxSW:[-.408,-.568]},dynamicPPPPPP:{bBoxNE:[8.512,1.096],bBoxSW:[-.408,-.568]},dynamicPiano:{bBoxNE:[1.464,1.096],bBoxSW:[-.356,-.568]},dynamicRinforzando1:{bBoxNE:[2.5,1.776],bBoxSW:[-.08,-.608]},dynamicRinforzando2:{bBoxNE:[2.976,1.776],bBoxSW:[-.08,-.608]},dynamicSforzando1:{bBoxNE:[2.416,1.776],bBoxSW:[0,-.608]},dynamicSforzandoPianissimo:{bBoxNE:[4.796,1.776],bBoxSW:[0,-.608]},dynamicSforzandoPiano:{bBoxNE:[3.38,1.776],bBoxSW:[0,-.608]},dynamicSforzato:{bBoxNE:[2.932,1.776],bBoxSW:[0,-.608]},dynamicSforzatoFF:{bBoxNE:[3.856,1.776],bBoxSW:[0,-.608]},dynamicSforzatoPiano:{bBoxNE:[4.304,1.776],bBoxSW:[0,-.608]},fClef:{bBoxNE:[2.736,1.048],bBoxSW:[-.02,-2.54]},fClef15ma:{bBoxNE:[2.736,1.984],bBoxSW:[-.02,-2.54]},fClef15mb:{bBoxNE:[2.736,1.048],bBoxSW:[-.02,-2.968]},fClef8va:{bBoxNE:[2.736,1.98],bBoxSW:[-.02,-2.54]},fClef8vb:{bBoxNE:[2.736,1.048],bBoxSW:[-.02,-2.976]},fermataAbove:{bBoxNE:[2.42,1.316],bBoxSW:[.012,-.012]},fermataLongAbove:{bBoxNE:[2.412,1.332],bBoxSW:[0,-.004]},fermataShortAbove:{bBoxNE:[2.416,1.364],bBoxSW:[0,0]},fingering0:{bBoxNE:[.94,1.004],bBoxSW:[.08,-.004]},fingering1:{bBoxNE:[.548,1.016],bBoxSW:[.08,0]},fingering2:{bBoxNE:[.888,1.012],bBoxSW:[.08,-.012]},fingering3:{bBoxNE:[.82,1.008],bBoxSW:[.08,0]},fingering4:{bBoxNE:[.864,1.012],bBoxSW:[.08,.004]},fingering5:{bBoxNE:[.82,1.032],bBoxSW:[.08,0]},fingeringALower:{bBoxNE:[1.068,1.032],bBoxSW:[0,-.02]},fingeringCLower:{bBoxNE:[.888,1.044],bBoxSW:[0,-.028]},fingeringILower:{bBoxNE:[.656,1.54],bBoxSW:[-.052,-.028]},fingeringMLower:{bBoxNE:[1.66,1.028],bBoxSW:[-.032,-.016]},fingeringPLower:{bBoxNE:[1.088,1.028],bBoxSW:[-.216,-.612]},fingeringTLower:{bBoxNE:[.604,1.484],bBoxSW:[0,-.028]},flag128thDown:{bBoxNE:[1.092,3.248],bBoxSW:[0,-2.32]},flag128thUp:{bBoxNE:[1.044,2.132],bBoxSW:[0,-3.248]},flag16thDown:{bBoxNE:[1.1635806326044895,3.2480256],bBoxSW:[0,-.036]},flag16thUp:{bBoxNE:[1.116,.008],bBoxSW:[0,-3.252]},flag256thDown:{bBoxNE:[1.196,3.252],bBoxSW:[0,-3.004]},flag256thUp:{bBoxNE:[1.056,2.816],bBoxSW:[0,-3.248]},flag32ndDown:{bBoxNE:[1.092,3.248],bBoxSW:[0,-.688]},flag32ndUp:{bBoxNE:[1.044,.596],bBoxSW:[0,-3.248]},flag64thDown:{bBoxNE:[1.092,3.248],bBoxSW:[0,-1.504]},flag64thUp:{bBoxNE:[1.044,1.388],bBoxSW:[0,-3.248]},flag8thDown:{bBoxNE:[1.224,3.232896633157715],bBoxSW:[0,-.056]},flag8thUp:{bBoxNE:[1.056,.036],bBoxSW:[0,-3.240768470618394]},fretboardFilledCircle:{bBoxNE:[.564,.564],bBoxSW:[0,0]},fretboardO:{bBoxNE:[.564,.564],bBoxSW:[0,0]},fretboardX:{bBoxNE:[.596,.596],bBoxSW:[0,0]},gClef:{bBoxNE:[2.684,4.392],bBoxSW:[0,-2.632]},gClef15ma:{bBoxNE:[2.684,5.276],bBoxSW:[0,-2.632]},gClef15mb:{bBoxNE:[2.684,4.392],bBoxSW:[0,-3.524]},gClef8va:{bBoxNE:[2.684,5.28],bBoxSW:[0,-2.632]},gClef8vb:{bBoxNE:[2.684,4.392],bBoxSW:[0,-3.512]},graceNoteSlashStemDown:{bBoxNE:[2.02,0],bBoxSW:[0,-1.604]},graceNoteSlashStemUp:{bBoxNE:[2.02,1.604],bBoxSW:[0,0]},guitarClosePedal:{bBoxNE:[1.144,1.14],bBoxSW:[0,-.004]},guitarFadeIn:{bBoxNE:[1.448,1.46],bBoxSW:[0,0]},guitarFadeOut:{bBoxNE:[1.448,1.46],bBoxSW:[0,0]},guitarGolpe:{bBoxNE:[1.08,1.128],bBoxSW:[.004,0]},guitarLeftHandTapping:{bBoxNE:[1.588,1.364],bBoxSW:[0,-.224]},guitarOpenPedal:{bBoxNE:[1.144,1.144],bBoxSW:[0,0]},guitarString0:{bBoxNE:[2.164,2.156],bBoxSW:[.004,0]},guitarString1:{bBoxNE:[2.16,2.156],bBoxSW:[0,0]},guitarString2:{bBoxNE:[2.16,2.156],bBoxSW:[0,0]},guitarString3:{bBoxNE:[2.16,2.156],bBoxSW:[0,0]},guitarString4:{bBoxNE:[2.164,2.156],bBoxSW:[.004,0]},guitarString5:{bBoxNE:[2.16,2.156],bBoxSW:[0,0]},guitarString6:{bBoxNE:[2.16,2.156],bBoxSW:[0,0]},guitarString7:{bBoxNE:[2.16,2.156],bBoxSW:[0,0]},guitarString8:{bBoxNE:[2.16,2.156],bBoxSW:[0,0]},guitarString9:{bBoxNE:[2.16,2.156],bBoxSW:[0,0]},guitarVibratoStroke:{bBoxNE:[.668,.476],bBoxSW:[-.056,0]},guitarVolumeSwell:{bBoxNE:[2.896,1.46],bBoxSW:[0,0]},guitarWideVibratoStroke:{bBoxNE:[.908,.896],bBoxSW:[-.096,0]},keyboardPedalPed:{bBoxNE:[4.076,2.22],bBoxSW:[0,-.032]},keyboardPedalUp:{bBoxNE:[1.8,1.8],bBoxSW:[0,0]},metAugmentationDot:{bBoxNE:[.4,.2],bBoxSW:[0,-.2]},metNote8thUp:{bBoxNE:[2.132,2.784],bBoxSW:[0,-.564]},metNoteQuarterUp:{bBoxNE:[1.328,2.752],bBoxSW:[0,-.564]},note8thUp:{bBoxNE:[2.264,3.492],bBoxSW:[0,-.552]},noteQuarterUp:{bBoxNE:[1.328,3.5],bBoxSW:[0,-.564]},noteShapeDiamondBlack:{bBoxNE:[1.444,.548],bBoxSW:[0,-.552]},noteShapeDiamondWhite:{bBoxNE:[1.444,.544],bBoxSW:[0,-.556]},noteShapeMoonBlack:{bBoxNE:[1.444,.5],bBoxSW:[0,-.5]},noteShapeMoonWhite:{bBoxNE:[1.444,.5],bBoxSW:[0,-.5]},noteShapeRoundBlack:{bBoxNE:[1.456,.552],bBoxSW:[0,-.552]},noteShapeRoundWhite:{bBoxNE:[1.464,.548],bBoxSW:[0,-.548]},noteShapeSquareBlack:{bBoxNE:[1.44,.46],bBoxSW:[0,-.46]},noteShapeSquareWhite:{bBoxNE:[1.44,.46],bBoxSW:[0,-.46]},noteShapeTriangleLeftBlack:{bBoxNE:[1.44,.5],bBoxSW:[0,-.5]},noteShapeTriangleLeftWhite:{bBoxNE:[1.44,.5],bBoxSW:[0,-.5]},noteShapeTriangleRightBlack:{bBoxNE:[1.44,.5],bBoxSW:[0,-.5]},noteShapeTriangleRightWhite:{bBoxNE:[1.44,.5],bBoxSW:[0,-.5]},noteShapeTriangleRoundBlack:{bBoxNE:[1.424,.5],bBoxSW:[0,-.5]},noteShapeTriangleRoundWhite:{bBoxNE:[1.424,.5],bBoxSW:[0,-.5]},noteShapeTriangleUpBlack:{bBoxNE:[1.424,.5],bBoxSW:[0,-.5]},noteShapeTriangleUpWhite:{bBoxNE:[1.424,.5],bBoxSW:[0,-.5]},noteheadBlack:{bBoxNE:[1.18,.5],bBoxSW:[0,-.5]},noteheadCircleSlash:{bBoxNE:[1,.5],bBoxSW:[0,-.5]},noteheadCircleX:{bBoxNE:[.996,.5],bBoxSW:[0,-.5]},noteheadCircleXDoubleWhole:{bBoxNE:[1.688,.62],bBoxSW:[0,-.62]},noteheadCircleXHalf:{bBoxNE:[1,.5],bBoxSW:[0,-.5]},noteheadCircleXWhole:{bBoxNE:[.996,.5],bBoxSW:[0,-.5]},noteheadCircledBlack:{bBoxNE:[1.284,.668],bBoxSW:[-.084,-.684]},noteheadCircledDoubleWhole:{bBoxNE:[2.412,.852],bBoxSW:[0,-.872]},noteheadCircledHalf:{bBoxNE:[1.244,.668],bBoxSW:[-.072,-.648]},noteheadCircledWhole:{bBoxNE:[1.748,.844],bBoxSW:[0,-.9]},noteheadClusterDoubleWhole3rd:{bBoxNE:[2.428,1.62],bBoxSW:[0,-.62]},noteheadClusterHalf3rd:{bBoxNE:[1.264,1.5],bBoxSW:[0,-.5]},noteheadClusterQuarter3rd:{bBoxNE:[1.44,1.5],bBoxSW:[0,-.5]},noteheadClusterWhole3rd:{bBoxNE:[1.7,1.5],bBoxSW:[0,-.5]},noteheadDiamondBlack:{bBoxNE:[1,.5],bBoxSW:[0,-.5]},noteheadDiamondBlackWide:{bBoxNE:[1.4,.5],bBoxSW:[0,-.5]},noteheadDiamondDoubleWhole:{bBoxNE:[1.728,.62],bBoxSW:[0,-.62]},noteheadDiamondHalf:{bBoxNE:[1.004,.5],bBoxSW:[0,-.5]},noteheadDiamondWhite:{bBoxNE:[1,.5],bBoxSW:[0,-.5]},noteheadDiamondWhiteWide:{bBoxNE:[1.4,.5],bBoxSW:[0,-.5]},noteheadDiamondWhole:{bBoxNE:[1.08,.5],bBoxSW:[0,-.5]},noteheadDoubleWhole:{bBoxNE:[2.396,.62],bBoxSW:[0,-.62]},noteheadDoubleWholeSquare:{bBoxNE:[1.664,.792],bBoxSW:[0,-.76]},noteheadHalf:{bBoxNE:[1.18,.5],bBoxSW:[0,-.5]},noteheadHeavyX:{bBoxNE:[1.54,.5],bBoxSW:[0,-.5]},noteheadHeavyXHat:{bBoxNE:[1.828,1.04],bBoxSW:[-.292,-.5]},noteheadParenthesis:{bBoxNE:[1.472,.728],bBoxSW:[-.292,-.72]},noteheadPlusBlack:{bBoxNE:[.996,.5],bBoxSW:[-.004,-.5]},noteheadPlusDoubleWhole:{bBoxNE:[1.892,.62],bBoxSW:[0,-.62]},noteheadPlusHalf:{bBoxNE:[1.044,.5],bBoxSW:[0,-.5]},noteheadPlusWhole:{bBoxNE:[1.14,.5],bBoxSW:[0,-.5]},noteheadRoundWhiteWithDot:{bBoxNE:[1.004,.5],bBoxSW:[0,-.5]},noteheadSlashHorizontalEnds:{bBoxNE:[2.12,1],bBoxSW:[0,-1]},noteheadSlashWhiteHalf:{bBoxNE:[3.12,1],bBoxSW:[0,-1]},noteheadSlashWhiteWhole:{bBoxNE:[3.92,1],bBoxSW:[0,-1]},noteheadSlashedBlack1:{bBoxNE:[1.5,.668],bBoxSW:[-.32,-.66]},noteheadSlashedBlack2:{bBoxNE:[1.504,.672],bBoxSW:[-.316,-.656]},noteheadSlashedDoubleWhole1:{bBoxNE:[2.384,.672],bBoxSW:[0,-.716]},noteheadSlashedDoubleWhole2:{bBoxNE:[2.384,.676],bBoxSW:[0,-.712]},noteheadSlashedHalf1:{bBoxNE:[1.544,.64],bBoxSW:[-.268,-.568]},noteheadSlashedHalf2:{bBoxNE:[1.52,.672],bBoxSW:[-.292,-.536]},noteheadSlashedWhole1:{bBoxNE:[1.732,.592],bBoxSW:[-.088,-.628]},noteheadSlashedWhole2:{bBoxNE:[1.744,.604],bBoxSW:[-.072,-.616]},noteheadSquareBlack:{bBoxNE:[1.252,.5],bBoxSW:[0,-.5]},noteheadSquareBlackLarge:{bBoxNE:[2,1],bBoxSW:[0,-1]},noteheadSquareBlackWhite:{bBoxNE:[2,1],bBoxSW:[0,-1]},noteheadSquareWhite:{bBoxNE:[1.252,.5],bBoxSW:[0,-.5]},noteheadTriangleDownBlack:{bBoxNE:[1.168,.5],bBoxSW:[0,-.5]},noteheadTriangleDownDoubleWhole:{bBoxNE:[1.932,.62],bBoxSW:[0,-.62]},noteheadTriangleDownHalf:{bBoxNE:[1.14,.5],bBoxSW:[0,-.5]},noteheadTriangleDownWhole:{bBoxNE:[1.276,.5],bBoxSW:[0,-.5]},noteheadTriangleRightBlack:{bBoxNE:[1.356,.5],bBoxSW:[0,-.5]},noteheadTriangleRightWhite:{bBoxNE:[1.356,.5],bBoxSW:[0,-.5]},noteheadTriangleUpBlack:{bBoxNE:[1.172,.5],bBoxSW:[0,-.5]},noteheadTriangleUpDoubleWhole:{bBoxNE:[1.932,.62],bBoxSW:[0,-.62]},noteheadTriangleUpHalf:{bBoxNE:[1.14,.5],bBoxSW:[0,-.5]},noteheadTriangleUpWhole:{bBoxNE:[1.276,.5],bBoxSW:[0,-.5]},noteheadWhole:{bBoxNE:[1.688,.5],bBoxSW:[0,-.5]},noteheadXBlack:{bBoxNE:[1.16,.5],bBoxSW:[0,-.5]},noteheadXDoubleWhole:{bBoxNE:[2.184,.62],bBoxSW:[0,-.62]},noteheadXHalf:{bBoxNE:[1.336,.5],bBoxSW:[0,-.5]},noteheadXOrnate:{bBoxNE:[.988,.504],bBoxSW:[0,-.504]},noteheadXWhole:{bBoxNE:[1.508,.5],bBoxSW:[0,-.5]},octaveBaselineB:{bBoxNE:[.796,1.352],bBoxSW:[0,-.04]},octaveBaselineM:{bBoxNE:[1.524,.928],bBoxSW:[0,-.02]},ornamentMordent:{bBoxNE:[2.916,1.276],bBoxSW:[.004,-.292]},ornamentShortTrill:{bBoxNE:[2.9,.98],bBoxSW:[0,0]},ornamentTrill:{bBoxNE:[2.084,1.56],bBoxSW:[0,-.04]},ornamentTurn:{bBoxNE:[1.84,.872],bBoxSW:[0,0]},ornamentTurnInverted:{bBoxNE:[1.828,.872],bBoxSW:[-.012,0]},ottava:{bBoxNE:[1.544,1.852],bBoxSW:[0,-.04]},ottavaAlta:{bBoxNE:[3.54,1.852],bBoxSW:[0,-.04]},ottavaBassaVb:{bBoxNE:[3.184,1.852],bBoxSW:[0,-.04]},pictEdgeOfCymbal:{bBoxNE:[4.828,2.14],bBoxSW:[.004,0]},quindicesima:{bBoxNE:[2.668,1.844],bBoxSW:[0,-.04]},quindicesimaAlta:{bBoxNE:[5.26,1.844],bBoxSW:[0,-.04]},repeat1Bar:{bBoxNE:[2.128,1.116],bBoxSW:[0,-1]},repeat2Bars:{bBoxNE:[3.048,1.116],bBoxSW:[0,-1]},repeatDot:{bBoxNE:[.4,.2],bBoxSW:[0,-.2]},rest128th:{bBoxNE:[1.94,2.756],bBoxSW:[0,-3]},rest16th:{bBoxNE:[1.28,.716],bBoxSW:[0,-2]},rest256th:{bBoxNE:[2.164,2.784],bBoxSW:[0,-4]},rest32nd:{bBoxNE:[1.452,1.704],bBoxSW:[0,-2]},rest64th:{bBoxNE:[1.692,1.72],bBoxSW:[0,-3.012]},rest8th:{bBoxNE:[.988,.696],bBoxSW:[0,-1.004]},restDoubleWhole:{bBoxNE:[.5,1],bBoxSW:[0,0]},restHBarLeft:{bBoxNE:[1.5,1.048],bBoxSW:[0,-1.08]},restHBarMiddle:{bBoxNE:[1.42,.384],bBoxSW:[-.108,-.416]},restHBarRight:{bBoxNE:[1.5,1.048],bBoxSW:[0,-1.08]},restHalf:{bBoxNE:[1.128,.568],bBoxSW:[0,-.008]},restLonga:{bBoxNE:[.5,1],bBoxSW:[0,-.996]},restQuarter:{bBoxNE:[1.08,1.492],bBoxSW:[.004,-1.5]},restWhole:{bBoxNE:[1.128,.036],bBoxSW:[0,-.54]},segno:{bBoxNE:[2.2,3.036],bBoxSW:[.016,-.108]},stringsDownBow:{bBoxNE:[1.248,1.272],bBoxSW:[0,0]},stringsUpBow:{bBoxNE:[.996,1.98],bBoxSW:[.004,.004]},systemDivider:{bBoxNE:[4.232,4.24],bBoxSW:[0,-.272]},textAugmentationDot:{bBoxNE:[.4,.256],bBoxSW:[0,-.144]},textBlackNoteFrac16thLongStem:{bBoxNE:[1.368,3.512],bBoxSW:[0,-.56]},textBlackNoteFrac32ndLongStem:{bBoxNE:[1.368,3.512],bBoxSW:[0,-.56]},textBlackNoteFrac8thLongStem:{bBoxNE:[1.368,3.512],bBoxSW:[0,-.56]},textBlackNoteLongStem:{bBoxNE:[1.328,3.512],bBoxSW:[0,-.564]},textCont16thBeamLongStem:{bBoxNE:[1.368,3.512],bBoxSW:[0,2.264]},textCont32ndBeamLongStem:{bBoxNE:[1.368,3.512],bBoxSW:[0,1.504]},textCont8thBeamLongStem:{bBoxNE:[1.368,3.512],bBoxSW:[0,3.012]},textTuplet3LongStem:{bBoxNE:[.94,5.3],bBoxSW:[0,4.2]},textTupletBracketEndLongStem:{bBoxNE:[1.272,4.764],bBoxSW:[0,3.94]},textTupletBracketStartLongStem:{bBoxNE:[1.272,4.764],bBoxSW:[0,3.94]},timeSig0:{bBoxNE:[1.8,1.004],bBoxSW:[.08,-1]},timeSig1:{bBoxNE:[1.256,1.004],bBoxSW:[.08,-1]},timeSig2:{bBoxNE:[1.704,1.016],bBoxSW:[.08,-1.028]},timeSig3:{bBoxNE:[1.604,.996],bBoxSW:[.08,-1.004]},timeSig4:{bBoxNE:[1.8,1.004],bBoxSW:[.08,-1]},timeSig5:{bBoxNE:[1.532,.984],bBoxSW:[.08,-1.004]},timeSig6:{bBoxNE:[1.656,1.004],bBoxSW:[.08,-.996]},timeSig7:{bBoxNE:[1.684,.996],bBoxSW:[.08,-1]},timeSig8:{bBoxNE:[1.664,1.036],bBoxSW:[.08,-1.036]},timeSig9:{bBoxNE:[1.656,1.004],bBoxSW:[.08,-.996]},timeSigCommon:{bBoxNE:[1.696,1.004],bBoxSW:[.02,-.996]},timeSigCutCommon:{bBoxNE:[1.672,1.444],bBoxSW:[0,-1.436]},tremolo1:{bBoxNE:[.6,.376],bBoxSW:[-.6,-.372]},tremolo2:{bBoxNE:[.596,.748],bBoxSW:[-.604,-.748]},tremolo3:{bBoxNE:[.6,1.112],bBoxSW:[-.6,-1.12]},tremolo4:{bBoxNE:[.6,1.496],bBoxSW:[-.6,-1.48]},tremolo5:{bBoxNE:[.6,1.88],bBoxSW:[-.604,-1.84]},tuplet0:{bBoxNE:[1.2731041262817027,1.5],bBoxSW:[-.001204330173715796,-.032]},tuplet1:{bBoxNE:[1.024,1.488],bBoxSW:[.04,0]},tuplet2:{bBoxNE:[1.316,1.5],bBoxSW:[.04,-.024]},tuplet3:{bBoxNE:[1.224,1.5],bBoxSW:[.04,-.032]},tuplet4:{bBoxNE:[1.252,1.488],bBoxSW:[.04,0]},tuplet5:{bBoxNE:[1.308,1.492],bBoxSW:[.04,-.032]},tuplet6:{bBoxNE:[1.256,1.5],bBoxSW:[.04105974105482295,-.032]},tuplet7:{bBoxNE:[1.332,1.488],bBoxSW:[.12,-.016]},tuplet8:{bBoxNE:[1.292,1.5],bBoxSW:[.04,-.032]},tuplet9:{bBoxNE:[1.254940258945177,1.5],bBoxSW:[.04,-.032]},tupletColon:{bBoxNE:[.484,1.072],bBoxSW:[.04,.232]},unpitchedPercussionClef1:{bBoxNE:[1.528,1],bBoxSW:[0,-1]},wiggleSawtooth:{bBoxNE:[3.06,1.06],bBoxSW:[-.068,-1.068]},wiggleSawtoothNarrow:{bBoxNE:[2.06,1.064],bBoxSW:[-.072,-1.064]},wiggleTrill:{bBoxNE:[1.08,.836],bBoxSW:[-.144,.392]},wiggleVibratoMediumFast:{bBoxNE:[1.292,.8],bBoxSW:[-.104,-.164]}},glyphsWithAnchors:{accidentalDoubleFlat:{cutOutNE:[.988,.644],cutOutSE:[1.336,-.396]},accidentalFlat:{cutOutNE:[.252,.656],cutOutSE:[.504,-.476]},accidentalNatural:{cutOutNE:[.192,.776],cutOutSW:[.476,-.828]},accidentalQuarterToneFlatArrowUp:{cutOutNE:[.604,.664],cutOutSE:[.62,-.452]},accidentalQuarterToneSharpNaturalArrowUp:{cutOutSW:[.616,-.868]},accidentalSharp:{cutOutNE:[.84,.896],cutOutNW:[.144,.568],cutOutSE:[.84,-.596],cutOutSW:[.144,-.896]},accidentalThreeQuarterTonesSharpArrowUp:{cutOutNW:[.272,1.304],cutOutSE:[.86,-.584],cutOutSW:[.132,-.888]},dynamicFF:{opticalCenter:[1.852,0]},dynamicFFF:{opticalCenter:[2.472,0]},dynamicFFFF:{opticalCenter:[2.824,0]},dynamicFFFFF:{opticalCenter:[2.976,0]},dynamicFFFFFF:{opticalCenter:[3.504,0]},dynamicForte:{opticalCenter:[1.256,0]},dynamicFortePiano:{opticalCenter:[1.5,0]},dynamicForzando:{opticalCenter:[1.352,0]},dynamicMF:{opticalCenter:[1.796,0]},dynamicMP:{opticalCenter:[1.848,0]},dynamicNiente:{opticalCenter:[.616,0]},dynamicPF:{opticalCenter:[1.68,0]},dynamicPP:{opticalCenter:[1.708,0]},dynamicPPP:{opticalCenter:[2.368,0]},dynamicPPPP:{opticalCenter:[3.004,0]},dynamicPPPPP:{opticalCenter:[3.552,0]},dynamicPPPPPP:{opticalCenter:[4.248,0]},dynamicPiano:{opticalCenter:[1.22,0]},dynamicRinforzando1:{opticalCenter:[1.564,0]},dynamicRinforzando2:{opticalCenter:[2.084,0]},dynamicSforzando1:{opticalCenter:[1.3,0]},dynamicSforzandoPianissimo:{opticalCenter:[1.972,0]},dynamicSforzandoPiano:{opticalCenter:[1.904,0]},dynamicSforzato:{opticalCenter:[1.76,0]},dynamicSforzatoFF:{opticalCenter:[2.276,0]},dynamicSforzatoPiano:{opticalCenter:[1.848,0]},flag128thDown:{stemDownSW:[0,-2.076]},flag128thUp:{stemUpNW:[0,1.9]},flag16thDown:{stemDownSW:[0,.128]},flag16thUp:{stemUpNW:[0,-.088]},flag256thDown:{stemDownSW:[0,-2.812]},flag256thUp:{stemUpNW:[0,2.592]},flag32ndDown:{stemDownSW:[0,-.448]},flag32ndUp:{stemUpNW:[0,.376]},flag64thDown:{stemDownSW:[0,-1.244]},flag64thUp:{stemUpNW:[0,1.172]},flag8thDown:{graceNoteSlashNW:[-.596,2.168],graceNoteSlashSE:[1.328,.628],stemDownSW:[0,.132]},flag8thUp:{graceNoteSlashNE:[1.284,-.796],graceNoteSlashSW:[-.644,-2.456],stemUpNW:[0,-.04]},guitarVibratoStroke:{repeatOffset:[.608,0]},guitarWideVibratoStroke:{repeatOffset:[.82,0]},noteShapeDiamondBlack:{stemDownNW:[0,0],stemUpSE:[1.444,0]},noteShapeDiamondWhite:{stemDownNW:[0,0],stemUpSE:[1.436,0]},noteShapeMoonBlack:{stemDownNW:[0,.068],stemUpSE:[1.44,.068]},noteShapeMoonWhite:{stemDownNW:[0,.072],stemUpSE:[1.444,.068]},noteShapeRoundBlack:{stemDownNW:[0,-.168],stemUpSE:[1.444,.184]},noteShapeRoundWhite:{stemDownNW:[0,-.168],stemUpSE:[1.456,.192]},noteShapeSquareBlack:{stemDownNW:[0,.46],stemUpSE:[1.44,-.46]},noteShapeSquareWhite:{stemDownNW:[0,.46],stemUpSE:[1.44,-.46]},noteShapeTriangleLeftBlack:{stemDownNW:[0,.5],stemUpSE:[1.436,-.5]},noteShapeTriangleLeftWhite:{stemDownNW:[0,.5],stemUpSE:[1.436,-.5]},noteShapeTriangleRightBlack:{stemDownNW:[0,.476],stemUpSE:[1.44,-.5]},noteShapeTriangleRightWhite:{stemDownNW:[0,.476],stemUpSE:[1.44,-.5]},noteShapeTriangleRoundBlack:{stemDownNW:[0,.172],stemUpSE:[1.424,.172]},noteShapeTriangleRoundWhite:{stemDownNW:[0,.172],stemUpSE:[1.424,.172]},noteShapeTriangleUpBlack:{stemDownNW:[0,-.5],stemUpSE:[1.424,-.5]},noteShapeTriangleUpWhite:{stemDownNW:[0,-.5],stemUpSE:[1.424,-.5]},noteheadBlack:{cutOutNW:[.208,.3],cutOutSE:[.94,-.296],splitStemDownNE:[.968,-.248],splitStemDownNW:[.12,-.416],splitStemUpSE:[1.092,.392],splitStemUpSW:[.312,.356],stemDownNW:[0,-.168],stemUpSE:[1.18,.168]},noteheadCircleSlash:{stemDownNW:[.004,0],stemUpSE:[1,0]},noteheadCircleX:{stemDownNW:[0,0],stemUpSE:[.996,0]},noteheadCircleXDoubleWhole:{noteheadOrigin:[.352,0]},noteheadCircleXHalf:{stemDownNW:[0,0],stemUpSE:[1,0]},noteheadCircledBlack:{stemDownNW:[0,-.164],stemUpSE:[1.18,.168]},noteheadCircledDoubleWhole:{noteheadOrigin:[.356,0]},noteheadCircledHalf:{stemDownNW:[0,-.144],stemUpSE:[1.172,.156]},noteheadClusterDoubleWhole3rd:{noteheadOrigin:[.364,0]},noteheadClusterHalf3rd:{stemDownNW:[0,-.164],stemUpSE:[1.264,1.144]},noteheadClusterQuarter3rd:{stemDownNW:[0,.26],stemUpSE:[1.44,.744]},noteheadDiamondBlack:{stemDownNW:[0,0],stemUpSE:[1,0]},noteheadDiamondBlackWide:{stemDownNW:[0,0],stemUpSE:[1.4,0]},noteheadDiamondDoubleWhole:{noteheadOrigin:[.324,0]},noteheadDiamondHalf:{stemDownNW:[0,0],stemUpSE:[1.004,0]},noteheadDiamondWhite:{stemDownNW:[0,0],stemUpSE:[1,0]},noteheadDiamondWhiteWide:{stemDownNW:[0,.004],stemUpSE:[1.4,0]},noteheadDoubleWhole:{noteheadOrigin:[.36,0]},noteheadHalf:{cutOutNW:[.204,.296],cutOutSE:[.98,-.3],splitStemDownNE:[.956,-.3],splitStemDownNW:[.128,-.428],splitStemUpSE:[1.108,.372],splitStemUpSW:[.328,.38],stemDownNW:[0,-.168],stemUpSE:[1.18,.168]},noteheadHeavyX:{stemDownNW:[0,-.436],stemUpSE:[1.54,.44]},noteheadHeavyXHat:{stemDownNW:[0,-.436],stemUpSE:[1.54,.456]},noteheadPlusBlack:{stemDownNW:[-.004,0],stemUpSE:[.996,0]},noteheadPlusDoubleWhole:{noteheadOrigin:[.372,0]},noteheadPlusHalf:{stemDownNW:[0,-.112],stemUpSE:[1.044,.088]},noteheadRoundWhiteWithDot:{stemDownNW:[0,0],stemUpSE:[1.004,0]},noteheadSlashHorizontalEnds:{stemDownNW:[0,-1],stemUpSE:[2.12,1]},noteheadSlashWhiteHalf:{stemDownNW:[0,-1],stemUpSE:[3.12,1]},noteheadSlashedBlack1:{stemDownNW:[0,-.172],stemUpSE:[1.18,.164]},noteheadSlashedBlack2:{stemDownNW:[0,-.172],stemUpSE:[1.18,.164]},noteheadSlashedDoubleWhole1:{noteheadOrigin:[.356,0]},noteheadSlashedDoubleWhole2:{noteheadOrigin:[.356,0]},noteheadSlashedHalf1:{stemDownNW:[0,-.168],stemUpSE:[1.168,.164]},noteheadSlashedHalf2:{stemDownNW:[0,-.164],stemUpSE:[1.172,.168]},noteheadSquareBlack:{stemDownNW:[0,-.5],stemUpSE:[1.252,.5]},noteheadSquareBlackLarge:{stemDownNW:[0,0],stemUpSE:[2,0]},noteheadSquareBlackWhite:{stemDownNW:[0,-1],stemUpSE:[2,1]},noteheadSquareWhite:{stemDownNW:[0,-.5],stemUpSE:[1.252,.5]},noteheadTriangleDownBlack:{stemDownNW:[0,.5],stemUpSE:[1.168,.5]},noteheadTriangleDownDoubleWhole:{noteheadOrigin:[.384,0]},noteheadTriangleDownHalf:{stemDownNW:[0,.464],stemUpSE:[1.14,.464]},noteheadTriangleRightBlack:{stemDownNW:[0,-.5],stemUpSE:[1.356,.5]},noteheadTriangleRightWhite:{stemDownNW:[0,-.5],stemUpSE:[1.356,.5]},noteheadTriangleUpBlack:{stemDownNW:[0,-.5],stemUpSE:[1.172,-.5]},noteheadTriangleUpDoubleWhole:{noteheadOrigin:[.34,0]},noteheadTriangleUpHalf:{stemDownNW:[0,-.46],stemUpSE:[1.14,-.46]},noteheadWhole:{cutOutNW:[.172,.332],cutOutSE:[1.532,-.364]},noteheadXBlack:{stemDownNW:[0,-.44],stemUpSE:[1.16,.444]},noteheadXDoubleWhole:{noteheadOrigin:[.348,0]},noteheadXHalf:{stemDownNW:[0,-.412],stemUpSE:[1.336,.412]},noteheadXOrnate:{stemDownNW:[0,-.312],stemUpSE:[.988,.316]},wiggleSawtooth:{repeatOffset:[2.992,0]},wiggleSawtoothNarrow:{repeatOffset:[1.996,0]},wiggleTrill:{repeatOffset:[.948,0]},wiggleVibratoMediumFast:{repeatOffset:[1.18,0]}}});let Ze=Rs;class Qn{static fromJson(t,e){e&&P.forEach(e,(s,i)=>Qn.setProperty(t,i.toLowerCase(),s))}static toJson(t){if(!t)return null;const e=new Map;e.set("musicfontsize",t.musicFontSize),e.set("onestaffspace",t.oneStaffSpace),e.set("tablinespacing",t.tabLineSpacing),e.set("arrowshaftthickness",t.arrowShaftThickness),e.set("barlineseparation",t.barlineSeparation),e.set("beamspacing",t.beamSpacing),e.set("beamthickness",t.beamThickness),e.set("bracketthickness",t.bracketThickness),e.set("dashedbarlinedashlength",t.dashedBarlineDashLength),e.set("dashedbarlinegaplength",t.dashedBarlineGapLength),e.set("dashedbarlinethickness",t.dashedBarlineThickness),e.set("hairpinthickness",t.hairpinThickness),e.set("legerlinethickness",t.legerLineThickness),e.set("legerlineextension",t.legerLineExtension),e.set("octavelinethickness",t.octaveLineThickness),e.set("pedallinethickness",t.pedalLineThickness),e.set("repeatbarlinedotseparation",t.repeatBarlineDotSeparation),e.set("repeatendinglinethickness",t.repeatEndingLineThickness),e.set("slurmidpointthickness",t.slurMidpointThickness),e.set("stafflinethickness",t.staffLineThickness),e.set("stemthickness",t.stemThickness),e.set("thickbarlinethickness",t.thickBarlineThickness),e.set("thinbarlinethickness",t.thinBarlineThickness),e.set("thinthickbarlineseparation",t.thinThickBarlineSeparation),e.set("tiemidpointthickness",t.tieMidpointThickness),e.set("tupletbracketthickness",t.tupletBracketThickness);{const s=new Map;e.set("stemup",s);for(const[i,r]of t.stemUp)s.set(i.toString(),Vr.toJson(r))}{const s=new Map;e.set("stemdown",s);for(const[i,r]of t.stemDown)s.set(i.toString(),Vr.toJson(r))}{const s=new Map;e.set("repeatoffsetx",s);for(const[i,r]of t.repeatOffsetX)s.set(i.toString(),r)}e.set("standardstemlength",t.standardStemLength);{const s=new Map;e.set("stemflagoffsets",s);for(const[i,r]of t.stemFlagOffsets)s.set(i.toString(),r)}{const s=new Map;e.set("glyphtop",s);for(const[i,r]of t.glyphTop)s.set(i.toString(),r)}{const s=new Map;e.set("glyphbottom",s);for(const[i,r]of t.glyphBottom)s.set(i.toString(),r)}{const s=new Map;e.set("glyphwidths",s);for(const[i,r]of t.glyphWidths)s.set(i.toString(),r)}{const s=new Map;e.set("glyphheights",s);for(const[i,r]of t.glyphHeights)s.set(i.toString(),r)}e.set("numberedbarrendererbarsize",t.numberedBarRendererBarSize),e.set("numberedbarrendererbarspacing",t.numberedBarRendererBarSpacing),e.set("numbereddashglyphpadding",t.numberedDashGlyphPadding),e.set("numbereddashglyphwidth",t.numberedDashGlyphWidth),e.set("linerangedglyphdashgap",t.lineRangedGlyphDashGap),e.set("linerangedglyphdashsize",t.lineRangedGlyphDashSize),e.set("prenoteeffectpadding",t.preNoteEffectPadding),e.set("postnoteeffectpadding",t.postNoteEffectPadding),e.set("onnoteeffectpadding",t.onNoteEffectPadding),e.set("stringnumbercirclepadding",t.stringNumberCirclePadding),e.set("rowcontainerpadding",t.rowContainerPadding),e.set("rowcontainergap",t.rowContainerGap),e.set("alternateendingspadding",t.alternateEndingsPadding),e.set("sustainpedallinepadding",t.sustainPedalLinePadding),e.set("tieheight",t.tieHeight),e.set("beattimerpadding",t.beatTimerPadding),e.set("bendnoteheadelementpadding",t.bendNoteHeadElementPadding),e.set("ghostparenthesiswidth",t.ghostParenthesisWidth),e.set("ghostparenthesispadding",t.ghostParenthesisPadding),e.set("brokenbeamwidth",t.brokenBeamWidth),e.set("tabwhammytextpadding",t.tabWhammyTextPadding),e.set("tabwhammyperhalfheight",t.tabWhammyPerHalfHeight),e.set("tabwhammydashsize",t.tabWhammyDashSize),e.set("songbookwhammydipheight",t.songBookWhammyDipHeight),e.set("deadslappedlinewidth",t.deadSlappedLineWidth),e.set("lefthandtabtiewidth",t.leftHandTabTieWidth),e.set("tabbenddashsize",t.tabBendDashSize),e.set("tabbendstaffpadding",t.tabBendStaffPadding),e.set("tabbendpervalueheight",t.tabBendPerValueHeight),e.set("tabbendlabelpadding",t.tabBendLabelPadding),e.set("simpleslidewidth",t.simpleSlideWidth),e.set("simpleslideheight",t.simpleSlideHeight),e.set("chorddiagrampaddingx",t.chordDiagramPaddingX),e.set("chorddiagrampaddingy",t.chordDiagramPaddingY),e.set("chorddiagramstringspacing",t.chordDiagramStringSpacing),e.set("chorddiagramfretspacing",t.chordDiagramFretSpacing),e.set("chorddiagramnutheight",t.chordDiagramNutHeight),e.set("chorddiagramfretheight",t.chordDiagramFretHeight),e.set("chorddiagramlinewidth",t.chordDiagramLineWidth),e.set("tripletfeelbracketpadding",t.tripletFeelBracketPadding),e.set("accidentalpadding",t.accidentalPadding),e.set("prebeatglyphspacing",t.preBeatGlyphSpacing),e.set("temponotescale",t.tempoNoteScale),e.set("tuningglyphcirclenumberscale",t.tuningGlyphCircleNumberScale),e.set("tuningglyphstringcolumnscale",t.tuningGlyphStringColumnScale),e.set("tuningglyphstringrowpadding",t.tuningGlyphStringRowPadding),e.set("directionsscale",t.directionsScale),e.set("multivoicedisplacednoteheadspacing",t.multiVoiceDisplacedNoteHeadSpacing);{const s=new Map;e.set("stemflagheight",s);for(const[i,r]of t.stemFlagHeight)s.set(i.toString(),r)}return e}static setProperty(t,e,s){switch(e){case"musicfontsize":return t.musicFontSize=s,!0;case"onestaffspace":return t.oneStaffSpace=s,!0;case"tablinespacing":return t.tabLineSpacing=s,!0;case"arrowshaftthickness":return t.arrowShaftThickness=s,!0;case"barlineseparation":return t.barlineSeparation=s,!0;case"beamspacing":return t.beamSpacing=s,!0;case"beamthickness":return t.beamThickness=s,!0;case"bracketthickness":return t.bracketThickness=s,!0;case"dashedbarlinedashlength":return t.dashedBarlineDashLength=s,!0;case"dashedbarlinegaplength":return t.dashedBarlineGapLength=s,!0;case"dashedbarlinethickness":return t.dashedBarlineThickness=s,!0;case"hairpinthickness":return t.hairpinThickness=s,!0;case"legerlinethickness":return t.legerLineThickness=s,!0;case"legerlineextension":return t.legerLineExtension=s,!0;case"octavelinethickness":return t.octaveLineThickness=s,!0;case"pedallinethickness":return t.pedalLineThickness=s,!0;case"repeatbarlinedotseparation":return t.repeatBarlineDotSeparation=s,!0;case"repeatendinglinethickness":return t.repeatEndingLineThickness=s,!0;case"slurmidpointthickness":return t.slurMidpointThickness=s,!0;case"stafflinethickness":return t.staffLineThickness=s,!0;case"stemthickness":return t.stemThickness=s,!0;case"thickbarlinethickness":return t.thickBarlineThickness=s,!0;case"thinbarlinethickness":return t.thinBarlineThickness=s,!0;case"thinthickbarlineseparation":return t.thinThickBarlineSeparation=s,!0;case"tiemidpointthickness":return t.tieMidpointThickness=s,!0;case"tupletbracketthickness":return t.tupletBracketThickness=s,!0;case"stemup":return t.stemUp=new Map,P.forEach(s,(i,r)=>{const a=new qn;Vr.fromJson(a,i),t.stemUp.set(P.parseEnum(r,f),a)}),!0;case"stemdown":return t.stemDown=new Map,P.forEach(s,(i,r)=>{const a=new qn;Vr.fromJson(a,i),t.stemDown.set(P.parseEnum(r,f),a)}),!0;case"repeatoffsetx":return t.repeatOffsetX=new Map,P.forEach(s,(i,r)=>{t.repeatOffsetX.set(P.parseEnum(r,f),i)}),!0;case"standardstemlength":return t.standardStemLength=s,!0;case"stemflagoffsets":return t.stemFlagOffsets=new Map,P.forEach(s,(i,r)=>{t.stemFlagOffsets.set(P.parseEnum(r,b),i)}),!0;case"glyphtop":return t.glyphTop=new Map,P.forEach(s,(i,r)=>{t.glyphTop.set(P.parseEnum(r,f),i)}),!0;case"glyphbottom":return t.glyphBottom=new Map,P.forEach(s,(i,r)=>{t.glyphBottom.set(P.parseEnum(r,f),i)}),!0;case"glyphwidths":return t.glyphWidths=new Map,P.forEach(s,(i,r)=>{t.glyphWidths.set(P.parseEnum(r,f),i)}),!0;case"glyphheights":return t.glyphHeights=new Map,P.forEach(s,(i,r)=>{t.glyphHeights.set(P.parseEnum(r,f),i)}),!0;case"numberedbarrendererbarsize":return t.numberedBarRendererBarSize=s,!0;case"numberedbarrendererbarspacing":return t.numberedBarRendererBarSpacing=s,!0;case"numbereddashglyphpadding":return t.numberedDashGlyphPadding=s,!0;case"numbereddashglyphwidth":return t.numberedDashGlyphWidth=s,!0;case"linerangedglyphdashgap":return t.lineRangedGlyphDashGap=s,!0;case"linerangedglyphdashsize":return t.lineRangedGlyphDashSize=s,!0;case"prenoteeffectpadding":return t.preNoteEffectPadding=s,!0;case"postnoteeffectpadding":return t.postNoteEffectPadding=s,!0;case"onnoteeffectpadding":return t.onNoteEffectPadding=s,!0;case"stringnumbercirclepadding":return t.stringNumberCirclePadding=s,!0;case"rowcontainerpadding":return t.rowContainerPadding=s,!0;case"rowcontainergap":return t.rowContainerGap=s,!0;case"alternateendingspadding":return t.alternateEndingsPadding=s,!0;case"sustainpedallinepadding":return t.sustainPedalLinePadding=s,!0;case"tieheight":return t.tieHeight=s,!0;case"beattimerpadding":return t.beatTimerPadding=s,!0;case"bendnoteheadelementpadding":return t.bendNoteHeadElementPadding=s,!0;case"ghostparenthesiswidth":return t.ghostParenthesisWidth=s,!0;case"ghostparenthesispadding":return t.ghostParenthesisPadding=s,!0;case"brokenbeamwidth":return t.brokenBeamWidth=s,!0;case"tabwhammytextpadding":return t.tabWhammyTextPadding=s,!0;case"tabwhammyperhalfheight":return t.tabWhammyPerHalfHeight=s,!0;case"tabwhammydashsize":return t.tabWhammyDashSize=s,!0;case"songbookwhammydipheight":return t.songBookWhammyDipHeight=s,!0;case"deadslappedlinewidth":return t.deadSlappedLineWidth=s,!0;case"lefthandtabtiewidth":return t.leftHandTabTieWidth=s,!0;case"tabbenddashsize":return t.tabBendDashSize=s,!0;case"tabbendstaffpadding":return t.tabBendStaffPadding=s,!0;case"tabbendpervalueheight":return t.tabBendPerValueHeight=s,!0;case"tabbendlabelpadding":return t.tabBendLabelPadding=s,!0;case"simpleslidewidth":return t.simpleSlideWidth=s,!0;case"simpleslideheight":return t.simpleSlideHeight=s,!0;case"chorddiagrampaddingx":return t.chordDiagramPaddingX=s,!0;case"chorddiagrampaddingy":return t.chordDiagramPaddingY=s,!0;case"chorddiagramstringspacing":return t.chordDiagramStringSpacing=s,!0;case"chorddiagramfretspacing":return t.chordDiagramFretSpacing=s,!0;case"chorddiagramnutheight":return t.chordDiagramNutHeight=s,!0;case"chorddiagramfretheight":return t.chordDiagramFretHeight=s,!0;case"chorddiagramlinewidth":return t.chordDiagramLineWidth=s,!0;case"tripletfeelbracketpadding":return t.tripletFeelBracketPadding=s,!0;case"accidentalpadding":return t.accidentalPadding=s,!0;case"prebeatglyphspacing":return t.preBeatGlyphSpacing=s,!0;case"temponotescale":return t.tempoNoteScale=s,!0;case"tuningglyphcirclenumberscale":return t.tuningGlyphCircleNumberScale=s,!0;case"tuningglyphstringcolumnscale":return t.tuningGlyphStringColumnScale=s,!0;case"tuningglyphstringrowpadding":return t.tuningGlyphStringRowPadding=s,!0;case"directionsscale":return t.directionsScale=s,!0;case"multivoicedisplacednoteheadspacing":return t.multiVoiceDisplacedNoteHeadSpacing=s,!0;case"stemflagheight":return t.stemFlagHeight=new Map,P.forEach(s,(i,r)=>{t.stemFlagHeight.set(P.parseEnum(r,b),i)}),!0}return!1}}class Jd{constructor(t,e,s){o(this,"startPos");o(this,"endPos");o(this,"text");this.text=t,this.startPos=e,this.endPos=s}}class Hr{constructor(t){o(this,"style","normal");o(this,"variant","normal");o(this,"weight","normal");o(this,"stretch","normal");o(this,"lineHeight","normal");o(this,"size","1rem");o(this,"families",[]);o(this,"parseOnlyFamilies",!1);o(this,"_tokens");o(this,"_currentTokenIndex",-1);o(this,"_input","");o(this,"_currentToken",null);this._input=t,this._tokens=this._splitToTokens(t)}_splitToTokens(t){const e=[];let s=0;for(;s<t.length;){let i=s;for(;i<t.length&&t.charAt(i)!==" ";)i++;i>s&&e.push(new Jd(t.substring(s,i),s,i)),s=i+1}return e}parse(){var t;if(this._reset(),this._tokens.length===1)switch((t=this._currentToken)==null?void 0:t.text){case"caption":case"icon":case"menu":case"message-box":case"small-caption":case"status-bar":case"inherit":return}this.parseOnlyFamilies||(this._fontStyleVariantWeight(),this._fontSizeLineHeight()),this._fontFamily()}static parseFamilies(t){const e=new Hr(t);return e.parseOnlyFamilies=!0,e.parse(),e.families}_fontFamily(){if(!this._currentToken){if(this.parseOnlyFamilies)return;throw new Error("Missing font list")}const t=this._input.substr(this._currentToken.startPos).trim();let e=0;for(;e<t.length;){const s=t.charAt(e);if(s===" "||s===",")e++;else if(s==='"'||s==="'"){const i=this._findEndOfQuote(t,e+1,s);this.families.push(t.substring(e+1,i).split(`\\${s}`).join(s)),e=i+1}else{const i=this._findEndOfQuote(t,e+1,",");this.families.push(t.substring(e,i).trim()),e=i+1}}}_findEndOfQuote(t,e,s){let i=!1;for(;e<t.length;){const r=t.charAt(e);if(!i&&r===s)return e;!i&&r==="\\"?i=!0:i=!1,e+=1}return t.length}_fontSizeLineHeight(){if(!this._currentToken)throw new Error("Missing font size");const t=this._currentToken.text.split("/");if(t.length>=3)throw new Error(`Invalid font size '${this._currentToken}' specified`);if(this._nextToken(),t.length>=2)if(t[1]==="/"){if(!this._currentToken)throw new Error("Missing line-height after font size");this.lineHeight=this._currentToken.text,this._nextToken()}else this.size=t[0],this.lineHeight=t[1];else if(t.length>=1){if(this.size=t[0],this._currentToken&&this._currentToken.text.indexOf("/")===0)if(this._currentToken.text==="/"){if(this._nextToken(),!this._currentToken)throw new Error("Missing line-height after font size");this.lineHeight=this._currentToken.text,this._nextToken()}else this.lineHeight=this._currentToken.text.substr(1),this._nextToken()}else throw new Error("Missing font size")}_nextToken(){this._currentTokenIndex++,this._currentTokenIndex<this._tokens.length?this._currentToken=this._tokens[this._currentTokenIndex]:this._currentToken=null}_fontStyleVariantWeight(){let t=!1,e=!1,s=!1,i=3;const r=[];for(;;){if(!this._currentToken)return;const a=this._currentToken.text;switch(a){case"normal":case"inherit":r.push(a),i--,this._nextToken();break;case"italic":case"oblique":this.style=a,t=!0,i--,this._nextToken();break;case"small-caps":this.variant=a,e=!0,i--,this._nextToken();break;case"bold":case"bolder":case"lighter":case"100":case"200":case"300":case"400":case"500":case"600":case"700":case"800":case"900":this.weight=a,s=!0,i--,this._nextToken();break;default:return}if(i===0)break}for(;r.length>0;){const a=r.pop();s?e?t||(this.style=a):this.variant=a:this.weight=a}}_reset(){this._currentTokenIndex=-1,this._nextToken()}static quoteFont(t){return t.indexOf(" ")===-1?t:`"${t.replaceAll('"','\\"')}"`}}var st;(function(n){n[n.Plain=0]="Plain",n[n.Italic=1]="Italic"})(st||(st={}));var bs;(function(n){n[n.Regular=0]="Regular",n[n.Bold=1]="Bold"})(bs||(bs={}));class Ye{constructor(t,e,s=st.Plain,i=bs.Regular){o(this,"_css");o(this,"_cssScale",0);o(this,"_families");o(this,"_style");o(this,"_weight");o(this,"_size");this._families=Hr.parseFamilies(t),this._size=e,this._style=s,this._weight=i,this._css=this.toCssString()}_reset(){this._cssScale=0,this._css=this.toCssString()}get family(){return this._families[0]}set family(t){this.families=Hr.parseFamilies(t)}get families(){return this._families}set families(t){this._families=t,this._reset()}get size(){return this._size}set size(t){this._size=t,this._reset()}get style(){return this._style}set style(t){this._style=t,this._reset()}get weight(){return this._weight}set weight(t){this._weight=t,this._reset()}get isBold(){return this.weight===bs.Bold}get isItalic(){return this.style===st.Italic}withSize(t){return Ye.withFamilyList(this._families,t,this._style,this._weight)}static withFamilyList(t,e,s=st.Plain,i=bs.Regular){const r=new Ye("",e,s,i);return r.families=t,r}toCssString(t=1){if(!this._css||!(Math.abs(t-this._cssScale)<.01)){let e="";this.isBold&&(e+="bold "),this.isItalic&&(e+="italic "),e+=this.size*t,e+="px ",e+=this.families.map(s=>Hr.quoteFont(s)).join(", "),this._css=e,this._cssScale=t}return this._css}static fromJson(t){if(t instanceof Ye)return t;switch(typeof t){case"undefined":return;case"object":{const e=t,s=e.get("families"),i=e.get("size"),r=P.parseEnum(e.get("style"),st),a=P.parseEnum(e.get("weight"),bs);return Ye.withFamilyList(s,i,r,a)}case"string":{const e=new Hr(t);e.parse();const s=e.families,i=e.size.toLowerCase();let r=0;switch(i){case"xx-small":r=7;break;case"x-small":r=10;break;case"small":case"smaller":r=13;break;case"medium":r=16;break;case"large":case"larger":r=18;break;case"x-large":r=24;break;case"xx-large":r=32;break;default:try{i.endsWith("em")?r=Number.parseFloat(i.substr(0,i.length-2))*16:i.endsWith("pt")?r=Number.parseFloat(i.substr(0,i.length-2))*16/12:i.endsWith("px")?r=Number.parseFloat(i.substr(0,i.length-2)):r=12}catch{r=12}break}let a=st.Plain;e.style==="italic"&&(a=st.Italic);let l=bs.Regular;switch(e.weight.toLowerCase()){case"normal":case"lighter":break;default:l=bs.Bold;break}return Ye.withFamilyList(s,r,a,l)}default:return}}static toJson(t){if(!t)return;const e=new Map;return e.set("families",t.families),e.set("size",t.size),e.set("style",t.style),e.set("weight",t.weight),e}}class ma{static fromJson(t,e){e&&P.forEach(e,(s,i)=>ma.setProperty(t,i.toLowerCase(),s))}static toJson(t){if(!t)return null;const e=new Map;e.set("smuflfontfamilyname",t.smuflFontFamilyName),e.set("engravingsettings",Qn.toJson(t.engravingSettings));{const s=new Map;e.set("elementfonts",s);for(const[i,r]of t.elementFonts)s.set(i.toString(),Ye.toJson(r))}return e.set("numberednotationfont",Ye.toJson(t.numberedNotationFont)),e.set("numberednotationgracefont",Ye.toJson(t.numberedNotationGraceFont)),e.set("tablaturefont",Ye.toJson(t.tablatureFont)),e.set("gracefont",Ye.toJson(t.graceFont)),e.set("stafflinecolor",qe.toJson(t.staffLineColor)),e.set("barseparatorcolor",qe.toJson(t.barSeparatorColor)),e.set("barnumbercolor",qe.toJson(t.barNumberColor)),e.set("mainglyphcolor",qe.toJson(t.mainGlyphColor)),e.set("secondaryglyphcolor",qe.toJson(t.secondaryGlyphColor)),e.set("scoreinfocolor",qe.toJson(t.scoreInfoColor)),e}static setProperty(t,e,s){switch(e){case"smuflfontfamilyname":return t.smuflFontFamilyName=s,!0;case"elementfonts":return P.forEach(s,(i,r)=>{t.elementFonts.set(P.parseEnum(r,v),Ye.fromJson(i))}),!0;case"numberednotationfont":return t.numberedNotationFont=Ye.fromJson(s),!0;case"numberednotationgracefont":return t.numberedNotationGraceFont=Ye.fromJson(s),!0;case"tablaturefont":return t.tablatureFont=Ye.fromJson(s),!0;case"gracefont":return t.graceFont=Ye.fromJson(s),!0;case"stafflinecolor":return t.staffLineColor=qe.fromJson(s),!0;case"barseparatorcolor":return t.barSeparatorColor=qe.fromJson(s),!0;case"barnumbercolor":return t.barNumberColor=qe.fromJson(s),!0;case"mainglyphcolor":return t.mainGlyphColor=qe.fromJson(s),!0;case"secondaryglyphcolor":return t.secondaryGlyphColor=qe.fromJson(s),!0;case"scoreinfocolor":return t.scoreInfoColor=qe.fromJson(s),!0}return["engravingsettings"].indexOf(e)>=0?(Qn.fromJson(t.engravingSettings,s),!0):!1}}var Wi;(function(n){n[n.Default=0]="Default",n[n.ScoreTab=1]="ScoreTab",n[n.Score=2]="Score",n[n.Tab=3]="Tab",n[n.TabMixed=4]="TabMixed"})(Wi||(Wi={}));const Oe=class Oe{constructor(){o(this,"smuflFontFamilyName");o(this,"engravingSettings",Ze.bravuraDefaults);o(this,"fingeringFont",Oe._effectFont);o(this,"inlineFingeringFont",Oe._effectFont);o(this,"effectFont",Oe._effectFont);o(this,"elementFonts",new Map);o(this,"numberedNotationFont",new Ye(Oe._sansFont,16,st.Plain));o(this,"numberedNotationGraceFont",new Ye(Oe._sansFont,14,st.Plain));o(this,"tablatureFont",new Ye(Oe._sansFont,14,st.Plain));o(this,"graceFont",new Ye(Oe._sansFont,12,st.Plain));o(this,"staffLineColor",new qe(165,165,165,255));o(this,"barSeparatorColor",new qe(34,34,17,255));o(this,"barNumberColor",new qe(200,0,0,255));o(this,"mainGlyphColor",new qe(0,0,0,255));o(this,"secondaryGlyphColor",new qe(0,0,0,100));o(this,"scoreInfoColor",new qe(0,0,0,255));for(const[t,e]of Oe.defaultFonts)this.elementFonts.set(t,e.withSize(e.size))}get copyrightFont(){return this.elementFonts.get(v.ScoreCopyright)}set copyrightFont(t){this.elementFonts.set(v.ScoreCopyright,t)}get titleFont(){return this.elementFonts.get(v.ScoreTitle)}set titleFont(t){this.elementFonts.set(v.ScoreTitle,t)}get subTitleFont(){return this.elementFonts.get(v.ScoreSubTitle)}set subTitleFont(t){this.elementFonts.set(v.ScoreSubTitle,t)}get wordsFont(){return this.elementFonts.get(v.ScoreWords)}set wordsFont(t){this.elementFonts.set(v.ScoreWords,t)}get timerFont(){return this.elementFonts.get(v.EffectBeatTimer)}set timerFont(t){this.elementFonts.set(v.EffectBeatTimer,t)}get directionsFont(){return this.elementFonts.get(v.EffectDirections)}set directionsFont(t){this.elementFonts.set(v.EffectDirections,t)}get fretboardNumberFont(){return this.elementFonts.get(v.ChordDiagramFretboardNumbers)}set fretboardNumberFont(t){this.elementFonts.set(v.ChordDiagramFretboardNumbers,t)}get markerFont(){return this.elementFonts.get(v.EffectMarker)}set markerFont(t){this.elementFonts.set(v.EffectMarker,t)}get barNumberFont(){return this.elementFonts.get(v.BarNumber)}set barNumberFont(t){this.elementFonts.set(v.BarNumber,t)}getFontForElement(t){let e=v.ScoreWords;switch(t){case V.Title:e=v.ScoreTitle;break;case V.SubTitle:e=v.ScoreSubTitle;break;case V.Artist:e=v.ScoreArtist;break;case V.Album:e=v.ScoreAlbum;break;case V.Words:e=v.ScoreWords;break;case V.Music:e=v.ScoreMusic;break;case V.WordsAndMusic:e=v.ScoreWordsAndMusic;break;case V.Copyright:case V.CopyrightSecondLine:e=v.ScoreCopyright;break;default:e=v.ScoreWords;break}return this.elementFonts.has(e)?this.elementFonts.get(e):Oe.defaultFonts.get(v.ScoreWords)}};o(Oe,"_sansFont","Arial, sans-serif"),o(Oe,"_serifFont","Georgia, serif"),o(Oe,"_effectFont",new Ye(Oe._serifFont,12,st.Italic)),o(Oe,"defaultFonts",new Map([[v.ScoreTitle,new Ye(Oe._serifFont,32,st.Plain)],[v.ScoreSubTitle,new Ye(Oe._serifFont,20,st.Plain)],[v.ScoreArtist,new Ye(Oe._serifFont,20,st.Plain)],[v.ScoreAlbum,new Ye(Oe._serifFont,20,st.Plain)],[v.ScoreWords,new Ye(Oe._serifFont,15,st.Plain)],[v.ScoreMusic,new Ye(Oe._serifFont,15,st.Plain)],[v.ScoreWordsAndMusic,new Ye(Oe._serifFont,15,st.Plain)],[v.ScoreCopyright,new Ye(Oe._sansFont,12,st.Plain,bs.Bold)],[v.EffectBeatTimer,new Ye(Oe._serifFont,12,st.Plain)],[v.EffectDirections,new Ye(Oe._serifFont,14,st.Plain)],[v.ChordDiagramFretboardNumbers,new Ye(Oe._sansFont,11,st.Plain)],[v.EffectFingering,new Ye(Oe._serifFont,14,st.Plain)],[v.EffectMarker,new Ye(Oe._serifFont,14,st.Plain,bs.Bold)],[v.EffectCapo,Oe._effectFont],[v.EffectFreeTime,Oe._effectFont],[v.EffectLyrics,Oe._effectFont],[v.EffectTap,Oe._effectFont],[v.ChordDiagrams,Oe._effectFont],[v.EffectChordNames,Oe._effectFont],[v.EffectText,Oe._effectFont],[v.EffectPalmMute,Oe._effectFont],[v.EffectLetRing,Oe._effectFont],[v.EffectBeatBarre,Oe._effectFont],[v.EffectTripletFeel,Oe._effectFont],[v.EffectHarmonics,Oe._effectFont],[v.EffectPickSlide,Oe._effectFont],[v.GuitarTuning,Oe._effectFont],[v.EffectRasgueado,Oe._effectFont],[v.EffectWhammyBar,Oe._effectFont],[v.TrackNames,Oe._effectFont],[v.RepeatCount,new Ye(Oe._sansFont,11,st.Plain)],[v.BarNumber,new Ye(Oe._sansFont,11,st.Plain)],[v.ScoreBendSlur,new Ye(Oe._sansFont,11,st.Plain)],[v.EffectAlternateEndings,new Ye(Oe._serifFont,15,st.Plain)]]));let gl=Oe;var ta;(function(n){n[n.Automatic=0]="Automatic",n[n.UseModelLayout=1]="UseModelLayout"})(ta||(ta={}));class qd{constructor(){o(this,"scale",1);o(this,"stretchForce",1);o(this,"layoutMode",Ti.Page);o(this,"staveProfile",Wi.Default);o(this,"barsPerRow",-1);o(this,"startBar",1);o(this,"barCount",-1);o(this,"barCountPerPartial",10);o(this,"justifyLastSystem",!1);o(this,"resources",new gl);o(this,"padding",[35,35]);o(this,"firstSystemPaddingTop",0);o(this,"systemPaddingTop",10);o(this,"systemPaddingBottom",10);o(this,"lastSystemPaddingBottom",5);o(this,"systemLabelPaddingLeft",0);o(this,"systemLabelPaddingRight",3);o(this,"accoladeBarPaddingRight",3);o(this,"firstNotationStaffPaddingTop",0);o(this,"lastNotationStaffPaddingBottom",0);o(this,"notationStaffPaddingTop",0);o(this,"notationStaffPaddingBottom",0);o(this,"effectStaffPaddingTop",0);o(this,"effectStaffPaddingBottom",0);o(this,"firstStaffPaddingLeft",6);o(this,"staffPaddingLeft",2);o(this,"effectBandPaddingBottom",2);o(this,"trackStaffPaddingBetween",5);o(this,"lyricLinesPaddingBetween",5);o(this,"systemsLayoutMode",ta.Automatic)}}class ya{static fromJson(t,e){e&&P.forEach(e,(s,i)=>ya.setProperty(t,i.toLowerCase(),s))}static toJson(t){if(!t)return null;const e=new Map;return e.set("scale",t.scale),e.set("stretchforce",t.stretchForce),e.set("layoutmode",t.layoutMode),e.set("staveprofile",t.staveProfile),e.set("barsperrow",t.barsPerRow),e.set("startbar",t.startBar),e.set("barcount",t.barCount),e.set("barcountperpartial",t.barCountPerPartial),e.set("justifylastsystem",t.justifyLastSystem),e.set("resources",ma.toJson(t.resources)),e.set("padding",t.padding),e.set("firstsystempaddingtop",t.firstSystemPaddingTop),e.set("systempaddingtop",t.systemPaddingTop),e.set("systempaddingbottom",t.systemPaddingBottom),e.set("lastsystempaddingbottom",t.lastSystemPaddingBottom),e.set("systemlabelpaddingleft",t.systemLabelPaddingLeft),e.set("systemlabelpaddingright",t.systemLabelPaddingRight),e.set("accoladebarpaddingright",t.accoladeBarPaddingRight),e.set("firstnotationstaffpaddingtop",t.firstNotationStaffPaddingTop),e.set("lastnotationstaffpaddingbottom",t.lastNotationStaffPaddingBottom),e.set("notationstaffpaddingtop",t.notationStaffPaddingTop),e.set("notationstaffpaddingbottom",t.notationStaffPaddingBottom),e.set("effectstaffpaddingtop",t.effectStaffPaddingTop),e.set("effectstaffpaddingbottom",t.effectStaffPaddingBottom),e.set("firststaffpaddingleft",t.firstStaffPaddingLeft),e.set("staffpaddingleft",t.staffPaddingLeft),e.set("effectbandpaddingbottom",t.effectBandPaddingBottom),e.set("trackstaffpaddingbetween",t.trackStaffPaddingBetween),e.set("lyriclinespaddingbetween",t.lyricLinesPaddingBetween),e.set("systemslayoutmode",t.systemsLayoutMode),e}static setProperty(t,e,s){switch(e){case"scale":return t.scale=s,!0;case"stretchforce":return t.stretchForce=s,!0;case"layoutmode":return t.layoutMode=P.parseEnum(s,Ti),!0;case"staveprofile":return t.staveProfile=P.parseEnum(s,Wi),!0;case"barsperrow":return t.barsPerRow=s,!0;case"startbar":return t.startBar=s,!0;case"barcount":return t.barCount=s,!0;case"barcountperpartial":return t.barCountPerPartial=s,!0;case"justifylastsystem":return t.justifyLastSystem=s,!0;case"padding":return t.padding=s,!0;case"firstsystempaddingtop":return t.firstSystemPaddingTop=s,!0;case"systempaddingtop":return t.systemPaddingTop=s,!0;case"systempaddingbottom":return t.systemPaddingBottom=s,!0;case"lastsystempaddingbottom":return t.lastSystemPaddingBottom=s,!0;case"systemlabelpaddingleft":return t.systemLabelPaddingLeft=s,!0;case"systemlabelpaddingright":return t.systemLabelPaddingRight=s,!0;case"accoladebarpaddingright":return t.accoladeBarPaddingRight=s,!0;case"firstnotationstaffpaddingtop":return t.firstNotationStaffPaddingTop=s,!0;case"lastnotationstaffpaddingbottom":return t.lastNotationStaffPaddingBottom=s,!0;case"notationstaffpaddingtop":return t.notationStaffPaddingTop=s,!0;case"notationstaffpaddingbottom":return t.notationStaffPaddingBottom=s,!0;case"effectstaffpaddingtop":return t.effectStaffPaddingTop=s,!0;case"effectstaffpaddingbottom":return t.effectStaffPaddingBottom=s,!0;case"firststaffpaddingleft":return t.firstStaffPaddingLeft=s,!0;case"staffpaddingleft":return t.staffPaddingLeft=s,!0;case"effectbandpaddingbottom":return t.effectBandPaddingBottom=s,!0;case"trackstaffpaddingbetween":return t.trackStaffPaddingBetween=s,!0;case"lyriclinespaddingbetween":return t.lyricLinesPaddingBetween=s,!0;case"systemslayoutmode":return t.systemsLayoutMode=P.parseEnum(s,ta),!0}if(["resources"].indexOf(e)>=0)return ma.fromJson(t.resources,s),!0;for(const i of["resources"])if(e.indexOf(i)===0&&ma.setProperty(t.resources,e.substring(i.length),s))return!0;return!1}}class ba{static fromJson(t,e){e&&P.forEach(e,(s,i)=>ba.setProperty(t,i.toLowerCase(),s))}static toJson(t){if(!t)return null;const e=new Map;e.set("notationmode",t.notationMode),e.set("fingeringmode",t.fingeringMode);{const s=new Map;e.set("elements",s);for(const[i,r]of t.elements)s.set(i.toString(),r)}return e.set("rhythmmode",t.rhythmMode),e.set("rhythmheight",t.rhythmHeight),e.set("transpositionpitches",t.transpositionPitches),e.set("displaytranspositionpitches",t.displayTranspositionPitches),e.set("smallgracetabnotes",t.smallGraceTabNotes),e.set("extendbendarrowsontiednotes",t.extendBendArrowsOnTiedNotes),e.set("extendlineeffectstobeatend",t.extendLineEffectsToBeatEnd),e.set("slurheight",t.slurHeight),e}static setProperty(t,e,s){switch(e){case"notationmode":return t.notationMode=P.parseEnum(s,Xt),!0;case"fingeringmode":return t.fingeringMode=P.parseEnum(s,di),!0;case"elements":return t.elements=new Map,P.forEach(s,(i,r)=>{t.elements.set(P.parseEnum(r,v),i)}),!0;case"rhythmmode":return t.rhythmMode=P.parseEnum(s,Xs),!0;case"rhythmheight":return t.rhythmHeight=s,!0;case"transpositionpitches":return t.transpositionPitches=s,!0;case"displaytranspositionpitches":return t.displayTranspositionPitches=s,!0;case"smallgracetabnotes":return t.smallGraceTabNotes=s,!0;case"extendbendarrowsontiednotes":return t.extendBendArrowsOnTiedNotes=s,!0;case"extendlineeffectstobeatend":return t.extendLineEffectsToBeatEnd=s,!0;case"slurheight":return t.slurHeight=s,!0}return!1}}class Sa{static fromJson(t,e){e&&P.forEach(e,(s,i)=>Sa.setProperty(t,i.toLowerCase(),s))}static toJson(t){if(!t)return null;const e=new Map;return e.set("encoding",t.encoding),e.set("mergepartgroupsinmusicxml",t.mergePartGroupsInMusicXml),e.set("beattextaslyrics",t.beatTextAsLyrics),e}static setProperty(t,e,s){switch(e){case"encoding":return t.encoding=s,!0;case"mergepartgroupsinmusicxml":return t.mergePartGroupsInMusicXml=s,!0;case"beattextaslyrics":return t.beatTextAsLyrics=s,!0}return!1}}class _a{static fromJson(t,e){e&&P.forEach(e,(s,i)=>_a.setProperty(t,i.toLowerCase(),s))}static toJson(t){if(!t)return null;const e=new Map;return e.set("notewidelength",t.noteWideLength),e.set("notewideamplitude",t.noteWideAmplitude),e.set("noteslightlength",t.noteSlightLength),e.set("noteslightamplitude",t.noteSlightAmplitude),e.set("beatwidelength",t.beatWideLength),e.set("beatwideamplitude",t.beatWideAmplitude),e.set("beatslightlength",t.beatSlightLength),e.set("beatslightamplitude",t.beatSlightAmplitude),e}static setProperty(t,e,s){switch(e){case"notewidelength":return t.noteWideLength=s,!0;case"notewideamplitude":return t.noteWideAmplitude=s,!0;case"noteslightlength":return t.noteSlightLength=s,!0;case"noteslightamplitude":return t.noteSlightAmplitude=s,!0;case"beatwidelength":return t.beatWideLength=s,!0;case"beatwideamplitude":return t.beatWideAmplitude=s,!0;case"beatslightlength":return t.beatSlightLength=s,!0;case"beatslightamplitude":return t.beatSlightAmplitude=s,!0}return!1}}class ka{static fromJson(t,e){e&&P.forEach(e,(s,i)=>ka.setProperty(t,i.toLowerCase(),s))}static toJson(t){if(!t)return null;const e=new Map;return e.set("simpleslidepitchoffset",t.simpleSlidePitchOffset),e.set("simpleslidedurationratio",t.simpleSlideDurationRatio),e.set("shiftslidedurationratio",t.shiftSlideDurationRatio),e}static setProperty(t,e,s){switch(e){case"simpleslidepitchoffset":return t.simpleSlidePitchOffset=s,!0;case"simpleslidedurationratio":return t.simpleSlideDurationRatio=s,!0;case"shiftslidedurationratio":return t.shiftSlideDurationRatio=s,!0}return!1}}var hi;(function(n){n[n.Off=0]="Off",n[n.Continuous=1]="Continuous",n[n.OffScreen=2]="OffScreen",n[n.Smooth=3]="Smooth"})(hi||(hi={}));class Qd{constructor(){o(this,"noteWideLength",240);o(this,"noteWideAmplitude",1);o(this,"noteSlightLength",360);o(this,"noteSlightAmplitude",.5);o(this,"beatWideLength",480);o(this,"beatWideAmplitude",2);o(this,"beatSlightLength",480);o(this,"beatSlightAmplitude",2)}}class Kd{constructor(){o(this,"simpleSlidePitchOffset",6);o(this,"simpleSlideDurationRatio",.25);o(this,"shiftSlideDurationRatio",.5)}}var Ya;(function(n){n[n.WebAudioAudioWorklets=0]="WebAudioAudioWorklets",n[n.WebAudioScriptProcessor=1]="WebAudioScriptProcessor"})(Ya||(Ya={}));var fs;(function(n){n[n.Disabled=0]="Disabled",n[n.EnabledAutomatic=1]="EnabledAutomatic",n[n.EnabledSynthesizer=2]="EnabledSynthesizer",n[n.EnabledBackingTrack=3]="EnabledBackingTrack",n[n.EnabledExternalMedia=4]="EnabledExternalMedia"})(fs||(fs={}));class Zd{constructor(){o(this,"soundFont",null);o(this,"scrollElement","html,body");o(this,"outputMode",Ya.WebAudioAudioWorklets);o(this,"enablePlayer",!1);o(this,"playerMode",fs.Disabled);o(this,"enableCursor",!0);o(this,"enableAnimatedBeatCursor",!0);o(this,"enableElementHighlighting",!0);o(this,"enableUserInteraction",!0);o(this,"scrollOffsetX",0);o(this,"scrollOffsetY",0);o(this,"scrollMode",hi.Continuous);o(this,"scrollSpeed",300);o(this,"nativeBrowserSmoothScroll",!0);o(this,"songBookBendDuration",75);o(this,"songBookDipDuration",150);o(this,"vibrato",new Qd);o(this,"slide",new Kd);o(this,"playTripletFeel",!0);o(this,"bufferTimeInMilliseconds",500)}}class wa{static fromJson(t,e){e&&P.forEach(e,(s,i)=>wa.setProperty(t,i.toLowerCase(),s))}static toJson(t){if(!t)return null;const e=new Map;return e.set("soundfont",t.soundFont),e.set("outputmode",t.outputMode),e.set("enableplayer",t.enablePlayer),e.set("playermode",t.playerMode),e.set("enablecursor",t.enableCursor),e.set("enableanimatedbeatcursor",t.enableAnimatedBeatCursor),e.set("enableelementhighlighting",t.enableElementHighlighting),e.set("enableuserinteraction",t.enableUserInteraction),e.set("scrolloffsetx",t.scrollOffsetX),e.set("scrolloffsety",t.scrollOffsetY),e.set("scrollmode",t.scrollMode),e.set("scrollspeed",t.scrollSpeed),e.set("nativebrowsersmoothscroll",t.nativeBrowserSmoothScroll),e.set("songbookbendduration",t.songBookBendDuration),e.set("songbookdipduration",t.songBookDipDuration),e.set("vibrato",_a.toJson(t.vibrato)),e.set("slide",ka.toJson(t.slide)),e.set("playtripletfeel",t.playTripletFeel),e.set("buffertimeinmilliseconds",t.bufferTimeInMilliseconds),e}static setProperty(t,e,s){switch(e){case"soundfont":return t.soundFont=s,!0;case"scrollelement":return t.scrollElement=s,!0;case"outputmode":return t.outputMode=P.parseEnum(s,Ya),!0;case"enableplayer":return t.enablePlayer=s,!0;case"playermode":return t.playerMode=P.parseEnum(s,fs),!0;case"enablecursor":return t.enableCursor=s,!0;case"enableanimatedbeatcursor":return t.enableAnimatedBeatCursor=s,!0;case"enableelementhighlighting":return t.enableElementHighlighting=s,!0;case"enableuserinteraction":return t.enableUserInteraction=s,!0;case"scrolloffsetx":return t.scrollOffsetX=s,!0;case"scrolloffsety":return t.scrollOffsetY=s,!0;case"scrollmode":return t.scrollMode=P.parseEnum(s,hi),!0;case"scrollspeed":return t.scrollSpeed=s,!0;case"nativebrowsersmoothscroll":return t.nativeBrowserSmoothScroll=s,!0;case"songbookbendduration":return t.songBookBendDuration=s,!0;case"songbookdipduration":return t.songBookDipDuration=s,!0;case"playtripletfeel":return t.playTripletFeel=s,!0;case"buffertimeinmilliseconds":return t.bufferTimeInMilliseconds=s,!0}if(["vibrato"].indexOf(e)>=0)return _a.fromJson(t.vibrato,s),!0;for(const i of["vibrato"])if(e.indexOf(i)===0&&_a.setProperty(t.vibrato,e.substring(i.length),s))return!0;if(["slide"].indexOf(e)>=0)return ka.fromJson(t.slide,s),!0;for(const i of["slide"])if(e.indexOf(i)===0&&ka.setProperty(t.slide,e.substring(i.length),s))return!0;return!1}}class Ba{static fromJson(t,e){e&&P.forEach(e,(s,i)=>Ba.setProperty(t,i.toLowerCase(),s))}static toJson(t){if(!t)return null;const e=new Map;return e.set("indent",t.indent),e.set("comments",t.comments),e}static setProperty(t,e,s){switch(e){case"indent":return t.indent=s,!0;case"comments":return t.comments=s,!0}return!1}}class dr{static fromJson(t,e){e&&P.forEach(e,(s,i)=>dr.setProperty(t,i.toLowerCase(),s))}static toJson(t){if(!t)return null;const e=new Map;return e.set("core",ga.toJson(t.core)),e.set("display",ya.toJson(t.display)),e.set("notation",ba.toJson(t.notation)),e.set("importer",Sa.toJson(t.importer)),e.set("player",wa.toJson(t.player)),e.set("exporter",Ba.toJson(t.exporter)),e}static setProperty(t,e,s){if(["core",""].indexOf(e)>=0)return ga.fromJson(t.core,s),!0;for(const i of["core",""])if(e.indexOf(i)===0&&ga.setProperty(t.core,e.substring(i.length),s))return!0;if(["display",""].indexOf(e)>=0)return ya.fromJson(t.display,s),!0;for(const i of["display",""])if(e.indexOf(i)===0&&ya.setProperty(t.display,e.substring(i.length),s))return!0;if(["notation"].indexOf(e)>=0)return ba.fromJson(t.notation,s),!0;for(const i of["notation"])if(e.indexOf(i)===0&&ba.setProperty(t.notation,e.substring(i.length),s))return!0;if(["importer"].indexOf(e)>=0)return Sa.fromJson(t.importer,s),!0;for(const i of["importer"])if(e.indexOf(i)===0&&Sa.setProperty(t.importer,e.substring(i.length),s))return!0;if(["player"].indexOf(e)>=0)return wa.fromJson(t.player,s),!0;for(const i of["player"])if(e.indexOf(i)===0&&wa.setProperty(t.player,e.substring(i.length),s))return!0;if(["exporter"].indexOf(e)>=0)return Ba.fromJson(t.exporter,s),!0;for(const i of["exporter"])if(e.indexOf(i)===0&&Ba.setProperty(t.exporter,e.substring(i.length),s))return!0;return!1}}class jd{constructor(){o(this,"encoding","utf-8");o(this,"mergePartGroupsInMusicXml",!1);o(this,"beatTextAsLyrics",!1)}}class eu{constructor(){o(this,"indent",2);o(this,"comments",!1)}}class vi{constructor(){o(this,"core",new Yc);o(this,"display",new qd);o(this,"notation",new Wo);o(this,"importer",new jd);o(this,"player",new Zd);o(this,"exporter",new eu)}setSongBookModeSettings(){this.notation.notationMode=Xt.SongBook,this.notation.smallGraceTabNotes=!1,this.notation.fingeringMode=di.SingleNoteEffectBand,this.notation.extendBendArrowsOnTiedNotes=!1,this.notation.elements.set(v.ParenthesisOnTiedBends,!1),this.notation.elements.set(v.TabNotesOnTiedBends,!1),this.notation.elements.set(v.ZerosOnDiveWhammys,!0)}static get songBook(){const t=new vi;return t.setSongBookModeSettings(),t}fillFromJson(t){dr.fromJson(this,t)}handleBackwardsCompatibility(){this.player.playerMode===fs.Disabled&&this.player.enablePlayer&&(this.player.playerMode=fs.EnabledAutomatic)}}class Lt{static _jsonReplacer(t,e){if(e instanceof Map){if("fromEntries"in Object)return Object.fromEntries(e);const s={};for(const[i,r]of e)s[i]=r;return s}return ArrayBuffer.isView(e)?Array.apply([],[e]):e}static scoreToJson(t){const e=Lt.scoreToJsObject(t);return JSON.stringify(e,Lt._jsonReplacer)}static jsonToScore(t,e){return Lt.jsObjectToScore(JSON.parse(t),e)}static scoreToJsObject(t){return Jn.toJson(t)}static jsObjectToScore(t,e){const s=new gi;return Jn.fromJson(s,t),s.finish(e??new vi),s}static settingsToJson(t){const e=Lt.settingsToJsObject(t);return JSON.stringify(e,Lt._jsonReplacer)}static jsonToSettings(t){return Lt.jsObjectToSettings(JSON.parse(t))}static settingsToJsObject(t){return dr.toJson(t)}static jsObjectToSettings(t){const e=new vi;return dr.fromJson(e,t),e}static jsObjectToMidiFile(t){const e=new xi;return P.forEach(t,(s,i)=>{switch(i){case"tickShift":e.tickShift=s;break;case"division":e.division=s;break;case"tracks":for(const r of s){const a=Lt._jsObjectToMidiTrack(r);e.tracks.push(a)}break}}),e}static _jsObjectToMidiTrack(t){const e=new Xl;return P.forEach(t,(s,i)=>{switch(i){case"events":for(const r of s){const a=Lt.jsObjectToMidiEvent(r);e.events.push(a)}break}}),e}static jsObjectToMidiEvent(t){const e=P.getValue(t,"track"),s=P.getValue(t,"tick"),i=P.getValue(t,"type");switch(i){case We.TimeSignature:return new $l(e,s,P.getValue(t,"numerator"),P.getValue(t,"denominatorIndex"),P.getValue(t,"midiClocksPerMetronomeClick"),P.getValue(t,"thirdySecondNodesInQuarter"));case We.AlphaTabRest:return new ql(e,s,P.getValue(t,"channel"));case We.AlphaTabMetronome:return new Jl(e,s,P.getValue(t,"metronomeNumerator"),P.getValue(t,"metronomeDurationInTicks"),P.getValue(t,"metronomeDurationInMilliseconds"));case We.NoteOn:return new Kl(e,s,P.getValue(t,"channel"),P.getValue(t,"noteKey"),P.getValue(t,"noteVelocity"));case We.NoteOff:return new Zl(e,s,P.getValue(t,"channel"),P.getValue(t,"noteKey"),P.getValue(t,"noteVelocity"));case We.ControlChange:return new jl(e,s,P.getValue(t,"channel"),P.getValue(t,"controller"),P.getValue(t,"value"));case We.ProgramChange:return new eh(e,s,P.getValue(t,"channel"),P.getValue(t,"program"));case We.TempoChange:const r=new th(s,0);return r.beatsPerMinute=P.getValue(t,"beatsPerMinute"),r;case We.PitchBend:return new sh(e,s,P.getValue(t,"channel"),P.getValue(t,"value"));case We.PerNotePitchBend:return new ih(e,s,P.getValue(t,"channel"),P.getValue(t,"noteKey"),P.getValue(t,"value"));case We.EndOfTrack:return new rh(e,s)}throw new Xe(ze.Format,`Unknown Midi Event type: ${i}`)}static midiFileToJsObject(t){const e=new Map;e.set("division",t.division),e.set("tickShift",t.tickShift);const s=[];for(const i of t.tracks)s.push(Lt._midiTrackToJsObject(i));return e.set("tracks",s),e}static _midiTrackToJsObject(t){const e=new Map,s=[];for(const i of t.events)s.push(Lt.midiEventToJsObject(i));return e.set("events",s),e}static midiEventToJsObject(t){const e=new Map;switch(e.set("track",t.track),e.set("tick",t.tick),e.set("type",t.type),t.type){case We.TimeSignature:e.set("numerator",t.numerator),e.set("denominatorIndex",t.denominatorIndex),e.set("midiClocksPerMetronomeClick",t.midiClocksPerMetronomeClick),e.set("thirdySecondNodesInQuarter",t.thirtySecondNodesInQuarter);break;case We.AlphaTabRest:e.set("channel",t.channel);break;case We.AlphaTabMetronome:e.set("metronomeNumerator",t.metronomeNumerator),e.set("metronomeDurationInMilliseconds",t.metronomeDurationInMilliseconds),e.set("metronomeDurationInTicks",t.metronomeDurationInTicks);break;case We.NoteOn:case We.NoteOff:e.set("channel",t.channel),e.set("noteKey",t.noteKey),e.set("noteVelocity",t.noteVelocity);break;case We.ControlChange:e.set("channel",t.channel),e.set("controller",t.controller),e.set("value",t.value);break;case We.ProgramChange:e.set("channel",t.channel),e.set("program",t.program);break;case We.TempoChange:e.set("beatsPerMinute",t.beatsPerMinute);break;case We.PitchBend:e.set("channel",t.channel),e.set("value",t.value);break;case We.PerNotePitchBend:e.set("channel",t.channel),e.set("noteKey",t.noteKey),e.set("value",t.value);break;case We.EndOfTrack:break}return e}}class hh{constructor(t,e){o(this,"_player");o(this,"_main");o(this,"_exporter",new Map);this._main=t,this._main.addEventListener("message",this.handleMessage.bind(this)),this._player=new Pc(new Ws,e),this._player.positionChanged.on(this.onPositionChanged.bind(this)),this._player.stateChanged.on(this.onPlayerStateChanged.bind(this)),this._player.finished.on(this.onFinished.bind(this)),this._player.soundFontLoaded.on(this.onSoundFontLoaded.bind(this)),this._player.soundFontLoadFailed.on(this.onSoundFontLoadFailed.bind(this)),this._player.soundFontLoadFailed.on(this.onSoundFontLoadFailed.bind(this)),this._player.midiLoaded.on(this.onMidiLoaded.bind(this)),this._player.midiLoadFailed.on(this.onMidiLoadFailed.bind(this)),this._player.readyForPlayback.on(this.onReadyForPlayback.bind(this)),this._player.midiEventsPlayed.on(this.onMidiEventsPlayed.bind(this)),this._player.playbackRangeChanged.on(this.onPlaybackRangeChanged.bind(this)),this._main.postMessage({cmd:"alphaSynth.ready"})}static init(){const t=fe.globalThis;t.addEventListener("message",e=>{const s=e.data;switch(s.cmd){case"alphaSynth.initialize":Ws.preferredSampleRate=s.sampleRate,L.logLevel=s.logLevel,fe.globalThis.alphaSynthWebWorker=new hh(t,s.bufferTimeInMilliseconds);break}})}handleMessage(t){const e=t.data,s=e.cmd;switch(s){case"alphaSynth.setLogLevel":L.logLevel=e.value;break;case"alphaSynth.setMasterVolume":this._player.masterVolume=e.value;break;case"alphaSynth.setMetronomeVolume":this._player.metronomeVolume=e.value;break;case"alphaSynth.setPlaybackSpeed":this._player.playbackSpeed=e.value;break;case"alphaSynth.setTickPosition":this._player.tickPosition=e.value;break;case"alphaSynth.setTimePosition":this._player.timePosition=e.value;break;case"alphaSynth.setPlaybackRange":this._player.playbackRange=e.value;break;case"alphaSynth.setIsLooping":this._player.isLooping=e.value;break;case"alphaSynth.setCountInVolume":this._player.countInVolume=e.value;break;case"alphaSynth.setMidiEventsPlayedFilter":this._player.midiEventsPlayedFilter=e.value;break;case"alphaSynth.play":this._player.play();break;case"alphaSynth.pause":this._player.pause();break;case"alphaSynth.playPause":this._player.playPause();break;case"alphaSynth.stop":this._player.stop();break;case"alphaSynth.playOneTimeMidiFile":this._player.playOneTimeMidiFile(Lt.jsObjectToMidiFile(e.midi));break;case"alphaSynth.loadSoundFontBytes":this._player.loadSoundFont(e.data,e.append);break;case"alphaSynth.resetSoundFonts":this._player.resetSoundFonts();break;case"alphaSynth.loadMidi":this._player.loadMidiFile(Lt.jsObjectToMidiFile(e.midi));break;case"alphaSynth.setChannelMute":this._player.setChannelMute(e.channel,e.mute);break;case"alphaSynth.setChannelTranspositionPitch":this._player.setChannelTranspositionPitch(e.channel,e.semitones);break;case"alphaSynth.setChannelSolo":this._player.setChannelSolo(e.channel,e.solo);break;case"alphaSynth.setChannelVolume":this._player.setChannelVolume(e.channel,e.volume);break;case"alphaSynth.resetChannelStates":this._player.resetChannelStates();break;case"alphaSynth.destroy":this._player.destroy(),this._main.postMessage({cmd:"alphaSynth.destroyed"});break;case"alphaSynth.applyTranspositionPitches":this._player.applyTranspositionPitches(new Map(JSON.parse(e.transpositionPitches)));break}s.startsWith("alphaSynth.exporter")&&this._handleExporterMessage(t)}_handleExporterMessage(t){const e=t.data,s=e.cmd;try{switch(s){case"alphaSynth.exporter.initialize":const i=this._player.exportAudio(e.options,Lt.jsObjectToMidiFile(e.midi),e.syncPoints,e.transpositionPitches);this._exporter.set(e.exporterId,i),this._main.postMessage({cmd:"alphaSynth.exporter.initialized",exporterId:e.exporterId});break;case"alphaSynth.exporter.render":if(this._exporter.has(e.exporterId)){const a=this._exporter.get(e.exporterId).render(e.milliseconds);this._main.postMessage({cmd:"alphaSynth.exporter.rendered",exporterId:e.exporterId,chunk:a})}else this._main.postMessage({cmd:"alphaSynth.exporter.error",exporterId:e.exporterId,error:new Error("Unknown exporter ID")});break;case"alphaSynth.exporter.destroy":this._exporter.delete(e.exporterId);break}}catch(i){this._main.postMessage({cmd:"alphaSynth.exporter.error",exporterId:e.exporterId,error:i})}}onPositionChanged(t){this._main.postMessage({cmd:"alphaSynth.positionChanged",currentTime:t.currentTime,endTime:t.endTime,currentTick:t.currentTick,endTick:t.endTick,isSeek:t.isSeek,originalTempo:t.originalTempo,modifiedTempo:t.modifiedTempo})}onPlayerStateChanged(t){this._main.postMessage({cmd:"alphaSynth.playerStateChanged",state:t.state,stopped:t.stopped})}onFinished(){this._main.postMessage({cmd:"alphaSynth.finished"})}onSoundFontLoaded(){this._main.postMessage({cmd:"alphaSynth.soundFontLoaded"})}onSoundFontLoadFailed(t){this._main.postMessage({cmd:"alphaSynth.soundFontLoadFailed",error:this._serializeException(fe.prepareForPostMessage(t))})}_serializeException(t){const e=JSON.parse(JSON.stringify(t));return t.message&&(e.message=t.message),t.stack&&(e.stack=t.stack),t.constructor&&t.constructor.name&&(e.type=t.constructor.name),e}onMidiLoaded(t){this._main.postMessage({cmd:"alphaSynth.midiLoaded",currentTime:t.currentTime,endTime:t.endTime,currentTick:t.currentTick,endTick:t.endTick,isSeek:t.isSeek,originalTempo:t.originalTempo,modifiedTempo:t.modifiedTempo})}onMidiLoadFailed(t){this._main.postMessage({cmd:"alphaSynth.midiLoaded",error:this._serializeException(fe.prepareForPostMessage(t))})}onReadyForPlayback(){this._main.postMessage({cmd:"alphaSynth.readyForPlayback"})}onMidiEventsPlayed(t){this._main.postMessage({cmd:"alphaSynth.midiEventsPlayed",events:t.events.map(Lt.midiEventToJsObject)})}onPlaybackRangeChanged(t){this._main.postMessage({cmd:"alphaSynth.playbackRangeChanged",playbackRange:t.playbackRange})}}var xs;(function(n){n[n.Browser=0]="Browser",n[n.NodeJs=1]="NodeJs",n[n.BrowserModule=2]="BrowserModule"})(xs||(xs={}));class ml{constructor(t,e){o(this,"characterWidths");o(this,"characterHeights");this.characterWidths=t,this.characterHeights=e}}const Ys=class Ys{static generateFontLookup(t){if(!Ys.fontSizeLookupTables.has(t))if(!fe.isRunningInWorker&&fe.webPlatform!==xs.NodeJs){const s=document.createElement("canvas").getContext("2d"),i=11;s.font=`${i}px ${t}`;const r=[],a=[];for(let h=Ys.ControlChars;h<255;h++){const c=String.fromCharCode(h),d=s.measureText(c);r.push(d.width);const u=d.actualBoundingBoxDescent+d.actualBoundingBoxAscent;a.push(u)}const l=new ml(new Uint8Array(r),new Uint8Array(a));Ys.fontSizeLookupTables.set(t,l)}else{const e=new ml(new Uint8Array([8]),new Uint8Array([10]));Ys.fontSizeLookupTables.set(t,e)}}static measureString(t,e,s,i,r){let a,h=e[0];for(let p=0;p<e.length;p++)if(Ys.fontSizeLookupTables.has(e[p])){h=e[p];break}Ys.fontSizeLookupTables.has(h)||Ys.generateFontLookup(h),a=Ys.fontSizeLookupTables.get(h);let c=1;i===st.Italic&&(c*=1.1),r===bs.Bold&&(c*=1.1);let d=0,u=0;for(let p=0;p<t.length;p++){const g=Math.min(a.characterWidths.length-1,t.charCodeAt(p)-Ys.ControlChars);g>=0&&(d+=a.characterWidths[g]*s/11,u=Math.max(u,a.characterHeights[g]*s/11))}return c*=1.07,new en(d*c,u)}};o(Ys,"fontSizeLookupTables",new Map),o(Ys,"ControlChars",32);let Lr=Ys;class Hi{constructor(){o(this,"id",A.newGuid());o(this,"reuseViewport",!0);o(this,"x",0);o(this,"y",0);o(this,"width",0);o(this,"height",0);o(this,"totalWidth",0);o(this,"totalHeight",0);o(this,"firstMasterBarIndex",-1);o(this,"lastMasterBarIndex",-1);o(this,"renderResult",null)}}class ch{constructor(){o(this,"masterBarBounds");o(this,"visualBounds");o(this,"realBounds");o(this,"bar");o(this,"beats",[])}addBeat(t){t.barBounds=this,this.beats.push(t),this.masterBarBounds.addBeat(t)}findBeatAtPos(t){let e=null;for(const s of this.beats)if(!e||s.realBounds.x<t)e=s;else if(s.realBounds.x>t)break;return e}finish(t=1){this.realBounds.scaleWith(t),this.visualBounds.scaleWith(t),this.beats.sort((e,s)=>e.realBounds.x-s.realBounds.x);for(const e of this.beats)e.finish(t)}}class dh{constructor(){o(this,"barBounds");o(this,"visualBounds");o(this,"onNotesX",0);o(this,"realBounds");o(this,"beat");o(this,"notes",null)}addNote(t){this.notes||(this.notes=[]),t.beatBounds=this,this.notes.push(t)}findNoteAtPos(t,e){const s=this.notes;if(!s)return null;for(const i of s){const r=i.noteHeadBounds.y+i.noteHeadBounds.h,a=i.noteHeadBounds.x+i.noteHeadBounds.w;if(i.noteHeadBounds.x<=t&&i.noteHeadBounds.y<=e&&t<=a&&e<=r)return i.note}return null}finish(t=1){if(this.realBounds.scaleWith(t),this.visualBounds.scaleWith(t),this.onNotesX*=t,this.notes)for(const e of this.notes)e.finish(t)}}class uh{constructor(){o(this,"index",0);o(this,"isFirstOfLine",!1);o(this,"visualBounds");o(this,"realBounds");o(this,"lineAlignedBounds");o(this,"bars",[]);o(this,"staffSystemBounds",null)}get staveGroupBounds(){return this.staffSystemBounds}addBar(t){t.masterBarBounds=this,this.bars.push(t)}findBeatAtPos(t){let e=null;const s=1e7;for(const i of this.bars){const r=i.findBeatAtPos(t);if(r&&(!e||e.realBounds.x<r.realBounds.x)){const a=Math.abs(r.realBounds.x-t);(!e||a<s)&&(e=r)}}return e?e.beat:null}finish(t=1){this.realBounds.scaleWith(t),this.visualBounds.scaleWith(t),this.lineAlignedBounds.scaleWith(t),this.bars.sort((e,s)=>e.realBounds.y<s.realBounds.y?-1:e.realBounds.y>s.realBounds.y?1:e.realBounds.x<s.realBounds.x?-1:e.realBounds.x>s.realBounds.x?1:0);for(const e of this.bars)e.finish(t)}addBeat(t){this.staffSystemBounds.boundsLookup.addBeat(t)}}class na{constructor(){o(this,"beatBounds");o(this,"noteHeadBounds");o(this,"note")}finish(t=1){this.noteHeadBounds.scaleWith(t)}}class fh{constructor(){o(this,"index",0);o(this,"visualBounds");o(this,"realBounds");o(this,"bars",[]);o(this,"boundsLookup")}finish(t=1){this.realBounds.scaleWith(t),this.visualBounds.scaleWith(t);for(const e of this.bars)e.finish(t)}addBar(t){this.boundsLookup.addMasterBar(t),t.staffSystemBounds=this,this.bars.push(t)}findBarAtPos(t){let e=null;for(const s of this.bars)if(!e||s.realBounds.x<t)e=s;else if(t>s.realBounds.x+s.realBounds.w)break;return e}}class ws{constructor(){o(this,"_beatLookup",new Map);o(this,"_masterBarLookup",new Map);o(this,"_currentStaffSystem",null);o(this,"staffSystems",[]);o(this,"isFinished",!1)}toJson(){const t={},e=[];t.staffSystems=e;for(const s of this.staffSystems){const i={};i.visualBounds=this._boundsToJson(s.visualBounds),i.realBounds=this._boundsToJson(s.realBounds),i.bars=[];for(const r of s.bars){const a={};a.lineAlignedBounds=this._boundsToJson(r.lineAlignedBounds),a.visualBounds=this._boundsToJson(r.visualBounds),a.realBounds=this._boundsToJson(r.realBounds),a.index=r.index,a.isFirstOfLine=r.isFirstOfLine,a.bars=[];for(const l of r.bars){const h={};h.visualBounds=this._boundsToJson(l.visualBounds),h.realBounds=this._boundsToJson(l.realBounds),h.beats=[];for(const c of l.beats){const d={};d.visualBounds=this._boundsToJson(c.visualBounds),d.realBounds=this._boundsToJson(c.realBounds),d.onNotesX=c.onNotesX;const u=d;if(u.beatIndex=c.beat.index,u.voiceIndex=c.beat.voice.index,u.barIndex=c.beat.voice.bar.index,u.staffIndex=c.beat.voice.bar.staff.index,u.trackIndex=c.beat.voice.bar.staff.track.index,c.notes){const p=[];d.notes=p;for(const g of c.notes){const m={},y=m;y.index=g.note.index,m.noteHeadBounds=this._boundsToJson(g.noteHeadBounds),p.push(m)}}h.beats.push(d)}a.bars.push(h)}i.bars.push(a)}e.push(i)}return t}static fromJson(t,e){const s=new ws,i=t.staffSystems;for(const r of i){const a=new fh;a.visualBounds=ws._boundsFromJson(r.visualBounds),a.realBounds=ws._boundsFromJson(r.realBounds),s.addStaffSystem(a);for(const l of r.bars){const h=new uh;h.index=l.index,h.isFirstOfLine=l.isFirstOfLine,h.lineAlignedBounds=ws._boundsFromJson(l.lineAlignedBounds),h.visualBounds=ws._boundsFromJson(l.visualBounds),h.realBounds=ws._boundsFromJson(l.realBounds),s.addMasterBar(h);for(const c of l.bars){const d=new ch;d.visualBounds=ws._boundsFromJson(c.visualBounds),d.realBounds=ws._boundsFromJson(c.realBounds),h.addBar(d);for(const u of c.beats){const p=new dh;p.visualBounds=ws._boundsFromJson(u.visualBounds),p.realBounds=ws._boundsFromJson(u.realBounds),p.onNotesX=u.onNotesX;const g=u;if(p.beat=e.tracks[g.trackIndex].staves[g.staffIndex].bars[g.barIndex].voices[g.voiceIndex].beats[g.beatIndex],u.notes){p.notes=[];for(const m of u.notes){const y=new na,S=m;y.note=p.beat.notes[S.index],y.noteHeadBounds=ws._boundsFromJson(m.noteHeadBounds),p.addNote(y)}}d.addBeat(p)}}}}return s}static _boundsFromJson(t){const e=new Pt;return e.x=t.x,e.y=t.y,e.w=t.w,e.h=t.h,e}_boundsToJson(t){const e={};return e.x=t.x,e.y=t.y,e.w=t.w,e.h=t.h,e}finish(t=1){for(const e of this.staffSystems)e.finish(t);this.isFinished=!0}addStaffSystem(t){t.index=this.staffSystems.length,t.boundsLookup=this,this.staffSystems.push(t),this._currentStaffSystem=t}addMasterBar(t){t.staffSystemBounds?this._masterBarLookup.set(t.index,t):(t.staffSystemBounds=this._currentStaffSystem,this._masterBarLookup.set(t.index,t),this._currentStaffSystem.addBar(t))}addBeat(t){var e;this._beatLookup.has(t.beat.id)||this._beatLookup.set(t.beat.id,[]),(e=this._beatLookup.get(t.beat.id))==null||e.push(t)}findMasterBarByIndex(t){return this._masterBarLookup.has(t)?this._masterBarLookup.get(t):null}findMasterBar(t){const e=t.index;return this._masterBarLookup.has(e)?this._masterBarLookup.get(e):null}findBeat(t){const e=this.findBeats(t);return e?e[0]:null}findBeats(t){const e=t.id;return this._beatLookup.has(e)?this._beatLookup.get(e):null}getBeatAtPos(t,e){let s=0,i=this.staffSystems.length-1,r=-1;for(;s<=i;){const h=(i+s)/2|0,c=this.staffSystems[h];if(e>=c.realBounds.y&&e<=c.realBounds.y+c.realBounds.h){r=h;break}e<c.realBounds.y?i=h-1:s=h+1}if(r===-1)return null;const l=this.staffSystems[r].findBarAtPos(t);return l?l.findBeatAtPos(t):null}getNoteAtPos(t,e,s){const i=this.findBeats(t);if(i)for(const r of i){const a=r.findNoteAtPos(e,s);if(a)return a}return null}}class Gr{constructor(t){o(this,"_currentLayoutMode",Ti.Page);o(this,"_currentRenderEngine",null);o(this,"_renderedTracks",null);o(this,"canvas",null);o(this,"score",null);o(this,"tracks",null);o(this,"layout",null);o(this,"settings");o(this,"boundsLookup",null);o(this,"width",0);o(this,"preRender",new xe);o(this,"renderFinished",new xe);o(this,"partialRenderFinished",new xe);o(this,"partialLayoutFinished",new xe);o(this,"postRenderFinished",new Ct);o(this,"error",new xe);this.settings=t,this._recreateCanvas(),this._recreateLayout()}destroy(){var t;this.score=null,(t=this.canvas)==null||t.destroy(),this.canvas=null,this.layout=null,this.boundsLookup=null,this.tracks=null}_recreateCanvas(){var t;return this._currentRenderEngine!==this.settings.core.engine?((t=this.canvas)==null||t.destroy(),this.canvas=fe.getRenderEngineFactory(this.settings.core.engine).createCanvas(),this._currentRenderEngine=this.settings.core.engine,!0):!1}_recreateLayout(){return!this.layout||this._currentLayoutMode!==this.settings.display.layoutMode?(this.layout=fe.getLayoutEngineFactory(this.settings.display.layoutMode).createLayout(this),this._currentLayoutMode=this.settings.display.layoutMode,!0):!1}renderScore(t,e,s){try{this.score=t;let i=null;if(t!=null&&e!=null){if(!e)i=t.tracks.slice(0);else{i=[];for(const r of e)r>=0&&r<t.tracks.length&&i.push(t.tracks[r])}i.length===0&&t.tracks.length>0&&i.push(t.tracks[0])}this.tracks=i,this.render(s)}catch(i){this.error.trigger(i)}}renderTracks(t){t.length===0?this.score=null:this.score=t[0].score,this.tracks=t,this.render()}updateSettings(t){this.settings=t}renderResult(t){try{const e=this.layout;e?(L.debug("Rendering",`Request render of lazy partial ${t}`),e.renderLazyPartial(t)):L.warning("Rendering",`Request render of lazy partial ${t} ignored, no layout exists`)}catch(e){this.error.trigger(e)}}render(t){if(this.width===0){L.warning("Rendering","AlphaTab skipped rendering because of width=0 (element invisible)",null);return}if(this.boundsLookup=new ws,this._recreateCanvas(),this.canvas.lineWidth=1,this.canvas.settings=this.settings,!this.tracks||this.tracks.length===0||!this.score)L.debug("Rendering","Clearing rendered tracks because no score or tracks are set"),this.preRender.trigger(!1),this._renderedTracks=null,this._onRenderFinished(),this.postRenderFinished.trigger(),L.debug("Rendering","Clearing finished");else{L.debug("Rendering",`Rendering ${this.tracks.length} tracks`);for(let e=0;e<this.tracks.length;e++){const s=this.tracks[e];L.debug("Rendering",`Track ${e}: ${s.name}`)}this.preRender.trigger(!1),this._recreateLayout(),this._layoutAndRender(t),L.debug("Rendering","Rendering finished")}}resizeRender(){this._recreateLayout()||this._recreateCanvas()||this._renderedTracks!==this.tracks||!this.tracks?(L.debug("Rendering","Starting full rerendering due to layout or canvas change",null),this.render()):this.layout.supportsResize?(L.debug("Rendering","Starting optimized rerendering for resize"),this.boundsLookup=new ws,this.preRender.trigger(!0),this.canvas.settings=this.settings,this.layout.resize(),this._onRenderFinished(),this.postRenderFinished.trigger()):L.debug("Rendering","Current layout does not support dynamic resizing, nothing was done",null),L.debug("Rendering","Resize finished")}_layoutAndRender(t){L.debug("Rendering",`Rendering at scale ${this.settings.display.scale} with layout ${this.layout.name}`,null),this.layout.layoutAndRender(t),this._renderedTracks=this.tracks,this._onRenderFinished(),this.postRenderFinished.trigger()}_onRenderFinished(){var e;(e=this.boundsLookup)==null||e.finish(this.settings.display.scale);const t=new Hi;t.totalHeight=this.layout.height,t.totalWidth=this.layout.width,t.renderResult=this.canvas.onRenderFinished(),this.renderFinished.trigger(t)}}class ph{constructor(t){o(this,"_renderer");o(this,"_main");this._main=t,this._main.addEventListener("message",this._handleMessage.bind(this),!1)}static init(){fe.globalThis.alphaTabWebWorker=new ph(fe.globalThis)}_handleMessage(t){const e=t.data;switch(e?e.cmd:""){case"alphaTab.initialize":const i=Lt.jsObjectToSettings(e.settings);L.logLevel=i.core.logLevel,this._renderer=new Gr(i),this._renderer.partialRenderFinished.on(a=>{this._main.postMessage({cmd:"alphaTab.partialRenderFinished",result:a})}),this._renderer.partialLayoutFinished.on(a=>{this._main.postMessage({cmd:"alphaTab.partialLayoutFinished",result:a})}),this._renderer.renderFinished.on(a=>{this._main.postMessage({cmd:"alphaTab.renderFinished",result:a})}),this._renderer.postRenderFinished.on(()=>{var a;this._main.postMessage({cmd:"alphaTab.postRenderFinished",boundsLookup:((a=this._renderer.boundsLookup)==null?void 0:a.toJson())??null})}),this._renderer.preRender.on(a=>{this._main.postMessage({cmd:"alphaTab.preRender",resize:a})}),this._renderer.error.on(this._error.bind(this));break;case"alphaTab.render":this._renderer.render(e.renderHints);break;case"alphaTab.resizeRender":this._renderer.resizeRender();break;case"alphaTab.renderResult":this._renderer.renderResult(e.resultId);break;case"alphaTab.setWidth":this._renderer.width=e.width;break;case"alphaTab.renderScore":this._updateFontSizes(e.fontSizes);const r=e.score==null?null:Lt.jsObjectToScore(e.score,this._renderer.settings);this._renderMultiple(r,e.trackIndexes);break;case"alphaTab.updateSettings":this._updateSettings(e.settings);break}}_updateFontSizes(t){if(!(t instanceof Map)){const e=t;t=new Map;for(const s in e)t.set(s,e[s])}if(t)for(const[e,s]of t)Lr.fontSizeLookupTables.set(e,s)}_updateSettings(t){dr.fromJson(this._renderer.settings,t)}_renderMultiple(t,e,s){try{this._renderer.renderScore(t,e,s)}catch(i){this._error(i)}}_error(t){L.error("Worker","An unexpected error occurred in worker",t),this._main.postMessage({cmd:"alphaTab.error",error:t})}}class tu{constructor(){o(this,"_measureCanvas");o(this,"_measureContext");o(this,"_canvas",null);o(this,"_context");o(this,"_color",new qe(0,0,0,255));o(this,"_font",new Ye("Arial",10,st.Plain));o(this,"_musicFont");o(this,"_lineWidth",0);o(this,"settings");this._measureCanvas=document.createElement("canvas"),this._measureCanvas.width=10,this._measureCanvas.height=10,this._measureCanvas.style.width="10px",this._measureCanvas.style.height="10px",this._measureContext=this._measureCanvas.getContext("2d"),this._measureContext.textBaseline="hanging"}destroy(){}onRenderFinished(){return null}beginRender(t,e){this._musicFont=new Ye(this.settings.display.resources.smuflFontFamilyName,this.settings.display.resources.engravingSettings.musicFontSize,st.Plain,bs.Regular);const s=this.settings.display.scale;this._canvas=document.createElement("canvas"),this._canvas.width=t*fe.highDpiFactor|0,this._canvas.height=e*fe.highDpiFactor|0,this._canvas.style.width=`${t}px`,this._canvas.style.height=`${e}px`,this._context=this._canvas.getContext("2d"),this._context.textBaseline="hanging",this._context.scale(fe.highDpiFactor*s,fe.highDpiFactor*s),this._context.lineWidth=this._lineWidth}endRender(){const t=this._canvas;return this._canvas=null,t}get color(){return this._color}set color(t){this._color.rgba!==t.rgba&&(this._color=t,this._context.strokeStyle=t.rgba,this._context.fillStyle=t.rgba)}get lineWidth(){return this._lineWidth}set lineWidth(t){this._lineWidth=t,this._context&&(this._context.lineWidth=t)}fillRect(t,e,s,i){s>0&&this._context.fillRect(t,e,s,i)}strokeRect(t,e,s,i){const r=this.lineWidth%2===0?0:.5;this._context.strokeRect(t+r,e+r,s,i)}beginPath(){this._context.beginPath()}closePath(){this._context.closePath()}moveTo(t,e){this._context.moveTo(t,e)}lineTo(t,e){this._context.lineTo(t,e)}quadraticCurveTo(t,e,s,i){this._context.quadraticCurveTo(t,e,s,i)}bezierCurveTo(t,e,s,i,r,a){this._context.bezierCurveTo(t,e,s,i,r,a)}fillCircle(t,e,s){this._context.beginPath(),this._context.arc(t,e,s,0,Math.PI*2,!0),this.fill()}strokeCircle(t,e,s){this._context.beginPath(),this._context.arc(t,e,s,0,Math.PI*2,!0),this.stroke()}fill(){this._context.fill(),this._context.beginPath()}stroke(){this._context.stroke(),this._context.beginPath()}get font(){return this._font}set font(t){this._font=t,this._context&&(this._context.font=t.toCssString(1)),this._measureContext.font=t.toCssString(1)}get textAlign(){switch(this._context.textAlign){case"left":return X.Left;case"center":return X.Center;case"right":return X.Right;default:return X.Left}}set textAlign(t){switch(t){case X.Left:this._context.textAlign="left";break;case X.Center:this._context.textAlign="center";break;case X.Right:this._context.textAlign="right";break}}get textBaseline(){switch(this._context.textBaseline){case"hanging":return Ue.Top;case"middle":return Ue.Middle;case"bottom":return Ue.Bottom;case"alphabetic":return Ue.Alphabetic;default:return Ue.Top}}set textBaseline(t){switch(t){case Ue.Top:this._context.textBaseline="hanging";break;case Ue.Middle:this._context.textBaseline="middle";break;case Ue.Bottom:this._context.textBaseline="bottom";break;case Ue.Alphabetic:this._context.textBaseline="alphabetic";break}}beginGroup(t){}endGroup(){}fillText(t,e,s){this._context.fillText(t,e,s)}measureText(t){const e=this._measureContext.measureText(t);return new en(e.width,e.actualBoundingBoxDescent+e.actualBoundingBoxAscent)}fillMusicFontSymbol(t,e,s,i,r=!1){i!==f.None&&this._fillMusicFontSymbolText(t,e,s,String.fromCharCode(i),r)}fillMusicFontSymbols(t,e,s,i,r=!1){let a="";for(const l of i)l!==f.None&&(a+=String.fromCharCode(l));this._fillMusicFontSymbolText(t,e,s,a,r)}_fillMusicFontSymbolText(t,e,s,i,r){const a=this._context.textAlign,l=this._context.textBaseline,h=this._context.font;this._context.font=this._musicFont.toCssString(s),this._context.textBaseline="alphabetic",r?this._context.textAlign="center":this._context.textAlign="left",this._context.fillText(i,t,e),this._context.textBaseline=l,this._context.font=h,this._context.textAlign=a}beginRotate(t,e,s){this._context.save(),this._context.translate(t,e),this._context.rotate(s*Math.PI/180)}endRotate(){this._context.restore()}}class si{constructor(t,e=!1){o(this,"_midiFile");o(this,"_smf1Mode");o(this,"tickShift",0);this._midiFile=t,this._smf1Mode=e}addTickShift(t){this._midiFile.tickShift=t,this.tickShift=t}addTimeSignature(t,e,s){t+=this.tickShift;let i=0,r=s;for(;r=r>>1,r>0;)i++;this._midiFile.addEvent(new $l(0,t,e,i,48,8))}addRest(t,e,s){e+=this.tickShift,this._smf1Mode||this._midiFile.addEvent(new ql(t,e,s))}addNote(t,e,s,i,r,a){e+=this.tickShift,this._midiFile.addEvent(new Kl(t,e,a,si._fixValue(i),si._fixValue(r))),this._midiFile.addEvent(new Zl(t,e+s,a,si._fixValue(i),si._fixValue(r)))}static _fixValue(t){return t>127?127:t<0?0:t}addControlChange(t,e,s,i,r){e+=this.tickShift,this._midiFile.addEvent(new jl(t,e,s,i,si._fixValue(r)))}addProgramChange(t,e,s,i){e+=this.tickShift,this._midiFile.addEvent(new eh(t,e,s,i))}addTempo(t,e){t+=this.tickShift;const s=new th(t,0);s.beatsPerMinute=e,this._midiFile.addEvent(s)}addBend(t,e,s,i){e+=this.tickShift,i>=ye.MaxPitchWheel?i=ye.MaxPitchWheel:i=Math.floor(i),this._midiFile.addEvent(new sh(t,e,s,i))}addNoteBend(t,e,s,i,r){e+=this.tickShift,this._smf1Mode?this.addBend(t,e,s,r):(r=r*ye.MaxPitchWheel20/ye.MaxPitchWheel,this._midiFile.addEvent(new ih(t,e,s,i,r)))}finishTrack(t,e){e+=this.tickShift,(this._midiFile.format===vr.MultiTrack||t===0)&&this._midiFile.addEvent(new rh(t,e))}}class su{constructor(t,e){o(this,"group");o(this,"opening");o(this,"iterations");o(this,"closingIndex",0);this.group=t,this.opening=e,t.closings=t.closings.sort((s,i)=>s.index-i.index),this.iterations=t.closings.map(s=>0)}}var Gt;(function(n){n[n.PlayingNormally=0]="PlayingNormally",n[n.DirectionJumped=1]="DirectionJumped",n[n.DirectionJumpedAlCoda=2]="DirectionJumpedAlCoda",n[n.DirectionJumpedAlDoubleCoda=3]="DirectionJumpedAlDoubleCoda",n[n.DirectionJumpedAlFine=4]="DirectionJumpedAlFine"})(Gt||(Gt={}));class iu{constructor(t){o(this,"_score");o(this,"_repeatStack",[]);o(this,"_groupsOnStack",new Set);o(this,"_previousAlternateEndings",0);o(this,"_state",Gt.PlayingNormally);o(this,"shouldPlay",!0);o(this,"index",0);o(this,"currentTick",0);this._score=t}get finished(){return this.index>=this._score.masterBars.length}processCurrent(){const t=this._score.masterBars[this.index];if(this._state===Gt.PlayingNormally){let e=t.alternateEndings;if(e===0&&(e=this._previousAlternateEndings),t===t.repeatGroup.opening&&t.repeatGroup.isClosed&&!this._groupsOnStack.has(t.repeatGroup)){const s=new su(t.repeatGroup,t);this._repeatStack.push(s),this._groupsOnStack.add(t.repeatGroup),this._previousAlternateEndings=0,e=t.alternateEndings}if(this._repeatStack.length===0||e===0)this.shouldPlay=!0;else{const s=this._repeatStack[this._repeatStack.length-1],i=s.iterations[s.closingIndex];this._previousAlternateEndings=e,e&1<<i?this.shouldPlay=!0:this.shouldPlay=!1}}else this.shouldPlay=!0;this.shouldPlay&&(this.currentTick+=t.calculateDuration())}moveNext(){this._moveNextWithDirections()||this._moveNextWithNormalRepeats()}_resetRepeats(){this._groupsOnStack.clear(),this._previousAlternateEndings=0,this._repeatStack=[]}_handleDaCapo(t,e,s){return t.has(e)?(this.index=0,this._state=s,this._resetRepeats(),!0):!1}_handleDalSegno(t,e,s,i){if(t.has(e)){const r=this._findJumpTarget(i,this.index,!0);return r===-1?!1:(this.index=r,this._state=s,this._resetRepeats(),!0)}return!1}_handleDaCoda(t,e,s){if(t.has(e)){const i=this._findJumpTarget(s,this.index,!1);return i===-1?(this.index++,!0):(this.index=i,this._state=Gt.PlayingNormally,!0)}return!1}_moveNextWithDirections(){const t=this._score.masterBars[this.index],e=t.directions!==null&&t.directions.size>0;if(this._state===Gt.PlayingNormally&&!e)return!1;if(!e)return this.index++,!0;switch(this._state){case Gt.PlayingNormally:return!!(this._handleDaCapo(t.directions,G.JumpDaCapo,Gt.DirectionJumped)||this._handleDaCapo(t.directions,G.JumpDaCapoAlCoda,Gt.DirectionJumpedAlCoda)||this._handleDaCapo(t.directions,G.JumpDaCapoAlDoubleCoda,Gt.DirectionJumpedAlDoubleCoda)||this._handleDaCapo(t.directions,G.JumpDaCapoAlFine,Gt.DirectionJumpedAlFine)||this._handleDalSegno(t.directions,G.JumpDalSegno,Gt.DirectionJumped,G.TargetSegno)||this._handleDalSegno(t.directions,G.JumpDalSegnoAlCoda,Gt.DirectionJumpedAlCoda,G.TargetSegno)||this._handleDalSegno(t.directions,G.JumpDalSegnoAlDoubleCoda,Gt.DirectionJumpedAlDoubleCoda,G.TargetSegno)||this._handleDalSegno(t.directions,G.JumpDalSegnoAlFine,Gt.DirectionJumpedAlFine,G.TargetSegno)||this._handleDalSegno(t.directions,G.JumpDalSegnoSegno,Gt.DirectionJumped,G.TargetSegnoSegno)||this._handleDalSegno(t.directions,G.JumpDalSegnoSegnoAlCoda,Gt.DirectionJumpedAlCoda,G.TargetSegnoSegno)||this._handleDalSegno(t.directions,G.JumpDalSegnoSegnoAlDoubleCoda,Gt.DirectionJumpedAlDoubleCoda,G.TargetSegnoSegno)||this._handleDalSegno(t.directions,G.JumpDalSegnoSegnoAlFine,Gt.DirectionJumpedAlFine,G.TargetSegnoSegno));case Gt.DirectionJumped:return this.index++,!0;case Gt.DirectionJumpedAlCoda:return this._handleDaCoda(t.directions,G.JumpDaCoda,G.TargetCoda)||this.index++,!0;case Gt.DirectionJumpedAlDoubleCoda:return this._handleDaCoda(t.directions,G.JumpDaDoubleCoda,G.TargetDoubleCoda)||this.index++,!0;case Gt.DirectionJumpedAlFine:return t.directions.has(G.TargetFine)?(this.index=this._score.masterBars.length,!0):(this.index++,!0)}return!0}_findJumpTarget(t,e,s){let i;return s?(i=this._findJumpTargetBackwards(t,e),i===-1&&(i=this._findJumpTargetForwards(t,e)),i):(i=this._findJumpTargetForwards(t,e),i===-1&&(i=this._findJumpTargetBackwards(t,e)),i)}_findJumpTargetForwards(t,e){let s=e;for(;s<this._score.masterBars.length;){const i=this._score.masterBars[s].directions;if(i&&i.has(t))return s;s++}return-1}_findJumpTargetBackwards(t,e){let s=e;for(;s>=0;){const i=this._score.masterBars[s].directions;if(i&&i.has(t))return s;s--}return-1}_moveNextWithNormalRepeats(){const e=this._score.masterBars[this.index].repeatCount-1;if(this._repeatStack.length>0&&e>0){const s=this._repeatStack[this._repeatStack.length-1];if(s.iterations[s.closingIndex]<e){this.index=s.opening.index,s.iterations[s.closingIndex]++;for(let r=0;r<s.closingIndex;r++)s.iterations[r]=0;s.closingIndex=0,this._previousAlternateEndings=0}else s.closingIndex<s.group.closings.length-1?(s.closingIndex++,this.index++):(this._repeatStack.pop(),this._groupsOnStack.delete(s.group),this.index++)}else this.index++}}class Cc{constructor(t,e){o(this,"beat");o(this,"playbackStart");this.beat=t,this.playbackStart=e}}class zs{constructor(t,e){o(this,"_highlightedBeats",new Map);o(this,"start");o(this,"end");o(this,"highlightedBeats",[]);o(this,"nextBeat",null);o(this,"previousBeat",null);this.start=t,this.end=e}get duration(){return this.end-this.start}highlightBeat(t,e){t.isEmpty&&!t.voice.isEmpty||this._highlightedBeats.has(t.id)||(this._highlightedBeats.set(t.id,!0),this.highlightedBeats.push(new Cc(t,e)))}getVisibleBeatAtStart(t){for(const e of this.highlightedBeats)if(e.playbackStart===this.start&&t.has(e.beat.voice.bar.staff.track.index))return e.beat;return null}getVisibleBeatAtStartWithChecker(t){for(const e of this.highlightedBeats)if(e.playbackStart===this.start&&t.isVisible(e.beat))return e.beat;return null}}class da{constructor(t,e){o(this,"tick");o(this,"tempo");this.tick=t,this.tempo=e}}class gh{constructor(){o(this,"start",0);o(this,"end",0);o(this,"tempoChanges",[]);o(this,"masterBar");o(this,"firstBeat",null);o(this,"lastBeat",null);o(this,"nextMasterBar",null);o(this,"previousMasterBar",null)}get tempo(){return this.tempoChanges[0].tempo}_insertAfter(t,e){this.firstBeat==null||t==null||this.lastBeat==null?(this.firstBeat=e,this.lastBeat=e):(e.nextBeat=t.nextBeat,e.previousBeat=t,t.nextBeat&&(t.nextBeat.previousBeat=e),t.nextBeat=e,t===this.lastBeat&&(this.lastBeat=e))}_insertBefore(t,e){this.firstBeat==null||t==null||this.lastBeat==null?(this.firstBeat=e,this.lastBeat=e):(e.previousBeat=t.previousBeat,e.nextBeat=t,t.previousBeat&&(t.previousBeat.nextBeat=e),t.previousBeat=e,t===this.firstBeat&&(this.firstBeat=e))}addBeat(t,e,s,i){const r=s+i;if(this.firstBeat==null){const a=new zs(s,r);a.highlightBeat(t,e),this._insertAfter(this.firstBeat,a)}else if(s>=this.lastBeat.end){const a=new zs(this.lastBeat.end,r);a.highlightBeat(t,e),this._insertAfter(this.lastBeat,a)}else{let a=null;if(s<this.firstBeat.start)a=this.firstBeat;else{let l=this.firstBeat;for(;l!=null;){if(s>=l.start&&s<l.end){a=l;break}l=l.nextBeat}if(a===null)throw new Xe(ze.General,"Error on building lookup, unknown variant")}if(s<a.start)if(r===a.start){const l=new zs(s,a.start);l.highlightBeat(t,e),this._insertBefore(this.firstBeat,l)}else if(r<a.end){const l=new zs(s,a.start);l.highlightBeat(t,e),this._insertBefore(a,l);const h=new zs(a.start,r);for(const c of a.highlightedBeats)h.highlightBeat(c.beat,c.playbackStart);h.highlightBeat(t,e),this._insertBefore(a,h),a.start=r}else if(r===a.end){const l=new zs(s,a.start);l.highlightBeat(t,e),a.highlightBeat(t,e),this._insertBefore(a,l)}else{const l=new zs(s,a.start);l.highlightBeat(t,e),a.highlightBeat(t,e),this._insertBefore(a,l),this.addBeat(t,e,a.end,r-a.end)}else if(s>a.start)if(r===a.end){const l=new zs(a.start,s);for(const h of a.highlightedBeats)l.highlightBeat(h.beat,h.playbackStart);a.start=s,a.highlightBeat(t,e),this._insertBefore(a,l)}else if(r<a.end){const l=new zs(a.start,s);this._insertBefore(a,l);const h=new zs(s,r);this._insertBefore(a,h);for(const c of a.highlightedBeats)l.highlightBeat(c.beat,c.playbackStart),h.highlightBeat(c.beat,c.playbackStart);h.highlightBeat(t,e),a.start=r}else{const l=new zs(a.start,s);for(const h of a.highlightedBeats)l.highlightBeat(h.beat,h.playbackStart);a.start=s,a.highlightBeat(t,e),this._insertBefore(a,l),this.addBeat(t,e,a.end,r-a.end)}else if(r===a.end)a.highlightBeat(t,e);else if(r<a.end){const l=new zs(a.start,r);for(const h of a.highlightedBeats)l.highlightBeat(h.beat,h.playbackStart);l.highlightBeat(t,e),a.start=r,this._insertBefore(a,l)}else a.highlightBeat(t,e),this.addBeat(t,e,a.end,r-a.end)}}}var Ts;(function(n){n[n.Unknown=0]="Unknown",n[n.ToNextBext=1]="ToNextBext",n[n.ToEndOfBar=2]="ToEndOfBar",n[n.ToEndOfBeat=3]="ToEndOfBeat"})(Ts||(Ts={}));class Ec{constructor(t){o(this,"beat");o(this,"masterBar");o(this,"beatLookup");o(this,"nextBeat",null);o(this,"tickDuration",0);o(this,"duration",0);o(this,"cursorMode",Ts.Unknown);this.masterBar=t}get start(){return this.masterBar.start+this.beatLookup.start}get end(){return this.start+this.tickDuration}calculateDuration(){if(this.masterBar.tempoChanges.length===1)this.duration=D.ticksToMillis(this.tickDuration,this.masterBar.tempoChanges[0].tempo);else{let t=0,e=this.start,s=this.masterBar.tempoChanges[0].tempo;const i=this.end;for(const r of this.masterBar.tempoChanges)if(r.tick<e)s=r.tempo;else{if(r.tick>i)break;t+=D.ticksToMillis(r.tick-e,s),s=r.tempo,e=r.tick}i>e&&(t+=D.ticksToMillis(i-e,s)),this.duration=t}}}class ru{constructor(t){o(this,"_lookup");this._lookup=t}isVisible(t){return this._lookup.has(t.voice.bar.staff.track.index)}}class vc{constructor(){o(this,"_currentMasterBar",null);o(this,"masterBarLookup",new Map);o(this,"masterBars",[]);o(this,"multiBarRestInfo",null);o(this,"playbackRange",null)}findBeat(t,e,s=null){return this.findBeatWithChecker(new ru(t),e,s)}findBeatWithChecker(t,e,s=null){let i=null;if(s&&(i=this._findBeatFast(t,s,e)),i||(i=this._findBeatSlow(t,s,e,!1)),i){const r=this.playbackRange;if(r!==null&&i.start>=r.endTick)return null}return i}_findBeatFast(t,e,s){if(s>=e.start&&s<e.end)return e;if(e.nextBeat&&s>=e.nextBeat.start&&s<e.nextBeat.end&&(t===void 0||t.isVisible(e.nextBeat.beat))){const i=e.nextBeat;return this._fillNextBeat(i,t),i}return null}_fillNextBeatMultiBarRest(t,e){const s=this.multiBarRestInfo.get(t.masterBar.masterBar.index);let i=t.masterBar;for(let r=0;r<s.length&&i;r++)i=i.nextMasterBar;i?i.nextMasterBar?(t.nextBeat=this._firstBeatInMasterBar(e,i.nextMasterBar,i.nextMasterBar.start,!0),t.nextBeat?(t.tickDuration=t.nextBeat.start-t.start,t.cursorMode=Ts.ToNextBext,(t.nextBeat.masterBar.masterBar.index!==i.masterBar.index+1&&(t.nextBeat.masterBar.masterBar.index!==i.masterBar.index||t.nextBeat.beat.playbackStart<=t.beat.playbackStart)||this.playbackRange!==null&&this.playbackRange.endTick<=t.nextBeat.start)&&(t.cursorMode=Ts.ToEndOfBeat)):(t.tickDuration=i.nextMasterBar.end-t.start,t.cursorMode=Ts.ToEndOfBeat)):(t.tickDuration=i.end-t.start,t.cursorMode=Ts.ToEndOfBeat):(L.warning("Synth","MultiBar Rest Info and the nextMasterBar are out of sync, this is an unexpected error. Please report it as bug.  (broken chain fill-next)"),t.tickDuration=(t.masterBar.end-t.masterBar.start)*(s.length+1),t.cursorMode=Ts.ToEndOfBeat),t.calculateDuration()}_fillNextBeat(t,e){this._isMultiBarRestResult(t)?this._fillNextBeatMultiBarRest(t,e):this._fillNextBeatDefault(t,e)}_fillNextBeatDefault(t,e){t.nextBeat=this._findBeatInMasterBar(t.masterBar,t.beatLookup.nextBeat,t.end,e,!0),t.nextBeat==null&&(t.nextBeat=this._findBeatSlow(e,t,t.end,!0)),t.nextBeat?(t.tickDuration=t.nextBeat.start-t.start,t.cursorMode=Ts.ToNextBext,t.calculateDuration()):(t.tickDuration=t.masterBar.end-t.start,t.cursorMode=Ts.ToEndOfBeat,t.calculateDuration()),t.nextBeat&&(t.nextBeat.masterBar.masterBar.index!==t.masterBar.masterBar.index+1&&(t.nextBeat.masterBar.masterBar.index!==t.masterBar.masterBar.index||t.nextBeat.beat.playbackStart<=t.beat.playbackStart)||this.playbackRange!==null&&this.playbackRange.endTick<=t.nextBeat.start)&&(t.cursorMode=Ts.ToEndOfBeat)}_isMultiBarRestResult(t){return this._internalIsMultiBarRestResult(t.masterBar.masterBar.index,t.beat)}_internalIsMultiBarRestResult(t,e){return this.multiBarRestInfo&&this.multiBarRestInfo.has(t)&&e.isRest&&e.voice.bar.isRestOnly}_findBeatSlow(t,e,s,i){let r=null;return e!=null&&(e.masterBar.start<=s&&e.masterBar.end>s?r=e.masterBar:e.masterBar.nextMasterBar&&e.masterBar.nextMasterBar.start<=s&&e.masterBar.nextMasterBar.end>s&&(r=e.masterBar.nextMasterBar)),r||(r=this._findMasterBar(s)),r?this._firstBeatInMasterBar(t,r,s,i):null}_firstBeatInMasterBar(t,e,s,i){let r=e;for(;r;){if(r.firstBeat){const a=this._findBeatInMasterBar(r,r.firstBeat,s,t,i);if(a)return a}r=r.nextMasterBar}return null}_findBeatInMasterBar(t,e,s,i,r){if(!e)return null;let a=null,l=null;const h=s-t.start;for(;e!=null&&l==null;){if((e.start<=h||r&&h<0)&&h<e.end){if(a=e,l=e.getVisibleBeatAtStartWithChecker(i),!l)if(r){let d=t;for(;d!=null&&l==null;){for(;e!=null;){if(l=e.getVisibleBeatAtStartWithChecker(i),l){a=e,t=d;break}e=e.nextBeat}(!l||!a)&&(d=d.nextMasterBar,e=(d==null?void 0:d.firstBeat)??null)}}else{let d=t;for(;d!=null&&l==null;){for(;e!=null;){if(l=e.getVisibleBeatAtStartWithChecker(i),l){a=e,t=d;break}e=e.previousBeat}(!l||!a)&&(d=d.previousMasterBar,e=(d==null?void 0:d.firstBeat)??null)}}}else if(e.end>h)break;e=(e==null?void 0:e.nextBeat)??null}return l==null?null:this._createResult(t,a,l,r,i)}_createResult(t,e,s,i,r){const a=new Ec(t);if(a.beat=s,a.beatLookup=e,a.tickDuration=e.end-e.start,!i)this._fillNextBeat(a,r);else if(this._isMultiBarRestResult(a)){const l=this.multiBarRestInfo.get(t.masterBar.index);let h=t;for(let c=0;c<l.length&&h;c++)h=h.nextMasterBar;h?h.nextMasterBar?a.tickDuration=h.nextMasterBar.start-e.start:a.tickDuration=h.end-e.start:L.warning("Synth","MultiBar Rest Info and the nextMasterBar are out of sync, this is an unexpected error. Please report it as bug.  (broken chain stretch-result)")}return a.calculateDuration(),a}_findMasterBar(t){if(t<=0&&this.masterBars.length>0)return this.masterBars[0];const e=this.masterBars;let s=0,i=e.length-1;for(;s<=i;){const r=(i+s)/2|0,a=e[r];if(t>=a.start&&t<a.end)return a;t<a.start?i=r-1:s=r+1}return null}getMasterBar(t){if(!this.masterBarLookup.has(t.index)){const e=new gh;return e.masterBar=t,e}return this.masterBarLookup.get(t.index)}getMasterBarStart(t){return this.masterBarLookup.has(t.index)?this.masterBarLookup.get(t.index).start:0}getBeatStart(t){return this.masterBarLookup.has(t.voice.bar.index)?this.masterBarLookup.get(t.voice.bar.index).start+t.playbackStart:0}addMasterBar(t){this.masterBars.push(t),this._currentMasterBar&&(t.previousMasterBar=this._currentMasterBar,this._currentMasterBar.nextMasterBar=t),this._currentMasterBar=t,this.masterBarLookup.has(t.masterBar.index)||this.masterBarLookup.set(t.masterBar.index,t)}addBeat(t,e,s){const i=this._currentMasterBar;if(i)if(e<0&&i.previousMasterBar){const r=i.previousMasterBar.end-i.previousMasterBar.start,a=r+e,l=a+s;if(i.previousMasterBar.addBeat(t,a,a,s),l>r){const h=s+e;i.addBeat(t,e,0,h)}}else i.addBeat(t,e,e,s)}}class au{constructor(){o(this,"noteOnly",0);o(this,"untilTieOrSlideEnd",0);o(this,"letRingEnd",0);o(this,"beatDurationFactor",1)}}class nu{constructor(){o(this,"firstBeatDuration",0);o(this,"secondBeatStartOffset",0);o(this,"secondBeatDuration",0)}}class ou{constructor(){o(this,"durations",[]);o(this,"brushInfos",[])}}class lu{constructor(){o(this,"synthTick",0);o(this,"synthTime",0);o(this,"currentTempo",0);o(this,"automationToSyncPoint",new Map);o(this,"syncPoints");o(this,"createNewSyncPoints",!1)}}const Ne=class Ne{constructor(t,e,s){o(this,"_score");o(this,"_settings");o(this,"_handler");o(this,"_programsPerChannel",new Map);o(this,"_currentTime",0);o(this,"_calculatedBeatTimers",new Set);o(this,"tickLookup",new vc);o(this,"applyTranspositionPitches",!0);o(this,"syncPoints",[]);o(this,"transpositionPitches",new Map);o(this,"_currentTripletFeel",null);o(this,"vibratoResolution",16);this._score=t,this._settings=e||new vi,this._handler=s}generate(){this.transpositionPitches.clear(),this._calculatedBeatTimers.clear(),this._currentTime=0;for(const t of this._score.tracks)this._generateTrack(t);L.debug("Midi","Begin midi generation"),this.syncPoints=[],Ne._playThroughSong(this._score,this.syncPoints,!1,(t,e,s,i,r)=>{this._generateMasterBar(t,e,s,i,r),t.index===0&&r===0&&this._detectTickShift()},(t,e,s)=>{for(const i of this._score.tracks)for(const r of i.staves)t<r.bars.length&&this._generateBar(r.bars[t],e,s)},t=>{for(const e of this._score.tracks)this._handler.finishTrack(e.index,t)}),L.debug("Midi","Midi generation done")}_detectTickShift(){let t=0;for(const e of this._score.tracks)for(const s of e.staves)for(const i of s.bars[0].voices)if(!i.isEmpty){const r=i.beats[0];r.playbackStart<t&&(t=r.playbackStart)}t=Math.abs(t),this._handler.addTickShift(t)}_generateTrack(t){this._generateChannel(t,t.playbackInfo.primaryChannel,t.playbackInfo),t.playbackInfo.primaryChannel!==t.playbackInfo.secondaryChannel&&this._generateChannel(t,t.playbackInfo.secondaryChannel,t.playbackInfo)}_addProgramChange(t,e,s,i){(!this._programsPerChannel.has(s)||this._programsPerChannel.get(s)!==i)&&(this._handler.addProgramChange(t.index,e,s,i),this._programsPerChannel.set(s,i))}_addBankChange(t,e,s,i){const r=ui.bankToLsbMsb(i);this._handler.addControlChange(t.index,e,s,at.BankSelectCoarse,r[1]),this._handler.addControlChange(t.index,e,s,at.BankSelectFine,r[0])}static buildTranspositionPitches(t,e){const s=new Map;for(const i of t.tracks){const r=i.index<e.notation.transpositionPitches.length?e.notation.transpositionPitches[i.index]:-i.staves[0].transpositionPitch;s.set(i.playbackInfo.primaryChannel,r),s.set(i.playbackInfo.secondaryChannel,r)}return s}_generateChannel(t,e,s){const i=t.index<this._settings.notation.transpositionPitches.length?this._settings.notation.transpositionPitches[t.index]:-t.staves[0].transpositionPitch;this.transpositionPitches.set(e,i);const r=Ne._toChannelShort(s.volume),a=Ne._toChannelShort(s.balance);this._handler.addControlChange(t.index,0,e,at.VolumeCoarse,r),this._handler.addControlChange(t.index,0,e,at.PanCoarse,a),this._handler.addControlChange(t.index,0,e,at.ExpressionControllerCoarse,127),this._handler.addControlChange(t.index,0,e,at.RegisteredParameterFine,0),this._handler.addControlChange(t.index,0,e,at.RegisteredParameterCourse,0),this._handler.addControlChange(t.index,0,e,at.DataEntryFine,0),this._handler.addControlChange(t.index,0,e,at.DataEntryCoarse,Ne._pitchBendRangeInSemitones),this._addBankChange(t,0,e,s.bank),this._addProgramChange(t,0,e,s.program)}static generateSyncPoints(t,e=!1){const s=[];return Ne._playThroughSong(t,s,e,(i,r,a,l,h)=>{},(i,r,a)=>{},i=>{}),s}static buildModifiedTempoLookup(t){const e=[];return Ne._playThroughSong(t,e,!1,(i,r,a,l,h)=>{},(i,r,a)=>{},i=>{}).automationToSyncPoint}static _playThroughSong(t,e,s,i,r,a){const l=new iu(t),h=new lu;h.currentTempo=t.tempo,h.syncPoints=e,h.createNewSyncPoints=s;let c=null;const d=new Map;for(;!l.finished;){const u=l.index,p=t.masterBars[u],g=l.currentTick;if(l.processCurrent(),l.shouldPlay){let m=d.has(u)?d.get(u):-1;m++,d.set(u,m),i(p,c,g,h.currentTempo,m);const y=p.tempoAutomations.length>0?p.tempoAutomations[0].value:h.currentTempo;r(u,g,y),h.synthTick=g,Ne._processBarTime(p,m,h)}l.moveNext(),c=p}if(e.length>0){const u=e[e.length-1],p=l.currentTick-u.synthTick;if(p>0){const g=new Wr;g.masterBarIndex=c.index,g.masterBarOccurence=d.get(c.index)-1,g.synthTick=l.currentTick,g.synthBpm=h.currentTempo,h.createNewSyncPoints?(g.syncBpm=u.synthBpm,g.synthBpm=u.synthBpm):e.length===1?g.syncBpm=u.synthBpm:g.syncBpm=e[e.length-2].syncBpm,g.synthTime=u.synthTime+D.ticksToMillis(p,u.synthBpm),g.syncTime=u.syncTime+D.ticksToMillis(p,g.syncBpm),h.createNewSyncPoints||u.updateSyncBpm(g.synthTime,g.syncTime),e.push(g)}}return a(l.currentTick),h}static _processBarTime(t,e,s){const i=t.calculateDuration(),r=t.syncPoints,a=s.synthTick;s.createNewSyncPoints?Ne._processBarTimeWithNewSyncPoints(t,e,s):r?Ne._processBarTimeWithSyncPoints(t,e,s):Ne._processBarTimeNoSyncPoints(t,s);const l=a+i,h=l-s.synthTick;h>0&&(s.synthTime+=D.ticksToMillis(h,s.currentTempo),s.synthTick=l)}static _processBarTimeWithNewSyncPoints(t,e,s){const i=s.synthTick;if(t.index===0&&e===0){s.currentTempo=t.score.tempo;const a=new Wr;a.masterBarIndex=t.index,a.masterBarOccurence=e,a.synthTick=i,a.synthBpm=s.currentTempo,a.synthTime=s.synthTime,a.syncBpm=s.currentTempo,a.syncTime=s.synthTime,s.syncPoints.push(a)}const r=t.calculateDuration();for(const a of t.tempoAutomations){const l=i+a.ratioPosition*r,h=l-s.synthTick;if(h>0&&(s.synthTick=l,s.synthTime+=D.ticksToMillis(h,s.currentTempo)),a.value!==s.currentTempo){s.currentTempo=a.value;const c=new Wr;c.masterBarIndex=t.index,c.masterBarOccurence=e,c.synthTick=l,c.synthBpm=s.currentTempo,c.synthTime=s.synthTime,c.syncBpm=s.currentTempo,c.syncTime=s.synthTime,s.syncPoints.push(c)}}}static _processBarTimeWithSyncPoints(t,e,s){const i=s.synthTick,r=t.calculateDuration();let a=0,l;for(const h of t.syncPoints){if(h.syncPointValue.barOccurence!==e)continue;const c=i+h.ratioPosition*r;for(;a<t.tempoAutomations.length&&t.tempoAutomations[a].ratioPosition<=h.ratioPosition;){const u=t.tempoAutomations[a],p=i+u.ratioPosition*r;l=p-s.synthTick,l>0&&(s.synthTick=p,s.synthTime+=D.ticksToMillis(l,s.currentTempo)),s.currentTempo=u.value,a++}l=c-s.synthTick,l>0&&(s.synthTick=c,s.synthTime+=D.ticksToMillis(l,s.currentTempo)),s.syncPoints.length>0&&s.syncPoints[s.syncPoints.length-1].updateSyncBpm(s.synthTime,h.syncPointValue.millisecondOffset);const d=new Wr;d.masterBarIndex=t.index,d.masterBarOccurence=e,d.synthTick=c,d.synthBpm=s.currentTempo,d.synthTime=s.synthTime,d.syncTime=h.syncPointValue.millisecondOffset,d.syncBpm=0,s.syncPoints.push(d),s.automationToSyncPoint.set(h,d)}for(;a<t.tempoAutomations.length;){const h=t.tempoAutomations[a],c=i+h.ratioPosition*r;l=c-s.synthTick,l>0&&(s.synthTick=c,s.synthTime+=D.ticksToMillis(l,s.currentTempo)),s.currentTempo=h.value,a++}}static _processBarTimeNoSyncPoints(t,e){const s=e.synthTick,i=t.calculateDuration();for(const r of t.tempoAutomations){const a=s+r.ratioPosition*i,l=a-e.synthTick;l>0&&(e.synthTick=a,e.synthTime+=D.ticksToMillis(l,e.currentTempo)),e.currentTempo=r.value}}static _toChannelShort(t){const e=Math.max(-32768,Math.min(32767,t*8-1));return Math.max(e,-1)+1}_generateMasterBar(t,e,s,i,r){(!e||e.timeSignatureDenominator!==t.timeSignatureDenominator||e.timeSignatureNumerator!==t.timeSignatureNumerator)&&this._handler.addTimeSignature(s,t.timeSignatureNumerator,t.timeSignatureDenominator);const a=t.calculateDuration(),l=new gh;if(t.tempoAutomations.length>0){t.tempoAutomations[0].ratioPosition>0&&l.tempoChanges.push(new da(s,i));for(const h of t.tempoAutomations){const c=s+a*h.ratioPosition;this._handler.addTempo(c,h.value),l.tempoChanges.push(new da(c,h.value))}}else e?l.tempoChanges.push(new da(s,i)):(this._handler.addTempo(s,t.score.tempo),l.tempoChanges.push(new da(s,t.score.tempo)));l.masterBar=t,l.start=s,l.end=l.start+a,this.tickLookup.addMasterBar(l)}_generateBar(t,e,s){const i=this._getPlaybackBar(t),r=this._currentTime;for(const c of i.voices)this._currentTime=r,this._generateVoice(c,e,t,s);const a=i.masterBar,l=a.calculateDuration(),h=a.tempoAutomations.slice();if(h.length===0)this._currentTime=r+D.ticksToMillis(l,s);else{this._currentTime=r;let c=e,d=s;const u=e+l;for(const g of h){const y=l*g.ratioPosition-c;y>0&&(this._currentTime+=D.ticksToMillis(y,d)),d=g.value,c+=y}const p=u-c;p>0&&(this._currentTime+=D.ticksToMillis(p,d))}i.id!==t.id&&this.tickLookup.addBeat(t.voices[0].beats[0],0,l)}_getPlaybackBar(t){switch(t.simileMark){case At.Simple:t.previousBar&&(t=this._getPlaybackBar(t.previousBar));break;case At.FirstOfDouble:t.previousBar&&t.previousBar.previousBar&&(t=this._getPlaybackBar(t.previousBar.previousBar));break;case At.SecondOfDouble:t.previousBar&&t.previousBar.previousBar&&(t=this._getPlaybackBar(t.previousBar.previousBar));break}return t}_generateVoice(t,e,s,i){if(t.isEmpty&&(!t.bar.isEmpty||t.index!==0))return;const r=s.masterBar.tempoAutomations.slice();let a=i;const l=s.masterBar.calculateDuration();for(const h of t.beats){const c=h.playbackStart/l;for(;r.length>0&&r[0].ratioPosition<=c;)a=r.shift().value;this._generateBeat(h,e,s,a)}}_generateBeat(t,e,s,i){let r=t.playbackStart,a=t.playbackDuration;const l=t.voice.bar.masterBar.calculateDuration();t.voice.bar.isEmpty?a=l:t.voice.bar.masterBar.tripletFeel!==Me.NoTripletFeel&&this._settings.player.playTripletFeel&&(this._currentTripletFeel?(r-=this._currentTripletFeel.secondBeatStartOffset,a=this._currentTripletFeel.secondBeatDuration,this._currentTripletFeel=null):(this._currentTripletFeel=Ne._calculateTripletFeelInfo(r,a,t),this._currentTripletFeel&&(a=this._currentTripletFeel.firstBeatDuration))),t.showTimer&&!this._calculatedBeatTimers.has(t.id)&&(t.timer=this._currentTime,this._calculatedBeatTimers.add(t.id)),this._currentTime+=D.ticksToMillis(a,i),s===t.voice.bar&&this.tickLookup.addBeat(t,r,a);const h=t.voice.bar.staff.track;for(const c of t.automations)this._generateNonTempoAutomation(t,c,e);if(t.isRest)this._handler.addRest(h.index,e+r,h.playbackInfo.primaryChannel);else if(t.deadSlapped)this._generateDeadSlap(t,e+r);else{const c=this._getBrushInfo(t),d=this._getRasgueadoInfo(t,a);for(const u of t.notes)this._generateNote(u,e+r,a,i,c,d)}if(t.fade!==Nt.None&&this._generateFade(t,e+r,a),t.vibrato!==Ee.None){let c=240,d=3;switch(t.vibrato){case Ee.Slight:c=this._settings.player.vibrato.beatSlightLength,d=this._settings.player.vibrato.beatSlightAmplitude;break;case Ee.Wide:c=this._settings.player.vibrato.beatWideLength,d=this._settings.player.vibrato.beatWideAmplitude;break}this._generateVibratorWithParams(e+r,t.playbackDuration,c,0,d,(u,p)=>{this._handler.addBend(t.voice.bar.staff.track.index,u,h.playbackInfo.secondaryChannel,p)})}}static _calculateTripletFeelInfo(t,e,s){let i;switch(s.voice.bar.masterBar.tripletFeel){case Me.Triplet8th:case Me.Dotted8th:case Me.Scottish8th:i=b.Eighth;break;case Me.Triplet16th:case Me.Dotted16th:case Me.Scottish16th:i=b.Sixteenth;break;default:return null}const r=D.toTicks(i);if(e!==r||t%r!==0||!s.nextBeat||s.nextBeat.voice!==s.voice||s.playbackDuration!==r)return null;const a=new nu;switch(s.voice.bar.masterBar.tripletFeel){case Me.Triplet8th:a.firstBeatDuration=D.applyTuplet(D.toTicks(b.Quarter),3,2),a.secondBeatDuration=D.applyTuplet(D.toTicks(b.Eighth),3,2);break;case Me.Dotted8th:a.firstBeatDuration=D.applyDot(D.toTicks(b.Eighth),!1),a.secondBeatDuration=D.toTicks(b.Sixteenth);break;case Me.Scottish8th:a.firstBeatDuration=D.toTicks(b.Sixteenth),a.secondBeatDuration=D.applyDot(D.toTicks(b.Eighth),!1);break;case Me.Triplet16th:a.firstBeatDuration=D.applyTuplet(D.toTicks(b.Eighth),3,2),a.secondBeatDuration=D.applyTuplet(D.toTicks(b.Sixteenth),3,2);break;case Me.Dotted16th:a.firstBeatDuration=D.applyDot(D.toTicks(b.Sixteenth),!1),a.secondBeatDuration=D.toTicks(b.ThirtySecond);break;case Me.Scottish16th:a.firstBeatDuration=D.toTicks(b.ThirtySecond),a.secondBeatDuration=D.applyDot(D.toTicks(b.Sixteenth),!1);break}return a.secondBeatStartOffset=e-a.firstBeatDuration,a}_generateDeadSlap(t,e){const s=D.toTicks(b.SixtyFourth),i=t.voice.bar.staff;if(i.tuning.length>0)for(const r of i.tuning)this._handler.addNote(i.track.index,e,s,r,D.dynamicToVelocity(re.F),i.track.playbackInfo.primaryChannel)}_needsSecondaryChannel(t){return t.hasBend||t.beat.hasWhammyBar||t.beat.vibrato!==Ee.None}_determineChannel(t,e){if(this._needsSecondaryChannel(e))return t.playbackInfo.secondaryChannel;let s=e;for(;s.isTieDestination;)if(s=s.tieOrigin,this._needsSecondaryChannel(s))return t.playbackInfo.secondaryChannel;for(s=e;s.isTieOrigin;)if(s=s.tieDestination,this._needsSecondaryChannel(s))return t.playbackInfo.secondaryChannel;return t.playbackInfo.primaryChannel}_generateNote(t,e,s,i,r,a){const l=t.beat.voice.bar.staff.track,h=t.beat.voice.bar.staff;let c=t.calculateRealValue(this.applyTranspositionPitches,!0);if(t.isPercussion){const k=jt.getArticulation(t);k&&(c=k.outputMidiNumber)}const d=a==null&&t.isStringed&&t.string<=r.length?r[t.string-1]:0,u=e+d,p=this._getNoteDuration(t,s,i);p.untilTieOrSlideEnd-=d,p.noteOnly-=d,p.letRingEnd-=d;const g=Ne._getNoteVelocity(t),m=this._determineChannel(l,t);let y=0;const S=Math.max(p.untilTieOrSlideEnd,p.letRingEnd);if(t.hasBend?y=Ne.getPitchWheel(t.bendPoints[0].value):t.beat.hasWhammyBar?y=Ne.getPitchWheel(t.beat.whammyBarPoints[0].value):t.isTieDestination||t.slideOrigin&&t.slideOrigin.slideOutType===ge.Legato?y=-1:y=Ne.getPitchWheel(0),y>=0&&this._handler.addNoteBend(l.index,u,m,c,y),t.beat.hasRasgueado){this._generateRasgueado(l,t,u,c,g,m,a);return}if(t.ornament!==ut.None){this._generateOrnament(l,t,u,S,c,g,m);return}if(t.isTrill&&!h.isPercussion){this._generateTrill(t,u,p,c,g,m);return}if(t.beat.isTremolo){this._generateTremoloPicking(t,u,p,c,g,m);return}t.hasBend?this._generateBend(t,u,p,c,m,i):t.beat.hasWhammyBar&&t.index===0?this._generateWhammy(t.beat,u,p,m,i):t.slideInType!==Et.None||t.slideOutType!==ge.None?this._generateSlide(t,u,p,c,m,i):(t.vibrato!==Ee.None||t.isTieDestination&&t.tieOrigin.vibrato!==Ee.None)&&this._generateVibrato(t,u,p,c,m),!t.isTieDestination&&(!t.slideOrigin||t.slideOrigin.slideOutType!==ge.Legato)&&this._handler.addNote(l.index,u,S,c,g,m)}_generateOrnament(t,e,s,i,r,a,l){let h,c;const d=r%12,u=1/3;switch(e.ornament){case ut.Turn:h=[r+Ne._ornamentKeysUp[d],r,r+Ne.ornamentKeysDown[d]],c=[D.toTicks(b.Sixteenth)*u,D.toTicks(b.Sixteenth)*u,D.toTicks(b.Sixteenth)*u];break;case ut.InvertedTurn:h=[r+Ne.ornamentKeysDown[d],r,r+Ne._ornamentKeysUp[d]],c=[D.toTicks(b.Sixteenth)*u,D.toTicks(b.Sixteenth)*u,D.toTicks(b.Sixteenth)*u];break;case ut.UpperMordent:h=[r,r+Ne._ornamentKeysUp[d]],c=[D.toTicks(b.ThirtySecond),D.toTicks(b.ThirtySecond)];break;case ut.LowerMordent:h=[r,r+Ne.ornamentKeysDown[d]],c=[D.toTicks(b.ThirtySecond),D.toTicks(b.ThirtySecond)];break;default:return}let p=1;i<D.QuarterTime&&(p=i/D.QuarterTime),a-=D.VelocityIncrement;let g=0;for(let y=0;y<h.length;y++){const S=c[y]*p;this._handler.addNote(t.index,s,S,h[y],a,l),s+=S,g+=S}const m=i-g;this._handler.addNote(t.index,s,m,r,a,l)}_getNoteDuration(t,e,s){const i=new au,r=D.toTicks(t.beat.duration);if(i.beatDurationFactor=e/r,i.noteOnly=e,i.untilTieOrSlideEnd=e,i.letRingEnd=e,t.isDead)return i.noteOnly=this._applyStaticDuration(Ne._defaultDurationDead,e,s),i.untilTieOrSlideEnd=i.noteOnly,i.letRingEnd=i.noteOnly,i;if(t.isPalmMute)return i.noteOnly=this._applyStaticDuration(Ne._defaultDurationPalmMute,e,s),i.untilTieOrSlideEnd=i.noteOnly,i.letRingEnd=i.noteOnly,i;if(t.isStaccato)return i.noteOnly=e/2|0,i.untilTieOrSlideEnd=i.noteOnly,i.letRingEnd=i.noteOnly,i;if(t.isTieOrigin){const a=t.tieDestination;if(a)if(t.isTieDestination){const l=this._getNoteDuration(a,a.beat.playbackDuration,s);i.untilTieOrSlideEnd=e+l.untilTieOrSlideEnd}else{const l=t.beat.absolutePlaybackStart,h=this._getNoteDuration(a,a.beat.playbackDuration,s),c=a.beat.absolutePlaybackStart+h.untilTieOrSlideEnd;i.untilTieOrSlideEnd=c-l}}else if(t.slideOutType===ge.Legato){const a=t.slideTarget;if(a){const l=t.beat.absolutePlaybackStart,h=this._getNoteDuration(a,a.beat.playbackDuration,s),c=a.beat.absolutePlaybackStart+h.untilTieOrSlideEnd;i.untilTieOrSlideEnd=c-l}}if(t.isLetRing&&this._settings.notation.notationMode===Xt.GuitarPro){let a=t.beat,l=0;const h=t.beat.voice.bar.masterBar.calculateDuration();for(;a.nextBeat;){const c=a.nextBeat;if(c.isRest||t.isStringed&&c.hasNoteOnString(t.string))break;if(a=a.nextBeat,l=a.absolutePlaybackStart-t.beat.absolutePlaybackStart+a.playbackDuration,l>h){l=h;break}}a===t.beat?i.letRingEnd=e:i.letRingEnd=l}else i.letRingEnd=i.untilTieOrSlideEnd;return i}_applyStaticDuration(t,e,s){const i=s*t/H.MaxPosition|0;return Math.min(i,e)}static _getNoteVelocity(t){let e=0;switch(!t.beat.voice.bar.staff.isPercussion&&t.hammerPullOrigin&&e--,t.isGhost&&e--,t.accentuated){case mt.Normal:e++;break;case mt.Heavy:e+=2;break}return D.dynamicToVelocity(t.dynamics,e)}_generateFade(t,e,s){const i=t.voice.bar.staff.track;switch(t.fade){case Nt.FadeIn:this._generateFadeSteps(i,e,s,0,Ne._toChannelShort(i.playbackInfo.volume));break;case Nt.FadeOut:this._generateFadeSteps(i,e,s,Ne._toChannelShort(i.playbackInfo.volume),0);break;case Nt.VolumeSwell:const r=s/2|0;this._generateFadeSteps(i,e,r,0,Ne._toChannelShort(i.playbackInfo.volume)),this._generateFadeSteps(i,e+r,r,Ne._toChannelShort(i.playbackInfo.volume),0);break}}_generateFadeSteps(t,e,s,i,r){s=s*.8|0;const l=(r-i)/s,h=s/120+1|0,c=e+s;for(let d=0;d<h;d++){const u=d===h-1,p=u?c:e+d*120,g=u?r:Math.round(i+(p-e)*l);this._handler.addControlChange(t.index,p,t.playbackInfo.primaryChannel,at.VolumeCoarse,g),this._handler.addControlChange(t.index,p,t.playbackInfo.secondaryChannel,at.VolumeCoarse,g)}}_generateVibrato(t,e,s,i,r){let a=0,l=0;switch(t.vibrato!==Ee.None?t.vibrato:t.isTieDestination?t.tieOrigin.vibrato:Ee.Slight){case Ee.Slight:a=this._settings.player.vibrato.noteSlightLength,l=this._settings.player.vibrato.noteSlightAmplitude;break;case Ee.Wide:a=this._settings.player.vibrato.noteWideLength,l=this._settings.player.vibrato.noteWideAmplitude;break;default:return}const c=t.beat.voice.bar.staff.track;let d=0;if(t.isTieDestination&&t.tieOrigin.hasBend){const u=t.tieOrigin.bendPoints;d=u[u.length-1].value}this._generateVibratorWithParams(e,s.noteOnly,a,d,l,(u,p)=>{this._handler.addNoteBend(c.index,u,r,i,p)})}_generateVibratorWithParams(t,e,s,i,r,a){const l=this.vibratoResolution,h=s/2|0,c=t+e;for(;t<c;){let d=0;const u=t+s<c?s:c-t;for(;d<u;){const p=i+r*Math.sin(d*Math.PI/h);a(t+d|0,Ne.getPitchWheel(p)),d+=l}t+=s}a(c|0,Ne.getPitchWheel(i))}static getPitchWheel(t){return ye.DefaultPitchWheel+t/2*Ne._pitchValuePerSemitone}_generateSlide(t,e,s,i,r,a){const l=t.slideOutType===ge.Legato?s.noteOnly:s.untilTieOrSlideEnd,h=[],c=t.beat.voice.bar.staff.track,d=this._settings.player.slide.simpleSlidePitchOffset,u=Math.floor(H.MaxPosition*this._settings.player.slide.simpleSlideDurationRatio),p=Math.floor(H.MaxPosition*this._settings.player.slide.shiftSlideDurationRatio);switch(t.slideInType){case Et.IntoFromAbove:h.push(new H(0,d)),h.push(new H(u,0));break;case Et.IntoFromBelow:h.push(new H(0,-d)),h.push(new H(u,0));break}switch(t.slideOutType){case ge.Legato:case ge.Shift:h.push(new H(p,0));const g=(t.slideTarget.calculateRealValue(this.applyTranspositionPitches,!0)-t.calculateRealValue(this.applyTranspositionPitches,!0))*2;h.push(new H(H.MaxPosition,g));break;case ge.OutDown:h.push(new H(H.MaxPosition-u,0)),h.push(new H(H.MaxPosition,-d));break;case ge.OutUp:h.push(new H(H.MaxPosition-u,0)),h.push(new H(H.MaxPosition,d));break}this._generateWhammyOrBend(e,l,h,a,(g,m)=>{this._handler.addNoteBend(c.index,g,r,i,m)})}_generateBend(t,e,s,i,r,a){const l=t.bendPoints,h=t.beat.voice.bar.staff.track,c=(m,y)=>{this._handler.addNoteBend(h.index,m,r,i,y)};let d=null,u;if(t.isTieOrigin&&this._settings.notation.extendBendArrowsOnTiedNotes){let m=t;for(;m.isTieOrigin&&!m.tieDestination.hasBend&&m.tieDestination.vibrato===Ee.None;)m=m.tieDestination;u=m.beat.absolutePlaybackStart-t.beat.absolutePlaybackStart+this._getNoteDuration(m,m.beat.playbackDuration,a).noteOnly}else if(t.isTieOrigin&&t.beat.graceType!==ee.None){switch(t.tieDestination.bendType){case J.Bend:case J.BendRelease:case J.PrebendBend:d=t.tieDestination.bendPoints[1].value;break;case J.Prebend:case J.PrebendRelease:d=t.tieDestination.bendPoints[0].value;break}u=Math.max(s.noteOnly,D.millisToTicks(this._settings.player.songBookBendDuration,a))}else u=s.noteOnly;l[0].value>0&&!t.isContinuedBend&&e>0&&e--;const p=Math.min(u,D.millisToTicks(this._settings.player.songBookBendDuration,a));let g=[];switch(t.bendType){case J.Custom:g=l;break;case J.Bend:case J.Release:switch(t.bendStyle){case tt.Default:g=l;break;case tt.Gradual:g.push(new H(0,t.bendPoints[0].value)),(!d||d<t.bendPoints[1].value)&&(d=t.bendPoints[1].value),g.push(new H(H.MaxPosition,d));break;case tt.Fast:(!d||d<t.bendPoints[1].value)&&(d=t.bendPoints[1].value),t.beat.graceType===ee.BendGrace?this._generateSongBookWhammyOrBend(e,u,!0,[t.bendPoints[0].value,d],p,a,c):this._generateSongBookWhammyOrBend(e,u,!1,[t.bendPoints[0].value,d],p,a,c);return}break;case J.BendRelease:switch(t.bendStyle){case tt.Default:g=l;break;case tt.Gradual:g.push(new H(0,t.bendPoints[0].value)),g.push(new H(H.MaxPosition/2|0,t.bendPoints[1].value)),g.push(new H(H.MaxPosition,t.bendPoints[2].value));break;case tt.Fast:this._generateSongBookWhammyOrBend(e,u,!1,[t.bendPoints[0].value,t.bendPoints[1].value,t.bendPoints[2].value],p,a,c);return}break;case J.Hold:g=l;break;case J.Prebend:g=l;break;case J.PrebendBend:switch(t.bendStyle){case tt.Default:g=l;break;case tt.Gradual:g.push(new H(0,t.bendPoints[0].value)),g.push(new H(H.MaxPosition,t.bendPoints[1].value));break;case tt.Fast:const m=Ne.getPitchWheel(t.bendPoints[0].value);c(e,m|0),(!d||d<t.bendPoints[1].value)&&(d=t.bendPoints[1].value),this._generateSongBookWhammyOrBend(e,u,!1,[t.bendPoints[0].value,d],p,a,c);return}break;case J.PrebendRelease:switch(t.bendStyle){case tt.Default:g=l;break;case tt.Gradual:g.push(new H(0,t.bendPoints[0].value)),g.push(new H(H.MaxPosition,t.bendPoints[1].value));break;case tt.Fast:const m=Ne.getPitchWheel(t.bendPoints[0].value);c(e,m|0),this._generateSongBookWhammyOrBend(e,u,!1,[t.bendPoints[0].value,t.bendPoints[1].value],p,a,c);return}break}this._generateWhammyOrBend(e,u,g,a,c)}_generateSongBookWhammyOrBend(t,e,s,i,r,a,l){const h=s?t:t+e-r,c=r/(i.length-1);for(let d=0;d<i.length-1;d++){const u=Ne.getPitchWheel(i[d]),p=Ne.getPitchWheel(i[d+1]),g=h+c*d;this._generateBendValues(g,c,u,p,a,l)}}_generateWhammy(t,e,s,i,r){const a=t.whammyBarPoints,l=t.voice.bar.staff.track,h=s.noteOnly;a[0].value>0&&!t.isContinuedWhammy&&e--;const c=(u,p)=>{this._handler.addBend(l.index,u,i,p)};let d=[];switch(t.whammyBarType){case De.Custom:d=a;break;case De.Dive:switch(t.whammyStyle){case tt.Default:d=a;break;case tt.Gradual:d.push(new H(0,a[0].value)),d.push(new H(H.MaxPosition,a[1].value));break;case tt.Fast:const u=Math.min(h,D.millisToTicks(this._settings.player.songBookBendDuration,r));this._generateSongBookWhammyOrBend(e,h,!1,[a[0].value,a[1].value],u,r,c);return}break;case De.Dip:switch(t.whammyStyle){case tt.Default:d=a;break;case tt.Gradual:d.push(new H(0,a[0].value)),d.push(new H(H.MaxPosition/2|0,a[1].value)),d.push(new H(H.MaxPosition,a[2].value));break;case tt.Fast:const u=Math.min(h,D.millisToTicks(this._settings.player.songBookDipDuration,r));this._generateSongBookWhammyOrBend(e,h,!0,[a[0].value,a[1].value,a[2].value],u,r,c);return}break;case De.Hold:d=a;break;case De.Predive:d=a;break;case De.PrediveDive:switch(t.whammyStyle){case tt.Default:d=a;break;case tt.Gradual:d.push(new H(0,a[0].value)),d.push(new H(H.MaxPosition/2|0,a[0].value)),d.push(new H(H.MaxPosition,a[1].value));break;case tt.Fast:const u=Ne.getPitchWheel(a[0].value);this._handler.addBend(l.index,e,i,u|0);const p=Math.min(h,D.millisToTicks(this._settings.player.songBookBendDuration,r));this._generateSongBookWhammyOrBend(e,h,!1,[a[0].value,a[1].value],p,r,c);return}break}this._generateWhammyOrBend(e,h,d,r,c)}_generateWhammyOrBend(t,e,s,i,r){const a=e/H.MaxPosition;for(let l=0;l<s.length-1;l++){const h=s[l],c=s[l+1],d=Ne.getPitchWheel(h.value),u=Ne.getPitchWheel(c.value),p=a*(c.offset-h.offset),g=t+a*h.offset;this._generateBendValues(g,p,d,u,i,r)}}_generateBendValues(t,e,s,i,r,a){const l=D.ticksToMillis(e,r),h=Math.abs(i-s)/Ne._pitchValuePerSemitone,c=Math.max(Ne._minBreakpointsPerSemitone*h,l/Ne._millisecondsPerBreakpoint),d=e/c,u=(i-s)/c,p=t+e;for(let g=0;g<c;g++)a(t|0,Math.round(s)),s+=u,t+=d;a(p|0,i)}_generateRasgueado(t,e,s,i,r,a,l){let h=s;for(let c=0;c<l.durations.length;c++){const d=l.brushInfos[c],u=e.isStringed&&e.string<=d.length?d[e.string-1]:0,p=l.durations[c];this._handler.addNote(t.index,h+u,p-u,i,r,a),h+=p}}_generateTrill(t,e,s,i,r,a){const l=t.beat.voice.bar.staff.track,h=t.stringTuning+t.trillFret;let c=D.toTicks(t.trillSpeed),d=!0,u=e;const p=e+s.untilTieOrSlideEnd;for(;u+10<p;)u+c>=p&&(c=p-u),this._handler.addNote(l.index,u,c,d?i:h,r,a),d=!d,u+=c}_generateTremoloPicking(t,e,s,i,r,a){const l=t.beat.voice.bar.staff.track;if(t.beat.tremoloPicking.marks===0)return;let c=t.beat.tremoloPicking.getDurationAsTicks(t.beat.duration)*s.beatDurationFactor,d=e;const u=e+s.untilTieOrSlideEnd;for(;d+10<u;)d+c>=u&&(c=u-d),this._handler.addNote(l.index,d,c,i,r,a),d+=c}_getRasgueadoInfo(t,e){if(!t.hasRasgueado)return null;const s=new ou,r=Ne._rasgueadoDurations.get(t.rasgueado).reduce((d,u)=>d+u,0);s.durations=Ne._rasgueadoDurations.get(t.rasgueado).map(d=>e*d/r),s.brushInfos=new Array(s.durations.length);const a=D.toTicks(b.Sixteenth);let l=0,h=0;for(const d of t.notes)d.isTieDestination||(l|=1<<d.string-1,h++);const c=Ne._rasgueadoDirections.get(t.rasgueado);for(let d=0;d<s.durations.length;d++){const u=s.durations[d]*a/D.QuarterTime,p=new Int32Array(t.voice.bar.staff.tuning.length);s.brushInfos[d]=p;const g=c[d];g!==Y.None&&this._fillBrushInfo(t,p,g===Y.ArpeggioDown||g===Y.BrushDown,l,h,u)}return s}_getBrushInfo(t){const e=new Int32Array(t.voice.bar.staff.tuning.length);if(t.brushType){let s=0,i=0;for(const r of t.notes)r.isTieDestination||(s|=1<<r.string-1,i++);this._fillBrushInfo(t,e,t.brushType===Y.ArpeggioDown||t.brushType===Y.BrushDown,s,i,t.brushDuration)}return e}_fillBrushInfo(t,e,s,i,r,a){if(t.notes.length>0){let l=0;const h=a/(r-1)|0;for(let c=0;c<t.voice.bar.staff.tuning.length;c++){const d=s?c:e.length-1-c;i&1<<d&&(e[d]=l,l+=h)}}return e}_generateNonTempoAutomation(t,e,s){switch(e.type){case Ve.Instrument:this._addProgramChange(t.voice.bar.staff.track,t.playbackStart+s,t.voice.bar.staff.track.playbackInfo.primaryChannel,(e.value|0)&255),this._addProgramChange(t.voice.bar.staff.track,t.playbackStart+s,t.voice.bar.staff.track.playbackInfo.secondaryChannel,(e.value|0)&255);break;case Ve.Bank:this._addBankChange(t.voice.bar.staff.track,t.playbackStart+s,t.voice.bar.staff.track.playbackInfo.primaryChannel,e.value),this._addBankChange(t.voice.bar.staff.track,t.playbackStart+s,t.voice.bar.staff.track.playbackInfo.secondaryChannel,e.value);break;case Ve.Balance:const i=Ne._toChannelShort(e.value);this._handler.addControlChange(t.voice.bar.staff.track.index,t.playbackStart+s,t.voice.bar.staff.track.playbackInfo.primaryChannel,at.PanCoarse,i),this._handler.addControlChange(t.voice.bar.staff.track.index,t.playbackStart+s,t.voice.bar.staff.track.playbackInfo.secondaryChannel,at.PanCoarse,i);break;case Ve.Volume:const r=Ne._toChannelShort(e.value);this._handler.addControlChange(t.voice.bar.staff.track.index,t.playbackStart+s,t.voice.bar.staff.track.playbackInfo.primaryChannel,at.VolumeCoarse,r),this._handler.addControlChange(t.voice.bar.staff.track.index,t.playbackStart+s,t.voice.bar.staff.track.playbackInfo.secondaryChannel,at.VolumeCoarse,r);break}}prepareSingleBeat(t){let e=-1,s=-1,i=t;for(;i&&(e===-1||s===-1);){for(const d of t.automations)switch(d.type){case Ve.Instrument:s=d.value;break;case Ve.Tempo:e=d.value;break}i=i.previousBeat}const r=t.voice.bar.staff.track,a=t.voice.bar.masterBar;e===-1&&(e=a.score.tempo);const l=t.playbackStart/a.calculateDuration();for(const d of a.tempoAutomations)if(d.ratioPosition<=l)e=d.value;else break;s===-1&&(s=r.playbackInfo.program);const h=r.playbackInfo.volume;this._generateTrack(r),this._handler.addTimeSignature(0,a.timeSignatureNumerator,a.timeSignatureDenominator),this._handler.addTempo(0,e);const c=Ne._toChannelShort(h);return this._handler.addControlChange(0,0,r.playbackInfo.primaryChannel,at.VolumeCoarse,c),this._handler.addControlChange(0,0,r.playbackInfo.secondaryChannel,at.VolumeCoarse,c),e}generateSingleBeat(t){const e=this.prepareSingleBeat(t);this._generateBeat(t,-t.playbackStart,t.voice.bar,e)}generateSingleNote(t){const e=this.prepareSingleBeat(t.beat);this._generateNote(t,0,t.beat.playbackDuration,e,new Int32Array(t.beat.voice.bar.staff.tuning.length),null)}};o(Ne,"_defaultDurationDead",30),o(Ne,"_defaultDurationPalmMute",80),o(Ne,"_ornamentKeysUp",[2,2,2,1,1,2,2,2,2,2,1,1]),o(Ne,"ornamentKeysDown",[-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1]),o(Ne,"_pitchBendRangeInSemitones",8*2),o(Ne,"_pitchValuePerSemitone",ye.DefaultPitchWheel/Ne._pitchBendRangeInSemitones),o(Ne,"_minBreakpointsPerSemitone",6),o(Ne,"_millisecondsPerBreakpoint",150),o(Ne,"_rasgueadoDirections",new Map([[le.Ii,[Y.BrushDown,Y.BrushUp]],[le.Mi,[Y.BrushDown,Y.BrushDown]],[le.MiiTriplet,[Y.BrushDown,Y.BrushDown,Y.BrushUp]],[le.MiiAnapaest,[Y.BrushDown,Y.BrushDown,Y.BrushUp]],[le.PmpTriplet,[Y.BrushUp,Y.BrushDown,Y.BrushDown]],[le.PmpAnapaest,[Y.BrushUp,Y.BrushDown,Y.BrushDown]],[le.PeiTriplet,[Y.BrushUp,Y.BrushDown,Y.BrushDown]],[le.PeiAnapaest,[Y.BrushUp,Y.BrushDown,Y.BrushDown]],[le.PaiTriplet,[Y.BrushUp,Y.BrushDown,Y.BrushDown]],[le.PaiAnapaest,[Y.BrushUp,Y.BrushDown,Y.BrushDown]],[le.AmiTriplet,[Y.BrushDown,Y.BrushDown,Y.BrushDown]],[le.AmiAnapaest,[Y.BrushDown,Y.BrushDown,Y.BrushDown]],[le.Ppp,[Y.None,Y.BrushDown,Y.BrushUp]],[le.Amii,[Y.BrushDown,Y.BrushDown,Y.BrushDown,Y.BrushUp]],[le.Amip,[Y.BrushDown,Y.BrushDown,Y.BrushDown,Y.BrushUp]],[le.Eami,[Y.BrushDown,Y.BrushDown,Y.BrushDown,Y.BrushDown]],[le.Eamii,[Y.BrushDown,Y.BrushDown,Y.BrushDown,Y.BrushDown,Y.BrushUp]],[le.Peami,[Y.BrushDown,Y.BrushDown,Y.BrushDown,Y.BrushDown,Y.BrushUp]]])),o(Ne,"_rasgueadoDurations",new Map([[le.Ii,[D.toTicks(b.Eighth),D.toTicks(b.Eighth)]],[le.Mi,[D.toTicks(b.Eighth),D.toTicks(b.Eighth)]],[le.MiiTriplet,[D.toTicks(b.Eighth)/3,D.toTicks(b.Eighth)/3,D.toTicks(b.Eighth)/3]],[le.MiiAnapaest,[D.toTicks(b.Sixteenth),D.toTicks(b.Sixteenth),D.toTicks(b.Eighth)]],[le.PmpTriplet,[D.toTicks(b.Eighth)/3,D.toTicks(b.Eighth)/3,D.toTicks(b.Eighth)/3]],[le.PmpAnapaest,[D.toTicks(b.Sixteenth)/3,D.toTicks(b.Sixteenth)/3,D.toTicks(b.Eighth)/3]],[le.PeiTriplet,[D.toTicks(b.Eighth)/3,D.toTicks(b.Eighth)/3,D.toTicks(b.Eighth)/3]],[le.PeiAnapaest,[D.toTicks(b.Sixteenth),D.toTicks(b.Sixteenth),D.toTicks(b.Eighth)]],[le.PaiTriplet,[D.toTicks(b.Eighth)/3,D.toTicks(b.Eighth)/3,D.toTicks(b.Eighth)/3]],[le.PaiAnapaest,[D.toTicks(b.Sixteenth),D.toTicks(b.Sixteenth),D.toTicks(b.Eighth)]],[le.AmiTriplet,[D.toTicks(b.Eighth)/3,D.toTicks(b.Eighth)/3,D.toTicks(b.Eighth)/3]],[le.AmiAnapaest,[D.toTicks(b.Sixteenth)/3,D.toTicks(b.Sixteenth)/3,D.toTicks(b.Eighth)/3]],[le.Ppp,[D.toTicks(b.Sixteenth)/3,D.toTicks(b.Sixteenth)/3,D.toTicks(b.Eighth)/3]],[le.Amii,[D.toTicks(b.Sixteenth)/3,D.toTicks(b.Sixteenth)/3,D.toTicks(b.Sixteenth)/3,D.toTicks(b.Eighth)]],[le.Amip,[D.toTicks(b.Sixteenth)/3,D.toTicks(b.Sixteenth)/3,D.toTicks(b.Sixteenth)/3,D.toTicks(b.Eighth)]],[le.Eami,[D.toTicks(b.Sixteenth),D.toTicks(b.Sixteenth),D.toTicks(b.Sixteenth),D.toTicks(b.Sixteenth)]],[le.Eamii,[D.toTicks(b.Sixteenth)/5,D.toTicks(b.Sixteenth)/5,D.toTicks(b.Sixteenth)/5,D.toTicks(b.Sixteenth)/5,D.toTicks(b.Sixteenth)/5]],[le.Peami,[D.toTicks(b.Sixteenth)/5,D.toTicks(b.Sixteenth)/5,D.toTicks(b.Sixteenth)/5,D.toTicks(b.Sixteenth)/5,D.toTicks(b.Sixteenth)/5]]]));let Bi=Ne;class hu{onAttach(t){}onDetach(t){}placeBeatCursor(t,e,s){const r=e.barBounds.masterBarBounds.visualBounds;t.transitionToX(0,s),t.setBounds(s,r.y,1,r.h)}placeBarCursor(t,e){const i=e.barBounds.masterBarBounds.visualBounds;t.setBounds(i.x,i.y,i.w,i.h)}transitionBeatCursor(t,e,s,i,r,a){const l=a===Ts.ToNextBext?2:1;i=s+(i-s)*l,r=r*l,t.transitionToX(r,i)}}class cu{onAttach(t){}onDetach(t){}placeBeatCursor(t,e,s){const r=e.barBounds.masterBarBounds.visualBounds;t.transitionToX(0,s),t.setBounds(s,r.y,1,r.h)}placeBarCursor(t,e){const i=e.barBounds.masterBarBounds.visualBounds;t.setBounds(i.x,i.y,i.w,i.h)}transitionBeatCursor(t,e,s,i,r,a){this.placeBeatCursor(t,e,s)}}var oe;(function(n){n[n.PreNotes=0]="PreNotes",n[n.OnNotes=1]="OnNotes",n[n.MiddleNotes=2]="MiddleNotes",n[n.Stem=3]="Stem",n[n.PostNotes=4]="PostNotes",n[n.EndBeat=5]="EndBeat"})(oe||(oe={}));class It{constructor(t,e){o(this,"x");o(this,"y");o(this,"width",0);o(this,"height",0);o(this,"renderer");this.x=t,this.y=e}getBoundingBoxTop(){return this.y}getBoundingBoxBottom(){return this.getBoundingBoxTop()+this.height}doLayout(){}paint(t,e,s){}}class mh extends It{scaleToWidth(t){this.width=t}}class Pi extends mh{constructor(e){super(0,0);o(this,"_ties",[]);o(this,"_tieWidth",0);o(this,"beat");o(this,"preNotes");o(this,"onNotes");this.beat=e,this._ties=[]}getLowestNoteY(e){return this.onNotes.getLowestNoteY(e)}getHighestNoteY(e){return this.onNotes.getHighestNoteY(e)}get beatId(){return this.beat.id}get isLastOfVoice(){return this.beat.isLastOfVoice}get displayDuration(){return this.beat.displayDuration}get graceIndex(){return this.beat.graceIndex}get graceType(){return this.beat.graceType}get absoluteDisplayStart(){return this.beat.absoluteDisplayStart}get graceGroup(){return this.beat.graceGroup}get voiceIndex(){return this.beat.voice.index}get isFirstOfTupletGroup(){return this.beat.hasTuplet&&this.beat.tupletGroup.beats[0].id===this.beat.id}get tupletGroup(){return this.beat.tupletGroup}get onTimeX(){return this.onNotes.x+this.onNotes.onTimeX}getNoteY(e,s){return this.onNotes.y+this.onNotes.getNoteY(e,s)}getRestY(e){return this.onNotes.y+this.onNotes.getRestY(e)}getNoteX(e,s){return this.onNotes.x+this.onNotes.getNoteX(e,s)}addTie(e){const s=e;s.renderer=this.renderer,this._ties.push(e),this.renderer.registerTie(e)}getBoundingBoxTop(){let e=A.minBoundingBox(this.preNotes.getBoundingBoxTop(),this.onNotes.getBoundingBoxTop());return Number.isNaN(e)&&(e=this.renderer.middleYPosition),e}getBoundingBoxBottom(){let e=A.maxBoundingBox(this.preNotes.getBoundingBoxBottom(),this.onNotes.getBoundingBoxBottom());return Number.isNaN(e)&&(e=this.renderer.middleYPosition),e}drawBeamHelperAsFlags(e){return e.hasFlag(!1,void 0)}get postBeatStretch(){return this.onNotes.computedWidth+this._tieWidth-this.onNotes.onTimeX}registerLayoutingInfo(e){const s=this.preNotes.computedWidth+this.onNotes.onTimeX;let i=this.postBeatStretch;for(const r of this._ties)i+=r.width;e.addBeatSpring(this,s,i),e.setBeatSizes(this,{preBeatSize:this.preNotes.width,onBeatSize:this.onNotes.width})}applyLayoutingInfo(e){this.updateWidth()}doLayout(){this.preNotes.x=0,this.preNotes.renderer=this.renderer,this.preNotes.container=this,this.preNotes.doLayout(),this.onNotes.x=this.preNotes.x+this.preNotes.width,this.onNotes.renderer=this.renderer,this.onNotes.container=this,this.onNotes.doLayout(),this.createBeatTies(),this.updateWidth()}createBeatTies(){let e=this.beat.notes.length-1;for(;e>=0;)this.createTies(this.beat.notes[e--])}doMultiVoiceLayout(){}updateWidth(){let e=this.preNotes.width+this.onNotes.width,s=0;for(const i of this._ties){const r=i;r.width>s&&(s=r.width)}this._tieWidth=s,e+=s,this.width=e}createTies(e){}static getGroupId(e){return`b${e.id}`}paint(e,s,i){if(this.preNotes.isEmpty&&this.onNotes.isEmpty&&this._ties.length===0)return;i.beginGroup(Pi.getGroupId(this.beat)),this.preNotes.paint(e+this.x,s+this.y,i),this.onNotes.paint(e+this.x,s+this.y,i);const a=e-this.renderer.beatGlyphsStart-this.renderer.x,l=s-this.renderer.y;for(let h=0,c=this._ties.length;h<c;h++){const d=this._ties[h];d.renderer=this.renderer,d.paint(a,l,i)}i.endGroup()}buildBoundingsLookup(e,s,i){const r=new dh;if(r.beat=this.beat,this.beat.isEmpty)r.visualBounds=new Pt,r.visualBounds.x=s+this.x,r.visualBounds.y=e.visualBounds.y,r.visualBounds.w=this.width,r.visualBounds.h=e.visualBounds.h,r.realBounds=new Pt,r.realBounds.x=s+this.x,r.realBounds.y=e.realBounds.y,r.realBounds.w=this.width,r.realBounds.h=e.realBounds.h,r.onNotesX=s+this.x+this.onNotes.x+this.onNotes.onTimeX;else{r.visualBounds=new Pt,r.visualBounds.x=s+this.x,this.preNotes.isEmpty?this.onNotes.isEmpty?r.visualBounds.x=s+this.x:r.visualBounds.x=s+this.x+this.onNotes.x:r.visualBounds.x=s+this.x+this.preNotes.x;let a=0;this.onNotes.isEmpty?this.preNotes.isEmpty?a=s+this.x+this.width:a=s+this.x+this.preNotes.x+this.preNotes.width:a=s+this.x+this.onNotes.x+this.onNotes.onTimeX+this.postBeatStretch,r.visualBounds.w=a-r.visualBounds.x,r.visualBounds.y=e.visualBounds.y,r.visualBounds.h=e.visualBounds.h,r.realBounds=new Pt,r.realBounds.x=s+this.x,r.realBounds.y=e.realBounds.y,r.realBounds.w=this.width,r.realBounds.h=e.realBounds.h,r.onNotesX=s+this.x+this.onNotes.x+this.onNotes.onTimeX}e.addBeat(r),this.renderer.settings.core.includeNoteBounds&&this.onNotes.buildBoundingsLookup(r,s+this.x,i+this.y)}getBeatX(e,s=!1){var i;switch(e){case oe.PreNotes:return this.preNotes.x;case oe.OnNotes:return this.onNotes.x;case oe.MiddleNotes:return this.onNotes.x+this.onNotes.middleX;case oe.Stem:return this.onNotes.x+this.onNotes.stemX;case oe.PostNotes:const r=s?((i=this.renderer.layoutingInfo.getBeatSizes(this.beat))==null?void 0:i.onBeatSize)??this.onNotes.width:this.onNotes.width;return this.onNotes.x+r;case oe.EndBeat:return this.width}return this.preNotes.x}}class du{constructor(){o(this,"_instance");o(this,"_instanceEventUnregister");o(this,"_settings");o(this,"_width",0);o(this,"_score",null);o(this,"_trackIndexes",null);o(this,"preRender",new xe);o(this,"renderFinished",new xe);o(this,"partialRenderFinished",new xe);o(this,"partialLayoutFinished",new xe);o(this,"postRenderFinished",new Ct);o(this,"error",new xe)}get instance(){return this._instance}set instance(t){this._instance=t;const e=this._instanceEventUnregister;if(e)for(const s of e)s();if(t){const s=[];s.push(t.preRender.on(i=>this.preRender.trigger(i))),s.push(t.renderFinished.on(i=>this.renderFinished.trigger(i))),s.push(t.partialRenderFinished.on(i=>this.partialRenderFinished.trigger(i))),s.push(t.partialLayoutFinished.on(i=>this.partialLayoutFinished.trigger(i))),s.push(t.postRenderFinished.on(()=>this.postRenderFinished.trigger())),s.push(t.error.on(i=>this.error.trigger(i))),this._instanceEventUnregister=s,this._settings&&t.updateSettings(this._settings),t.width=this._width,this._score!==null&&t.renderScore(this._score,this._trackIndexes)}else this._instanceEventUnregister=void 0}get boundsLookup(){return this._instance?this._instance.boundsLookup:null}get width(){return this._instance?this._instance.width:0}set width(t){this._width=t,this._instance&&(this._instance.width=t)}render(t){var e;(e=this._instance)==null||e.render(t)}resizeRender(){var t;(t=this._instance)==null||t.resizeRender()}renderScore(t,e,s){var i;this._score=t,this._trackIndexes=e,(i=this._instance)==null||i.renderScore(t,e,s)}renderResult(t){var e;(e=this._instance)==null||e.renderResult(t)}updateSettings(t){var e;this._settings=t,(e=this._instance)==null||e.updateSettings(t)}destroy(){var t;(t=this._instance)==null||t.destroy(),this._instance=void 0}}class Gh{constructor(){o(this,"oldWidth",0);o(this,"newWidth",0);o(this,"settings",null)}}class _o{constructor(t){o(this,"api");o(this,"lastScroll",-1);this.api=t}[Symbol.dispose](){}forceScrollTo(t){this._scrollToBeat(t,!0),this.lastScroll=-1}_scrollToBeat(t,e){const s=this.calculateLastScroll(t);s===this.lastScroll&&!e||(this.lastScroll=s,this.doScroll(t))}onBeatCursorUpdating(t,e,s,i,r,a){this._scrollToBeat(t,!1)}}class uu extends _o{calculateLastScroll(t){return t.barBounds.masterBarBounds.realBounds.y}doScroll(t){const e=this.api.uiFacade,s=this.api.settings,i=e.getScrollContainer(),r=e.getOffset(i,this.api.container),a=t.barBounds.masterBarBounds.realBounds.y+s.player.scrollOffsetY;e.scrollToY(i,r.y+a,this.api.settings.player.scrollSpeed)}}class fu extends _o{calculateLastScroll(t){return t.barBounds.masterBarBounds.realBounds.y}doScroll(t){const e=this.api.uiFacade,s=this.api.settings,i=e.getScrollContainer(),r=i.scrollTop+e.getOffset(null,i).h,a=t.barBounds.masterBarBounds;if(a.visualBounds.y+a.visualBounds.h>=r||a.visualBounds.y<i.scrollTop){const l=a.realBounds.y+s.player.scrollOffsetY;e.scrollToY(i,l,s.player.scrollSpeed)}}}class pu{constructor(t){o(this,"_api");o(this,"_lastScroll",-1);o(this,"_scrollContainerResizeUnregister");this._api=t,this._scrollContainerResizeUnregister=t.uiFacade.getScrollContainer().resize.on(()=>{const e=t.uiFacade.getScrollContainer(),s=t.settings.player.scrollOffsetX,r=e.width+s;t.uiFacade.setCanvasOverflow(t.canvasElement,r,!0)})}[Symbol.dispose](){this._api.uiFacade.setCanvasOverflow(this._api.canvasElement,0,!0),this._scrollContainerResizeUnregister()}forceScrollTo(t){const e=this._api.uiFacade,s=this._api.settings,i=e.getScrollContainer(),r=t.barBounds.masterBarBounds.realBounds.y+s.player.scrollOffsetY;e.scrollToY(i,r,0),this._lastScroll=-1}onBeatCursorUpdating(t,e,s,i,r,a){const l=this._api.uiFacade,h=this._api.settings,c=t.barBounds.masterBarBounds,d=c.realBounds.y+h.player.scrollOffsetY;if(d===this._lastScroll&&a>0)return;const u=l.getScrollContainer();if(l.scrollToY(u,d,0),a===0){this._lastScroll=-1;return}this._lastScroll=d;const p=d+c.realBounds.h,g=this._calculateSystemDuration(c);l.scrollToY(u,p,g)}_calculateSystemDuration(t){const e=t.staffSystemBounds.bars,s=this._api.tickCache;let i=0;const r=this._api.score.masterBars;for(const a of e){const l=r[a.index],h=s.getMasterBar(l),c=s.getMasterBar(l).tempoChanges;let d=c[0].tempo,u=c[0].tick;for(let g=1;g<c.length;g++){const m=c[g].tick-u;i+=D.ticksToMillis(m,d),d=c[g].tempo,u=c[g].tick}const p=h.end-u;i+=D.ticksToMillis(p,d)}return i}}class gu extends _o{calculateLastScroll(t){return t.barBounds.masterBarBounds.visualBounds.x}doScroll(t){const e=this.api.uiFacade,s=this.api.settings,i=e.getScrollContainer(),a=t.barBounds.masterBarBounds.realBounds.x+s.player.scrollOffsetX;e.scrollToX(i,a,s.player.scrollSpeed)}}class mu extends _o{calculateLastScroll(t){return t.barBounds.masterBarBounds.visualBounds.x}doScroll(t){const e=this.api.uiFacade,s=this.api.settings,i=e.getScrollContainer(),r=i.scrollLeft+e.getOffset(null,i).w,a=t.barBounds.masterBarBounds;if(a.visualBounds.x+a.visualBounds.w>=r||a.visualBounds.x<i.scrollLeft){const l=a.realBounds.x+s.player.scrollOffsetX;e.scrollToX(i,l,s.player.scrollSpeed)}}}class yu{constructor(t){o(this,"_api");o(this,"_lastScroll",-1);o(this,"_scrollContainerResizeUnregister");this._api=t,this._scrollContainerResizeUnregister=t.uiFacade.getScrollContainer().resize.on(()=>{const e=t.uiFacade.getScrollContainer(),s=t.settings.player.scrollOffsetX,r=e.width+s;t.uiFacade.setCanvasOverflow(t.canvasElement,r,!1)})}[Symbol.dispose](){this._scrollContainerResizeUnregister(),this._api.uiFacade.setCanvasOverflow(this._api.canvasElement,0,!1)}forceScrollTo(t){const e=this._api.uiFacade,s=this._api.settings,i=e.getScrollContainer(),r=t.onNotesX+s.player.scrollOffsetY;e.scrollToY(i,r,0),this._lastScroll=-1}onBeatCursorUpdating(t,e,s,i,r,a){const l=this._api.uiFacade;if(r===this._lastScroll&&a>0)return;const h=this._api.settings,c=l.getScrollContainer();if(l.scrollToX(c,i+h.player.scrollOffsetX,0),a===0){this._lastScroll=-1;return}this._lastScroll=r;const d=r+h.player.scrollOffsetX;l.scrollToX(c,d,a)}}class yl{constructor(t){o(this,"activeBeats");this.activeBeats=t}}class Kn{constructor(){o(this,"startTick",0);o(this,"endTick",0)}}class bu{constructor(){o(this,"_masterVolume",1);o(this,"_metronomeVolume",0);o(this,"_countInVolume",0);o(this,"_playbackSpeed",1);o(this,"_isLooping",!1);o(this,"_midiEventsPlayedFilter",[]);o(this,"_instance");o(this,"_instanceEventUnregister");o(this,"midiTickShift",0);o(this,"ready");o(this,"readyForPlayback");o(this,"finished",new Ct);o(this,"soundFontLoaded",new Ct);o(this,"soundFontLoadFailed",new xe);o(this,"midiLoaded");o(this,"midiLoadFailed",new xe);o(this,"stateChanged");o(this,"positionChanged");o(this,"midiEventsPlayed",new xe);o(this,"playbackRangeChanged");this.ready=new Ct(()=>this.isReady),this.readyForPlayback=new Ct(()=>this.isReadyForPlayback),this.midiLoaded=new xe(()=>{var t;return((t=this._instance)==null?void 0:t.loadedMidiInfo)??null}),this.stateChanged=new xe(()=>new Br(this.state,!1)),this.positionChanged=new xe(()=>this.currentPosition),this.playbackRangeChanged=new xe(()=>{const t=this.playbackRange;return t?new jr(t):null})}get instance(){return this._instance}set instance(t){this._instance=t;const e=this._instanceEventUnregister;if(e)for(const s of e)s();if(t){const s=[];s.push(t.ready.on(()=>this.ready.trigger())),s.push(t.readyForPlayback.on(()=>this.readyForPlayback.trigger())),s.push(t.finished.on(()=>this.finished.trigger())),s.push(t.soundFontLoaded.on(()=>this.soundFontLoaded.trigger())),s.push(t.soundFontLoadFailed.on(i=>this.soundFontLoadFailed.trigger(i))),s.push(t.midiLoaded.on(i=>{this.midiLoaded.trigger(this._shiftPositionChangedEventArgsToApi(i))})),s.push(t.midiLoadFailed.on(i=>this.midiLoadFailed.trigger(i))),s.push(t.stateChanged.on(i=>this.stateChanged.trigger(i))),s.push(t.positionChanged.on(i=>{this.positionChanged.trigger(this._shiftPositionChangedEventArgsToApi(i))})),s.push(t.midiEventsPlayed.on(i=>this.midiEventsPlayed.trigger(i))),s.push(t.playbackRangeChanged.on(i=>this.playbackRangeChanged.trigger(this._shiftPlaybackRangeChangedEventArgsToApi(i)))),this._instanceEventUnregister=s,this.isReady?(t.masterVolume=this._masterVolume,t.metronomeVolume=this._metronomeVolume,t.countInVolume=this._countInVolume,t.playbackSpeed=this._playbackSpeed,t.isLooping=this._isLooping,t.midiEventsPlayedFilter=this._midiEventsPlayedFilter,this.ready.trigger()):s.push(t.ready.on(()=>{t.masterVolume=this._masterVolume,t.metronomeVolume=this._metronomeVolume,t.countInVolume=this._countInVolume,t.playbackSpeed=this._playbackSpeed,t.isLooping=this._isLooping,t.midiEventsPlayedFilter=this._midiEventsPlayedFilter}))}else this._instanceEventUnregister=void 0}get output(){return this._instance.output}get isReady(){return this._instance?this._instance.isReady:!1}get isReadyForPlayback(){return this._instance?this._instance.isReadyForPlayback:!1}get state(){return this._instance?this._instance.state:Ut.Paused}get logLevel(){return L.logLevel}set logLevel(t){L.logLevel=t,this._instance&&(this._instance.logLevel=t)}get masterVolume(){return this._masterVolume}set masterVolume(t){t=Math.max(t,ye.MinVolume),this._masterVolume=t,this._instance&&(this._instance.masterVolume=t)}get metronomeVolume(){return this._metronomeVolume}set metronomeVolume(t){t=Math.max(t,ye.MinVolume),this._metronomeVolume=t,this._instance&&(this._instance.metronomeVolume=t)}get playbackSpeed(){return this._playbackSpeed}set playbackSpeed(t){this._playbackSpeed=t,this._instance&&(this._instance.playbackSpeed=t)}get loadedMidiInfo(){return this._instance?this._shiftPositionChangedEventArgsToApi(this._instance.loadedMidiInfo):void 0}get currentPosition(){return this._instance?this._shiftPositionChangedEventArgsToApi(this._instance.currentPosition):new ci(0,0,0,0,!1,120,120)}get tickPosition(){return this._instance?this._shiftTickToApi(this._instance.tickPosition):0}set tickPosition(t){this._instance&&(this._instance.tickPosition=this._shiftTickToPlayer(t))}get timePosition(){return this._instance?this._instance.timePosition:0}set timePosition(t){this._instance&&(this._instance.timePosition=t)}get playbackRange(){return this._instance?this._shiftPlaybackRangeToApi(this._instance.playbackRange):null}set playbackRange(t){this._instance&&(this._instance.playbackRange=this._shiftPlaybackRangeToPlayer(t))}get isLooping(){return this._isLooping}set isLooping(t){this._isLooping=t,this._instance&&(this._instance.isLooping=t)}get countInVolume(){return this._countInVolume}set countInVolume(t){this._countInVolume=t,this._instance&&(this._instance.countInVolume=t)}get midiEventsPlayedFilter(){return this._midiEventsPlayedFilter}set midiEventsPlayedFilter(t){this._midiEventsPlayedFilter=t,this._instance&&(this._instance.midiEventsPlayedFilter=t)}destroy(){this._instance&&(this._instance.destroy(),this._instance=void 0)}play(){return this._instance?this._instance.play():!1}pause(){this._instance&&this._instance.pause()}playPause(){this._instance&&this._instance.playPause()}stop(){this._instance&&this._instance.stop()}playOneTimeMidiFile(t){this._instance&&this._instance.playOneTimeMidiFile(t)}loadSoundFont(t,e){this._instance&&this._instance.loadSoundFont(t,e)}resetSoundFonts(){this._instance&&this._instance.resetSoundFonts()}loadMidiFile(t){this._instance&&this._instance.loadMidiFile(t)}loadBackingTrack(t){this._instance&&this._instance.loadBackingTrack(t)}updateSyncPoints(t){this._instance&&this._instance.updateSyncPoints(t)}applyTranspositionPitches(t){this._instance&&this._instance.applyTranspositionPitches(t)}setChannelTranspositionPitch(t,e){this._instance&&this._instance.setChannelTranspositionPitch(t,e)}setChannelMute(t,e){this._instance&&this._instance.setChannelMute(t,e)}resetChannelStates(){this._instance&&this._instance.resetChannelStates()}setChannelSolo(t,e){this._instance&&this._instance.setChannelSolo(t,e)}setChannelVolume(t,e){this._instance&&this._instance.setChannelVolume(t,e)}_shiftPlaybackRangeChangedEventArgsToApi(t){return t.playbackRange==null?t:this.midiTickShift>0?new jr(this._shiftPlaybackRangeToApi(t.playbackRange)):t}_shiftPlaybackRangeToApi(t){if(t==null)return t;const e=this.midiTickShift;if(e>0){const s=new Kn;return s.startTick=t.startTick-e,s.endTick=t.endTick-e,s}else return t}_shiftPlaybackRangeToPlayer(t){if(t==null)return t;const e=this.midiTickShift;if(e>0){const s=new Kn;return s.startTick=t.startTick+e,s.endTick=t.endTick+e,s}else return t}_shiftPositionChangedEventArgsToApi(t){if(!t)return t;const e=this.midiTickShift;return e>0?new ci(t.currentTime,t.endTime,t.currentTick-e,t.endTick-e,t.isSeek,t.originalTempo,t.modifiedTempo):t}_shiftTickToApi(t){return t-this.midiTickShift}_shiftTickToPlayer(t){return t+this.midiTickShift}}class Su{constructor(){o(this,"_midiEventQueue",new nh);o(this,"masterVolume",1);o(this,"metronomeVolume",0);o(this,"outSampleRate",44100);o(this,"currentTempo",120);o(this,"timeSignatureNumerator",4);o(this,"timeSignatureDenominator",4);o(this,"activeVoiceCount",0);o(this,"output")}noteOffAll(t){}resetSoft(){}resetPresets(){}loadPresets(t,e,s,i){}setupMetronomeChannel(t){}synthesizeSilent(t){this.fakeSynthesize()}_processMidiMessage(t){}dispatchEvent(t){this._midiEventQueue.enqueue(t)}synthesize(t,e,s){return this.fakeSynthesize()}fakeSynthesize(){const t=[];for(;!this._midiEventQueue.isEmpty;){const e=this._midiEventQueue.dequeue();e.isMetronome&&this.metronomeVolume>0||e.event&&this._processMidiMessage(e.event),t.push(e)}return t}applyTranspositionPitches(t){}setChannelTranspositionPitch(t,e){}channelSetMute(t,e){}channelSetSolo(t,e){}resetChannelStates(){}channelSetMixVolume(t,e){}hasSamplesForProgram(t){return!0}hasSamplesForPercussion(t){return!0}}class Dc extends lh{constructor(e,s){super(e,new Su,s);o(this,"_backingTrackOutput");this.synthesizer.output=e,this._backingTrackOutput=e,e.timeUpdate.on(i=>{const r=this.sequencer.mainTimePositionFromBackingTrack(i,e.backingTrackDuration);this.sequencer.fillMidiEventQueueToEndTime(r),this.synthesizer.fakeSynthesize(),this.updateTimePosition(r,!1),this.checkForFinish()})}updateMasterVolume(e){super.updateMasterVolume(e),this._backingTrackOutput.masterVolume=e}updatePlaybackSpeed(e){super.updatePlaybackSpeed(e),this._backingTrackOutput.playbackRate=e}onSampleRequest(){}loadMidiFile(e){this.isSoundFontLoaded||(this.isSoundFontLoaded=!0,this.soundFontLoaded.trigger()),super.loadMidiFile(e)}updateTimePosition(e,s){super.updateTimePosition(e,s),s&&this._backingTrackOutput.seekTo(this.sequencer.mainTimePositionToBackingTrack(e,this._backingTrackOutput.backingTrackDuration))}loadBackingTrack(e){const s=e.backingTrack;s&&(this._backingTrackOutput.loadBackingTrack(s),this.timePosition=0)}updateSyncPoints(e){this.sequencer.mainUpdateSyncPoints(e),this.tickPosition=this.tickPosition}}class _u{constructor(){o(this,"sampleRate",44100);o(this,"_seekPosition",0);o(this,"_handler");o(this,"ready",new Ct);o(this,"samplesPlayed",new xe);o(this,"timeUpdate",new xe);o(this,"sampleRequest",new Ct)}get handler(){return this._handler}set handler(t){t&&this._seekPosition!==0&&(t.seekTo(this._seekPosition),this._seekPosition=0),this._handler=t}get backingTrackDuration(){var t;return((t=this.handler)==null?void 0:t.backingTrackDuration)??0}get playbackRate(){var t;return((t=this.handler)==null?void 0:t.playbackRate)??1}set playbackRate(t){const e=this.handler;e&&(e.playbackRate=t)}get masterVolume(){var t;return((t=this.handler)==null?void 0:t.masterVolume)??1}set masterVolume(t){const e=this.handler;e&&(e.masterVolume=t)}seekTo(t){const e=this.handler;e?e.seekTo(t):this._seekPosition=t}loadBackingTrack(t){}open(t){this.ready.trigger()}updatePosition(t){this.timeUpdate.trigger(t)}play(){var t;(t=this.handler)==null||t.play()}destroy(){}pause(){var t;(t=this.handler)==null||t.pause()}addSamples(t){}resetSamples(){}activate(){}async enumerateOutputDevices(){return[]}async setOutputDevice(t){}async getOutputDevice(){return null}}class ku extends Dc{get handler(){return this.output.handler}set handler(t){this.output.handler=t}constructor(t){super(new _u,t)}}class Zn{constructor(t,e,s,i){o(this,"cursorWrapper");o(this,"barCursor");o(this,"beatCursor");o(this,"selectionWrapper");this.cursorWrapper=t,this.barCursor=e,this.beatCursor=s,this.selectionWrapper=i}}class wu{constructor(){o(this,"bounds",null)}isVisible(t){const e=this.bounds;return e?e.findBeat(t)!==null:!1}}class Bu{constructor(t,e){o(this,"_startTime",0);o(this,"_trackIndexes",null);o(this,"_trackIndexLookup",null);o(this,"_beatVisibilityChecker",new wu);o(this,"_isDestroyed",!1);o(this,"_score",null);o(this,"_tracks",[]);o(this,"_actualPlayerMode",fs.Disabled);o(this,"_player");o(this,"_renderer");o(this,"_defaultScrollHandler");o(this,"_defaultCursorHandler");o(this,"_customCursorHandler");o(this,"uiFacade");o(this,"container");o(this,"settings");o(this,"canvasElement");o(this,"_tickCache",null);o(this,"customScrollHandler");o(this,"_cursorWrapper",null);o(this,"_barCursor",null);o(this,"_beatCursor",null);o(this,"_selectionWrapper",null);o(this,"_previousTick",0);o(this,"_currentBeat",null);o(this,"_currentBeatBounds",null);o(this,"_isInitialBeatCursorUpdate",!0);o(this,"_previousStateForCursor",Ut.Paused);o(this,"_previousCursorCache",null);o(this,"_cursorHandlerMode",!1);o(this,"_scrollHandlerMode",hi.Off);o(this,"_scrollHandlerVertical",!0);o(this,"playedBeatChanged");o(this,"activeBeatsChanged");o(this,"_isBeatMouseDown",!1);o(this,"_isNoteMouseDown",!1);o(this,"_selectionStart");o(this,"_selectionEnd");o(this,"beatMouseDown",new xe);o(this,"beatMouseMove",new xe);o(this,"beatMouseUp",new xe);o(this,"noteMouseDown",new xe);o(this,"noteMouseMove",new xe);o(this,"noteMouseUp",new xe);o(this,"playbackRangeHighlightChanged",new xe);o(this,"scoreLoaded");o(this,"resize",new xe);o(this,"renderStarted",new xe);o(this,"renderFinished",new xe);o(this,"postRenderFinished",new Ct);o(this,"error",new xe);o(this,"midiLoad",new xe);o(this,"midiLoaded");o(this,"settingsUpdated",new Ct);this.uiFacade=t,this.container=t.rootContainer,this.activeBeatsChanged=new xe(()=>this._player.state===Ut.Playing&&this._currentBeat?new yl(this._currentBeat.beatLookup.highlightedBeats.map(i=>i.beat)):null),this.playedBeatChanged=new xe(()=>this._player.state===Ut.Playing&&this._currentBeat?this._currentBeat.beat:null),this.scoreLoaded=new xe(()=>this._score?this._score:null),this.midiLoaded=new xe(()=>this._player.loadedMidiInfo??null),t.initialize(this,e),L.logLevel=this.settings.core.logLevel,this.settings.handleBackwardsCompatibility(),fe.printEnvironmentInfo(!1),this.canvasElement=t.createCanvasElement(),this.container.appendChild(this.canvasElement),this._renderer=new du,this.settings.core.useWorkers&&this.uiFacade.areWorkersSupported&&fe.getRenderEngineFactory(this.settings.core.engine).supportsWorkers?this._renderer.instance=this.uiFacade.createWorkerRenderer():this._renderer.instance=new Gr(this.settings),this.container.resize.on(fe.throttle(()=>{this._isDestroyed||this.container.width!==this._renderer.width&&this.triggerResize()},t.resizeThrottle));const s=new Gh;s.oldWidth=this._renderer.width,s.newWidth=this.container.width|0,s.settings=this.settings,this._onResize(s),this._renderer.preRender.on(this._onRenderStarted.bind(this)),this._renderer.renderFinished.on(i=>{this._onRenderFinished(i)}),this._renderer.postRenderFinished.on(()=>{const i=Date.now()-this._startTime;L.debug("rendering",`Rendering completed in ${i}ms`),this._onPostRenderFinished()}),this._renderer.preRender.on(i=>{this._startTime=Date.now()}),this._renderer.partialLayoutFinished.on(i=>this._appendRenderResult(i,!1)),this._renderer.partialRenderFinished.on(this._updateRenderResult.bind(this)),this._renderer.renderFinished.on(i=>{this._appendRenderResult(i,!0)}),this._renderer.error.on(this.onError.bind(this)),this._setupPlayerWrapper(),this.settings.player.playerMode!==fs.Disabled&&this._setupOrDestroyPlayer(),this._setupClickHandling(),this.uiFacade.beginInvoke(()=>{this.uiFacade.initialRender()})}get midiTickShift(){return this._player.midiTickShift}get actualPlayerMode(){return this._actualPlayerMode}get renderer(){return this._renderer}get score(){return this._score}get tracks(){return this._tracks}_setupPlayerWrapper(){const t=new bu;this._player=t,t.ready.on(()=>{this.loadMidiForScore()}),t.readyForPlayback.on(()=>{if(this._onPlayerReady(),this.tracks)for(const e of this.tracks){const s=e.playbackInfo.volume/16;t.setChannelVolume(e.playbackInfo.primaryChannel,s),t.setChannelVolume(e.playbackInfo.secondaryChannel,s)}}),t.soundFontLoaded.on(this._onSoundFontLoaded.bind(this)),t.soundFontLoadFailed.on(e=>{this.onError(e)}),t.midiLoaded.on(this._onMidiLoaded.bind(this)),t.midiLoadFailed.on(e=>{this.onError(e)}),t.stateChanged.on(this._onPlayerStateChanged.bind(this)),t.positionChanged.on(this._onPlayerPositionChanged.bind(this)),t.midiEventsPlayed.on(this._onMidiEventsPlayed.bind(this)),t.playbackRangeChanged.on(this._onPlaybackRangeChanged.bind(this)),t.finished.on(this._onPlayerFinished.bind(this))}destroy(){this._isDestroyed=!0,this._player.destroy(),this.uiFacade.destroy(),this._renderer.destroy()}updateSettings(){this.settings.handleBackwardsCompatibility();const t=this.score;t&&A.applyPitchOffsets(this.settings,t),this._updateRenderer(),this._renderer.updateSettings(this.settings),this._setupOrDestroyPlayer(),this._onSettingsUpdated()}_updateRenderer(){const t=this._renderer;this.settings.core.useWorkers&&this.uiFacade.areWorkersSupported&&fe.getRenderEngineFactory(this.settings.core.engine).supportsWorkers?t.instance instanceof Gr&&(t.destroy(),t.instance=this.uiFacade.createWorkerRenderer()):t.instance instanceof Gr||(t.destroy(),t.instance=new Gr(this.settings))}load(t,e){try{return this.uiFacade.load(t,s=>{this.renderScore(s,e)},s=>{this.onError(s)})}catch(s){return this.onError(s),!1}}renderScore(t,e,s){const i=[];if(!e)t.tracks.length>0&&i.push(t.tracks[0]);else if(e.length===0)t.tracks.length>0&&i.push(t.tracks[0]);else if(e.length===1&&e[0]===-1)for(const r of t.tracks)i.push(r);else for(const r of e)r>=0&&r<=t.tracks.length&&i.push(t.tracks[r]);this._internalRenderTracks(t,i,s)}renderTracks(t,e){if(t.length>0){const s=t[0].score;for(const i of t)if(i.score!==s){this.onError(new Xe(ze.General,"All rendered tracks must belong to the same score."));return}this._internalRenderTracks(s,t,e)}}_internalRenderTracks(t,e,s){if(A.applyPitchOffsets(this.settings,t),t!==this.score){this._score=t,this._tracks=e,this._tickCache=null,this._trackIndexes=[];for(const i of e)this._trackIndexes.push(i.index);this._trackIndexLookup=new Set(this._trackIndexes),this._onScoreLoaded(t),this.loadMidiForScore(),this.render(s)}else{this._tracks=e;const i=A.computeFirstDisplayedBarIndex(t,this.settings),r=A.computeLastDisplayedBarIndex(t,this.settings,i);this._tickCache&&(this._tickCache.multiBarRestInfo=A.buildMultiBarRestInfo(this.tracks,i,r)),this._trackIndexes=[];for(const a of e)this._trackIndexes.push(a.index);this._trackIndexLookup=new Set(this._trackIndexes),this.render(s)}}triggerResize(){if(!this.container.isVisible)L.warning("Rendering","AlphaTab container was invisible while autosizing, waiting for element to become visible",null),this.uiFacade.rootContainerBecameVisible.on(()=>{L.debug("Rendering","AlphaTab container became visible, doing autosizing",null),this.triggerResize()});else{const t=new Gh;t.oldWidth=this._renderer.width,t.newWidth=this.container.width,t.settings=this.settings,this._onResize(t),this._renderer.updateSettings(this.settings),this._renderer.width=this.container.width,this._renderer.resizeRender()}}_appendRenderResult(t,e){e&&(this.canvasElement.width=t.totalWidth,this.canvasElement.height=t.totalHeight,this._cursorWrapper&&(this._cursorWrapper.width=t.totalWidth,this._cursorWrapper.height=t.totalHeight)),(t.width>0||t.height>0)&&this.uiFacade.beginAppendRenderResults(t),e&&this.uiFacade.beginAppendRenderResults(null)}_updateRenderResult(t){t&&t.renderResult&&this.uiFacade.beginUpdateRenderResults(t)}tex(t,e){try{const s=new bo;s.logErrors=!0,s.initFromString(t,this.settings);const i=s.readScore();this.renderScore(i,e)}catch(s){this.onError(s)}}loadSoundFont(t,e=!1){return this.uiFacade.loadSoundFont(t,e)}resetSoundFonts(){this._player.resetSoundFonts()}render(t){this.uiFacade.canRender?(this._renderer.width=this.container.width,this._renderer.renderScore(this.score,this._trackIndexes,t)):this.uiFacade.canRenderChanged.on(()=>this.render(t))}get customCursorHandler(){return this._customCursorHandler}set customCursorHandler(t){if(this._customCursorHandler===t)return;const e=this._customCursorHandler??this._defaultCursorHandler;if(this._customCursorHandler=t,this._cursorWrapper){const s=new Zn(this._cursorWrapper,this._barCursor,this._beatCursor,this._selectionWrapper);e==null||e.onDetach(s),t?t==null||t.onDetach(s):this._defaultCursorHandler&&this._defaultCursorHandler.onAttach(s)}}get tickCache(){return this._tickCache}get boundsLookup(){return this._renderer.boundsLookup}get player(){return this._player.instance?this._player:null}get isReadyForPlayback(){return this._player.isReadyForPlayback}get playerState(){return this._player.state}get masterVolume(){return this._player.masterVolume}set masterVolume(t){this._player.masterVolume=t}get metronomeVolume(){return this._player.metronomeVolume}set metronomeVolume(t){this._player.metronomeVolume=t}get countInVolume(){return this._player.countInVolume}set countInVolume(t){this._player.countInVolume=t}get midiEventsPlayedFilter(){return this._player.midiEventsPlayedFilter}set midiEventsPlayedFilter(t){this._player.midiEventsPlayedFilter=t}get tickPosition(){return this._player.tickPosition}set tickPosition(t){this._player.tickPosition=t}get timePosition(){return this._player.timePosition}set timePosition(t){this._player.timePosition=t}get endTick(){return this._player.currentPosition.endTick}get endTime(){return this._player.currentPosition.endTime}get playbackRange(){return this._player.playbackRange}set playbackRange(t){this._player.playbackRange=t,this._tickCache&&(this._tickCache.playbackRange=t),this._updateSelectionCursor(t)}get playbackSpeed(){return this._player.playbackSpeed}set playbackSpeed(t){this._player.playbackSpeed=t}get isLooping(){return this._player.isLooping}set isLooping(t){this._player.isLooping=t}_destroyPlayer(){this._player.destroy(),this._previousTick=0,this._destroyCursors()}_setupOrDestroyPlayer(){var s;let t=this.settings.player.playerMode;if(t===fs.EnabledAutomatic){const i=this.score;if(!i)return!1;(s=i==null?void 0:i.backingTrack)!=null&&s.rawAudioFile?t=fs.EnabledBackingTrack:t=fs.EnabledSynthesizer}let e=null;if(t!==this._actualPlayerMode)switch(this._destroyPlayer(),this._updateCursors(),t){case fs.Disabled:e=null;break;case fs.EnabledSynthesizer:e=this.uiFacade.createWorkerPlayer();break;case fs.EnabledBackingTrack:e=this.uiFacade.createBackingTrackPlayer();break;case fs.EnabledExternalMedia:e=new ku(this.settings.player.bufferTimeInMilliseconds);break}else return this._updateCursors(),!1;return this._actualPlayerMode=t,e&&(this._player.instance=e),!1}loadMidiForScore(){if(!this.score)return;const t=this.score;L.debug("AlphaTab","Generating Midi");const e=new xi,s=new si(e),i=new Bi(t,this.settings,s),r=A.computeFirstDisplayedBarIndex(t,this.settings),a=A.computeLastDisplayedBarIndex(t,this.settings,r);i.tickLookup.multiBarRestInfo=A.buildMultiBarRestInfo(this.tracks,r,a),i.applyTranspositionPitches=!1,i.generate(),this._tickCache=i.tickLookup,this._tickCache.playbackRange=this.playbackRange,this._onMidiLoad(e);const l=this._player;l.midiTickShift=s.tickShift,l.loadMidiFile(e),l.loadBackingTrack(t),l.updateSyncPoints(i.syncPoints),l.applyTranspositionPitches(i.transpositionPitches)}updateSyncPoints(){if(!this.score)return;const t=this.score;this._player.updateSyncPoints(Bi.generateSyncPoints(t))}changeTrackVolume(t,e){for(const s of t)this._player.setChannelVolume(s.playbackInfo.primaryChannel,e),this._player.setChannelVolume(s.playbackInfo.secondaryChannel,e)}changeTrackSolo(t,e){for(const s of t)this._player.setChannelSolo(s.playbackInfo.primaryChannel,e),this._player.setChannelSolo(s.playbackInfo.secondaryChannel,e)}changeTrackMute(t,e){for(const s of t)this._player.setChannelMute(s.playbackInfo.primaryChannel,e),this._player.setChannelMute(s.playbackInfo.secondaryChannel,e)}changeTrackTranspositionPitch(t,e){for(const s of t)this._player.setChannelTranspositionPitch(s.playbackInfo.primaryChannel,e),this._player.setChannelTranspositionPitch(s.playbackInfo.secondaryChannel,e)}play(){return this._player.play()}pause(){this._player.pause()}playPause(){this._player.playPause()}stop(){this._player.stop()}playBeat(t){const e=new xi,s=new si(e);new Bi(t.voice.bar.staff.track.score,this.settings,s).generateSingleBeat(t),this._player.playOneTimeMidiFile(e)}playNote(t){const e=new xi,s=new si(e);new Bi(t.beat.voice.bar.staff.track.score,this.settings,s).generateSingleNote(t),this._player.playOneTimeMidiFile(e)}_destroyCursors(){if(!this._cursorWrapper)return;const t=this.customCursorHandler??this._defaultCursorHandler;t==null||t.onDetach(new Zn(this._cursorWrapper,this._barCursor,this._beatCursor,this._selectionWrapper)),this.uiFacade.destroyCursors(),this._cursorWrapper=null,this._barCursor=null,this._beatCursor=null,this._selectionWrapper=null}_createCursors(){if(this._cursorWrapper)return;const t=this.uiFacade.createCursors();if(t){this._cursorWrapper=t.cursorWrapper,this._barCursor=t.barCursor,this._beatCursor=t.beatCursor,this._selectionWrapper=t.selectionWrapper;const e=this.customCursorHandler??this._defaultCursorHandler;e==null||e.onAttach(t),this._isInitialBeatCursorUpdate=!0}this._currentBeat!==null&&this._cursorUpdateBeat(this._currentBeat,!1,this._previousTick>10,1,!0)}_updateCursors(){this._updateCursorHandler(),this._updateScrollHandler();const t=this._hasCursor;t?this._createCursors():!t&&this._cursorWrapper&&this._destroyCursors()}_updateCursorHandler(){const t=this._defaultCursorHandler,e=this.settings.player.enableAnimatedBeatCursor;t!==void 0&&this._cursorHandlerMode===e||(e?this._defaultCursorHandler=new hu:this._defaultCursorHandler=new cu)}_updateScrollHandler(){const t=this._defaultScrollHandler,e=this.settings.player.scrollMode,s=fe.getLayoutEngineFactory(this.settings.display.layoutMode).vertical;if(!(this._scrollHandlerMode===e&&this._scrollHandlerVertical===s)){if(t){t[Symbol.dispose]();const i=this.uiFacade.getScrollContainer();this.uiFacade.stopScrolling(i)}switch(e){case hi.Off:this._defaultScrollHandler=void 0;break;case hi.Continuous:s?this._defaultScrollHandler=new uu(this):this._defaultScrollHandler=new gu(this);break;case hi.OffScreen:s?this._defaultScrollHandler=new fu(this):this._defaultScrollHandler=new mu(this);break;case hi.Smooth:s?this._defaultScrollHandler=new pu(this):this._defaultScrollHandler=new yu(this);break}}}_cursorUpdateTick(t,e,s,i=!1,r=!1){this._previousTick=t;const a=this._tickCache;if(a){const l=a.findBeatWithChecker(this._beatVisibilityChecker,t,this._currentBeat);l&&this._cursorUpdateBeat(l,e,i,s,r||this.playerState===Ut.Paused)}}_cursorUpdateBeat(t,e,s,i,r=!1){const a=t.beat;if(!a)return;const l=this._renderer.boundsLookup;if(!l)return;const h=this._currentBeat,c=this._previousCursorCache,d=this._previousStateForCursor;if(!r&&a===(h==null?void 0:h.beat)&&l===c&&d===this._player.state&&(h==null?void 0:h.start)===t.start)return;const u=l.findBeat(a);u&&(this._currentBeat=t,this._previousCursorCache=l,this._previousStateForCursor=this._player.state,this.uiFacade.beginInvoke(()=>{this._internalCursorUpdateBeat(t,e,l,u,s,i)}))}scrollToCursor(){const t=this._currentBeatBounds;if(t){const e=this.customScrollHandler??this._defaultScrollHandler;e&&e.forceScrollTo(t)}}_internalCursorUpdateBeat(t,e,s,i,r,a){var x;const l=t.beat,h=(x=t.nextBeat)==null?void 0:x.beat;let c=t.duration;const d=t.beatLookup.highlightedBeats,u=t.cursorMode,p=this.customCursorHandler??this._defaultCursorHandler,g=this._beatCursor,m=this._barCursor,y=i.barBounds.masterBarBounds,S=y.visualBounds,k=this._currentBeatBounds;this._currentBeatBounds=i,m&&p.placeBarCursor(m,i);const T=this._player.state===Ut.Playing&&!e;let N=i.realBounds.x+i.realBounds.w,F=null;h&&u===Ts.ToNextBext&&(F=s.findBeat(h),F&&F.barBounds.masterBarBounds.staffSystemBounds===y.staffSystemBounds&&(N=F.onNotesX));let q=i.onNotesX;if(g){const j=N-i.onNotesX,Q=this._previousTick-this._currentBeat.start,Te=this._currentBeat.tickDuration>0?Q/this._currentBeat.tickDuration:0;q=i.onNotesX+j*Te,c-=c*Te,c=c/a,T?((!k||this._isInitialBeatCursorUpdate||S.y!==k.barBounds.masterBarBounds.visualBounds.y||q<k.onNotesX||y.index>k.barBounds.masterBarBounds.index+1)&&p.placeBeatCursor(g,i,q),this.uiFacade.beginInvoke(()=>{p.transitionBeatCursor(g,i,q,N,c,u)})):(c=0,p.placeBeatCursor(g,i,q)),this._isInitialBeatCursorUpdate=!1}else this._isInitialBeatCursorUpdate=!0;this.uiFacade.removeHighlights();let U=!1;if(T){if(this.settings.player.enableElementHighlighting)for(const j of d){const Q=Pi.getGroupId(j.beat);this.uiFacade.highlightElements(Q,l.voice.bar.index)}r=!e,U=!0}if(r&&!this._isBeatMouseDown&&this.settings.player.scrollMode!==hi.Off){const j=this.customScrollHandler??this._defaultScrollHandler;j&&j.onBeatCursorUpdating(i,F===null?void 0:F,u,q,N,c)}U&&(this._onPlayedBeatChanged(l),this._onActiveBeatsChanged(new yl(d.map(j=>j.beat))))}_onPlayedBeatChanged(t){this._isDestroyed||(this.playedBeatChanged.trigger(t),this.uiFacade.triggerEvent(this.container,"playedBeatChanged",t))}_onActiveBeatsChanged(t){this._isDestroyed||(this.activeBeatsChanged.trigger(t),this.uiFacade.triggerEvent(this.container,"activeBeatsChanged",t))}get _hasCursor(){return this.settings.player.playerMode!==fs.Disabled&&this.settings.player.enableCursor}_onBeatMouseDown(t,e){this._isDestroyed||(this._hasCursor&&this.settings.player.enableUserInteraction&&(this._selectionStart={beat:e},this._selectionEnd=void 0),this._isBeatMouseDown=!0,this.beatMouseDown.trigger(e),this.uiFacade.triggerEvent(this.container,"beatMouseDown",e,t))}_onNoteMouseDown(t,e){this._isDestroyed||(this._isNoteMouseDown=!0,this.noteMouseDown.trigger(e),this.uiFacade.triggerEvent(this.container,"noteMouseDown",e,t))}_onBeatMouseMove(t,e){this._isDestroyed||(this.settings.player.enableUserInteraction&&(!this._selectionEnd||this._selectionEnd.beat!==e)&&(this._selectionEnd={beat:e},this._cursorSelectRange(this._selectionStart,this._selectionEnd)),this.beatMouseMove.trigger(e),this.uiFacade.triggerEvent(this.container,"beatMouseMove",e,t))}_onNoteMouseMove(t,e){this._isDestroyed||(this.noteMouseMove.trigger(e),this.uiFacade.triggerEvent(this.container,"noteMouseMove",e,t))}_onBeatMouseUp(t,e){this._isDestroyed||(this._hasCursor&&this.settings.player.enableUserInteraction&&this.applyPlaybackRangeFromHighlight(),this.beatMouseUp.trigger(e),this.uiFacade.triggerEvent(this.container,"beatMouseUp",e,t),this._isBeatMouseDown=!1)}_onNoteMouseUp(t,e){this._isDestroyed||(this.noteMouseUp.trigger(e),this.uiFacade.triggerEvent(this.container,"noteMouseUp",e,t),this._isNoteMouseDown=!1)}_updateSelectionCursor(t){if(this._tickCache)if(t){const e=this._tickCache.findBeat(this._trackIndexLookup,t.startTick),s=this._tickCache.findBeat(this._trackIndexLookup,t.endTick);if(e&&s){const i={beat:e.beat},r={beat:s.beat};this._cursorSelectRange(i,r)}}else this._cursorSelectRange(void 0,void 0)}_setupClickHandling(){this.canvasElement.mouseDown.on(t=>{var r,a;if(!t.isLeftMouseButton)return;this.settings.player.enableUserInteraction&&t.preventDefault();const e=t.getX(this.canvasElement),s=t.getY(this.canvasElement),i=((r=this._renderer.boundsLookup)==null?void 0:r.getBeatAtPos(e,s))??null;if(i&&(this._onBeatMouseDown(t,i),this.settings.core.includeNoteBounds)){const l=(a=this._renderer.boundsLookup)==null?void 0:a.getNoteAtPos(i,e,s);l&&this._onNoteMouseDown(t,l)}}),this.canvasElement.mouseMove.on(t=>{var r,a;if(!this._isBeatMouseDown)return;const e=t.getX(this.canvasElement),s=t.getY(this.canvasElement),i=((r=this._renderer.boundsLookup)==null?void 0:r.getBeatAtPos(e,s))??null;if(i&&(this._onBeatMouseMove(t,i),this._isNoteMouseDown)){const l=(a=this._renderer.boundsLookup)==null?void 0:a.getNoteAtPos(i,e,s);l&&this._onNoteMouseMove(t,l)}}),this.canvasElement.mouseUp.on(t=>{var r,a;if(!this._isBeatMouseDown)return;this.settings.player.enableUserInteraction&&t.preventDefault();const e=t.getX(this.canvasElement),s=t.getY(this.canvasElement),i=((r=this._renderer.boundsLookup)==null?void 0:r.getBeatAtPos(e,s))??null;if(this._onBeatMouseUp(t,i),this._isNoteMouseDown)if(i){const l=((a=this._renderer.boundsLookup)==null?void 0:a.getNoteAtPos(i,e,s))??null;this._onNoteMouseUp(t,l)}else this._onNoteMouseUp(t,null)}),this._renderer.postRenderFinished.on(()=>{!this._selectionStart||!this._hasCursor||!this.settings.player.enableUserInteraction||this._cursorSelectRange(this._selectionStart,this._selectionEnd)})}highlightPlaybackRange(t,e){this._selectionStart={beat:t},this._selectionEnd={beat:e},this._cursorSelectRange(this._selectionStart,this._selectionEnd)}applyPlaybackRangeFromHighlight(){var t,e;if(this._selectionEnd){const s=((t=this._tickCache)==null?void 0:t.getBeatStart(this._selectionStart.beat))??this._selectionStart.beat.absolutePlaybackStart;if((((e=this._tickCache)==null?void 0:e.getBeatStart(this._selectionEnd.beat))??this._selectionEnd.beat.absolutePlaybackStart)<s){const r=this._selectionStart;this._selectionStart=this._selectionEnd,this._selectionEnd=r}}if(this._selectionStart&&this._tickCache){const s=this._tickCache,i=s.getMasterBarStart(this._selectionStart.beat.voice.bar.masterBar);if(this._currentBeat=null,this._player.state===Ut.Paused&&this._cursorUpdateTick(this._tickCache.getBeatStart(this._selectionStart.beat),!1,1),this.tickPosition=i+this._selectionStart.beat.playbackStart,this._selectionEnd&&this._selectionStart.beat!==this._selectionEnd.beat){const r=s.getMasterBarStart(this._selectionEnd.beat.voice.bar.masterBar),a=new Kn;a.startTick=i+this._selectionStart.beat.playbackStart,a.endTick=r+this._selectionEnd.beat.playbackStart+this._selectionEnd.beat.playbackDuration-50,this.playbackRange=a}else this._selectionStart=void 0,this.playbackRange=null,this._cursorSelectRange(this._selectionStart,this._selectionEnd)}}clearPlaybackRangeHighlight(){this._cursorSelectRange(void 0,void 0)}_cursorSelectRange(t,e){var d,u;const s=this._renderer.boundsLookup;if(!s){this.playbackRangeHighlightChanged.trigger({});return}const i=this._selectionWrapper;if(!i){this.playbackRangeHighlightChanged.trigger({});return}if(i.clear(),!t||!e||t.beat===e.beat){this.playbackRangeHighlightChanged.trigger({});return}t.bounds||(t.bounds=s.findBeat(t.beat)??void 0),e.bounds||(e.bounds=s.findBeat(e.beat)??void 0);const r=((d=this._tickCache)==null?void 0:d.getBeatStart(t.beat))??t.beat.absolutePlaybackStart;if((((u=this._tickCache)==null?void 0:u.getBeatStart(e.beat))??e.beat.absolutePlaybackStart)<r){const p=t;t=e,e=p}const l={startBeat:t.beat,startBeatBounds:t.bounds,endBeat:e.beat,endBeatBounds:e.bounds,highlightBlocks:[]};let h=t.bounds.realBounds.x;t.beat.index===0&&(h=t.bounds.barBounds.masterBarBounds.realBounds.x);let c=e.bounds.realBounds.x+e.bounds.realBounds.w;if(e.beat.index===e.beat.voice.beats.length-1&&(c=e.bounds.barBounds.masterBarBounds.realBounds.x+e.bounds.barBounds.masterBarBounds.realBounds.w),t.bounds.barBounds.masterBarBounds.staffSystemBounds!==e.bounds.barBounds.masterBarBounds.staffSystemBounds){const p=t.bounds.barBounds.masterBarBounds.staffSystemBounds.visualBounds.x,g=t.bounds.barBounds.masterBarBounds.staffSystemBounds.visualBounds.x+t.bounds.barBounds.masterBarBounds.staffSystemBounds.visualBounds.w,m=this.uiFacade.createSelectionElement(),y=new Pt(h,t.bounds.barBounds.masterBarBounds.visualBounds.y,g-h,t.bounds.barBounds.masterBarBounds.visualBounds.h);m.setBounds(y.x,y.y,y.w,y.h),l.highlightBlocks.push(y),i.appendChild(m);const S=t.bounds.barBounds.masterBarBounds.staffSystemBounds.index+1,k=e.bounds.barBounds.masterBarBounds.staffSystemBounds.index;for(let F=S;F<k;F++){const q=s.staffSystems[F],U=this.uiFacade.createSelectionElement(),x=new Pt(p,q.visualBounds.y,g-p,q.visualBounds.h);l.highlightBlocks.push(x),U.setBounds(x.x,x.y,x.w,x.h),i.appendChild(U)}const T=this.uiFacade.createSelectionElement(),N=new Pt(p,e.bounds.barBounds.masterBarBounds.visualBounds.y,c-p,e.bounds.barBounds.masterBarBounds.visualBounds.h);l.highlightBlocks.push(N),T.setBounds(N.x,N.y,N.w,N.h),i.appendChild(T)}else{const p=this.uiFacade.createSelectionElement(),g=new Pt(h,t.bounds.barBounds.masterBarBounds.visualBounds.y,c-h,t.bounds.barBounds.masterBarBounds.visualBounds.h);p.setBounds(g.x,g.y,g.w,g.h),l.highlightBlocks.push(g),i.appendChild(p)}this.playbackRangeHighlightChanged.trigger(l)}_onScoreLoaded(t){this._isDestroyed||(this.scoreLoaded.trigger(t),this.uiFacade.triggerEvent(this.container,"scoreLoaded",t),this._setupOrDestroyPlayer()||this.loadMidiForScore())}_onResize(t){this._isDestroyed||(this.resize.trigger(t),this.uiFacade.triggerEvent(this.container,"resize",t))}_onRenderStarted(t){this._isDestroyed||(this.renderStarted.trigger(t),this.uiFacade.triggerEvent(this.container,"renderStarted",t))}_onRenderFinished(t){this._isDestroyed||(this.renderFinished.trigger(t),this.uiFacade.triggerEvent(this.container,"renderFinished",t))}_onPostRenderFinished(){this._isDestroyed||(this._beatVisibilityChecker.bounds=this.boundsLookup,this._currentBeat=null,this._cursorUpdateTick(this._previousTick,!1,1,!0,!0),this.postRenderFinished.trigger(),this.uiFacade.triggerEvent(this.container,"postRenderFinished",null))}onError(t){this._isDestroyed||(L.error("API","An unexpected error occurred",t),this.error.trigger(t),this.uiFacade.triggerEvent(this.container,"error",t))}get playerReady(){return this._player.readyForPlayback}_onPlayerReady(){this._isDestroyed||this.uiFacade.triggerEvent(this.container,"playerReady",null)}get playerFinished(){return this._player.finished}_onPlayerFinished(){this._isDestroyed||this.uiFacade.triggerEvent(this.container,"playerFinished",null)}get soundFontLoaded(){return this._player.soundFontLoaded}_onSoundFontLoaded(){this._isDestroyed||this.uiFacade.triggerEvent(this.container,"soundFontLoaded",null)}_onMidiLoad(t){this._isDestroyed||(this.midiLoad.trigger(t),this.uiFacade.triggerEvent(this.container,"midiLoad",t))}_onMidiLoaded(t){this._isDestroyed||(this.midiLoaded.trigger(t),this.uiFacade.triggerEvent(this.container,"midiFileLoaded",t))}get playerStateChanged(){return this._player.stateChanged}_onPlayerStateChanged(t){if(!this._isDestroyed){if(!t.stopped&&t.state===Ut.Paused){const e=this._currentBeat,s=this._tickCache;e&&s&&(this._player.tickPosition=s.getBeatStart(e.beat),this.scrollToCursor())}this.uiFacade.triggerEvent(this.container,"playerStateChanged",t)}}get playerPositionChanged(){return this._player.positionChanged}_onPlayerPositionChanged(t){if(this._isDestroyed)return;const e=t.currentTick;this._previousTick=e,this.uiFacade.beginInvoke(()=>{const s=t.modifiedTempo/t.originalTempo;this._cursorUpdateTick(e,!1,s,!1,t.isSeek)}),this.uiFacade.triggerEvent(this.container,"playerPositionChanged",t)}get midiEventsPlayed(){return this._player.midiEventsPlayed}_onMidiEventsPlayed(t){this._isDestroyed||this.uiFacade.triggerEvent(this.container,"midiEventsPlayed",t)}get playbackRangeChanged(){return this._player.playbackRangeChanged}_onPlaybackRangeChanged(t){this._isDestroyed||this.uiFacade.triggerEvent(this.container,"playbackRangeChanged",t)}_onSettingsUpdated(){this._isDestroyed||(this.settingsUpdated.trigger(),this.uiFacade.triggerEvent(this.container,"settingsUpdated",null))}async enumerateOutputDevices(){return await this._player.output.enumerateOutputDevices()}async setOutputDevice(t){await this._player.output.setOutputDevice(t)}async getOutputDevice(){return await this._player.output.getOutputDevice()}async exportAudio(t){if(!this.score)throw new Xe(ze.General,"No song loaded");let e;switch(this._actualPlayerMode){case fs.EnabledSynthesizer:e=this.uiFacade.createWorkerAudioExporter(this._player.instance);break;default:e=this.uiFacade.createWorkerAudioExporter(null);break}const s=this.score,i=new xi,r=new si(i),a=new Bi(s,this.settings,r);a.applyTranspositionPitches=!1,a.generate();const l=new xc;l.soundFonts=t.soundFonts,l.sampleRate=t.sampleRate,l.useSyncPoints=t.useSyncPoints,l.masterVolume=t.masterVolume,l.metronomeVolume=t.metronomeVolume,l.playbackRange=t.playbackRange;for(const[h,c]of t.trackVolume)if(h<this.score.tracks.length){const d=this.score.tracks[h];l.trackVolume.set(d.playbackInfo.primaryChannel,c),l.trackVolume.set(d.playbackInfo.secondaryChannel,c)}for(const[h,c]of t.trackTranspositionPitches)if(h<this.score.tracks.length){const d=this.score.tracks[h];l.trackTranspositionPitches.set(d.playbackInfo.primaryChannel,c),l.trackTranspositionPitches.set(d.playbackInfo.secondaryChannel,c)}return await e.initialize(l,i,a.syncPoints,a.transpositionPitches),e}}class pr extends Xe{constructor(e,s){super(ze.General,e);o(this,"xhr");this.xhr=s}}class xr{static loadAlphaTex(t,e){const s=new bo;return s.logErrors=!0,s.initFromString(t,e??new vi),s.readScore()}static loadScoreAsync(t,e,s,i){const r=new XMLHttpRequest;r.open("GET",t,!0,null,null),r.responseType="arraybuffer",r.onreadystatechange=()=>{if(r.readyState===XMLHttpRequest.DONE){const a=r.response;if(r.status===200||r.status===0&&a)try{const l=r.response,h=new Uint8Array(l),c=xr.loadScoreFromBytes(h,i);e(c)}catch(l){s(l)}else r.status===0?s(new pr(`You are offline!!
 Please Check Your Network.`,r)):r.status===404?s(new pr("Requested URL not found.",r)):r.status===500?s(new pr("Internel Server Error.",r)):r.statusText==="parsererror"?s(new pr(`Error.
Parsing JSON Request failed.`,r)):r.statusText==="timeout"?s(new pr("Request Time out.",r)):s(new pr(`Unknow Error: ${r.responseText}`,r))}},r.send()}static loadScoreFromBytes(t,e){e||(e=new vi);const s=fe.buildImporters();L.debug("ScoreLoader",`Loading score from ${t.length} bytes using ${s.length} importers`);let i=null;const r=wt.fromBuffer(t);for(const a of s){r.reset();try{L.debug("ScoreLoader",`Importing using importer ${a.name}`),a.init(r,e),i=a.readScore(),L.debug("ScoreLoader",`Score imported using ${a.name}`);break}catch(l){if(l instanceof Mt)L.debug("ScoreLoader",`${a.name} does not support the file`);else throw L.error("ScoreLoader","Score import failed due to unexpected error: ",l),l}}if(i)return i;throw new Mt("No compatible importer found for file")}}class Ao{constructor(t){o(this,"mouseEvent");this.mouseEvent=t}get isLeftMouseButton(){return this.mouseEvent.button===0}getX(t){const e=t.element,i=e.getBoundingClientRect().left+e.ownerDocument.defaultView.pageXOffset;return this.mouseEvent.pageX-i}getY(t){const e=t.element,i=e.getBoundingClientRect().top+e.ownerDocument.defaultView.pageYOffset;return this.mouseEvent.pageY-i}preventDefault(){this.mouseEvent.preventDefault()}}const Ra=class Ra{constructor(t){o(this,"_resizeListeners",0);o(this,"element");o(this,"lastBounds",new Pt);o(this,"resize");o(this,"mouseDown");o(this,"mouseMove");o(this,"mouseUp");this.element=t,this.mouseDown={on:s=>{const i=r=>{s(new Ao(r))};return this.element.addEventListener("mousedown",i,!0),()=>{this.element.removeEventListener("mousedown",i,!0)}},off:s=>{}},this.mouseUp={on:s=>{const i=r=>{s(new Ao(r))};return this.element.addEventListener("mouseup",i,!0),()=>{this.element.removeEventListener("mouseup",i,!0)}},off:s=>{}},this.mouseMove={on:s=>{const i=r=>{s(new Ao(r))};return this.element.addEventListener("mousemove",i,!0),()=>{this.element.removeEventListener("mousemove",i,!0)}},off:s=>{}};const e=this;this.resize={on:function(s){return e._resizeListeners===0&&Ra._resizeObserver.value.observe(e.element),e.element.addEventListener("resize",s,!0),e._resizeListeners++,()=>this.off(s)},off:s=>{this.element.removeEventListener("resize",s,!0),this._resizeListeners--,this._resizeListeners<=0&&(this._resizeListeners=0,Ra._resizeObserver.value.unobserve(this.element))}}}get width(){return this.element.offsetWidth}set width(t){this.element.style.width=`${t}px`}get scrollLeft(){return this.element.scrollLeft}set scrollLeft(t){this.element.scrollLeft=t}get scrollTop(){return this.element.scrollTop}set scrollTop(t){this.element.scrollTop=t}get height(){return this.element.offsetHeight}set height(t){t>=0?this.element.style.height=`${t}px`:this.element.style.height="100%"}get isVisible(){return!!this.element.offsetWidth||!!this.element.offsetHeight||!!this.element.getClientRects().length}stopAnimation(){this.element.style.transition="none"}transitionToX(t,e){this.element.style.transition=`transform ${t}ms linear`,this.setBounds(e,Number.NaN,Number.NaN,Number.NaN)}setBounds(t,e,s,i){Number.isNaN(t)&&(t=this.lastBounds.x),Number.isNaN(e)&&(e=this.lastBounds.y),Number.isNaN(s)&&(s=this.lastBounds.w),Number.isNaN(i)&&(i=this.lastBounds.h),this.element.style.transform=`translate(${t}px, ${e}px) scale(${s}, ${i})`,this.element.style.transformOrigin="top left",this.lastBounds.x=t,this.lastBounds.y=e,this.lastBounds.w=s,this.lastBounds.h=i}appendChild(t){this.element.appendChild(t.element)}clear(){this.element.innerText=""}};o(Ra,"_resizeObserver",new Kr(()=>new ResizeObserver(t=>{for(const e of t){const s=new CustomEvent("resize",{detail:e});e.target.dispatchEvent(s)}})));let sr=Ra;class Uh{constructor(t){o(this,"_originalFamilies");o(this,"_families");o(this,"_isStarted",!1);o(this,"isFontLoaded",!1);o(this,"fontLoaded",new xe);this._originalFamilies=t,this._families=t}checkForFontAvailability(){if(fe.isRunningInWorker){this.isFontLoaded=!1;return}if(this._isStarted)return;this._isStarted=!0;let t=0;const e=window.setInterval(()=>{L.warning("Rendering",`Could not load font '${this._families[0]}' within ${(t+1)*5} seconds`,null),this._families.length>1?(this._families.shift(),t=0):t++},5e3);L.debug("Font",`Start checking for font availablility: ${this._families.join(", ")}`);const s=a=>{this._families.length>1?(L.debug("Font",`[${this._families[0]}] Loading Failed, switching to ${this._families[1]}`,a),this._families.shift(),window.setTimeout(()=>{r()},0)):(L.error("Font",`[${this._originalFamilies.join(",")}] Loading Failed, rendering cannot start`,a),window.clearInterval(e))},i=a=>{L.debug("Font",`[${a}] Font API signaled available`),this.isFontLoaded=!0,window.clearInterval(e),this.fontLoaded.trigger(this._families[0])},r=async()=>{for(const a of this._families)if(await this._isFontAvailable(a,!1)){i(a);return}try{await document.fonts.load(`1em ${this._families[0]}`)}catch(a){s(a)}return L.debug("Font",`[${this._families[0]}] Font API signaled loaded`),await this._isFontAvailable(this._families[0],!0)?i(this._families[0]):s("Font not available"),!0};document.fonts.ready.then(()=>{r()})}_isFontAvailable(t,e){return new Promise(s=>{const i=`1em ${t}`;if(document.fonts.check(i))s(!0);else if(e){L.debug("Font",`Font ${t} not available, creating test element to trigger load`);const r=document.createElement("div");r.style.font=i,r.style.opacity="0",r.style.position="absolute",r.style.top="0",r.style.left="0",r.innerText=`Trigger ${t} load`,document.body.appendChild(r),setTimeout(()=>{document.body.removeChild(r),document.fonts.check(i)?s(!0):s(!1)},200)}else s(!1)})}}class Lc extends Ri{constructor(){super(...arguments);o(this,"_audioNode",null);o(this,"_circularBuffer");o(this,"_bufferCount",0);o(this,"_requestedBufferCount",0);o(this,"_outputBuffer",new Float32Array(0))}open(e){super.open(e),this._bufferCount=Math.floor(e*this.sampleRate/1e3/Ri.BufferSize),this._circularBuffer=new Yl(Ri.BufferSize*this._bufferCount),this.onReady()}play(){super.play();const e=this.context;this._audioNode=e.createScriptProcessor(4096,0,2),this._audioNode.onaudioprocess=this._generateSound.bind(this),this._circularBuffer.clear(),this._requestBuffers(),this.source=e.createBufferSource(),this.source.buffer=this.buffer,this.source.loop=!0,this.source.connect(this._audioNode,0,0),this.source.start(0),this._audioNode.connect(e.destination,0,0)}pause(){super.pause(),this._audioNode&&this._audioNode.disconnect(0),this._audioNode=null}addSamples(e){this._circularBuffer.write(e,0,e.length),this._requestedBufferCount--}resetSamples(){this._circularBuffer.clear()}_requestBuffers(){const e=this._bufferCount/2|0,s=e*Ri.BufferSize;if(this._circularBuffer.count+this._requestedBufferCount*Ri.BufferSize<s){for(let r=0;r<e;r++)this.onSampleRequest();this._requestedBufferCount+=e}}_generateSound(e){const s=e.outputBuffer.getChannelData(0),i=e.outputBuffer.getChannelData(1),r=s.length+i.length;let a=this._outputBuffer;a.length!==r&&(a=new Float32Array(r),this._outputBuffer=a);const l=this._circularBuffer.read(a,0,Math.min(a.length,this._circularBuffer.count));let h=0;const c=Math.min(s.length,l);for(let d=0;d<c;d++)s[d]=a[h++],i[d]=a[h++];if(l<s.length)for(let d=l;d<s.length;d++)s[d]=0,i[d]=0;this.onSamplesPlayed(l/ye.AudioChannels),this._requestBuffers()}}class un{constructor(t,e){o(this,"_synth");o(this,"_output");o(this,"_workerIsReadyForPlayback",!1);o(this,"_workerIsReady",!1);o(this,"_outputIsReady",!1);o(this,"_state",Ut.Paused);o(this,"_masterVolume",0);o(this,"_metronomeVolume",0);o(this,"_countInVolume",0);o(this,"_playbackSpeed",0);o(this,"_isLooping",!1);o(this,"_playbackRange",null);o(this,"_midiEventsPlayedFilter",[]);o(this,"_loadedMidiInfo");o(this,"_currentPosition",new ci(0,0,0,0,!1,120,120));o(this,"ready",new Ct);o(this,"readyForPlayback",new Ct);o(this,"finished",new Ct);o(this,"soundFontLoaded",new Ct);o(this,"soundFontLoadFailed",new xe);o(this,"midiLoaded",new xe);o(this,"midiLoadFailed",new xe);o(this,"stateChanged",new xe);o(this,"positionChanged",new xe);o(this,"midiEventsPlayed",new xe);o(this,"playbackRangeChanged",new xe);this._workerIsReadyForPlayback=!1,this._workerIsReady=!1,this._outputIsReady=!1,this._state=Ut.Paused,this._masterVolume=0,this._metronomeVolume=0,this._playbackSpeed=0,this._isLooping=!1,this._playbackRange=null,this._output=t,this._output.ready.on(this._onOutputReady.bind(this)),this._output.samplesPlayed.on(this.onOutputSamplesPlayed.bind(this)),this._output.sampleRequest.on(this.onOutputSampleRequest.bind(this)),this._output.open(e.player.bufferTimeInMilliseconds);try{this._synth=fe.createWebWorker(e)}catch(s){L.error("AlphaSynth",`Failed to create WebWorker: ${s}`)}this._synth.addEventListener("message",this.handleWorkerMessage.bind(this),!1),this._synth.postMessage({cmd:"alphaSynth.initialize",sampleRate:this._output.sampleRate,logLevel:e.core.logLevel,bufferTimeInMilliseconds:e.player.bufferTimeInMilliseconds}),this.masterVolume=1,this.playbackSpeed=1,this.metronomeVolume=0}get output(){return this._output}get isReady(){return this._workerIsReady&&this._outputIsReady}get isReadyForPlayback(){return this._workerIsReadyForPlayback}get state(){return this._state}get logLevel(){return L.logLevel}get worker(){return this._synth}set logLevel(t){L.logLevel=t,this._synth.postMessage({cmd:"alphaSynth.setLogLevel",value:t})}get masterVolume(){return this._masterVolume}set masterVolume(t){t=Math.max(t,ye.MinVolume),this._masterVolume=t,this._synth.postMessage({cmd:"alphaSynth.setMasterVolume",value:t})}get metronomeVolume(){return this._metronomeVolume}set metronomeVolume(t){t=Math.max(t,ye.MinVolume),this._metronomeVolume=t,this._synth.postMessage({cmd:"alphaSynth.setMetronomeVolume",value:t})}get countInVolume(){return this._countInVolume}set countInVolume(t){t=Math.max(t,ye.MinVolume),this._countInVolume=t,this._synth.postMessage({cmd:"alphaSynth.setCountInVolume",value:t})}get midiEventsPlayedFilter(){return this._midiEventsPlayedFilter}set midiEventsPlayedFilter(t){this._midiEventsPlayedFilter=t,this._synth.postMessage({cmd:"alphaSynth.setMidiEventsPlayedFilter",value:fe.prepareForPostMessage(t)})}get playbackSpeed(){return this._playbackSpeed}set playbackSpeed(t){t=A.clamp(t,ye.MinPlaybackSpeed,ye.MaxPlaybackSpeed),this._playbackSpeed=t,this._synth.postMessage({cmd:"alphaSynth.setPlaybackSpeed",value:t})}get loadedMidiInfo(){return this.loadedMidiInfo}get currentPosition(){return this._currentPosition}get tickPosition(){return this._currentPosition.currentTick}set tickPosition(t){t<0&&(t=0),this._currentPosition=new ci(this._currentPosition.currentTime,this._currentPosition.endTime,t,this._currentPosition.endTick,!0,this._currentPosition.originalTempo,this._currentPosition.modifiedTempo),this._synth.postMessage({cmd:"alphaSynth.setTickPosition",value:t})}get timePosition(){return this._currentPosition.currentTime}set timePosition(t){t<0&&(t=0),this._currentPosition=new ci(t,this._currentPosition.endTime,this._currentPosition.currentTick,this._currentPosition.endTick,!0,this._currentPosition.originalTempo,this._currentPosition.modifiedTempo),this._synth.postMessage({cmd:"alphaSynth.setTimePosition",value:t})}get isLooping(){return this._isLooping}set isLooping(t){this._isLooping=t,this._synth.postMessage({cmd:"alphaSynth.setIsLooping",value:t})}get playbackRange(){return this._playbackRange}set playbackRange(t){t&&(t.startTick<0&&(t.startTick=0),t.endTick<0&&(t.endTick=0)),this._playbackRange=t,this._synth.postMessage({cmd:"alphaSynth.setPlaybackRange",value:fe.prepareForPostMessage(t)})}destroy(){this._synth.postMessage({cmd:"alphaSynth.destroy"})}play(){return this._output.activate(),this._synth.postMessage({cmd:"alphaSynth.play"}),!0}pause(){this._synth.postMessage({cmd:"alphaSynth.pause"})}playPause(){this._output.activate(),this._synth.postMessage({cmd:"alphaSynth.playPause"})}stop(){this._synth.postMessage({cmd:"alphaSynth.stop"})}playOneTimeMidiFile(t){this._synth.postMessage({cmd:"alphaSynth.playOneTimeMidiFile",midi:Lt.midiFileToJsObject(fe.prepareForPostMessage(t))})}loadSoundFont(t,e){this._synth.postMessage({cmd:"alphaSynth.loadSoundFontBytes",data:fe.prepareForPostMessage(t),append:e})}resetSoundFonts(){this._synth.postMessage({cmd:"alphaSynth.resetSoundFonts"})}loadMidiFile(t){this._synth.postMessage({cmd:"alphaSynth.loadMidi",midi:Lt.midiFileToJsObject(fe.prepareForPostMessage(t))})}applyTranspositionPitches(t){this._synth.postMessage({cmd:"alphaSynth.applyTranspositionPitches",transpositionPitches:JSON.stringify(Array.from(fe.prepareForPostMessage(t).entries()))})}setChannelTranspositionPitch(t,e){this._synth.postMessage({cmd:"alphaSynth.setChannelTranspositionPitch",channel:t,semitones:e})}setChannelMute(t,e){this._synth.postMessage({cmd:"alphaSynth.setChannelMute",channel:t,mute:e})}resetChannelStates(){this._synth.postMessage({cmd:"alphaSynth.resetChannelStates"})}setChannelSolo(t,e){this._synth.postMessage({cmd:"alphaSynth.setChannelSolo",channel:t,solo:e})}setChannelVolume(t,e){e=Math.max(e,ye.MinVolume),this._synth.postMessage({cmd:"alphaSynth.setChannelVolume",channel:t,volume:e})}handleWorkerMessage(t){const e=t.data;switch(e.cmd){case"alphaSynth.ready":this._workerIsReady=!0,this._checkReady();break;case"alphaSynth.destroyed":this._synth.terminate();break;case"alphaSynth.readyForPlayback":this._workerIsReadyForPlayback=!0,this._checkReadyForPlayback();break;case"alphaSynth.positionChanged":this._currentPosition=new ci(e.currentTime,e.endTime,e.currentTick,e.endTick,e.isSeek,e.originalTempo,e.modifiedTempo),this.positionChanged.trigger(this._currentPosition);break;case"alphaSynth.midiEventsPlayed":this.midiEventsPlayed.trigger(new oh(e.events.map(Lt.jsObjectToMidiEvent)));break;case"alphaSynth.playerStateChanged":this._state=e.state,this.stateChanged.trigger(new Br(e.state,e.stopped));break;case"alphaSynth.playbackRangeChanged":this._playbackRange=e.playbackRange,this.playbackRangeChanged.trigger(new jr(this._playbackRange));break;case"alphaSynth.finished":this.finished.trigger();break;case"alphaSynth.soundFontLoaded":this.soundFontLoaded.trigger();break;case"alphaSynth.soundFontLoadFailed":this.soundFontLoadFailed.trigger(e.error);break;case"alphaSynth.midiLoaded":this._checkReadyForPlayback(),this._loadedMidiInfo=new ci(e.currentTime,e.endTime,e.currentTick,e.endTick,e.isSeek,e.originalTempo,e.modifiedTempo),this.midiLoaded.trigger(this._loadedMidiInfo);break;case"alphaSynth.midiLoadFailed":this._checkReadyForPlayback(),this.midiLoadFailed.trigger(e.error);break;case"alphaSynth.output.addSamples":this._output.addSamples(e.samples);break;case"alphaSynth.output.play":this._output.play();break;case"alphaSynth.output.pause":this._output.pause();break;case"alphaSynth.output.destroy":this._output.destroy();break;case"alphaSynth.output.resetSamples":this._output.resetSamples();break}}_checkReady(){this.isReady&&this.ready.trigger()}_checkReadyForPlayback(){this.isReadyForPlayback&&this.readyForPlayback.trigger()}onOutputSampleRequest(){this._synth.postMessage({cmd:"alphaSynth.output.sampleRequest"})}onOutputSamplesPlayed(t){this._synth.postMessage({cmd:"alphaSynth.output.samplesPlayed",samples:t})}_onOutputReady(){this._outputIsReady=!0,this._checkReady()}loadBackingTrack(t){}updateSyncPoints(t){}}class Tu{constructor(t,e){o(this,"_api");o(this,"_worker");o(this,"_width",0);o(this,"boundsLookup",null);o(this,"preRender",new xe);o(this,"partialRenderFinished",new xe);o(this,"partialLayoutFinished",new xe);o(this,"renderFinished",new xe);o(this,"postRenderFinished",new Ct);o(this,"error",new xe);this._api=t;try{this._worker=fe.createWebWorker(e)}catch(s){L.error("Rendering",`Failed to create WebWorker: ${s}`);return}this._worker.postMessage({cmd:"alphaTab.initialize",settings:this._serializeSettingsForWorker(e)}),this._worker.addEventListener("message",this._handleWorkerMessage.bind(this))}destroy(){this._worker.terminate()}updateSettings(t){this._worker.postMessage({cmd:"alphaTab.updateSettings",settings:this._serializeSettingsForWorker(t)})}_serializeSettingsForWorker(t){const e=Lt.settingsToJsObject(fe.prepareForPostMessage(t));return e.delete("player"),e}render(t){this._worker.postMessage({cmd:"alphaTab.render",renderHints:t})}resizeRender(){this._worker.postMessage({cmd:"alphaTab.resizeRender"})}renderResult(t){this._worker.postMessage({cmd:"alphaTab.renderResult",resultId:t})}get width(){return this._width}set width(t){this._width=t,this._worker.postMessage({cmd:"alphaTab.setWidth",width:t})}_handleWorkerMessage(t){const e=t.data;switch(e.cmd){case"alphaTab.preRender":this.preRender.trigger(e.resize);break;case"alphaTab.partialRenderFinished":this.partialRenderFinished.trigger(e.result);break;case"alphaTab.partialLayoutFinished":this.partialLayoutFinished.trigger(e.result);break;case"alphaTab.renderFinished":this.renderFinished.trigger(e.result);break;case"alphaTab.postRenderFinished":this.boundsLookup=ws.fromJson(e.boundsLookup,this._api.score),this.boundsLookup.finish(),this.postRenderFinished.trigger();break;case"alphaTab.error":this.error.trigger(e.error);break}}renderScore(t,e,s){const i=t==null?null:Lt.scoreToJsObject(fe.prepareForPostMessage(t));this._worker.postMessage({cmd:"alphaTab.renderScore",score:i,trackIndexes:fe.prepareForPostMessage(e),fontSizes:Lr.fontSizeLookupTables,renderHints:s})}}class xu extends sr{constructor(e,s,i){super(e);o(this,"_xscale");o(this,"_yscale");o(this,"centerAtPosition",!1);this._xscale=s,this._yscale=i}get width(){return this.element.offsetWidth/this._xscale}set width(e){this.element.style.width=`${e*this._xscale}px`}get height(){return this.element.offsetHeight/this._yscale}set height(e){e>=0?this.element.style.height=`${e*this._yscale}px`:this.element.style.height="100%"}setBounds(e,s,i,r){Number.isNaN(e)&&(e=this.lastBounds.x),Number.isNaN(s)&&(s=this.lastBounds.y),Number.isNaN(i)?i=this.lastBounds.w:i=i/this._xscale,Number.isNaN(r)?r=this.lastBounds.h:r=r/this._yscale;let a=`translate(${e}px, ${s}px) scale(${i}, ${r})`;this.centerAtPosition&&(a+=" translateX(-50%)"),this.element.style.transform=a,this.element.style.transformOrigin="top left",this.lastBounds.x=e,this.lastBounds.y=s,this.lastBounds.w=i,this.lastBounds.h=r}}class Nu{constructor(){o(this,"sampleRate",44100);o(this,"audioElement");o(this,"_updateInterval",0);o(this,"ready",new Ct);o(this,"samplesPlayed",new xe);o(this,"timeUpdate",new xe);o(this,"sampleRequest",new Ct)}get backingTrackDuration(){const t=this.audioElement.duration??0;return Number.isFinite(t)?t*1e3:0}get playbackRate(){return this.audioElement.playbackRate}set playbackRate(t){this.audioElement.playbackRate=t}get masterVolume(){return this.audioElement.volume}set masterVolume(t){this.audioElement.volume=t}seekTo(t){this.audioElement.currentTime=t/1e3}loadBackingTrack(t){var i;(i=this.audioElement)!=null&&i.src&&URL.revokeObjectURL(this.audioElement.src);const e=new Blob([t.rawAudioFile]),s=this.audioElement.playbackRate;this.audioElement.src=URL.createObjectURL(e),this.audioElement.playbackRate=s}open(t){const e=document.createElement("audio");e.style.display="none",document.body.appendChild(e),e.addEventListener("seeked",()=>{this._updatePosition()}),e.addEventListener("timeupdate",()=>{this._updatePosition()}),this.audioElement=e,this.ready.trigger()}_updatePosition(){const t=this.audioElement.currentTime*1e3;this.timeUpdate.trigger(t)}play(){this.audioElement.play(),this._updateInterval=window.setInterval(()=>{this._updatePosition()},50)}destroy(){const t=this.audioElement;t&&document.body.removeChild(t)}pause(){this.audioElement.pause(),window.clearInterval(this._updateInterval)}addSamples(t){}resetSamples(){}activate(){}async enumerateOutputDevices(){return $s.enumerateOutputDevices()}async setOutputDevice(t){await $s.checkSinkIdSupport()&&(t?await this.audioElement.setSinkId(t.deviceId):await this.audioElement.setSinkId(""))}async getOutputDevice(){if(!await $s.checkSinkIdSupport())return null;const t=this.audioElement.sinkId;if(typeof t!="string"||t===""||t==="default")return null;let e=$s.findKnownDevice(t);if(e)return e;const s=await this.enumerateOutputDevices();return e=s.find(i=>i.deviceId===t),e||(L.warning("WebAudio","Could not find output device in device list",t,s),null)}}const go=class go{constructor(t,e){o(this,"_worker");o(this,"_unsubscribe");o(this,"_exporterId");o(this,"_ownsWorker");o(this,"_promise",null);this._exporterId=go._nextExporterId++,this._worker=t,this._ownsWorker=e}async initialize(t,e,s,i){const r=this.handleWorkerMessage.bind(this);this._worker.worker.addEventListener("message",r,!1),this._unsubscribe=()=>{this._worker.worker.removeEventListener("message",r,!1)},this._promise=Promise.withResolvers(),this._worker.worker.postMessage({cmd:"alphaSynth.exporter.initialize",exporterId:this._exporterId,options:fe.prepareForPostMessage(t),midi:Lt.midiFileToJsObject(fe.prepareForPostMessage(e)),syncPoints:fe.prepareForPostMessage(s),transpositionPitches:fe.prepareForPostMessage(i)}),await this._promise.promise}handleWorkerMessage(t){var i,r,a,l;const e=t.data;if(e.exporterId!==this._exporterId)return;switch(e.cmd){case"alphaSynth.exporter.initialized":(i=this._promise)==null||i.resolve(null),this._promise=null;break;case"alphaSynth.exporter.error":(r=this._promise)==null||r.reject(e.error),this._promise=null;break;case"alphaSynth.exporter.rendered":(a=this._promise)==null||a.resolve(e.chunk),this._promise=null;break;case"alphaSynth.destroyed":(l=this._promise)==null||l.reject(new Xe(ze.General,"Worker was destroyed")),this._promise=null;break}}async render(t){if(this._promise)throw new Xe(ze.General,"There is already an ongoing operation, wait for initialize to complete before requesting render");return this._promise=Promise.withResolvers(),this._worker.worker.postMessage({cmd:"alphaSynth.exporter.render",exporterId:this._exporterId,milliseconds:t}),await this._promise.promise}destroy(){this._worker.worker.postMessage({cmd:"alphaSynth.exporter.destroy",exporterId:this._exporterId}),this._unsubscribe(),this._ownsWorker&&this._worker.destroy()}[Symbol.dispose](){this.destroy()}};o(go,"_nextExporterId",1);let bl=go;var Si;(function(n){n[n.LayoutDone=0]="LayoutDone",n[n.RenderRequested=1]="RenderRequested",n[n.RenderDone=2]="RenderDone",n[n.Detached=3]="Detached"})(Si||(Si={}));const er=class er{constructor(t){o(this,"_fontCheckers",new Map);o(this,"_api");o(this,"_contents",null);o(this,"_file",null);o(this,"_totalResultCount",0);o(this,"_initialTrackIndexes",null);o(this,"_intersectionObserver");o(this,"_barToElementLookup",new Map);o(this,"_resultIdToElementLookup",new Map);o(this,"_webFont");o(this,"rootContainerBecameVisible",new Ct);o(this,"canRenderChanged",new Ct);o(this,"rootContainer");o(this,"areWorkersSupported");o(this,"_highlightedElements",[]);o(this,"_scrollContainer",null);o(this,"_scrollAnimationId",0);o(this,"_activeScrollAnimations",new Set);o(this,"_scrollAnimationLookup",new Map);if(fe.webPlatform!==xs.Browser&&fe.webPlatform!==xs.BrowserModule)throw new Xe(ze.General,"Usage of AlphaTabApi is only possible in browser environments. For usage in node use the Low Level APIs");t.classList.add("alphaTab"),this.rootContainer=new sr(t),this.areWorkersSupported="Worker"in window,this._intersectionObserver=new IntersectionObserver(this._onElementVisibilityChanged.bind(this),{threshold:[0,.01,1]}),this._intersectionObserver.observe(t)}get resizeThrottle(){return 10}get canRender(){return this._areAllFontsLoaded()}_areAllFontsLoaded(){let t=!1;for(const e of this._fontCheckers.values())e.isFontLoaded||(t=!0);return t?!1:(L.debug("Font",`All fonts loaded: ${this._fontCheckers.size}`),!0)}_onFontLoaded(t){Lr.generateFontLookup(t),this._areAllFontsLoaded()&&this.canRenderChanged.trigger()}_onElementVisibilityChanged(t){for(const e of t){const s=e.target;if(s===this.rootContainer.element)e.isIntersecting&&(this.rootContainerBecameVisible.trigger(),this._intersectionObserver.unobserve(this.rootContainer.element));else if("layoutResultId"in s&&this._api.settings.core.enableLazyLoading){const i=s;e.isIntersecting?i.renderedResultId!==i.layoutResultId?this._resultIdToElementLookup.has(i.layoutResultId)?i.resultState!==Si.RenderRequested&&(i.resultState=Si.RenderRequested,this._api.renderer.renderResult(i.layoutResultId)):s.replaceChildren():i.resultState===Si.Detached&&(s.replaceChildren(...i.renderedResult),i.resultState=Si.RenderDone):i.resultState===Si.RenderDone&&(i.resultState=Si.Detached,i.replaceChildren())}}}createWorkerRenderer(){return new Tu(this._api,this._api.settings)}initialize(t,e){this._api=t;let s;e instanceof vi?s=e:s=Lt.jsObjectToSettings(e);const i=this._getDataAttributes();dr.fromJson(s,i),s.notation.notationMode===Xt.SongBook&&s.setSongBookModeSettings(),t.settings=s,this._setupFontCheckers(s),this._initialTrackIndexes=this.parseTracks(s.core.tracks),this._contents="";const r=t.container;s.core.tex&&(this._contents=r.element.textContent,r.element.innerText=""),this._createStyleElements(s),this._file=s.core.file}_setupFontCheckers(t){for(const e of t.display.resources.elementFonts.values())this._registerFontChecker(e);this._registerFontChecker(t.display.resources.graceFont),this._registerFontChecker(t.display.resources.tablatureFont),this._registerFontChecker(t.display.resources.numberedNotationFont),this._registerFontChecker(t.display.resources.numberedNotationGraceFont)}_registerFontChecker(t){if(!this._fontCheckers.has(t.families.join(", "))){const e=new Uh(t.families);this._fontCheckers.set(t.families.join(", "),e),e.fontLoaded.on(this._onFontLoaded.bind(this)),e.checkForFontAvailability()}}destroy(){const t=this.rootContainer.element;t.innerHTML="";const e=this._webFont,s=e.elements.get(t.ownerDocument);s&&(s.usages--,s.usages<=0&&(s.element.remove(),e.elements.delete(t.ownerDocument))),e.elements.size===0&&er._registeredWebFonts.delete(e.hash)}createCanvasElement(){const t=document.createElement("div");return t.classList.add("at-surface",`at${this._webFont.fontSuffix}`),t.style.fontSize="0",t.style.overflow="hidden",t.style.lineHeight="0",t.style.position="relative",new sr(t)}setCanvasOverflow(t,e,s){const i=t.element;e===0?(i.style.boxSizing="",i.style.paddingRight="",i.style.paddingBottom=""):s?(i.style.boxSizing="content-box",i.style.paddingBottom=`${e}px`):(i.style.boxSizing="content-box",i.style.paddingRight=`${e}px`)}triggerEvent(t,e,s=null,i){const r=t.element;e=`alphaTab.${e}`;const a=document.createEvent("CustomEvent"),l=i?i.mouseEvent:null;if(a.initCustomEvent(e,!1,!1,s),l&&(a.originalEvent=l),r.dispatchEvent(a),window&&"jQuery"in window){const h=window.jQuery,c=[];c.push(s),l&&c.push(l),h(r).trigger(e,c)}}load(t,e,s){if(t instanceof gi)return e(t),!0;if(t instanceof ArrayBuffer){const i=new Uint8Array(t);return e(xr.loadScoreFromBytes(i,this._api.settings)),!0}return t instanceof Uint8Array?(e(xr.loadScoreFromBytes(t,this._api.settings)),!0):typeof t=="string"?(xr.loadScoreAsync(t,e,s,this._api.settings),!0):!1}loadSoundFont(t,e){return this._api.player?t instanceof ArrayBuffer?(this._api.player.loadSoundFont(new Uint8Array(t),e),!0):t instanceof Uint8Array?(this._api.player.loadSoundFont(t,e),!0):typeof t=="string"?(this._api.loadSoundFontFromUrl(t,e),!0):!1:!1}initialRender(){this._api.renderer.preRender.on(e=>{this._totalResultCount=0,this._resultIdToElementLookup.clear(),this._barToElementLookup.clear()});const t=()=>{this._api.renderer.width=this.rootContainer.width|0,this._api.renderer.updateSettings(this._api.settings),this._contents?(this._api.tex(this._contents,this._initialTrackIndexes??void 0),this._initialTrackIndexes=null):this._file&&xr.loadScoreAsync(this._file,e=>{this._api.renderScore(e,this._initialTrackIndexes??void 0),this._initialTrackIndexes=null},e=>{this._api.onError(e)},this._api.settings)};this.rootContainer.isVisible?t():this.rootContainerBecameVisible.on(t)}_createStyleElements(t){const e=this._api.container.element.ownerDocument;er.createSharedStyleElement(e);const s=t.core.smuflFontSources??Yc.buildDefaultSmuflFontSources(t.core.fontDirectory),i=er._cyrb53(s.values()),r=er._registeredWebFonts;if(r.has(i)){const p=r.get(i);p.checker.fontLoaded.on(this._onFontLoaded.bind(this)),this._createStyleElement(p,e),this._webFont=p;return}const a=r.size===0?"":String(r.size),l=`alphaTab${a}`,h=Array.from(s.entries()).map(p=>`url(${JSON.stringify(p[1])}) format('${er._cssFormat(p[0])}')`).join(","),c=`
            @font-face {
                font-display: block;
                font-family: '${l}';
                src: ${h};
                font-weight: normal;
                font-style: normal;
            }
            .at-surface.at${a} .at {
                font-family: '${l}';
                speak: none;
                font-style: normal;
                font-weight: normal;
                font-variant: normal;
                text-transform: none;
                line-height: 1;
                line-height: 1;
                -webkit-font-smoothing: antialiased;
                -moz-osx-font-smoothing: grayscale;
                font-size: ${t.display.resources.engravingSettings.musicFontSize}px;
                overflow: visible !important;
            }`,d=new Uh([l]);d.fontLoaded.on(this._onFontLoaded.bind(this)),this._fontCheckers.set(l,d),d.checkForFontAvailability(),t.display.resources.smuflFontFamilyName=l;const u={hash:i,elements:new Map,fontSuffix:a,checker:d,cssSource:c};this._createStyleElement(u,e),r.set(i,u),this._webFont=u}_createStyleElement(t,e){if(t.elements.has(e)){t.elements.get(e).usages++;return}const s=e.createElement("style");s.id=`alphaTabStyle${t.fontSuffix}`,s.innerHTML=t.cssSource,e.getElementsByTagName("head").item(0).appendChild(s),t.elements.set(e,{element:s,usages:1})}static _cssFormat(t){switch(t){case ti.EmbeddedOpenType:return"embedded-opentype";case ti.Woff:return"woff";case ti.Woff2:return"woff2";case ti.OpenType:return"opentype";case ti.TrueType:return"truetype";case ti.Svg:return"svg"}}static _cyrb53(t,e=0){let s=3735928559^e,i=1103547991^e;for(const r of t)for(let a=0;a<r.length;a++){const l=r.charCodeAt(a);s=Math.imul(s^l,2654435761),i=Math.imul(i^l,1597334677)}return s=Math.imul(s^s>>>16,2246822507),s^=Math.imul(i^i>>>13,3266489909),i=Math.imul(i^i>>>16,2246822507),i^=Math.imul(s^s>>>13,3266489909),4294967296*(2097151&i)+(s>>>0)}static createSharedStyleElement(t){let e=t.getElementById("alphaTabStyle");if(!e){e=document.createElement("style"),e.id="alphaTabStyleShared";const s=`
                .at-surface * {
                    cursor: default;
                    vertical-align: top;
                    overflow: visible;
                }
                .at-surface-svg text {
                    dominant-baseline: alphabetic;
                    white-space:pre;
                }`;e.innerHTML=s,document.getElementsByTagName("head").item(0).appendChild(e)}}parseTracks(t){if(!t)return[];const e=[];if(typeof t=="string")try{if(t==="all")return[-1];t=JSON.parse(t)}catch{t=[0]}if(typeof t=="number")e.push(t);else if("length"in t){const s=t.length,i=t;for(let r=0;r<s;r++){const a=i[r];let l=0;typeof a=="number"?l=a:"index"in a?l=a.index:l=Number.parseInt(a.toString(),10),(l>=0||l===-1)&&e.push(l)}}else"index"in t&&e.push(t.index);return e}_getDataAttributes(){const t=new Map,e=this._api.container.element;if(e.dataset)for(const s of Object.keys(e.dataset)){let i=e.dataset[s];try{i=JSON.parse(i)}catch{i===""&&(i=null)}t.set(s,i)}else for(let s=0;s<e.attributes.length;s++){const i=e.attributes.item(s),r=i.nodeName;if(r.startsWith("data-")){const a=r.substr(5).split("-");let l=a[0];for(let c=1;c<a.length;c++)l+=a[c].substr(0,1).toUpperCase()+a[c].substr(1);let h=i.nodeValue;try{h=JSON.parse(h)}catch{h===""&&(h=null)}t.set(l,h)}}return t}beginUpdateRenderResults(t){if(!this._resultIdToElementLookup.has(t.id))return;const e=this._resultIdToElementLookup.get(t.id),s=t.renderResult;typeof s=="string"?e.innerHTML=s:"nodeType"in s&&e.replaceChildren(s),e.resultState=Si.RenderDone,e.renderedResultId=t.id,e.renderedResult=Array.from(e.children)}beginAppendRenderResults(t){const e=this._api.canvasElement.element;if(t){let s;this._totalResultCount<e.childElementCount?s=e.childNodes.item(this._totalResultCount):(s=document.createElement("div"),e.appendChild(s)),s.style.zIndex="1",s.style.position="absolute",s.style.left=`${t.x}px`,s.style.top=`${t.y}px`,s.style.width=`${t.width}px`,s.style.height=`${t.height}px`,s.style.display="inline-block",s.layoutResultId=t.id,s.resultState=Si.LayoutDone,s.renderedResultId=void 0,s.renderedResult=void 0,t.reuseViewport||(s.textContent=""),this._resultIdToElementLookup.set(t.id,s);for(let i=t.firstMasterBarIndex;i<=t.lastMasterBarIndex;i++)i>=0&&this._barToElementLookup.set(i,s);this._api.settings.core.enableLazyLoading&&(this._intersectionObserver.unobserve(s),this._intersectionObserver.observe(s)),this._totalResultCount++}else for(;e.childElementCount>this._totalResultCount;)this._api.settings.core.enableLazyLoading&&this._intersectionObserver.unobserve(e.lastChild),e.removeChild(e.lastElementChild)}createWorkerPlayer(){let t=null;const e="ScriptProcessorNode"in window;return window.isSecureContext&&"AudioWorkletNode"in window&&this._api.settings.player.outputMode===Ya.WebAudioAudioWorklets?(L.debug("Player","Will use webworkers for synthesizing and web audio api with worklets for playback"),t=new un(new kc(this._api.settings),this._api.settings)):e&&(L.debug("Player","Will use webworkers for synthesizing and web audio api with ScriptProcessor for playback"),t=new un(new Lc,this._api.settings)),t?t.ready.on(()=>{this._api.settings.player.soundFont&&this._api.loadSoundFontFromUrl(this._api.settings.player.soundFont,!1)}):L.error("Player","Player requires webworkers and web audio api, browser unsupported",null),t}createWorkerAudioExporter(t){const e=t===null||!(t instanceof un);return e&&(t=this.createWorkerPlayer()),new bl(t,e)}beginInvoke(t){window.requestAnimationFrame(()=>{t()})}highlightElements(t,e){const s=this._barToElementLookup.get(e);if(s){const i=s.getElementsByClassName(t);for(let r=0;r<i.length;r++)i.item(r).classList.add("at-highlight"),this._highlightedElements.push(i.item(r))}}removeHighlights(){const t=this._highlightedElements;if(t){for(const e of t)e.classList.remove("at-highlight");this._highlightedElements=[]}}destroyCursors(){const t=this._api.container.element,e=t.querySelector(".at-cursors");t.removeChild(e)}createCursors(){const t=this._api.container.element,e=document.createElement("div");e.classList.add("at-cursors");const s=document.createElement("div");s.classList.add("at-selection");const i=this.createScalingElement(),r=this.createScalingElement(),a=i.element;a.classList.add("at-cursor-bar");const l=r.element;return l.classList.add("at-cursor-beat"),t.style.position="relative",t.style.textAlign="left",e.style.position="absolute",e.style.zIndex="1000",e.style.display="inline",e.style.pointerEvents="none",s.style.position="absolute",a.style.position="absolute",a.style.left="0",a.style.top="0",a.style.willChange="transform",i.width=1,i.height=1,i.setBounds(0,0,1,1),l.style.position="absolute",l.style.transition="all 0s linear",l.style.left="0",l.style.top="0",l.style.willChange="transform",r.width=3,r.height=1,r.centerAtPosition=!0,r.setBounds(0,0,1,1),t.insertBefore(e,t.firstChild),e.appendChild(s),e.appendChild(a),e.appendChild(l),new Zn(new sr(e),i,r,new sr(s))}getOffset(t,e){const s=e.element,i=s.getBoundingClientRect();let r=i.top+s.ownerDocument.defaultView.pageYOffset,a=i.left+s.ownerDocument.defaultView.pageXOffset;if(t){const h=t.element,c=h.nodeName.toLowerCase();if(c!=="html"&&c!=="body"){const d=this.getOffset(null,t);r=r+h.scrollTop-d.y,a=a+h.scrollLeft-d.x}}const l=new Pt;return l.x=a,l.y=r,l.w=i.width,l.h=i.height,l}getScrollContainer(){if(this._scrollContainer)return this._scrollContainer;let t=typeof this._api.settings.player.scrollElement=="string"?document.querySelector(this._api.settings.player.scrollElement):this._api.settings.player.scrollElement;const e=t.nodeName.toLowerCase();return(e==="html"||e==="body")&&("scrollingElement"in document?t=document.scrollingElement:navigator.userAgent.indexOf("WebKit")!==-1?t=document.body:t=document.documentElement),this._scrollContainer=new sr(t),this._scrollContainer}createSelectionElement(){return this.createScalingElement()}createScalingElement(){const t=document.createElement("div");t.style.position="absolute";const e=new xu(t,100,100);return e.width=1,e.height=1,e.setBounds(0,0,1,1),e}scrollToY(t,e,s){this._internalScrollToY(t.element,e,s)}scrollToX(t,e,s){this._internalScrollToX(t.element,e,s)}stopScrolling(t){const e=this._scrollAnimationLookup.get(t.element);e!==void 0&&this._activeScrollAnimations.delete(e)}get _nativeBrowserSmoothScroll(){const t=this._api.settings.player;return t.nativeBrowserSmoothScroll&&t.scrollMode!==hi.Smooth}_internalScrollToY(t,e,s){this._nativeBrowserSmoothScroll?t.scrollTo({top:e,behavior:"smooth"}):this._internalScrollTo(t,t.scrollTop,e,s,i=>{t.scrollTop=i})}_internalScrollTo(t,e,s,i,r){const a=this._scrollAnimationLookup.get(t);if(a!==void 0&&this._activeScrollAnimations.delete(a),i===0){r(s);return}const l=this._scrollAnimationId++;this._scrollAnimationLookup.set(t,l),this._activeScrollAnimations.add(l);const h=s-e;let c=0;const d=u=>{if(!this._activeScrollAnimations.has(l))return;c===0&&(c=u);const p=u-c,g=Math.min(p/i,1);r(e+h*g|0),p<i?window.requestAnimationFrame(d):this._activeScrollAnimations.delete(l)};window.requestAnimationFrame(d)}_internalScrollToX(t,e,s){this._nativeBrowserSmoothScroll?t.scrollTo({left:e,behavior:"smooth"}):this._internalScrollTo(t,t.scrollLeft,e,s,i=>{t.scrollLeft=i})}createBackingTrackPlayer(){return new Dc(new Nu,this._api.settings.player.bufferTimeInMilliseconds)}};o(er,"_registeredWebFonts",new Map);let Sl=er;class Pu{constructor(t,e){o(this,"loaded");o(this,"total");this.loaded=t,this.total=e}}class yh extends Bu{constructor(e,s){super(new Sl(e),s);o(this,"soundFontLoad",new xe)}tex(e,s){const i=this.uiFacade;super.tex(e,i.parseTracks(s))}print(e,s=null){const i=window.open("","","width=0,height=0"),r=i.document.createElement("div");e?r.style.width=e:this.settings.display.layoutMode===Ti.Horizontal?r.style.width="297mm":r.style.width="210mm",i.document.write(`
        <!DOCTYPE html>
        <html>
          <head>
            <style>
            .at-surface {
                width: auto !important;
                height: auto !important;
            }
            .at-surface > div {
                position: relative!important;
                left: auto !important;
                top: auto !important;
                break-inside: avoid;
            }
            </style>
          </head>
          <body></body>
        </html>
        `);const a=this.score;a&&(a.artist&&a.title?i.document.title=`${a.title} - ${a.artist}`:a.title&&(i.document.title=`${a.title}`)),i.document.body.appendChild(r);const l=typeof window.screenLeft<"u"?window.screenLeft:window.left,h=typeof window.screenTop<"u"?window.screenTop:window.top,c="innerWidth"in window?window.innerWidth:"clientWidth"in document.documentElement?document.documentElement.clientWidth:window.screen.width,d="innerHeight"in window?window.innerHeight:"clientHeight"in document.documentElement?document.documentElement.clientHeight:window.screen.height,u=r.offsetWidth+50,p=window.innerHeight,g=(c/2|0)-(u/2|0)+l,m=(d/2|0)-(p/2|0)+h;i.resizeTo(u,p),i.moveTo(g,m),i.focus();const y=Lt.jsObjectToSettings(Lt.settingsToJsObject(this.settings));y.core.enableLazyLoading=!1,y.core.useWorkers=!0,y.core.file=null,y.core.tracks=null,y.player.enableCursor=!1,y.player.playerMode=fs.Disabled,y.player.enableElementHighlighting=!1,y.player.enableUserInteraction=!1,y.player.soundFont=null,y.display.scale=.8,y.display.stretchForce=.8,dr.fromJson(y,s);const S=new yh(r,y);i.onunload=()=>{S.destroy()},S.renderer.postRenderFinished.on(()=>{i.print()}),S.renderTracks(this.tracks)}downloadMidi(e=vr.SingleTrackMultiChannel){if(!this.score)return;const s=new xi;s.format=e;const i=new si(s,!0);new Bi(this.score,this.settings,i).generate();const a=s.toBinary(),l=this.score.title?`${this.score.title}.mid`:"File.mid",h=document.createElement("a");h.download=l;const c=new Blob([a],{type:"audio/midi"}),d=URL.createObjectURL(c);h.href=d,h.style.display="none",document.body.appendChild(h),h.click(),document.body.removeChild(h)}changeTrackMute(e,s){const i=this._trackIndexesToTracks(this.uiFacade.parseTracks(e));super.changeTrackMute(i,s)}changeTrackSolo(e,s){const i=this._trackIndexesToTracks(this.uiFacade.parseTracks(e));super.changeTrackSolo(i,s)}changeTrackVolume(e,s){const i=this._trackIndexesToTracks(this.uiFacade.parseTracks(e));super.changeTrackVolume(i,s)}_trackIndexesToTracks(e){if(!this.score)return[];const s=[];if(e.length===1&&e[0]===-1)for(const i of this.score.tracks)s.push(i);else for(const i of e)i>=0&&i<this.score.tracks.length&&s.push(this.score.tracks[i]);return s}loadSoundFontFromUrl(e,s){const i=this.player;if(!i)return;L.debug("AlphaSynth",`Start loading Soundfont from url ${e}`);const r=new XMLHttpRequest;r.open("GET",e,!0,null,null),r.responseType="arraybuffer",r.onload=a=>{const l=new Uint8Array(r.response);this.loadSoundFont(l,s)},r.onerror=a=>{L.error("AlphaSynth",`Loading failed: ${a.message}`),i.soundFontLoadFailed.trigger(new pr(a.message,r))},r.onprogress=a=>{L.debug("AlphaSynth",`Soundfont downloading: ${a.loaded}/${a.total} bytes`);const l=new Pu(a.loaded,a.total);this.soundFontLoad.trigger(l),this.uiFacade.triggerEvent(this.container,"soundFontLoad",l)},r.send()}}class zh{constructor(){o(this,"_initListeners",[])}exec(t,e,s){if(typeof e!="string"&&(s=[e],e="init"),e.charCodeAt(0)===95||e==="exec")return null;const i=new jQuery(t),r=i.data("alphaTab");if(e==="destroy"&&!r)return null;if(e!=="init"&&!r)throw new Error("alphaTab not initialized");const a=this[e];if(a){const l=[i,r].concat(s);return a.apply(this,l)}return L.error("Api",`Method '${e}' does not exist on jQuery.alphaTab`),null}init(t,e,s){if(!e){e=new yh(t[0],s),t.data("alphaTab",e);for(const i of this._initListeners)i(t,e,s)}}destroy(t,e){t.removeData("alphaTab"),e.destroy()}print(t,e,s,i){e.print(s,i)}load(t,e,s,i){return e.load(s,i)}render(t,e){e.render()}renderScore(t,e,s,i){e.renderScore(s,i)}renderTracks(t,e,s){e.renderTracks(s)}invalidate(t,e){e.render()}tex(t,e,s,i){e.tex(s,i)}muteTrack(t,e,s,i){e.changeTrackMute(s,i)}soloTrack(t,e,s,i){e.changeTrackSolo(s,i)}trackVolume(t,e,s,i){e.changeTrackVolume(s,i)}loadSoundFont(t,e,s,i){e.loadSoundFont(s,i)}resetSoundFonts(t,e){e.resetSoundFonts()}pause(t,e){e.pause()}play(t,e){return e.play()}playPause(t,e){e.playPause()}stop(t,e){e.stop()}api(t,e){return e}player(t,e){return e.player}isReadyForPlayback(t,e){return e.isReadyForPlayback}playerState(t,e){return e.playerState}masterVolume(t,e,s){return typeof s=="number"&&(e.masterVolume=s),e.masterVolume}metronomeVolume(t,e,s){return typeof s=="number"&&(e.metronomeVolume=s),e.metronomeVolume}countInVolume(t,e,s){return typeof s=="number"&&(e.countInVolume=s),e.countInVolume}midiEventsPlayedFilter(t,e,s){return Array.isArray(s)&&(e.midiEventsPlayedFilter=s),e.midiEventsPlayedFilter}playbackSpeed(t,e,s){return typeof s=="number"&&(e.playbackSpeed=s),e.playbackSpeed}tickPosition(t,e,s){return typeof s=="number"&&(e.tickPosition=s),e.tickPosition}timePosition(t,e,s){return typeof s=="number"&&(e.timePosition=s),e.timePosition}loop(t,e,s){return typeof s=="boolean"&&(e.isLooping=s),e.isLooping}renderer(t,e){return e.renderer}score(t,e){return e.score}settings(t,e){return e.settings}tracks(t,e){return e.tracks}_oninit(t){this._initListeners.push(t)}static restore(t){new jQuery(t).empty().removeData("alphaTab")}}function Cu(n,t,e){if(t!=null){if(typeof t!="object"&&typeof t!="function")throw new TypeError("Object expected.");var s,i;if(s===void 0){if(!Symbol.dispose)throw new TypeError("Symbol.dispose is not defined.");s=t[Symbol.dispose]}if(typeof s!="function")throw new TypeError("Object not disposable.");i&&(s=function(){try{i.call(this)}catch(r){return Promise.reject(r)}}),n.stack.push({value:t,dispose:s,async:e})}return t}var Eu=typeof SuppressedError=="function"?SuppressedError:function(n,t,e){var s=new Error(e);return s.name="SuppressedError",s.error=n,s.suppressed=t,s};function vu(n){function t(r){n.error=n.hasError?new Eu(r,n.error,"An error was suppressed during disposal."):r,n.hasError=!0}var e,s=0;function i(){for(;e=n.stack.pop();)try{if(!e.async&&s===1)return s=0,n.stack.push(e),Promise.resolve().then(i);if(e.dispose){var r=e.dispose.call(e.value);if(e.async)return s|=2,Promise.resolve(r).then(i,function(a){return t(a),i()})}else s|=1}catch(a){t(a)}if(s===1)return n.hasError?Promise.reject(n.error):Promise.resolve();if(n.hasError)throw n.error}return i()}const bt=class bt{constructor(){o(this,"_canvas");o(this,"_color",new qe(0,0,0,0));o(this,"_lineWidth",0);o(this,"_textStyle",null);o(this,"_scale",1);o(this,"_textStyles",new Map);o(this,"_font",new Ye("Arial",10,st.Plain));o(this,"_musicTextStyle",null);o(this,"settings");o(this,"textAlign",X.Left);o(this,"textBaseline",Ue.Top);this._canvas=new bt._alphaSkia.AlphaSkiaCanvas,this.color=new qe(0,0,0,255)}static enable(t,e){bt._alphaSkia=e,bt.initializeMusicFont(bt._alphaSkia.AlphaSkiaTypeface.register(t))}static initializeMusicFont(t){bt._defaultMusicTextStyle=new bt._alphaSkia.AlphaSkiaTextStyle([t.familyName],t.weight,t.isItalic)}static registerFont(t,e){const s=bt._alphaSkia.AlphaSkiaTypeface.register(t.buffer);return e||(e=Ye.withFamilyList([s.familyName],12,s.isItalic?st.Italic:st.Plain,s.weight>400?bs.Bold:bs.Regular)),e}get font(){return this._font}set font(t){if(this._font===t)return;this._font=t;const e=this._textStyleKey(t);if(this._textStyles.has(e))this._textStyle=this._textStyles.get(e);else{const s=new bt._alphaSkia.AlphaSkiaTextStyle(t.families,t.weight===bs.Bold?700:400,t.isItalic);this._textStyles.set(e,s),this._textStyle=s}}_textStyleKey(t){return[...t.families,t.weight.toString(),t.isItalic?"italic":"upright"].join("_")}destroy(){this._canvas[Symbol.dispose]();for(const t of this._textStyles.values())t[Symbol.dispose]()}onRenderFinished(){return null}beginRender(t,e){this._scale=this.settings.display.scale,this._canvas.beginRender(t,e,fe.highDpiFactor);const s=this.settings.display.resources.smuflFontFamilyName;s&&s!==bt._defaultMusicTextStyle.familyNames[0]?this._textStyles.has(s)?this._musicTextStyle=this._textStyles.get(s):(this._musicTextStyle=new bt._alphaSkia.AlphaSkiaTextStyle([s],bt._defaultMusicTextStyle.weight,bt._defaultMusicTextStyle.isItalic),this._textStyles.set(s,this._musicTextStyle)):this._musicTextStyle=bt._defaultMusicTextStyle}endRender(){return this._canvas.endRender()}get color(){return this._color}set color(t){this._color.rgba!==t.rgba&&(this._color=t,this._canvas.color=bt._alphaSkia.AlphaSkiaCanvas.rgbaToColor(t.r,t.g,t.b,t.a))}get lineWidth(){return this._lineWidth}set lineWidth(t){this._lineWidth=t,this._canvas.lineWidth=t}fillRect(t,e,s,i){s>0&&this._canvas.fillRect(t*this._scale,e*this._scale,s*this._scale,i*this._scale)}strokeRect(t,e,s,i){const r=this.lineWidth%2===0?0:.5;this._canvas.strokeRect(t*this._scale+r,e*this._scale+r,s*this._scale,i*this._scale)}beginPath(){this._canvas.beginPath()}closePath(){this._canvas.closePath()}moveTo(t,e){this._canvas.moveTo(t*this._scale,e*this._scale)}lineTo(t,e){this._canvas.lineTo(t*this._scale,e*this._scale)}quadraticCurveTo(t,e,s,i){this._canvas.quadraticCurveTo(t*this._scale,e*this._scale,s*this._scale,i*this._scale)}bezierCurveTo(t,e,s,i,r,a){this._canvas.bezierCurveTo(t*this._scale,e*this._scale,s*this._scale,i*this._scale,r*this._scale,a*this._scale)}fillCircle(t,e,s){this._canvas.fillCircle(t*this._scale,e*this._scale,s*this._scale)}strokeCircle(t,e,s){this._canvas.strokeCircle(t*this._scale,e*this._scale,s*this._scale)}fill(){this._canvas.fill()}stroke(){this._canvas.stroke()}beginGroup(t){}endGroup(){}fillText(t,e,s){if(t.length===0)return;let i=bt._alphaSkia.AlphaSkiaTextAlign.Left;switch(this.textAlign){case X.Left:i=bt._alphaSkia.AlphaSkiaTextAlign.Left;break;case X.Center:i=bt._alphaSkia.AlphaSkiaTextAlign.Center;break;case X.Right:i=bt._alphaSkia.AlphaSkiaTextAlign.Right;break}let r=bt._alphaSkia.AlphaSkiaTextBaseline.Top;switch(this.textBaseline){case Ue.Top:r=bt._alphaSkia.AlphaSkiaTextBaseline.Top;break;case Ue.Middle:r=bt._alphaSkia.AlphaSkiaTextBaseline.Middle;break;case Ue.Bottom:r=bt._alphaSkia.AlphaSkiaTextBaseline.Bottom;break;case Ue.Alphabetic:r=bt._alphaSkia.AlphaSkiaTextBaseline.Alphabetic;break}this._canvas.fillText(t,this._textStyle,this._font.size*this._scale,e*this._scale,s*this._scale,i,r)}measureText(t){const e={stack:[],error:void 0,hasError:!1};try{const s=Cu(e,this._canvas.measureText(t,this._textStyle,this._font.size,bt._alphaSkia.AlphaSkiaTextAlign.Left,bt._alphaSkia.AlphaSkiaTextBaseline.Alphabetic),!1),[i,r]=this._getTextWidthAndHeight(s,t);return new en(i,r)}catch(s){e.error=s,e.hasError=!0}finally{vu(e)}}_getTextWidthAndHeight(t,e){let s=t.width;if(e.length>0&&s<1)for(let r=0;r<5&&(s=t.width,!(s>1));r++);const i=t.actualBoundingBoxAscent+t.actualBoundingBoxDescent;return[s,i]}fillMusicFontSymbol(t,e,s,i,r){i!==f.None&&this._fillMusicFontSymbolText(t,e,s,String.fromCharCode(i),r)}fillMusicFontSymbols(t,e,s,i,r){let a="";for(const l of i)l!==f.None&&(a+=String.fromCharCode(l));this._fillMusicFontSymbolText(t,e,s,a,r)}_fillMusicFontSymbolText(t,e,s,i,r){this._canvas.fillText(i,this._musicTextStyle,this.settings.display.resources.engravingSettings.musicFontSize*this._scale*s,t*this._scale,e*this._scale,r?bt._alphaSkia.AlphaSkiaTextAlign.Center:bt._alphaSkia.AlphaSkiaTextAlign.Left,bt._alphaSkia.AlphaSkiaTextBaseline.Alphabetic)}beginRotate(t,e,s){this._canvas.beginRotate(t*this._scale,e*this._scale,s)}endRotate(){this._canvas.endRotate()}};o(bt,"_alphaSkia"),o(bt,"_defaultMusicTextStyle",null);let Ta=bt;class ko{constructor(){o(this,"buffer","");o(this,"_currentPath","");o(this,"_currentPathIsEmpty",!0);o(this,"scale",1);o(this,"color",new qe(255,255,255,255));o(this,"lineWidth",1);o(this,"font",new Ye("Arial",10,st.Plain));o(this,"textAlign",X.Left);o(this,"textBaseline",Ue.Top);o(this,"settings")}destroy(){}beginRender(t,e){this.scale=this.settings.display.scale,this.buffer=`<svg xmlns="http://www.w3.org/2000/svg" version="1.1" width="${t|0}px" height="${e|0}px" class="at-surface-svg">
`,this._currentPath="",this._currentPathIsEmpty=!0,this.textBaseline=Ue.Top}beginGroup(t){this.buffer+=`<g class="${t}">`}endGroup(){this.buffer+="</g>"}endRender(){return this.buffer+="</svg>",this.buffer}fillRect(t,e,s,i){s>0&&(this.buffer+=`<rect x="${t*this.scale}" y="${e*this.scale}" width="${s*this.scale}" height="${i*this.scale}" fill="${this.color.rgba}" />
`)}strokeRect(t,e,s,i){const r=this.lineWidth*this.scale%2===0?0:.5;this.buffer+=`<rect x="${t*this.scale+r}" y="${e*this.scale+r}" width="${s*this.scale}" height="${i*this.scale}" stroke="${this.color.rgba}"`,this.lineWidth!==1&&(this.buffer+=` stroke-width="${this.lineWidth*this.scale}"`),this.buffer+=` fill="transparent" />
`}beginPath(){}closePath(){this._currentPath+=" z"}moveTo(t,e){this._currentPath+=` M${t*this.scale},${e*this.scale}`}lineTo(t,e){this._currentPathIsEmpty=!1,this._currentPath+=` L${t*this.scale},${e*this.scale}`}quadraticCurveTo(t,e,s,i){this._currentPathIsEmpty=!1,this._currentPath+=` Q${t*this.scale},${e*this.scale},${s*this.scale},${i*this.scale}`}bezierCurveTo(t,e,s,i,r,a){this._currentPathIsEmpty=!1,this._currentPath+=` C${t*this.scale},${e*this.scale},${s*this.scale},${i*this.scale},${r*this.scale},${a*this.scale}`}fillCircle(t,e,s){this._currentPathIsEmpty=!1,t*=this.scale,e*=this.scale,s*=this.scale,this._currentPath+=` M${t-s},${e} A1,1 0 0,0 ${t+s},${e} A1,1 0 0,0 ${t-s},${e} z`,this.fill()}strokeCircle(t,e,s){this._currentPathIsEmpty=!1,t*=this.scale,e*=this.scale,s*=this.scale,this._currentPath+=` M${t-s},${e} A1,1 0 0,0 ${t+s},${e} A1,1 0 0,0 ${t-s},${e} z`,this.stroke()}fill(){this._currentPathIsEmpty||(this.buffer+=`<path d="${this._currentPath}"`,this.color.rgba!=="#000000"&&(this.buffer+=` fill="${this.color.rgba}"`),this.buffer+=' style="stroke: none"/>'),this._currentPath="",this._currentPathIsEmpty=!0}stroke(){if(!this._currentPathIsEmpty){let t=`<path d="${this._currentPath}" stroke="${this.color.rgba}"`;(this.lineWidth!==1||this.scale!==1)&&(t+=` stroke-width="${this.lineWidth*this.scale}"`),t+=' style="fill: none" />',this.buffer+=t}this._currentPath="",this._currentPathIsEmpty=!0}fillText(t,e,s){if(t==="")return;let i=`<text x="${e*this.scale}" y="${s*this.scale}" style='stroke: none; font:${this.font.toCssString(this.settings.display.scale)}; ${this.getSvgBaseLine()}'`;this.color.rgba!=="#000000"&&(i+=` fill="${this.color.rgba}"`),this.textAlign!==X.Left&&(i+=` text-anchor="${this.getSvgTextAlignment(this.textAlign)}"`),i+=`>${ko._escapeText(t)}</text>`,this.buffer+=i}static _escapeText(t){return t.replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}getSvgTextAlignment(t){switch(t){case X.Left:return"start";case X.Center:return"middle";case X.Right:return"end"}return""}getSvgBaseLine(){switch(this.textBaseline){case Ue.Top:return"dominant-baseline: hanging";case Ue.Bottom:return"dominant-baseline: ideographic";case Ue.Alphabetic:return"";case Ue.Middle:return"dominant-baseline: middle";default:return""}}measureText(t){return t?Lr.measureString(t,this.font.families,this.font.size,this.font.style,this.font.weight):new en(0,0)}onRenderFinished(){return null}beginRotate(t,e,s){this.buffer+=`<g transform="translate(${t*this.scale} ,${e*this.scale}) rotate( ${s})">`}endRotate(){this.buffer+="</g>"}}class Mc extends ko{fillMusicFontSymbol(t,e,s,i,r){i!==f.None&&this._fillMusicFontSymbolText(t,e,s,`&#${i};`,r)}fillMusicFontSymbols(t,e,s,i,r){let a="";for(const l of i)l!==f.None&&(a+=`&#${l};`);this._fillMusicFontSymbolText(t,e,s,a,r)}_fillMusicFontSymbolText(t,e,s,i,r){t*=this.scale,e*=this.scale,this.buffer+=`<g transform="translate(${t} ${e})" class="at" ><text`;const a=this.scale*s;a!==1?this.buffer+=` style="font-size: ${a*100}%; stroke:none"`:this.buffer+=' style="stroke:none"',this.color.rgba!=="#000000"&&(this.buffer+=` fill="${this.color.rgba}"`),r&&(this.buffer+=` text-anchor="${this.getSvgTextAlignment(X.Center)}"`),this.buffer+=`>${i}</text></g>`}}var Se;(function(n){n[n.OwnedTop=0]="OwnedTop",n[n.OwnedBottom=1]="OwnedBottom",n[n.SharedTop=2]="SharedTop",n[n.SharedBottom=3]="SharedBottom"})(Se||(Se={}));class wo{constructor(t){o(this,"hideOnMultiTrack",!1);o(this,"hideOnPercussionTrack",!1);o(this,"effectBands");this.effectBands=t}canCreate(t,e){return!this.hideOnPercussionTrack||!e.isPercussion}}var Pe;(function(n){n[n.SinglePreBeat=0]="SinglePreBeat",n[n.SingleOnBeat=1]="SingleOnBeat",n[n.SingleOnBeatToEnd=2]="SingleOnBeatToEnd",n[n.GroupedOnBeat=3]="GroupedOnBeat",n[n.GroupedOnBeatToEnd=4]="GroupedOnBeatToEnd",n[n.FullBar=5]="FullBar"})(Pe||(Pe={}));class Cs extends It{constructor(e=0,s=0){super(e,s);o(this,"beat",null);o(this,"nextGlyph",null);o(this,"previousGlyph",null)}}class Du extends Cs{constructor(e,s,i,r,a,l){super(e,s);o(this,"_endings");o(this,"_endingsString","");o(this,"_openLine");o(this,"_closeLine");o(this,"_indent");this._endings=A.getAlternateEndingsList(i),this._openLine=r,this._closeLine=a,this._indent=l}doLayout(){super.doLayout(),this.height=this.renderer.resources.elementFonts.get(v.EffectAlternateEndings).size+this.renderer.smuflMetrics.alternateEndingsPadding*2;let e="";for(let s=0,i=this._endings.length;s<i;s++)e+=this._endings[s]+1,e+=". ";this._endingsString=e}paint(e,s,i){let r=this._closeLine?this.width-i.lineWidth:this.width;if(this.renderer.bar.getActualBarLineRight()===Be.LightHeavy&&(r-=this.renderer.smuflMetrics.thickBarlineThickness+this.renderer.smuflMetrics.barlineSeparation),e=(e|0)+i.lineWidth/2,s=(s|0)+i.lineWidth/2,this._indent&&(e+=this.renderer.smuflMetrics.alternateEndingsPadding,r-=this.renderer.smuflMetrics.alternateEndingsPadding),this._openLine?(i.moveTo(e+this.x,s+this.y+this.height),i.lineTo(e+this.x,s+this.y)):i.moveTo(e+this.x,s+this.y),i.lineTo(e+this.x+r,s+this.y),this._closeLine&&i.lineTo(e+this.x+r,s+this.y+this.height),i.stroke(),this._openLine){const l=i.textBaseline;i.textBaseline=Ue.Top;const h=this.renderer.resources;i.font=h.elementFonts.get(v.EffectAlternateEndings),i.fillText(this._endingsString,e+this.x+this.renderer.smuflMetrics.alternateEndingsPadding,s+this.y+this.renderer.smuflMetrics.alternateEndingsPadding),i.textBaseline=l}}}class yt{get effectId(){return this.notationElement.toString()}finalizeBand(t){}onAlignGlyphs(t){}}class Lu extends yt{get notationElement(){return v.EffectAlternateEndings}get hideOnMultiTrack(){return!0}get canShareBand(){return!1}get sizingMode(){return Pe.FullBar}shouldCreateGlyph(t,e){return e.voice.index===0&&e.index===0&&e.voice.bar.masterBar.alternateEndings!==0}createNewGlyph(t,e){const s=e.voice.bar.masterBar,i=s.previousMasterBar===null||s.alternateEndings!==s.previousMasterBar.alternateEndings;let r=s.isRepeatEnd||s.nextMasterBar===null||s.alternateEndings!==s.nextMasterBar.alternateEndings;s.repeatGroup.closings.some(l=>l.index>=s.index)||(r=!1);const a=s.previousMasterBar!==null&&s.alternateEndings!==s.previousMasterBar.alternateEndings&&s.previousMasterBar.alternateEndings>0;return new Du(0,0,s.alternateEndings,i,r,a)}canExpand(t,e){return!0}}class sn extends Cs{constructor(e){super();o(this,"endPosition");o(this,"forceGroupedRendering",!1);o(this,"endOnBarLine",!1);this.endPosition=e}get isLinkedWithPrevious(){var e;return!!this.previousGlyph&&((e=this.previousGlyph.renderer.staff)==null?void 0:e.system)===this.renderer.staff.system}get isLinkedWithNext(){var e;return!!this.nextGlyph&&this.nextGlyph.renderer.isFinalized&&((e=this.nextGlyph.renderer.staff)==null?void 0:e.system)===this.renderer.staff.system}paint(e,s,i){if(this.isLinkedWithPrevious)return;if(!this.isLinkedWithNext&&!this.forceGroupedRendering){this.paintNonGrouped(e,s,i);return}let r;if(!this.isLinkedWithNext&&this.forceGroupedRendering)r=this;else for(r=this.nextGlyph;r.isLinkedWithNext;)r=r.nextGlyph;const a=r.renderer,l=r.beat,h=this.endPosition,c=e-this.renderer.x,d=this.calculateEndX(a,l,c,h);this.paintGrouped(e,s,d,i)}calculateEndX(e,s,i,r){return s?i+e.x+e.getBeatX(s,r):i+e.x+this.x+this.width}paintNonGrouped(e,s,i){const r=e-this.renderer.x,a=this.calculateEndX(this.renderer,this.beat,r,this.endPosition);this.paintGrouped(e,s,a,i)}}class Ar extends sn{constructor(e,s,i=!0){super(oe.OnNotes);o(this,"_label");o(this,"_dashed");o(this,"_labelWidth",0);o(this,"_fontElement");this._label=e,this._dashed=i,this._fontElement=s}doLayout(){this.renderer.settings.notation.extendLineEffectsToBeatEnd&&(this.endPosition=oe.EndBeat,this.forceGroupedRendering=!0),super.doLayout(),this.renderer.scoreRenderer.canvas.font=this.renderer.resources.elementFonts.get(this._fontElement);const e=this.renderer.scoreRenderer.canvas.measureText(this._label);this.height=e.height,this._labelWidth=e.width}paintNonGrouped(e,s,i){const r=this.renderer.resources;i.font=r.elementFonts.get(this._fontElement);const a=i.textBaseline;i.textBaseline=Ue.Middle,i.fillText(this._label,e+this.x-this._labelWidth/2,s+this.y+this.height/2),i.textBaseline=a}paintGrouped(e,s,i,r){this.paintNonGrouped(e,s,r);const a=this.renderer.smuflMetrics.lineRangedGlyphDashGap,l=this.renderer.smuflMetrics.lineRangedGlyphDashSize,h=this.renderer.smuflMetrics.pedalLineThickness,c=e+this.x+this._labelWidth/2+a/2,d=s+this.y+this.height/2-h/2;if(this._dashed){if(i>c){let u=c;for(;u<i;){const p=Math.min(u+l,i);r.fillRect(u,d,p-u,h),u+=l+a}r.fillRect(i,d-l/2+h/2,h,l)}}else r.fillRect(c,d,i-c,h),r.fillRect(i-h,d,h,l/2)}}const Oa=class Oa extends yt{get notationElement(){return v.EffectLetRing}get canShareBand(){return!1}get hideOnMultiTrack(){return!1}shouldCreateGlyph(t,e){return e.isBarre}get sizingMode(){return Pe.GroupedOnBeat}createNewGlyph(t,e){let s="";switch(e.barreShape){case Hs.None:case Hs.Full:break;case Hs.Half:s+="1/2";break}return s+=`B ${Oa.toRoman(e.barreFret)}`,new Ar(s,v.EffectBeatBarre,!1)}static toRoman(t){let e="";if(t>0)for(const[s,i]of Oa._romanLetters){const r=Math.floor(t/i);t-=r*i,e+=s.repeat(r)}return e}canExpand(t,e){return t.barreFret===e.barreFret&&t.barreShape===e.barreShape}};o(Oa,"_romanLetters",new Map([["L",50],["XL",40],["X",10],["IX",9],["V",5],["IV",4],["I",1]]));let _l=Oa;class Mu extends Cs{constructor(e){super(0,0);o(this,"_timer");o(this,"_text","");o(this,"_textWidth",0);o(this,"_textHeight",0);this._timer=e}doLayout(){const e=this._timer/6e4|0,s=(this._timer-e*6e4)/1e3|0;this._text=`${e}:${s.toString().padStart(2,"0")}`;const i=this.renderer.scoreRenderer.canvas;i.font=this.renderer.resources.elementFonts.get(v.EffectBeatTimer);const r=i.measureText(this._text);this._textHeight=i.font.size+this.renderer.smuflMetrics.beatTimerPadding*2,this._textWidth=r.width+this.renderer.smuflMetrics.beatTimerPadding*2,this.height=this._textHeight+this.renderer.smuflMetrics.beatTimerPadding*2}paint(e,s,i){const r=this._textWidth/2|0;i.strokeRect(e+this.x-r,s+this.y+this.renderer.smuflMetrics.beatTimerPadding,this._textWidth,this._textHeight);const a=i.font,l=i.textBaseline,h=i.textAlign;i.font=this.renderer.resources.elementFonts.get(v.EffectBeatTimer),i.textBaseline=Ue.Middle,i.textAlign=X.Center,i.fillText(this._text,e+this.x,s+this.y+this.height/2),i.font=a,i.textBaseline=l,i.textAlign=h}}class Fu extends yt{get notationElement(){return v.EffectBeatTimer}get hideOnMultiTrack(){return!0}get canShareBand(){return!0}get sizingMode(){return Pe.SingleOnBeat}shouldCreateGlyph(t,e){return e.showTimer}createNewGlyph(t,e){return new Mu(e.timer??0)}canExpand(t,e){return!0}}class Js extends Cs{constructor(e,s,i,r,a=X.Left,l=null,h){super(e,s);o(this,"_lines");o(this,"_lineHeights",null);o(this,"font");o(this,"textAlign");o(this,"textBaseline");o(this,"colorOverride");this._lines=i.split(`
`),this.font=r,this.textAlign=a,this.textBaseline=l,this.colorOverride=h}doLayout(){super.doLayout(),this._lineHeights=[];const e=this.renderer.scoreRenderer.canvas;for(const s of this._lines){e.font=this.font;const i=e.measureText(s),r=i.height;this._lineHeights.push(r),this.height+=r,this.width=Math.max(this.width,i.width)}}paint(e,s,i){const r=i.color;i.color=this.colorOverride??r,i.font=this.font;const a=i.textAlign,l=i.textBaseline;i.textAlign=this.textAlign,this.textBaseline!==null&&(i.textBaseline=this.textBaseline);let h=s+this.y;for(let c=0;c<this._lines.length;c++)i.fillText(this._lines[c],e+this.x,h),h+=this._lineHeights[c];i.textAlign=a,i.textBaseline=l,i.color=r}}class Au extends yt{get notationElement(){return v.EffectCapo}get hideOnMultiTrack(){return!1}get canShareBand(){return!1}get sizingMode(){return Pe.SingleOnBeat}shouldCreateGlyph(t,e){return e.index===0&&e.voice.bar.index===0&&e.voice.bar.staff.capo!==0}createNewGlyph(t,e){return new Js(0,0,`Capo. fret ${e.voice.bar.staff.capo}`,t.resources.elementFonts.get(v.EffectCapo),X.Left)}canExpand(t,e){return!1}}const Yr=class Yr extends Cs{constructor(e,s,i,r,a=!1){super(e,s);o(this,"_chord");o(this,"_textRow",0);o(this,"_fretRow",0);o(this,"_firstFretSpacing",0);o(this,"_center");o(this,"_fontElement");this._chord=i,this._center=a,this._fontElement=r}doLayout(){super.doLayout();const s=this.renderer.resources.elementFonts.get(this._fontElement);if(this._textRow=s.size*1.5,this._fretRow=s.size*1.5,this.height=this._textRow,this.width=2*this.renderer.smuflMetrics.chordDiagramPaddingX,this.renderer.settings.notation.isNotationElementVisible(v.ChordDiagramFretboardNumbers))this._chord.firstFret>1?this._firstFretSpacing=this.renderer.smuflMetrics.chordDiagramFretSpacing:this._firstFretSpacing=0,this.height+=this._fretRow+Yr._frets*this.renderer.smuflMetrics.chordDiagramFretSpacing+2*this.renderer.smuflMetrics.chordDiagramPaddingY,this.width+=this._firstFretSpacing+(this._chord.strings.length-1)*this.renderer.smuflMetrics.chordDiagramStringSpacing;else if(this._chord.showName){const i=this.renderer.scoreRenderer.canvas;i.font=s,this.width+=i.measureText(this._chord.name).width}}paint(e,s,i){e+=this.x+this.renderer.smuflMetrics.chordDiagramPaddingX+this._firstFretSpacing,s+=this.y,this._center&&(e-=this.width/2);const r=this.renderer.resources,a=r.engravingSettings.chordDiagramLineWidth,l=this.width-2*this.renderer.smuflMetrics.chordDiagramPaddingX-this._firstFretSpacing+a,h=i.textAlign,c=i.textBaseline,d=r.elementFonts.get(this._fontElement);i.font=d,i.textAlign=X.Center,i.textBaseline=Ue.Top,this._chord.showName&&i.fillText(this._chord.name,e+l/2,s+d.size/2),this.renderer.settings.notation.isNotationElementVisible(v.ChordDiagramFretboardNumbers)&&this._paintFretboard(e,s,i,l),i.textAlign=h,i.textBaseline=c}_paintFretboard(e,s,i,r){s+=this._textRow;const a=this.renderer.resources,l=this.renderer.smuflMetrics.chordDiagramStringSpacing,h=this.renderer.smuflMetrics.chordDiagramFretSpacing,c=a.engravingSettings.glyphHeights.get(f.FretboardFilledCircle),d=a.engravingSettings.glyphTop.get(f.FretboardFilledCircle),u=a.engravingSettings.glyphHeights.get(f.FretboardX)/2,p=a.engravingSettings.glyphHeights.get(f.FretboardO)/2,g=a.engravingSettings.chordDiagramLineWidth;i.font=a.elementFonts.get(v.ChordDiagramFretboardNumbers),i.textBaseline=Ue.Middle;for(let y=0;y<this._chord.strings.length;y++){const S=e+y*l,k=s+this._fretRow/2;let T=this._chord.strings[this._chord.strings.length-y-1];T<0?kt.fillMusicFontSymbolSafe(i,S,k+u,1,f.FretboardX,!0):T===0?kt.fillMusicFontSymbolSafe(i,S,k+p,1,f.FretboardO,!0):(T-=this._chord.firstFret-1,i.fillText(T.toString(),S,k))}s+=this._fretRow;for(let y=0;y<this._chord.strings.length;y++){const S=e+y*l;i.fillRect(S,s,g,h*Yr._frets+1)}this._chord.firstFret>1?(i.textAlign=X.Left,i.fillText(this._chord.firstFret.toString(),e-this._firstFretSpacing,s+h/2),i.fillRect(e,s,r,g)):i.fillRect(e,s-this.renderer.smuflMetrics.chordDiagramNutHeight/2,r,this.renderer.smuflMetrics.chordDiagramNutHeight);for(let y=0;y<=Yr._frets;y++){const S=s+y*h;i.fillRect(e,S,r,this.renderer.smuflMetrics.chordDiagramFretHeight)}const m=new Map;for(const y of this._chord.barreFrets){const S=[-1,-1];m.set(y-this._chord.firstFret,S)}for(let y=0;y<this._chord.strings.length;y++){let S=this._chord.strings[y];if(S>0){if(S-=this._chord.firstFret,m.has(S)){const N=m.get(S);(N[0]===-1||y<N[0])&&(N[0]=y),(N[1]===-1||y>N[1])&&(N[1]=y)}const k=s+S*h+h/2+.5,T=e+(this._chord.strings.length-y-1)*l+g/2;kt.fillMusicFontSymbolSafe(i,T,k+d-c/2,1,f.FretboardFilledCircle,!0)}}for(const[y,S]of m){const k=s+y*h+h/2+.5,T=e+(this._chord.strings.length-S[1]-1)*l,N=e+(this._chord.strings.length-S[0]-1)*l;i.fillRect(T,k-c/2,N-T,c)}}};o(Yr,"_frets",5);let jn=Yr;class Iu extends yt{get notationElement(){return v.EffectChordNames}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return Pe.SingleOnBeat}shouldCreateGlyph(t,e){return e.hasChord}createNewGlyph(t,e){return e.voice.bar.staff.track.score.stylesheet.globalDisplayChordDiagramsInScore?new jn(0,0,e.chord,v.EffectChordNames,!0):new Js(0,0,e.chord.name,t.resources.elementFonts.get(v.EffectChordNames),X.Center)}canExpand(t,e){return!1}}class Ru extends sn{constructor(e,s,i){super(oe.EndBeat);o(this,"_crescendo");this._crescendo=Jt.None,this._crescendo=i,this.x=e,this.y=s}doLayout(){super.doLayout(),this.height=this.renderer.smuflMetrics.glyphHeights.get(f.DynamicCrescendoHairpin)}paintGrouped(e,s,i,r){const a=e+this.x,l=this.height,h=this.renderer.smuflMetrics.glyphWidths.get(f.NoteheadBlack)/2;r.beginPath(),this._crescendo===Jt.Crescendo?(i-=h,r.moveTo(i,s+this.y),r.lineTo(a,s+this.y+l/2),r.lineTo(i,s+this.y+l)):(i-=h,r.moveTo(a,s+this.y),r.lineTo(i,s+this.y+l/2),r.lineTo(a,s+this.y+l));const c=r.lineWidth;r.lineWidth=this.renderer.smuflMetrics.hairpinThickness,r.stroke(),r.lineWidth=c}}class Ou extends yt{get notationElement(){return v.EffectCrescendo}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return Pe.GroupedOnBeatToEnd}shouldCreateGlyph(t,e){return e.crescendo!==Jt.None}createNewGlyph(t,e){return new Ru(0,0,e.crescendo)}canExpand(t,e){return t.crescendo===e.crescendo}}class ln extends It{constructor(e){super(0,0);o(this,"_symbols");o(this,"_scale",1);this._symbols=e}doLayout(){this.height=0;const e=this.renderer.smuflMetrics.directionsScale;this._scale=e;for(const s of this._symbols){const i=this.renderer.smuflMetrics.glyphHeights.get(s)*e;i>this.height&&(this.height=i)}}paint(e,s,i){i.fillMusicFontSymbols(e+this.x,s+this.y+this.height,this._scale,this._symbols,!0)}}class Ds extends It{constructor(e){super(0,0);o(this,"_text");this._text=e}doLayout(){const e=this.renderer.scoreRenderer.canvas;e.font=this.renderer.resources.elementFonts.get(v.EffectDirections),this.height=e.measureText(this._text).height}paint(e,s,i){const r=i.font,a=i.textBaseline,l=i.textAlign;i.font=this.renderer.resources.elementFonts.get(v.EffectDirections),i.textBaseline=Ue.Middle,i.textAlign=X.Right,i.fillText(this._text,e+this.x,s+this.y+this.height/2),i.font=r,i.textBaseline=a,i.textAlign=l}}class Wu extends Cs{constructor(e,s,i){super(e,s);o(this,"_directions");o(this,"_barBeginGlyphs",[]);o(this,"_barEndGlyphs",[]);this._directions=i}doLayout(){const e=this._directions;e.has(G.TargetSegnoSegno)&&this._barBeginGlyphs.push(new ln([f.Segno,f.Segno])),e.has(G.TargetSegno)&&this._barBeginGlyphs.push(new ln([f.Segno])),e.has(G.TargetDoubleCoda)&&this._barBeginGlyphs.push(new ln([f.Coda,f.Coda])),e.has(G.TargetCoda)&&this._barBeginGlyphs.push(new ln([f.Coda])),e.has(G.TargetFine)&&this._barEndGlyphs.push(new Ds("Fine")),e.has(G.JumpDaDoubleCoda)&&this._barEndGlyphs.push(new Ds("To Double Coda")),e.has(G.JumpDaCoda)&&this._barEndGlyphs.push(new Ds("To Coda")),e.has(G.JumpDalSegnoSegno)&&this._barEndGlyphs.push(new Ds("D.S.S.")),e.has(G.JumpDalSegnoSegnoAlCoda)&&this._barEndGlyphs.push(new Ds("D.S.S. al Coda")),e.has(G.JumpDalSegnoSegnoAlDoubleCoda)&&this._barEndGlyphs.push(new Ds("D.S.S. al Double Coda")),e.has(G.JumpDalSegnoSegnoAlFine)&&this._barEndGlyphs.push(new Ds("D.S.S. al Fine")),e.has(G.JumpDalSegno)&&this._barEndGlyphs.push(new Ds("D.S.")),e.has(G.JumpDalSegnoAlCoda)&&this._barEndGlyphs.push(new Ds("D.S. al Coda")),e.has(G.JumpDalSegnoAlDoubleCoda)&&this._barEndGlyphs.push(new Ds("D.S. al Double Coda")),e.has(G.JumpDalSegnoAlFine)&&this._barEndGlyphs.push(new Ds("D.S. al Fine")),e.has(G.JumpDaCapo)&&this._barEndGlyphs.push(new Ds("D.C.")),e.has(G.JumpDaCapoAlCoda)&&this._barEndGlyphs.push(new Ds("D.C. al Coda")),e.has(G.JumpDaCapoAlDoubleCoda)&&this._barEndGlyphs.push(new Ds("D.C. al Double Coda")),e.has(G.JumpDaCapoAlFine)&&this._barEndGlyphs.push(new Ds("D.C. al Fine"));const s=this._doSideLayout(this._barBeginGlyphs),i=this._doSideLayout(this._barEndGlyphs);this.height=Math.max(s,i)}_doSideLayout(e){let s=0;const i=this.renderer.settings.display.effectBandPaddingBottom;for(const r of e)r.y=s,r.renderer=this.renderer,r.doLayout(),s+=r.height+i;return s}paint(e,s,i){for(const r of this._barBeginGlyphs)r.paint(e+this.x,s+this.y,i);for(const r of this._barEndGlyphs)r.paint(e+this.x+this.width,s+this.y,i)}}class Vu extends yt{get notationElement(){return v.EffectDirections}get hideOnMultiTrack(){return!0}get canShareBand(){return!1}get sizingMode(){return Pe.FullBar}shouldCreateGlyph(t,e){return e.voice.index===0&&e.index===0&&e.voice.bar.masterBar.directions!==null&&e.voice.bar.masterBar.directions.size>0}createNewGlyph(t,e){return new Wu(0,0,e.voice.bar.masterBar.directions)}canExpand(t,e){return!0}}class Ht extends Cs{constructor(e,s,i,r){super(e,s);o(this,"glyphScale",0);o(this,"symbol");o(this,"center",!1);o(this,"colorOverride");o(this,"offsetX",0);o(this,"offsetY",0);this.glyphScale=i,this.symbol=r}getBoundingBoxTop(){const e=this.renderer.smuflMetrics.glyphTop.get(this.symbol);return this.y-this.offsetY-e}doLayout(){this.width=this.renderer.smuflMetrics.glyphWidths.get(this.symbol)*this.glyphScale,this.height=this.renderer.smuflMetrics.glyphHeights.get(this.symbol)*this.glyphScale}paint(e,s,i){if(this.width===0&&this.height===0)return;const r=i.color;this.colorOverride&&(i.color=this.colorOverride),i.fillMusicFontSymbol(e+this.x+this.offsetX,s+this.y+this.offsetY,this.glyphScale,this.symbol,this.center),i.color=r}}class Hu extends Cs{constructor(e,s,i,r){super(e,s);o(this,"glyphScale",0);o(this,"symbols");o(this,"center",!1);o(this,"colorOverride");o(this,"offsetX",0);o(this,"offsetY",0);this.glyphScale=i,this.symbols=r}getBoundingBoxTop(){let e=0;for(let s=0;s<this.symbols.length;s++){const i=this.renderer.smuflMetrics.glyphTop.get(this.symbols[s]);(s===0||i<e)&&(e=i)}return this.y-this.offsetY-e}doLayout(){this.width=0,this.height=0;for(let e=0;e<this.symbols.length;e++){const s=this.renderer.smuflMetrics.glyphWidths.get(this.symbols[e])*this.glyphScale,i=this.renderer.smuflMetrics.glyphHeights.get(this.symbols[e])*this.glyphScale;(e===0||s>this.width)&&(this.width=s),(e===0||i>this.height)&&(this.height=i)}}paint(e,s,i){if(this.width===0&&this.height===0)return;const r=i.color;this.colorOverride&&(i.color=this.colorOverride),i.fillMusicFontSymbols(e+this.x+this.offsetX,s+this.y+this.offsetY,this.glyphScale,this.symbols,this.center),i.color=r}}class bh extends Ht{constructor(t,e,s){super(t,e,1,bh._getSymbol(s))}doLayout(){super.doLayout(),this.center=!0,this.height=this.renderer.smuflMetrics.glyphHeights.get(f.DynamicForte);const t=this.renderer.smuflMetrics.glyphTop.get(f.DynamicForte);this.offsetY=t}static _getSymbol(t){switch(t){case re.PPP:return f.DynamicPPP;case re.PP:return f.DynamicPP;case re.P:return f.DynamicPiano;case re.MP:return f.DynamicMP;case re.MF:return f.DynamicMF;case re.F:return f.DynamicForte;case re.FF:return f.DynamicFF;case re.FFF:return f.DynamicFFF;case re.PPPP:return f.DynamicPPPP;case re.PPPPP:return f.DynamicPPPPP;case re.PPPPPP:return f.DynamicPPPPP;case re.FFFF:return f.DynamicFFFF;case re.FFFFF:return f.DynamicFFFFF;case re.FFFFFF:return f.DynamicFFFFFF;case re.SF:return f.DynamicSforzando1;case re.SFP:return f.DynamicSforzandoPiano;case re.SFPP:return f.DynamicSforzandoPianissimo;case re.FP:return f.DynamicFortePiano;case re.RF:return f.DynamicRinforzando1;case re.RFZ:return f.DynamicRinforzando2;case re.SFZ:return f.DynamicSforzato;case re.SFFZ:return f.DynamicSforzatoFF;case re.FZ:return f.DynamicForzando;case re.N:return f.DynamicNiente;case re.PF:return f.DynamicPF;case re.SFZP:return f.DynamicSforzatoPiano;default:return f.None}}}class Gu extends yt{get notationElement(){return v.EffectDynamics}get hideOnMultiTrack(){return!1}get canShareBand(){return!1}get sizingMode(){return Pe.SingleOnBeat}shouldCreateGlyph(t,e){return this._internalShouldCreateGlyph(e)}_internalShouldCreateGlyph(t){if(t.voice.bar.staff.track.score.stylesheet.hideDynamics||t.isEmpty||t.voice.isEmpty||t.isRest)return!1;const e=this._getPreviousDynamicsBeat(t);let s=t.voice.index===0&&!e||t.dynamics!==(e==null?void 0:e.dynamics);if(s&&t.voice.index>0){for(const i of t.voice.bar.voices)if(i.index<t.voice.index){const r=i.getBeatAtPlaybackStart(t.playbackStart);r&&t.dynamics===r.dynamics&&this._internalShouldCreateGlyph(r)&&(s=!1)}}return s}_getPreviousDynamicsBeat(t){let e=t.previousBeat;for(;e!=null;){if(!e.isRest)return e;e=e.previousBeat}return null}createNewGlyph(t,e){return new bh(0,0,e.dynamics)}canExpand(t,e){return!0}}class Sh extends Ht{constructor(t){super(0,0,1,Sh._getSymbol(t)),this.center=!0}static _getSymbol(t){switch(t){case Nt.FadeIn:return f.GuitarFadeIn;case Nt.FadeOut:return f.GuitarFadeOut;case Nt.VolumeSwell:return f.GuitarVolumeSwell}return f.None}paint(t,e,s){super.paint(t,e+this.height,s)}}class Yh extends yt{get notationElement(){return v.EffectFadeIn}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return Pe.SingleOnBeat}shouldCreateGlyph(t,e){return e.fade!==Nt.None}createNewGlyph(t,e){return new Sh(e.fade)}canExpand(t,e){return!0}}class _h extends Ht{constructor(t,e,s){super(t,e,1,_h._getSymbol(s))}static _getSymbol(t){switch(t){case Ss.Short:return f.FermataShortAbove;case Ss.Medium:return f.FermataAbove;case Ss.Long:return f.FermataLongAbove;default:return f.None}}paint(t,e,s){super.paint(t-this.width/2,e+this.height,s)}}class Uu extends yt{get notationElement(){return v.EffectFermata}get hideOnMultiTrack(){return!1}get canShareBand(){return!1}get sizingMode(){return Pe.SingleOnBeat}shouldCreateGlyph(t,e){return e.voice.index===0&&!!e.fermata}createNewGlyph(t,e){return new _h(0,0,e.fermata.type)}canExpand(t,e){return!0}}class mi extends It{constructor(){super(...arguments);o(this,"glyphs",null)}get isEmpty(){return!this.glyphs||this.glyphs.length===0}getBoundingBoxTop(){let e=Number.NaN;const s=this.glyphs;if(s)for(const i of s)e=A.minBoundingBox(e,i.getBoundingBoxTop());return e}getBoundingBoxBottom(){let e=Number.NaN;const s=this.glyphs;if(s)for(const i of s)e=A.maxBoundingBox(e,i.getBoundingBoxBottom());return e}doLayout(){if(!this.glyphs||this.glyphs.length===0){this.width=0;return}let e=0,s=0;for(let i=0,r=this.glyphs.length;i<r;i++){const a=this.glyphs[i];a.renderer=this.renderer,a.doLayout(),e=Math.max(e,a.width),s=Math.max(s,a.y+a.height)}this.width=e,this.height=s}addGlyph(e){this.glyphs||(this.glyphs=[]),this.renderer&&(e.renderer=this.renderer),this.glyphs.push(e)}paint(e,s,i){const r=this.glyphs;if(!(!r||r.length===0))for(const a of r)a.paint(e+this.x,s+this.y,i)}}class ve{static score(t,e,s,i=!1){if(!s.style&&!i)return;const r=ve._scoreDefaultColor(t.settings.display.resources,e);return new Or(t,e,s.style,r)}static scoreColor(t,e,s){const i=ve._scoreDefaultColor(t,e);if(s.style&&s.style.colors.has(e))return s.style.colors.get(e)??i}static _scoreDefaultColor(t,e){return t.mainGlyphColor}static bar(t,e,s,i=!1){if(!s.style&&!i)return;let r=t.settings.display.resources.mainGlyphColor;switch(e){case Ae.StandardNotationRepeats:case Ae.GuitarTabsRepeats:case Ae.SlashRepeats:case Ae.NumberedRepeats:case Ae.StandardNotationClef:case Ae.GuitarTabsClef:case Ae.StandardNotationKeySignature:case Ae.NumberedKeySignature:case Ae.StandardNotationTimeSignature:case Ae.GuitarTabsTimeSignature:case Ae.SlashTimeSignature:case Ae.NumberedTimeSignature:break;case Ae.StandardNotationBarLines:case Ae.GuitarTabsBarLines:case Ae.SlashBarLines:case Ae.NumberedBarLines:r=t.settings.display.resources.barSeparatorColor;break;case Ae.StandardNotationBarNumber:case Ae.SlashBarNumber:case Ae.NumberedBarNumber:case Ae.GuitarTabsBarNumber:r=t.settings.display.resources.barNumberColor;break;case Ae.StandardNotationStaffLine:case Ae.GuitarTabsStaffLine:case Ae.SlashStaffLine:case Ae.NumberedStaffLine:r=t.settings.display.resources.staffLineColor;break}return new Or(t,e,s.style,r)}static voice(t,e,s,i=!1){if(!s.style&&!i)return;const r=s.index===0?t.settings.display.resources.mainGlyphColor:t.settings.display.resources.secondaryGlyphColor;return new Or(t,e,s.style,r)}static trackColor(t,e,s){const i=ve._trackDefaultColor(t,e);if(s.style&&s.style.colors.has(e))return s.style.colors.get(e)??i}static _trackDefaultColor(t,e){let s=t.mainGlyphColor;switch(e){case fi.TrackName:case fi.SystemSeparator:case fi.StringTuning:break;case fi.BracesAndBrackets:s=t.barSeparatorColor;break}return s}static track(t,e,s,i=!1){if(!s.style&&!i)return;const r=ve._trackDefaultColor(t.settings.display.resources,e);return new Or(t,e,s.style,r)}static beatColor(t,e,s){const i=ve._beatDefaultColor(t,e,s);if(s.style&&s.style.colors.has(e))return s.style.colors.get(e)??i}static _beatDefaultColor(t,e,s){return s.voice.index===0?t.mainGlyphColor:t.secondaryGlyphColor}static beat(t,e,s,i=!1){if(!s.style&&!i)return;const r=ve._beatDefaultColor(t.settings.display.resources,e,s);return new Or(t,e,s.style,r)}static noteColor(t,e,s){const i=ve._noteDefaultColor(t,e,s);if(s.style&&s.style.colors.has(e))return s.style.colors.get(e)??i}static _noteDefaultColor(t,e,s){return s.beat.voice.index===0?t.mainGlyphColor:t.secondaryGlyphColor}static note(t,e,s,i=!1){if(!s.style&&!i)return;const r=s.beat.voice.index===0?t.settings.display.resources.mainGlyphColor:t.settings.display.resources.secondaryGlyphColor;return new Or(t,e,s.style,r)}}class Or{constructor(t,e,s,i){o(this,"_canvas");o(this,"_previousColor");this._canvas=t,s&&s.colors.has(e)?(this._previousColor=t.color,t.color=s.colors.get(e)??i):s||(this._previousColor=t.color,t.color=i)}[Symbol.dispose](){this._previousColor&&(this._canvas.color=this._previousColor)}}class zu{constructor(t,e){o(this,"line",0);o(this,"symbols");o(this,"color");this.line=t,this.symbols=e}}class Xa extends mi{constructor(){super(0,0);o(this,"_infos",new Map)}get isEmpty(){return this._infos.size===0}addFingers(e){const s=this.renderer.settings;if(s.notation.fingeringMode!==di.ScoreDefault&&s.notation.fingeringMode!==di.ScoreForcePiano)return;const i=Xa.fingerToMusicFontSymbol(this.renderer.settings,e.beat,e.leftHandFinger,!0);i!==f.None&&this._addFinger(e,i);const r=Xa.fingerToMusicFontSymbol(this.renderer.settings,e.beat,e.rightHandFinger,!1);r!==f.None&&this._addFinger(e,r)}static fingerToMusicFontSymbol(e,s,i,r){if(e.notation.fingeringMode===di.ScoreForcePiano||e.notation.fingeringMode===di.SingleNoteEffectBandForcePiano||ui.isPiano(s.voice.bar.staff.track.playbackInfo.program))switch(i){case ae.Unknown:case ae.NoOrDead:return f.None;case ae.Thumb:return f.Fingering1;case ae.IndexFinger:return f.Fingering2;case ae.MiddleFinger:return f.Fingering3;case ae.AnnularFinger:return f.Fingering4;case ae.LittleFinger:return f.Fingering5;default:return f.None}if(r)switch(i){case ae.Unknown:return f.None;case ae.NoOrDead:return f.Fingering0;case ae.Thumb:return f.FingeringTLower;case ae.IndexFinger:return f.Fingering1;case ae.MiddleFinger:return f.Fingering2;case ae.AnnularFinger:return f.Fingering3;case ae.LittleFinger:return f.Fingering4;default:return f.None}switch(i){case ae.Unknown:case ae.NoOrDead:return f.None;case ae.Thumb:return f.FingeringPLower;case ae.IndexFinger:return f.FingeringILower;case ae.MiddleFinger:return f.FingeringMLower;case ae.AnnularFinger:return f.FingeringALower;case ae.LittleFinger:return f.FingeringCLower;default:return f.None}}_addFinger(e,s){const i=this.renderer,r=i.getNoteSteps(e);if(this._infos.has(r))this._infos.get(r).symbols.push(s);else{const a=new zu(r,[s]);a.color=ve.noteColor(i.resources,ns.StandardNotationEffects,e),this._infos.set(r,a)}}doLayout(){const e=this.renderer;for(const[s,i]of this._infos){const r=new Hu(0,0,1,i.symbols);r.colorOverride=i.color,r.renderer=e,r.y=e.getScoreY(i.line),r.doLayout(),r.offsetY=r.height/2,this.addGlyph(r),this.width=Math.max(this.width,r.width)}for(const s of this.glyphs){const i=s;i.x=this.width/2,i.center=!0}}}class Yu extends yt{get notationElement(){return v.EffectFingering}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return Pe.SingleOnBeat}shouldCreateGlyph(t,e){return e.voice.index!==0||e.isRest||t.notation.fingeringMode!==di.SingleNoteEffectBand&&t.notation.fingeringMode!==di.SingleNoteEffectBandForcePiano||e.notes.length!==1?!1:e.notes[0].isFingering}createNewGlyph(t,e){let s=ae.Unknown,i=!1;const r=e.notes[0];r.leftHandFinger!==ae.Unknown?(s=r.leftHandFinger,i=!0):r.rightHandFinger!==ae.Unknown&&(s=r.rightHandFinger);const a=Xa.fingerToMusicFontSymbol(t.settings,e,s,i),l=new Ht(0,0,1,a);return l.center=!0,l.renderer=t,l.doLayout(),l.offsetY=t.smuflMetrics.glyphTop.get(l.symbol),l}canExpand(t,e){return!0}}class Xu extends yt{get notationElement(){return v.EffectText}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return Pe.SinglePreBeat}shouldCreateGlyph(t,e){const s=e.voice.bar.masterBar;return e.voice.bar.staff.index===0&&e.voice.index===0&&e.index===0&&s.isFreeTime&&(s.index===0||s.isFreeTime!==s.previousMasterBar.isFreeTime)}createNewGlyph(t,e){return new Js(0,0,"Free time",t.resources.elementFonts.get(v.EffectFreeTime),X.Left)}canExpand(t,e){return!0}}class Fc extends Ht{constructor(t,e,s=!1){super(t,e,Ze.GraceScale,f.GuitarGolpe),this.center=s}doLayout(){super.doLayout(),this.offsetY=this.height}}class hn extends yt{constructor(e){super();o(this,"_type");this._type=e}get notationElement(){return v.EffectGolpe}get effectId(){return`${super.effectId}.${as[this._type]}`}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return Pe.SingleOnBeat}shouldCreateGlyph(e,s){return s.golpe===this._type}createNewGlyph(e,s){return new Fc(0,0,!0)}canExpand(e,s){return!1}}class Ir extends yt{constructor(){super(...arguments);o(this,"lastCreateInfo",null)}shouldCreateGlyph(e,s){this.lastCreateInfo=[];for(let i=0,r=s.notes.length;i<r;i++){const a=s.notes[i];this.shouldCreateGlyphForNote(a)&&this.lastCreateInfo.push(a)}return this.lastCreateInfo.length>0}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}canExpand(e,s){return!0}}class Qi extends Ir{constructor(e){super();o(this,"_harmonicType");o(this,"_beat",null);o(this,"_effectId");switch(this._harmonicType=e,e){case ie.None:this._effectId="harmonics-none";break;case ie.Natural:this._effectId="harmonics-natural";break;case ie.Artificial:this._effectId="harmonics-artificial";break;case ie.Pinch:this._effectId="harmonics-pinch";break;case ie.Tap:this._effectId="harmonics-tap";break;case ie.Semi:this._effectId="harmonics-semi";break;case ie.Feedback:this._effectId="harmonics-feedback";break;default:this._effectId="";break}}get effectId(){return this._effectId}get notationElement(){return v.EffectHarmonics}shouldCreateGlyphForNote(e){return!e.isHarmonic||e.harmonicType!==this._harmonicType?!1:(e.beat!==this._beat&&(this._beat=e.beat),!0)}get sizingMode(){return Pe.GroupedOnBeat}createNewGlyph(e,s){return new Ar(Qi.harmonicToString(this._harmonicType),v.EffectHarmonics)}static harmonicToString(e){switch(e){case ie.Natural:return"N.H.";case ie.Artificial:return"A.H.";case ie.Pinch:return"P.H.";case ie.Tap:return"T.H.";case ie.Semi:return"S.H.";case ie.Feedback:return"Fdbk."}return""}}class $u extends Ht{constructor(){super(0,0,1,f.GuitarLeftHandTapping),this.center=!0}doLayout(){super.doLayout(),this.offsetY=this.renderer.smuflMetrics.glyphTop.get(this.symbol)}}class Xh extends Ir{get notationElement(){return v.EffectTap}get sizingMode(){return Pe.SingleOnBeat}shouldCreateGlyphForNote(t){return t.isLeftHandTapped}createNewGlyph(t,e){return new $u}}class $h extends yt{get notationElement(){return v.EffectLetRing}get canShareBand(){return!1}get hideOnMultiTrack(){return!1}shouldCreateGlyph(t,e){return e.isLetRing}get sizingMode(){return Pe.GroupedOnBeat}createNewGlyph(t,e){return new Ar("LetRing",v.EffectLetRing)}canExpand(t,e){return!0}}class Ju extends Cs{constructor(e,s,i,r,a=X.Center){super(e,s);o(this,"_lines");o(this,"_linePositions",[]);o(this,"font");o(this,"textAlign");this._lines=i,this.font=r,this.textAlign=a}doLayout(){super.doLayout();const e=this.renderer.settings.display.lyricLinesPaddingBetween,s=this.renderer.scoreRenderer.canvas;s.font=this.font;let i=0;for(const r of this._lines){this._linePositions.push(i);const a=s.measureText(r.length>0?r:" ");i+=a.height+e}i-=e,this.height=i}paint(e,s,i){i.font=this.font;const r=i.textAlign;i.textAlign=this.textAlign;for(let a=0;a<this._lines.length;a++)this._lines[a]&&i.fillText(this._lines[a],e+this.x,s+this.y+this._linePositions[a]);i.textAlign=r}}class qu extends yt{get notationElement(){return v.EffectLyrics}get hideOnMultiTrack(){return!1}get canShareBand(){return!1}get sizingMode(){return Pe.SingleOnBeat}shouldCreateGlyph(t,e){return!!e.lyrics}createNewGlyph(t,e){return new Ju(0,0,e.lyrics,t.resources.elementFonts.get(v.EffectLyrics),X.Center)}canExpand(t,e){return!0}}class Qu extends yt{get notationElement(){return v.EffectMarker}get hideOnMultiTrack(){return!0}get canShareBand(){return!0}get sizingMode(){return Pe.SinglePreBeat}shouldCreateGlyph(t,e){return e.voice.bar.staff.index===0&&e.voice.index===0&&e.index===0&&e.voice.bar.masterBar.isSectionStart}createNewGlyph(t,e){return new Js(0,0,e.voice.bar.masterBar.section.marker?`[${e.voice.bar.masterBar.section.marker}] ${e.voice.bar.masterBar.section.text}`:e.voice.bar.masterBar.section.text,t.resources.elementFonts.get(v.EffectMarker),X.Left)}canExpand(t,e){return!0}}class kh extends Ht{constructor(t){super(0,0,1,kh._getSymbol(t)),this.center=!0}static _getSymbol(t){switch(t){case ut.InvertedTurn:return f.OrnamentTurnInverted;case ut.Turn:return f.OrnamentTurn;case ut.UpperMordent:return f.OrnamentShortTrill;case ut.LowerMordent:return f.OrnamentMordent}return f.None}doLayout(){super.doLayout(),this.height=this.renderer.smuflMetrics.glyphHeights.get(f.OrnamentMordent),this.offsetY=this.renderer.smuflMetrics.glyphTop.get(f.OrnamentMordent)}}class Ku extends yt{get notationElement(){return v.EffectNoteOrnament}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return Pe.SingleOnBeat}shouldCreateGlyph(t,e){return e.notes.some(s=>s.ornament!==ut.None)}createNewGlyph(t,e){return new kh(e.notes.find(s=>s.ornament!==ut.None).ornament)}canExpand(t,e){return!1}}class Ci extends Ht{constructor(t,e,s,i){super(t,e,i,Ci.getMusicSymbol(s))}static getMusicSymbol(t){switch(t){case he.Natural:return f.AccidentalNatural;case he.Sharp:return f.AccidentalSharp;case he.Flat:return f.AccidentalFlat;case he.NaturalQuarterNoteUp:return f.AccidentalQuarterToneSharpNaturalArrowUp;case he.SharpQuarterNoteUp:return f.AccidentalThreeQuarterTonesSharpArrowUp;case he.FlatQuarterNoteUp:return f.AccidentalQuarterToneFlatArrowUp;case he.DoubleSharp:return f.AccidentalDoubleSharp;case he.DoubleFlat:return f.AccidentalDoubleFlat}return f.None}}class Zu extends Cs{constructor(e,s,i,r){super(e,s);o(this,"_keySignature");o(this,"_keySignatureType");o(this,"_text","");o(this,"_accidental",he.None);o(this,"_accidentalOffset",0);o(this,"_padding",0);this._keySignature=i,this._keySignatureType=r}doLayout(){super.doLayout();let e="",s="",i=he.None;switch(this._keySignatureType){case cs.Major:switch(e="1 = ",this._keySignature){case Ke.Cb:s="  C",i=he.Flat;break;case Ke.Gb:s="  G",i=he.Flat;break;case Ke.Db:s="  D",i=he.Flat;break;case Ke.Ab:s="  A",i=he.Flat;break;case Ke.Eb:s="  E",i=he.Flat;break;case Ke.Bb:s="  B",i=he.Flat;break;case Ke.F:s="F";break;case Ke.C:s="C",i=he.None;break;case Ke.G:s="G",i=he.None;break;case Ke.D:s="D",i=he.None;break;case Ke.A:s="A",i=he.None;break;case Ke.E:s="E",i=he.None;break;case Ke.B:s="B",i=he.None;break;case Ke.FSharp:s="  F",i=he.Sharp;break;case Ke.CSharp:s="  C",i=he.Sharp;break}break;case cs.Minor:switch(e="6 = ",this._keySignature){case Ke.Cb:s="  a",i=he.Flat;break;case Ke.Gb:s="  e",i=he.Flat;break;case Ke.Db:s="  b",i=he.Flat;break;case Ke.Ab:s="f",i=he.None;break;case Ke.Eb:s="c",i=he.None;break;case Ke.Bb:s="g",i=he.None;break;case Ke.F:s="d";break;case Ke.C:s="a",i=he.None;break;case Ke.G:s="e",i=he.None;break;case Ke.D:s="b",i=he.None;break;case Ke.A:s="  f",i=he.Sharp;break;case Ke.E:s="  c",i=he.Sharp;break;case Ke.B:s="  g",i=he.Sharp;break;case Ke.FSharp:s="  d",i=he.Sharp;break;case Ke.CSharp:s="  a",i=he.Sharp;break}break}this._text=e+s,this._accidental=i;const r=this.renderer.scoreRenderer.canvas,a=this.renderer.settings,l=a.display.resources;r.font=l.numberedNotationFont,this._accidentalOffset=r.measureText(e).width;const h=r.measureText(e+s);this._padding=this.renderer.index===0?a.display.firstStaffPaddingLeft:a.display.staffPaddingLeft,this.width=this._padding+h.width,this.height=h.height}paint(e,s,i){var a;const r=ve.bar(i,Ae.NumberedKeySignature,this.renderer.bar);try{const l=this.renderer.resources;i.font=l.numberedNotationFont,i.textBaseline=Ue.Alphabetic,i.fillText(this._text,e+this.x+this._padding,s+this.y+this.height),this._accidental!==he.None&&kt.fillMusicFontSymbolSafe(i,e+this.x+this._padding+this._accidentalOffset,s+this.y+this.height,1,Ci.getMusicSymbol(this._accidental),!1)}finally{(a=r==null?void 0:r[Symbol.dispose])==null||a.call(r)}}}class ju extends yt{get notationElement(){return v.EffectNumberedNotationKeySignature}get hideOnMultiTrack(){return!1}get canShareBand(){return!1}get sizingMode(){return Pe.FullBar}shouldCreateGlyph(t,e){const s=e.voice.bar;return e.index===0&&e.voice.index===0&&(!s.previousBar||s.keySignature!==s.previousBar.keySignature)}createNewGlyph(t,e){return new Zu(0,0,t.bar.keySignature,t.bar.keySignatureType)}canExpand(t,e){return!1}}class ef extends sn{constructor(e,s){super(oe.PostNotes);o(this,"_ottava");o(this,"_aboveStaff");this._ottava=e,this._aboveStaff=s}doLayout(){super.doLayout(),this.height=this.renderer.smuflMetrics.glyphHeights.get(f.QuindicesimaAlta)}paintNonGrouped(e,s,i){this._paintOttava(e,s,i)}_paintOttava(e,s,i){let r=0;switch(this._ottava){case pe._15ma:r=this.renderer.smuflMetrics.glyphWidths.get(f.QuindicesimaAlta),kt.fillMusicFontSymbolSafe(i,e+this.x-r/2,s+this.y+this.height,1,f.QuindicesimaAlta,!1);break;case pe._8va:r=this.renderer.smuflMetrics.glyphWidths.get(f.OttavaAlta),kt.fillMusicFontSymbolSafe(i,e+this.x-r/2,s+this.y+this.height,1,f.OttavaAlta,!1);break;case pe._8vb:r=this.renderer.smuflMetrics.glyphWidths.get(f.OttavaBassaVb),kt.fillMusicFontSymbolSafe(i,e+this.x-r/2,s+this.y+this.height,1,f.OttavaBassaVb,!1);break;case pe._15mb:r=(this.renderer.smuflMetrics.glyphWidths.get(f.Quindicesima)+this.renderer.smuflMetrics.glyphWidths.get(f.OctaveBaselineM)+this.renderer.smuflMetrics.glyphWidths.get(f.OctaveBaselineB))*1,kt.fillMusicFontSymbolsSafe(i,e+this.x-r/2,s+this.y+this.height,1,[f.Quindicesima,f.OctaveBaselineM,f.OctaveBaselineB],!1);break}return r/2}paintGrouped(e,s,i,r){const a=this._paintOttava(e,s,r),l=this.renderer.smuflMetrics.lineRangedGlyphDashGap,h=e+this.x+a+l;let c=s+this.y;const d=this.height*.5;c+=this._aboveStaff?0:this.height;const u=this.renderer.smuflMetrics.lineRangedGlyphDashSize,p=r.lineWidth;if(r.lineWidth=this.renderer.smuflMetrics.octaveLineThickness,i>h){let g=h;for(;g<i;)r.beginPath(),r.moveTo(g,c|0),r.lineTo(Math.min(g+u,i),c|0),g+=u+l,r.stroke();r.beginPath(),this._aboveStaff?(r.moveTo(i,c),r.lineTo(i,c+d)):(r.moveTo(i,c),r.lineTo(i,c-d)),r.stroke()}r.lineWidth=p}}class tf extends yt{constructor(e){super();o(this,"_aboveStaff");this._aboveStaff=e}get effectId(){return`ottavia-${this._aboveStaff?"above":"below"}`}get notationElement(){return v.EffectOttavia}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return Pe.GroupedOnBeat}shouldCreateGlyph(e,s){switch(s.ottava){case pe._15ma:return this._aboveStaff;case pe._8va:return this._aboveStaff;case pe._8vb:return!this._aboveStaff;case pe._15mb:return!this._aboveStaff}return!1}createNewGlyph(e,s){return new ef(s.ottava,this._aboveStaff)}canExpand(e,s){return e.ottava===s.ottava}}class sf extends Ir{get notationElement(){return v.EffectPalmMute}shouldCreateGlyphForNote(t){return t.isPalmMute}get sizingMode(){return Pe.GroupedOnBeat}createNewGlyph(t,e){return new Ar("P.M.",v.EffectPalmMute)}}class Jh extends Ir{get notationElement(){return v.EffectPickSlide}shouldCreateGlyphForNote(t){return t.slideOutType===ge.PickSlideDown||t.slideOutType===ge.PickSlideUp}get sizingMode(){return Pe.GroupedOnBeat}createNewGlyph(t,e){return new Ar("P.S.",v.EffectPickSlide)}}class $a extends Ht{constructor(t,e,s){super(t,e,Ze.GraceScale,$a._getSymbol(s)),this.center=!0}doLayout(){super.doLayout(),this.offsetY=this.height}static _getSymbol(t){switch(t){case Ot.Up:return f.StringsUpBow;case Ot.Down:return f.StringsDownBow;default:return f.None}}}class qh extends yt{get notationElement(){return v.EffectPickStroke}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return Pe.SingleOnBeat}shouldCreateGlyph(t,e){return e.pickStroke!==Ot.None}createNewGlyph(t,e){return new $a(0,0,e.pickStroke)}canExpand(t,e){return!0}}class rf extends yt{get notationElement(){return v.EffectRasgueado}get canShareBand(){return!1}get hideOnMultiTrack(){return!1}shouldCreateGlyph(t,e){return e.hasRasgueado}get sizingMode(){return Pe.GroupedOnBeat}createNewGlyph(t,e){return new Ar("rasg.",v.EffectRasgueado)}canExpand(t,e){return!0}}class eo extends It{constructor(e,s,i){super(0,0);o(this,"_uniqueEffectGlyphs",[]);o(this,"_effectGlyphs",[]);o(this,"_container");o(this,"isEmpty",!0);o(this,"previousBand",null);o(this,"isLinkedToPrevious",!1);o(this,"firstBeat",null);o(this,"lastBeat",null);o(this,"height",0);o(this,"originalHeight",0);o(this,"voice");o(this,"info");o(this,"slot",null);this.voice=e,this.info=s,this._container=i}*iterateAllGlyphs(){for(const e of this._effectGlyphs)for(const s of e.values())yield s}finalizeBand(){this.info.finalizeBand(this)}doLayout(){super.doLayout();for(let e=0;e<this.renderer.bar.voices.length;e++)this._effectGlyphs.push(new Map),this._uniqueEffectGlyphs.push([])}static shouldCreateGlyph(e,s,i){return s.shouldCreateGlyph(i.settings,e)&&(!s.hideOnMultiTrack||i.staff.trackIndex===0)}createGlyph(e){if(e.voice===this.voice&&eo.shouldCreateGlyph(e,this.info,this.renderer)){if(this.isEmpty=!1,(!this.firstBeat||e.isBefore(this.firstBeat))&&(this.firstBeat=e),!this.lastBeat||e.isAfter(this.lastBeat))switch(this.lastBeat=e,this.info.sizingMode){case Pe.SingleOnBeatToEnd:case Pe.GroupedOnBeatToEnd:this.lastBeat.nextBeat&&(this.lastBeat=this.lastBeat.nextBeat);break}const s=this._createOrResizeGlyph(this.info.sizingMode,e);s.height>this.height&&(this.height=s.height,this.originalHeight=s.height)}}resetHeight(){this.height=this.originalHeight}_createOrResizeGlyph(e,s){let i;switch(e){case Pe.FullBar:return i=this.info.createNewGlyph(this.renderer,s),i.renderer=this.renderer,i.beat=s,i.doLayout(),this._effectGlyphs[s.voice.index].set(s.index,i),this._uniqueEffectGlyphs[s.voice.index].push(i),i;case Pe.SinglePreBeat:case Pe.SingleOnBeat:case Pe.SingleOnBeatToEnd:return i=this.info.createNewGlyph(this.renderer,s),i.renderer=this.renderer,i.beat=s,i.doLayout(),this._effectGlyphs[s.voice.index].set(s.index,i),this._uniqueEffectGlyphs[s.voice.index].push(i),i;case Pe.GroupedOnBeat:case Pe.GroupedOnBeatToEnd:const r=e===Pe.GroupedOnBeat?Pe.SingleOnBeat:Pe.SingleOnBeatToEnd;if(s.index>0||this.renderer.index>0){const a=s.previousBeat;if(this.info.shouldCreateGlyph(this.renderer.settings,a)){let l=null;if(s.index>0&&this._effectGlyphs[s.voice.index].has(a.index))l=this._effectGlyphs[s.voice.index].get(a.index);else if(this.renderer.index>0){const d=this._container.previousContainer.getBand(a.voice,this.info.effectId);if(d){const u=d._effectGlyphs[a.voice.index];u.has(a.index)&&(l=u.get(a.index))}}const h=this._createOrResizeGlyph(r,s);return l&&this.info.canExpand(a,s)&&(l.nextGlyph=h,h.previousGlyph=l,this.isLinkedToPrevious=!0),h}return this._createOrResizeGlyph(r,s)}return this._createOrResizeGlyph(r,s);default:return this._createOrResizeGlyph(Pe.SingleOnBeat,s)}}paint(e,s,i){var r;super.paint(e,s,i);for(let a=0,l=this._uniqueEffectGlyphs.length;a<l;a++){const h=this._uniqueEffectGlyphs[a];for(let c=0,d=h.length;c<d;c++){const u=h[c],p=ve.beat(i,ht.Effects,u.beat,!1);try{u.paint(e+this.x,s+this.y,i)}finally{(r=p==null?void 0:p[Symbol.dispose])==null||r.call(p)}}}}alignGlyphs(){for(let e=0;e<this._effectGlyphs.length;e++)for(const s of this._effectGlyphs[e].keys()){const i=this.renderer.bar.voices[e].beats[s];this._alignGlyph(this.info.sizingMode,i)}this.info.onAlignGlyphs(this)}_alignGlyph(e,s){const i=this._effectGlyphs[s.voice.index].get(s.index),r=this.renderer.getBeatContainer(s);switch(e){case Pe.SinglePreBeat:const a=this.renderer.layoutingInfo.getPreBeatSize(s);i.x=this.renderer.beatGlyphsStart+r.x+r.onTimeX-a;break;case Pe.SingleOnBeat:case Pe.GroupedOnBeat:i.x=this.renderer.beatGlyphsStart+r.x+r.onTimeX;break;case Pe.SingleOnBeatToEnd:case Pe.GroupedOnBeatToEnd:if(i.x=this.renderer.beatGlyphsStart+r.x+r.onTimeX,r.isLastOfVoice)i.width=this.renderer.width-i.x;else{const l=this.renderer.layoutingInfo.getPostBeatSize(s);i.width=l}break;case Pe.FullBar:i.width=this.renderer.width;break}}}class af{constructor(){o(this,"uniqueEffectId",null);o(this,"y",0);o(this,"height",0);o(this,"firstBeat",null);o(this,"lastBeat",null)}}class nf{constructor(){o(this,"bands");o(this,"shared");this.bands=[],this.shared=new af}update(t){t.info.canShareBand||(this.shared.uniqueEffectId=t.info.effectId),t.slot=this,this.bands.push(t),t.height>this.shared.height&&(this.shared.height=t.height),(!this.shared.firstBeat||t.firstBeat.isBefore(this.shared.firstBeat))&&(this.shared.firstBeat=t.firstBeat),(!this.shared.lastBeat||t.lastBeat.isAfter(this.shared.lastBeat))&&(this.shared.lastBeat=t.lastBeat)}canBeUsed(t){return!this.shared.uniqueEffectId&&t.info.canShareBand||t.info.effectId===this.shared.uniqueEffectId?!!(!this.shared.firstBeat||this.shared.lastBeat===t.firstBeat||this.shared.lastBeat.isBefore(t.firstBeat)||this.shared.lastBeat.isBefore(this.shared.firstBeat)):!1}}class of{constructor(t){o(this,"_effectSlot");o(this,"_assignedSlots");o(this,"slots");o(this,"owner");this.slots=[],this._effectSlot=new Map,this._assignedSlots=new Map,this.owner=t}reset(){this._effectSlot.clear(),this._assignedSlots.clear(),this.slots=[]}getOrCreateSlot(t){if(this._assignedSlots.has(t))return this._assignedSlots.get(t);if(this._effectSlot.has(t.info.effectId)){const s=this._effectSlot.get(t.info.effectId);if(s.canBeUsed(t))return this._assignedSlots.set(t,s),s}for(const s of this.slots)if(s.canBeUsed(t))return this._assignedSlots.set(t,s),s;const e=new nf;return this.slots.push(e),this._assignedSlots.set(t,e),e}register(t){const e=this.getOrCreateSlot(t);e.update(t),this._effectSlot.set(t.info.effectId,e)}sortSlots(t){for(const e of this.slots)e.bands.sort((s,i)=>{const r=t.get(s.info),a=t.get(i.info);return r-a});this.slots.sort((e,s)=>{const i=t.get(e.bands[0].info),r=t.get(s.bands[0].info);return i-r})}}class Qh{constructor(t,e){o(this,"_bands",[]);o(this,"_bandLookup",new Map);o(this,"_effectBandSizingInfo",null);o(this,"_effectInfosSortOrder",new Map);o(this,"height",0);o(this,"infos");o(this,"_renderer");o(this,"_isTopContainer");this._renderer=t,this._isTopContainer=e}alignGlyphs(){for(const t of this._bands)t.alignGlyphs()}get previousContainer(){return this._renderer.index===0?void 0:this._isTopContainer?this._renderer.previousRenderer.topEffects:this._renderer.previousRenderer.bottomEffects}get isLinkedToPreviousRenderer(){return this._bands.some(t=>t.isLinkedToPrevious)}reLayout(){this.resetEffectBandSizingInfo(),this.sizeAndAlignEffectBands()}afterStaffBarReverted(){this.resetEffectBandSizingInfo(),this.sizeAndAlignEffectBands()}createVoiceGlyphs(t){let e=0;const s=this._renderer,i=s.settings.notation;for(const r of this.infos){if(!i.isNotationElementVisible(r.effect.notationElement))continue;let a;this._effectInfosSortOrder.set(r.effect,r.order??e);for(const l of t.beats)!a&&eo.shouldCreateGlyph(l,r.effect,s)&&(a=new eo(t,r.effect,this),a.renderer=this._renderer,a.doLayout(),this._bands.push(a),this._bandLookup.set(`${t.index}.${r.effect.effectId}`,a)),a!==void 0&&a.createGlyph(l);e++}}doLayout(){this._effectInfosSortOrder.clear(),this._bands=[],this._bandLookup=new Map,this.resetEffectBandSizingInfo()}resetEffectBandSizingInfo(){this._renderer.index>0?this._effectBandSizingInfo=this.previousContainer._effectBandSizingInfo:this._effectBandSizingInfo&&this._effectBandSizingInfo.owner===this?this._effectBandSizingInfo.reset():this._effectBandSizingInfo=new of(this)}finalizeEffects(){return this._updateEffectBandHeights(!0)}updateEffectBandHeights(){return this._updateEffectBandHeights(!1)}_updateEffectBandHeights(t){if(!this._effectBandSizingInfo)return!1;let e=0;const s=0,i=this._renderer.settings.display.effectBandPaddingBottom;for(const r of this._effectBandSizingInfo.slots){r.shared.y=e;for(const a of r.bands)e+=s,a.y=e,t&&a.finalizeBand(),a.height=r.shared.height;e+=r.shared.height+i}return e=Math.ceil(e),e!==this.height?(this.height=e,!0):!1}sizeAndAlignEffectBands(t=!0){for(const e of this._bands)e.resetHeight(),e.alignGlyphs(),t&&!e.isEmpty&&this._effectBandSizingInfo.register(e);t&&this._effectBandSizingInfo.sortSlots(this._effectInfosSortOrder)}paint(t,e,s){const i=this._renderer.resources;for(const r of this._bands)s.color=r.voice.index===0?i.mainGlyphColor:i.secondaryGlyphColor,r.isEmpty||r.paint(t,e,s)}getBand(t,e){const s=`${t.index}.${e}`;return this._bandLookup.has(s)?this._bandLookup.get(s):null}}class xa extends mi{constructor(){super(0,0);o(this,"gap",0);this.glyphs=[]}doLayout(){}addGlyph(e){e.x=this.width,e.renderer=this.renderer,e.doLayout(),this.width=e.x+e.width+this.gap,super.addGlyph(e)}}class Ac extends It{constructor(){super(0,0);o(this,"voiceDrawOrder");o(this,"_beatGlyphLookup",new Map);o(this,"beatGlyphs",new Map);o(this,"tupletGroups",new Map)}getBoundingBoxTop(){let e=Number.NaN;for(const s of this.beatGlyphs.values())for(const i of s)e=A.minBoundingBox(e,i.getBoundingBoxTop());return e}getBoundingBoxBottom(){let e=Number.NaN;for(const s of this.beatGlyphs.values())for(const i of s)e=A.maxBoundingBox(e,i.getBoundingBoxBottom());return e}scaleToWidth(e){const s=this.renderer.layoutingInfo.spaceToForce(e);this._scaleToForce(s)}_scaleToForce(e){this.width=this.renderer.layoutingInfo.calculateVoiceWidth(e);const s=this.renderer.layoutingInfo.buildOnTimePositions(e);for(const i of this.beatGlyphs.values())for(let r=0,a=i.length;r<a;r++){const l=i[r];switch(l.graceType){case ee.None:l.x=s.get(l.absoluteDisplayStart)-l.onTimeX;break;default:const h=l.graceGroup.beats[0].absoluteDisplayStart,c=l.graceGroup.id;if(l.graceGroup.isComplete&&s.has(h)){l.x=s.get(h)-l.onTimeX;const d=this.renderer.layoutingInfo.allGraceRods.get(c),u=l.graceGroup.beats[l.graceGroup.beats.length-1].nextBeat,p=u?this.renderer.layoutingInfo.getPreBeatSize(u):0;l.x-=p,l.x-=d[l.graceIndex].postSpringWidth,l.x+=d[l.graceIndex].graceBeatWidth;const g=d[l.graceGroup.beats.length-1];l.x-=g.graceBeatWidth}else{const d=this.renderer.layoutingInfo.incompleteGraceRods.get(c),u=d[l.graceIndex].postSpringWidth-d[l.graceIndex].preSpringWidth;r>0?l.graceIndex===0?l.x=i[r-1].x+i[r-1].width:l.x=i[r-1].x+d[l.graceIndex-1].postSpringWidth-d[l.graceIndex-1].preSpringWidth-u:l.x=-u}break}if(r>0){const h=l.x-i[r-1].x;i[r-1].scaleToWidth(h)}if(r===a-1){const h=this.width-i[i.length-1].x;l.scaleToWidth(h)}}}registerLayoutingInfo(e){for(const s of this.beatGlyphs.values())for(const i of s)i.registerLayoutingInfo(e)}applyLayoutingInfo(e){for(const s of this.beatGlyphs.values()){for(const i of s)i.applyLayoutingInfo(e);this._scaleToForce(Math.max(this.renderer.settings.display.stretchForce,e.minStretchForce))}}addGlyph(e){let s;this.beatGlyphs.has(e.voiceIndex)?s=this.beatGlyphs.get(e.voiceIndex):(s=[],this.beatGlyphs.set(e.voiceIndex,s)),e.x=s.length===0?0:s[s.length-1].x+s[s.length-1].width,e.renderer=this.renderer,s.push(e);const i=e.beatId;i>=0&&this._beatGlyphLookup.set(i,e);const r=e.x+e.width;if(r>this.width&&(this.width=r),e.isFirstOfTupletGroup){let a;this.tupletGroups.has(e.voiceIndex)?a=this.tupletGroups.get(e.voiceIndex):(a=[],this.tupletGroups.set(e.voiceIndex,a)),a.push(e.tupletGroup)}}getBeatX(e,s=oe.PreNotes,i=!1){const r=this.getBeatContainer(e);return r?r.x+r.getBeatX(s,i):0}getLowestNoteY(e,s){const i=this.getBeatContainer(e);return i?i.y+i.getLowestNoteY(s):0}getHighestNoteY(e,s){const i=this.getBeatContainer(e);return i?i.y+i.getHighestNoteY(s):0}getNoteX(e,s){const i=this.getBeatContainer(e.beat);return i?i.x+i.getNoteX(e,s):0}getNoteY(e,s){const i=this.getBeatContainer(e.beat);return i?i.y+i.getNoteY(e,s):0}getRestY(e,s){const i=this.getBeatContainer(e);return i?i.y+i.getRestY(s):0}getBeatContainer(e){if(this._beatGlyphLookup.has(e.id))return this._beatGlyphLookup.get(e.id)}buildBoundingsLookup(e,s,i){for(const[r,a]of this.beatGlyphs){const l=this.renderer.bar.voices[r];if(r===0||!l.isEmpty)for(const h of a)h.buildBoundingsLookup(e,s+this.x,i+this.y)}}doLayout(){for(const e of this.beatGlyphs.values()){let s=0;for(const i of e)i.x=s,i.doLayout(),s+=i.width;s>this.width&&(this.width=s)}this.renderer.bar.isMultiVoice&&this._doMultiVoiceLayout(),this.voiceDrawOrder=Array.from(this.beatGlyphs.keys()),fe.sortDescending(this.voiceDrawOrder)}_doMultiVoiceLayout(){for(const e of this.beatGlyphs.values()){let s=0;for(const i of e)i.x=s,i.doMultiVoiceLayout(),s+=i.width;s>this.width&&(this.width=s)}}paint(e,s,i){var r;for(const a of this.voiceDrawOrder){const l=this.beatGlyphs.get(a),h=this.renderer.bar.voices[a],c=ve.voice(i,Zr.Glyphs,h,!0);try{for(let d=0,u=l.length;d<u;d++)l[d].paint(e+this.x,s+this.y,i)}finally{(r=c==null?void 0:c[Symbol.dispose])==null||r.call(c)}}}}o(Ac,"KeySizeBeat","Beat");class zt extends It{constructor(e,s){super(0,0);o(this,"tieDirection",E.Up);o(this,"slurEffectId");o(this,"isForEnd");o(this,"_startX",0);o(this,"_startY",0);o(this,"_endX",0);o(this,"_endY",0);o(this,"_tieHeight",0);o(this,"_boundingBox");o(this,"_shouldPaint",!1);this.slurEffectId=e,this.isForEnd=s}get checkForOverflow(){return this._shouldPaint&&this._boundingBox!==void 0}getBoundingBoxTop(){return this._boundingBox?this._boundingBox.y:this._startY}getBoundingBoxBottom(){return this._boundingBox?this._boundingBox.y+this._boundingBox.h:this._startY}doLayout(){this.width=0;const e=this.lookupStartBeatRenderer(),s=this.lookupEndBeatRenderer();this._startX=0,this._endX=0,this._startY=0,this._endY=0,this.height=0,this.tieDirection=this.calculateTieDirection();const i=this.isForEnd;if(this._shouldPaint=!1,i){if(e.staff!==s.staff){const a=e.staff.barRenderers[0];this._startX=a.x,this._endX=this.calculateEndX();const l=e.scoreRenderer.layout.slurRegistry.completeMultiSystemSlur(this);l?this._startY=l.calculateMultiSystemSlurY(s):this._startY=this.caclculateEndY(),this._endY=this.caclculateEndY(),this._shouldPaint=e.staff!==s.staff}}else{if(e!==s)if(this._startX=this.calculateStartX(),this._startY=this.calculateStartY(),!s||e.staff!==s.staff){const a=e.staff.barRenderers[e.staff.barRenderers.length-1];this._endX=a.x+a.width,this._endY=this._startY,e.scoreRenderer.layout.slurRegistry.startMultiSystemSlur(this)}else this._endX=this.calculateEndX(),this._endY=this.caclculateEndY();else this._shouldPaint=!0,this._startX=this.calculateStartX(),this._endX=this.calculateEndX(),this._startY=this.calculateStartY(),this._endY=this.caclculateEndY();this._shouldPaint=!0}this._boundingBox=void 0,this.y=Math.min(this._startY,this._endY);let r;if(this.shouldDrawBendSlur()?(this._tieHeight=0,r=zt.calculateBendSlurHeight(this._startX,this._startY,this._endX,this._endY,this.tieDirection===E.Down,this.renderer.smuflMetrics.tieHeight)):(this._tieHeight=this.getTieHeight(this._startX,this._startY,this._endX,this._endY),r=zt.calculateActualTieHeight(1,this._startX,this._startY,this._endX,this._endY,this.tieDirection===E.Down,this._tieHeight,this.renderer.smuflMetrics.tieMidpointThickness)),this._boundingBox=r,this.height=r.h,this.tieDirection===E.Up){const a=this.y-r.y;a>0&&(this.y-=a)}}paint(e,s,i){this._shouldPaint&&(this.shouldDrawBendSlur()?zt.drawBendSlur(i,e+this._startX,s+this._startY,e+this._endX,s+this._endY,this.tieDirection===E.Down,this.renderer.smuflMetrics.tieHeight):zt.paintTie(i,1,e+this._startX,s+this._startY,e+this._endX,s+this._endY,this.tieDirection===E.Down,this._tieHeight,this.renderer.smuflMetrics.tieMidpointThickness))}getTieHeight(e,s,i,r){return this.renderer.smuflMetrics.tieHeight}calculateMultiSystemSlurY(e){const s=this.lookupStartBeatRenderer(),r=this.calculateStartY()-s.y;return e.y+r}shouldCreateMultiSystemSlur(e){var i;const s=(i=this.lookupEndBeatRenderer())==null?void 0:i.staff;return s?e.staff.system.index<s.system.index:!0}static calculateActualTieHeight(e,s,i,r,a,l,h,c){const d=zt._computeBezierControlPoints(e,s,i,r,a,l,h,c);if(d.length===0)return new Pt(s,i,r-s,a-i);const u=d[0],p=d[1],g=d[2],m=d[3],y=d[4],S=d[5],k=d[6],T=d[7],N=.125*u+.375*g+.375*y+.125*k,F=.125*p+.375*m+.375*S+.125*T,q=Math.min(u,k,N),U=Math.max(u,k,N);let x=Math.min(p,T,F),j=Math.max(p,T,F);l?j+=c:x-=c;const Q=new Pt;return Q.x=q,Q.y=x,Q.w=U-q,Q.h=j-x,Q}static _computeBezierControlPoints(e,s,i,r,a,l,h,c){if(s===r&&i===a)return[];if(r<s){let U=s;s=r,r=U,U=i,i=a,a=U}h*=e,c*=e,l&&(h*=-1,c*=-1),e>=1&&(c*=1.2);const d=a-i,u=r-s,p=Math.sqrt(u*u+d*d);let g=s+p*.25,m=i-h,y=s+p*.75,S=i-h,k=s+p*.75,T=i-h-c,N=s+p*.25,F=i-h-c;const q=Math.atan2(d,u);return[g,m]=zt._rotate(g,m,s,i,q),[y,S]=zt._rotate(y,S,s,i,q),[k,T]=zt._rotate(k,T,s,i,q),[N,F]=zt._rotate(N,F,s,i,q),[s,i,g,m,y,S,r,a,k,T,N,F,s,i]}static _rotate(e,s,i,r,a){const l=e-i,h=s-r,c=l*Math.cos(a)-h*Math.sin(a),d=l*Math.sin(a)+h*Math.cos(a);return[i+c,r+d]}static paintTie(e,s,i,r,a,l,h,c,d){const u=zt._computeBezierControlPoints(s,i,r,a,l,h,c,d);e.beginPath(),e.moveTo(u[0],u[1]),e.bezierCurveTo(u[2],u[3],u[4],u[5],u[6],u[7]),e.bezierCurveTo(u[8],u[9],u[10],u[11],u[12],u[13]),e.closePath(),e.fill()}static calculateBendSlurTopY(e,s,i,r,a,l,h){let c=r-s,d=i-e;const u=Math.sqrt(c*c+d*d);a?c*=-1:d*=-1,c/=u,d/=u;let p=h*l;return i-e<20&&(p/=2),(r+s)/2+p*d}static calculateBendSlurHeight(e,s,i,r,a,l){let h=r-s,c=i-e;const d=Math.sqrt(h*h+c*c);a?h*=-1:c*=-1,h/=d,c/=d;const u=(r+s)/2;let p=l;i-e<20&&(p/=2);const g=u+p*c,m=Math.min(s,r,g),y=Math.max(s,r,g);return new Pt(e,Math.min(s,r,g),i-e,y-m)}static drawBendSlur(e,s,i,r,a,l,h,c){let d=a-i,u=r-s;const p=Math.sqrt(d*d+u*u);l?d*=-1:u*=-1,d/=p,u/=p;const g=(r+s)/2,m=(a+i)/2;let y=h;r-s<20&&(y/=2);const S=g+y*d,k=m+y*u;if(e.beginPath(),e.moveTo(s,i),e.lineTo(S,k),e.lineTo(r,a),e.stroke(),c){const T=e.measureText(c).width,N=l?0:-e.font.size;e.fillText(c,S-T/2,k+N)}}}class Bo extends zt{constructor(e,s,i,r){super(e,r);o(this,"startNote");o(this,"endNote");o(this,"startNoteRenderer",null);o(this,"endNoteRenderer",null);this.startNote=s,this.endNote=i}get isLeftHandTap(){return this.startNote===this.endNote}getTieHeight(e,s,i,r){return this.isLeftHandTap?this.renderer.smuflMetrics.tieHeight:super.getTieHeight(e,s,i,r)}calculateTieDirection(){switch(this.lookupStartBeatRenderer().getBeatDirection(this.startNote.beat)){case E.Up:return E.Down;default:return E.Up}}calculateStartX(){const e=this.lookupStartBeatRenderer();return this.isLeftHandTap?this.calculateEndX()-e.smuflMetrics.leftHandTabTieWidth:e.x+e.getNoteX(this.startNote,this.getStartNotePosition())}getStartNotePosition(){return je.Center}calculateStartY(){const e=this.lookupStartBeatRenderer();if(this.isLeftHandTap)return e.y+e.getNoteY(this.startNote,M.Center);switch(this.tieDirection){case E.Up:return e.y+e.getNoteY(this.startNote,M.Top);default:return e.y+e.getNoteY(this.startNote,M.Bottom)}}calculateEndX(){const e=this.lookupEndBeatRenderer();return e?this.isLeftHandTap?e.x+e.getNoteX(this.endNote,je.Left):e.x+e.getNoteX(this.endNote,je.Center):this.calculateStartY()+this.renderer.smuflMetrics.leftHandTabTieWidth}getEndNotePosition(){return je.Center}caclculateEndY(){const e=this.lookupEndBeatRenderer();if(!e)return this.calculateStartY();if(this.isLeftHandTap)return e.y+e.getNoteY(this.endNote,M.Center);switch(this.tieDirection){case E.Up:return e.y+e.getNoteY(this.endNote,M.Top);default:return e.y+e.getNoteY(this.endNote,M.Bottom)}}lookupEndBeatRenderer(){return this.endNoteRenderer||(this.endNoteRenderer=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,this.endNote.beat.voice.bar)),this.endNoteRenderer}lookupStartBeatRenderer(){return this.startNoteRenderer||(this.startNoteRenderer=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,this.startNote.beat.voice.bar)),this.startNoteRenderer}shouldDrawBendSlur(){return!1}}class lf extends zt{constructor(e){super(e.slurEffectId,!1);o(this,"_startTie");this._startTie=e}lookupStartBeatRenderer(){return this.renderer}lookupEndBeatRenderer(){return this.renderer}shouldDrawBendSlur(){return!1}calculateTieDirection(){return this._startTie.tieDirection}calculateStartY(){return this._startTie.calculateMultiSystemSlurY(this.renderer)}caclculateEndY(){return this.calculateStartY()}calculateStartX(){return this.renderer.staff.barRenderers[0].x}calculateEndX(){const e=this.renderer.staff.barRenderers[this.renderer.staff.barRenderers.length-1];return e.x+e.width}}class sa extends It{constructor(e,s,i,r,a=1){super(e,s);o(this,"_scale",0);o(this,"_baseline");o(this,"_symbols",[]);this._symbols=sa.getSymbols(i),this._scale=a,this._baseline=r}static getSymbols(e){const s=[];for(;e>0;){const i=e%10;s.unshift(sa.getSymbol(i)),e=e/10|0}return s}static getSymbol(e){switch(e){case 0:return f.TimeSig0;case 1:return f.TimeSig1;case 2:return f.TimeSig2;case 3:return f.TimeSig3;case 4:return f.TimeSig4;case 5:return f.TimeSig5;case 6:return f.TimeSig6;case 7:return f.TimeSig7;case 8:return f.TimeSig8;case 9:return f.TimeSig9;default:return f.None}}doLayout(){let e=0;for(const s of this._symbols)e+=this.renderer.smuflMetrics.glyphWidths.get(s);this.width=e}paint(e,s,i){switch(this._baseline){case Ue.Top:s+=this.renderer.smuflMetrics.glyphBottom.get(this._symbols[0]);break;case Ue.Bottom:s+=this.renderer.smuflMetrics.glyphTop.get(this._symbols[0]);break}i.fillMusicFontSymbols(e+this.x,s+this.y,this._scale,this._symbols)}}const Wa=class Wa extends It{constructor(){super(0,0);o(this,"_numberGlyph",[]);o(this,"_numberTop",0)}doLayout(){const e=this.renderer.smuflMetrics;this.width=Wa._restSymbols.reduce((r,a)=>r+e.glyphWidths.get(a),0);const s=this.renderer.additionalMultiRestBars.length+1;this._numberGlyph=sa.getSymbols(s),this._numberTop=this.renderer.getLineY(-1.5);const i=e.glyphTop.get(this._numberGlyph[0]);this.renderer.registerOverflowTop(Math.abs(this._numberTop)+i)}paint(e,s,i){i.fillMusicFontSymbols(e+this.x,s+this.y+this.renderer.height/2,1,Wa._restSymbols);const r=this.renderer.getLineY(-1.5);i.fillMusicFontSymbols(e+this.x+this.width/2,s+this.y+r|0,1,this._numberGlyph,!0)}};o(Wa,"_restSymbols",[f.RestHBarLeft,f.RestHBarMiddle,f.RestHBarMiddle,f.RestHBarMiddle,f.RestHBarRight]);let kl=Wa;class hf extends mh{constructor(){super(0,0);o(this,"_glyph")}get absoluteDisplayStart(){return this.renderer.bar.masterBar.start}get beatId(){return-1}get onTimeX(){return 0}get graceType(){return ee.None}get graceIndex(){return 0}get graceGroup(){return null}get voiceIndex(){return 0}get isFirstOfTupletGroup(){return!1}get tupletGroup(){return null}get isLastOfVoice(){return!0}get displayDuration(){return 0}getRestY(e){const s=this._glyph;if(s)switch(e){case M.Top:return s.y;case M.TopWithStem:return s.y-this.renderer.smuflMetrics.getStemLength(b.Quarter,!0);case M.Center:case M.StemUp:case M.StemDown:return s.y+s.height/2;case M.Bottom:return s.y+s.height;case M.BottomWithStem:return s.y+s.height+this.renderer.smuflMetrics.getStemLength(b.Quarter,!0)}return 0}getNoteY(e,s){return this.getRestY(s)}getHighestNoteY(e){return this.getRestY(e)}getLowestNoteY(e){return this.getRestY(e)}getNoteX(e,s){const i=this._glyph;if(i)switch(s){case je.Left:return i.x;case je.Center:return i.x+i.width/2;case je.Right:return i.x+i.width}return 0}getBeatX(e,s){const i=this._glyph;if(i)switch(e){case oe.PreNotes:return i.x;case oe.OnNotes:case oe.MiddleNotes:case oe.Stem:case oe.PostNotes:return i.x+i.width;case oe.EndBeat:return this.width}return 0}registerLayoutingInfo(e){var i;const s=((i=this._glyph)==null?void 0:i.width)??0;e.addBeatSpring(this,0,s)}applyLayoutingInfo(e){}buildBoundingsLookup(e,s,i){}doLayout(){this.renderer.showMultiBarRest&&(this._glyph=new kl,this._glyph.renderer=this.renderer,this._glyph.doLayout(),this.width=this._glyph.width)}doMultiVoiceLayout(){}getBoundingBoxTop(){var e;return((e=this._glyph)==null?void 0:e.getBoundingBoxTop())??Number.NaN}getBoundingBoxBottom(){var e;return((e=this._glyph)==null?void 0:e.getBoundingBoxBottom())??Number.NaN}paint(e,s,i){var r;(r=this._glyph)==null||r.paint(e+this.x,s+this.y,i)}}class cf{constructor(){o(this,"startBeat",null);o(this,"startX",0);o(this,"startY",0);o(this,"endBeat",null);o(this,"endX",0);o(this,"endY",0)}calcY(t){return this.startX===this.endX?this.startY:(this.endY-this.startY)/(this.endX-this.startX)*(t-this.startX)+this.startY}}class Ms{constructor(t,e,s){o(this,"_staff");o(this,"_renderer");o(this,"_beamingRuleLookup");o(this,"voice",null);o(this,"beats",[]);o(this,"shortestDuration",b.QuadrupleWhole);o(this,"hasTuplet",!1);o(this,"slashBeats",[]);o(this,"restBeats",[]);o(this,"lowestNoteInHelper",null);o(this,"_lowestNoteCompareValueInHelper",-1);o(this,"highestNoteInHelper",null);o(this,"_highestNoteCompareValueInHelper",-1);o(this,"invertBeamDirection",!1);o(this,"preferredBeamDirection",null);o(this,"graceType",ee.None);o(this,"drawingInfos",new Map);this._staff=t,this._renderer=e,this.beats=[],this._beamingRuleLookup=s}get isRestBeamHelper(){return this.beats.length===1&&this.beats[0].isRest}hasStem(t,e){return t&&Ms.beatHasStem(e)||!t&&Ms.beatHasStem(e)}static beatHasStem(t){return t.duration>b.Whole}hasFlag(t,e){return t&&Ms.beatHasFlag(e)||!t&&this.beats.length===1&&Ms.beatHasFlag(this.beats[0])}static beatHasFlag(t){return!t.deadSlapped&&!t.isRest&&(t.duration>b.Quarter||t.graceType!==ee.None)}alignWithBeats(){for(const t of this.drawingInfos.values())t.startX=this._renderer.getBeatX(t.startBeat,oe.Stem),t.endX=this._renderer.getBeatX(t.endBeat,oe.Stem),this.drawingInfos.clear()}finish(){this._renderer.completeBeamingHelper(this)}static computeLineHeightsForRest(t){switch(t){case b.QuadrupleWhole:return[2,2];case b.DoubleWhole:return[2,2];case b.Whole:return[0,1];case b.Half:return[1,0];case b.Quarter:return[3,3];case b.Eighth:return[2,2];case b.Sixteenth:return[2,4];case b.ThirtySecond:return[4,4];case b.SixtyFourth:return[4,6];case b.OneHundredTwentyEighth:return[6,6];case b.TwoHundredFiftySixth:return[6,8]}return[0,0]}checkBeat(t){t.invertBeamDirection&&(this.invertBeamDirection=!0),this.voice||(this.voice=t.voice);let e=!1;if(this.beats.length===0)e=!0;else switch(this.beats[this.beats.length-1].beamingMode){case ot.Auto:case ot.ForceSplitOnSecondaryToNext:e=this._canJoin(this.beats[this.beats.length-1],t);break;case ot.ForceSplitToNext:e=!1;break;case ot.ForceMergeWithNext:e=!0;break}return e&&(this.preferredBeamDirection==null&&t.preferredBeamDirection!==null&&(this.preferredBeamDirection=t.preferredBeamDirection),t.hasTuplet&&(this.hasTuplet=!0),t.graceType!==ee.None&&(this.graceType=t.graceType),t.isRest?this.beats.length===0?this.beats.push(t):this.restBeats.push(t):(this.isRestBeamHelper&&(this.beats=[]),this.beats.push(t),this._checkNote(t.minNote),this._checkNote(t.maxNote),this.shortestDuration<t.duration&&(this.shortestDuration=t.duration)),t.slashed&&this.slashBeats.push(t)),e}_checkNote(t){if(!t)return;let e,s;this.voice&&t.isPercussion?(e=-Er.getPercussionSteps(t),s=e):(e=Er.getNoteValue(t),s=e,t.harmonicType!==ie.None&&t.harmonicType!==ie.Natural&&(s=t.realValue-this._staff.displayTranspositionPitch)),(!this.lowestNoteInHelper||e<this._lowestNoteCompareValueInHelper)&&(this.lowestNoteInHelper=t,this._lowestNoteCompareValueInHelper=e),(!this.highestNoteInHelper||s>this._highestNoteCompareValueInHelper)&&(this.highestNoteInHelper=t,this._highestNoteCompareValueInHelper=s)}_canJoin(t,e){if(!t||!e||t.graceType!==e.graceType||t.graceType===ee.BendGrace||e.graceType===ee.BendGrace||t.deadSlapped||e.deadSlapped)return!1;if(t.graceType!==ee.None&&e.graceType!==ee.None)return!0;const s=t.voice.bar,i=e.voice.bar;if(s!==i)return!1;const r=t.playbackStart,a=e.playbackStart;if(!Ms._canJoinDuration(t.duration)||!Ms._canJoinDuration(e.duration))return r===a;if(t.tupletGroup!==e.tupletGroup)return!1;if(t.hasTuplet&&e.hasTuplet&&t.tupletGroup===e.tupletGroup&&t.tupletGroup.isFull)return!0;const l=this._beamingRuleLookup.calculateGroupIndex(r),h=this._beamingRuleLookup.calculateGroupIndex(a);return l===h}static _canJoinDuration(t){switch(t){case b.Whole:case b.Half:case b.Quarter:return!1;default:return!0}}static isFullBarJoin(t,e,s){return A.getIndex(t.duration)-2-s>0&&A.getIndex(e.duration)-2-s>0}get beatOfLowestNote(){return this.lowestNoteInHelper.beat}get beatOfHighestNote(){return this.highestNoteInHelper.beat}}class df{constructor(t,e){o(this,"topY",0);o(this,"bottomY",0);this.topY=t,this.bottomY=e}}class uf{constructor(t){o(this,"beat");o(this,"topY",-1e3);o(this,"bottomY",-1e3);o(this,"slots",[]);this.beat=t}addSlot(t,e){if(this.slots.push(new df(t,e)),this.topY===-1e3)this.topY=t,this.bottomY=e;else{const s=Math.min(t,e),i=Math.max(t,e);s<this.topY&&(this.topY=s),i>this.bottomY&&(this.bottomY=i)}}}class ff{constructor(){o(this,"reservedLayoutAreasByDisplayTime",new Map);o(this,"restDurationsByDisplayTime",new Map)}getBeatMinMaxY(){let t=-1e3,e=-1e3;for(const s of this.reservedLayoutAreasByDisplayTime.values())t===-1e3?(t=s.topY,e=s.bottomY):(t>s.topY&&(t=s.topY),e<s.bottomY&&(e=s.bottomY));return t===-1e3?[0,0]:[t,e]}reserveBeatSlot(t,e,s){e!==s&&(this.reservedLayoutAreasByDisplayTime.has(t.displayStart)||this.reservedLayoutAreasByDisplayTime.set(t.displayStart,new uf(t)),this.reservedLayoutAreasByDisplayTime.get(t.displayStart).addSlot(e,s),t.isRest&&this.registerRest(t))}registerRest(t){this.restDurationsByDisplayTime.has(t.displayStart)||this.restDurationsByDisplayTime.set(t.displayStart,new Map),this.restDurationsByDisplayTime.get(t.displayStart).has(t.playbackDuration)||this.restDurationsByDisplayTime.get(t.displayStart).set(t.playbackDuration,t.id)}applyRestCollisionOffset(t,e,s){if(t.voice.index>0&&this.reservedLayoutAreasByDisplayTime.has(t.playbackStart)){const i=Ms.computeLineHeightsForRest(t.duration).map(d=>d*s),r=e-i[0],a=e+i[1];let l=r;const h=this.reservedLayoutAreasByDisplayTime.get(t.playbackStart);let c=!1;for(const d of h.slots)if(r>=d.topY&&r<=d.bottomY||a>=d.topY&&a<=d.bottomY){c=!0;break}if(c){t.voice.index===1?l=h.topY-i[1]-i[0]:l=h.bottomY;const d=l+i[0]+i[1],u=s*2,p=Math.ceil(Math.abs(l-r)/u);return h.addSlot(l,d),l<r?p*-u:p*u}}return 0}}class to{constructor(t,e,s){o(this,"_division",0);o(this,"_slots",[]);o(this,"_barDuration");this._division=e,this._slots=s,this._barDuration=t}calculateGroupIndex(t){if(this._slots.length===0)return t;t=t%this._barDuration;const e=Math.floor(t/this._division);return this._slots[e]}static build(t,e,s){const i=t.calculateDuration(!1),r=D.toTicks(e),a=i/r;if(a<0||s.length===0)return new to(0,0,[]);let l=0,h=s[l];const c=[];for(let d=0;d<a;d++)l<s.length?(c.push(l),h--,h<=0&&(l++,l<s.length&&(h=s[l]))):(c.push(l),l++);return new to(i,r,c)}}const Xr=class Xr{constructor(t){o(this,"_renderer");o(this,"_beamHelperLookup",new Map);o(this,"beamHelpers",[]);o(this,"collisionHelper");o(this,"preferredBeamDirection",null);this._renderer=t,this.collisionHelper=new ff}initialize(){const t=this._renderer,e=this._renderer.bar,s=e.masterBar,i=s.actualBeamingRules??Xr._findOrBuildDefaultBeamingRules(s),r=i.findRule(e.shortestDuration),a=`beaming_${i.uniqueId}_${r[0]}`;let l=this._renderer.scoreRenderer.layout.beamingRuleLookups.has(a)?this._renderer.scoreRenderer.layout.beamingRuleLookups.get(a):void 0;l||(l=to.build(s,r[0],r[1]),this._renderer.scoreRenderer.layout.beamingRuleLookups.set(a,l));let h=null,c=null;for(let d=0,u=e.voices.length;d<u;d++){const p=e.voices[d];this.beamHelpers.push([]);for(let g=0,m=p.beats.length;g<m;g++){const y=p.beats[g];let S;y.graceType!==ee.None?S=c:(S=h,c&&c.finish(),c=null),(!S||!S.checkBeat(y))&&(S&&S.finish(),S=new Ms(e.staff,t,l),S.preferredBeamDirection=this.preferredBeamDirection,S.checkBeat(y),y.graceType!==ee.None?c=S:h=S,this.beamHelpers[p.index].push(S)),this._beamHelperLookup.set(y.id,S)}h&&h.finish(),c&&c.finish(),h=null,c=null}}static _findOrBuildDefaultBeamingRules(t){let e=Xr._defaultBeamingRules;e||(e=new Map([dt.createSimple(2,16,b.Sixteenth,[1,1]),dt.createSimple(1,8,b.Eighth,[1]),dt.createSimple(1,4,b.Quarter,[1]),dt.createSimple(3,16,b.Sixteenth,[3]),dt.createSimple(4,16,b.Sixteenth,[2,2]),dt.createSimple(2,8,b.Eighth,[1,1]),dt.createSimple(5,16,b.Sixteenth,[3,2]),dt.createSimple(6,16,b.Sixteenth,[3,3]),dt.createSimple(3,8,b.Eighth,[3]),dt.createSimple(4,8,b.Eighth,[2,2]),dt.createSimple(2,4,b.Quarter,[1,1]),dt.createSimple(9,16,b.Sixteenth,[3,3,3]),dt.createSimple(5,8,b.Eighth,[3,2]),dt.createSimple(12,16,b.Sixteenth,[3,3,3,3]),dt.createSimple(6,8,b.Eighth,[3,3,3]),dt.createSimple(3,4,b.Quarter,[1,1,1]),dt.createSimple(7,8,b.Eighth,[4,3]),dt.createSimple(8,8,b.Eighth,[3,3,2]),dt.createSimple(4,4,b.Quarter,[1,1,1,1]),dt.createSimple(9,8,b.Eighth,[3,3,3]),dt.createSimple(10,8,b.Eighth,[4,3,3]),dt.createSimple(5,4,b.Quarter,[1,1,1,1,1]),dt.createSimple(12,8,b.Eighth,[3,3,3,3]),dt.createSimple(6,4,b.Quarter,[1,1,1,1,1,1]),dt.createSimple(15,8,b.Eighth,[3,3,3,3,3,3]),dt.createSimple(8,4,b.Quarter,[1,1,1,1,1,1,1,1]),dt.createSimple(18,8,b.Eighth,[3,3,3,3,3,3])].map(c=>[`${c.timeSignatureNumerator}_${c.timeSignatureDenominator}`,c])),Xr._defaultBeamingRules=e);const s=`${t.timeSignatureNumerator}_${t.timeSignatureDenominator}`;if(e.has(s))return e.get(s);let i=D.QuarterTime;switch(t.timeSignatureDenominator){case 8:t.timeSignatureNumerator%3===0&&(i+=D.QuarterTime/2|0);break}const r=Math.ceil(t.calculateDuration(!1)/i),a=i/D.QuarterTime*2,l=new dt,h=[];for(let c=0;c<r;c++)h.push(a);return l.groups.set(b.Eighth,h),l.timeSignatureNumerator=t.timeSignatureNumerator,l.timeSignatureDenominator=t.timeSignatureDenominator,l.finish(),e.set(s,l),l}getBeamingHelperForBeat(t){return this._beamHelperLookup.has(t.id)?this._beamHelperLookup.get(t.id):void 0}};o(Xr,"_defaultBeamingRules");let wl=Xr;var M;(function(n){n[n.TopWithStem=0]="TopWithStem",n[n.Top=1]="Top",n[n.Center=2]="Center",n[n.Bottom=3]="Bottom",n[n.BottomWithStem=4]="BottomWithStem",n[n.StemUp=5]="StemUp",n[n.StemDown=6]="StemDown"})(M||(M={}));var je;(function(n){n[n.Left=0]="Left",n[n.Center=1]="Center",n[n.Right=2]="Right"})(je||(je={}));class Bl{constructor(t,e){o(this,"_preBeatGlyphs",new xa);o(this,"voiceContainer",new Ac);o(this,"_postBeatGlyphs",new xa);o(this,"_ties",[]);o(this,"_multiSystemSlurs");o(this,"topEffects");o(this,"bottomEffects");o(this,"scoreRenderer");o(this,"staff");o(this,"layoutingInfo");o(this,"bar");o(this,"additionalMultiRestBars",null);o(this,"x",0);o(this,"y",0);o(this,"width",0);o(this,"computedWidth",0);o(this,"height",0);o(this,"index",0);o(this,"_contentTopOverflow",0);o(this,"_contentBottomOverflow",0);o(this,"beatEffectsMinY",Number.NaN);o(this,"beatEffectsMaxY",Number.NaN);o(this,"helpers");o(this,"isLinkedToPrevious",!1);o(this,"canWrap",!0);o(this,"wasFirstOfStaff",!1);o(this,"_appliedLayoutingInfo",0);o(this,"isFinalized",!1);this.scoreRenderer=t,this.bar=e,this.helpers=new wl(this),this.topEffects=new Qh(this,!0),this.bottomEffects=new Qh(this,!1)}get nextRenderer(){return!this.bar||!this.bar.nextBar?null:this.scoreRenderer.layout.getRendererForBar(this.staff.staffId,this.bar.nextBar)}get previousRenderer(){return!this.bar||!this.bar.previousBar?null:this.scoreRenderer.layout.getRendererForBar(this.staff.staffId,this.bar.previousBar)}get lastBar(){return this.additionalMultiRestBars?this.additionalMultiRestBars[this.additionalMultiRestBars.length-1]:this.bar}get topOverflow(){return this._contentTopOverflow+this.topEffects.height}get bottomOverflow(){return this._contentBottomOverflow+this.bottomEffects.height}get collisionHelper(){return this.helpers.collisionHelper}get showMultiBarRest(){return!0}registerTie(t){this._ties.push(t)}get middleYPosition(){return 0}registerBeatEffectOverflows(t,e){const s=this.beatEffectsMinY;(Number.isNaN(s)||t<s)&&(this.beatEffectsMinY=t);const i=this.beatEffectsMaxY;(Number.isNaN(i)||e>i)&&(this.beatEffectsMaxY=e)}registerOverflowTop(t){return t=Math.ceil(t),t>this._contentTopOverflow?(this._contentTopOverflow=t,!0):!1}registerOverflowBottom(t){return t=Math.ceil(t),t>this._contentBottomOverflow?(this._contentBottomOverflow=t,!0):!1}scaleToWidth(t){const e=t-this._preBeatGlyphs.width-this._postBeatGlyphs.width;this.voiceContainer.scaleToWidth(e);for(const s of this.helpers.beamHelpers)for(const i of s)i.alignWithBeats();this._postBeatGlyphs.x=this._preBeatGlyphs.x+this._preBeatGlyphs.width+e,this.width=t,this.topEffects.alignGlyphs(),this.bottomEffects.alignGlyphs()}get resources(){return this.settings.display.resources}get smuflMetrics(){return this.resources.engravingSettings}get settings(){return this.scoreRenderer.settings}get isFirstOfStaff(){return this.index===0}get isLastOfStaff(){return this.index===this.staff.barRenderers.length-1}get isLast(){return!this.bar||this.bar.index===this.scoreRenderer.layout.lastBarIndex}_registerLayoutingInfo(){const t=this.layoutingInfo,e=this._preBeatGlyphs.width;t.preBeatSize<e&&(t.preBeatSize=e),this.voiceContainer.registerLayoutingInfo(t);const i=this._postBeatGlyphs.width;t.postBeatSize<i&&(t.postBeatSize=i)}afterReverted(){this.staff=void 0,this.registerMultiSystemSlurs(void 0),this.isFinalized=!1}afterStaffBarReverted(){this.topEffects.afterStaffBarReverted(),this.bottomEffects.afterStaffBarReverted(),this._registerStaffOverflow()}applyLayoutingInfo(){if(this._appliedLayoutingInfo>=this.layoutingInfo.version)return!1;this.topEffects.resetEffectBandSizingInfo(),this.bottomEffects.resetEffectBandSizingInfo(),this._appliedLayoutingInfo=this.layoutingInfo.version,this._preBeatGlyphs.width=this.layoutingInfo.preBeatSize;const t=this.voiceContainer;return t.x=this._preBeatGlyphs.x+this._preBeatGlyphs.width,t.applyLayoutingInfo(this.layoutingInfo),this._postBeatGlyphs.x=Math.floor(t.x+t.width),this._postBeatGlyphs.width=this.layoutingInfo.postBeatSize,this.width=Math.ceil(this._postBeatGlyphs.x+this._postBeatGlyphs.width),this.computedWidth=this.width,this.topEffects.sizeAndAlignEffectBands(),this.bottomEffects.sizeAndAlignEffectBands(),this._registerStaffOverflow(),!0}registerMultiSystemSlurs(t){if(!t){this._multiSystemSlurs=void 0;return}let e;for(const s of t){const i=new lf(s);i.renderer=this,i.tieDirection=s.tieDirection,e||(e=[]),e.push(i)}this._multiSystemSlurs=e}_finalizeTies(t,e,s){let i=!1;for(const r of t){const a=r;if(a.doLayout(),r.checkForOverflow){const l=a.getBoundingBoxTop(),c=a.getBoundingBoxBottom()-s;c>0&&this.registerOverflowBottom(c)&&(i=!0);const d=l-e;d<0&&this.registerOverflowTop(d*-1)&&(i=!0)}}return i}finalizeRenderer(){this.isFinalized=!0;let t=!1;const e=this.y,s=this.y+this.height;this._finalizeTies(this._ties,e,s)&&(t=!0);const i=this._multiSystemSlurs;i&&this._finalizeTies(i,e,s)&&(t=!0);const r=this.topEffects.finalizeEffects(),a=this.bottomEffects.finalizeEffects();return(r||a)&&(t=!0),t&&(this.updateSizes(),this._registerStaffOverflow()),t}_registerStaffOverflow(){this.staff.registerOverflowTop(this.topOverflow),this.staff.registerOverflowBottom(this.bottomOverflow)}doLayout(){if(this.bar){this.helpers.initialize(),this._ties=[],this._preBeatGlyphs.renderer=this,this.voiceContainer.renderer=this,this._postBeatGlyphs.renderer=this,this.topEffects.doLayout(),this.bottomEffects.doLayout(),this.bar.simileMark===At.SecondOfDouble&&(this.canWrap=!1),this.createPreBeatGlyphs(),this.createBeatGlyphs(),this.createPostBeatGlyphs(),this._registerLayoutingInfo(),this.topEffects.sizeAndAlignEffectBands(!1),this.bottomEffects.sizeAndAlignEffectBands(!1),this.updateSizes();for(const t of this.helpers.beamHelpers)for(const e of t)e.finish();this.computedWidth=this.width,this.calculateOverflows(0,this.height)}}calculateOverflows(t,e){const s=this._preBeatGlyphs.glyphs;if(s)for(const d of s){const u=d.getBoundingBoxTop();u<0&&this.registerOverflowTop(u*-1);const p=d.getBoundingBoxBottom();p>e&&this.registerOverflowBottom(p-e)}const i=this._postBeatGlyphs.glyphs;if(i)for(const d of i){const u=d.getBoundingBoxTop();u<0&&this.registerOverflowTop(u*-1);const p=d.getBoundingBoxBottom();p>e&&this.registerOverflowBottom(p-e)}const r=this.voiceContainer,a=r.getBoundingBoxTop();a<0&&this.registerOverflowTop(a*-1);const l=r.getBoundingBoxBottom();l>e&&this.registerOverflowBottom(l-e);const h=this.beatEffectsMinY;!Number.isNaN(h)&&h<0&&this.registerOverflowTop(h*-1);const c=this.beatEffectsMaxY;!Number.isNaN(c)&&c>e&&this.registerOverflowBottom(c-e)}updateSizes(){this.staff.registerStaffTop(0),this.voiceContainer.x=this._preBeatGlyphs.x+this._preBeatGlyphs.width,this._postBeatGlyphs.x=Math.floor(this.voiceContainer.x+this.voiceContainer.width),this.width=Math.ceil(this._postBeatGlyphs.x+this._postBeatGlyphs.width);const t=this.topEffects.updateEffectBandHeights(),e=this.bottomEffects.updateEffectBandHeights();(t||e)&&this._registerStaffOverflow(),this.height+=this.layoutingInfo.height,this.height=Math.ceil(this.height),this.staff.registerStaffBottom(this.height)}addPreBeatGlyph(t){t.renderer=this,this._preBeatGlyphs.addGlyph(t)}addBeatGlyph(t){t.renderer=this,this.voiceContainer.addGlyph(t)}getBeatContainer(t){return this.voiceContainer.getBeatContainer(t)}paint(t,e,s){this.paintContent(t,e,s);const i=e+this.y-this.staff.topOverflow;this.topEffects.paint(t+this.x,i,s);const r=e+this.y+this.height+this.staff.bottomOverflow-this.bottomEffects.height;this.bottomEffects.paint(t+this.x,r,s)}paintContent(t,e,s){this.paintBackground(t,e,s),s.color=this.resources.mainGlyphColor,this._preBeatGlyphs.paint(t+this.x,e+this.y,s),this.voiceContainer.paint(t+this.x,e+this.y,s),s.color=this.resources.mainGlyphColor,this._postBeatGlyphs.paint(t+this.x,e+this.y,s),this._paintMultiSystemSlurs(t,e,s)}_paintMultiSystemSlurs(t,e,s){const i=this._multiSystemSlurs;if(i)for(const r of i)r.paint(t,e,s)}paintBackground(t,e,s){this.layoutingInfo.paint(t+this.x+this._preBeatGlyphs.x+this._preBeatGlyphs.width,e+this.y+this.height,s)}buildBoundingsLookup(t,e,s){const i=new ch;i.bar=this.bar,i.visualBounds=new Pt,i.visualBounds.x=e+this.x,i.visualBounds.y=s+this.y,i.visualBounds.w=this.width,i.visualBounds.h=this.height,i.realBounds=new Pt,i.realBounds.x=e+this.x,i.realBounds.y=s+this.y,i.realBounds.w=this.width,i.realBounds.h=this.height,t.addBar(i),this.voiceContainer.buildBoundingsLookup(i,e+this.x,s+this.y)}addPostBeatGlyph(t){this._postBeatGlyphs.addGlyph(t)}createPreBeatGlyphs(){this.wasFirstOfStaff=this.isFirstOfStaff}createBeatGlyphs(){if(this.additionalMultiRestBars){const t=new hf;this.addBeatGlyph(t)}else for(const t of this.bar.filledVoices)this.createVoiceGlyphs(this.bar.voices[t]);this.voiceContainer.doLayout(),(this.topEffects.isLinkedToPreviousRenderer||this.bottomEffects.isLinkedToPreviousRenderer)&&(this.isLinkedToPrevious=!0)}createVoiceGlyphs(t){this.topEffects.createVoiceGlyphs(t),this.bottomEffects.createVoiceGlyphs(t)}createPostBeatGlyphs(){}get beatGlyphsStart(){return this.voiceContainer.x}get postBeatGlyphsStart(){return this._postBeatGlyphs.x}getBeatX(t,e=oe.PreNotes,s=!1){return this.beatGlyphsStart+this.voiceContainer.getBeatX(t,e,s)}getRatioPositionX(t){const e=this.bar.isEmpty?this.beatGlyphsStart:this.getBeatX(this.bar.voices[0].beats[0],oe.MiddleNotes),s=e,i=this.postBeatGlyphsStart-e;return s+i*t}getNoteX(t,e){return this.beatGlyphsStart+this.voiceContainer.getNoteX(t,e)}getNoteY(t,e){return this.voiceContainer.y+ +this.voiceContainer.getNoteY(t,e)}getRestY(t,e){return this.voiceContainer.y+ +this.voiceContainer.getRestY(t,e)}reLayout(){this.topEffects.reLayout(),this.bottomEffects.reLayout(),this.updateSizes(),(this.wasFirstOfStaff&&!this.isFirstOfStaff||!this.wasFirstOfStaff&&this.isFirstOfStaff)&&(this.recreatePreBeatGlyphs(),this._postBeatGlyphs.doLayout()),this._registerLayoutingInfo(),this.calculateOverflows(0,this.height)}recreatePreBeatGlyphs(){this._preBeatGlyphs=new xa,this._preBeatGlyphs.renderer=this,this.createPreBeatGlyphs()}paintSimileMark(t,e,s){var r;const i=ve.voice(s,Zr.Glyphs,this.bar.voices[0],!0);try{switch(this.bar.simileMark){case At.Simple:s.beginGroup(Pi.getGroupId(this.bar.voices[0].beats[0])),kt.fillMusicFontSymbolSafe(s,t+this.x+this.width/2,e+this.y+this.height/2,1,f.Repeat1Bar,!0),s.endGroup();break;case At.SecondOfDouble:s.beginGroup(Pi.getGroupId(this.bar.voices[0].beats[0])),s.beginGroup(Pi.getGroupId(this.bar.previousBar.voices[0].beats[0])),kt.fillMusicFontSymbolSafe(s,t+this.x,e+this.y+this.height/2,1,f.Repeat2Bars,!0),s.endGroup(),s.endGroup();break}}finally{(r=i==null?void 0:i[Symbol.dispose])==null||r.call(i)}}completeBeamingHelper(t){}}class Ic extends sn{constructor(e,s,i,r=!1){super(oe.EndBeat);o(this,"_type");o(this,"_symbol",f.None);o(this,"_repeatOffsetX",0);o(this,"_symbolOffsetY",0);o(this,"_partialWaves");this._type=i,this.x=e,this.y=s,this._partialWaves=r}doLayout(){switch(super.doLayout(),this._type){case Ee.Slight:this._symbol=this.slightVibratoGlyph;break;case Ee.Wide:this._symbol=this.wideVibratoGlyph;break}this._repeatOffsetX=this.renderer.smuflMetrics.repeatOffsetX.get(this._symbol),this._symbolOffsetY=this.renderer.smuflMetrics.glyphTop.get(this._symbol),this.height=this.renderer.smuflMetrics.glyphHeights.get(this._symbol)}paintGrouped(e,s,i,r){const a=e+this.x,l=i-a,h=this._repeatOffsetX;let c=l/h;this._partialWaves||(c=Math.floor(c)),c<1&&(c=1);const d=[];for(let u=0;u<c;u++)d.push(this._symbol);r.fillMusicFontSymbols(e+this.x,s+this.y+this._symbolOffsetY,1,d,!1)}}class ur extends Ic{get slightVibratoGlyph(){return f.GuitarVibratoStroke}get wideVibratoGlyph(){return f.GuitarWideVibratoStroke}}class Ji extends H{constructor(e=0,s=0){super(e,s);o(this,"lineValue",0);this.lineValue=s}}class To extends It{constructor(){super(0,0);o(this,"_notes",[]);o(this,"_renderPoints",new Map);o(this,"_preBendMinValue",-1);o(this,"_bendMiddleMinValue",-1);o(this,"_bendEndMinValue",-1);o(this,"_bendEndContinuedMinValue",-1);o(this,"_releaseMinValue",-1);o(this,"_releaseContinuedMinValue",-1);o(this,"_maxBendValue",-1);o(this,"checkForOverflow",!1)}addBends(e){this._notes.push(e);const s=this._createRenderingPoints(e);this._renderPoints.set(e.id,s),(this._maxBendValue===-1||this._maxBendValue<e.maxBendPoint.value)&&(this._maxBendValue=e.maxBendPoint.value);let i=0;switch(e.bendType){case J.Bend:i=s[1].value,e.isTieOrigin?(this._bendEndContinuedMinValue===-1||i<this._bendEndContinuedMinValue)&&(this._bendEndContinuedMinValue=i):(this._bendEndMinValue===-1||i<this._bendEndMinValue)&&(this._bendEndMinValue=i);break;case J.Release:i=s[1].value,e.isTieOrigin?(this._releaseContinuedMinValue===-1||i<this._releaseContinuedMinValue)&&(this._releaseContinuedMinValue=i):i>0&&(this._releaseMinValue===-1||i<this._releaseMinValue)&&(this._releaseMinValue=i);break;case J.BendRelease:i=s[1].value,(this._bendMiddleMinValue===-1||i<this._bendMiddleMinValue)&&(this._bendMiddleMinValue=i),i=s[2].value,e.isTieOrigin?(this._releaseContinuedMinValue===-1||i<this._releaseContinuedMinValue)&&(this._releaseContinuedMinValue=i):i>0&&(this._releaseMinValue===-1||i<this._releaseMinValue)&&(this._releaseMinValue=i);break;case J.Prebend:i=s[0].value,(this._preBendMinValue===-1||i<this._preBendMinValue)&&(this._preBendMinValue=i);break;case J.PrebendBend:i=s[0].value,(this._preBendMinValue===-1||i<this._preBendMinValue)&&(this._preBendMinValue=i),i=s[1].value,e.isTieOrigin?(this._bendEndContinuedMinValue===-1||i<this._bendEndContinuedMinValue)&&(this._bendEndContinuedMinValue=i):(this._bendEndMinValue===-1||i<this._bendEndMinValue)&&(this._bendEndMinValue=i);break;case J.PrebendRelease:i=s[0].value,(this._preBendMinValue===-1||i<this._preBendMinValue)&&(this._preBendMinValue=i),i=s[1].value,e.isTieOrigin?(this._releaseContinuedMinValue===-1||i<this._releaseContinuedMinValue)&&(this._releaseContinuedMinValue=i):i>0&&(this._releaseMinValue===-1||i<this._releaseMinValue)&&(this._releaseMinValue=i);break}}doLayout(){super.doLayout(),this._calculateAndRegisterOverflow();let e=0;for(const s of this._notes){const i=this._renderPoints.get(s.id);switch(s.bendType){case J.Bend:i[1].lineValue=s.isTieOrigin?this._bendEndContinuedMinValue:this._bendEndMinValue;break;case J.Release:e=s.isTieOrigin?this._releaseContinuedMinValue:this._releaseMinValue,e>=0&&(i[1].lineValue=e);break;case J.BendRelease:i[1].lineValue=this._bendMiddleMinValue,e=s.isTieOrigin?this._releaseContinuedMinValue:this._releaseMinValue,e>=0&&(i[2].lineValue=e);break;case J.Prebend:i[0].lineValue=this._preBendMinValue;break;case J.PrebendBend:i[0].lineValue=this._preBendMinValue,i[1].lineValue=s.isTieOrigin?this._bendEndContinuedMinValue:this._bendEndMinValue;break;case J.PrebendRelease:i[0].lineValue=this._preBendMinValue,e=s.isTieOrigin?this._releaseContinuedMinValue:this._releaseMinValue,e>=0&&(i[1].lineValue=e);break}}this.width=0,this._notes.sort((s,i)=>s.isStringed?s.string-i.string:s.realValue-i.realValue)}_calculateAndRegisterOverflow(){const e=this.renderer.resources,s=this.renderer.smuflMetrics;let i=this._maxBendValue*s.tabBendPerValueHeight;i+=s.tabBendStaffPadding;const r=this.renderer.scoreRenderer.canvas;r.font=e.tablatureFont;const a=r.measureText("full");i+=a.height+e.engravingSettings.tabBendLabelPadding,this.renderer.registerOverflowTop(i)}_createRenderingPoints(e){const s=[];switch(e.bendType){case J.Custom:for(const i of e.bendPoints)s.push(new Ji(i.offset,i.value));break;case J.BendRelease:s.push(new Ji(0,e.bendPoints[0].value)),s.push(new Ji(H.MaxPosition/2|0,e.bendPoints[1].value)),s.push(new Ji(H.MaxPosition,e.bendPoints[3].value));break;case J.Bend:case J.Hold:case J.Prebend:case J.PrebendBend:case J.PrebendRelease:case J.Release:s.push(new Ji(0,e.bendPoints[0].value)),s.push(new Ji(H.MaxPosition,e.bendPoints[1].value));break}return s}paint(e,s,i){const r=i.color;this._notes.length>1&&(i.color=this.renderer.resources.secondaryGlyphColor);for(const a of this._notes){const l=this.renderer;let h=a,c=!1,d=null,u=!1,p=null;for(;h.isTieOrigin;){const N=h.tieDestination;if(d=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,N.beat.voice.bar),!d||l.staff!==d.staff)break;if(h=N,c=!0,h.hasBend||!this.renderer.settings.notation.extendBendArrowsOnTiedNotes||h.vibrato!==Ee.None){u=!0;break}}p=h.beat,d=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,p.voice.bar),p.isLastOfVoice&&!h.hasBend&&this.renderer.settings.notation.extendBendArrowsOnTiedNotes&&(p=null);const g=l.smuflMetrics,m=g.glyphWidths.get(f.ArrowheadBlackDown),y=s+l.y-g.tabBendStaffPadding;let S=e+l.x;const k=this._renderPoints.get(a.id);k[0].value>0||a.isContinuedBend?S+=l.getBeatX(a.beat,oe.MiddleNotes):S+=l.getNoteX(a,je.Right);let T=0;!p||p.isLastOfVoice&&!u?(T=e+d.x+d.postBeatGlyphsStart,T-=this.renderer.smuflMetrics.postNoteEffectPadding):u||!p.nextBeat?T=e+d.x+d.getBeatX(p,oe.MiddleNotes):a.bendType===J.Hold?T=e+d.x+d.getBeatX(p.nextBeat,oe.OnNotes):(T=e+d.x+d.getBeatX(p.nextBeat,oe.PreNotes),T-=this.renderer.smuflMetrics.postNoteEffectPadding),c||(T-=m/2),this._paintBendLines(i,S,y,T,l,a,k),this._paintBendVibrato(i,e,T+m/2,y-g.tabBendPerValueHeight*k[k.length-1].lineValue,d,h),i.color=r}}_paintBendVibrato(e,s,i,r,a,l){if(l.isTieDestination&&l.vibrato!==Ee.None&&!l.hasBend){const h=s+a.x,c=i-h,d=new ur(c,0,l.vibrato);d.beat=l.beat,d.renderer=a,d.doLayout(),d.paint(h,r,e)}}_paintBendLines(e,s,i,r,a,l,h){const c=e.lineWidth,d=this.renderer.resources,u=e.textBaseline;e.textBaseline=Ue.Alphabetic,e.lineWidth=d.engravingSettings.arrowShaftThickness;const g=(r-s)/H.MaxPosition;for(let m=0,y=h.length-1;m<y;m++){const S=h[m];let k=h[m+1];m===0&&S.value!==0&&!l.isTieDestination&&this._paintBend(e,s,i,g,a,l,new Ji(0,0),S),l.bendType!==J.Prebend?(m===0&&(s+=this.renderer.smuflMetrics.postNoteEffectPadding),this._paintBend(e,s,i,g,a,l,S,k)):l.isTieOrigin&&l.tieDestination.hasBend&&(k=new Ji(H.MaxPosition,S.value),k.lineValue=S.lineValue,this._paintBend(e,s,i,g,a,l,S,k))}e.lineWidth=c,e.textBaseline=u}_paintBendLine(e,s,i,r,a,l,h){if(l.value===h.value){if(l.lineValue>0){let c=r;const d=this.renderer.smuflMetrics.tabBendDashSize,u=s+d;if((c-s)/(d*2)<1)e.moveTo(c,i),e.lineTo(s,i);else for(;c>u;)e.moveTo(c,i),e.lineTo(c-d,i),c-=d*2;e.stroke()}}else if(r>s){const d=h.value>l.value?3:-3;e.moveTo(s,i),e.bezierCurveTo((s+r)/2,i,r,i,r,a+d),e.stroke()}else e.moveTo(s,i),e.lineTo(r,a),e.stroke()}_paintBend(e,s,i,r,a,l,h,c){const d=a.lineOffset/2,u=a.resources,p=u.engravingSettings,g=s+r*h.offset;let m;h.value===0?(m=i+p.tabBendStaffPadding,c.offset===h.offset?m+=a.getNoteY(l.beat.maxStringNote,M.Top)-d:m+=a.getNoteY(l,M.Center)):m=i-p.tabBendPerValueHeight*h.lineValue;const y=s+r*c.offset;let S;c.lineValue===0?S=i+p.tabBendStaffPadding+a.getNoteY(l.beat.maxStringNote,M.Center):S=i-p.tabBendPerValueHeight*c.lineValue,this._paintBendLine(e,g,m,y,S,h,c);const k=p.glyphWidths.get(f.ArrowheadBlackDown);if(h.value!==c.value){const T=c.value>h.value;this._paintBendLineArrow(e,y,S,m,k,T),this._paintBendLineSlurText(e,g,m,y,S,l,u.graceFont),this._paintBendLineValueText(e,m,y,S-p.tabBendLabelPadding,h,c,u.tablatureFont)}}_paintBendLineSlurText(e,s,i,r,a,l,h){if(l.bendStyle===tt.Gradual){const c="grad.",d=e.measureText(c);e.font=h;let u=0,p=0;if(i>a){const g=Math.abs(i-a);u=g>d.height?i-g/2:i,p=(s+r-d.width)/2}else u=i,p=r-d.width;e.fillText(c,p,u)}}_paintBendLineValueText(e,s,i,r,a,l,h){if(l.value!==0){const c=l.value>a.value;let d=l.value,u="";if(d===4)u="full",d-=4;else if(d>=4||d<=-4){const p=d/4|0;u+=p,d-=p*4}if(d>0&&(u+=To.getFractionSign(d)),u!==""){const p=c?r:s+Math.abs(r-s)*1/3;e.font=h;const g=e.measureText(u),m=i-g.width/2;e.fillText(u,m,p)}}}_paintBendLineArrow(e,s,i,r,a,l){l?(i+a>r&&(i=r-a),e.beginPath(),e.moveTo(s,i),e.lineTo(s-a*.5,i+a),e.lineTo(s+a*.5,i+a),e.closePath(),e.fill()):(i<r&&(i=r+a),e.beginPath(),e.moveTo(s,i),e.lineTo(s-a*.5,i-a),e.lineTo(s+a*.5,i-a),e.closePath(),e.fill())}static getFractionSign(e){switch(e){case 1:return"¼";case 2:return"½";case 3:return"¾";default:return`${e}/ 4`}}}class Rc extends Cs{constructor(e){super(0,0);o(this,"_beat");o(this,"_renderPoints");o(this,"_isSimpleDip",!1);o(this,"originalTopOffset",0);o(this,"originalBottomOffset",0);o(this,"topOffset",0);o(this,"bottomOffset",0);this._beat=e,this._renderPoints=this._createRenderingPoints(e)}_createRenderingPoints(e){if(e.whammyBarType===De.Custom)return e.whammyBarPoints;const s=[];switch(e.whammyBarType){case De.Dive:case De.Hold:case De.PrediveDive:case De.Predive:s.push(new H(0,e.whammyBarPoints[0].value)),s.push(new H(H.MaxPosition,e.whammyBarPoints[1].value));break;case De.Dip:s.push(new H(0,e.whammyBarPoints[0].value)),s.push(new H(H.MaxPosition/2|0,e.whammyBarPoints[1].value)),s.push(new H(H.MaxPosition,e.whammyBarPoints[e.whammyBarPoints.length-1].value));break}return s}doLayout(){if(super.doLayout(),this._beat.whammyBarType===De.Custom)return;this._isSimpleDip=this.renderer.settings.notation.notationMode===Xt.SongBook&&this._beat.whammyBarType===De.Dip;const e=this._beat.minWhammyPoint,s=this._beat.maxWhammyPoint;let i=s.value>0?-this._getOffset(s.value):0,r=e.value<0?-this._getOffset(e.value):0;const a=this.renderer.scoreRenderer.canvas;a.font=this.renderer.resources.tablatureFont;const h=a.measureText("-1").height+this.renderer.smuflMetrics.tabWhammyTextPadding;if((i!==0||this._beat.whammyBarPoints[0].value!==0||this.renderer.settings.notation.isNotationElementVisible(v.ZerosOnDiveWhammys))&&(i-=h),r!==0)if(this._isSimpleDip)i-=h;else{const c=r-h;c<i&&(i=c)}i=Math.abs(i),r=Math.abs(r),this.topOffset=i,this.bottomOffset=r,this.originalTopOffset=i,this.originalBottomOffset=r,this.height=i+r,this.width=0}_getOffset(e){if(e===0)return 0;let s=this.renderer.smuflMetrics.tabWhammyPerHalfHeight+Math.log2(Math.abs(e)/2)*this.renderer.smuflMetrics.tabWhammyPerHalfHeight;return e<0&&(s=-s),s}paint(e,s,i){var a;const r=ve.beat(i,ht.StandardNotationEffects,this._beat);try{const l=this.renderer;let h=this._beat.nextBeat,c=null,d=oe.PreNotes;h&&(c=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,h.voice.bar),!c||c.staff!==l.staff||c!==l&&!h.hasWhammyBar?(h=null,c=null):d=h.hasWhammyBar&&(l.settings.notation.notationMode!==Xt.SongBook||h.whammyBarType!==De.Dip)?oe.MiddleNotes:oe.PreNotes);let u=0,p=0;this._isSimpleDip?(u=e+l.getBeatX(this._beat,oe.OnNotes,!0),p=e+l.getBeatX(this._beat,oe.PostNotes,!0)):(u=e+l.getBeatX(this._beat,oe.MiddleNotes,!0),c?p=e-l.x+c.x+c.getBeatX(h,d,!0):p=e+l.getBeatX(this._beat,oe.EndBeat)-l.smuflMetrics.postNoteEffectPadding);const g=i.textAlign,m=i.textBaseline;if(i.textAlign=X.Center,i.textBaseline=Ue.Alphabetic,i.font=this.renderer.resources.tablatureFont,this._renderPoints.length>=2){const y=(p-u)/H.MaxPosition;i.beginPath();const S=s+this.topOffset;let k=this._beat.whammyStyle===tt.Gradual?"grad.":"";for(let T=0,N=this._renderPoints.length-1;T<N;T++){const F=this._renderPoints[T],q=this._renderPoints[T+1];let U=T===0;T===0&&F.value!==0&&!this._beat.isContinuedWhammy&&(this._paintWhammy(!1,new H(0,0),F,u,S,y,i),U=!1),this._paintWhammy(U,F,q,u,S,y,i,k),k=""}i.stroke()}i.textAlign=g,i.textBaseline=m}finally{(a=r==null?void 0:r[Symbol.dispose])==null||a.call(r)}}_paintWhammy(e,s,i,r,a,l,h,c){const d=r+l*s.offset,u=r+l*i.offset,p=a-this._getOffset(s.value),g=a-this._getOffset(i.value);if(s.offset===i.offset){const S=this.renderer.smuflMetrics.tabWhammyDashSize;if(Math.abs(g-p)/(S*2)<1)h.moveTo(d,p),h.lineTo(u,g);else{const T=Math.max(p,g);let N=Math.min(p,g);for(;T>N;)h.moveTo(d,N),h.lineTo(d,N+S),N+=S*2}h.stroke()}else if(s.value===i.value){const S=this.renderer.smuflMetrics.tabWhammyDashSize;if(Math.abs(u-d)/(S*2)<1)h.moveTo(d,p),h.lineTo(u,g);else{let T=Math.max(d,u);const N=Math.min(d,u);for(;T>N;)h.moveTo(T,p),h.lineTo(T-S,p),T-=S*2}h.stroke()}else h.moveTo(d,p),h.lineTo(u,g);const m=this.renderer.smuflMetrics.tabWhammyTextPadding;e&&!this._beat.isContinuedWhammy&&!this._isSimpleDip&&(this.renderer.settings.notation.isNotationElementVisible(v.ZerosOnDiveWhammys)&&h.fillText("0",d,p-m),c&&h.fillText(c,d,p-m));let y=Math.abs(i.value);if((y!==0||this.renderer.settings.notation.isNotationElementVisible(v.ZerosOnDiveWhammys)&&!this._isSimpleDip)&&s.value!==i.value){let S="";if(i.value<0&&(S+="-"),y>=4){const N=y/4|0;S+=N,y-=N*4}else y===0&&(S+="0");y>0&&(S+=To.getFractionSign(y));let k=0;this._isSimpleDip?k=Math.min(p,g):k=s.offset===i.offset?Math.min(p,g):g;const T=u;h.fillText(S,T,k-m)}}}class pf extends yt{get notationElement(){return v.EffectWhammyBar}get effectId(){return`${super.effectId}.simpledip`}get hideOnMultiTrack(){return!1}get canShareBand(){return!1}get sizingMode(){return Pe.SingleOnBeat}shouldCreateGlyph(t,e){return t.notation.notationMode===Xt.SongBook&&e.hasWhammyBar&&e.whammyBarType===De.Dip}createNewGlyph(t,e){return new Rc(e)}canExpand(t,e){return!0}}class Oc extends Ic{get slightVibratoGlyph(){return f.WiggleSawtoothNarrow}get wideVibratoGlyph(){return f.WiggleSawtooth}}class Kh extends yt{get notationElement(){return v.EffectSlightBeatVibrato}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return Pe.GroupedOnBeatToEnd}shouldCreateGlyph(t,e){return e.vibrato===Ee.Slight}createNewGlyph(t,e){return new Oc(0,0,Ee.Slight)}canExpand(t,e){return!0}}class Zh extends Ir{constructor(e){super();o(this,"_hideOnTiedBend");this._hideOnTiedBend=e}get notationElement(){return v.EffectSlightNoteVibrato}shouldCreateGlyphForNote(e){let s=e.vibrato===Ee.Slight||e.isTieDestination&&e.tieOrigin.vibrato===Ee.Slight;return this._hideOnTiedBend&&s&&e.isTieDestination&&e.tieOrigin.hasBend&&(s=!1),s}get sizingMode(){return Pe.GroupedOnBeatToEnd}createNewGlyph(e,s){return new ur(0,0,Ee.Slight)}}class gf extends Cs{constructor(){super(0,0)}doLayout(){super.doLayout(),this.height=this.renderer.smuflMetrics.glyphHeights.get(f.KeyboardPedalPed)}paint(t,e,s){const i=this.renderer,r=e+this.y,a=this.height,l=i.bar.sustainPedals,h=this.renderer.smuflMetrics.glyphWidths.get(f.KeyboardPedalPed),c=this.renderer.smuflMetrics.glyphWidths.get(f.KeyboardPedalUp);let d=0;for(;d<l.length;){let u=l[d];for(;u!=null;){const p=t+this.renderer.getRatioPositionX(u.ratioPosition);let g=0;if(u.pedalType===lt.Down?(kt.fillMusicFontSymbolSafe(s,p,r+a,1,f.KeyboardPedalPed,!0),g=h/2+this.renderer.smuflMetrics.sustainPedalLinePadding):u.pedalType===lt.Up&&(kt.fillMusicFontSymbolSafe(s,p,r+a,1,f.KeyboardPedalUp,!0),g=c/2+this.renderer.smuflMetrics.sustainPedalLinePadding),u.nextPedalMarker)if(u.nextPedalMarker.bar===u.bar){let m=t+this.renderer.getRatioPositionX(u.nextPedalMarker.ratioPosition);switch(u.nextPedalMarker.pedalType){case lt.Down:m-=h/2;break;case lt.Hold:break;case lt.Up:m-=c/2;break}const y=p+g;m>y&&s.fillRect(y,r+a-this.renderer.smuflMetrics.pedalLineThickness,m-y,this.renderer.smuflMetrics.pedalLineThickness)}else{const m=t+this.x+this.width,y=p+g;s.fillRect(y,r+a-this.renderer.smuflMetrics.pedalLineThickness,m-y,this.renderer.smuflMetrics.pedalLineThickness)}if(d===0&&u.previousPedalMarker){const m=t+this.x,y=p-g;s.fillRect(m,r+a-this.renderer.smuflMetrics.pedalLineThickness,y-m,this.renderer.smuflMetrics.pedalLineThickness)}d++,u.nextPedalMarker!=null&&u.nextPedalMarker.bar!==u.bar?(u=null,d=l.length):u=u.nextPedalMarker}}}}class mf extends yt{get notationElement(){return v.EffectSustainPedal}get hideOnMultiTrack(){return!1}get canShareBand(){return!1}get sizingMode(){return Pe.FullBar}shouldCreateGlyph(t,e){return e.voice.index===0&&e.index===0&&e.voice.bar.sustainPedals.length>0}createNewGlyph(t,e){return new gf}canExpand(t,e){return!0}}const $r=class $r extends yt{get notationElement(){return v.EffectWhammyBarLine}get hideOnMultiTrack(){return!1}get canShareBand(){return!1}get sizingMode(){return Pe.GroupedOnBeatToEnd}shouldCreateGlyph(t,e){return e.hasWhammyBar}createNewGlyph(t,e){return new Rc(e)}canExpand(t,e){return e.hasWhammyBar}onAlignGlyphs(t){const e=t.renderer.staff.getSharedLayoutData($r.offsetSharedDataKey,[0,0]);t.renderer.staff.setSharedLayoutData($r.offsetSharedDataKey,e);for(const s of t.iterateAllGlyphs()){const i=s;i.originalTopOffset>e[0]&&(e[0]=i.originalTopOffset),i.originalBottomOffset>e[1]&&(e[1]=i.originalBottomOffset)}}finalizeBand(t){const e=t.renderer.staff.getSharedLayoutData($r.offsetSharedDataKey,[0,0]),s=e[0],i=e[1];for(const r of t.iterateAllGlyphs()){const a=r;a.topOffset=s,a.bottomOffset=i,a.height=s+i}t.slot.shared.height=s+i,t.height=s+i}};o($r,"offsetSharedDataKey","tab.whammy.offset");let Tl=$r;class jh extends yt{get notationElement(){return v.EffectTap}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return Pe.SingleOnBeat}shouldCreateGlyph(t,e){return e.slap||e.pop||e.tap}createNewGlyph(t,e){const s=t.resources;return e.slap?new Js(0,0,"S",s.elementFonts.get(v.EffectTap),X.Center):e.pop?new Js(0,0,"P",s.elementFonts.get(v.EffectTap),X.Center):new Js(0,0,"T",s.elementFonts.get(v.EffectTap),X.Center)}canExpand(t,e){return!0}}class yf extends Cs{constructor(e){super(0,0);o(this,"_tempoAutomations");this._tempoAutomations=e}doLayout(){super.doLayout();const e=this.renderer.resources;this.height=this.renderer.smuflMetrics.glyphHeights.get(f.MetNoteQuarterUp)*e.engravingSettings.tempoNoteScale}paint(e,s,i){for(const r of this._tempoAutomations){let a=e+this.renderer.getRatioPositionX(r.ratioPosition);const l=this.renderer.resources;i.font=l.elementFonts.get(v.EffectMarker);const h=s+this.y+this.height+this.renderer.smuflMetrics.glyphBottom.get(f.MetNoteQuarterUp)*l.engravingSettings.tempoNoteScale,c=i.textBaseline;if(i.textBaseline=Ue.Alphabetic,r.text){const d=`${r.text} `,u=i.measureText(d);i.fillText(d,a,h),a+=u.width}else a-=l.engravingSettings.glyphWidths.get(f.MetNoteQuarterUp)/2;kt.fillMusicFontSymbolSafe(i,a,h,l.engravingSettings.tempoNoteScale,f.MetNoteQuarterUp),a+=this.renderer.smuflMetrics.glyphWidths.get(f.MetNoteQuarterUp)*l.engravingSettings.tempoNoteScale,i.fillText(` = ${r.value.toString()}`,a,h),i.textBaseline=c,a+=i.measureText(` = ${r.value.toString()}`).width}}}class bf extends yt{get notationElement(){return v.EffectTempo}get hideOnMultiTrack(){return!0}get canShareBand(){return!1}get sizingMode(){return Pe.SinglePreBeat}shouldCreateGlyph(t,e){return e.voice.bar.staff.index===0&&e.voice.index===0&&e.index===0&&e.voice.bar.masterBar.tempoAutomations.some(s=>s.isVisible)}createNewGlyph(t,e){return new yf(e.voice.bar.masterBar.tempoAutomations.filter(s=>s.isVisible))}canExpand(t,e){return!0}}class Sf extends yt{get notationElement(){return v.EffectText}get hideOnMultiTrack(){return!1}get canShareBand(){return!1}get sizingMode(){return Pe.SingleOnBeat}shouldCreateGlyph(t,e){return!!e.text}createNewGlyph(t,e){return new Js(0,0,e.text,t.resources.elementFonts.get(v.EffectText),X.Left)}canExpand(t,e){return!0}}class _f extends sn{constructor(t,e){super(oe.EndBeat),this.x=t,this.y=e}doLayout(){super.doLayout(),this.height=this.renderer.smuflMetrics.glyphHeights.get(f.OrnamentTrill)}paintGrouped(t,e,s,i){const r=this.renderer.smuflMetrics.glyphWidths.get(f.OrnamentTrill),l=t+this.x+r,h=this.renderer.smuflMetrics.repeatOffsetX.get(f.WiggleTrill),c=Math.ceil((s-l)/h),d=[f.OrnamentTrill];for(let u=0;u<c;u++)d.push(f.WiggleTrill);i.fillMusicFontSymbols(t+this.x-r/2,e+this.y+this.height,1,d,!1)}}class ec extends Ir{get notationElement(){return v.EffectTrill}shouldCreateGlyphForNote(t){return t.isTrill}get sizingMode(){return Pe.GroupedOnBeatToEnd}createNewGlyph(t,e){return new _f(0,0)}}var Ft;(function(n){n[n.EighthEighth=0]="EighthEighth",n[n.SixteenthSixteenth=1]="SixteenthSixteenth",n[n.QuarterTripletEighthTriplet=2]="QuarterTripletEighthTriplet",n[n.EighthSixteenthTriplet=3]="EighthSixteenthTriplet",n[n.EighthDottedSixteenth=4]="EighthDottedSixteenth",n[n.SixteenthDottedThirtySecond=5]="SixteenthDottedThirtySecond",n[n.SixteenthEighthDotted=6]="SixteenthEighthDotted",n[n.ThirtySecondSixteenthDotted=7]="ThirtySecondSixteenthDotted"})(Ft||(Ft={}));class kf extends Cs{constructor(e){super(0,0);o(this,"_tripletFeel");o(this,"_tupletHeight",0);o(this,"_tupletPadding",0);this._tripletFeel=e}doLayout(){super.doLayout();const e=this.renderer.smuflMetrics.tempoNoteScale;this.height=this.renderer.smuflMetrics.glyphHeights.get(f.MetNoteQuarterUp)*e,this._tupletHeight=this.renderer.smuflMetrics.glyphHeights.get(f.Tuplet3)*e,this._tupletPadding=this.renderer.smuflMetrics.tripletFeelBracketPadding,this.height+=this._tupletHeight}paint(e,s,i){e+=this.x,s+=this.y;let r=Ft.EighthEighth,a=Ft.EighthEighth;switch(this._tripletFeel){case Me.NoTripletFeel:r=Ft.EighthEighth,a=Ft.EighthEighth;break;case Me.Triplet8th:r=Ft.EighthEighth,a=Ft.QuarterTripletEighthTriplet;break;case Me.Triplet16th:r=Ft.SixteenthSixteenth,a=Ft.EighthSixteenthTriplet;break;case Me.Dotted8th:r=Ft.EighthEighth,a=Ft.EighthDottedSixteenth;break;case Me.Dotted16th:r=Ft.SixteenthSixteenth,a=Ft.SixteenthDottedThirtySecond;break;case Me.Scottish8th:r=Ft.EighthEighth,a=Ft.SixteenthEighthDotted;break;case Me.Scottish16th:r=Ft.SixteenthSixteenth,a=Ft.ThirtySecondSixteenthDotted;break}const l=this.renderer.smuflMetrics.tempoNoteScale,h=s+this.renderer.smuflMetrics.glyphTop.get(f.MetNoteQuarterUp)*l,c=s+this.height,d=i.textBaseline;i.textBaseline=Ue.Bottom,i.font=this.renderer.resources.elementFonts.get(v.EffectTripletFeel),i.fillText("(",e,c),e+=i.measureText("( ").width,e=this._drawGroup(e,h+this._tupletHeight,i,r),i.fillText(" = ",e,c),e+=i.measureText(" = ").width,e=this._drawGroup(e,h+this._tupletHeight,i,a),i.fillText(" )",e,c),i.textBaseline=d}_drawGroup(e,s,i,r){const a=this.renderer.smuflMetrics.tempoNoteScale;let l=[],h=[];const c=[];let d=f.None;switch(r){case Ft.EighthEighth:c.push(X.Center),l=[f.MetNoteQuarterUp],h=[f.MetNoteQuarterUp];break;case Ft.SixteenthSixteenth:c.push(X.Center),c.push(X.Center),l=[f.MetNoteQuarterUp],h=[f.MetNoteQuarterUp];break;case Ft.QuarterTripletEighthTriplet:l=[f.MetNoteQuarterUp],h=[f.MetNote8thUp],d=f.Tuplet3;break;case Ft.EighthSixteenthTriplet:c.push(X.Center),c.push(X.Right),l=[f.MetNoteQuarterUp],h=[f.MetNoteQuarterUp],d=f.Tuplet3;break;case Ft.EighthDottedSixteenth:c.push(X.Center),c.push(X.Right),l=[f.MetNoteQuarterUp,f.Space,f.MetAugmentationDot],h=[f.MetNoteQuarterUp];break;case Ft.SixteenthDottedThirtySecond:c.push(X.Center),c.push(X.Center),c.push(X.Right),l=[f.MetNoteQuarterUp,f.Space,f.MetAugmentationDot],h=[f.MetNoteQuarterUp];break;case Ft.SixteenthEighthDotted:c.push(X.Center),c.push(X.Left),l=[f.MetNoteQuarterUp],h=[f.MetNoteQuarterUp,f.Space,f.MetAugmentationDot];break;case Ft.ThirtySecondSixteenthDotted:c.push(X.Center),c.push(X.Center),c.push(X.Left),l=[f.MetNoteQuarterUp],h=[f.MetNoteQuarterUp,f.Space,f.MetAugmentationDot];break}const u=this.renderer.smuflMetrics.glyphWidths.get(f.MetNoteQuarterUp)*a,p=e+u-this.renderer.smuflMetrics.stemThickness*a,g=p+u*2+this.renderer.smuflMetrics.stemThickness*a,m=this.renderer.smuflMetrics.tempoNoteScale*this.renderer.smuflMetrics.beamThickness,y=this.renderer.smuflMetrics.tempoNoteScale*this.renderer.smuflMetrics.beamSpacing,S=this.renderer.smuflMetrics.brokenBeamWidth*a;let k=s-this.renderer.smuflMetrics.glyphHeights.get(f.MetNoteQuarterUp)*a+m;if(d!==f.None){const F=(e+g)/2,q=k-this._tupletHeight-this._tupletPadding,U=this.renderer.smuflMetrics.glyphTop.get(d)*a,x=this.renderer.smuflMetrics.glyphWidths.get(d)*a;kt.fillMusicFontSymbolSafe(i,F,q+U,a,d,!0);const j=F-x/2-this._tupletPadding,Q=F+x/2+this._tupletPadding,Te=this._tupletHeight/2,te=i.lineWidth;i.beginPath(),i.moveTo(e,q+Te+Te),i.lineTo(e,q+Te),i.lineTo(j,q+Te),i.moveTo(Q,q+Te),i.lineTo(g,q+Te),i.lineTo(g,q+Te+Te),i.lineWidth=this.renderer.smuflMetrics.tupletBracketThickness*a,i.stroke(),i.lineWidth=te}i.fillMusicFontSymbols(e,s,a,l,!1),e+=u,e+=u,i.fillMusicFontSymbols(e,s,a,h,!1),e+=u,(h[h.length-1]===f.MetAugmentationDot||h[0]===f.MetNote8thUp)&&(e+=u);for(const T of c){switch(T){case X.Left:i.fillRect(p,k,S,m);break;case X.Center:i.fillRect(p,k,g-p,m);break;case X.Right:i.fillRect(g-S,k,S,m);break}k+=m+y}return e}}class wf extends yt{get notationElement(){return v.EffectTripletFeel}get hideOnMultiTrack(){return!0}get canShareBand(){return!1}get sizingMode(){return Pe.SinglePreBeat}shouldCreateGlyph(t,e){return e.index===0&&(e.voice.bar.masterBar.index===0&&e.voice.bar.masterBar.tripletFeel!==Me.NoTripletFeel||e.voice.bar.masterBar.index>0&&e.voice.bar.masterBar.tripletFeel!==e.voice.bar.masterBar.previousMasterBar.tripletFeel)}createNewGlyph(t,e){return new kf(e.voice.bar.masterBar.tripletFeel)}canExpand(t,e){return!0}}class wh extends Ht{constructor(t){super(0,0,1,wh._getSymbol(t)),this.center=!0}static _getSymbol(t){switch(t){case ps.Open:return f.GuitarOpenPedal;case ps.Closed:return f.GuitarClosePedal}return f.None}paint(t,e,s){super.paint(t,e+this.height,s)}}class Bf extends yt{get notationElement(){return v.EffectWahPedal}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return Pe.SingleOnBeat}shouldCreateGlyph(t,e){return e.wahPedal!==ps.None}createNewGlyph(t,e){return new wh(e.wahPedal)}canExpand(t,e){return!1}}class Tf extends yt{get notationElement(){return v.EffectWhammyBar}get hideOnMultiTrack(){return!1}get canShareBand(){return!1}get sizingMode(){return Pe.GroupedOnBeat}shouldCreateGlyph(t,e){return e.hasWhammyBar}createNewGlyph(t,e){return new Ar("w/bar",v.EffectWhammyBar)}canExpand(t,e){return!0}}class tc extends yt{get notationElement(){return v.EffectWideBeatVibrato}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return Pe.GroupedOnBeatToEnd}shouldCreateGlyph(t,e){return e.vibrato===Ee.Wide}createNewGlyph(t,e){return new Oc(0,0,Ee.Wide)}canExpand(t,e){return!0}}class sc extends Ir{get notationElement(){return v.EffectWideNoteVibrato}shouldCreateGlyphForNote(t){return t.vibrato===Ee.Wide||t.isTieDestination&&t.tieOrigin.vibrato===Ee.Wide}get sizingMode(){return Pe.GroupedOnBeatToEnd}createNewGlyph(t,e){return new ur(0,0,Ee.Wide)}}class ic extends mi{constructor(e,s,i=X.Center){super(e,s);o(this,"_glyphWidth",0);o(this,"_align");this.glyphs=[],this._align=i}doLayout(){const e=this.renderer.smuflMetrics.rowContainerGap,s=this._glyphWidth-e;let i=0;switch(this._align){case X.Left:i=0;break;case X.Center:i=(this.width-s)/2;break;case X.Right:i=this.width-s;break}for(const r of this.glyphs)r.x=i,i+=r.width+e}addGlyphToRow(e){this.glyphs.push(e),this._glyphWidth+=e.width+this.renderer.smuflMetrics.rowContainerGap,e.height>this.height&&(this.height=e.height)}}class Wc extends mi{constructor(e,s,i=X.Center){super(e,s);o(this,"_rows",[]);o(this,"_align");this.height=0,this.glyphs=[],this._align=i}doLayout(){let e=0,s=0;const i=this.renderer.smuflMetrics.rowContainerGap;this._rows=[];let r=new ic(e,s,this._align);r.renderer=this.renderer,r.width=this.width;for(const a of this.glyphs){const l=e+a.width+i;l<this.width?(r.addGlyphToRow(a),e=Math.ceil(l)):(r.isEmpty||(r.doLayout(),this._rows.push(r),s+=r.height+i),e=0,r=new ic(e,s,this._align),r.renderer=this.renderer,r.width=this.width,r.addGlyphToRow(a),e+=Math.ceil(a.width+i))}r.isEmpty||(r.doLayout(),this._rows.push(r),s+=Math.ceil(r.height+this.renderer.smuflMetrics.rowContainerPadding)),this.height=s}paint(e,s,i){for(const r of this._rows)r.paint(e+this.x,s+this.y,i)}}class xf extends Wc{addChord(t){if(t.strings.length>0){const e=new jn(0,0,t,v.ChordDiagrams);e.renderer=this.renderer,e.doLayout(),this.glyphs.push(e)}}paint(t,e,s){var i;if(this.glyphs.length>0){const r=ve.score(s,V.ChordDiagramList,this.renderer.scoreRenderer.score);try{super.paint(t,e,s)}finally{(i=r==null?void 0:r[Symbol.dispose])==null||i.call(r)}}}}class Nf extends Wc{constructor(t,e){super(t,e,X.Left)}}class Pf extends mi{constructor(e,s,i,r){super(e,s);o(this,"_tuning");o(this,"_trackLabel");o(this,"colorOverride");this._tuning=i,this._trackLabel=r,this.glyphs=[]}doLayout(){if(!(this.glyphs.length>0)){this._createGlyphs(this._tuning);for(const e of this.glyphs)e.renderer=this.renderer,e.doLayout()}}paint(e,s,i){const r=i.color;this.colorOverride&&(i.color=this.colorOverride),super.paint(e,s,i),i.color=r}_createGlyphs(e){const s=this.renderer.resources;if(this.height=0,this._trackLabel.length>0){const l=new Js(0,this.height,this._trackLabel,s.elementFonts.get(v.GuitarTuning),X.Left);l.renderer=this.renderer,l.doLayout(),this.height+=l.height,this.addGlyph(l)}if(e.name.length>0){const l=new Js(0,this.height,e.name,s.elementFonts.get(v.GuitarTuning),X.Left);l.renderer=this.renderer,l.doLayout(),this.height+=l.height,this.addGlyph(l)}const i=this.renderer.smuflMetrics.tuningGlyphCircleNumberScale,r=this.renderer.smuflMetrics.glyphHeights.get(f.GuitarString0)*i;this.renderer.scoreRenderer.canvas.font=s.elementFonts.get(v.GuitarTuning);const a=(r+this.renderer.scoreRenderer.canvas.measureText(" = Gb").width)*s.engravingSettings.tuningGlyphStringColumnScale;if(this.width=Math.max(this.renderer.scoreRenderer.canvas.measureText(this._trackLabel).width,Math.max(this.renderer.scoreRenderer.canvas.measureText(e.name).width,2*a)),!e.isStandard){const l=Math.ceil(e.tunings.length/2)|0;let h=0;const c=this.height+this.renderer.smuflMetrics.tuningGlyphStringRowPadding;let d=c;for(let u=0,p=e.tunings.length;u<p;u++){const g=f.GuitarString0+(u+1);this.addGlyph(new Ht(h,d+r,i,g));const m=` = ${Vs.getTextForTuning(e.tunings[u],!1)}`;this.addGlyph(new Js(h+r,d+r/2,m,s.elementFonts.get(v.GuitarTuning),X.Left,Ue.Middle)),d+=r+this.renderer.smuflMetrics.tuningGlyphStringRowPadding;const y=d;this.height<y&&(this.height=y),u===l-1&&(d=c,h+=a)}}}}class Na{constructor(){o(this,"_staffLookup",new Map)}clear(){this._staffLookup.clear()}startMultiSystemSlur(t){const e=Na._staffId(t.renderer.staff);let s;this._staffLookup.has(e)?s=this._staffLookup.get(e):(s={startedSlurs:new Map},this._staffLookup.set(e,s)),s.startedSlurs.set(t.slurEffectId,{startGlyph:t})}static _staffId(t){return`${t.modelStaff.index}.${t.modelStaff.track.index}.${t.staffId}`}completeMultiSystemSlur(t){const e=Na._staffId(t.renderer.staff);if(!this._staffLookup.has(e))return;const s=this._staffLookup.get(e);if(s.startedSlurs.has(t.slurEffectId)){const i=s.startedSlurs.get(t.slurEffectId);return i.endGlyph=t,i.startGlyph}}*getAllContinuations(t){const e=Na._staffId(t.staff);if(!this._staffLookup.has(e)||t.index>0)return;const s=this._staffLookup.get(e);for(const i of s.startedSlurs.values())i.startGlyph.shouldCreateMultiSystemSlur(t)&&(yield i.startGlyph)}}class Cf{constructor(t,e,s,i){o(this,"_factory");o(this,"_sharedLayoutData",new Map);o(this,"staffTrackGroup");o(this,"system");o(this,"barRenderers",[]);o(this,"x",0);o(this,"y",0);o(this,"height",0);o(this,"index",0);o(this,"staffIndex",0);o(this,"isVisible",!1);o(this,"_emptyBarCount",0);o(this,"topEffectInfos",[]);o(this,"bottomEffectInfos",[]);o(this,"trackIndex",0);o(this,"modelStaff");o(this,"staffTop",0);o(this,"topPadding",0);o(this,"bottomPadding",0);o(this,"staffBottom",0);o(this,"topOverflow",0);o(this,"bottomOverflow",0);this._factory=i,this.trackIndex=e,this.modelStaff=s,this.system=t;for(const r of i.effectBands)if(!(r.shouldCreate&&!r.shouldCreate(s)))switch(r.mode){case Se.OwnedTop:case Se.SharedTop:this.topEffectInfos.push(r);break;case Se.OwnedBottom:case Se.SharedBottom:this.bottomEffectInfos.push(r);break}this._updateVisibility()}get isFirstInSystem(){return this.system.firstVisibleStaff===this}get staffId(){return this._factory.staffId}get contentTop(){return this.y+this.staffTop+this.topPadding+this.topOverflow}get contentBottom(){return this.y+this.topPadding+this.topOverflow+this.staffBottom}getSharedLayoutData(t,e){return this._sharedLayoutData.has(t)?this._sharedLayoutData.get(t):e}setSharedLayoutData(t,e){this._sharedLayoutData.set(t,e)}registerStaffTop(t){t>this.staffTop&&(this.staffTop=t)}registerStaffBottom(t){t>this.staffBottom&&(this.staffBottom=t)}addBarRenderer(t){t.staff=this,t.index=this.barRenderers.length,t.reLayout(),this.barRenderers.push(t),this.system.layout.registerBarRenderer(this.staffId,t),(t.bar.isEmpty||t.bar.isRestOnly)&&this._emptyBarCount++,this._updateVisibility()}_updateVisibility(){const t=this.modelStaff.track.score.stylesheet;t.hideEmptyStaves&&(t.hideEmptyStavesInFirstSystem||this.system.index>0)?this.isVisible=this._emptyBarCount<this.barRenderers.length:this.isVisible=!0}addBar(t,e,s){const i=this._factory.create(this.system.layout.renderer,t);i.topEffects.infos=this.topEffectInfos,i.bottomEffects.infos=this.bottomEffectInfos,i.additionalMultiRestBars=s,i.staff=this,i.index=this.barRenderers.length,i.layoutingInfo=e,i.doLayout(),this.barRenderers.push(i),this.system.layout.registerBarRenderer(this.staffId,i),(t.isEmpty||t.isRestOnly)&&this._emptyBarCount++,this._updateVisibility()}revertLastBar(){this.resetSharedLayoutData();const t=this.barRenderers[this.barRenderers.length-1];this.barRenderers.splice(this.barRenderers.length-1,1),this.topOverflow=0,this.bottomOverflow=0;for(const e of this.barRenderers)e.afterStaffBarReverted();return(t.bar.isEmpty||t.bar.isRestOnly)&&this._emptyBarCount--,this._updateVisibility(),t}resetSharedLayoutData(){this._sharedLayoutData.clear()}registerOverflowTop(t){t>this.topOverflow&&(this.topOverflow=t)}registerOverflowBottom(t){t>this.bottomOverflow&&(this.bottomOverflow=t)}calculateHeightForAccolade(){this._applyStaffPaddings(),this.height=this.barRenderers.length>0?this.barRenderers[0].height:0,this.height>0&&(this.height+=Math.ceil(this.topPadding+this.topOverflow+this.bottomOverflow+this.bottomPadding))}_applyStaffPaddings(){const t=this.index===0,e=this.index===this.system.staves.length-1,s=this.system.layout.renderer.settings.display;this.topPadding=t?s.firstNotationStaffPaddingTop:s.notationStaffPaddingTop,this.bottomPadding=e?s.lastNotationStaffPaddingBottom:s.notationStaffPaddingBottom}finalizeStaff(){this._applyStaffPaddings(),this.height=0;let t=!1,e=this.topOverflow;for(const s of this.barRenderers)s.registerMultiSystemSlurs(this.system.layout.slurRegistry.getAllContinuations(s)),s.finalizeRenderer()&&(t=!0),this.height=Math.max(this.height,s.height);if(t){e=this.topOverflow;for(const s of this.barRenderers)s.y=this.topPadding+e;for(const s of this.barRenderers)s.finalizeRenderer()}this.height>0&&(this.height+=this.topPadding+e+this.bottomOverflow+this.bottomPadding),this.height=Math.ceil(this.height),this._updateVisibility()}paint(t,e,s,i,r){if(!(this.height===0||r===0))for(let a=i,l=Math.min(i+r,this.barRenderers.length);a<l;a++)this.barRenderers[a].paint(t+this.x,e+this.y,s)}}class rc{constructor(){o(this,"timePosition",0);o(this,"longestDuration",0);o(this,"smallestDuration",0);o(this,"force",0);o(this,"springConstant",0);o(this,"preBeatWidth",0);o(this,"graceBeatWidth",0);o(this,"postSpringWidth",0);o(this,"allDurations",new Set)}get springWidth(){return this.preSpringWidth+this.postSpringWidth}get preSpringWidth(){return this.preBeatWidth+this.graceBeatWidth}}const Jr=class Jr{constructor(){o(this,"_timeSortedSprings",[]);o(this,"_minTime",-1);o(this,"_onTimePositionsForce",0);o(this,"_onTimePositions",new Map);o(this,"_incompleteGraceRodsWidth",0);o(this,"_beatSizes",new Map);o(this,"_minDuration",Jr._defaultMinDuration);o(this,"version",0);o(this,"preBeatSize",0);o(this,"postBeatSize",0);o(this,"minStretchForce",0);o(this,"totalSpringConstant",0);o(this,"incompleteGraceRods",new Map);o(this,"allGraceRods",new Map);o(this,"springs",new Map);o(this,"height",0)}_updateMinStretchForce(t){this.minStretchForce<t&&(this.minStretchForce=t)}getBeatSizes(t){const e=t.absoluteDisplayStart;if(this._beatSizes.has(e))return this._beatSizes.get(e)}setBeatSizes(t,e){const s=t.absoluteDisplayStart;if(this._beatSizes.has(s)){const i=this._beatSizes.get(s);i.onBeatSize<e.onBeatSize&&(i.onBeatSize=e.onBeatSize),i.preBeatSize<e.preBeatSize&&(i.preBeatSize=e.preBeatSize)}else this._beatSizes.set(s,e)}getPreBeatSize(t){if(t.graceType!==ee.None){const s=t.graceGroup.id;return this.allGraceRods.get(s)[t.graceIndex].preBeatWidth}const e=t.absoluteDisplayStart;return this.springs.has(e)?this.springs.get(e).preBeatWidth:0}getPostBeatSize(t){if(t.graceType!==ee.None){const s=t.graceGroup.id;return this.allGraceRods.get(s)[t.graceIndex].postSpringWidth}const e=t.absoluteDisplayStart;return this.springs.has(e)?this.springs.get(e).postSpringWidth:0}addSpring(t,e,s,i,r){this.version++;let a;if(this.springs.has(t))a=this.springs.get(t),a.postSpringWidth<r&&(a.postSpringWidth=r),a.graceBeatWidth<s&&(a.graceBeatWidth=s),a.preBeatWidth<i&&(a.preBeatWidth=i),e<a.smallestDuration&&(a.smallestDuration=e),e>a.longestDuration&&(a.longestDuration=e),a.allDurations.add(e);else{if(a=new rc,a.timePosition=t,a.allDurations.add(e),this._timeSortedSprings.length>0){const c=this._timeSortedSprings[this._timeSortedSprings.length-1];for(const d of c.allDurations)c.timePosition+d;e<this._minDuration&&(this._minDuration=e)}a.longestDuration=e,a.postSpringWidth=r,a.graceBeatWidth=s,a.preBeatWidth=i,this.springs.set(t,a);const l=this._timeSortedSprings;let h=l.length-1;for(;h>0&&l[h].timePosition>t;)h--;this._timeSortedSprings.splice(h+1,0,a)}return(this._minTime===-1||this._minTime>t)&&(this._minTime=t),a}addBeatSpring(t,e,s){const i=t.absoluteDisplayStart;if(t.graceType!==ee.None){const r=t.graceGroup.id;this.allGraceRods.has(r)||this.allGraceRods.set(r,new Array(t.graceGroup.beats.length)),!t.graceGroup.isComplete&&!this.incompleteGraceRods.has(r)&&this.incompleteGraceRods.set(r,new Array(t.graceGroup.beats.length));const a=this.allGraceRods.get(r)[t.graceIndex];if(a)a.postSpringWidth<s&&(a.postSpringWidth=s),a.preBeatWidth<e&&(a.preBeatWidth=e);else{const l=new rc;l.timePosition=i,l.postSpringWidth=s,l.preBeatWidth=e,t.graceGroup.isComplete||(this.incompleteGraceRods.get(r)[t.graceIndex]=l),this.allGraceRods.get(r)[t.graceIndex]=l}}else{let r=0;if(t.graceGroup&&this.allGraceRods.has(t.graceGroup.id))for(const a of this.allGraceRods.get(t.graceGroup.id))r+=a.springWidth;this.addSpring(i,t.displayDuration,r,e,s)}}finish(){for(const[t,e]of this.allGraceRods){let s=0;for(const i of e)s+=i.preBeatWidth,i.graceBeatWidth=s,s+=i.postSpringWidth}this._incompleteGraceRodsWidth=0;for(const t of this.incompleteGraceRods.values())for(const e of t)this._incompleteGraceRodsWidth+=e.preBeatWidth+e.postSpringWidth;this._calculateSpringConstants(),this.version++}_calculateSpringConstants(){let t=0;const e=this._timeSortedSprings;if(e.length===0){this.totalSpringConstant=-1,this.minStretchForce=-1;return}for(let s=0;s<e.length;s++){const i=e[s];let r=0;if(s===e.length-1)r=i.longestDuration;else{const a=e[s+1];r=Math.abs(a.timePosition-i.timePosition)}i.springConstant=this._calculateSpringConstant(i,r),t+=1/i.springConstant}this.totalSpringConstant=1/t,this.minStretchForce=0;for(let s=0;s<e.length;s++){const i=e[s];let r=0;if(s===e.length-1)r=i.postSpringWidth;else{const l=e[s+1];r=i.postSpringWidth+l.preSpringWidth}s===0&&(r+=i.preSpringWidth);const a=r*i.springConstant;this._updateMinStretchForce(a)}}paint(t,e,s){}_calculateSpringConstant(t,e){e<=0&&(e=D.toTicks(b.TwoHundredFiftySixth)),t.smallestDuration===0&&(t.smallestDuration=e);const s=t.smallestDuration,i=this._minDuration,r=Jr._defaultMinDurationWidth,a=1+.85*Math.log2(e/i);return s/e*(1/(a*r))}spaceToForce(t){return this.totalSpringConstant!==-1?(this._timeSortedSprings.length>0&&(t-=this._timeSortedSprings[0].preSpringWidth),t-=this._incompleteGraceRodsWidth,Math.max(t,0)*this.totalSpringConstant):-1}calculateVoiceWidth(t){let e=0;return this.totalSpringConstant!==-1&&(e=this._calculateWidth(t,this.totalSpringConstant)),this._timeSortedSprings.length>0&&(e+=this._timeSortedSprings[0].preSpringWidth),e+=this._incompleteGraceRodsWidth,e}_calculateWidth(t,e){return t/e}buildOnTimePositions(t){if(this.totalSpringConstant===-1)return new Map;if(A.isAlmostEqualTo(this._onTimePositionsForce,t)&&this._onTimePositions)return this._onTimePositions;this._onTimePositionsForce=t;const e=new Map;this._onTimePositions=e;const s=this._timeSortedSprings;if(s.length===0)return e;let i=s[0].preSpringWidth;for(let r=0;r<s.length;r++)e.set(s[r].timePosition,i),i+=this._calculateWidth(t,s[r].springConstant);return e}};o(Jr,"_defaultMinDuration",30),o(Jr,"_defaultMinDurationWidth",7);let xl=Jr;class Ef{constructor(){o(this,"width",0);o(this,"isLinkedToPrevious",!1);o(this,"canWrap",!0);o(this,"masterBar");o(this,"additionalMultiBarRestIndexes",null);o(this,"renderers",[]);o(this,"layoutingInfo")}get lastMasterBarIndex(){return this.additionalMultiBarRestIndexes?this.additionalMultiBarRestIndexes[this.additionalMultiBarRestIndexes.length-1]:this.masterBar.index}}class vf{constructor(t,e){o(this,"track");o(this,"staffSystem");o(this,"staves",[]);o(this,"firstVisibleStaff");o(this,"lastVisibleStaff");o(this,"bracket",null);this.staffSystem=t,this.track=e}addStaff(t){this.staves.push(t)}}class Df{constructor(t){o(this,"_system");o(this,"firstStaffInBracket");o(this,"lastStaffInBracket");o(this,"firstVisibleStaffInBracket");o(this,"lastVisibleStaffInBracket");o(this,"drawAsBrace",!1);o(this,"braceScale",1);o(this,"width",0);o(this,"index",0);o(this,"canPaint",!1);this._system=t}updateCanPaint(){let t,e;for(let i=this.firstStaffInBracket.index;i<=this.lastStaffInBracket.index;i++){const r=this._system.allStaves[i];r.isVisible&&(t||(t=r),e=r)}if(this.firstVisibleStaffInBracket=t,this.lastVisibleStaffInBracket=e,!t||!e){this.canPaint=!1;return}if(!this._system.layout.renderer.score.stylesheet.showSingleStaffBrackets&&t===e){this.canPaint=!1;return}this.canPaint=!0}finalizeBracket(t){if(!this.canPaint){this.width=0;return}const e=t.glyphHeights.get(f.Brace),s=t.glyphWidths.get(f.Brace);if(this.drawAsBrace?this.width=s:this.width=t.bracketThickness,!this.drawAsBrace)return;const i=this.firstVisibleStaffInBracket.contentTop,l=(this.lastVisibleStaffInBracket.contentBottom-i)/e;this.braceScale=l,this.width=s*this.braceScale}}class xo extends Df{constructor(e,s){super(e);o(this,"track");this.track=s,this.drawAsBrace=xo.isTrackDrawAsBrace(s)}includesStaff(e){return e.modelStaff.track===this.track}static isTrackDrawAsBrace(e){return e.staves.filter(s=>s.showStandardNotation).length>1}}class Lf extends xo{includesStaff(t){return t.modelStaff.track===this.track?!0:this.drawAsBrace?!1:this.track.playbackInfo.program===t.modelStaff.track.playbackInfo.program}}class Mf{constructor(t){o(this,"_accoladeSpacingCalculated",!1);o(this,"_brackets",[]);o(this,"_staffToBracket",new Map);o(this,"_contentHeight",0);o(this,"_hasSystemSeparator",!1);o(this,"x",0);o(this,"y",0);o(this,"index",0);o(this,"accoladeWidth",0);o(this,"isFull",!1);o(this,"width",0);o(this,"computedWidth",0);o(this,"totalBarDisplayScale",0);o(this,"isLast",!1);o(this,"masterBarsRenderers",[]);o(this,"staves",[]);o(this,"layout");o(this,"topPadding");o(this,"bottomPadding");o(this,"allStaves",[]);o(this,"firstVisibleStaff");this.layout=t,this.topPadding=t.renderer.settings.display.systemPaddingTop,this.bottomPadding=t.renderer.settings.display.systemPaddingBottom}get firstBarIndex(){return this.masterBarsRenderers[0].masterBar.index}get lastBarIndex(){return this.masterBarsRenderers[this.masterBarsRenderers.length-1].lastMasterBarIndex}addMasterBarRenderers(t,e){if(t.length===0)return null;this.masterBarsRenderers.push(e),e.layoutingInfo.preBeatSize=0;let s=0,i,r=!1;for(const a of this.staves){let l,h;for(const c of a.staves){const d=e.renderers[s++];c.addBarRenderer(d),c.isVisible&&(r=!0,l||(l=c),i||(i=c),h=c)}a.firstVisibleStaff=l,a.lastVisibleStaff=h,i||(i=l)}if(!r){const a=this.staves[0],l=a.staves[0];l.isVisible=!0,a.firstVisibleStaff=l,a.lastVisibleStaff=l,i=l}return this.firstVisibleStaff=i,this._calculateAccoladeSpacing(t),this._applyLayoutAndUpdateWidth(),e}addBars(t,e,s){const i=new Ef;i.additionalMultiBarRestIndexes=s,i.layoutingInfo=new xl,i.masterBar=t[0].score.masterBars[e],this.masterBarsRenderers.push(i);let r,a=!1;const l=i.layoutingInfo;for(const h of this.staves){let c,d;for(const u of h.staves){const p=h.track.staves[u.modelStaff.index].bars[e],g=s==null?null:s.map(y=>h.track.staves[u.modelStaff.index].bars[y]);u.addBar(p,l,g),u.isVisible&&(a=!0,c||(c=u),d=u);const m=u.barRenderers[u.barRenderers.length-1];i.renderers.push(m),m.isLinkedToPrevious&&(i.isLinkedToPrevious=!0),m.canWrap||(i.canWrap=!1)}h.firstVisibleStaff=c,h.lastVisibleStaff=d,r||(r=c)}if(!a){const h=this.staves[0],c=h.staves[0];c.isVisible=!0,h.firstVisibleStaff=c,h.lastVisibleStaff=c,r=c}return this.firstVisibleStaff=r,this._calculateAccoladeSpacing(t),l.finish(),i.width=this._applyLayoutAndUpdateWidth(),i}getBarDisplayScale(t){return this.staves.length>1?t.bar.masterBar.displayScale:t.bar.displayScale}revertLastBar(){if(this.masterBarsRenderers.length>1){const t=this.masterBarsRenderers[this.masterBarsRenderers.length-1];this.masterBarsRenderers.splice(this.masterBarsRenderers.length-1,1);let e=0,s=0,i;for(const r of this.staves){let a,l;for(const h of r.staves){const c=h.revertLastBar(),d=c.computedWidth;d>e&&(e=d),c.afterReverted(),s=this.getBarDisplayScale(c),h.isVisible&&(a||(a=h),l=h)}r.firstVisibleStaff=a,r.lastVisibleStaff=l,i||(i=a)}return this.firstVisibleStaff=i,this.width-=e,this.computedWidth-=e,this.totalBarDisplayScale-=s,t}return null}_applyLayoutAndUpdateWidth(){let t=0,e=0;for(const s of this.allStaves){const i=s.barRenderers[s.barRenderers.length-1];i.applyLayoutingInfo(),e=this.getBarDisplayScale(i),i.computedWidth>t&&(t=i.computedWidth)}return this.totalBarDisplayScale+=e,this.width+=t,this.computedWidth+=t,t}_calculateAccoladeSpacing(t){const e=this.layout.renderer.settings;if(this._accoladeSpacingCalculated)for(const s of this._brackets)s.updateCanPaint(),s.finalizeBracket(e.display.resources.engravingSettings);else{this._accoladeSpacingCalculated=!0,this.accoladeWidth=0;const s=this.layout.renderer.score.stylesheet;if(this.layout.renderer.settings.notation.isNotationElementVisible(v.TrackNames)){const l=this.layout.renderer.tracks.length===1?s.singleTrackTrackNamePolicy:s.multiTrackTrackNamePolicy,h=this.index===0?s.firstSystemTrackNameMode:s.otherSystemsTrackNameMode,c=this.index===0?s.firstSystemTrackNameOrientation:s.otherSystemsTrackNameOrientation;let d=!1;switch(l){case Tt.Hidden:break;case Tt.FirstSystem:d=this.index===0;break;case Tt.AllSystems:d=!0;break}let u=!1;if(d){const p=this.layout.renderer.canvas,g=e.display.resources.elementFonts.get(v.TrackNames);p.font=g;for(const m of t){let y="";switch(h){case ls.FullName:y=m.name;break;case ls.ShortName:y=m.shortName;break}if(y.length>0){u=!0;const S=p.measureText(y);switch(c){case hs.Horizontal:this.accoladeWidth=Math.ceil(Math.max(this.accoladeWidth,S.width));break;case hs.Vertical:this.accoladeWidth=Math.ceil(Math.max(this.accoladeWidth,S.height));break}}}this.accoladeWidth+=e.display.systemLabelPaddingLeft,u&&(this.accoladeWidth+=e.display.systemLabelPaddingRight)}}let r=0;for(const l of this.allStaves)l.y=r,l.calculateHeightForAccolade(),r+=l.height;let a=0;for(const l of this._brackets)l.updateCanPaint(),l.finalizeBracket(e.display.resources.engravingSettings),a=Math.max(a,l.width);this.accoladeWidth+=a,this.width+=this.accoladeWidth,this.computedWidth+=this.accoladeWidth}}_getStaffTrackGroup(t){for(let e=0,s=this.staves.length;e<s;e++){const i=this.staves[e];if(i.track===t)return i}return null}addStaff(t){const e=t.modelStaff.track;let s=this._getStaffTrackGroup(e);s||(s=new vf(this,e),this.staves.push(s)),t.staffTrackGroup=s,t.system=this,t.index=this.allStaves.length,this.allStaves.push(t),s.addStaff(t);let i=this._brackets.find(r=>r.includesStaff(t));if(!i)switch(e.score.stylesheet.bracketExtendMode){case nr.NoBrackets:break;case nr.GroupStaves:i=new xo(this,e),i.index=this._brackets.length,this._brackets.push(i);break;case nr.GroupSimilarInstruments:i=new Lf(this,e),i.index=this._brackets.length,this._brackets.push(i);break}i&&(i.firstStaffInBracket||(i.firstStaffInBracket=t),i.lastStaffInBracket=t,s.bracket=i,this._staffToBracket.set(t,i))}get height(){return Math.ceil(this._contentHeight+this.topPadding+this.bottomPadding)}paint(t,e,s){var i;if(this.paintPartial(t+this.x,e+this.y+this.topPadding,s,0,this.masterBarsRenderers.length),this._hasSystemSeparator){const r=ve.track(s,fi.SystemSeparator,this.allStaves[0].modelStaff.track);try{const a=this.layout.renderer.settings.display.resources.engravingSettings,l=Math.min(0,a.glyphBottom.get(f.SystemDivider)??0);kt.fillMusicFontSymbolSafe(s,t+this.x,e+this.y+this.height+l,1,f.SystemDivider,!1),kt.fillMusicFontSymbolSafe(s,t+this.x+this.width-a.glyphWidths.get(f.SystemDivider),e+this.y+this.height+l,1,f.SystemDivider,!1)}finally{(i=r==null?void 0:r[Symbol.dispose])==null||i.call(r)}}}paintPartial(t,e,s,i,r){var l,h,c;for(const d of this.allStaves)d.isVisible&&d.paint(t,e,s,i,r);const a=this.layout.renderer.settings.display.resources;if(this.staves.length>0&&i===0){s.color=a.barSeparatorColor;const d=this.layout.renderer.settings,u=this.layout.renderer.settings.notation.isNotationElementVisible(v.TrackNames);if(s.font=a.elementFonts.get(v.TrackNames),u){const g=this.layout.renderer.score.stylesheet,m=this.layout.renderer.tracks.length===1?g.singleTrackTrackNamePolicy:g.multiTrackTrackNamePolicy,y=this.index===0?g.firstSystemTrackNameMode:g.otherSystemsTrackNameMode,S=this.index===0?g.firstSystemTrackNameOrientation:g.otherSystemsTrackNameOrientation;let k=!1;switch(m){case Tt.Hidden:break;case Tt.FirstSystem:k=this.index===0;break;case Tt.AllSystems:k=!0;break}if(k){const T=s.textBaseline,N=s.textAlign;for(const F of this.staves)if(F.firstVisibleStaff){const q=e+F.firstVisibleStaff.contentTop,U=e+F.lastVisibleStaff.contentBottom;let x="";switch(y){case ls.FullName:x=F.track.name;break;case ls.ShortName:x=F.track.shortName;break}const j=ve.track(s,fi.TrackName,F.track);try{if(x.length>0){const Q=t+F.staves[0].x-d.display.accoladeBarPaddingRight-(((l=F.bracket)==null?void 0:l.width)??0)-d.display.systemLabelPaddingRight;switch(S){case hs.Horizontal:s.textBaseline=Ue.Middle,s.textAlign=X.Right,s.fillText(x,Q,(q+U)/2);break;case hs.Vertical:s.textBaseline=Ue.Bottom,s.textAlign=X.Center,s.beginRotate(Q,(q+U)/2,-90-.1),s.fillText(x,0,0),s.endRotate();break}}}finally{(h=j==null?void 0:j[Symbol.dispose])==null||h.call(j)}}s.textBaseline=T,s.textAlign=N}}const p=!this.layout.renderer.score.stylesheet.extendBarLines;if(this.allStaves.length>0&&p){let g=null;for(const m of this.allStaves)if(m.isVisible){if(g!==null){const y=g.contentBottom,S=m.contentTop,k=t+g.x,T=g.barRenderers[0],N=ve.bar(s,T.staffLineBarSubElement,T.bar);try{const F=Math.ceil(S-y);s.fillRect(k,e+y,a.engravingSettings.thinBarlineThickness,F)}finally{(c=N==null?void 0:N[Symbol.dispose])==null||c.call(N)}}g=m}}this._paintBrackets(t,e,s)}}_paintBrackets(t,e,s){const i=this.layout.renderer.settings;for(const r of this._brackets)if(r.canPaint){const a=t+r.firstVisibleStaffInBracket.x,l=r.width,h=i.display.accoladeBarPaddingRight,c=e+r.firstVisibleStaffInBracket.contentTop,d=e+r.lastVisibleStaffInBracket.contentBottom;let u=c,p=d;if(r.drawAsBrace)kt.fillMusicFontSymbolSafe(s,a-h-l,p,r.braceScale,f.Brace);else if(r.firstVisibleStaffInBracket!==r.lastVisibleStaffInBracket){const m=i.display.resources.engravingSettings.oneStaffSpace*.25;u-=m,p+=m;const y=3;s.fillRect(a-h-l,u-y,l,Math.ceil(p-u+y*2));const S=a-h-l;kt.fillMusicFontSymbolSafe(s,S,u,1,f.BracketTop),kt.fillMusicFontSymbolSafe(s,S,Math.floor(p),1,f.BracketBottom)}}}finalizeSystem(){const t=this.layout.renderer.settings;if(this.index===0&&(this.topPadding=t.display.firstSystemPaddingTop),this.isLast)this.bottomPadding=t.display.lastSystemPaddingBottom;else if(this.layout.renderer.score.stylesheet.useSystemSignSeparator&&this.layout.renderer.tracks.length>1){const s=t.display.resources.engravingSettings.glyphHeights.get(f.SystemDivider);this.bottomPadding=Math.max(this.bottomPadding,s),this._hasSystemSeparator=!0}if(!this._finalizeTrackGroups()){const i=this.staves[0].staves[0];i.isVisible=!0,this._finalizeTrackGroups(!0)}for(const s of this._brackets)s.finalizeBracket(t.display.resources.engravingSettings)}_finalizeTrackGroups(t=!1){let e=0;const s=this.layout.renderer.settings,i=s.display.resources.engravingSettings,r=i.glyphHeights.get(f.BracketTop),a=i.glyphHeights.get(f.BracketBottom);let l,h=0,c=!1;for(const d of this.staves){let u,p;for(const g of d.staves){l!==void 0&&l.trackIndex!==g.trackIndex&&(e+=s.display.trackStaffPaddingBetween);const m=this._staffToBracket.has(g)?this._staffToBracket.get(g):void 0,y=m&&!m.drawAsBrace&&m.canPaint;if(y&&m.firstStaffInBracket===g){const S=r-g.topOverflow;S>0&&(e+=S)}if(g.x=this.accoladeWidth,g.y=e,t||g.finalizeStaff(),g.isVisible&&(e+=g.height,c=!0,l=g,u||(u=g),p=g),h=0,y&&m.lastStaffInBracket===g){const S=a-g.bottomOverflow;S>0&&(g.isVisible?e+=S:h=S)}}if(d.firstVisibleStaff=u,d.lastVisibleStaff=p,this.firstVisibleStaff||(this.firstVisibleStaff=u),t)break}return h&&(e+=h),this._contentHeight=e,c}buildBoundingsLookup(t,e){if(this.layout.renderer.boundsLookup.isFinished)return;const s=this.allStaves[0],i=this.allStaves[this.allStaves.length-1];e+=this.topPadding;const r=e+this.y+s.y,l=e+this.y+i.y+i.height-r,h=e+this.y,d=e+this.y+this.height-h,u=e+this.y+s.y+s.topPadding+s.topOverflow,g=e+this.y+i.y+i.height-i.bottomPadding-i.bottomOverflow-u,m=this.x+s.x,y=new fh;y.visualBounds=new Pt,y.visualBounds.x=t+this.x,y.visualBounds.y=e+this.y,y.visualBounds.w=this.width,y.visualBounds.h=this.height-this.topPadding-this.bottomPadding,y.realBounds=new Pt,y.realBounds.x=t+this.x,y.realBounds.y=e+this.y,y.realBounds.w=this.width,y.realBounds.h=this.height,this.layout.renderer.boundsLookup.addStaffSystem(y);const S=new Map;for(let k=0;k<this.staves.length;k++)for(const T of this.staves[k].staves)if(T.isVisible)for(const N of T.barRenderers){let F;S.has(N.bar.masterBar.index)?F=S.get(N.bar.masterBar.index):(F=new uh,F.index=N.bar.masterBar.index,F.isFirstOfLine=N.isFirstOfStaff,F.realBounds=new Pt,F.realBounds.x=m+N.x,F.realBounds.y=h,F.realBounds.w=N.width,F.realBounds.h=d,F.visualBounds=new Pt,F.visualBounds.x=m+N.x,F.visualBounds.y=r,F.visualBounds.w=N.width,F.visualBounds.h=l,F.lineAlignedBounds=new Pt,F.lineAlignedBounds.x=m+N.x,F.lineAlignedBounds.y=u,F.lineAlignedBounds.w=N.width,F.lineAlignedBounds.h=g,this.layout.renderer.boundsLookup.addMasterBar(F),S.set(F.index,F)),N.buildBoundingsLookup(F,m,e+this.y+T.y)}}getBarX(t){if(this.allStaves.length===0||this.layout.renderer.tracks.length===0)return 0;const e=this.layout.renderer.tracks[0].staves[0].bars[t];return this.layout.getRendererForBar(this.allStaves[0].staffId,e).x}}class Ff{constructor(t,e){o(this,"args");o(this,"renderCallback");this.args=t,this.renderCallback=e}}const Sr=class Sr{constructor(t){o(this,"_barRendererLookup",new Map);o(this,"pagePadding",null);o(this,"profile",new Set);o(this,"renderer");o(this,"width",0);o(this,"height",0);o(this,"multiBarRestInfo",null);o(this,"headerGlyphs",new Map);o(this,"footerGlyphs",new Map);o(this,"chordDiagrams",null);o(this,"tuningGlyph",null);o(this,"slurRegistry",new Na);o(this,"beamingRuleLookups",new Map);o(this,"_lazyPartials",new Map);o(this,"firstBarIndex",0);o(this,"lastBarIndex",0);this.renderer=t}get scaledWidth(){return Math.round(this.width/this.renderer.settings.display.scale)}resize(){this._lazyPartials.clear(),this.slurRegistry.clear(),this.doResize()}layoutAndRender(t){this._lazyPartials.clear(),this.slurRegistry.clear(),this.beamingRuleLookups.clear(),this._barRendererLookup.clear(),this.profile=fe.staveProfiles.get(this.renderer.settings.display.staveProfile);const e=this.renderer.score;this.firstBarIndex=A.computeFirstDisplayedBarIndex(e,this.renderer.settings),this.lastBarIndex=A.computeLastDisplayedBarIndex(e,this.renderer.settings,this.firstBarIndex),this.multiBarRestInfo=A.buildMultiBarRestInfo(this.renderer.tracks,this.firstBarIndex,this.lastBarIndex),this.pagePadding=this.renderer.settings.display.padding.map(s=>s/this.renderer.settings.display.scale),this.pagePadding||(this.pagePadding=[0,0,0,0]),this.pagePadding.length===1?this.pagePadding=[this.pagePadding[0],this.pagePadding[0],this.pagePadding[0],this.pagePadding[0]]:this.pagePadding.length===2&&(this.pagePadding=[this.pagePadding[0],this.pagePadding[1],this.pagePadding[0],this.pagePadding[1]]),this._createScoreInfoGlyphs(),this.doLayoutAndRender(t)}registerPartial(t,e){if(t.height===0)return;const s=this.renderer.settings.display.scale;t.x*=s,t.y*=s,t.width*=s,t.height*=s,t.totalWidth*=s,t.totalHeight*=s,this.renderer.settings.core.enableLazyLoading?(this._lazyPartials.set(t.id,new Ff(t,e)),this.renderer.partialLayoutFinished.trigger(t)):(this.renderer.partialLayoutFinished.trigger(t),this._internalRenderLazyPartial(t,e))}_internalRenderLazyPartial(t,e){const s=this.renderer.canvas;s.beginRender(t.width,t.height),e(s),t.renderResult=s.endRender(),this.renderer.partialRenderFinished.trigger(t)}renderLazyPartial(t){if(this._lazyPartials.has(t)){const e=this._lazyPartials.get(t);this._internalRenderLazyPartial(e.args,e.renderCallback)}}_createHeaderFooterGlyph(t,e,s,i){switch(s){case V.WordsAndMusic:if(e.words!==e.music)return;break;case V.Words:case V.Music:if(e.words===e.music)return;break;case V.CopyrightSecondLine:if(!this.footerGlyphs.has(V.Copyright))return;break}const r=t.display.resources,a=t.notation,h=e.style&&e.style.headerAndFooter.has(s)?e.style.headerAndFooter.get(s):Ui.defaultHeaderAndFooter.get(s);let c=h.isVisible!==void 0?h.isVisible:!0;if(i!==void 0&&(c=a.isNotationElementVisible(i)),!c)return;const d=h.buildText(e);if(d)return new Js(0,0,d,r.getFontForElement(s),h.textAlign,void 0,ve.scoreColor(r,s,e))}_createScoreInfoGlyphs(){L.debug("ScoreLayout","Creating score info glyphs");const t=this.renderer.settings,e=this.renderer.score;this.headerGlyphs=new Map,this.footerGlyphs=new Map;const s=new Bl(this.renderer,this.renderer.tracks[0].staves[0].bars[0]);for(const[a,l]of Sr.headerElements.value){const h=this._createHeaderFooterGlyph(t,e,a,l);h&&(h.renderer=s,h.doLayout(),this.headerGlyphs.set(a,h))}for(const[a,l]of Sr.footerElements.value){const h=this._createHeaderFooterGlyph(t,e,a,l);h&&(h.renderer=s,h.doLayout(),this.footerGlyphs.set(a,h))}const i=t.notation,r=t.display.resources;if(i.isNotationElementVisible(v.GuitarTuning)){const a=[];for(const l of this.renderer.tracks)for(const h of l.staves){let c=!h.isPercussion&&h.isStringed&&h.tuning.length>0&&h.showTablature;if(e.stylesheet.perTrackDisplayTuning&&e.stylesheet.perTrackDisplayTuning.has(l.index)&&e.stylesheet.perTrackDisplayTuning.get(l.index)===!1&&(c=!1),c){a.push(h);break}}if(a.length>0&&e.stylesheet.globalDisplayTuning){this.tuningGlyph=new Nf(0,0),this.tuningGlyph.renderer=s;for(const l of a)if(l.stringTuning.tunings.length>0){const h=a.length>1?l.track.name:"",c=new Pf(0,0,l.stringTuning,h);c.colorOverride=ve.trackColor(r,fi.StringTuning,l.track),c.renderer=s,c.doLayout(),this.tuningGlyph.addGlyph(c)}}else this.tuningGlyph=null}if(i.isNotationElementVisible(v.ChordDiagrams)){this.chordDiagrams=new xf(0,0),this.chordDiagrams.renderer=s;const a=new Set;for(const l of this.renderer.tracks)if(e.stylesheet.globalDisplayChordDiagramsOnTop&&(e.stylesheet.perTrackChordDiagramsOnTop==null||!e.stylesheet.perTrackChordDiagramsOnTop.has(l.index)||e.stylesheet.perTrackChordDiagramsOnTop.get(l.index)))for(const c of l.staves){const d=c.chords;if(d)for(const[,u]of d)a.has(u.uniqueId)||u.showDiagram&&(a.add(u.uniqueId),this.chordDiagrams.addChord(u))}this.chordDiagrams.isEmpty&&(this.chordDiagrams=null)}else this.chordDiagrams=null}createEmptyStaffSystem(t){const e=new Mf(this);e.index=t;const s=fe.defaultRenderers,i=[];for(let r=0;r<this.renderer.tracks.length;r++){const a=this.renderer.tracks[r];for(let l=0;l<a.staves.length;l++){const h=a.staves[l];let c=[],d=[],u;for(const p of s)if(this.profile.has(p.staffId)&&p.canCreate(a,h)){const g=new Cf(e,r,h,p);g.topEffectInfos.splice(0,0,...c),g.bottomEffectInfos.push(...d),u=g,i.push(g),c=[],d=[]}else for(const g of p.effectBands)switch(g.mode){case Se.SharedTop:c.push(g);break;case Se.SharedBottom:d.push(g);break}u&&(c.length>0&&u.bottomEffectInfos.push(...c),d.length>0&&u.bottomEffectInfos.push(...d))}}for(const r of i)e.addStaff(r);return e}registerBarRenderer(t,e){if(this._barRendererLookup.has(t)||this._barRendererLookup.set(t,new Map),this._barRendererLookup.get(t).set(e.bar.id,e),e.additionalMultiRestBars)for(const s of e.additionalMultiRestBars)this._barRendererLookup.get(t).set(s.id,e)}getRendererForBar(t,e){const s=e.id;return this._barRendererLookup.has(t)&&this._barRendererLookup.get(t).has(s)?this._barRendererLookup.get(t).get(s):null}layoutAndRenderBottomScoreInfo(t){t=Math.round(t);const e=new Hi;e.x=0,e.y=t;let s=0;const i=this.renderer.settings.display.resources,r=[];let a=0;for(const[l,h]of Sr.footerElements.value)if(this.footerGlyphs.has(l)){const c=this.footerGlyphs.get(l);c.y=s,this.alignScoreInfoGlyph(c),s+=c.height,r.push(c),a=Math.max(a,Math.round(c.x+c.width))}return s=Math.round(s),r.length>0&&(e.width=a,e.height=s,e.totalWidth=this.scaledWidth,e.totalHeight=t+e.height,this.registerPartial(e,l=>{l.color=i.scoreInfoColor,l.textAlign=X.Left,l.textBaseline=Ue.Top;for(const h of r)h.paint(0,0,l)})),t+s}alignScoreInfoGlyph(t){if(fe.getLayoutEngineFactory(this.renderer.settings.display.layoutMode).vertical)switch(t.textAlign){case X.Left:t.x=this.pagePadding[0];break;case X.Center:t.x=this.scaledWidth/2;break;case X.Right:t.x=this.scaledWidth-this.pagePadding[2];break}else t.x=this.firstBarX,t.textAlign=X.Left}layoutAndRenderAnnotation(t){const e="rendered by alphaTab",s=this.renderer.settings.display.resources,i=12,r=s.elementFonts.has(v.ScoreCopyright)?s.elementFonts.get(v.ScoreCopyright).families:s.tablatureFont.families,a=Ye.withFamilyList(r,i,st.Plain,bs.Bold),l=new Bl(this.renderer,this.renderer.tracks[0].staves[0].bars[0]),h=new Js(0,0,e,a,X.Center,void 0,s.mainGlyphColor);h.renderer=l,h.doLayout(),this.alignScoreInfoGlyph(h);const c=new Hi;return c.width=h.x+h.width,c.x=0,c.height=i,c.y=t,c.totalWidth=this.scaledWidth,c.totalHeight=t+i,c.firstMasterBarIndex=-1,c.lastMasterBarIndex=-1,this.registerPartial(c,d=>{d.color=s.mainGlyphColor,d.font=a,d.textAlign=X.Left,d.textBaseline=Ue.Top,h.paint(0,0,d)}),t+i}};o(Sr,"headerElements",new Kr(()=>new Map([[V.Title,v.ScoreTitle],[V.SubTitle,v.ScoreSubTitle],[V.Artist,v.ScoreArtist],[V.Album,v.ScoreAlbum],[V.Words,v.ScoreWords],[V.Music,v.ScoreMusic],[V.WordsAndMusic,v.ScoreWordsAndMusic],[V.Transcriber,void 0]]))),o(Sr,"footerElements",new Kr(()=>new Map([[V.Copyright,v.ScoreCopyright],[V.CopyrightSecondLine,void 0]])));let Ja=Sr;class ac{constructor(){o(this,"x",0);o(this,"width",0);o(this,"masterBars",[]);o(this,"results",[])}}class Af extends Ja{constructor(){super(...arguments);o(this,"_system",null)}get name(){return"HorizontalScreen"}get supportsResize(){return!1}get firstBarX(){let e=this.pagePadding[0];return this._system&&(e+=this._system.accoladeWidth),e}doResize(){}doLayoutAndRender(e){const s=this.renderer.score;let i=this.renderer.settings.display.startBar;i--,i=Math.min(s.masterBars.length-1,Math.max(0,i));let r=i,a=this.renderer.settings.display.barCount;a<=0&&(a=s.masterBars.length),a=i+a-1,a=Math.min(s.masterBars.length-1,Math.max(0,a)),this._system=this.createEmptyStaffSystem(0),this._system.isLast=!0,this._system.x=this.pagePadding[0],this._system.y=this.pagePadding[1];const l=this.renderer.settings.display.barCountPerPartial,h=[];let c=new ac;for(;r<=a;){const u=this.multiBarRestInfo,p=u!==null&&u.has(r)?u.get(r):null,g=this._system.addBars(this.renderer.tracks,r,p);c.masterBars.length>=l&&!g.isLinkedToPrevious&&(c=this._completePartial(h,c)),this._scaleBars(g),c.results.push(g),c.masterBars.push(s.masterBars[r]),c.width+=g.width,r++}c.masterBars.length>0&&this._completePartial(h,c),this._finalizeStaffSystem(),this.height=Math.floor(this._system.y+this._system.height),this.width=this._system.x+this._system.width+this.pagePadding[2],r=0;let d=0;for(let u=0;u<h.length;u++){const p=h[u],g=new Hi;g.reuseViewport=(e==null?void 0:e.reuseViewport)??!1,g.x=d,g.y=0,g.totalWidth=this.width,g.totalHeight=this.height,g.width=p.width,g.height=this.height,g.firstMasterBarIndex=p.masterBars[0].index,g.lastMasterBarIndex=p.masterBars[p.masterBars.length-1].index,d+=p.width;const m=r,y=u;this._system.buildBoundingsLookup(0,0),this.registerPartial(g,S=>{let k=this._system.getBarX(p.masterBars[0].index)+this._system.accoladeWidth;y===0&&(k-=this._system.x+this._system.accoladeWidth),S.color=this.renderer.settings.display.resources.mainGlyphColor,S.textAlign=X.Left,L.debug(this.name,`Rendering partial from bar ${p.masterBars[0].index} to ${p.masterBars[p.masterBars.length-1].index}`,null),this._system.paintPartial(-k,this._system.y,S,m,p.masterBars.length)}),r+=p.masterBars.length}this.height=this.layoutAndRenderBottomScoreInfo(this.height),this.height=this.layoutAndRenderAnnotation(this.height),this.height+=this.pagePadding[3],this.height*=this.renderer.settings.display.scale}_scaleBars(e){e.width=0,this._system.width-=e.width;for(const s of e.renderers){const i=s.staff.system.staves.length>1?s.bar.masterBar.displayWidth:s.bar.displayWidth;i>0&&s.scaleToWidth(i);const r=s.x+s.width;r>e.width&&(e.width=r)}this._system.width+=e.width}_completePartial(e,s){e.length===0&&(s.width+=this._system.accoladeWidth+this.pagePadding[0]),e.push(s),L.debug(this.name,`Finished partial from bar ${s.masterBars[0].index} to ${s.masterBars[s.masterBars.length-1].index}`,null);const i=new ac;return i.x=s.x+s.width,i}_finalizeStaffSystem(){this._alignRenderers(),this._system.finalizeSystem()}_alignRenderers(){this.width=0;const e=this._system;for(const s of e.allStaves){s.resetSharedLayoutData();let i=0;for(const r of s.barRenderers)r.x=i,r.y=s.topPadding+s.topOverflow,r.scaleToWidth(r.width),i+=r.width;i>this.width&&(e.width=i)}e.width+=e.accoladeWidth}}class Vc extends Ja{constructor(){super(...arguments);o(this,"_systems",[]);o(this,"_allMasterBarRenderers",[]);o(this,"_barsFromPreviousSystem",[]);o(this,"_reuseViewPort",!1)}doLayoutAndRender(e){let s=this.pagePadding[1];this.width=this.renderer.width,this._allMasterBarRenderers=[],this._reuseViewPort=(e==null?void 0:e.reuseViewport)??!1,s=this._layoutAndRenderScoreInfo(s,-1),s=this._layoutAndRenderTunings(s,-1),s=this._layoutAndRenderChordDiagrams(s,-1),s=this._layoutAndRenderScore(s),s=this.layoutAndRenderBottomScoreInfo(s),s=this.layoutAndRenderAnnotation(s),this.height=(s+this.pagePadding[3])*this.renderer.settings.display.scale}registerPartial(e,s){e.reuseViewport=this._reuseViewPort,super.registerPartial(e,s)}get supportsResize(){return!0}get firstBarX(){let e=this.pagePadding[0];return this._systems.length>0&&(e+=this._systems[0].accoladeWidth),e}doResize(){let e=this.pagePadding[1];this.width=this.renderer.width;const s=this.height;this._reuseViewPort=!0,e=this._layoutAndRenderScoreInfo(e,s),e=this._layoutAndRenderTunings(e,s),e=this._layoutAndRenderChordDiagrams(e,s),e=this._resizeAndRenderScore(e,s),e=this.layoutAndRenderBottomScoreInfo(e),e=this.layoutAndRenderAnnotation(e),this.height=(e+this.pagePadding[3])*this.renderer.settings.display.scale}_layoutAndRenderTunings(e,s=-1){if(!this.tuningGlyph)return e;const i=this.renderer.settings.display.resources;this.tuningGlyph.x=this.pagePadding[0],this.tuningGlyph.width=this.scaledWidth-this.pagePadding[0]-this.pagePadding[2],this.tuningGlyph.doLayout();const r=Math.round(this.tuningGlyph.height),a=new Hi;return a.x=0,a.y=e,a.width=this.scaledWidth,a.height=r,a.totalWidth=this.scaledWidth,a.totalHeight=s<0?e+a.height:s,this.registerPartial(a,l=>{l.color=i.scoreInfoColor,l.textAlign=X.Center,this.tuningGlyph.paint(0,0,l)}),e+r}_layoutAndRenderChordDiagrams(e,s=-1){if(!this.chordDiagrams)return e;const i=this.renderer.settings.display.resources;this.chordDiagrams.x=this.pagePadding[0],this.chordDiagrams.width=this.scaledWidth-this.pagePadding[0]-this.pagePadding[2],this.chordDiagrams.doLayout();const r=Math.round(this.chordDiagrams.height),a=new Hi;return a.x=0,a.y=e,a.width=this.scaledWidth,a.height=r,a.totalWidth=this.scaledWidth,a.totalHeight=s<0?e+r:s,this.registerPartial(a,l=>{l.color=i.scoreInfoColor,l.textAlign=X.Center,this.chordDiagrams.paint(0,0,l)}),e+r}_layoutAndRenderScoreInfo(e,s=-1){L.debug(this.name,"Layouting score info");const i=new Hi;i.x=0,i.y=e;let r=0;const a=this.renderer.settings.display.resources,l=[];for(const[h,c]of Ja.headerElements.value)if(this.headerGlyphs.has(h)){const d=this.headerGlyphs.get(h);d.y=r,this.alignScoreInfoGlyph(d);let u=d.font.size;h===V.Words&&this.headerGlyphs.has(V.Music)&&this.headerGlyphs.get(V.Music).textAlign!==d.textAlign&&(u=0),r+=u,l.push(d)}return l.length>0&&(r=Math.floor(r+17),i.width=this.scaledWidth,i.height=r,i.totalWidth=this.scaledWidth,i.totalHeight=s<0?e+i.height:s,this.registerPartial(i,h=>{h.color=a.scoreInfoColor,h.textAlign=X.Center;for(const c of l)c.paint(0,0,h)})),e+r}_resizeAndRenderScore(e,s){if(this.getBarsPerSystem(0)>0)for(let r=0;r<this._systems.length;r++){const a=this._systems[r];a.width=a.computedWidth,this._fitSystem(a),e+=this._paintSystem(a,s)}else{for(const h of this._allMasterBarRenderers)for(const c of h.renderers)c.afterReverted();this._systems=[];let r=0;const a=this._maxWidth;let l=this.createEmptyStaffSystem(this._systems.length);for(l.x=this.pagePadding[0],l.y=e;r<this._allMasterBarRenderers.length;){let h=this._allMasterBarRenderers[r];if(l.width+h.width<=a||l.masterBarsRenderers.length===0)l.addMasterBarRenderers(this.renderer.tracks,h),r++,this._needsLineBreak(r)&&(l.isFull=!0);else{for(;h&&!h.canWrap&&l.masterBarsRenderers.length>1;)h=l.revertLastBar(),r--;l.isFull=!0}l.isFull&&(l.isLast=this.lastBarIndex===l.lastBarIndex,this._systems.push(l),this._fitSystem(l),e+=this._paintSystem(l,s),l=this.createEmptyStaffSystem(this._systems.length),l.x=this.pagePadding[0],l.y=e)}l.isLast=this.lastBarIndex===l.lastBarIndex,this._fitSystem(l),e+=this._paintSystem(l,s)}return e}_layoutAndRenderScore(e){let i=this.firstBarIndex;const r=this.lastBarIndex;for(this._systems=[];i<=r;){const a=this._createStaffSystem(i,r);this._systems.push(a),a.x=this.pagePadding[0],a.y=e,i=a.lastBarIndex+1,this._fitSystem(a),L.debug(this.name,`Rendering partial from bar ${a.firstBarIndex} to ${a.lastBarIndex}`,null),e+=this._paintSystem(a,e)}return e}_paintSystem(e,s){const i=Math.floor(e.height),r=new Hi;return r.x=0,r.y=e.y,r.totalWidth=this.scaledWidth,r.totalHeight=s,r.width=this.scaledWidth,r.height=i,r.firstMasterBarIndex=e.firstBarIndex,r.lastMasterBarIndex=e.lastBarIndex,e.buildBoundingsLookup(0,0),this.registerPartial(r,a=>{this.renderer.canvas.color=this.renderer.settings.display.resources.mainGlyphColor,this.renderer.canvas.textAlign=X.Left,e.paint(0,-(r.y/this.renderer.settings.display.scale),a)}),i}_fitSystem(e){e.isFull||e.width>this._maxWidth||this.renderer.settings.display.justifyLastSystem?this._scaleToWidth(e,this._maxWidth):this._scaleToWidth(e,e.width),e.finalizeSystem()}_scaleToWidth(e,s){const i=s-e.accoladeWidth,r=this.shouldApplyBarScale,a=e.totalBarDisplayScale,h=(s-e.computedWidth)/e.masterBarsRenderers.length;for(const c of e.allStaves){c.resetSharedLayoutData();let d=0;for(const u of c.barRenderers){u.x=d,u.y=c.topPadding+c.topOverflow;let p;r?p=e.getBarDisplayScale(u)*i/a:p=u.computedWidth+h,u.scaleToWidth(p),d+=u.width}}e.width=s}_createStaffSystem(e,s){const i=this.createEmptyStaffSystem(this._systems.length),r=this.getBarsPerSystem(i.index),a=this._maxWidth,l=s+1;let h=e;for(;h<l;){if(this._barsFromPreviousSystem.length>0)for(const d of this._barsFromPreviousSystem)i.addMasterBarRenderers(this.renderer.tracks,d),h=d.lastMasterBarIndex;else{const d=this.multiBarRestInfo,u=d!==null&&d.has(h)?d.get(h):null,p=i.addBars(this.renderer.tracks,h,u);this._allMasterBarRenderers.push(p),h=p.lastMasterBarIndex}this._barsFromPreviousSystem=[];let c=!1;if((r===-1&&i.width>=a&&i.masterBarsRenderers.length!==0||i.masterBarsRenderers.length===r+1)&&(c=!0),c){let d=i.revertLastBar();if(d)for(this._barsFromPreviousSystem.push(d);d&&!d.canWrap&&i.masterBarsRenderers.length>1;)d=i.revertLastBar(),d&&this._barsFromPreviousSystem.push(d);return i.isFull=!0,i.isLast=!1,this._barsFromPreviousSystem.reverse(),i}if(this._needsLineBreak(h))return i.isFull=!0,i.isLast=!1,i;i.x=0,h++}return i.isLast=s===i.lastBarIndex,i}_needsLineBreak(e){let s=!1,i=!0;for(const r of this.renderer.tracks)r.lineBreaks&&r.lineBreaks.has(e+1)?s=!0:i=!1;return s&&i}get _maxWidth(){return this.scaledWidth-this.pagePadding[0]-this.pagePadding[2]}}class If extends Vc{get name(){return"PageView"}getBarsPerSystem(t){let e=this.renderer.settings.display.barsPerRow;return this.renderer.settings.display.systemsLayoutMode===ta.UseModelLayout&&(e=A.getSystemLayout(this.renderer.score,t,this.renderer.tracks)),e}get shouldApplyBarScale(){return this.renderer.settings.display.systemsLayoutMode===ta.UseModelLayout}}class Rf extends Vc{get name(){return"Parchment"}getBarsPerSystem(t){return A.getSystemLayout(this.renderer.score,t,this.renderer.tracks)}get shouldApplyBarScale(){return!0}}class Rr extends It{doLayout(){this.width=this.renderer.smuflMetrics.thinBarlineThickness}paint(t,e,s){this.paintExtended(t,e,s,this.height)}}class la extends Rr{constructor(e,s,i){super(e,s);o(this,"_isRepeat");this._isRepeat=i}doLayout(){this.width=this._isRepeat?this.renderer.smuflMetrics.repeatEndingLineThickness:this.renderer.smuflMetrics.thinBarlineThickness}paintExtended(e,s,i,r){i.fillRect(e+this.x,s+this.y,this.renderer.smuflMetrics.thinBarlineThickness,r)}}class Of extends Rr{paintExtended(t,e,s,i){const r=this.renderer.smuflMetrics.thinBarlineThickness/2,a=this.renderer.getLineHeight(1);let l=e+this.y+a*.5+r;const h=e+this.y+i;for(;l<h;)s.fillCircle(t+this.x,l,r),l+=a}}class Wf extends Rr{paintExtended(t,e,s,i){const r=this.renderer.smuflMetrics.dashedBarlineDashLength,a=t+this.x-this.width/2,l=Math.ceil(i/2/r),h=e+this.y+i,c=this.renderer.smuflMetrics.dashedBarlineGapLength,d=s.lineWidth;if(s.lineWidth=this.renderer.smuflMetrics.dashedBarlineThickness,s.beginPath(),l<1)s.moveTo(a,e+this.y),s.lineTo(a,h);else{let u=e+this.y;for(;u<h;){s.moveTo(a,u);const p=Math.min(h-u,r);s.lineTo(a,u+p),u+=r+c}}s.stroke(),s.lineWidth=d}}class ha extends Rr{doLayout(){this.width=this.renderer.smuflMetrics.thickBarlineThickness}paintExtended(t,e,s,i){s.fillRect(t+this.x,e+this.y,this.width,i)}}class nc extends Rr{doLayout(){this.width=this.renderer.smuflMetrics.glyphWidths.get(f.RepeatDot)}paintExtended(t,e,s,i){const r=this.renderer,a=r.heightLineCount%2===0?1:.5,l=e+this.y+this.height/2,h=r.getLineHeight(a),c=r.smuflMetrics.glyphTop.get(f.RepeatDot),d=r.smuflMetrics.glyphHeights.get(f.RepeatDot),u=c-d/2;kt.fillMusicFontSymbolSafe(s,t+this.x,l+u-h,1,f.RepeatDot),kt.fillMusicFontSymbolSafe(s,t+this.x,l+u+h,1,f.RepeatDot)}}class Vf extends Rr{paintExtended(t,e,s,i){const r=this.renderer;if(r.drawnLineCount-1<=2)return;const h=r.smuflMetrics.staffLineThickness/2,c=(r.drawnLineCount-1)/2,d=r.getLineY(c-1)-h,u=r.getLineY(c+1)+h;s.fillRect(t+this.x,e+d,r.smuflMetrics.thinBarlineThickness,u-d)}}class Hf extends Rr{paintExtended(t,e,s,i){const a=this.renderer.getLineHeight(1),l=-(a/2)+1;s.fillRect(t+this.x,e+this.y+l,1,a)}}class Nl extends xa{constructor(e,s){super();o(this,"_isRight");o(this,"_extendToNextStaff");this._isRight=e,this._extendToNextStaff=s}doLayout(){const e=this.renderer.bar,s=e.masterBar,i=this._isRight?e.getActualBarLineRight():e.getActualBarLineLeft(this.renderer.index===0),r=this._isRight&&s.isRepeatEnd||!this._isRight&&s.isRepeatStart;let a=Be.Automatic;if(!this._isRight){const g=this.renderer.previousRenderer;if(g&&g.staff===this.renderer.staff&&(a=g.bar.getActualBarLineRight(),i===a))return}switch(this._isRight&&s.isRepeatEnd&&(this.addGlyph(new nc(0,0)),this.width+=this.renderer.smuflMetrics.repeatBarlineDotSeparation),i){case Be.Dashed:this.addGlyph(new Wf(0,0));break;case Be.Dotted:this.addGlyph(new Of(0,0));break;case Be.Heavy:a!==Be.LightHeavy&&a!==Be.HeavyHeavy&&this.addGlyph(new ha(0,0));break;case Be.HeavyHeavy:a!==Be.LightHeavy&&a!==Be.Heavy&&this.addGlyph(new ha(0,0)),this.width+=this.renderer.smuflMetrics.barlineSeparation,this.addGlyph(new ha(0,0));break;case Be.HeavyLight:a!==Be.LightHeavy&&a!==Be.Heavy&&a!==Be.HeavyHeavy&&this.addGlyph(new ha(0,0)),this.width+=this.renderer.smuflMetrics.thinThickBarlineSeparation,this.addGlyph(new la(0,0,r));break;case Be.LightHeavy:a!==Be.HeavyLight&&a!==Be.Regular&&a!==Be.LightLight&&this.addGlyph(new la(0,0,r)),this.width+=this.renderer.smuflMetrics.thinThickBarlineSeparation,this.addGlyph(new ha(0,0));break;case Be.LightLight:a!==Be.HeavyLight&&a!==Be.Regular&&this.addGlyph(new la(0,0,r)),this.width+=this.renderer.smuflMetrics.barlineSeparation,this.addGlyph(new la(0,0,r));break;case Be.None:break;case Be.Regular:a!==Be.HeavyLight&&a!==Be.LightLight&&this.addGlyph(new la(0,0,r));break;case Be.Short:this.addGlyph(new Vf(0,0));break;case Be.Tick:this.addGlyph(new Hf(0,0));break}this._isRight||s.isRepeatStart&&(this.width+=this.renderer.smuflMetrics.repeatBarlineDotSeparation,this.addGlyph(new nc(0,0)));const l=this.renderer,h=l.smuflMetrics.staffLineThickness;let c=this.y,d=this.y;l.drawnLineCount<2||!this._isRight&&l.isFirstOfStaff||this._isRight&&l.isLastOfStaff?(c-=h,d+=l.height):(c+=l.getLineY(0)-h/2,d+=l.getLineY(l.drawnLineCount-1)+h/2);const u=d-c;let p=0;if(this._extendToNextStaff&&this._isRight){const g=Math.ceil(this.width);p=g-this.width,this.width=g}for(const g of this.glyphs)g.y=c,g.x+=p,g.height=u}paint(e,s,i){var h;const r=this.glyphs;if(!r)return;const a=this.renderer,l=ve.bar(i,a.barLineBarSubElement,this.renderer.bar,!0);try{let c=this.height;const d=a.staff,u=d.system.allStaves;let p=!1;if(this._extendToNextStaff&&d.index<u.length-1){const g=u[d.index+1],m=d.y+a.y;c=g.y+g.topOverflow+a.smuflMetrics.staffLineThickness-m,p=!0}for(const g of r)p?g.paintExtended(e,s,i,c):g.paint(e,s,i)}finally{(h=l==null?void 0:l[Symbol.dispose])==null||h.call(l)}}}class Hc extends It{constructor(e,s,i){super(e,s);o(this,"_number");this._number=`${i}  `}doLayout(){this.renderer.scoreRenderer.canvas.font=this.renderer.resources.elementFonts.get(v.BarNumber);const e=this.renderer.scoreRenderer.canvas.measureText(this._number);this.width=e.width,this.height=e.height,this.y-=this.height}paint(e,s,i){var a;if(!this.renderer.staff.isFirstInSystem)return;const r=ve.bar(i,this.renderer.barNumberBarSubElement,this.renderer.bar,!0);try{const l=this.renderer.resources,h=i.textBaseline;i.font=l.elementFonts.get(v.BarNumber),i.textBaseline=Ue.Top,i.fillText(this._number,e+this.x,s+this.y),i.textBaseline=h}finally{(a=r==null?void 0:r[Symbol.dispose])==null||a.call(r)}}}class Io extends Bo{shouldDrawBendSlur(){return this.renderer.settings.notation.extendBendArrowsOnTiedNotes&&!!this.startNote.bendOrigin&&this.startNote.isTieOrigin}calculateTieDirection(){return E.Up}}class oc{constructor(){o(this,"x",0);o(this,"y",-3e3);o(this,"width",0)}}class Bh extends mi{constructor(){super(0,0)}doLayout(){if(!this.glyphs||this.glyphs.length===0){this.width=0;return}this.glyphs.sort((s,i)=>s.y<i.y?-1:s.y>i.y?1:0);const t=[];t.push(new oc);for(let s=0,i=this.glyphs.length;s<i;s++){const r=this.glyphs[s];r.renderer=this.renderer,r.doLayout();let a=0;for(;t[a].y>r.y;)a++,a===t.length&&t.push(new oc);r.x=a,t[a].y=r.y+r.height,t[a].width<r.width&&(t[a].width=r.width)}this.width=0;const e=this.renderer.smuflMetrics.accidentalPadding;for(const s of t)this.width+=s.width+e,s.x=this.width;for(let s=0,i=this.glyphs.length;s<i;s++){const r=this.glyphs[s],a=t[r.x];r.x=this.width-a.x}}}class qa extends Ht{constructor(t,e){super(t,e,1,f.AugmentationDot)}doLayout(){super.doLayout(),this.offsetX=this.width/2,this.width*=1.5}}class rn extends mi{constructor(){super(0,0);o(this,"_effectGlyphs",[]);o(this,"_normalGlyphs",[]);o(this,"container");o(this,"computedWidth",0)}doLayout(){let e=0;if(this.glyphs)for(let s=0,i=this.glyphs.length;s<i;s++){const r=this.glyphs[s];r.x=e,r.renderer=this.renderer,r.doLayout(),e+=r.width}this.width=e,this.computedWidth=e}noteLoop(e){for(let s=this.container.beat.notes.length-1;s>=0;s--)e(this.container.beat.notes[s])}addEffect(e){super.addGlyph(e),this._effectGlyphs.push(e)}addNormal(e){super.addGlyph(e),this._normalGlyphs.push(e)}get effectElement(){}paint(e,s,i){this._paintEffects(e,s,i),this._paintNormal(e,s,i)}_paintNormal(e,s,i){for(const r of this._normalGlyphs)r.paint(e+this.x,s+this.y,i)}_paintEffects(e,s,i){var a;const r=this.effectElement?ve.beat(i,this.effectElement,this.container.beat):void 0;try{for(const l of this._effectGlyphs)l.paint(e+this.x,s+this.y,i)}finally{(a=r==null?void 0:r[Symbol.dispose])==null||a.call(r)}}}class No extends rn{constructor(){super(...arguments);o(this,"onTimeX",0);o(this,"middleX",0);o(this,"stemX",0)}}class Po extends It{constructor(){super(0,0);o(this,"_topY",0)}getBoundingBoxTop(){return this._topY}getBoundingBoxBottom(){return this._topY+this.height}doLayout(){this.width=this.renderer.smuflMetrics.glyphWidths.get(f.NoteheadSlashWhiteHalf);const e=this.renderer,s=e.getLineHeight(e.heightLineCount-1),i=e.getLineY(0),r=e.drawnLineCount>0?e.getLineHeight(e.drawnLineCount-1):0,a=i+r/2-s/2;this.height=s,this._topY=a}paint(e,s,i){const r=this.height,a=this._topY,l=i.lineWidth;i.lineWidth=this.renderer.smuflMetrics.deadSlappedLineWidth,i.moveTo(e+this.x,s+a),i.lineTo(e+this.x+this.width,s+a+r),i.moveTo(e+this.x,s+a+r),i.lineTo(e+this.x+this.width,s+a),i.stroke(),i.lineWidth=l}}class Gf extends It{constructor(e,s,i,r,a,l){super(e,s);o(this,"_isGrace");o(this,"_beat");o(this,"_number");o(this,"_octaveDots");o(this,"_octaveDotsY",0);o(this,"_octaveDotHeight",0);this._isGrace=r,this._number=i,this._beat=a,this._octaveDots=l}getBoundingBoxTop(){let e=-this.height/2;return this._octaveDots>0&&this._octaveDotsY<e&&(e=this._octaveDotsY),this.y+e}getBoundingBoxBottom(){let e=this.height/2;const s=this._octaveDotsY+Math.abs(this._octaveDots)*this._octaveDotHeight*2;return this._octaveDots<0&&e<s&&(e=s),this.y+e}paint(e,s,i){var a;const r=this._beat.isRest?ve.beat(i,ht.NumberedRests,this._beat):this._beat.notes.length>0?ve.note(i,ns.NumberedNumber,this._beat.notes[0]):void 0;try{const l=this.renderer.resources;i.font=this._isGrace?l.numberedNotationGraceFont:l.numberedNotationFont;const h=i.textBaseline;i.textBaseline=Ue.Middle,i.textAlign=X.Left,i.fillText(this._number.toString(),e+this.x,s+this.y),i.textBaseline=h;const c=Math.abs(this._octaveDots);let d=this._octaveDotsY+l.engravingSettings.glyphTop.get(f.AugmentationDot);for(let u=0;u<c;u++)kt.fillMusicFontSymbolSafe(i,e+this.x+this.width/2,s+this.y+d,1,f.AugmentationDot,!0),d+=this._octaveDotHeight*2}finally{(a=r==null?void 0:r[Symbol.dispose])==null||a.call(r)}}doLayout(){const e=this.renderer.resources,s=this._isGrace?e.numberedNotationGraceFont:e.numberedNotationFont,i=this.renderer.scoreRenderer.canvas;i.font=s;const r=i.measureText(`${this._number}`);this.height=r.height,this.width=r.width;const a=this._octaveDots,l=e.engravingSettings.glyphHeights.get(f.AugmentationDot),h=Math.abs(a)*l*2;a>0?this._octaveDotsY=-(this.height/2)-h-e.engravingSettings.glyphTop.get(f.AugmentationDot):a<0&&(this._octaveDotsY=this.height/2+l+e.engravingSettings.glyphTop.get(f.AugmentationDot)),this._octaveDotHeight=l}}class ys extends It{constructor(t,e,s){super(t,e),this.width=s}getBoundingBoxTop(){return Number.NaN}getBoundingBoxBottom(){return Number.NaN}}class Uf extends rn{constructor(){super(...arguments);o(this,"accidental",he.None);o(this,"skipLayout",!1)}get effectElement(){return ht.NumberedEffects}doLayout(){if(!this.skipLayout){if(!this.container.beat.isRest&&!this.container.beat.isEmpty){const e=new Bh;if(e.renderer=this.renderer,this.container.beat.notes.length>0){const s=this.container.beat.notes[0],i=A.resolveSpelling(this.renderer.bar.keySignature,s.displayValue,s.accidentalMode),r=A.getKeySignatureAccidentalOffset(this.renderer.bar.keySignature,i.degree),a=i.accidentalOffset-r;let l=he.None;if(s.accidentalMode!==de.ForceNone&&(s.hasQuarterToneOffset?a>0?l=he.SharpQuarterNoteUp:a<0?l=he.FlatQuarterNoteUp:l=he.NaturalQuarterNoteUp:a!==0&&(l=A.accidentalOffsetToType(a))),l!==he.None){this.accidental=l;const h=this.renderer,c=ve.noteColor(h.resources,ns.NumberedAccidentals,s),d=new Ci(0,h.getLineY(0),l,s.beat.graceType!==ee.None?Ze.GraceScale*Ze.GraceScale:Ze.GraceScale);d.colorOverride=c,d.renderer=this.renderer,e.addGlyph(d),this.addNormal(e),this.addNormal(new ys(0,0,this.renderer.smuflMetrics.preNoteEffectPadding))}}}super.doLayout()}}}const qr=class qr extends No{constructor(){super(...arguments);o(this,"noteHeads",null);o(this,"deadSlapped",null)}get effectElement(){return ht.NumberedEffects}getNoteX(e,s){let i=null;if(this.noteHeads?i=this.noteHeads:this.deadSlapped&&(i=this.deadSlapped),i){let r=i.x;switch(s){case je.Left:break;case je.Center:r+=i.width/2;break;case je.Right:r+=i.width;break}return r}return 0}buildBoundingsLookup(e,s,i){if(this.noteHeads&&this.container.beat.notes.length>0){const r=new na;r.note=this.container.beat.notes[0],r.noteHeadBounds=new Pt,r.noteHeadBounds.x=s+this.x+this.noteHeads.x,r.noteHeadBounds.y=i+this.y+this.noteHeads.y-this.noteHeads.height/2,r.noteHeadBounds.w=this.width,r.noteHeadBounds.h=this.height,e.addNote(r)}}getLowestNoteY(e){return this._internalGetNoteY(e)}getHighestNoteY(e){return this._internalGetNoteY(e)}getNoteY(e,s){return this._internalGetNoteY(s)}getRestY(e){return this._internalGetNoteY(e)}_internalGetNoteY(e){let s=null;if(this.noteHeads?s=this.noteHeads:this.deadSlapped&&(s=this.deadSlapped),s){let i=this.y+s.y;switch(e){case M.Top:case M.TopWithStem:i-=s.height/2;break;case M.Center:break;case M.Bottom:case M.BottomWithStem:i+=s.height/2;break;case M.StemUp:case M.StemDown:break}return i}return 0}doLayout(){const e=this.renderer;e.shortestDuration<this.container.beat.duration&&(e.shortestDuration=this.container.beat.duration);let s=0;if(!this.container.beat.isEmpty){const i=e.getLineY(0);let r="0";if(this.container.beat.notes.length>0){const a=this.container.beat.notes[0];if(a.isDead)r="X";else{const l=this.renderer.bar.keySignature,h=this.renderer.bar.keySignatureType,c=l+7,u=(h===cs.Minor?qr._minorKeySignatureOneValues:qr._majorKeySignatureOneValues)[c],p=A.resolveSpelling(l,a.displayValue,a.accidentalMode),g=A.getKeySignatureTonicDegree(l,h),m=h===cs.Minor?(g+2)%7:g;r=((p.degree-m+7)%7+1).toString();const S=a.displayValue-u;s=Math.floor(S/12)}}if(this.container.beat.deadSlapped){const a=new Po;a.renderer=this.renderer,a.doLayout(),this.deadSlapped=a,this.addEffect(a)}else{const a=this.container.beat.graceType!==ee.None,l=new Gf(0,i,r,a,this.container.beat,s);this.noteHeads=l,this.addNormal(l)}if(this.container.beat.dots>0&&this.container.beat.duration>=b.Quarter)for(let a=0;a<this.container.beat.dots;a++){const l=new qa(0,i);l.renderer=this.renderer,this.addEffect(l)}}super.doLayout(),this.container.beat.isEmpty?this.onTimeX=this.width/2:this.noteHeads?this.onTimeX=this.noteHeads.x+this.noteHeads.width/2:this.deadSlapped&&(this.onTimeX=this.deadSlapped.x+this.deadSlapped.width/2),this.middleX=this.onTimeX,this.stemX=this.middleX}};o(qr,"_majorKeySignatureOneValues",[59,66,61,68,63,70,65,60,67,62,69,64,71,66,61]),o(qr,"_minorKeySignatureOneValues",[68,63,70,65,60,67,62,69,64,71,66,61,68,63,70]);let Pl=qr;class Pr extends Bo{calculateTieDirection(){return this.isLeftHandTap?E.Up:Pr.getBeamDirectionForNote(this.startNote)}static getBeamDirectionForNote(t){return t.string>3?E.Up:E.Down}}class Cl extends Pr{constructor(e,s,i,r,a){super(e,s,i,a);o(this,"_forSlide");this._forSlide=r}getTieHeight(e,s,i,r){return Math.log(i-e+1)*this.renderer.settings.notation.slurHeight/2}tryExpand(e,s,i,r){if(this._forSlide!==i||this.startNote.beat.id!==e.beat.id||this.endNote.beat.id!==s.beat.id||this.renderer===this.lookupEndBeatRenderer()!==r||this.tieDirection!==Pr.getBeamDirectionForNote(e))return!1;switch(this.tieDirection){case E.Up:e.realValue>this.startNote.realValue&&(this.startNote=e),s.realValue>this.endNote.realValue&&(this.endNote=s);break;case E.Down:e.realValue<this.startNote.realValue&&(this.startNote=e),s.realValue<this.endNote.realValue&&(this.endNote=s);break}return!0}}class lc extends Cl{calculateTieDirection(){return E.Up}}class Gc extends Pi{constructor(e){super(e);o(this,"_slurs",new Map);o(this,"_effectSlurs",[]);o(this,"_dashes");o(this,"hasAdditionalNumbers",!1);this.preNotes=new Uf,this.onNotes=new Pl}*iterateAdditionalNumbers(){const e=this._dashes;if(e)for(const s of e)s instanceof Co&&(yield s)}addDash(e){let s=this._dashes;s||(s=[],this._dashes=s),s.push(e)}addNotes(e){let s=this._dashes;s||(s=[],this._dashes=s),s.push(e),this.hasAdditionalNumbers=!0}doLayout(){this._slurs.clear(),this._effectSlurs=[],super.doLayout()}buildBoundingsLookup(e,s,i){super.buildBoundingsLookup(e,s,i);const r=this._dashes;if(r){const a=e.beats[e.beats.length-1],l=r[r.length-1],h=l.x+l.contentWidth;a.visualBounds.w=h-a.visualBounds.x;const c=l.x+l.width;a.realBounds.w=c-a.realBounds.x}}createTies(e){if(e.isVisible){if(e.isTieOrigin&&e.tieDestination.isVisible&&!this._slurs.has("numbered.tie")){const s=new Io(`numbered.tie.${e.beat.id}`,e,e.tieDestination,!1);this.addTie(s),this._slurs.set(s.slurEffectId,s)}if(e.isTieDestination){const s=new Io(`numbered.tie.${e.tieOrigin.beat.id}`,e.tieOrigin,e,!0);this.addTie(s)}if(e.isLeftHandTapped&&!e.isHammerPullDestination&&!this._slurs.has(`numbered.tie.leftHandTap.${e.beat.id}`)){const s=new Io(`numbered.tie.leftHandTap.${e.beat.id}`,e,e,!1);this.addTie(s),this._slurs.set(s.slurEffectId,s)}if(e.isEffectSlurOrigin&&e.effectSlurDestination){let s=!1;for(const i of this._effectSlurs)if(i.tryExpand(e,e.effectSlurDestination,!1,!1)){s=!0;break}if(!s){const i=new lc("numbered.slur.effect",e,e.effectSlurDestination,!1,!1);this._effectSlurs.push(i),this.addTie(i),this._slurs.set(i.slurEffectId,i),this._slurs.set("numbered.slur.effect",i)}}if(e.isEffectSlurDestination&&e.effectSlurOrigin){let s=!1;for(const i of this._effectSlurs)if(i.tryExpand(e.effectSlurOrigin,e,!1,!0)){s=!0;break}if(!s){const i=new lc("numbered.slur.effect",e.effectSlurOrigin,e,!1,!0);this._effectSlurs.push(i),this.addTie(i),this._slurs.set(i.slurEffectId,i),this._slurs.set("numbered.slur.effect",i)}}}}}class Co extends Gc{constructor(e,s,i){super(e);o(this,"_absoluteDisplayStart");o(this,"_displayDuration");o(this,"barCount");this._absoluteDisplayStart=s,this._displayDuration=i,this.preNotes.skipLayout=!0,this.barCount=Co._ticksToBarCount(i)}static _ticksToBarCount(e){return e>=D.toTicks(b.Eighth)?1:e>=D.toTicks(b.Sixteenth)?2:e>=D.toTicks(b.ThirtySecond)?3:e>=D.toTicks(b.SixtyFourth)?4:e>=D.toTicks(b.OneHundredTwentyEighth)?5:e>=D.toTicks(b.TwoHundredFiftySixth)?6:0}get beatId(){return-1}get contentWidth(){return this.onNotes.width}get absoluteDisplayStart(){return this._absoluteDisplayStart}get displayDuration(){return this._displayDuration}get graceType(){return ee.None}get graceIndex(){return 0}get graceGroup(){return null}get isFirstOfTupletGroup(){return!1}get tupletGroup(){return null}get isLastOfVoice(){return!1}buildBoundingsLookup(e,s,i){}}class zf extends mh{constructor(e,s){super(0,0);o(this,"_absoluteDisplayStart");o(this,"_voiceIndex");this._absoluteDisplayStart=s,this._voiceIndex=e}get beatId(){return-1}get contentWidth(){return this.renderer.smuflMetrics.numberedDashGlyphWidth}get absoluteDisplayStart(){return this._absoluteDisplayStart}get displayDuration(){return D.QuarterTime}get onTimeX(){return this.renderer.smuflMetrics.numberedDashGlyphWidth/2}get graceType(){return ee.None}get graceIndex(){return 0}get graceGroup(){return null}get voiceIndex(){return this._voiceIndex}get isFirstOfTupletGroup(){return!1}get tupletGroup(){return null}get isLastOfVoice(){return!1}getLowestNoteY(e){return 0}getHighestNoteY(e){return 0}getNoteY(e,s){return 0}doMultiVoiceLayout(){}getRestY(e){return 0}getNoteX(e,s){return 0}getBeatX(e,s){return 0}registerLayoutingInfo(e){const s=this.renderer.smuflMetrics.numberedDashGlyphWidth;e.addBeatSpring(this,s/2,s/2)}applyLayoutingInfo(e){}buildBoundingsLookup(e,s,i){}paint(e,s,i){const r=this.renderer,a=r.smuflMetrics.numberedDashGlyphWidth,l=r.smuflMetrics.numberedBarRendererBarSize,h=Math.ceil(s+r.getLineY(0)-l);i.fillRect(e+this.x,h,a,l)}}class El extends It{constructor(e){super(0,0);o(this,"_isOpen");o(this,"colorOverride");this._isOpen=e}doLayout(){super.doLayout(),this.width=this.renderer.smuflMetrics.ghostParenthesisWidth+this.renderer.smuflMetrics.ghostParenthesisPadding}paint(e,s,i){const r=i.color;this.colorOverride&&(i.color=this.colorOverride),this._isOpen?zt.paintTie(i,1,e+this.x+this.renderer.smuflMetrics.ghostParenthesisWidth,s+this.y+this.height,e+this.x+this.renderer.smuflMetrics.ghostParenthesisWidth,s+this.y,!1,this.renderer.smuflMetrics.ghostParenthesisWidth/2,this.renderer.smuflMetrics.tieMidpointThickness):zt.paintTie(i,1,e+this.x+this.renderer.smuflMetrics.ghostParenthesisPadding,s+this.y,e+this.x+this.renderer.smuflMetrics.ghostParenthesisPadding,s+this.y+this.height,!1,this.renderer.smuflMetrics.ghostParenthesisWidth/2,this.renderer.smuflMetrics.tieMidpointThickness),i.color=r}}class Uc extends mi{constructor(e,s,i,r,a,l){super(e,s);o(this,"_numerator",0);o(this,"_denominator",0);o(this,"_isCommon");o(this,"_isFreeTime");o(this,"barSubElement",Ae.StandardNotationTimeSignature);this._numerator=i,this._denominator=r,this._isCommon=a,this._isFreeTime=l}paint(e,s,i){var a;const r=ve.bar(i,this.barSubElement,this.renderer.bar);try{super.paint(e,s,i)}finally{(a=r==null?void 0:r[Symbol.dispose])==null||a.call(r)}}doLayout(){if(this._isCommon&&this._numerator===2&&this._denominator===2){const e=new Ht(0,0,this.commonScale,f.TimeSigCutCommon);this.addGlyph(e),super.doLayout()}else if(this._isCommon&&this._numerator===4&&this._denominator===4){const e=new Ht(0,0,this.commonScale,f.TimeSigCommon);this.addGlyph(e),super.doLayout()}else{const e=new sa(0,0,this._numerator,Ue.Top,this.numberScale),s=new sa(0,0,this._denominator,Ue.Bottom,this.numberScale);this.addGlyph(e),this.addGlyph(s),super.doLayout();const i=this.width;e.x=(i-e.width)/2,s.x=(i-s.width)/2,this.width=Math.max(e.x+e.width,s.x+s.width)}if(this._isFreeTime){const e=this.renderer.smuflMetrics.oneStaffSpace*2,s=new El(!0);s.renderer=this.renderer,s.y=-e,s.height=e*2,s.doLayout();for(const r of this.glyphs)r.x+=s.width;this.width+=s.width,this.addGlyph(s);const i=new El(!1);i.renderer=this.renderer,i.x=this.width,i.y=-e,i.height=e*2,i.doLayout(),this.addGlyph(i),this.width+=i.width}}}class Th extends Uc{get commonScale(){return 1}get numberScale(){return 1}}class an extends Ht{constructor(t,e,s,i,r){super(t,e,r?Ze.GraceScale:1,an.getSymbol(s,i,r))}paint(t,e,s){const i=s.color;super.paint(t,e,s),s.color=i}static getSymbol(t,e,s){if(s&&(t=b.Eighth),e===E.Up)switch(t){case b.Eighth:return f.Flag8thUp;case b.Sixteenth:return f.Flag16thUp;case b.ThirtySecond:return f.Flag32ndUp;case b.SixtyFourth:return f.Flag64thUp;case b.OneHundredTwentyEighth:return f.Flag128thUp;case b.TwoHundredFiftySixth:return f.Flag256thUp;default:return f.Flag8thUp}switch(t){case b.Eighth:return f.Flag8thDown;case b.Sixteenth:return f.Flag16thDown;case b.ThirtySecond:return f.Flag32ndDown;case b.SixtyFourth:return f.Flag64thDown;case b.OneHundredTwentyEighth:return f.Flag128thDown;case b.TwoHundredFiftySixth:return f.Flag128thDown;default:return f.Flag8thDown}}}class Yf extends It{constructor(e,s,i){super(e,s);o(this,"_count",0);this._count=0,this._count=i}doLayout(){this.renderer.scoreRenderer.canvas.font=this.renderer.resources.elementFonts.get(v.RepeatCount);const e=this.renderer.scoreRenderer.canvas.measureText(`x${this._count}`);this.width=0,this.height=e.height,this.y-=e.height}paint(e,s,i){var a;const r=ve.bar(i,this.renderer.repeatsBarSubElement,this.renderer.bar);try{const l=this.renderer.resources,h=i.textAlign;i.font=l.elementFonts.get(v.RepeatCount),i.textAlign=X.Right;const c=`x${this._count}`,d=i.measureText(c).width/1.5;i.fillText(c,e+this.x-d,s+this.y),i.textAlign=h}finally{(a=r==null?void 0:r[Symbol.dispose])==null||a.call(r)}}}class pi extends Bl{constructor(){super(...arguments);o(this,"firstLineY",0);o(this,"_startSpacing",!1);o(this,"tupletSize",0)}get lineOffset(){return this.lineSpacing}get tupletOffset(){return this.smuflMetrics.oneStaffSpace*.5}get topGlyphOverflow(){return 0}get bottomGlyphOverflow(){return 0}initLineBasedSizes(){this.height=this.lineOffset*(this.heightLineCount-1)}updateSizes(){this.initLineBasedSizes(),this.adjustSizes(),this.updateFirstLineY(),super.updateSizes()}adjustSizes(){}updateFirstLineY(){const e=this.lineOffset*(this.heightLineCount-1),s=this.drawnLineCount===0?0:(this.drawnLineCount-1)*this.lineOffset,i=this.smuflMetrics.staffLineThickness/2;this.firstLineY=((e-s)/2|0)-i}doLayout(){this.initLineBasedSizes(),this.updateFirstLineY(),this.tupletSize=this.smuflMetrics.glyphHeights.get(f.Tuplet0),super.doLayout()}getLineY(e){return this.firstLineY+this.getLineHeight(e)}getLineHeight(e){return this.lineOffset*e}paintContent(e,s,i){super.paintContent(e,s,i),this.paintBeams(e,s,i,this.flagsSubElement,this.beamsSubElement),this.paintTuplets(e,s,i,this.tupletSubElement)}paintBackground(e,s,i){super.paintBackground(e,s,i),this.paintStaffLines(e,s,i),this.paintSimileMark(e,s,i)}paintStaffLines(e,s,i){var a;const r=ve.bar(i,this.staffLineBarSubElement,this.bar,!0);try{const l=[];for(let d=0,u=this.drawnLineCount;d<u;d++)l.push([]);this.additionalMultiRestBars||this.collectSpaces(l);for(const d of l)d.sort((u,p)=>u[0]>p[0]?1:u[0]<p[0]?-1:0);const h=this.width,c=this.smuflMetrics.staffLineThickness/2;for(let d=0;d<this.drawnLineCount;d++){const u=this.getLineY(d)-c;let p=0;for(const g of l[d])i.fillRect(e+this.x+p,s+this.y+u,g[0]-p,this.smuflMetrics.staffLineThickness),p=g[0]+g[1];i.fillRect(e+this.x+p,s+this.y+u,h-p,this.smuflMetrics.staffLineThickness)}}finally{(a=r==null?void 0:r[Symbol.dispose])==null||a.call(r)}}collectSpaces(e){}createStartSpacing(){if(this._startSpacing)return!1;const e=this.index===0?this.settings.display.firstStaffPaddingLeft:this.settings.display.staffPaddingLeft;return this.addPreBeatGlyph(new ys(0,0,e)),this._startSpacing=!0,!0}paintTuplets(e,s,i,r,a=!1){for(const l of this.voiceContainer.voiceDrawOrder)if(this.voiceContainer.tupletGroups.has(l)){const h=this.voiceContainer.tupletGroups.get(l);for(const c of h)this._paintTupletHelper(e,s,i,c,r,a)}}getBeatDirection(e){const s=this.helpers.getBeamingHelperForBeat(e);return s?this.getBeamDirection(s):E.Up}getTupletBeamDirection(e){return this.getBeamDirection(e)}calculateBeamYWithDirection(e,s,i){return this.ensureBeamDrawingInfo(e,i),e.drawingInfos.get(i).calcY(s)}_paintTupletHelper(e,s,i,r,a,l){var T;const h=this.resources,c=i.textAlign,d=i.textBaseline;i.color=r.voice.index===0?this.resources.mainGlyphColor:this.resources.secondaryGlyphColor,i.textAlign=X.Center,i.textBaseline=Ue.Middle;let u;const p=r.beats[0].tupletNumerator,g=r.beats[0].tupletDenominator;if(p===2&&g===3)u=[f.Tuplet2];else if(p===3&&g===2)u=[f.Tuplet3];else if(p===4&&g===6)u=[f.Tuplet4];else if(p===5&&g===4)u=[f.Tuplet5];else if(p===6&&g===4)u=[f.Tuplet6];else if(p===7&&g===4)u=[f.Tuplet7];else if(p===9&&g===8)u=[f.Tuplet9];else if(p===10&&g===8)u=[f.Tuplet1,f.Tuplet0];else if(p===11&&g===8)u=[f.Tuplet1,f.Tuplet1];else if(p===12&&g===8)u=[f.Tuplet1,f.Tuplet2];else if(p===13&&g===8)u=[f.Tuplet1,f.Tuplet3];else{u=[];const N=f.Tuplet0;p>10?(u.push(N+Math.floor(p/10)),u.push(N+(p-10))):u.push(N+p),u.push(f.TupletColon),g>10?(u.push(N+Math.floor(g/10)),u.push(N+(g-10))):u.push(N+g)}const m=this.tupletOffset,y=this.tupletSize,S=m+y*.5,k=ve.beat(i,a,r.beats[0]);try{const N=i.lineWidth;if(i.lineWidth=this.smuflMetrics.tupletBracketThickness,r.beats.length===1||!r.isFull)for(const F of r.beats){const q=this.helpers.getBeamingHelperForBeat(F);if(!q)continue;const U=this.getTupletBeamDirection(q),x=this.getBeatX(F,oe.Stem);let j=this.calculateBeamYWithDirection(q,x,U);U===E.Down?j+=S:j-=S,i.fillMusicFontSymbols(e+this.x+x,s+this.y+j+y*.5,1,u,!0)}else{const F=r.beats[0],q=r.beats[r.beats.length-1];let U=null,x=null;for(let ri=0;ri<r.beats.length;ri++)if(!r.beats[ri].isRest){U=r.beats[ri];break}for(let ri=r.beats.length-1;ri>=0;ri--)if(!r.beats[ri].isRest){x=r.beats[ri];break}let j=!1;U||(U=F,j=!0),x||(x=q);const Q=this.getBeatX(F,oe.OnNotes),Te=this.getBeatX(q,oe.PostNotes),te=this.helpers.getBeamingHelperForBeat(U),we=this.helpers.getBeamingHelperForBeat(x),$e=this.getTupletBeamDirection(te);let ce=this.calculateBeamYWithDirection(te,Q,$e),rt=this.calculateBeamYWithDirection(we,Te,$e);j&&(ce=Math.max(ce,rt),rt=ce),$e===E.Down?(ce+=S,rt+=S):(ce-=S,rt-=S);const Es=u.reduce((ri,qc)=>ri+h.engravingSettings.glyphWidths.get(qc),0),_t=h.engravingSettings.oneStaffSpace*.5,Gs=(Q+Te)/2,bi=Gs-Es/2-_t,Qs=Gs+Es/2+_t,$t=(rt-ce)/(Te-Q),Di=ce-$t*Q,Ks=$t*bi+Di,vs=$t*Gs+Di,Ch=$t*Qs+Di,Jc=$e===E.Down?ce-y*.5:ce+y*.5,Eh=$e===E.Down?rt-y*.5:rt+y*.5,vh=i.lineWidth%2===0?0:.5;e+=vh,s+=vh,bi>Q&&(i.beginPath(),i.moveTo(e+this.x+Q,s+this.y+Jc),l?i.quadraticCurveTo(e+this.x+(bi+Q)/2,s+this.y+Ks,e+this.x+bi,s+this.y+Ks):(i.lineTo(e+this.x+Q,s+this.y+ce),i.lineTo(e+this.x+bi,s+this.y+Ks)),i.moveTo(e+this.x+Qs,s+this.y+Ch),l?i.quadraticCurveTo(e+this.x+(Te+Qs)/2,s+this.y+Ch,e+this.x+Te,s+this.y+Eh):(i.lineTo(e+this.x+Te,s+this.y+rt),i.lineTo(e+this.x+Te,s+this.y+Eh)),i.stroke()),i.fillMusicFontSymbols(e+this.x+Gs,s+this.y+vs+y*.5,1,u,!0)}i.textAlign=c,i.textBaseline=d,i.lineWidth=N}finally{(T=k==null?void 0:k[Symbol.dispose])==null||T.call(k)}}paintBeams(e,s,i,r,a){for(const l of this.voiceContainer.voiceDrawOrder)for(const h of this.helpers.beamHelpers[l])this.paintBeamHelper(e,s,i,h,r,a)}drawBeamHelperAsFlags(e){return e.beats.length===1}hasFlag(e){if(e.isRest)return!1;const s=this.helpers.getBeamingHelperForBeat(e);return s?s.hasFlag(this.drawBeamHelperAsFlags(s),e):Ms.beatHasFlag(e)}hasStem(e){if(e.isRest)return!1;const s=this.helpers.getBeamingHelperForBeat(e);return s?s.hasStem(this.drawBeamHelperAsFlags(s),e):Ms.beatHasStem(e)}paintBeamHelper(e,s,i,r,a,l){i.color=r.voice.index===0?this.resources.mainGlyphColor:this.resources.secondaryGlyphColor,this.shouldPaintBeamingHelper(r)&&(this.drawBeamHelperAsFlags(r)?this.paintFlag(e,s,i,r,a):this.paintBar(e,s,i,r,l))}shouldPaintBeamingHelper(e){return!e.isRestBeamHelper}shouldPaintFlag(e){return!(e.graceType===ee.BendGrace||e.deadSlapped||e.graceType!==ee.None&&this.settings.notation.notationMode===Xt.SongBook||e.duration===b.Whole||e.duration===b.DoubleWhole||e.duration===b.QuadrupleWhole)}paintFlag(e,s,i,r,a){var l;for(const h of r.beats){if(!this.shouldPaintFlag(h))continue;const c=h.graceType!==ee.None,d=this.getBeatX(h,oe.Stem),u=this.getBeamDirection(r),p=s+this.y+this.getFlagTopY(h,u),g=s+this.y+this.getFlagBottomY(h,u);let m=0;if(u===E.Down?m=g:m=p,!r.hasStem(!0,h))continue;this.paintBeamingStem(h,s+this.y,e+this.x+d,p,g,i);const y=ve.beat(i,a,h);try{let S=0;if(r.hasFlag(!0,h)){const k=new an(e+this.x+d,m,h.duration,u,c);k.renderer=this,k.doLayout(),k.paint(0,0,i),S=k.width/2}h.graceType===ee.BeforeBeat&&(u===E.Down?kt.fillMusicFontSymbolSafe(i,e+this.x+d+S/2,(p+g-this.smuflMetrics.glyphHeights.get(f.GraceNoteSlashStemDown))/2,Ze.GraceScale,f.GraceNoteSlashStemDown,!0):kt.fillMusicFontSymbolSafe(i,e+this.x+d+S/2,(p+g+this.smuflMetrics.glyphHeights.get(f.GraceNoteSlashStemUp))/2,Ze.GraceScale,f.GraceNoteSlashStemUp,!0))}finally{(l=y==null?void 0:y[Symbol.dispose])==null||l.call(y)}}}recreatePreBeatGlyphs(){this._startSpacing=!1,super.recreatePreBeatGlyphs()}calculateBeamY(e,s){return this.calculateBeamYWithDirection(e,s,this.getBeamDirection(e))}createPreBeatGlyphs(){super.createPreBeatGlyphs(),this.addPreBeatGlyph(new Nl(!1,this.bar.staff.track.score.stylesheet.extendBarLines)),this.createLinePreBeatGlyphs();let e=!1;this.index===0&&(e=this.createStartSpacing()),this.shouldCreateBarNumber()?this.addPreBeatGlyph(new Hc(0,this.getLineHeight(-.5),this.bar.index+1)):e||this.addPreBeatGlyph(new ys(0,0,this.smuflMetrics.oneStaffSpace))}shouldCreateBarNumber(){let e=Vt.AllBars;switch(this.settings.notation.isNotationElementVisible(v.BarNumber)?this.bar.barNumberDisplay!==void 0?e=this.bar.barNumberDisplay:e=this.bar.staff.track.score.stylesheet.barNumberDisplay:e=Vt.Hide,e){case Vt.AllBars:return!0;case Vt.FirstOfSystem:return this.isFirstOfStaff;case Vt.Hide:return!1}return!0}createPostBeatGlyphs(){super.createPostBeatGlyphs();const e=this.lastBar;this.addPostBeatGlyph(new Nl(!0,this.bar.staff.track.score.stylesheet.extendBarLines)),e.masterBar.isRepeatEnd&&e.masterBar.repeatCount>2&&this.settings.notation.isNotationElementVisible(v.RepeatCount)&&this.addPostBeatGlyph(new Yf(0,this.getLineHeight(-.5),this.bar.masterBar.repeatCount))}paintBar(e,s,i,r,a){var p;const l=this.getBeamDirection(r),c=r.graceType!==ee.None?Ze.GraceScale:1;let d=(this.beamSpacing+this.beamThickness)*c,u=this.beamThickness*c;l===E.Down&&(d=-d,u=-u);for(let g=0,m=r.beats.length;g<m;g++){const y=r.beats[g];if(y.deadSlapped)continue;const S=this.getBeatX(y,oe.Stem);let k=s+this.y;l===E.Up?k+=this.getFlagBottomY(y,l):k+=this.getFlagTopY(y,l);const T=s+this.y+this.calculateBeamY(r,S);let N,F;k<T?(N=k,F=T):(N=T,F=k),this.paintBeamingStem(y,s+this.y,e+this.x+S,N,F,i);const q=ve.beat(i,a,y);try{const U=this.smuflMetrics.brokenBeamWidth*c,x=A.getIndex(y.duration)-2,j=s+this.y,Q=this.smuflMetrics.stemThickness;for(let Te=0;Te<x;Te++){let te=Math.floor(S+Q),we=0,$e=0,ce=0;const rt=j+Te*d;if(g<r.beats.length-1){const Es=Ms.isFullBarJoin(y,r.beats[g+1],Te);if(Te===x-1&&Es&&y.beamingMode===ot.ForceSplitOnSecondaryToNext)we=Math.ceil(te+U),$e=rt+this.calculateBeamY(r,te),ce=rt+this.calculateBeamY(r,we),pi.paintSingleBar(i,e+this.x+te,$e,e+this.x+we,ce,u),we=Math.floor(this.getBeatX(r.beats[g+1],oe.Stem)),te=Math.floor(we-U),$e=rt+this.calculateBeamY(r,te),ce=rt+this.calculateBeamY(r,we),pi.paintSingleBar(i,e+this.x+te,$e,e+this.x+we,ce,u);else{if(Es)we=Math.ceil(this.getBeatX(r.beats[g+1],oe.Stem));else if(g===0||!Ms.isFullBarJoin(r.beats[g-1],y,Te))we=Math.ceil(te+U);else continue;$e=rt+this.calculateBeamY(r,te),ce=rt+this.calculateBeamY(r,we),pi.paintSingleBar(i,e+this.x+te,$e,e+this.x+we,ce,u)}}else g>0&&!Ms.isFullBarJoin(y,r.beats[g-1],Te)&&(we=Math.ceil(S),te=Math.floor(S-U),$e=rt+this.calculateBeamY(r,te),ce=rt+this.calculateBeamY(r,we),pi.paintSingleBar(i,e+this.x+te,$e,e+this.x+we,ce,u))}}finally{(p=q==null?void 0:q[Symbol.dispose])==null||p.call(q)}}if(r.graceType===ee.BeforeBeat){const g=this.getBeatX(r.beats[0],oe.Stem),m=this.smuflMetrics.glyphWidths.get(f.Flag8thUp)*Ze.GraceScale;let y=s+this.y+this.calculateBeamY(r,g)|0;y+=u+d,l===E.Down?kt.fillMusicFontSymbolSafe(i,e+this.x+g+m/2,y,Ze.GraceScale,f.GraceNoteSlashStemDown,!0):kt.fillMusicFontSymbolSafe(i,e+this.x+g+m/2,y,Ze.GraceScale,f.GraceNoteSlashStemUp,!0)}}static paintSingleBar(e,s,i,r,a,l){e.beginPath(),e.moveTo(s,i),e.lineTo(r,a),e.lineTo(r,a+l),e.lineTo(s,i+l),e.closePath(),e.fill()}calculateBeamingOverflows(e,s){let i=0,r=0;for(const a of this.helpers.beamHelpers)for(const l of a)if(this.shouldPaintBeamingHelper(l))if(l.beats.length===1&&l.beats[0].duration>=b.Half){const h=this.getTupletBeamDirection(l),c=this.getBeamDirection(l),d=this.smuflMetrics.stemFlagOffsets.get(l.beats[0].duration);if(c===E.Up){let u=this.getFlagTopY(l.beats[0],c)-d;if(l.hasTuplet&&h===c&&(u-=this.tupletSize+this.tupletOffset),u<i&&(i=u),l.hasTuplet&&h!==c){let p=this.getFlagBottomY(l.beats[0],h);p+=this.tupletSize+this.tupletOffset,p>r&&(r=p)}}else{let u=this.getFlagBottomY(l.beats[0],c)+d;if(l.hasTuplet&&h===c&&(u+=this.tupletSize+this.tupletOffset),u>r&&(r=u),l.hasTuplet&&h!==c){let p=this.getFlagTopY(l.beats[0],h);p-=this.tupletSize+this.tupletOffset,p<i&&(i=p)}}}else{const h=this.getBeamDirection(l);this.ensureBeamDrawingInfo(l,h);const c=l.drawingInfos.get(h),d=this.getTupletBeamDirection(l);if(h===E.Up){let u=Math.min(c.startY,c.endY);l.hasTuplet&&d===h&&(u-=this.tupletSize+this.tupletOffset),u<i&&(i=u);let p=this.voiceContainer.getLowestNoteY(l.beatOfLowestNote,M.Bottom);l.hasTuplet&&d!==h&&(p+=this.tupletSize+this.tupletOffset),p>r&&(r=p)}else{let u=Math.max(c.startY,c.endY);l.hasTuplet&&d===h&&(u+=this.tupletSize+this.tupletOffset),u>r&&(r=u);let p=this.voiceContainer.getHighestNoteY(l.beatOfHighestNote,M.Top);l.hasTuplet&&d!==h&&(p-=this.tupletSize+this.tupletOffset),p<i&&(i=p)}}i<e&&this.registerOverflowTop(Math.abs(i)),r>s&&this.registerOverflowBottom(Math.abs(r)-s)}initializeBeamDrawingInfo(e,s){const i=new cf,r=e.beats[0],a=e.beats[e.beats.length-1];i.startBeat=r,i.startX=this.getBeatX(r,oe.Stem),i.startY=s===E.Up?this.getFlagTopY(r,s):this.getFlagBottomY(r,s),i.endBeat=a,i.endX=this.getBeatX(a,oe.Stem),i.endY=s===E.Up?this.getFlagTopY(a,s):this.getFlagBottomY(a,s);const l=this.smuflMetrics.oneStaffSpace;return s===E.Down&&i.startY>i.endY&&i.startY-i.endY>l&&(i.endY=i.startY-l),s===E.Down&&i.endY>i.startY&&i.endY-i.startY>l&&(i.startY=i.endY-l),s===E.Up&&i.startY<i.endY&&i.endY-i.startY>l&&(i.endY=i.startY+l),s===E.Up&&i.endY<i.startY&&i.startY-i.endY>l&&(i.startY=i.endY+l),i}get beamSpacing(){return this.smuflMetrics.beamSpacing}get beamThickness(){return this.smuflMetrics.beamThickness}ensureBeamDrawingInfo(e,s){if(e.drawingInfos.has(s))return;const i=this.initializeBeamDrawingInfo(e,s);e.drawingInfos.set(s,i);const r=A.getIndex(e.shortestDuration)-2,a=this.applyBarShift(e,s,i,r);if(e.beats.length>1){if(s===E.Up){const h=a+this.getFlagTopY(e.beatOfHighestNote,s),d=i.calcY(this.getBeatX(e.beatOfHighestNote,oe.Stem))-h;d>0&&(i.startY-=d,i.endY-=d)}else{const h=a+this.getFlagBottomY(e.beatOfLowestNote,s),c=i.calcY(this.getBeatX(e.beatOfLowestNote,oe.Stem)),d=h-c;d>0&&(i.startY+=d,i.endY+=d)}let l=0;if(e.restBeats.length>0){const h=e.graceType!==ee.None?Ze.GraceScale:1;l=r*(this.beamSpacing+this.beamThickness)*h}for(const h of e.restBeats)if(h.isRest&&h.index<e.beats[e.beats.length-1].index){if(s===E.Up){const c=this.getBeatContainer(h).getBoundingBoxTop()-l,u=i.calcY(this.getBeatX(h,oe.Stem))-c;u>0&&(i.startY-=u,i.endY-=u)}else if(s===E.Down){const c=this.getBeatContainer(h).getBoundingBoxBottom()+l,d=i.calcY(this.getBeatX(h,oe.Stem)),u=c-d;u>0&&(i.startY+=u,i.endY+=u)}}if(e.slashBeats.length>0)for(const h of e.slashBeats){const c=i.calcY(this.getBeatX(h,oe.Stem)),u=(s===E.Up?this.getFlagTopY(h,s):this.getFlagBottomY(h,s))-c;u>0&&(i.startY+=u,i.endY+=u)}}E.Up,i.startY=Math.round(i.startY),i.endY=Math.round(i.endY)}applyBarShift(e,s,i,r){let a=0;const l=e.isRestBeamHelper,h=e.graceType!==ee.None?Ze.GraceScale:1;if(r>2&&!l){const c=this.beamSpacing*h,d=this.beamThickness*h,u=r*d+(r-1)*c;if(s===E.Up){const g=i.startY+2*d+c-u,m=i.startY-g;m>0&&(a=m*-1,i.startY-=m,i.endY-=m)}else{const m=i.startY-2*d+c+u-i.startY;m>0&&(a=m,i.startY+=m,i.endY+=m)}}return a}getMinLineOfBeat(e){return 0}getMaxLineOfBeat(e){return 0}}class Qa extends pi{constructor(e,s){super(e,s);o(this,"simpleWhammyOverflow",0);o(this,"_isOnlyNumbered");o(this,"shortestDuration",b.QuadrupleWhole);this._isOnlyNumbered=!s.staff.showSlash&&!s.staff.showTablature&&!s.staff.showStandardNotation}get dotSpacing(){return this.smuflMetrics.glyphHeights.get(f.AugmentationDot)*2}get repeatsBarSubElement(){return Ae.NumberedRepeats}get barNumberBarSubElement(){return Ae.NumberedBarNumber}get barLineBarSubElement(){return Ae.NumberedBarLines}get staffLineBarSubElement(){return Ae.NumberedStaffLine}get lineSpacing(){return this.smuflMetrics.oneStaffSpace}get heightLineCount(){return 5}get drawnLineCount(){return 0}get bottomGlyphOverflow(){return 0}get flagsSubElement(){return ht.NumberedDuration}get beamsSubElement(){return ht.NumberedDuration}get tupletSubElement(){return ht.NumberedTuplet}shouldPaintBeamingHelper(e){return!0}paintFlag(e,s,i,r,a){this.paintBar(e,s,i,r,a)}paintBar(e,s,i,r,a){var l;if(!(r.beats.length===0||r.graceType!==ee.None))for(let h=0,c=r.beats.length;h<c;h++){const d=r.beats[h],u=ve.beat(i,a,d);try{const p=this.getBeamDirection(r),m=r.graceType!==ee.None?Ze.GraceScale:1;let y=(this.beamSpacing+this.beamThickness)*m,S=this.beamThickness*m;p===E.Down&&(y=-y,S=-S);let k=A.getIndex(d.duration)-2,T=this.getBeatX(d,oe.PreNotes),N=0,F=0;h===r.beats.length-1?(N=T,F=this.getBeatX(d,oe.PostNotes)):(N=T,F=this.getBeatX(r.beats[h+1],oe.PreNotes));const q=s+this.y+this.calculateBeamY(r,T);for(let x=0;x<k;x++){const j=q+x*y;pi.paintSingleBar(i,e+this.x+N,j,e+this.x+F,j,S)}const U=this.voiceContainer.getBeatContainer(d);if(U&&U.hasAdditionalNumbers)for(const x of U.iterateAdditionalNumbers()){k=x.barCount,T=this.beatGlyphsStart+x.x+x.getBeatX(oe.PreNotes,!1);for(let j=0;j<k;j++){const Q=q+j*y,Te=this.beatGlyphsStart+x.x+x.getBeatX(oe.PostNotes,!1);pi.paintSingleBar(i,e+this.x+T,Q,e+this.x+Te,Q,S)}}}finally{(l=u==null?void 0:u[Symbol.dispose])==null||l.call(u)}}}calculateOverflows(e,s){super.calculateOverflows(e,s),!this.bar.isEmpty&&this.calculateBeamingOverflows(e,s)}getNoteLine(e){return 0}_calculateBarHeight(e){const s=A.getIndex(e.duration)-2;let i=0;if(s>0){const r=this.smuflMetrics;i=r.numberedBarRendererBarSpacing+s*(r.numberedBarRendererBarSpacing+r.numberedBarRendererBarSize)}return i}getFlagTopY(e,s){const i=this._calculateBarHeight(e),r=this.voiceContainer.getBeatContainer(e);return r?s===E.Up?r.getBoundingBoxTop()-i:r.getBoundingBoxBottom():s===E.Up?this.voiceContainer.getBoundingBoxTop()-i:this.voiceContainer.getBoundingBoxBottom()}getFlagBottomY(e,s){const i=this._calculateBarHeight(e),r=this.voiceContainer.getBeatContainer(e);return r?s===E.Down?r.getBoundingBoxBottom()+i:this.getLineY(0):s===E.Down?this.voiceContainer.getBoundingBoxBottom()+i:this.getLineY(0)}getBeamDirection(e){return E.Down}getTupletBeamDirection(e){return E.Up}createPreBeatGlyphs(){this.wasFirstOfStaff=this.isFirstOfStaff,(this.index===0||this.bar.masterBar.isRepeatStart&&this._isOnlyNumbered)&&this.addPreBeatGlyph(new Nl(!1,this.bar.staff.track.score.stylesheet.extendBarLines)),this.createLinePreBeatGlyphs();const e=this.createStartSpacing();this.shouldCreateBarNumber()?this.addPreBeatGlyph(new Hc(0,this.getLineHeight(-.5),this.bar.index+1)):e||this.addPreBeatGlyph(new ys(0,0,this.smuflMetrics.oneStaffSpace))}createLinePreBeatGlyphs(){this._isOnlyNumbered&&(!this.bar.previousBar||this.bar.previousBar&&this.bar.masterBar.timeSignatureNumerator!==this.bar.previousBar.masterBar.timeSignatureNumerator||this.bar.previousBar&&this.bar.masterBar.timeSignatureDenominator!==this.bar.previousBar.masterBar.timeSignatureDenominator||this.bar.previousBar&&this.bar.masterBar.isFreeTime&&this.bar.masterBar.isFreeTime!==this.bar.previousBar.masterBar.isFreeTime)&&(this.createStartSpacing(),this._createTimeSignatureGlyphs())}_createTimeSignatureGlyphs(){const e=this.bar.masterBar,s=new Th(0,this.getLineY(0),e.timeSignatureNumerator,e.timeSignatureDenominator,e.timeSignatureCommon,e.isFreeTime&&(e.previousMasterBar==null||e.isFreeTime!==e.previousMasterBar.isFreeTime));s.barSubElement=Ae.NumberedTimeSignature,this.addPreBeatGlyph(s)}createPostBeatGlyphs(){this._isOnlyNumbered&&super.createPostBeatGlyphs()}createVoiceGlyphs(e){if(e.index>0)return;super.createVoiceGlyphs(e);const s=this.bar.masterBar.start;for(const i of e.beats){const r=new Gc(i);if(this.addBeatGlyph(r),i.duration<b.Quarter){const a=i.displayStart+i.displayDuration;let l=i.displayStart+D.QuarterTime;for(;l<a;){if(a-l>=D.QuarterTime){const c=new zf(e.index,s+l);this.addBeatGlyph(c),r.addDash(c)}else if(i.duration===b.Half&&i.dots>1){const c=new Co(i,s+l,a-l);this.addBeatGlyph(c),r.addNotes(c)}l+=D.QuarterTime}}}}paintBeamingStem(e,s,i,r,a,l){}get beamSpacing(){return this.smuflMetrics.numberedBarRendererBarSpacing}get beamThickness(){return this.smuflMetrics.numberedBarRendererBarSize}paintBeamHelper(e,s,i,r,a,l){var h;((h=r.voice)==null?void 0:h.index)===0&&super.paintBeamHelper(e,s,i,r,a,l)}applyBarShift(e,s,i,r){return 0}calculateBeamYWithDirection(e,s,i){this.ensureBeamDrawingInfo(e,i);const r=e.drawingInfos.get(i);return i===E.Up?Math.min(r.startY,r.endY):Math.max(r.startY,r.endY)}paintTuplets(e,s,i,r,a=!1){super.paintTuplets(e,s,i,r,!0)}}o(Qa,"StaffId","numbered");class Xf extends wo{get staffId(){return Qa.StaffId}create(t,e){return new Qa(t,e)}canCreate(t,e){return super.canCreate(t,e)&&e.showNumbered}}class xh extends Ht{constructor(e,s,i,r){super(e,s,1,xh._getSymbol(i,r));o(this,"_clef");o(this,"_clefOttava");o(this,"_ottavaGlyph");this._clef=i,this._clefOttava=r}getBoundingBoxTop(){let e=super.getBoundingBoxTop();const s=this._ottavaGlyph;if(s){const i=this.y+s.getBoundingBoxTop();e=A.minBoundingBox(e,i)}return e}getBoundingBoxBottom(){let e=super.getBoundingBoxBottom();const s=this._ottavaGlyph;if(s){const i=this.y+s.getBoundingBoxBottom();e=A.maxBoundingBox(e,i)}return e}doLayout(){switch(this.center=!0,super.doLayout(),this.width=this.renderer.smuflMetrics.glyphWidths.get(f.GClef),this.offsetX=this.width/2,this._ottavaGlyph=void 0,this._clef){case Fe.C3:case Fe.C4:switch(this._clefOttava){case pe._8vb:return}break;case Fe.F4:case Fe.G2:return}let e,s=!1;switch(this._clefOttava){case pe._15ma:e=f.Clef15,s=!0;break;case pe._8va:e=f.Clef8,s=!0;break;case pe._8vb:e=f.Clef8;break;case pe._15mb:e=f.Clef15;break;default:return}const i=this.width/2,r=s?this.renderer.smuflMetrics.glyphTop.get(this.symbol):this.renderer.smuflMetrics.glyphBottom.get(this.symbol)-this.renderer.smuflMetrics.glyphHeights.get(e);this._ottavaGlyph=new Ht(i,-r,1,e),this._ottavaGlyph.center=!0,this._ottavaGlyph.renderer=this.renderer,this._ottavaGlyph.doLayout()}static _getSymbol(e,s){switch(e){case Fe.Neutral:return f.UnpitchedPercussionClef1;case Fe.C3:case Fe.C4:switch(s){case pe._8vb:return f.CClef8vb;default:return f.CClef}case Fe.F4:switch(s){case pe._15ma:return f.FClef15ma;case pe._8va:return f.FClef8va;case pe._8vb:return f.FClef8vb;case pe._15mb:return f.FClef15mb;default:return f.FClef}case Fe.G2:switch(s){case pe._15ma:return f.GClef15ma;case pe._8va:return f.GClef8va;case pe._8vb:return f.GClef8vb;case pe._15mb:return f.GClef15mb;default:return f.GClef}default:return f.None}}paint(e,s,i){var a;const r=ve.bar(i,Ae.StandardNotationClef,this.renderer.bar);try{super.paint(e,s,i);const l=this._ottavaGlyph;l&&l.paint(e+this.x,s+this.y,i)}finally{(a=r==null?void 0:r[Symbol.dispose])==null||a.call(r)}}}class $f extends xa{paint(t,e,s){var r;const i=ve.bar(s,Ae.StandardNotationKeySignature,this.renderer.bar);try{super.paint(t,e,s)}finally{(r=i==null?void 0:i[Symbol.dispose])==null||r.call(i)}}}class Pa extends Cs{constructor(e,s,i){super(e,s);o(this,"_note");this._note=i}static _getSymbol(e,s){switch(e){case mt.None:return f.None;case mt.Normal:return s?f.ArticAccentAbove:f.ArticAccentBelow;case mt.Heavy:return s?f.ArticMarcatoAbove:f.ArticMarcatoBelow;case mt.Tenuto:return s?f.ArticTenutoAbove:f.ArticTenutoBelow;default:return f.None}}doLayout(){this.width=this.renderer.smuflMetrics.glyphWidths.get(f.ArticAccentAbove),this.height=this.renderer.smuflMetrics.glyphHeights.get(f.ArticAccentAbove)}paint(e,s,i){const r=this.renderer.getBeatDirection(this._note.beat),a=Pa._getSymbol(this._note.accentuated,r===E.Down),l=r===E.Up?s+this.y:s+this.y+this.height;kt.fillMusicFontSymbolSafe(i,e+this.x,l,1,a,!0)}}class hc extends Ht{constructor(t,e){super(t,e,Ze.GraceScale,f.ArticStaccatoAbove),this.center=!0}doLayout(){super.doLayout(),this.offsetY=this.height}}class nn extends Ht{constructor(e,s,i,r){super(e,s,i?Ze.GraceScale:1,r);o(this,"centerOnStem",!1)}paint(e,s,i){this.centerOnStem&&(this.center=!0),super.paint(e,s,i)}}class Qr extends nn{constructor(t,e,s,i){super(t,e,i,Qr.getSymbol(s))}static getSymbol(t){switch(t){case b.QuadrupleWhole:return f.NoteheadDoubleWholeSquare;case b.DoubleWhole:return f.NoteheadDoubleWhole;case b.Whole:return f.NoteheadWhole;case b.Half:return f.NoteheadHalf;default:return f.NoteheadBlack}}}class Jf extends nn{constructor(t,e,s){super(t,e,s,f.NoteheadXOrnate)}}class so extends nn{constructor(t,e,s,i){super(t,e,i,so._getSymbol(s))}static _getSymbol(t){switch(t){case b.QuadrupleWhole:case b.DoubleWhole:case b.Whole:case b.Half:return f.NoteheadDiamondWhiteWide;default:return f.NoteheadDiamondBlackWide}}}class cc{constructor(t,e,s){o(this,"steps",0);o(this,"isGhost");o(this,"color");this.steps=t,this.isGhost=e,this.color=s}}class io extends It{constructor(e){super(0,0);o(this,"_isOpen");o(this,"_infos",[]);o(this,"_glyphs",[]);o(this,"isEmpty",!0);this._isOpen=e}addParenthesis(e){const s=this.renderer,i=s.getNoteSteps(e),r=e.isGhost||this._isTiedBend(e)&&s.settings.notation.isNotationElementVisible(v.ParenthesisOnTiedBends),a=ve.noteColor(s.resources,ns.Effects,e);this._add(new cc(i,r,a))}addParenthesisOnSteps(e,s){const i=new cc(e,s,void 0);this._add(i)}_add(e){this._infos.push(e),e.isGhost&&(this.isEmpty=!1)}_isTiedBend(e){return e.isTieDestination?e.tieOrigin.hasBend?!0:this._isTiedBend(e.tieOrigin):!1}doLayout(){const e=this.renderer;this._infos.sort((r,a)=>r.steps-a.steps);let s=null;const i=e.getScoreHeight(1);for(let r=0,a=this._infos.length;r<a;r++){let l;if(!this._infos[r].isGhost)s=null;else if(!s)l=new El(this._isOpen),l.colorOverride=this._infos[r].color,l.renderer=this.renderer,l.y=e.getScoreY(this._infos[r].steps)-i,l.height=i*2,l.doLayout(),this._glyphs.push(l),s=l;else{const h=e.getScoreY(this._infos[r].steps)+i;s.height=h-s.y}}this.width=this._glyphs.length>0?this._glyphs[0].width:0}paint(e,s,i){super.paint(e,s,i);for(const r of this._glyphs)r.paint(e+this.x,s+this.y,i)}}class qf extends nn{constructor(e,s,i,r,a){super(e,s,a,i.getSymbol(r));o(this,"_isGrace");o(this,"_articulation");this._isGrace=a,this._articulation=i}paint(e,s,i){const r=i.color;this.colorOverride&&(i.color=this.colorOverride);const a=this._isGrace?1:0;kt.fillMusicFontSymbolSafe(i,e+this.x,s+this.y+a,this.glyphScale,this.symbol,!1),this._articulation.techniqueSymbol!==f.None&&this._articulation.techniqueSymbolPlacement===Je.Inside&&kt.fillMusicFontSymbolSafe(i,e+this.x,s+this.y+a,this.glyphScale,this._articulation.techniqueSymbol,!1),i.color=r}doLayout(){super.doLayout(),this.width===0&&(this.height=this.renderer.smuflMetrics.glyphWidths.get(f.NoteheadBlack)),this.height===0&&(this.height=this.renderer.smuflMetrics.glyphHeights.get(f.NoteheadBlack))}}class Qf extends Ht{constructor(t,e){super(t,e,.5,f.PictEdgeOfCymbal),this.center=!0}doLayout(){super.doLayout(),this.offsetY=this.height}}var Zs;(function(n){n[n.NoIntersection=0]="NoIntersection",n[n.EndsTouchingOuter=1]="EndsTouchingOuter",n[n.EndsTouchingInner=2]="EndsTouchingInner",n[n.ExactMatch=3]="ExactMatch",n[n.FullIntersection=4]="FullIntersection"})(Zs||(Zs={}));class or{constructor(t){o(this,"mainVoiceDirection",E.Up);o(this,"groups",new Map);o(this,"minX",0);o(this,"maxX",0);o(this,"_isFinished",!1);this.mainVoiceDirection=t}update(){let t=0,e=0;for(const s of this.groups.values()){const i=s.minX+s.multiVoiceShiftX,r=s.maxX+s.multiVoiceShiftX;i<t&&(t=i),e<r&&(e=r)}this.minX=t,this.maxX=e}finish(t){if(!this._isFinished){this._isFinished=!0;for(const e of this.groups.values())this._checkForGroupDisplacement(e,t);this.update()}}_checkForGroupDisplacement(t,e){if(this.mainVoiceDirection===t.direction)return;const s=this.groups.get(this.mainVoiceDirection),i=or._checkIntersection(s,t),r=e.multiVoiceDisplacedNoteHeadSpacing;switch(i){case Zs.NoIntersection:return;case Zs.ExactMatch:or._canShareNoteHead(s,t)||(s.direction===E.Up?t.displacedNotes?t.multiVoiceShiftX=t.stemX+t.correctNotes.width+r:t.multiVoiceShiftX=t.correctNotes.width+r:s.multiVoiceShiftX=t.stemX+r);break;case Zs.EndsTouchingOuter:if(s.direction===E.Up)if(s.displacedNotes)t.multiVoiceShiftX=s.stemX;else{const a=s.stemX-t.stemX;t.multiVoiceShiftX=a}else if(s.displacedNotes)t.multiVoiceShiftX=-t.stemX;else{const a=t.stemX-s.stemX;s.multiVoiceShiftX=a}break;case Zs.EndsTouchingInner:s.direction===E.Up?(s.multiVoiceShiftX=s.stemX,t.hasFlag&&(s.multiVoiceShiftX+=r)):(t.multiVoiceShiftX=t.stemX,s.hasFlag&&(t.multiVoiceShiftX+=r));break;case Zs.FullIntersection:!s.hasStem&&!t.hasStem||(s.direction===E.Up?(s.multiVoiceShiftX=s.stemX,t.hasFlag?s.multiVoiceShiftX+=r:s.multiVoiceShiftX-=r):(t.multiVoiceShiftX=t.stemX,s.hasFlag?t.multiVoiceShiftX+=r:t.multiVoiceShiftX-=r));break}}static _canShareNoteHead(t,e){const s=t.direction===E.Up?t.maxStep:t.minStep,i=e.direction===E.Up?e.maxStep:e.minStep,r=t.correctNotes.notes.get(s);if(r.length>1)return!1;const a=e.correctNotes.notes.get(i);return a.length>1?!1:or._canShareNoteHeadGlyph(r[0].glyph,a[0].glyph)}static _canShareNoteHeadGlyph(t,e){return t.glyphScale===e.glyphScale&&t.centerOnStem===e.centerOnStem&&Ha.isBlackNoteHead(t.symbol)&&Ha.isBlackNoteHead(e.symbol)}static _checkIntersection(t,e){let s=0;if(t.direction===E.Up){const i=t.maxStep;s=e.minStep-i}else{const i=t.minStep,r=e.maxStep;s=i-r}return s===0?Zs.ExactMatch:s===1?Zs.EndsTouchingOuter:s===-1?Zs.EndsTouchingInner:s<0?Zs.FullIntersection:Zs.NoIntersection}}class Eo extends It{constructor(){super(0,0);o(this,"_infos",[]);o(this,"_noteHeadInfo");o(this,"noteGroup");o(this,"minStepsNote",null);o(this,"maxStepsNote",null);o(this,"noteStartX",0);o(this,"onTimeX",0)}get stemX(){return this.noteGroup?this.noteGroup.stemX+this.noteGroup.multiVoiceShiftX:0}getBoundingBoxTop(){return this.minStepsNote?this.minStepsNote.glyph.getBoundingBoxTop():this.y}getBoundingBoxBottom(){return this.maxStepsNote?this.maxStepsNote.glyph.getBoundingBoxBottom():this.y+this.height}add(e,s){const i={glyph:e,steps:s};this._infos.push(i),(!this.minStepsNote||this.minStepsNote.steps>i.steps)&&(this.minStepsNote=i),(!this.maxStepsNote||this.maxStepsNote.steps<i.steps)&&(this.maxStepsNote=i)}_prepareForLayout(e){const s=this.direction;e.groups||(e.mainVoiceDirection=s),s===E.Up?this._infos.sort((l,h)=>h.steps-l.steps):this._infos.sort((l,h)=>l.steps-h.steps);let i;const r=this.hasFlag,a=this.hasStem;return e.groups.has(s)?(i=e.groups.get(s),r&&(i.hasFlag=r),a&&(i.hasStem=a)):(i={correctNotes:{notes:new Map,width:0,minX:Number.NaN},direction:s,stemX:0,maxX:Number.NaN,minX:Number.NaN,minStep:Number.NaN,maxStep:Number.NaN,multiVoiceShiftX:0,hasFlag:r,hasStem:a},e.groups.set(s,i)),i}doLayout(){const e=this.getScoreChordNoteHeadInfo(),s=this._prepareForLayout(e);this.noteGroup=s,this._noteHeadInfo=e,this._collectNoteDisplacements(s),this._alignNoteHeadsGroup(s),e.update(),this._updateSizes()}_updateSizes(){const e=this.noteGroup;this.onTimeX=e.correctNotes.minX+e.correctNotes.width/2,this.width=this.noteStartX+e.multiVoiceShiftX+e.maxX-e.minX}doMultiVoiceLayout(){this._noteHeadInfo.finish(this.renderer.smuflMetrics),this._updateSizes()}_alignNoteHeadsGroup(e){e.direction===E.Up?(this._alignNoteHeads(e,e.correctNotes,!0),e.displacedNotes&&this._alignNoteHeads(e,e.displacedNotes,!1)):(this._alignNoteHeads(e,e.correctNotes,!1),e.displacedNotes&&this._alignNoteHeads(e,e.displacedNotes,!0))}_alignNoteHeads(e,s,i){const r=this.scale,a=this.renderer.smuflMetrics;for(const l of s.notes.values())for(const h of l){h.glyph.x=e.stemX,h.glyph.centerOnStem||(i?a.stemUp.has(h.glyph.symbol)?h.glyph.x-=a.stemUp.get(h.glyph.symbol).x*r:h.glyph.x-=a.glyphWidths.get(h.glyph.symbol)*r:a.stemDown.has(h.glyph.symbol)&&(h.glyph.x+=a.stemDown.get(h.glyph.symbol).x*r)),s.width=Math.max(s.width,h.glyph.width),(Number.isNaN(s.minX)||h.glyph.x<s.minX)&&(s.minX=h.glyph.x),(Number.isNaN(e.minX)||h.glyph.x<e.minX)&&(e.minX=h.glyph.x);const c=h.glyph.x+h.glyph.width;(Number.isNaN(e.maxX)||c>e.maxX)&&(e.maxX=c)}}static _hasCollision(e,s){return e.notes.has(s.steps)||e.notes.has(s.steps+1)||e.notes.has(s.steps-1)}_collectNoteDisplacements(e){for(const s of this._infos){s.glyph.renderer=this.renderer,s.glyph.doLayout();const i=Eo._hasCollision(e.correctNotes,s);let r;i?(e.displacedNotes||(e.displacedNotes={notes:new Map,width:0,minX:0}),r=e.displacedNotes):r=e.correctNotes;let a;r.notes.has(s.steps)?a=r.notes.get(s.steps):(a=[],r.notes.set(s.steps,a)),a.push(s),(Number.isNaN(e.minStep)||s.steps<e.minStep)&&(e.minStep=s.steps),(Number.isNaN(e.maxStep)||s.steps>e.maxStep)&&(e.maxStep=s.steps),this._updateGroupStemXPosition(s,e)}}_updateGroupStemXPosition(e,s){const i=this.renderer.smuflMetrics,r=this.scale;let a;s.direction===E.Up||s.displacedNotes?i.stemUp.has(e.glyph.symbol)?a=i.stemUp.get(e.glyph.symbol).x*r:a=i.glyphWidths.get(e.glyph.symbol)*r:i.stemDown.has(e.glyph.symbol)?a=i.stemDown.get(e.glyph.symbol).x*r:a=0,a+=this.noteStartX,a>s.stemX&&(s.stemX=a)}paint(e,s,i){e+=this.x,s+=this.y,this._paintLedgerLines(e,s,i);const r=this.noteGroup;e+=r.multiVoiceShiftX;const a=this._infos;for(const l of a)l.glyph.renderer=this.renderer,l.glyph.paint(e,s,i)}_paintLedgerLines(e,s,i){var l;if(!this.minStepsNote)return;const r=this.renderer,a=ve.bar(i,Ae.StandardNotationStaffLine,r.bar,!0);try{const h=this.scale,c=this.renderer.smuflMetrics.legerLineExtension*h,d=this.width+c*2-this.noteStartX,u=r.getLineHeight(1),p=r.getLineY(-1),g=r.getLineY(r.drawnLineCount),m=r.getLineY(this.minStepsNote.steps/2),y=r.getLineY(this.maxStepsNote.steps/2),S=this.renderer.smuflMetrics.legerLineThickness*h/2;let k=p;for(;k>=m;)i.fillRect(e-c+this.noteStartX,s+k-S,d,this.renderer.smuflMetrics.legerLineThickness*h),k-=u;for(k=g;k<=y;)i.fillRect(e-c+this.noteStartX,s+k-S,d,this.renderer.smuflMetrics.legerLineThickness*h),k+=u}finally{(l=a==null?void 0:a[Symbol.dispose])==null||l.call(a)}}}class oa extends Ht{constructor(e,s,i){super(e,s,1,oa._getSymbol(i));o(this,"stemExtensionHeight",0)}static _getSymbol(e){if(e.style===zi.BuzzRoll)return f.BuzzRoll;switch(e.marks){case 1:return f.Tremolo1;case 2:return f.Tremolo2;case 3:return f.Tremolo3;case 4:return f.Tremolo4;case 5:return f.Tremolo5;default:return f.None}}alignTremoloPickingGlyph(e,s,i,r){const a=this.renderer,l=a.smuflMetrics;let h=0;const c=l.glyphHeights.get(f.Tremolo1)/2,d=this.height/2,u=this.symbol===f.Tremolo1,p=a.lineSpacing,g=u?p:p/2;if(e===E.Up){let m=s;m+=l.stemFlagHeight.get(r),m-=l.stemFlagOffsets.get(r),h=g*Math.ceil(m/g);const y=h+d,S=i-p;S<y&&(h=S-d),m+=c;const k=h-d;m>k?this.stemExtensionHeight=m-k:this.stemExtensionHeight=0}else{let m=s;m-=l.stemFlagHeight.get(r),m+=l.stemFlagOffsets.get(r),h=g*Math.floor(m/g);const y=h-d,S=i+p;S>y&&(h=S+d),m-=c;const k=h+d;m<k?this.stemExtensionHeight=k-m:this.stemExtensionHeight=0}this.y=h}}class Kf extends Eo{constructor(){super(...arguments);o(this,"_noteGlyphLookup",new Map);o(this,"_notes",[]);o(this,"_deadSlapped",null);o(this,"_tremoloPicking",null);o(this,"_stemLengthExtension",0);o(this,"aboveBeatEffects",new Map);o(this,"belowBeatEffects",new Map);o(this,"beat")}get direction(){return this.renderer.getBeatDirection(this.beat)}get hasFlag(){return this.renderer.hasFlag(this.beat)}get hasStem(){return this.renderer.hasStem(this.beat)}get scale(){return this.beat.graceType!==ee.None?Ze.GraceScale:1}getScoreChordNoteHeadInfo(){if(this.beat.graceType!==ee.None)return new or(this.direction);const e=this.beat.voice.bar.staff,s=`score.noteheads.${e.track.index}.${e.index}.${this.beat.voice.bar.index}.${this.beat.absoluteDisplayStart}`;let i=this.renderer.staff.getSharedLayoutData(s,void 0);return i||(i=new or(this.direction),this.renderer.staff.setSharedLayoutData(s,i)),i}getNoteX(e,s){if(this._noteGlyphLookup.has(e.id)){const i=this._noteGlyphLookup.get(e.id);let r=this.x+i.x;switch(s){case je.Left:break;case je.Center:r+=i.width/2;break;case je.Right:r+=i.width;break}return r}return 0}getNoteY(e,s){if(this._noteGlyphLookup.has(e.id)){const i=this._noteGlyphLookup.get(e.id);return this._internalGetNoteY(i,s)}return 0}getLowestNoteY(e){return this.maxStepsNote?this._internalGetNoteY(this.maxStepsNote.glyph,e):0}getHighestNoteY(e){return this.minStepsNote?this._internalGetNoteY(this.minStepsNote.glyph,e):0}_internalGetNoteY(e,s){let i=this.y+e.y;const r=this.renderer,a=this.beat.graceType!==ee.None?Ze.GraceScale:1;switch(s){case M.TopWithStem:i-=(r.smuflMetrics.stemUp.has(e.symbol)?r.smuflMetrics.stemUp.get(e.symbol).bottomY:0)*a,i-=r.smuflMetrics.getStemLength(this.beat.duration,r.hasFlag(this.beat))*a,i-=this._stemLengthExtension;let l=r.centerStaffStemY(this.direction);return l-=this._stemLengthExtension,Math.min(l,i);case M.Top:i-=e.height/2;break;case M.Center:break;case M.Bottom:i+=e.height/2;break;case M.BottomWithStem:i-=(this.renderer.smuflMetrics.stemDown.has(e.symbol)?this.renderer.smuflMetrics.stemDown.get(e.symbol).topY:-this.renderer.smuflMetrics.glyphHeights.get(e.symbol)/2)*a,i+=r.smuflMetrics.getStemLength(this.beat.duration,r.hasFlag(this.beat))*a,i+=this._stemLengthExtension;let h=r.centerStaffStemY(this.direction);return h+=this._stemLengthExtension,Math.max(h,i);case M.StemUp:i-=(r.smuflMetrics.stemUp.has(e.symbol)?r.smuflMetrics.stemUp.get(e.symbol).bottomY:0)*a;break;case M.StemDown:i-=(r.smuflMetrics.stemDown.has(e.symbol)?r.smuflMetrics.stemDown.get(e.symbol).topY:-r.smuflMetrics.glyphHeights.get(e.symbol)/2)*a;break}return i}addMainNoteGlyph(e,s,i){super.add(e,i),this._noteGlyphLookup.set(s.id,e),this._notes.push(s)}addEffectNoteGlyph(e,s){super.add(e,s)}doLayout(){super.doLayout();const e=this.renderer;this.beat.deadSlapped&&(this._deadSlapped=new Po,this._deadSlapped.renderer=this.renderer,this._deadSlapped.doLayout(),this.width=this._deadSlapped.width,this.onTimeX=this.width/2);let s=0,i=0;const r=this.renderer.smuflMetrics.onNoteEffectPadding;this.beat.deadSlapped?(i=e.getScoreY(0),s=e.getScoreY(e.heightLineCount)):this.direction===E.Up?(i=this._internalGetNoteY(this.maxStepsNote.glyph,M.Bottom)+r,s=this._internalGetNoteY(this.minStepsNote.glyph,M.TopWithStem)-r):(i=this._internalGetNoteY(this.maxStepsNote.glyph,M.BottomWithStem)+r,s=this._internalGetNoteY(this.minStepsNote.glyph,M.Top)-r);let a=null,l=null;for(const h of this.aboveBeatEffects.values())h.renderer=this.renderer,h.doLayout(),s-=h.height,h.y=s,(a===null||a>s)&&(a=s),(l===null||l<s)&&(l=s),s-=r;for(const h of this.belowBeatEffects.values())h.renderer=this.renderer,h.doLayout(),h.y=i,(a===null||a>i)&&(a=i),(l===null||l<i)&&(l=i),i+=h.height+r;a!==null&&e.registerBeatEffectOverflows(a,l??0),this.beat.isTremolo&&!this.beat.deadSlapped&&(this._tremoloPicking=new oa(0,0,this.beat.tremoloPicking),this._tremoloPicking.renderer=this.renderer,this._tremoloPicking.doLayout(),this._alignTremoloPickingGlyph())}_alignTremoloPickingGlyph(){const e=this._tremoloPicking,s=this.direction;s===E.Up?e.alignTremoloPickingGlyph(s,this.getHighestNoteY(M.TopWithStem),this.getHighestNoteY(M.Center),this.beat.duration):e.alignTremoloPickingGlyph(s,this.getLowestNoteY(M.BottomWithStem),this.getLowestNoteY(M.Center),this.beat.duration),this._stemLengthExtension=e.stemExtensionHeight;let i=this.stemX;this.beat.duration<b.Half&&(i=this.width/2),e.x=i}buildBoundingsLookup(e,s,i){for(const r of this._notes)if(this._noteGlyphLookup.has(r.id)){const a=this._noteGlyphLookup.get(r.id),l=new na;l.note=r,l.noteHeadBounds=new Pt,l.noteHeadBounds.x=s+this.x+a.x,l.noteHeadBounds.y=i+this.y+a.y-a.height/2,l.noteHeadBounds.w=a.width,l.noteHeadBounds.h=a.height,e.addNote(l)}}paint(e,s,i){this._paintEffects(e,s,i),super.paint(e,s,i)}_paintEffects(e,s,i){var a;const r=ve.beat(i,ht.StandardNotationEffects,this.beat);try{for(const l of this.aboveBeatEffects.values())l.paint(e+this.x+this.width/2,s+this.y,i);for(const l of this.belowBeatEffects.values())l.paint(e+this.x+this.width/2,s+this.y,i);this._tremoloPicking&&this._tremoloPicking.paint(e,s,i),this._deadSlapped&&this._deadSlapped.paint(e,s,i)}finally{(a=r==null?void 0:r[Symbol.dispose])==null||a.call(r)}}}class on extends Ht{constructor(t,e,s){super(t,e,1,on.getSymbol(s))}static getSymbol(t){switch(t){case b.QuadrupleWhole:return f.RestLonga;case b.DoubleWhole:return f.RestDoubleWhole;case b.Whole:return f.RestWhole;case b.Half:return f.RestHalf;case b.Quarter:return f.RestQuarter;case b.Eighth:return f.Rest8th;case b.Sixteenth:return f.Rest16th;case b.ThirtySecond:return f.Rest32nd;case b.SixtyFourth:return f.Rest64th;case b.OneHundredTwentyEighth:return f.Rest128th;case b.TwoHundredFiftySixth:return f.Rest256th;default:return f.None}}paint(t,e,s){this.internalPaint(t,e,s,ht.StandardNotationRests)}internalPaint(t,e,s,i){var a;const r=ve.beat(s,i,this.beat);try{super.paint(t,e,s)}finally{(a=r==null?void 0:r[Symbol.dispose])==null||a.call(r)}}}class Gi extends Eo{constructor(e,s,i=!1){super();o(this,"_beat");o(this,"_showParenthesis",!1);o(this,"_noteValueLookup",new Map);o(this,"_accidentals",new Bh);o(this,"_preNoteParenthesis",null);o(this,"_postNoteParenthesis",null);o(this,"isEmpty",!0);o(this,"_groupId");this._beat=s,this._groupId=e,this._showParenthesis=i,i&&(this._preNoteParenthesis=new io(!0),this._postNoteParenthesis=new io(!1))}get scale(){return Ze.GraceScale}get hasFlag(){return!1}get hasStem(){return!1}get direction(){return E.Up}getScoreChordNoteHeadInfo(){const e=this._beat.voice.bar.staff,s=`score.noteheads.${this._groupId}.${e.track.index}.${e.index}.${this._beat.absoluteDisplayStart}`;let i=this.renderer.staff.getSharedLayoutData(s,void 0);return i||(i=new or(this.direction),this.renderer.staff.setSharedLayoutData(s,i)),new or(this.direction)}containsNoteValue(e){return this._noteValueLookup.has(e)}getNoteValueY(e){return this._noteValueLookup.has(e)?this.y+this._noteValueLookup.get(e).y:0}addGlyph(e,s,i){const r=this.renderer,a=new Qr(0,0,b.Quarter,!0),l=r.accidentalHelper.applyAccidentalForValue(this._beat,e,s,!0),h=r.accidentalHelper.getNoteStepsForValue(e,!1);if(a.y=r.getScoreY(h),this._showParenthesis&&(this._preNoteParenthesis.renderer=this.renderer,this._postNoteParenthesis.renderer=this.renderer,this._preNoteParenthesis.addParenthesisOnSteps(h,!0),this._postNoteParenthesis.addParenthesisOnSteps(h,!0)),l!==he.None){const c=new Ci(0,a.y,l,Ze.GraceScale);c.renderer=this.renderer,this._accidentals.renderer=this.renderer,this._accidentals.addGlyph(c)}this._noteValueLookup.set(e,a),this.add(a,h),this.isEmpty=!1}doLayout(){let e=0;this._showParenthesis&&(this._preNoteParenthesis.x=e,this._preNoteParenthesis.renderer=this.renderer,this._preNoteParenthesis.doLayout(),e+=this._preNoteParenthesis.width+this.renderer.smuflMetrics.bendNoteHeadElementPadding),this._accidentals.isEmpty||(e+=this._accidentals.width+this.renderer.smuflMetrics.bendNoteHeadElementPadding,this._accidentals.x=e,this._accidentals.renderer=this.renderer,this._accidentals.doLayout(),e+=this._accidentals.width+this.renderer.smuflMetrics.bendNoteHeadElementPadding),this.noteStartX=e,super.doLayout(),this._showParenthesis&&(this._postNoteParenthesis.x=this.width+this.renderer.smuflMetrics.bendNoteHeadElementPadding,this._postNoteParenthesis.renderer=this.renderer,this._postNoteParenthesis.doLayout(),this.width+=this._postNoteParenthesis.width+this.renderer.smuflMetrics.bendNoteHeadElementPadding)}paint(e,s,i){this._accidentals.isEmpty||this._accidentals.paint(e+this.x,s+this.y,i),this._showParenthesis&&(this._preNoteParenthesis.paint(e+this.x,s+this.y,i),this._postNoteParenthesis.paint(e+this.x,s+this.y,i)),super.paint(e,s,i)}}class zc extends mi{drawBendSlur(t,e,s,i,r,a,l){zt.drawBendSlur(t,e,s,i,r,a,this.renderer.smuflMetrics.tieHeight,l)}doLayout(){if(this.glyphs){this.width=0;for(const t of this.glyphs)t.doLayout(),this.width+=t.width}}getTieDirection(t,e){switch(e.getBeatDirection(t)){case E.Up:return E.Down;default:return E.Up}}}class Zf extends zc{constructor(e){super(0,0);o(this,"_container");o(this,"_beat");o(this,"_endGlyph",null);o(this,"checkForOverflow",!1);this._container=e,this._beat=e.beat}get hasBoundingBox(){const e=this._endGlyph;return e?!!e.minStepsNote&&!!e.maxStepsNote:!1}getBoundingBoxTop(){var e;return(e=this._endGlyph)!=null&&e.minStepsNote?this._endGlyph.minStepsNote.glyph.getBoundingBoxTop():super.getBoundingBoxTop()}getBoundingBoxBottom(){var e;return(e=this._endGlyph)!=null&&e.maxStepsNote?this._endGlyph.maxStepsNote.glyph.getBoundingBoxBottom():super.getBoundingBoxBottom()}doMultiVoiceLayout(){var e;(e=this._endGlyph)==null||e.doMultiVoiceLayout()}doLayout(){const e=this.renderer,s=e.settings.notation.notationMode;switch(this._beat.whammyBarType){case De.None:case De.Custom:case De.Hold:return;case De.Dive:case De.PrediveDive:{const i=new Gi("postwhammy",this._beat,!1);this._endGlyph=i,i.renderer=e;const r=this._beat.whammyBarPoints[this._beat.whammyBarPoints.length-1];for(const a of this._beat.notes)a.isTieOrigin||i.addGlyph(this._getBendNoteValue(a,r),r.value%2!==0,void 0);i.doLayout(),this.addGlyph(i)}break;case De.Dip:{if(s===Xt.SongBook)return;{const i=new Gi("middlewhammy",this._beat,!1);if(i.renderer=e,e.settings.notation.notationMode===Xt.GuitarPro){const a=this._beat.whammyBarPoints[1];for(const l of this._beat.notes)i.addGlyph(this._getBendNoteValue(l,this._beat.whammyBarPoints[1]),a.value%2!==0,void 0)}i.doLayout(),this.addGlyph(i);const r=new Gi("postwhammy",this._beat,!1);if(r.renderer=e,this._endGlyph=r,e.settings.notation.notationMode===Xt.GuitarPro){const a=this._beat.whammyBarPoints[this._beat.whammyBarPoints.length-1];for(const l of this._beat.notes)r.addGlyph(this._getBendNoteValue(l,a),a.value%2!==0,void 0)}r.doLayout(),this.addGlyph(r)}}break;case De.Predive:break}super.doLayout(),this.width=this.width/2}paint(e,s,i){var c,d;const r=this._beat;switch(r.whammyBarType){case De.None:case De.Custom:return}const a=this.renderer.settings.notation.notationMode,l=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,r.voice.bar),h=ve.beat(i,ht.StandardNotationEffects,r);try{const u=e+l.x+l.getBeatX(r,oe.MiddleNotes),p=this.getTieDirection(r,l);let g=this._beat.notes.length===1?p:E.Up;const m=i.textAlign,y=this.renderer.smuflMetrics.glyphHeights.get(f.NoteheadBlack);for(let S=0;S<r.notes.length;S++){const k=r.notes[S],T=ve.note(i,ns.StandardNotationEffects,k);try{let N=s+l.y;S>0&&S>=(this._beat.notes.length/2|0)&&(g=E.Down),g===E.Down?N+=l.getNoteY(k,M.Bottom):N+=l.getNoteY(k,M.Top);let F=e+l.x+l.getBeatX(r,oe.EndBeat);if(F-=this.renderer.smuflMetrics.postNoteEffectPadding,this._endGlyph){const te=this._endGlyph.width-this._endGlyph.onTimeX;F-=te}const q=r.whammyStyle===tt.Gradual&&S===0?"grad.":"";let U=null;k.isTieOrigin&&(U=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,k.tieDestination.beat.voice.bar),U&&U.staff===l.staff?F=e+U.x+U.getBeatX(k.tieDestination.beat,oe.MiddleNotes):U=null);let x=y*Ze.GraceScale*.5;g===E.Up&&(x=-x);const j=r.whammyBarPoints.length>0?this._getBendNoteValue(k,r.whammyBarPoints[r.whammyBarPoints.length-1]):0;let Q=0,Te=!1;switch(this.glyphs&&this.glyphs[0].containsNoteValue(j)?(Q=this.glyphs[0].getNoteValueY(j)+x,Te=!0):U&&(k.isTieOrigin&&k.tieDestination.beat.hasWhammyBar||k.beat.isContinuedWhammy)?(Q=s+U.y+U.getNoteY(k.tieDestination,M.Top),Te=!0,g===E.Down&&(Q+=y)):k.isTieOrigin&&(U?Q=s+U.y+U.getNoteY(k.tieDestination,M.Top):Q=N,g===E.Down&&(Q+=y)),r.whammyBarType){case De.Hold:k.isTieOrigin&&zt.paintTie(i,1,u,N,F,Q,p===E.Down,this.renderer.smuflMetrics.tieHeight,this.renderer.smuflMetrics.slurMidpointThickness);break;case De.Dive:if(S===0){const $e=this.glyphs[0];$e.x=F-$e.onTimeX;const ce=this.glyphs[0].y;$e.y=s+l.y,$e.paint(0,0,i),$e.containsNoteValue(j)&&(Q-=ce,Q+=$e.y)}Te?this.drawBendSlur(i,u,N,F,Q,g===E.Down,q):k.isTieOrigin&&zt.paintTie(i,1,u,N,F,Q,p===E.Down,this.renderer.smuflMetrics.tieHeight,this.renderer.smuflMetrics.slurMidpointThickness);break;case De.Dip:if(a===Xt.SongBook)k.isTieOrigin&&zt.paintTie(i,1,u,N,F,Q,p===E.Down,this.renderer.smuflMetrics.tieHeight,this.renderer.smuflMetrics.slurMidpointThickness);else{const $e=(u+F)/2,ce=this.glyphs[0];ce.x=$e-ce.onTimeX,ce.y=s+l.y,ce.paint(0,0,i);const rt=this._getBendNoteValue(k,r.whammyBarPoints[1]),Es=ce.getNoteValueY(rt)+x;this.drawBendSlur(i,u,N,$e,Es,g===E.Down,q);const _t=this.glyphs[1];_t.x=F-_t.onTimeX,_t.y=s+l.y,_t.paint(0,0,i),Q=_t.getNoteValueY(j)+x,this.drawBendSlur(i,$e,Es,F,Q,g===E.Down,q)}break;case De.PrediveDive:case De.Predive:let te=e+l.x+l.getBeatX(k.beat,oe.PreNotes);te+=this._container.prebendNoteHeadOffset;const we=s+l.y+l.getScoreY(l.accidentalHelper.getNoteStepsForValue(k.displayValue-(k.beat.whammyBarPoints[0].value/2|0),!1))+x;if(this.drawBendSlur(i,te,we,u,N,g===E.Down,q),this.glyphs){const $e=this.glyphs[0];$e.x=F-$e.onTimeX,$e.y=s+l.y,$e.paint(0,0,i),this.drawBendSlur(i,u,N,F,Q,g===E.Down,q)}break}}finally{(c=T==null?void 0:T[Symbol.dispose])==null||c.call(T)}}i.textAlign=m}finally{(d=h==null?void 0:h[Symbol.dispose])==null||d.call(h)}}_getBendNoteValue(e,s){return e.displayValueWithoutBend+(s.value/2|0)}}class ia extends nn{constructor(e,s,i){super(e,s,i.graceType!==ee.None,ia.getSymbol(i.duration));o(this,"beatEffects",new Map);o(this,"noteHeadElement",ns.SlashNoteHead);o(this,"effectElement",ht.SlashEffects);o(this,"stemX",0);this.beat=i}paint(e,s,i){var a;const r=this.beat.notes.length===0?void 0:ve.note(i,this.noteHeadElement,this.beat.notes[0]);try{super.paint(e,s,i),this._paintEffects(e,s,i)}finally{(a=r==null?void 0:r[Symbol.dispose])==null||a.call(r)}}_paintEffects(e,s,i){var a;const r=ve.beat(i,this.effectElement,this.beat);try{for(const l of this.beatEffects.values())l.paint(e+this.x,s+this.y,i)}finally{(a=r==null?void 0:r[Symbol.dispose])==null||a.call(r)}}doLayout(){super.doLayout();const e=this.renderer,s=e.smuflMetrics.onNoteEffectPadding;let i=e.smuflMetrics.glyphHeights.get(this.symbol),r=Number.NaN,a=Number.NaN;for(const c of this.beatEffects.values())c.y+=i,c.x+=this.width/2,c.renderer=e,i+=c.height+s,c.doLayout(),(Number.isNaN(r)||r>i)&&(r=i),(Number.isNaN(a)||a<i)&&(a=i);Number.isNaN(r)||e.registerBeatEffectOverflows(r,a);const l=e.getBeatDirection(this.beat),h=this.symbol;if(l===E.Up){const c=e.smuflMetrics.stemUp.has(h)?e.smuflMetrics.stemUp.get(h).x:0;this.stemX=c}else{const c=e.smuflMetrics.stemDown.has(h)?e.smuflMetrics.stemDown.get(h).x:0;this.stemX=c}}static getSymbol(e){switch(e){case b.QuadrupleWhole:case b.DoubleWhole:case b.Whole:return f.NoteheadSlashWhiteWhole;case b.Half:return f.NoteheadSlashWhiteHalf;default:return f.NoteheadSlashHorizontalEnds}}}class jf extends Cs{constructor(){super(...arguments);o(this,"_strings",new Set)}addString(e){this._strings.add(e)}doLayout(){const e=this.renderer.smuflMetrics.glyphWidths.get(f.GuitarString0)*this.renderer.smuflMetrics.tuningGlyphCircleNumberScale;this.height=(e+this.renderer.smuflMetrics.stringNumberCirclePadding)*this._strings.size,this.width=e}paint(e,s,i){const r=this.renderer.bar.staff.tuning.length;let a=0;const l=this.renderer.smuflMetrics.glyphWidths.get(f.GuitarString0)*this.renderer.smuflMetrics.tuningGlyphCircleNumberScale;for(const h of this._strings){const c=r-h,d=f.GuitarString1+c;kt.fillMusicFontSymbolSafe(i,e+this.x,s+this.y+l+a,this.renderer.smuflMetrics.tuningGlyphCircleNumberScale,d,!0),a+=l+this.renderer.smuflMetrics.stringNumberCirclePadding}}}class ep extends No{constructor(){super(...arguments);o(this,"_collisionOffset",Number.NaN);o(this,"_skipPaint",!1);o(this,"_whammy");o(this,"noteHeads",null);o(this,"restGlyph",null)}get effectElement(){return ht.StandardNotationEffects}buildBoundingsLookup(e,s,i){this.noteHeads&&this.noteHeads.buildBoundingsLookup(e,s+this.x,i+this.y)}getBoundingBoxTop(){var s;let e=this.y;return this.noteHeads?e=this.noteHeads.getBoundingBoxTop():this.restGlyph&&(e=this.restGlyph.getBoundingBoxTop()),(s=this._whammy)!=null&&s.hasBoundingBox&&(e=Math.min(e,this._whammy.getBoundingBoxTop())),e}getBoundingBoxBottom(){var s;let e=this.y+this.height;return this.noteHeads?e=this.noteHeads.getBoundingBoxBottom():this.restGlyph&&(e=this.restGlyph.getBoundingBoxBottom()),(s=this._whammy)!=null&&s.hasBoundingBox&&(e=Math.max(e,this._whammy.getBoundingBoxBottom())),e}getLowestNoteY(e){return this.noteHeads?this.noteHeads.getLowestNoteY(e):0}getHighestNoteY(e){return this.noteHeads?this.noteHeads.getHighestNoteY(e):0}getNoteY(e,s){return e.beat.slashed&&(e=e.beat.notes[0]),this.noteHeads?this.noteHeads.getNoteY(e,s):0}getNoteX(e,s){return e.beat.slashed&&(e=e.beat.notes[0]),this.noteHeads?this.noteHeads.getNoteX(e,s):0}getRestY(e){const s=this.restGlyph;if(s)switch(e){case M.TopWithStem:return s.getBoundingBoxTop()-this.renderer.smuflMetrics.getStemLength(b.Quarter,!0);case M.Top:return s.getBoundingBoxTop();case M.Center:case M.StemUp:case M.StemDown:return s.getBoundingBoxTop()+s.height/2;case M.Bottom:return s.getBoundingBoxBottom();case M.BottomWithStem:return s.getBoundingBoxBottom()+this.renderer.smuflMetrics.getStemLength(b.Quarter,!0)}return 0}applyRestCollisionOffset(){if(this.restGlyph&&Number.isNaN(this._collisionOffset)){this._collisionOffset=this.renderer.collisionHelper.applyRestCollisionOffset(this.container.beat,this.restGlyph.y,this.renderer.getScoreHeight(1)),this.y+=this._collisionOffset;const e=this.renderer.collisionHelper.restDurationsByDisplayTime;e.has(this.container.beat.playbackStart)&&e.get(this.container.beat.playbackStart).has(this.container.beat.playbackDuration)&&e.get(this.container.beat.playbackStart).get(this.container.beat.playbackDuration)!==this.container.beat.id&&(this._skipPaint=!0)}}paint(e,s,i){this._skipPaint||super.paint(e,s,i)}doMultiVoiceLayout(){var s,i;this.applyRestCollisionOffset(),(s=this.noteHeads)==null||s.doMultiVoiceLayout(),(i=this._whammy)==null||i.doMultiVoiceLayout();let e=0;if(this.glyphs)for(const r of this.glyphs)r.x=e,e+=r.width;this.width=e,this.computedWidth=e,this._updatePositions()}doLayout(){this._createGlyphs(),super.doLayout(),this._updatePositions()}_updatePositions(){this.container.beat.isEmpty?(this.onTimeX=this.width/2,this.middleX=this.onTimeX,this.stemX=this.middleX):this.restGlyph?(this.onTimeX=this.restGlyph.x+this.restGlyph.width/2,this.middleX=this.onTimeX,this.stemX=this.middleX):this.noteHeads&&(this.onTimeX=this.noteHeads.x+this.noteHeads.onTimeX,this.middleX=this.noteHeads.x+this.noteHeads.width/2,this.stemX=this.noteHeads.x+this.noteHeads.stemX)}_createGlyphs(){this.container.beat.isEmpty||(this.container.beat.isRest?this._createRestGlyphs():this._createNoteGlyphs())}_createNoteGlyphs(){const e=this.renderer,s=new Kf;this.noteHeads=s,s.beat=this.container.beat;const i=new io(!1);if(i.renderer=this.renderer,this.container.beat.slashed){const r=e.heightLineCount-1,a=new ia(0,e.getScoreY(r),this.container.beat);a.colorOverride=ve.noteColor(e.resources,ns.StandardNotationNoteHead,this.container.beat.notes[0]),this.noteHeads.addMainNoteGlyph(a,this.container.beat.notes[0],r)}else for(const r of this.container.beat.notes)r.isVisible&&(this._createNoteGlyph(r),i.addParenthesis(r));if(this.addNormal(s),i.isEmpty||this.addEffect(i),this.container.beat.hasWhammyBar){const r=new Zf(this.container);this._whammy=r,r.renderer=this.renderer,r.doLayout(),this.container.addTie(r)}if(this.container.beat.dots>0)for(let r=0;r<this.container.beat.dots;r++){const a=new mi(0,0);a.renderer=this.renderer;for(const l of this.container.beat.notes){const h=this._createBeatDot(e.getNoteSteps(l),a);h.colorOverride=ve.noteColor(e.resources,ns.StandardNotationEffects,l)}this.addEffect(a)}if(this.renderer.bar.isMultiVoice){let r=0,a=0;const l=e.getBeatDirection(this.container.beat);let h=0;this.container.beat.hasTuplet&&(h+=e.tupletOffset+e.tupletSize),l===E.Up?(r=this.getHighestNoteY(M.TopWithStem)-h,a=this.getLowestNoteY(M.Bottom)):(r=this.getHighestNoteY(M.Top),a=this.getLowestNoteY(M.BottomWithStem)+h),this.renderer.collisionHelper.reserveBeatSlot(this.container.beat,r,a)}}_createRestGlyphs(){const e=this.renderer;let s=Math.ceil((this.renderer.bar.staff.standardNotationLineCount-1)/2)*2;this.container.beat.duration===b.Whole&&this.renderer.bar.staff.standardNotationLineCount!==1&&this.renderer.bar.staff.standardNotationLineCount!==3&&(s-=2);const i=new on(0,e.getScoreY(s),this.container.beat.duration);if(this.restGlyph=i,i.beat=this.container.beat,this.addNormal(i),this.renderer.bar.isMultiVoice)if(this.container.beat.voice.index===0){const r=Ms.computeLineHeightsForRest(this.container.beat.duration),a=i.y-e.getScoreHeight(r[0]),l=i.y+e.getScoreHeight(r[1]);this.renderer.collisionHelper.reserveBeatSlot(this.container.beat,a,l)}else this.renderer.collisionHelper.registerRest(this.container.beat);if(this.container.beat.dots>0)for(let r=0;r<this.container.beat.dots;r++){const a=new mi(0,0);a.renderer=this.renderer,this._createBeatDot(s,a),this.addEffect(a)}}_createBeatDot(e,s){const i=this.renderer,r=new qa(0,i.getScoreY(e));return s.addGlyph(r),r}_createNoteHeadGlyph(e){const s=this.container.beat.graceType!==ee.None,i=e.style;if((i==null?void 0:i.noteHead)!==void 0){const r=new Qr(0,0,e.beat.duration,s);return r.symbol=i.noteHead,i.noteHeadCenterOnStem&&(r.centerOnStem=!0),r}if(e.beat.voice.bar.staff.isPercussion){const r=jt.getArticulation(e);if(r)return new qf(0,0,r,e.beat.duration,s);L.warning("Rendering",`No articulation found for percussion instrument ${e.percussionArticulation}`)}return e.isDead?new Jf(0,0,s):e.beat.graceType===ee.BendGrace?new Qr(0,0,b.Quarter,!0):e.harmonicType===ie.Natural?new so(0,0,e.beat.duration,s):new Qr(0,0,e.beat.duration,s)}_createNoteGlyph(e){if(e.beat.graceType===ee.BendGrace&&!e.hasBend)return;const s=this.renderer,i=this._createNoteHeadGlyph(e);i.colorOverride=ve.noteColor(s.resources,ns.StandardNotationNoteHead,e);let r=s.getNoteSteps(e);if(i.y=s.getScoreY(r),this.noteHeads.addMainNoteGlyph(i,e,r),!e.beat.slashed&&e.harmonicType!==ie.None&&e.harmonicType!==ie.Natural){const c=e.displayValue+e.harmonicPitch,d=new so(0,0,e.beat.duration,this.container.beat.graceType!==ee.None);d.colorOverride=i.colorOverride,r=s.accidentalHelper.getNoteStepsForValue(c,!1),d.y=s.getScoreY(r),this.noteHeads.addEffectNoteGlyph(d,r)}const a=this.noteHeads.belowBeatEffects,l=this.noteHeads.aboveBeatEffects,h=s.getBeatDirection(this.container.beat)===E.Up?this.noteHeads.belowBeatEffects:this.noteHeads.aboveBeatEffects;if(e.isStaccato&&!a.has("Staccato")&&h.set("Staccato",new hc(0,0)),e.accentuated===mt.Normal&&!a.has("Accent")&&h.set("Accent",new Pa(0,0,e)),e.accentuated===mt.Heavy&&!a.has("HAccent")&&h.set("HAccent",new Pa(0,0,e)),e.accentuated===mt.Tenuto&&!a.has("Tenuto")&&h.set("Tenuto",new Pa(0,0,e)),e.showStringNumber&&e.isStringed){let c;l.has("StringNumber")?c=l.get("StringNumber"):(c=new jf(0,0),l.set("StringNumber",c)),c.addString(e.string)}if(e.isPercussion){const c=jt.getArticulation(e);if(c&&c.techniqueSymbolPlacement!==Je.Inside){let d;switch(c.techniqueSymbolPlacement){case Je.Above:d=this.noteHeads.aboveBeatEffects;break;case Je.Below:d=this.noteHeads.belowBeatEffects;break;case Je.Outside:d=h;break;default:return}switch(c.techniqueSymbol){case f.PictEdgeOfCymbal:d.set("PictEdgeOfCymbal",new Qf(0,0));break;case f.ArticStaccatoAbove:d.set("ArticStaccatoAbove",new hc(0,0));break;case f.StringsUpBow:d.set("StringsUpBow",new $a(0,0,Ot.Up));break;case f.StringsDownBow:d.set("StringsDownBow",new $a(0,0,Ot.Down));break;case f.GuitarGolpe:d.set("GuitarGolpe",new Fc(0,0,!0));break}}}}}class tp extends It{constructor(e){super(0,0);o(this,"_beat");o(this,"_noteVibratoGlyph");this._beat=e}doLayout(){if(this._beat.brushType===Y.ArpeggioUp||this._beat.brushType===Y.ArpeggioDown){const e=new ur(0,0,Ee.Slight,!0);e.renderer=this.renderer,e.doLayout(),this._noteVibratoGlyph=e,this.width=e.height}else this.width=0}paint(e,s,i){if(this._beat.brushType===Y.ArpeggioUp||this._beat.brushType===Y.ArpeggioDown){const r=this.renderer,a=r.lineOffset,l=s+this.y+(r.getNoteY(this._beat.maxNote,M.Bottom)-a),h=s+this.y+r.getNoteY(this._beat.minNote,M.Top)+a,c=e+this.x+this.width/2,d=this.renderer.smuflMetrics.glyphWidths.get(f.ArrowheadBlackDown),u=this._noteVibratoGlyph;if(this._beat.brushType===Y.ArpeggioUp){const p=l+d,g=h-d;u.width=Math.abs(g-p),i.beginRotate(e+this.x,g,-90),u.paint(0,0,i),i.endRotate(),i.beginPath(),i.moveTo(c,h),i.lineTo(c+d/2,h-d),i.lineTo(c-d/2,h-d),i.closePath(),i.fill()}else if(this._beat.brushType===Y.ArpeggioDown){const p=l+d,g=h;u.width=Math.abs(g-p),i.beginRotate(e+this.x,p,90),u.paint(0,-u.height,i),i.endRotate(),i.beginPath(),i.moveTo(c,l),i.lineTo(c+d/2,l+d),i.lineTo(c-d/2,l+d),i.closePath(),i.fill()}}}}class sp extends rn{constructor(){super(...arguments);o(this,"_prebends",null);o(this,"accidentals",null)}get prebendNoteHeadOffset(){return this._prebends?this._prebends.x+this._prebends.onTimeX:0}get effectElement(){return ht.StandardNotationEffects}doMultiVoiceLayout(){var e;(e=this._prebends)==null||e.doMultiVoiceLayout()}doLayout(){this.container.beat.isRest||this._createGlyphs(),super.doLayout()}_createGlyphs(){const e=new Bh;e.renderer=this.renderer;const s=new Xa;s.renderer=this.renderer;const i=new io(!0);i.renderer=this.renderer;let r=null,a=!1;for(const l of this.container.beat.notes){const h=ve.noteColor(this.renderer.resources,ns.StandardNotationEffects,l);if(l.isVisible){if(l.hasBend)switch(l.bendType){case J.PrebendBend:case J.Prebend:case J.PrebendRelease:r||(r=new Gi("prebend",this.container.beat,!0),r.renderer=this.renderer),r.addGlyph(l.displayValue-(l.bendPoints[0].value/2|0),!1,h);break}else if(l.beat.hasWhammyBar)switch(l.beat.whammyBarType){case De.PrediveDive:case De.Predive:r||(r=new Gi("prebend",this.container.beat,!0),r.renderer=this.renderer),r.addGlyph(l.displayValue-(l.beat.whammyBarPoints[0].value/2|0),!1,h);break}switch(this._createAccidentalGlyph(l,e),i.addParenthesis(l),s.addFingers(l),l.slideInType){case Et.IntoFromBelow:case Et.IntoFromAbove:a=!0;break}}}a&&this.addNormal(new ys(0,0,this.renderer.smuflMetrics.simpleSlideWidth*(this.container.beat.graceType!==ee.None?Ze.GraceScale:1))),this._prebends=r,r&&(this.addEffect(r),this.addNormal(new ys(0,0,this.renderer.smuflMetrics.preNoteEffectPadding*(this.container.beat.graceType!==ee.None?Ze.GraceScale:1)))),this.container.beat.brushType!==Y.None&&(this.addEffect(new tp(this.container.beat)),this.addNormal(new ys(0,0,this.renderer.smuflMetrics.preNoteEffectPadding*(this.container.beat.graceType!==ee.None?Ze.GraceScale:1)))),s.isEmpty||(this.isEmpty||this.addNormal(new ys(0,0,this.renderer.smuflMetrics.preNoteEffectPadding*(this.container.beat.graceType!==ee.None?Ze.GraceScale:1))),this.addEffect(s),this.addNormal(new ys(0,0,this.renderer.smuflMetrics.preNoteEffectPadding*(this.container.beat.graceType!==ee.None?Ze.GraceScale:1)))),i.isEmpty||this.addEffect(i),e.isEmpty||(this.accidentals=e,this.isEmpty||this.addNormal(new ys(0,0,this.renderer.smuflMetrics.preNoteEffectPadding*(this.container.beat.graceType!==ee.None?Ze.GraceScale:1))),this.addNormal(e),this.addNormal(new ys(0,0,this.renderer.smuflMetrics.preNoteEffectPadding*(this.container.beat.graceType!==ee.None?Ze.GraceScale:1))))}_createAccidentalGlyph(e,s){const i=this.renderer;let r=i.accidentalHelper.applyAccidental(e),a=i.getNoteSteps(e);const l=this.container.beat.graceType!==ee.None,h=ve.noteColor(i.resources,ns.StandardNotationAccidentals,e),c=l?Ze.GraceScale:1;if(r!==he.None){const d=new Ci(0,i.getScoreY(a),r,c);d.colorOverride=h,d.renderer=this.renderer,s.addGlyph(d)}if(e.harmonicType!==ie.None&&e.harmonicType!==ie.Natural){const d=e.displayValue+e.harmonicPitch;r=i.accidentalHelper.applyAccidentalForValue(e.beat,d,l,!1),a=i.accidentalHelper.getNoteStepsForValue(d,!1);const u=new Ci(0,i.getScoreY(a),r,c);u.colorOverride=h,u.renderer=this.renderer,s.addGlyph(u)}}}class ip extends zc{constructor(e){super(0,0);o(this,"_beat");o(this,"_notes",[]);o(this,"_endNoteGlyph",null);o(this,"_middleNoteGlyph",null);o(this,"_container");o(this,"checkForOverflow",!1);this._beat=e.beat,this._container=e}doLayout(){super.doLayout(),this.width=0}getBoundingBoxTop(){return super.getBoundingBoxTop()-this._calculateMaxSlurHeight(E.Up)}getBoundingBoxBottom(){return super.getBoundingBoxBottom()+this._calculateMaxSlurHeight(E.Down)}doMultiVoiceLayout(){var e,s;(e=this._middleNoteGlyph)==null||e.doMultiVoiceLayout(),(s=this._endNoteGlyph)==null||s.doMultiVoiceLayout()}_calculateMaxSlurHeight(e){const s=this.getTieDirection(this._beat,this.renderer);if(s!==e)return 0;let i=0;for(const r of this._notes){if(r.isTieOrigin)continue;switch(r.bendType){case J.Custom:case J.Prebend:case J.Hold:continue}const l=this.renderer.getBeatContainer(this._beat).width*2;let h=0,c=0;switch(r.bendType){case J.Bend:case J.PrebendBend:h=this._endNoteGlyph.minStepsNote.glyph.getBoundingBoxTop(),c=l;break;case J.BendRelease:h=this._middleNoteGlyph.minStepsNote.glyph.getBoundingBoxTop(),c=l/2;break;case J.Release:case J.PrebendRelease:h=this._endNoteGlyph.maxStepsNote.glyph.getBoundingBoxTop(),c=l;break}const d=this.renderer.getNoteY(r,M.Top);let u=Math.abs(zt.calculateBendSlurTopY(0,d,c,h,s===E.Down,1,this.renderer.smuflMetrics.tieHeight)-h);if(r.bendStyle===tt.Gradual){const p=this.renderer.resources,g=this.renderer.scoreRenderer.canvas;g.font=p.elementFonts.get(v.ScoreBendSlur),u+=g.measureText("grad.").height}u>i&&(i=u)}return i}addBends(e){if(this._notes.push(e),e.isTieOrigin)return;const s=ve.noteColor(this.renderer.resources,ns.StandardNotationEffects,e);switch(e.bendType){case J.Bend:case J.PrebendRelease:case J.PrebendBend:{let i=this._endNoteGlyph;i||(i=new Gi("postbend",e.beat,!1),i.renderer=this.renderer,this._endNoteGlyph=i,this.addGlyph(i));const r=e.bendPoints[e.bendPoints.length-1];i.addGlyph(this._getBendNoteValue(e,r),r.value%2!==0,s)}break;case J.Release:if(!e.isTieOrigin){let i=this._endNoteGlyph;i||(i=new Gi("postbend",e.beat,!1),i.renderer=this.renderer,this._endNoteGlyph=i,this.addGlyph(i));const r=e.bendPoints[e.bendPoints.length-1];i.addGlyph(this._getBendNoteValue(e,r),r.value%2!==0,s)}break;case J.BendRelease:{let i=this._middleNoteGlyph;i||(i=new Gi("middlebend",e.beat,!1),this._middleNoteGlyph=i,i.renderer=this.renderer,this.addGlyph(i));const r=e.bendPoints[1];i.addGlyph(this._getBendNoteValue(e,e.bendPoints[1]),r.value%2!==0,s);let a=this._endNoteGlyph;a||(a=new Gi("postbend",e.beat,!1),a.renderer=this.renderer,this._endNoteGlyph=a,this.addGlyph(a));const l=e.bendPoints[e.bendPoints.length-1];a.addGlyph(this._getBendNoteValue(e,l),l.value%2!==0,s)}break}}paint(e,s,i){const r=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,this._beat.voice.bar),a=e+r.x+r.getBeatX(this._beat,oe.MiddleNotes);let l=e+r.x;if(this._beat.isLastOfVoice?l+=r.getBeatX(this._beat,oe.EndBeat):l+=r.getBeatX(this._beat.nextBeat,oe.PreNotes),l-=this.renderer.smuflMetrics.postNoteEffectPadding,this._endNoteGlyph){const c=this._endNoteGlyph.width-this._endNoteGlyph.onTimeX;l-=c}const h=(a+l)/2;this._middleNoteGlyph&&(this._middleNoteGlyph.x=h-this._middleNoteGlyph.onTimeX,this._middleNoteGlyph.y=s+r.y,this._middleNoteGlyph.paint(0,0,i)),this._endNoteGlyph&&(this._endNoteGlyph.x=l-this._endNoteGlyph.onTimeX,this._endNoteGlyph.y=s+r.y,this._endNoteGlyph.paint(0,0,i)),this._notes.sort((c,d)=>d.displayValue-c.displayValue),this.renderer.settings.notation.isNotationElementVisible(v.ScoreBendSlur)&&this._paintSlurs(e,s,i,r,a,h,l)}_paintSlurs(e,s,i,r,a,l,h){var p;const c=this._beat.graceType===ee.BendGrace?this._beat.nextBeat:this._beat;let d=this._notes.length===1?this.getTieDirection(c,r):E.Up;const u=this.renderer.smuflMetrics.glyphHeights.get(f.NoteheadBlack);i.font=this.renderer.resources.elementFonts.get(v.ScoreBendSlur);for(let g=0;g<this._notes.length;g++){const m=this._notes[g],y=ve.note(i,ns.StandardNotationEffects,m);try{g>0&&g>=(this._notes.length/2|0)&&(d=E.Down);let S=s+r.y+r.getNoteY(m,M.Top),k=u*Ze.GraceScale*.5;d===E.Down&&(S+=u);const T=m.bendStyle===tt.Gradual?"grad.":"";if(m.isTieOrigin){const N=m.tieDestination,F=N?this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,N.beat.voice.bar):null;if(!F||F.staff!==r.staff){const q=e+r.x+r.width,U=m.tieDestination.displayValue;r.accidentalHelper.applyAccidentalForValue(m.beat,U,!1,!0);const x=s+r.y+r.getScoreY(r.accidentalHelper.getNoteStepsForValue(U,!1));m.bendType===J.Hold||m.bendType===J.Prebend?zt.paintTie(i,1,a,S,q,x,d===E.Down,this.renderer.smuflMetrics.tieHeight,this.renderer.smuflMetrics.slurMidpointThickness):this.drawBendSlur(i,a,S,q,x,d===E.Down,T)}else{const q=e+F.x+F.getBeatX(N.beat,oe.MiddleNotes);let U=s+F.y+F.getNoteY(N,M.Top);d===E.Down&&(U+=u),m.bendType===J.Hold||m.bendType===J.Prebend?zt.paintTie(i,1,a,S,q,U,d===E.Down,this.renderer.smuflMetrics.tieHeight,this.renderer.smuflMetrics.slurMidpointThickness):this.drawBendSlur(i,a,S,q,U,d===E.Down,T)}switch(m.bendType){case J.Prebend:case J.PrebendBend:case J.PrebendRelease:let q=e+r.x+r.getBeatX(m.beat,oe.PreNotes);q+=this._container.prebendNoteHeadOffset;const U=s+r.y+r.getScoreY(r.accidentalHelper.getNoteStepsForValue(m.displayValue-(m.bendPoints[0].value/2|0),!1))+k;this.drawBendSlur(i,q,U,a,S,d===E.Down);break}}else{d===E.Up&&(k=-k);let N=0,F=0;switch(m.bendType){case J.Bend:N=this._getBendNoteValue(m,m.bendPoints[m.bendPoints.length-1]),F=this._endNoteGlyph.getNoteValueY(N)+k,this.drawBendSlur(i,a,S,h,F,d===E.Down,T);break;case J.BendRelease:const q=this._getBendNoteValue(m,m.bendPoints[1]),U=this._middleNoteGlyph.getNoteValueY(q)+k;this.drawBendSlur(i,a,S,l,U,d===E.Down,T),N=this._getBendNoteValue(m,m.bendPoints[m.bendPoints.length-1]),F=this._endNoteGlyph.getNoteValueY(N)+k,this.drawBendSlur(i,l,U,h,F,d===E.Down,T);break;case J.Release:this.glyphs&&(N=this._getBendNoteValue(m,m.bendPoints[m.bendPoints.length-1]),F=this.glyphs[0].getNoteValueY(N)+k,this.drawBendSlur(i,a,S,h,F,d===E.Down,T));break;case J.Prebend:case J.PrebendBend:case J.PrebendRelease:let x=e+r.x+r.getBeatX(m.beat,oe.PreNotes);x+=this._container.prebendNoteHeadOffset;const j=s+r.y+r.getScoreY(r.accidentalHelper.getNoteStepsForValue(m.displayValue-(m.bendPoints[0].value/2|0),!1))+k;this.drawBendSlur(i,x,j,a,S,d===E.Down),this.glyphs&&(N=this._getBendNoteValue(m,m.bendPoints[m.bendPoints.length-1]),F=this.glyphs[0].getNoteValueY(N)+k,this.drawBendSlur(i,a,S,h,F,d===E.Down,T));break}}}finally{(p=y==null?void 0:y[Symbol.dispose])==null||p.call(y)}}}_getBendNoteValue(e,s){return e.displayValueWithoutBend+(s.value/2|0)}}class dc extends zt{constructor(e,s,i,r){super(e,r);o(this,"startBeat");o(this,"endBeat");o(this,"startBeatRenderer",null);o(this,"endBeatRenderer",null);this.startBeat=s,this.endBeat=i}doLayout(){super.doLayout()}lookupStartBeatRenderer(){return this.startBeatRenderer||(this.startBeatRenderer=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,this.startBeat.voice.bar)),this.startBeatRenderer}lookupEndBeatRenderer(){return this.endBeatRenderer||(this.endBeatRenderer=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,this.endBeat.voice.bar)),this.endBeatRenderer}shouldDrawBendSlur(){return!1}calculateTieDirection(){if(this.startBeat.isRest)return E.Up;switch(this.lookupStartBeatRenderer().getBeatDirection(this.startBeat)){case E.Up:return E.Down;default:return E.Up}}calculateStartX(){const e=this.lookupStartBeatRenderer();return e.x+e.getBeatX(this.startBeat,oe.MiddleNotes)}calculateStartY(){const e=this.lookupStartBeatRenderer();if(this.startBeat.isRest)switch(this.tieDirection){case E.Up:return e.y+e.getRestY(this.startBeat,M.Top);default:return e.y+e.getRestY(this.startBeat,M.Bottom)}switch(this.tieDirection){case E.Up:return e.y+e.getNoteY(this.startBeat.maxNote,M.Top);default:return e.y+e.getNoteY(this.startBeat.minNote,M.Bottom)}}calculateEndX(){const e=this.lookupEndBeatRenderer();if(!e)return this.calculateStartX()+this.renderer.smuflMetrics.leftHandTabTieWidth;const s=e.getBeatDirection(this.endBeat);return e.x+e.getBeatX(this.endBeat,this.endBeat.duration>b.Whole&&s===this.tieDirection?oe.Stem:oe.MiddleNotes)}caclculateEndY(){const e=this.lookupEndBeatRenderer();if(!e)return this.calculateStartY();if(this.endBeat.isRest)switch(this.tieDirection){case E.Up:return e.y+e.getRestY(this.endBeat,M.Top);default:return e.y+e.getRestY(this.endBeat,M.Bottom)}const s=this.lookupStartBeatRenderer().getBeatDirection(this.startBeat),i=e.getBeatDirection(this.endBeat);if(s!==i&&this.startBeat.graceType===ee.None){if(i===this.tieDirection)switch(this.tieDirection){case E.Up:return e.y+e.getNoteY(this.endBeat.maxNote,M.TopWithStem);default:return e.y+e.getNoteY(this.endBeat.minNote,M.BottomWithStem)}switch(this.tieDirection){case E.Up:return e.y+e.getNoteY(this.endBeat.maxNote,M.BottomWithStem);default:return e.y+e.getNoteY(this.endBeat.minNote,M.TopWithStem)}}switch(this.tieDirection){case E.Up:return e.y+e.getNoteY(this.endBeat.maxNote,M.Top);default:return e.y+e.getNoteY(this.endBeat.minNote,M.Bottom)}}}class rp extends It{constructor(e,s,i,r){super(0,0);o(this,"_outType");o(this,"_inType");o(this,"_startNote");o(this,"_parent");o(this,"checkForOverflow",!1);this._outType=s,this._inType=e,this._startNote=i,this._parent=r}doLayout(){this.width=0}paint(e,s,i){this._paintSlideIn(e,s,i),this._drawSlideOut(e,s,i)}_paintSlideIn(e,s,i){const r=this.renderer,a=r.smuflMetrics.simpleSlideWidth;let l=e+r.x+r.getNoteX(this._startNote,je.Left)-r.smuflMetrics.preNoteEffectPadding;const h=s+r.y+r.getNoteY(this._startNote,M.Center);let c=l-a,d=s+r.y;switch(this._inType){case Et.IntoFromBelow:d+=r.getNoteY(this._startNote,M.Bottom);break;case Et.IntoFromAbove:d+=r.getNoteY(this._startNote,M.Top);break;default:return}const u=this._getAccidentalsWidth(r,this._startNote.beat);c-=u,l-=u,this._paintSlideLine(i,!1,c,l,d,h)}_getAccidentalsWidth(e,s){return e.getBeatContainer(s).accidentalsWidth}_drawSlideOut(e,s,i){const r=this.renderer,a=r.smuflMetrics.simpleSlideWidth,l=r.smuflMetrics.postNoteEffectPadding;let h=0,c=0,d=0,u=0,p=!1;switch(this._outType){case ge.Shift:case ge.Legato:if(h=e+r.x+r.getBeatX(this._startNote.beat,oe.PostNotes)+l,c=s+r.y+r.getNoteY(this._startNote,M.Center),this._startNote.slideTarget){const g=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,this._startNote.slideTarget.beat.voice.bar);!g||g.staff!==r.staff?(d=e+r.x+r.width,this._startNote.slideTarget.realValue>this._startNote.realValue?u=s+r.y+r.getNoteY(this._startNote,M.Top):u=s+r.y+r.getNoteY(this._startNote,M.Bottom)):(d=e+g.x+g.getBeatX(this._startNote.slideTarget.beat,oe.PreNotes)-l,u=s+g.y+g.getNoteY(this._startNote.slideTarget,M.Center))}else d=e+r.x+this._parent.x,u=c;break;case ge.OutUp:h=e+r.x+r.getNoteX(this._startNote,je.Right)+l,c=s+r.y+r.getNoteY(this._startNote,M.Center),d=h+a,u=s+r.y+r.getNoteY(this._startNote,M.Top);break;case ge.OutDown:h=e+r.x+r.getNoteX(this._startNote,je.Right)+l,c=s+r.y+r.getNoteY(this._startNote,M.Center),d=h+a,u=s+r.y+r.getNoteY(this._startNote,M.Bottom);break;case ge.PickSlideUp:h=e+r.x+r.getNoteX(this._startNote,je.Right)+l*2,c=s+r.y+r.getNoteY(this._startNote,M.Center),u=s+r.y+r.getNoteY(this._startNote,M.Top),d=e+r.x+r.width,this._startNote.beat.nextBeat&&this._startNote.beat.nextBeat.voice===this._startNote.beat.voice&&(d=e+r.x+r.getBeatX(this._startNote.beat.nextBeat,oe.PreNotes)),p=!0;break;case ge.PickSlideDown:h=e+r.x+r.getNoteX(this._startNote,je.Right)+l*2,c=s+r.y+r.getNoteY(this._startNote,M.Center),u=s+r.y+r.getNoteY(this._startNote,M.Bottom),d=e+r.x+r.width,this._startNote.beat.nextBeat&&this._startNote.beat.nextBeat.voice===this._startNote.beat.voice&&(d=e+r.x+r.getBeatX(this._startNote.beat.nextBeat,oe.PreNotes)),p=!0;break;default:return}this._paintSlideLine(i,p,h,d,c,u)}_paintSlideLine(e,s,i,r,a,l){if(s){const h=new ur(0,0,Ee.Slight);h.renderer=this.renderer,h.doLayout(),a-=h.height/2,l-=h.height/2;const c=r-i,d=l-a,u=Math.sqrt(Math.pow(d,2)+Math.pow(c,2));h.width=c;const p=Math.asin(d/u)*(180/Math.PI);e.beginRotate(i,a,p),h.paint(0,0,e),e.endRotate()}else e.beginPath(),e.moveTo(i,a),e.lineTo(r,l),e.stroke()}}class vl extends Bo{shouldDrawBendSlur(){return this.renderer.settings.notation.extendBendArrowsOnTiedNotes&&!!this.startNote.bendOrigin&&this.startNote.isTieOrigin}calculateStartX(){return this.isLeftHandTap?this.calculateEndX()-this.renderer.smuflMetrics.leftHandTabTieWidth:this.renderer.x+this.renderer.getBeatX(this.startNote.beat,oe.PostNotes)}calculateEndX(){const t=this.lookupEndBeatRenderer();return t?this.isLeftHandTap?t.x+t.getNoteX(this.endNote,je.Left):t.x+t.getBeatX(this.endNote.beat,oe.PreNotes):this.calculateStartX()+this.renderer.smuflMetrics.leftHandTabTieWidth}}class cn extends vl{getTieHeight(t,e,s,i){return Math.log2(s-t+1)*this.renderer.settings.notation.slurHeight/2}calculateStartX(){return this.renderer.x+(this._isStartCentered()?this.renderer.getBeatX(this.startNote.beat,oe.MiddleNotes):this.renderer.getNoteX(this.startNote,je.Right))}calculateStartY(){if(this._isStartCentered())switch(this.tieDirection){case E.Up:return this.renderer.y+this.renderer.getNoteY(this.startNote,M.Top);default:return this.renderer.y+this.renderer.getNoteY(this.startNote,M.Bottom)}return this.renderer.y+this.renderer.getNoteY(this.startNote,M.Center)}calculateEndX(){const t=this.lookupEndBeatRenderer();return t?this._isEndCentered()?this._isEndOnStem()?t.x+t.getBeatX(this.endNote.beat,oe.Stem):t.x+t.getNoteX(this.endNote,je.Center):t.x+t.getBeatX(this.endNote.beat,oe.PreNotes):this.calculateStartX()+this.renderer.smuflMetrics.leftHandTabTieWidth}caclculateEndY(){const t=this.lookupEndBeatRenderer();if(!t)return this.calculateStartY();if(this._isEndCentered()){if(this._isEndOnStem())switch(this.tieDirection){case E.Up:return t.y+t.getNoteY(this.endNote,M.TopWithStem);default:return t.y+t.getNoteY(this.endNote,M.BottomWithStem)}switch(this.tieDirection){case E.Up:return t.y+t.getNoteY(this.endNote,M.Top);default:return t.y+t.getNoteY(this.endNote,M.Bottom)}}return t.y+t.getNoteY(this.endNote,M.Center)}_isStartCentered(){return this.startNote===this.startNote.beat.maxNote&&this.tieDirection===E.Up||this.startNote===this.startNote.beat.minNote&&this.tieDirection===E.Down}_isEndCentered(){return this.startNote.beat.graceType===ee.None&&(this.endNote===this.endNote.beat.maxNote&&this.tieDirection===E.Up||this.endNote===this.endNote.beat.minNote&&this.tieDirection===E.Down)}_isEndOnStem(){const t=this.lookupStartBeatRenderer().getBeatDirection(this.startNote.beat),e=this.lookupEndBeatRenderer(),s=e?e.getBeatDirection(this.endNote.beat):t;return t!==s&&this.startNote.beat.graceType===ee.None}}class ap extends Pi{constructor(e){super(e);o(this,"_bend",null);o(this,"_effectSlur",null);o(this,"_effectEndSlur",null);o(this,"_flagStretch",0);this.preNotes=new sp,this.onNotes=new ep}get prebendNoteHeadOffset(){return this.preNotes.prebendNoteHeadOffset}get accidentalsWidth(){const e=this.preNotes;return e&&e.accidentals?e.accidentals.width:0}doMultiVoiceLayout(){var e;this.preNotes.x=0,this.preNotes.doMultiVoiceLayout(),this.onNotes.x=this.preNotes.x+this.preNotes.width,this.onNotes.doMultiVoiceLayout(),(e=this._bend)==null||e.doMultiVoiceLayout()}doLayout(){this._effectSlur=null,this._effectEndSlur=null;const e=this.renderer,s=this.beat,i=s.graceType!==ee.None;if(e.hasFlag(s)){const r=e.getBeatDirection(s),a=i?Ze.GraceScale:1,l=an.getSymbol(s.duration,r,i),h=e.smuflMetrics.glyphWidths.get(l)*a;this._flagStretch=h}else if(i){const r=e.smuflMetrics.glyphWidths.get(f.Flag8thUp)*Ze.GraceScale;this._flagStretch=r}super.doLayout(),this._bend&&(this._bend.renderer=this.renderer,this._bend.doLayout(),this.updateWidth())}getBoundingBoxTop(){return this._bend!==null?A.minBoundingBox(this._bend.getBoundingBoxTop(),super.getBoundingBoxTop()):super.getBoundingBoxTop()}getBoundingBoxBottom(){return this._bend!==null?A.maxBoundingBox(this._bend.getBoundingBoxBottom(),super.getBoundingBoxTop()):super.getBoundingBoxBottom()}createTies(e){if(e.isVisible){if(e.isTieOrigin&&!e.hasBend&&!e.beat.hasWhammyBar&&e.beat.graceType!==ee.BendGrace&&e.tieDestination&&e.tieDestination.isVisible){const s=new vl(`score.tie.${e.id}`,e,e.tieDestination,!1);this.addTie(s)}if(e.isTieDestination&&!e.tieOrigin.hasBend&&!e.beat.hasWhammyBar){const s=new vl(`score.tie.${e.tieOrigin.id}`,e.tieOrigin,e,!0);this.addTie(s)}if(e.slideInType!==Et.None||e.slideOutType!==ge.None){const s=new rp(e.slideInType,e.slideOutType,e,this);this.addTie(s)}if(e.isSlurOrigin&&e.slurDestination&&e.slurDestination.isVisible){const s=new cn(`score.slur.${e.id}`,e,e.slurDestination,!1);this.addTie(s)}if(e.isSlurDestination){const s=new cn(`score.slur.${e.slurOrigin.id}`,e.slurOrigin,e,!0);this.addTie(s)}if(!this._effectSlur&&e.isEffectSlurOrigin&&e.effectSlurDestination){const s=new cn(`score.slur.effect.${e.beat.id}`,e,e.effectSlurDestination,!1);this._effectSlur=s,this.addTie(s)}if(!this._effectEndSlur&&e.beat.isEffectSlurDestination&&e.beat.effectSlurOrigin){const s=this.renderer.getBeatDirection(e.beat),i=s===E.Up?e.beat.effectSlurOrigin.minNote:e.beat.effectSlurOrigin.maxNote,r=s===E.Up?e.beat.minNote:e.beat.maxNote,a=new cn(`score.slur.effect.${i.beat.id}`,i,r,!0);this._effectEndSlur=a,this.addTie(a)}if(e.hasBend){if(!this._bend){const s=new ip(this);this._bend=s,s.renderer=this.renderer,this.addTie(s)}this._bend.addBends(e)}if(this.beat.isLegatoOrigin){if(!this.beat.previousBeat||!this.beat.previousBeat.isLegatoOrigin){let s=this.beat.nextBeat;for(;s.nextBeat&&s.nextBeat.isLegatoDestination;)s=s.nextBeat;this.addTie(new dc(`score.legato.${this.beat.id}`,this.beat,s,!1))}}else if(this.beat.isLegatoDestination&&!this.beat.isLegatoOrigin){let s=this.beat.previousBeat;for(;s.previousBeat&&s.previousBeat.isLegatoOrigin;)s=s.previousBeat;this.addTie(new dc(`score.legato.${s.id}`,s,this.beat,!0))}}}get postBeatStretch(){return super.postBeatStretch+this._flagStretch}updateWidth(){super.updateWidth(),this.width+=this._flagStretch}}const Ii=class Ii extends pi{constructor(e,s){super(e,s);o(this,"accidentalHelper");o(this,"_beamDirections",new Map);this.accidentalHelper=new Er(this)}get repeatsBarSubElement(){return Ae.StandardNotationRepeats}get barNumberBarSubElement(){return Ae.StandardNotationBarNumber}get barLineBarSubElement(){return Ae.StandardNotationBarLines}get staffLineBarSubElement(){return Ae.StandardNotationStaffLine}get lineSpacing(){return this.smuflMetrics.oneStaffSpace}get heightLineCount(){return Math.max(5,this.bar.staff.standardNotationLineCount)}get drawnLineCount(){return this.bar.staff.standardNotationLineCount}getScoreY(e){return super.getLineY(e/2)}getScoreHeight(e){return super.getLineHeight(e/2)}calculateOverflows(e,s){super.calculateOverflows(e,s),!this.bar.isEmpty&&this.calculateBeamingOverflows(e,s)}get flagsSubElement(){return ht.StandardNotationFlags}get beamsSubElement(){return ht.StandardNotationBeams}get tupletSubElement(){return ht.StandardNotationTuplet}getFlagTopY(e,s){const i=s===E.Up?M.TopWithStem:M.StemDown;return e.isRest?this.getRestY(e,i):this.voiceContainer.getHighestNoteY(e,i)}getFlagBottomY(e,s){const i=s===E.Up?M.StemUp:M.BottomWithStem;return e.isRest?this.getRestY(e,i):this.voiceContainer.getLowestNoteY(e,i)}getBeamDirection(e){return this._beamDirections.has(e)?this._beamDirections.get(e):E.Up}centerStaffStemY(e){return this.bar.staff.standardNotationLineCount===cr.DefaultStandardNotationLineCount?this.getScoreY(this.bar.staff.standardNotationLineCount-1):e===E.Up?this.getScoreY(this.bar.staff.standardNotationLineCount*2):this.getScoreY(0)}get middleYPosition(){return this.getScoreY(this.bar.staff.standardNotationLineCount-1)}applyLayoutingInfo(){const e=super.applyLayoutingInfo();if(e&&this.bar.isMultiVoice){const s=this.getScoreY(-2),i=this.getScoreY(this.heightLineCount*2),r=this.helpers.collisionHelper.getBeatMinMaxY();r[0]<s&&this.registerOverflowTop(Math.abs(r[0])),r[1]>i&&this.registerOverflowBottom(Math.abs(r[1])-i)}return e}getMinLineOfBeat(e){return this.accidentalHelper.getMinSteps(e)/2}getMaxLineOfBeat(e){return this.accidentalHelper.getMaxSteps(e)/2}createLinePreBeatGlyphs(){let e=!1;if(this.isFirstOfStaff||this.bar.clef!==this.bar.previousBar.clef||this.bar.clefOttava!==this.bar.previousBar.clefOttava){let s=0;switch(this.bar.clef){case Fe.Neutral:s=this.bar.staff.standardNotationLineCount-1;break;case Fe.F4:s=2;break;case Fe.C3:s=4;break;case Fe.C4:s=2;break;case Fe.G2:s=6;break}this.createStartSpacing(),this.addPreBeatGlyph(new xh(0,this.getScoreY(s),this.bar.clef,this.bar.clefOttava)),this.addPreBeatGlyph(new ys(0,0,this.smuflMetrics.preBeatGlyphSpacing)),e=!0}(e||this.index===0&&this.bar.keySignature!==Ke.C||this.bar.previousBar&&this.bar.keySignature!==this.bar.previousBar.keySignature)&&(this.createStartSpacing(),this._createKeySignatureGlyphs()),(!this.bar.previousBar||this.bar.previousBar&&this.bar.masterBar.timeSignatureNumerator!==this.bar.previousBar.masterBar.timeSignatureNumerator||this.bar.previousBar&&this.bar.masterBar.timeSignatureDenominator!==this.bar.previousBar.masterBar.timeSignatureDenominator||this.bar.previousBar&&this.bar.masterBar.isFreeTime&&this.bar.masterBar.isFreeTime!==this.bar.previousBar.masterBar.isFreeTime)&&(this.createStartSpacing(),this._createTimeSignatureGlyphs())}_createKeySignatureGlyphs(){let e=0;const s=this.bar.keySignature,i=this.bar.previousBar?this.bar.previousBar.keySignature:0;switch(this.bar.clef){case Fe.Neutral:e=0;break;case Fe.G2:e=1;break;case Fe.F4:e=3;break;case Fe.C3:e=2;break;case Fe.C4:e=0;break}const r=new $f;r.gap=this.smuflMetrics.accidentalPadding,r.renderer=this;const a=new Map,l=[];if(A.keySignatureIsSharp(s))for(let h=0;h<Math.abs(s);h++){const c=Ii._sharpKsSteps[h]+e;l.push(new Ci(0,this.getScoreY(c),he.Sharp,1)),a.set(c,!0)}else for(let h=0;h<Math.abs(s);h++){const c=Ii._flatKsSteps[h]+e;l.push(new Ci(0,this.getScoreY(c),he.Flat,1)),a.set(c,!0)}if(this.bar.keySignature===Ke.C){const h=Math.abs(i),c=A.keySignatureIsSharp(i)?Ii._sharpKsSteps:Ii._flatKsSteps;for(let d=0;d<h;d++){const u=c[d]+e;a.has(u)||r.addGlyph(new Ci(0,this.getScoreY(c[d]+e),he.Natural,1))}}for(const h of l)r.addGlyph(h);this.addPreBeatGlyph(r),r.isEmpty||this.addPreBeatGlyph(new ys(0,0,this.smuflMetrics.preBeatGlyphSpacing))}_createTimeSignatureGlyphs(){const e=this.bar.staff.standardNotationLineCount-1;this.addPreBeatGlyph(new Th(0,this.getScoreY(e),this.bar.masterBar.timeSignatureNumerator,this.bar.masterBar.timeSignatureDenominator,this.bar.masterBar.timeSignatureCommon,this.bar.masterBar.isFreeTime)),this.addPreBeatGlyph(new ys(0,0,this.smuflMetrics.preBeatGlyphSpacing))}createVoiceGlyphs(e){super.createVoiceGlyphs(e);for(const s of e.beats)this.addBeatGlyph(new ap(s))}getNoteLine(e){return this.accidentalHelper.getNoteSteps(e)/2}getNoteSteps(e){return this.accidentalHelper.getNoteSteps(e)}completeBeamingHelper(e){const s=this._calculateBeamDirection(e);this._beamDirections.set(e,s)}_calculateBeamDirection(e){if(!e.voice)return E.Up;if(e.preferredBeamDirection!==null)return e.preferredBeamDirection;if(e.voice.index>0)return this._invertBeamDirection(e,E.Down);if(e.voice.bar.isMultiVoice)return this._invertBeamDirection(e,E.Up);if(e.beats[0].graceType!==ee.None)return this._invertBeamDirection(e,E.Up);if(e.beats.length===1&&e.beats[0].slashed)return this._invertBeamDirection(e,E.Down);if(e.highestNoteInHelper&&e.lowestNoteInHelper){const s=this._getNoteCenterYBeforeLayouting(e.highestNoteInHelper),i=this._getNoteCenterYBeforeLayouting(e.lowestNoteInHelper),r=(s+i)/2;return this._invertBeamDirection(e,this.middleYPosition<r?E.Up:E.Down)}return this._invertBeamDirection(e,E.Up)}_getNoteCenterYBeforeLayouting(e){const s=Er.computeStepsWithoutAccidentals(this.bar,e);return this.getScoreY(s)}_invertBeamDirection(e,s){if(!e.invertBeamDirection)return s;switch(s){case E.Down:return E.Up;default:return E.Down}}paintBeamingStem(e,s,i,r,a,l){var c;const h=ve.beat(l,ht.StandardNotationStem,e);try{l.fillRect(i,r,this.smuflMetrics.stemThickness,a-r)}finally{(c=h==null?void 0:h[Symbol.dispose])==null||c.call(h)}}};o(Ii,"StaffId","score"),o(Ii,"_sharpKsSteps",[-1,2,-2,1,4,0,3]),o(Ii,"_flatKsSteps",[3,0,4,1,5,2,6]);let lr=Ii;class np extends wo{get staffId(){return lr.StaffId}create(t,e){return new lr(t,e)}canCreate(t,e){return super.canCreate(t,e)&&e.showStandardNotation}}class op extends on{paint(t,e,s){super.internalPaint(t,e,s,ht.SlashRests)}}class lp extends No{constructor(){super(...arguments);o(this,"_tremoloPicking");o(this,"_stemLengthExtension",0);o(this,"noteHeads",null);o(this,"deadSlapped",null);o(this,"restGlyph",null)}get effectElement(){return ht.SlashEffects}getNoteX(e,s){let i=null;if(this.noteHeads?i=this.noteHeads:this.deadSlapped&&(i=this.deadSlapped),i){let r=i.x;switch(s){case je.Left:break;case je.Center:r+=i.width/2;break;case je.Right:r+=i.width;break}return r}return 0}buildBoundingsLookup(e,s,i){if(this.noteHeads&&this.container.beat.notes.length>0){const r=new na;r.note=this.container.beat.notes[0],r.noteHeadBounds=new Pt,r.noteHeadBounds.x=s+this.x+this.noteHeads.x,r.noteHeadBounds.y=i+this.y+this.noteHeads.y-this.noteHeads.height/2,r.noteHeadBounds.w=this.width,r.noteHeadBounds.h=this.height,e.addNote(r)}}getLowestNoteY(e){return this._internalGetNoteY(e)}getHighestNoteY(e){return this._internalGetNoteY(e)}getRestY(e){const s=this.restGlyph;if(s)switch(e){case M.TopWithStem:return s.getBoundingBoxTop()-this.renderer.smuflMetrics.getStemLength(b.Quarter,!0);case M.Top:return s.getBoundingBoxTop();case M.Center:case M.StemUp:case M.StemDown:return s.getBoundingBoxTop()+s.height/2;case M.Bottom:return s.getBoundingBoxBottom();case M.BottomWithStem:return s.getBoundingBoxBottom()+this.renderer.smuflMetrics.getStemLength(b.Quarter,!0)}return 0}getNoteY(e,s){return this._internalGetNoteY(s)}_internalGetNoteY(e){let s=null,i=f.None,r=!1;if(this.noteHeads?(s=this.noteHeads,i=ia.getSymbol(this.container.beat.duration),r=!0):this.deadSlapped&&(s=this.deadSlapped),s){let a=this.y+s.y;const l=this.renderer,h=this.container.beat,c=h.graceType!==ee.None?Ze.GraceScale:1;switch(e){case M.TopWithStem:return r?(a-=(l.smuflMetrics.stemUp.has(i)?l.smuflMetrics.stemUp.get(i).bottomY:0)*c,a-=l.smuflMetrics.getStemLength(h.duration,l.hasFlag(h))*c,a-=this._stemLengthExtension):a-=s.height/2,a;case M.Top:a-=s.height/2;break;case M.Center:break;case M.Bottom:a+=s.height/2;break;case M.BottomWithStem:return r?(a-=(l.smuflMetrics.stemDown.has(i)?l.smuflMetrics.stemDown.get(i).topY:-l.smuflMetrics.glyphHeights.get(i)/2)*c,a+=l.smuflMetrics.getStemLength(h.duration,l.hasFlag(h))*c,a+=this._stemLengthExtension):a+=s.height/2,a;case M.StemUp:a-=this.renderer.smuflMetrics.stemUp.has(i)?this.renderer.smuflMetrics.stemUp.get(i).bottomY:0;break;case M.StemDown:a-=this.renderer.smuflMetrics.stemDown.has(i)?this.renderer.smuflMetrics.stemDown.get(i).topY:0;break}return a}return 0}doLayout(){const e=this.renderer,s=e.getLineY(0);if(this.container.beat.deadSlapped){const r=new Po;r.renderer=this.renderer,r.doLayout(),this.deadSlapped=r,this.addEffect(r)}else if(!this.container.beat.isEmpty)if(this.container.beat.isRest){const r=new op(0,s,this.container.beat.duration);this.restGlyph=r,r.beat=this.container.beat,this.addNormal(r)}else{const r=new ia(0,s,this.container.beat);this.noteHeads=r,r.beat=this.container.beat,this.addNormal(r),this.container.beat.isTremolo&&(this._tremoloPicking=new oa(0,0,this.container.beat.tremoloPicking),this._tremoloPicking.renderer=this.renderer,this._tremoloPicking.doLayout(),this._alignTremoloPickingGlyph())}if(this.container.beat.dots>0)for(let r=0;r<this.container.beat.dots;r++)this.addEffect(new qa(0,s-e.getLineHeight(.5)));super.doLayout(),this.container.beat.isEmpty?(this.onTimeX=this.width/2,this.stemX=this.onTimeX):this.restGlyph?(this.onTimeX=this.restGlyph.x+this.restGlyph.width/2,this.stemX=this.onTimeX):this.noteHeads?(this.onTimeX=this.noteHeads.x+this.noteHeads.width/2,this.stemX=this.noteHeads.x+this.noteHeads.stemX):this.deadSlapped&&(this.onTimeX=this.deadSlapped.x+this.deadSlapped.width/2,this.stemX=this.onTimeX),this.middleX=this.onTimeX;const i=this._tremoloPicking;i&&(i.x=this.container.beat.duration<b.Half?this.width/2:this.stemX)}_alignTremoloPickingGlyph(){const e=this._tremoloPicking;e.alignTremoloPickingGlyph(E.Up,this._internalGetNoteY(M.TopWithStem),this._internalGetNoteY(M.Center),this.container.beat.duration),this._stemLengthExtension=e.stemExtensionHeight;let s=this.stemX;this.container.beat.duration<b.Half&&(s=this.width/2),e.x=s}paint(e,s,i){super.paint(e,s,i);const r=this._tremoloPicking;r&&r.paint(e+this.x,s+this.y,i)}}class uc extends Bo{calculateTieDirection(){return E.Down}getStartNotePosition(){return je.Right}getEndNotePosition(){return je.Left}}class hp extends Pi{constructor(e){super(e);o(this,"_tiedNoteTie",null);o(this,"_flagStretch",0);this.preNotes=new rn,this.onNotes=new lp}doLayout(){const e=this.renderer,s=this.beat,i=s.graceType!==ee.None;if(e.hasFlag(s)){const r=e.getBeatDirection(s),a=i?Ze.GraceScale:1,l=an.getSymbol(s.duration,r,i),h=e.smuflMetrics.glyphWidths.get(l)*a;this._flagStretch=h}else if(i){const r=e.smuflMetrics.glyphWidths.get(f.Flag8thUp)*Ze.GraceScale;this._flagStretch=r}super.doLayout()}createTies(e){if(e.isVisible){if(!this._tiedNoteTie&&e.isTieOrigin&&e.tieDestination.isVisible){const s=new uc("slash.tie",e,e.tieDestination,!1);this._tiedNoteTie=s,this.addTie(s)}if(!this._tiedNoteTie&&e.isTieDestination){const s=new uc("slash.tie",e.tieOrigin,e,!0);this._tiedNoteTie=s,this.addTie(s)}}}get postBeatStretch(){return super.postBeatStretch+this._flagStretch}updateWidth(){super.updateWidth(),this.width+=this._flagStretch}}class Ka extends pi{constructor(e,s){super(e,s);o(this,"simpleWhammyOverflow",0);o(this,"_isOnlySlash");this._isOnlySlash=!s.staff.showTablature&&!s.staff.showStandardNotation,this.helpers.preferredBeamDirection=E.Up}get repeatsBarSubElement(){return Ae.SlashRepeats}get barNumberBarSubElement(){return Ae.SlashBarNumber}get barLineBarSubElement(){return Ae.SlashBarLines}get staffLineBarSubElement(){return Ae.SlashStaffLine}get lineSpacing(){return this.smuflMetrics.oneStaffSpace}get heightLineCount(){return 5}get drawnLineCount(){return 1}get bottomGlyphOverflow(){return 0}get flagsSubElement(){return ht.SlashFlags}get beamsSubElement(){return ht.SlashBeams}get tupletSubElement(){return ht.SlashTuplet}doLayout(){super.doLayout(),this.voiceContainer.tupletGroups.size>0&&this.registerOverflowTop(this.tupletSize)}getNoteLine(e){return 0}getFlagTopY(e,s){const i=s===E.Up?M.TopWithStem:M.StemDown;return e.notes.length>0?this.getNoteY(e.notes[0],i):this.getRestY(e,i)}getFlagBottomY(e,s){const i=s===E.Up?M.StemUp:M.BottomWithStem;return e.notes.length>0?this.getNoteY(e.notes[0],i):this.getRestY(e,i)}getBeamDirection(e){return E.Up}createLinePreBeatGlyphs(){this._isOnlySlash&&(!this.bar.previousBar||this.bar.previousBar&&this.bar.masterBar.timeSignatureNumerator!==this.bar.previousBar.masterBar.timeSignatureNumerator||this.bar.previousBar&&this.bar.masterBar.timeSignatureDenominator!==this.bar.previousBar.masterBar.timeSignatureDenominator||this.bar.previousBar&&this.bar.masterBar.isFreeTime&&this.bar.masterBar.isFreeTime!==this.bar.previousBar.masterBar.isFreeTime)&&(this.createStartSpacing(),this._createTimeSignatureGlyphs())}_createTimeSignatureGlyphs(){this.addPreBeatGlyph(new ys(0,0,this.smuflMetrics.oneStaffSpace));const e=this.bar.masterBar,s=new Th(0,this.getLineY(0),e.timeSignatureNumerator,e.timeSignatureDenominator,e.timeSignatureCommon,e.isFreeTime&&(e.previousMasterBar==null||e.isFreeTime!==e.previousMasterBar.isFreeTime));s.barSubElement=Ae.SlashTimeSignature,this.addPreBeatGlyph(s)}createVoiceGlyphs(e){if(!(e.index>0)){super.createVoiceGlyphs(e);for(const s of e.beats)this.addBeatGlyph(new hp(s))}}calculateOverflows(e,s){super.calculateOverflows(e,s),!this.bar.isEmpty&&this.calculateBeamingOverflows(e,s)}shouldPaintBeamingHelper(e){return super.shouldPaintBeamingHelper(e)&&e.voice.index===0}paintBeamingStem(e,s,i,r,a,l){var c;const h=ve.beat(l,ht.SlashStem,e);try{l.fillRect(i,r,this.smuflMetrics.stemThickness,a-r)}finally{(c=h==null?void 0:h[Symbol.dispose])==null||c.call(h)}}paintBeamHelper(e,s,i,r,a,l){var h;((h=r.voice)==null?void 0:h.index)===0&&super.paintBeamHelper(e,s,i,r,a,l)}}o(Ka,"StaffId","slash");class cp extends wo{get staffId(){return Ka.StaffId}create(t,e){return new Ka(t,e)}canCreate(t,e){return super.canCreate(t,e)&&e.showSlash}}class dp extends It{constructor(e,s,i){super(e,s);o(this,"_note");o(this,"_noteString",null);o(this,"_trillNoteString",null);o(this,"_trillNoteStringWidth",0);o(this,"isEmpty",!1);o(this,"noteStringWidth",0);this._note=i}get _padding(){return this.renderer.lineSpacing*.25}getBoundingBoxTop(){return this.y-this.height/2-this._padding}getBoundingBoxBottom(){return this.y+this.height/2}doLayout(){const e=this._note;let s=e.fret-e.beat.voice.bar.staff.transpositionPitch;if(e.harmonicType===ie.Natural&&e.harmonicValue!==0&&(s=e.harmonicValue-e.beat.voice.bar.staff.transpositionPitch),e.isTieDestination)e.beat.index===0&&this.renderer.settings.notation.notationMode===Xt.GuitarPro||(e.bendType===J.Bend||e.bendType===J.BendRelease)&&this.renderer.settings.notation.isNotationElementVisible(v.TabNotesOnTiedBends)?this._noteString=`(${(e.tieOrigin.fret-e.beat.voice.bar.staff.transpositionPitch).toString()})`:this._noteString="";else if(this._noteString=e.isDead?"x":s.toString(),e.isGhost)this._noteString=`(${this._noteString})`;else if(e.harmonicType===ie.Natural){const i=this._noteString.indexOf(".");i>=0&&(this._noteString=this._noteString.substr(0,i+2)),this._noteString=`<${this._noteString}>`}if(e.isTrill)this._trillNoteString=`(${(e.trillFret-e.beat.voice.bar.staff.transpositionPitch).toString()})`;else if(A.isAlmostEqualTo(e.harmonicValue,0))this._trillNoteString="";else switch(e.harmonicType){case ie.Artificial:case ie.Pinch:case ie.Tap:case ie.Semi:case ie.Feedback:let i=(s+e.harmonicValue).toString();const r=i.indexOf(".");r>=0&&(i=i.substr(0,r+2)),this._trillNoteString=`<${i}>`;break;default:this._trillNoteString="";break}if(this.isEmpty=!this._noteString,!this.isEmpty){this.renderer.scoreRenderer.canvas.font=this.renderer.resources.tablatureFont;const i=!!this._trillNoteString;this.noteStringWidth=this.renderer.scoreRenderer.canvas.measureText(this._noteString+(i?" ":"")).width,this.width=this.noteStringWidth,this.height=this.renderer.scoreRenderer.canvas.font.size,i&&(this.renderer.scoreRenderer.canvas.font=this.renderer.resources.graceFont,this._trillNoteStringWidth=3+this.renderer.scoreRenderer.canvas.measureText(this._trillNoteString).width,this.width+=this._trillNoteStringWidth)}}paint(e,s,i){var c;if(this.isEmpty)return;const r=this.noteStringWidth+this._trillNoteStringWidth,a=e+this.x+(this.width-r)/2,l=s+this.y;this.paintTrill(a,l,i);const h=ve.note(i,ns.GuitarTabFretNumber,this._note);try{i.fillText(this._noteString,a,l)}finally{(c=h==null?void 0:h[Symbol.dispose])==null||c.call(h)}}paintTrill(e,s,i){var a;const r=ve.note(i,ns.GuitarTabFretNumber,this._note);try{const l=this.renderer.scoreRenderer.canvas.font;this.renderer.scoreRenderer.canvas.font=this.renderer.resources.graceFont,i.fillText(this._trillNoteString,e+this.noteStringWidth,s),this.renderer.scoreRenderer.canvas.font=l}finally{(a=r==null?void 0:r[Symbol.dispose])==null||a.call(r)}}buildBoundingsLookup(e,s,i){const r=new na;r.note=this._note,r.noteHeadBounds=new Pt,r.noteHeadBounds.x=s+this.x,r.noteHeadBounds.y=i+this.y-this.height/2,r.noteHeadBounds.w=this.width,r.noteHeadBounds.h=this.height,e.addNote(r)}}class up extends It{constructor(e,s,i){super(e,s);o(this,"_notes",[]);o(this,"_deadSlapped",null);o(this,"_isGrace");o(this,"beat");o(this,"maxStringNote",null);o(this,"minStringNote",null);o(this,"beatEffects",new Map);o(this,"notesPerString",new Map);o(this,"noteStringWidth",0);this._isGrace=i}buildBoundingsLookup(e,s,i){for(const r of this._notes)r.buildBoundingsLookup(e,s+this.x,i+this.y)}getNoteX(e,s){if(this.notesPerString.has(e.string)){const i=this.notesPerString.get(e.string);let r=this.x+i.x;switch(s){case je.Left:break;case je.Center:r+=i.noteStringWidth/2;break;case je.Right:r+=i.width;break}return r}return 0}getLowestNoteY(e){return this.maxStringNote?this.getNoteY(this.maxStringNote,e):0}getHighestNoteY(e){return this.minStringNote?this.getNoteY(this.minStringNote,e):0}getNoteY(e,s){if(this.notesPerString.has(e.string)){const i=this.notesPerString.get(e.string);let r=this.y+i.y;switch(s){case M.Top:r-=i.height/2;break;case M.StemUp:r=this.y+i.getBoundingBoxTop();break;case M.Center:break;case M.Bottom:r+=i.height/2;break;case M.StemDown:r=this.y+i.getBoundingBoxBottom();break;case M.TopWithStem:r=-this.renderer.settings.notation.rhythmHeight,r-=this.calculateTremoloHeightForStem();break;case M.BottomWithStem:r=this.renderer.height+this.renderer.settings.notation.rhythmHeight,r+=this.calculateTremoloHeightForStem();break}return r}return 0}calculateTremoloHeightForStem(){const e=this.beat;if(!e.isTremolo||e.duration<=b.Quarter)return 0;const s=oa._getSymbol(e.tremoloPicking),i=this.renderer.smuflMetrics;return i.glyphHeights.has(s)?i.glyphHeights.get(s):0}doLayout(){let e=0;if(this.beat.deadSlapped)this._deadSlapped=new Po,this._deadSlapped.renderer=this.renderer,this._deadSlapped.doLayout(),e=this._deadSlapped.width,this.noteStringWidth=e;else{let s=0;for(let c=0,d=this._notes.length;c<d;c++){const u=this._notes[c];u.renderer=this.renderer,u.doLayout(),u.width>e&&(e=u.width),u.noteStringWidth>s&&(s=u.noteStringWidth)}this.noteStringWidth=s;const i=this.renderer.resources.tablatureFont.size;let r=Number.NaN,a=Number.NaN,l=this.getNoteY(this.minStringNote,M.Center)+i/2;const h=this.renderer.smuflMetrics.onNoteEffectPadding;for(const c of this.beatEffects.values())c.y+=l,c.x+=this.width/2,c.renderer=this.renderer,c.doLayout(),l+=c.height+h,(Number.isNaN(r)||r>l)&&(r=l),(Number.isNaN(a)||a<l)&&(a=l);Number.isNaN(r)||this.renderer.registerBeatEffectOverflows(r,a)}this.width=e}addNoteGlyph(e,s){this._notes.push(e),this.notesPerString.set(s.string,e),(!this.minStringNote||s.string<this.minStringNote.string)&&(this.minStringNote=s),(!this.maxStringNote||s.string>this.maxStringNote.string)&&(this.maxStringNote=s)}paint(e,s,i){var r,a;if(e+=this.x,s+=this.y,this.beat.deadSlapped)(r=this._deadSlapped)==null||r.paint(e,s,i);else{const l=this.renderer.resources,h=i.textBaseline;i.textBaseline=Ue.Middle,i.font=this._isGrace?l.graceFont:l.tablatureFont;const c=this._notes,d=this.width;for(const p of c)p.renderer=this.renderer,p.width=d,p.paint(e,s,i);i.textBaseline=h;const u=ve.beat(i,ht.GuitarTabEffects,this.beat);try{for(const p of this.beatEffects.values())p.paint(e,s,i)}finally{(a=u==null?void 0:u[Symbol.dispose])==null||a.call(u)}}}}class fp extends Ht{constructor(e,s,i,r){super(e,s,1,on.getSymbol(r));o(this,"_isVisibleRest");this._isVisibleRest=i}doLayout(){super.doLayout()}paint(e,s,i){var r;if(this._isVisibleRest){const a=ve.beat(i,ht.GuitarTabRests,this.beat);try{super.paint(e,s,i)}finally{(r=a==null?void 0:a[Symbol.dispose])==null||r.call(a)}}}}class pp extends No{constructor(){super(...arguments);o(this,"slash",null);o(this,"noteNumbers",null);o(this,"restGlyph",null)}get effectElement(){return ht.GuitarTabEffects}getNoteX(e,s){if(this.slash){let i=this.slash.x;switch(s){case je.Left:break;case je.Center:i+=this.slash.width/2;break;case je.Right:i+=this.slash.width;break}return i}return this.noteNumbers?this.noteNumbers.getNoteX(e,s):0}getNoteY(e,s){return this.noteNumbers?this.noteNumbers.getNoteY(e,s):0}getRestY(e){const s=this.restGlyph;if(s)switch(e){case M.TopWithStem:return s.getBoundingBoxTop()-this.renderer.smuflMetrics.getStemLength(b.Quarter,!0);case M.Top:return s.getBoundingBoxTop();case M.Center:case M.StemUp:case M.StemDown:return s.getBoundingBoxTop()+s.height/2;case M.Bottom:return s.getBoundingBoxTop();case M.BottomWithStem:return s.getBoundingBoxBottom()+this.renderer.smuflMetrics.getStemLength(b.Quarter,!0)}return 0}getLowestNoteY(e){return this.noteNumbers?this.noteNumbers.getLowestNoteY(e):0}getHighestNoteY(e){return this.noteNumbers?this.noteNumbers.getHighestNoteY(e):0}buildBoundingsLookup(e,s,i){this.noteNumbers&&this.noteNumbers.buildBoundingsLookup(e,s+this.x,i+this.y)}doLayout(){const e=this.renderer,s=[];if(this.container.beat.isRest){const r=Math.floor((this.renderer.bar.staff.tuning.length-1)/2),a=e.getLineY(r),l=new fp(0,a,e.showRests,this.container.beat.duration);if(this.restGlyph=l,l.beat=this.container.beat,this.addNormal(l),this.container.beat.dots>0&&e.showRests)for(let h=0;h<this.container.beat.dots;h++)this.addEffect(new qa(0,a))}else{const r=this.renderer.settings.notation.smallGraceTabNotes&&this.container.beat.graceType!==ee.None;let a;if(this.container.beat.slashed&&!this.container.beat.notes.some(l=>l.isTieDestination)){const l=Math.floor((this.renderer.bar.staff.tuning.length-1)/2),h=e.getLineY(l),c=new ia(0,h,this.container.beat);c.noteHeadElement=ns.GuitarTabFretNumber,c.effectElement=ht.GuitarTabEffects,this.slash=c,c.beat=this.container.beat,this.addNormal(c),a=c.beatEffects}else{const l=new up(0,0,r);this.noteNumbers=l,l.beat=this.container.beat;for(const h of this.container.beat.notes)h.isVisible&&this._createNoteGlyph(h);this.addNormal(l),a=l.beatEffects}if(this.container.beat.isTremolo&&!a.has("tremolo")){const l=new oa(0,0,this.container.beat.tremoloPicking);l.offsetY=this.renderer.smuflMetrics.glyphTop.get(l.symbol),a.set("tremolo",l),s.push(l)}if(this.container.beat.dots>0&&e.rhythmMode!==Xs.Hidden){const l=this.getNoteY(this.container.beat.maxNote,M.BottomWithStem);for(let h=0;h<this.container.beat.dots;h++)this.addEffect(new qa(0,l))}}if(this.isEmpty)return;let i=0;for(let r=0,a=this.glyphs.length;r<a;r++){const l=this.glyphs[r];l.x=i,l.renderer=this.renderer,l.doLayout(),i+=l.width}this.width=i,this.computedWidth=i,this.container.beat.isEmpty?this.onTimeX=this.width/2:this.restGlyph?this.onTimeX=this.restGlyph.x+this.restGlyph.width/2:this.noteNumbers?this.onTimeX=this.noteNumbers.x+this.noteNumbers.noteStringWidth/2:this.slash&&(this.onTimeX=this.slash.x+this.slash.width/2),this.middleX=this.onTimeX,this.stemX=this.middleX;for(const r of s)r.x=this.onTimeX}_createNoteGlyph(e){const s=this.renderer,i=new dp(0,0,e),r=s.getNoteLine(e);i.y=s.getLineY(r),i.renderer=this.renderer,i.doLayout(),this.noteNumbers.addNoteGlyph(i,e);const a=i.getBoundingBoxTop(),l=i.getBoundingBoxBottom();this.renderer.collisionHelper.reserveBeatSlot(this.container.beat,a,l);const h=s.minString,c=s.maxString;(Number.isNaN(h)||h<e.string)&&(s.minString=r),(Number.isNaN(c)||c>e.string)&&(s.maxString=r)}}class gp extends It{constructor(e){super(0,0);o(this,"_beat");o(this,"_noteVibratoGlyph");this._beat=e}doLayout(){if(this.width=this.renderer.smuflMetrics.glyphWidths.get(f.ArrowheadBlackDown),this._beat.brushType===Y.ArpeggioUp){const e=new ur(0,0,Ee.Slight,!0);e.renderer=this.renderer,e.doLayout(),this._noteVibratoGlyph=e}else if(this._beat.brushType===Y.ArpeggioDown){const e=new ur(0,0,Ee.Slight,!0);e.renderer=this.renderer,e.doLayout(),this._noteVibratoGlyph=e}}paint(e,s,i){const r=this.renderer,a=s+this.x+r.getNoteY(this._beat.maxStringNote,M.Top),l=s+this.y+r.getNoteY(this._beat.minStringNote,M.Bottom),h=e+this.x+this.width/2,c=this.renderer.smuflMetrics.glyphWidths.get(f.ArrowheadBlackDown);if(this._beat.brushType!==Y.None){if(this._beat.brushType===Y.BrushUp||this._beat.brushType===Y.BrushDown)i.beginPath(),i.moveTo(h,a),i.lineTo(h,l),i.stroke();else if(this._beat.brushType===Y.ArpeggioUp){const d=this._noteVibratoGlyph,u=a,p=l-c;d.width=Math.abs(p-u),i.beginRotate(e+this.x,p,-90),d.paint(0,(this.width-d.height)/2,i),i.endRotate()}else if(this._beat.brushType===Y.ArpeggioDown){const d=this._noteVibratoGlyph,u=a+c,p=l;d.width=Math.abs(p-u),i.beginRotate(e+this.x,u,90),d.paint(0,-(this.width-d.height/2),i),i.endRotate()}this._beat.brushType===Y.BrushUp||this._beat.brushType===Y.ArpeggioUp?(i.beginPath(),i.moveTo(h,l),i.lineTo(h+c/2,l-c),i.lineTo(h-c/2,l-c),i.closePath(),i.fill()):(i.beginPath(),i.moveTo(h,a),i.lineTo(h+c/2,a+c),i.lineTo(h-c/2,a+c),i.closePath(),i.fill())}}}class mp extends rn{doLayout(){this.container.beat.brushType!==Y.None&&!this.container.beat.isRest&&(this.addEffect(new gp(this.container.beat)),this.addNormal(new ys(0,0,this.renderer.smuflMetrics.preNoteEffectPadding))),super.doLayout()}get effectElement(){return ht.GuitarTabEffects}}class yp extends It{constructor(e,s,i,r){super(0,0);o(this,"_inType");o(this,"_outType");o(this,"_startNote");o(this,"_parent");o(this,"checkForOverflow",!1);this._inType=e,this._outType=s,this._startNote=i,this._parent=r}doLayout(){this.width=0}paint(e,s,i){this._paintSlideIn(e,s,i),this._paintSlideOut(e,s,i)}_paintSlideIn(e,s,i){const r=this.renderer,a=this.renderer.smuflMetrics.simpleSlideWidth,l=this.renderer.smuflMetrics.simpleSlideHeight;let h=0,c=0,d=0,u=0;const p=this.renderer.smuflMetrics.preNoteEffectPadding;switch(this._inType){case Et.IntoFromBelow:d=e+r.x+r.getNoteX(this._startNote,je.Left)-p,u=s+r.y+r.getNoteY(this._startNote,M.Center)-l,h=d-a,c=s+r.y+r.getNoteY(this._startNote,M.Center)+l;break;case Et.IntoFromAbove:d=e+r.x+r.getNoteX(this._startNote,je.Left)-p,u=s+r.y+r.getNoteY(this._startNote,M.Center)+l,h=d-a,c=s+r.y+r.getNoteY(this._startNote,M.Center)-l;break;default:return}this._paintSlideLine(i,!1,h,d,c,u)}_paintSlideOut(e,s,i){const r=this.renderer,a=this.renderer.smuflMetrics.simpleSlideWidth,l=this.renderer.smuflMetrics.simpleSlideHeight;let h=0,c=0,d=0,u=0,p=!1;const g=this.renderer.smuflMetrics.postNoteEffectPadding;switch(this._outType){case ge.Shift:case ge.Legato:if(h=e+r.x+r.getBeatX(this._startNote.beat,oe.PostNotes)+g,c=s+r.y+r.getNoteY(this._startNote,M.Center),this._startNote.slideTarget){const m=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,this._startNote.slideTarget.beat.voice.bar);!m||m.staff!==r.staff?(d=e+r.x+r.width,u=c):(d=e+m.x+m.getBeatX(this._startNote.slideTarget.beat,oe.OnNotes)-g,u=s+m.y+m.getNoteY(this._startNote.slideTarget,M.Center)),this._startNote.slideTarget.fret>this._startNote.fret?(c+=l,u-=l):(c-=l,u+=l)}else d=e+r.x+this._parent.x,u=c;break;case ge.OutUp:h=e+r.x+r.getNoteX(this._startNote,je.Right)+g,c=s+r.y+r.getNoteY(this._startNote,M.Center)+l,d=h+a,u=s+r.y+r.getNoteY(this._startNote,M.Center)-l;break;case ge.OutDown:h=e+r.x+r.getNoteX(this._startNote,je.Right)+g,c=s+r.y+r.getNoteY(this._startNote,M.Center)-l,d=h+a,u=s+r.y+r.getNoteY(this._startNote,M.Center)+l;break;case ge.PickSlideDown:h=e+r.x+r.getNoteX(this._startNote,je.Right)+g*2,c=s+r.y+r.getNoteY(this._startNote,M.Center),d=e+r.x+r.width,u=c+l*3,this._startNote.beat.nextBeat&&this._startNote.beat.nextBeat.voice===this._startNote.beat.voice&&(d=e+r.x+r.getBeatX(this._startNote.beat.nextBeat,oe.PreNotes)),p=!0;break;case ge.PickSlideUp:h=e+r.x+r.getNoteX(this._startNote,je.Right)+g*2,c=s+r.y+r.getNoteY(this._startNote,M.Center),d=e+r.x+r.width,u=c-l*3,this._startNote.beat.nextBeat&&this._startNote.beat.nextBeat.voice===this._startNote.beat.voice&&(d=e+r.x+r.getBeatX(this._startNote.beat.nextBeat,oe.PreNotes)),p=!0;break;default:return}this._paintSlideLine(i,p,h,d,c,u)}_paintSlideLine(e,s,i,r,a,l){if(s){const h=new ur(0,0,Ee.Slight);h.renderer=this.renderer,h.doLayout(),a-=h.height/2,l-=h.height/2;const c=r-i,d=l-a,u=Math.sqrt(Math.pow(d,2)+Math.pow(c,2));h.width=c;const p=Math.asin(d/u)*(180/Math.PI);e.beginRotate(i,a,p),h.paint(0,0,e),e.endRotate()}else e.beginPath(),e.moveTo(i,a),e.lineTo(r,l),e.stroke()}}class bp extends Pi{constructor(e){super(e);o(this,"_bend",null);o(this,"_effectSlurs",[]);this.preNotes=new mp,this.onNotes=new pp}drawBeamHelperAsFlags(e){return e.hasFlag(this.renderer.drawBeamHelperAsFlags(e),this.beat)}doLayout(){this._effectSlurs=[],super.doLayout(),this._bend&&(this._bend.renderer=this.renderer,this._bend.doLayout(),this.updateWidth())}createTies(e){if(!e.isVisible)return;const s=this.renderer;if(e.isTieOrigin&&s.showTiedNotes&&e.tieDestination.isVisible){const i=new Pr(`tab.tie.${e.id}`,e,e.tieDestination,!1);this.addTie(i)}if(e.isTieDestination&&s.showTiedNotes){const i=new Pr(`tab.tie.${e.tieOrigin.id}`,e.tieOrigin,e,!0);this.addTie(i)}if(e.isLeftHandTapped&&!e.isHammerPullDestination){const i=new Pr(`tab.tie.leftHandTap.${e.id}`,e,e,!1);this.addTie(i)}if(e.isEffectSlurOrigin&&e.effectSlurDestination){let i=!1;for(const r of this._effectSlurs)if(r.tryExpand(e,e.effectSlurDestination,!1,!1)){i=!0;break}if(!i){const r=new Cl(`tab.slur.effect.${e.id}`,e,e.effectSlurDestination,!1,!1);this._effectSlurs.push(r),this.addTie(r)}}if(e.isEffectSlurDestination&&e.effectSlurOrigin){let i=!1;for(const r of this._effectSlurs)if(r.tryExpand(e.effectSlurOrigin,e,!1,!0)){i=!0;break}if(!i){const r=new Cl(`tab.slur.effect.${e.effectSlurOrigin.id}`,e.effectSlurOrigin,e,!1,!0);this._effectSlurs.push(r),this.addTie(r)}}if(e.slideInType!==Et.None||e.slideOutType!==ge.None){const i=new yp(e.slideInType,e.slideOutType,e,this);this.addTie(i)}if(e.hasBend){if(!this._bend){const i=new To;this._bend=i,i.renderer=this.renderer,this.addTie(i)}this._bend.addBends(e)}}}class Sp extends Ht{constructor(t,e){super(t,e,1,f.SixStringTabClef)}doLayout(){this.symbol=this.renderer.bar.staff.tuning.length<=4?f.FourStringTabClef:f.SixStringTabClef,this.center=!0,super.doLayout(),this.width=this.renderer.smuflMetrics.glyphWidths.get(f.GClef),this.offsetX=this.width/2}}class _p extends Uc{doLayout(){this.barSubElement=Ae.GuitarTabsTimeSignature,super.doLayout()}get commonScale(){return 1}get numberScale(){return this.renderer.bar.staff.tuning.length<=4?Ze.GraceScale:1}}class Nr extends pi{constructor(){super(...arguments);o(this,"_hasTuplets",!1);o(this,"showTimeSignature",!1);o(this,"showRests",!1);o(this,"showTiedNotes",!1);o(this,"_showMultiBarRest",!1);o(this,"minString",Number.NaN);o(this,"maxString",Number.NaN)}get showMultiBarRest(){return this._showMultiBarRest}get repeatsBarSubElement(){return Ae.GuitarTabsRepeats}get barNumberBarSubElement(){return Ae.GuitarTabsBarNumber}get barLineBarSubElement(){return Ae.GuitarTabsBarLines}get staffLineBarSubElement(){return Ae.GuitarTabsStaffLine}get lineSpacing(){return this.smuflMetrics.tabLineSpacing}get heightLineCount(){return this.bar.staff.tuning.length}get drawnLineCount(){return this.bar.staff.tuning.length}get rhythmMode(){let e=this.settings.notation.rhythmMode;return e===Xs.Automatic&&(e=this.bar.staff.showStandardNotation?Xs.Hidden:Xs.ShowWithBars),e}getNoteLine(e){return this.bar.staff.tuning.length-e.string}collectSpaces(e){if(this.additionalMultiRestBars)return;const s=this.smuflMetrics.staffLineThickness,i=this.bar.staff.tuning;for(const r of this.voiceContainer.beatGlyphs.values())for(const a of r){const l=a.onNotes,h=l.noteNumbers;if(h)for(const[c,d]of h.notesPerString)d.isEmpty||e[i.length-c].push(new Float32Array([this.beatGlyphsStart+a.x+l.x+h.x-s,h.width+s*2]))}}doLayout(){this.bar.staff.showStandardNotation&&this.scoreRenderer.layout.profile.has(lr.StaffId)||(this.showTimeSignature=!0,this.showRests=!0,this.showTiedNotes=!0,this._showMultiBarRest=!0),super.doLayout(),this.minString===0&&this.registerOverflowTop(this.lineSpacing/2),this.maxString===this.bar.staff.tuning.length-1&&this.registerOverflowBottom(this.lineSpacing/2),this.rhythmMode!==Xs.Hidden&&(this._hasTuplets=this.voiceContainer.tupletGroups.size>0,this._hasTuplets&&this.registerOverflowBottom(this.settings.notation.rhythmHeight+this.tupletSize))}createLinePreBeatGlyphs(){if(this.isFirstOfStaff){const e=(this.bar.staff.tuning.length-1)/2;this.createStartSpacing(),this.addPreBeatGlyph(new Sp(0,this.getLineY(e)))}this.showTimeSignature&&(!this.bar.previousBar||this.bar.previousBar&&this.bar.masterBar.timeSignatureNumerator!==this.bar.previousBar.masterBar.timeSignatureNumerator||this.bar.previousBar&&this.bar.masterBar.timeSignatureDenominator!==this.bar.previousBar.masterBar.timeSignatureDenominator||this.bar.previousBar&&this.bar.masterBar.isFreeTime&&this.bar.masterBar.isFreeTime!==this.bar.previousBar.masterBar.isFreeTime)&&(this.createStartSpacing(),this._createTimeSignatureGlyphs())}_createTimeSignatureGlyphs(){this.addPreBeatGlyph(new ys(0,0,this.smuflMetrics.oneStaffSpace));const e=(this.bar.staff.tuning.length+1)/2-1;this.addPreBeatGlyph(new _p(0,this.getLineY(e),this.bar.masterBar.timeSignatureNumerator,this.bar.masterBar.timeSignatureDenominator,this.bar.masterBar.timeSignatureCommon,this.bar.masterBar.isFreeTime))}createVoiceGlyphs(e){super.createVoiceGlyphs(e);for(const s of e.beats)this.addBeatGlyph(new bp(s))}get flagsSubElement(){return ht.GuitarTabFlags}get beamsSubElement(){return ht.GuitarTabBeams}get tupletSubElement(){return ht.GuitarTabTuplet}paintBeams(e,s,i,r,a){this.rhythmMode!==Xs.Hidden&&super.paintBeams(e,s,i,r,a)}paintTuplets(e,s,i,r,a=!1){this.rhythmMode!==Xs.Hidden&&super.paintTuplets(e,s,i,r,a)}drawBeamHelperAsFlags(e){return super.drawBeamHelperAsFlags(e)||this.rhythmMode===Xs.ShowWithBeams}getFlagTopY(e,s){const i=e.maxStringNote,r=s===E.Up?M.TopWithStem:M.StemDown;return i?this.getNoteY(i,r):this.getRestY(e,r)}getFlagBottomY(e,s){const i=e.minStringNote,r=s===E.Up?M.StemUp:M.BottomWithStem;return i?this.getNoteY(i,r):this.getRestY(e,r)}getBeamDirection(e){return E.Down}shouldPaintFlag(e){return!(!super.shouldPaintFlag(e)||e.graceType!==ee.None)}paintBeamingStem(e,s,i,r,a,l){var c;if(a<r){const d=a;a=r,r=d}const h=ve.beat(l,ht.GuitarTabStem,e);try{let d=[];if(this.helpers.collisionHelper.reservedLayoutAreasByDisplayTime.has(e.displayStart)&&(d=this.helpers.collisionHelper.reservedLayoutAreasByDisplayTime.get(e.displayStart).slots.slice(),d.sort((g,m)=>g.topY-m.topY)),d.length===1){l.fillRect(i,r,this.smuflMetrics.stemThickness,a-r);return}const u=a-s,p=d[d.length-1];l.fillRect(i,s+p.bottomY,this.smuflMetrics.stemThickness,u-p.bottomY);for(let g=d.length-1;g>0;g--){const m=d[g].topY,y=d[g-1].bottomY;y<m&&l.fillRect(i,s+y,this.smuflMetrics.stemThickness,m-y)}}finally{(c=h==null?void 0:h[Symbol.dispose])==null||c.call(h)}}calculateOverflows(e,s){super.calculateOverflows(e,s),!this.bar.isEmpty&&this.rhythmMode!==Xs.Hidden&&this.calculateBeamingOverflows(e,s)}}o(Nr,"StaffId","tab");class kp extends wo{get staffId(){return Nr.StaffId}constructor(t){super(t),this.hideOnPercussionTrack=!0}canCreate(t,e){return e.showTablature&&e.tuning.length>0&&super.canCreate(t,e)}create(t,e){return new Nr(t,e)}}class Ro{constructor(t,e){o(this,"vertical");o(this,"createLayout");this.vertical=t,this.createLayout=e}}class Oo{constructor(t,e){o(this,"supportsWorkers");o(this,"createCanvas");this.supportsWorkers=t,this.createCanvas=e}}const ne=class ne{static get globalThis(){if(ne._globalThis===void 0){try{ne._globalThis=globalThis}catch{}typeof ne._globalThis>"u"&&(ne._globalThis=self),typeof ne._globalThis>"u"&&(ne._globalThis=global),typeof ne._globalThis>"u"&&(ne._globalThis=window),typeof ne._globalThis>"u"&&(ne._globalThis=Function("return this")())}return ne._globalThis}static get isRunningInWorker(){return"WorkerGlobalScope"in ne.globalThis}static get isRunningInAudioWorklet(){return"AudioWorkletGlobalScope"in ne.globalThis}static throttle(t,e){let s=0;return()=>{ne.globalThis.clearTimeout(s),s=ne.globalThis.setTimeout(t,e)}}static _detectScriptFile(){if(!ne.isRunningInWorker&&ne.globalThis.ALPHATAB_ROOT){let t=ne.globalThis.ALPHATAB_ROOT;return t=ne.ensureFullUrl(t),t=ne._appendScriptName(t),t}try{const t=import.meta.url;if(t&&t.indexOf("file://")===-1)return t}catch{}return"document"in ne.globalThis&&document.currentScript&&document.currentScript instanceof HTMLScriptElement?document.currentScript.src:null}static ensureFullUrl(t){var e,s,i;if(!t)return"";if(!t.startsWith("http")&&!t.startsWith("https")&&!t.startsWith("file")){let r="";const a=ne.globalThis.location;if(r+=(e=a.protocol)==null?void 0:e.toString(),r+="//",a.hostname&&(r+=(s=a.hostname)==null?void 0:s.toString()),a.port&&(r+=":",r+=(i=a.port)==null?void 0:i.toString()),!t.startsWith("/")){const l=a.pathname.split("/").slice(0,-1).join("/");l.length>0&&(l.startsWith("/")||(r+="/"),r+=l==null?void 0:l.toString())}return t.startsWith("/")||(r+="/"),r+=t==null?void 0:t.toString(),r}return t}static _appendScriptName(t){return t&&!t.endsWith(".js")&&(t.endsWith("/")||(t+="/"),t+="alphaTab.js"),t}static _detectFontDirectory(){if(!ne.isRunningInWorker&&ne.globalThis.ALPHATAB_FONT)return ne.ensureFullUrl(ne.globalThis.ALPHATAB_FONT);const t=ne.scriptFile;if(t){const e=t.lastIndexOf("/");if(e>=0)return`${t.substr(0,e)}/font/`}return null}static _registerJQueryPlugin(){if(!ne.isRunningInWorker&&ne.globalThis&&"jQuery"in ne.globalThis){const t=ne.globalThis.jQuery,e=new zh;t.fn.alphaTab=function(s){const i=Array.prototype.slice.call(arguments,1);return this.length===1?e.exec(this[0],s,i):this.each((r,a)=>{e.exec(a,s,i)})},t.alphaTab={restore:zh.restore},t.fn.alphaTab.fn=e}}static getRenderEngineFactory(t){return!t||!ne.renderEngines.has(t)?ne.renderEngines.get("default"):ne.renderEngines.get(t)}static getLayoutEngineFactory(t){return!t||!ne.layoutEngines.has(t)?ne.layoutEngines.get(Ti.Page):ne.layoutEngines.get(t)}static buildImporters(){return[new Xo,new bd,new md,new Zo,new cd,new bo]}static _createDefaultRenderEngines(){const t=new Map;return t.set("svg",new Oo(!0,()=>new Mc)),t.set("default",t.get("svg")),t.set("skia",new Oo(!1,()=>new Ta)),ne._createPlatformSpecificRenderEngines(t),t}static enableAlphaSkia(t,e){Ta.enable(t,e)}static registerAlphaSkiaCustomFont(t){return Ta.registerFont(t)}static _createPlatformSpecificRenderEngines(t){t.set("html5",new Oo(!1,()=>new tu))}static _createDefaultStaveProfiles(){const t=new Map;return t.set(Wi.Default,new Set([Ka.StaffId,lr.StaffId,Qa.StaffId,Nr.StaffId])),t.set(Wi.ScoreTab,new Set([Ka.StaffId,lr.StaffId,Qa.StaffId,Nr.StaffId])),t.set(Wi.Score,new Set([lr.StaffId])),t.set(Wi.Tab,new Set([Nr.StaffId])),t.set(Wi.TabMixed,new Set([Nr.StaffId])),t}static _createDefaultLayoutEngines(){const t=new Map;return t.set(Ti.Page,new Ro(!0,e=>new If(e))),t.set(Ti.Horizontal,new Ro(!1,e=>new Af(e))),t.set(Ti.Parchment,new Ro(!0,e=>new Rf(e))),t}static initializeMain(t,e){ne.isRunningInWorker||ne.isRunningInAudioWorklet||((ne.webPlatform===xs.Browser||ne.webPlatform===xs.BrowserModule)&&(ne._registerJQueryPlugin(),ne.highDpiFactor=window.devicePixelRatio),ne.createWebWorker=t,ne.createAudioWorklet=e)}static get alphaTabWorker(){return ne.globalThis.Worker}static get alphaTabUrl(){return ne.globalThis.URL}static initializeWorker(){if(!ne.isRunningInWorker)throw new Xe(ze.General,"Not running in worker, cannot run worker initialization");ph.init(),hh.init(),ne.createWebWorker=t=>{throw new Xe(ze.General,"Nested workers are not supported")}}static initializeAudioWorklet(){if(!ne.isRunningInAudioWorklet)throw new Xe(ze.General,"Not running in audio worklet, cannot run worklet initialization");jo.init()}static _detectWebPack(){try{if(typeof __webpack_require__=="function")return typeof __ALPHATAB_WEBPACK__!="boolean"&&L.warning("WebPack","Detected bundling with WebPack but @coderline/alphatab-webpack was not used! To ensure alphaTab works as expected use our bundler plugins. Learn more at https://www.alphatab.net/docs/getting-started/installation-webpack"),!0}catch{}return!1}static _detectVite(){try{if(typeof __BASE__=="string")return typeof __ALPHATAB_VITE__!="boolean"&&L.warning("Vite","Detected bundling with Vite but @coderline/alphatab-vite was not used! To ensure alphaTab works as expected use our bundler plugins. Learn more at https://www.alphatab.net/docs/getting-started/installation-vite"),!0}catch{}return!1}static _detectWebPlatform(){if(!(typeof ne.globalThis.Window<"u"&&ne.globalThis instanceof ne.globalThis.Window))try{if(Object.prototype.toString.call(typeof process<"u"?process:0)==="[object process]")return xs.NodeJs}catch{}try{const e=import.meta.url;if(e&&typeof e=="string"&&!e.startsWith("file://"))return xs.BrowserModule}catch{}return xs.Browser}static printEnvironmentInfo(t=!0){const e=t?s=>{L.log.debug("VersionInfo",s)}:s=>{L.debug("VersionInfo",s)};Va.print(e),e(`High DPI: ${ne.highDpiFactor}`),ne._printPlatformInfo(e)}static _printPlatformInfo(t){t(`Platform: ${xs[ne.webPlatform]}`),t(`WebPack: ${ne.isWebPackBundled}`),t(`Vite: ${ne.isViteBundled}`),ne.webPlatform!==xs.NodeJs&&(t(`Browser: ${navigator.userAgent}`),t(`Window Size: ${window.outerWidth}x${window.outerHeight}`),t(`Screen Size: ${window.screen.width}x${window.screen.height}`))}static prepareForPostMessage(t){if(!t)return t;if(typeof t=="object"){const e=t.__v_raw;if(e)return ne.prepareForPostMessage(e)}return t}static quoteJsonString(t){return JSON.stringify(t)}static sortDescending(t){t.sort((e,s)=>s-e)}};o(ne,"highDpiFactor",1),o(ne,"_globalThis"),o(ne,"webPlatform",ne._detectWebPlatform()),o(ne,"isWebPackBundled",ne._detectWebPack()),o(ne,"isViteBundled",ne._detectVite()),o(ne,"scriptFile",ne._detectScriptFile()),o(ne,"fontDirectory",ne._detectFontDirectory()),o(ne,"createWebWorker"),o(ne,"createAudioWorklet"),o(ne,"renderEngines",ne._createDefaultRenderEngines()),o(ne,"layoutEngines",ne._createDefaultLayoutEngines()),o(ne,"staveProfiles",ne._createDefaultStaveProfiles()),o(ne,"defaultRenderers",[new cp([{effect:new bf,mode:Se.SharedTop},{effect:new wf,mode:Se.SharedTop},{effect:new Qu,mode:Se.SharedTop},{effect:new Vu,mode:Se.SharedTop},{effect:new Xu,mode:Se.SharedTop},{effect:new Sf,mode:Se.SharedTop},{effect:new Fu,mode:Se.SharedTop},{effect:new Iu,mode:Se.SharedTop},{effect:new Lu,mode:Se.SharedTop,order:1e3}]),new np([{effect:new Au,mode:Se.SharedTop},{effect:new Uu,mode:Se.SharedTop},{effect:new _l,mode:Se.SharedTop},{effect:new Ku,mode:Se.SharedTop},{effect:new rf,mode:Se.SharedTop},{effect:new Bf,mode:Se.SharedTop},{effect:new Tf,mode:Se.OwnedTop},{effect:new pf,mode:Se.OwnedTop},{effect:new ec,mode:Se.OwnedTop},{effect:new tf(!0),mode:Se.OwnedTop},{effect:new Xh,mode:Se.OwnedTop},{effect:new jh,mode:Se.OwnedTop},{effect:new tc,mode:Se.OwnedTop},{effect:new Kh,mode:Se.OwnedTop},{effect:new sc,mode:Se.OwnedTop},{effect:new Zh(!1),mode:Se.OwnedTop},{effect:new Yh,mode:Se.OwnedTop,shouldCreate:t=>!t.showTablature},{effect:new $h,mode:Se.OwnedTop,shouldCreate:t=>!t.showTablature},{effect:new qh,mode:Se.OwnedTop,shouldCreate:t=>!t.showTablature},{effect:new Jh,mode:Se.OwnedTop,shouldCreate:t=>!t.showTablature},{effect:new hn(as.Finger),mode:Se.OwnedTop},{effect:new hn(as.Thumb),mode:Se.OwnedBottom},{effect:new Ou,mode:Se.SharedBottom},{effect:new Gu,mode:Se.SharedBottom},{effect:new mf,mode:Se.SharedBottom}]),new Xf([{effect:new ju,mode:Se.OwnedTop,order:1e3}]),new kp([{effect:new qu,mode:Se.SharedTop},{effect:new Tl,mode:Se.OwnedTop},{effect:new ec,mode:Se.OwnedTop},{effect:new tc,mode:Se.OwnedTop},{effect:new Kh,mode:Se.OwnedTop},{effect:new sc,mode:Se.OwnedTop},{effect:new Zh(!0),mode:Se.OwnedTop},{effect:new jh,mode:Se.OwnedTop},{effect:new Yh,mode:Se.OwnedTop},{effect:new Qi(ie.Natural),mode:Se.OwnedTop},{effect:new Qi(ie.Artificial),mode:Se.OwnedTop},{effect:new Qi(ie.Pinch),mode:Se.OwnedTop},{effect:new Qi(ie.Tap),mode:Se.OwnedTop},{effect:new Qi(ie.Semi),mode:Se.OwnedTop},{effect:new Qi(ie.Feedback),mode:Se.OwnedTop},{effect:new $h,mode:Se.OwnedTop},{effect:new Yu,mode:Se.OwnedTop},{effect:new sf,mode:Se.OwnedTop},{effect:new qh,mode:Se.OwnedTop},{effect:new Jh,mode:Se.OwnedTop},{effect:new Xh,mode:Se.OwnedTop},{effect:new hn(as.Finger),mode:Se.OwnedTop,shouldCreate:t=>!t.showStandardNotation},{effect:new hn(as.Thumb),mode:Se.OwnedBottom,shouldCreate:t=>!t.showStandardNotation}])]);let fe=ne;var ti;(function(n){n[n.EmbeddedOpenType=0]="EmbeddedOpenType",n[n.Woff=1]="Woff",n[n.Woff2=2]="Woff2",n[n.OpenType=3]="OpenType",n[n.TrueType=4]="TrueType",n[n.Svg=5]="Svg"})(ti||(ti={}));class Yc{constructor(){o(this,"scriptFile",null);o(this,"fontDirectory",null);o(this,"smuflFontSources",null);o(this,"file",null);o(this,"tex",!1);o(this,"tracks",null);o(this,"enableLazyLoading",!0);o(this,"engine","default");o(this,"logLevel",oi.Info);o(this,"useWorkers",!0);o(this,"includeNoteBounds",!1);this.scriptFile=fe.scriptFile,this.fontDirectory=fe.fontDirectory}static buildDefaultSmuflFontSources(t){const e=new Map,s=t??"";return e.set(ti.Woff2,`${s}Bravura.woff2`),e.set(ti.Woff,`${s}Bravura.woff`),e.set(ti.OpenType,`${s}Bravura.otf`),e}}const wp=Object.freeze(Object.defineProperty({__proto__:null,get AlphaTexAccidentalMode(){return Ga},AlphaTexDiagnosticBag:yo,get AlphaTexDiagnosticCode(){return _e},get AlphaTexDiagnosticsSeverity(){return me},AlphaTexLexer:gn,get AlphaTexNodeType(){return C},get AlphaTexParseMode(){return Cr},AlphaTexParser:Ua,get AlphaTexStaffNoteKind(){return os},get AlphaTexVoiceMode(){return wi},get ArgumentListParseTypesMode(){return Rt}},Symbol.toStringTag,{value:"Module"})),Ap=Object.freeze(Object.defineProperty({__proto__:null,AlphaTexErrorWithDiagnostics:ir,AlphaTexImporter:bo,ScoreImporter:Fr,ScoreLoader:xr,UnsupportedFormatError:Mt,alphaTex:wp},Symbol.toStringTag,{value:"Module"})),Ip=Object.freeze(Object.defineProperty({__proto__:null,ByteBuffer:wt,IOHelper:w},Symbol.toStringTag,{value:"Module"}));class Nh{constructor(){o(this,"data");o(this,"settings")}init(t,e){this.data=t,this.settings=e}export(t,e=null){const s=wt.withCapacity(1024);return this.init(s,e??new vi),this.writeScore(t),s.toArray()}}class Bp{constructor(){o(this,"tex","");o(this,"isStartOfLine",!0);o(this,"indentString","");o(this,"currentIndent",0)}indent(){this.indentString.length>0&&this.currentIndent++}outdent(){this.indentString.length>0&&this.currentIndent--}_preWrite(){if(this.isStartOfLine&&this.indentString.length>0)for(let t=0;t<this.currentIndent;t++)this.tex+=this.indentString;this.isStartOfLine=!1}write(t){this._preWrite(),this.tex+=t,this.isStartOfLine=!1}writeString(t){this._preWrite(),this.tex+=fe.quoteJsonString(t)}writeLine(t){this._preWrite(),t!==void 0&&(this.tex+=t),this.indentString.length>0?this.tex+=`
`:this.tex.endsWith(" ")||(this.tex+=" "),this.isStartOfLine=!0}}class Tp{constructor(t){o(this,"_writer");o(this,"_comments",!1);o(this,"_trackIndex",0);o(this,"_staffIndex",0);o(this,"_voiceIndex",0);const e=new Bp;this._comments=t.exporter.comments,e.indentString=t.exporter.indent>0?" ".repeat(t.exporter.indent):"",this._writer=e}get tex(){return this._writer.tex}writeScoreNode(t){this._writeComments(t.leadingComments);for(const e of t.bars)this._writeBar(e);this._writeComments(t.trailingComments)}_writeBar(t){this._writeComments(t.leadingComments),this._writeMetaDataList(t.metaData),this._writer.indent();for(const e of t.beats)this._writeBeat(e);this._writer.outdent(),this._writeComments(t.trailingComments),this._writeToken(t.pipe,!0)}_writeBeat(t){this._writeComments(t.leadingComments),t.durationChange&&this._writeDurationChange(t.durationChange),t.rest?this._writeValue(t.rest):t.notes&&this._writeNotes(t.notes),this._writeToken(t.durationDot,!1),this._writeValue(t.durationValue),this._writeToken(t.beatMultiplier,!1),this._writeValue(t.beatMultiplierValue),t.beatEffects&&this._writeProperties(t.beatEffects,!1),this._writeComments(t.trailingComments),this._writer.writeLine()}_writeNotes(t){this._writeComments(t.leadingComments),this._writeToken(t.openParenthesis,!1);let e=!0;for(const s of t.notes)e||this._writer.write(" "),this._writeNote(s),e=!1;this._writeToken(t.closeParenthesis,!1),this._writeComments(t.trailingComments)}_writeNote(t){this._writeComments(t.leadingComments),this._writeValue(t.noteValue),this._writeToken(t.noteStringDot,!1),this._writeValue(t.noteString),t.noteEffects&&this._writeProperties(t.noteEffects,!1),this._writeComments(t.trailingComments)}_writeDurationChange(t){this._writeComments(t.leadingComments),this._writeToken(t.colon,!1),this._writeValue(t.value),t.properties&&(this._writer.write(" "),this._writeProperties(t.properties,!1)),this._writeComments(t.trailingComments),this._writer.write(" ")}_writeMetaDataList(t){for(const e of t)this._writeMetaData(e)}_writeMetaData(t){switch(t.tag.tag.text){case"track":this._staffIndex>0&&this._writer.outdent(),this._trackIndex>0&&this._writer.outdent();break;case"staff":this._staffIndex>0&&this._writer.outdent();break;case"voice":this._voiceIndex>0&&this._writer.outdent();break}this._writeComments(t.leadingComments),this._writeToken(t.tag.prefix,!1),this._writeValue(t.tag.tag);let e=!0;switch(t.propertiesBeforeArguments?(t.properties&&(this._writer.write(" "),this._writeProperties(t.properties,!1)),t.arguments&&(this._writer.write(" "),this._writeValues(t.arguments))):(t.arguments&&(this._writer.write(" "),this._writeValues(t.arguments)),t.properties&&(this._writer.write(" "),this._writeProperties(t.properties,!0),e=!1)),t.trailingComments&&(this._writer.write(" "),this._writeComments(t.trailingComments)),t.tag.tag.text){case"track":this._trackIndex++,this._staffIndex=0,this._voiceIndex=0,this._writer.indent();break;case"staff":this._staffIndex++,this._voiceIndex=0,this._writer.indent();break;case"voice":this._voiceIndex++,this._writer.indent();break}e&&this._writer.writeLine()}_writeProperties(t,e){this._writeComments(t.leadingComments),this._writeToken(t.openBrace,e),e&&this._writer.indent();let s=!0;for(const i of t.properties)!s&&!e&&this._writer.write(" "),this._writeProperty(i),s=!1,e&&this._writer.writeLine();e&&this._writer.outdent(),this._writeToken(t.closeBrace,e),this._writeComments(t.trailingComments)}_writeProperty(t){this._writeComments(t.leadingComments),this._writeValue(t.property),t.arguments&&(this._writer.write(" "),this._writeValues(t.arguments)),this._writeComments(t.trailingComments)}_writeValues(t){this._writeComments(t.leadingComments),this._writeToken(t.openParenthesis,!1);let e=!0;for(const s of t.arguments)e||this._writer.write(" "),this._writeValue(s),e=!1;this._writeToken(t.closeParenthesis,!1),this._writeComments(t.trailingComments)}_writeValue(t){if(t){switch(this._writeComments(t.leadingComments),t.nodeType){case C.Ident:this._writer.write(t.text);break;case C.Arguments:this._writeValues(t);break;case C.Number:this._writer.write(t.value.toString());break;case C.String:this._writer.writeString(t.text);break}this._writeComments(t.trailingComments)}}_writeToken(t,e){if(t){switch(this._writeComments(t.leadingComments),t.nodeType){case C.Dot:this._writer.write(".");break;case C.Backslash:this._writer.write("\\");break;case C.DoubleBackslash:this._writer.write("\\\\");break;case C.Pipe:this._writer.write("|");break;case C.LBrace:this._writer.write("{");break;case C.RBrace:this._writer.write("}");break;case C.LParen:this._writer.write("(");break;case C.RParen:this._writer.write(")");break;case C.Colon:this._writer.write(":");break;case C.Asterisk:this._writer.write("*");break}this._writeComments(t.trailingComments),e&&this._writer.writeLine()}}_writeComments(t){if(!(!this._comments||!t))for(const e of t){let s=e.text;s.startsWith(" ")||(s=` ${s}`),e.multiLine?(s.endsWith(" ")||(s+=" "),this._writer.write(`/*${s}*/`)):this._writer.writeLine(`//${s}`)}}}class xp extends Nh{constructor(){super(...arguments);o(this,"_handler",mn.instance)}get name(){return"alphaTex"}exportToString(e,s=null){return this.settings=s??new vi,this.scoreToAlphaTexString(e)}writeScore(e){const s=w.stringToBytes(this.scoreToAlphaTexString(e));this.data.write(s,0,s.length)}scoreToAlphaTexString(e){const s=new Tp(this.settings);return s.writeScoreNode(this._score(e)),s.tex}_score(e){const s={nodeType:C.Score,bars:[]};for(const i of e.tracks)this._track(s,i);return s.bars.length===0?s.bars.push({nodeType:C.Bar,metaData:this._handler.buildScoreMetaDataNodes(e),beats:[]}):s.bars[0].metaData=this._handler.buildScoreMetaDataNodes(e).concat(s.bars[0].metaData),s.bars.push({nodeType:C.Bar,metaData:this._handler.buildSyncPointNodes(e),beats:[]}),s}_track(e,s){for(const i of s.staves)this._staff(e,i)}_staff(e,s){const i=Math.max(...s.filledVoices)+1;if(s.bars.length===0){const r={nodeType:C.Bar,metaData:this._handler.buildBarMetaDataNodes(s,void 0,0,!1),beats:[],pipe:void 0};e.bars.push(r)}else for(let r=0;r<i;r++)this._voice(e,r,s,i>1)}_voice(e,s,i,r){for(const a of i.bars)this._bar(e,a,s,r)}_bar(e,s,i,r){var l;const a={nodeType:C.Bar,metaData:this._handler.buildBarMetaDataNodes(s.staff,s,i,r),beats:[],pipe:void 0};if(s.isEmpty)a.trailingComments=[{multiLine:!1,text:`Bar ${s.index+1} / Voice ${i+1} no contents`}];else{const h=s.voices[i];if(h.isEmpty)a.trailingComments=[{multiLine:!1,text:`Bar ${s.index+1} / Voice ${i+1} no contents`}];else{for(const c of h.beats)a.beats.push(this._beat(c));a.beats.length>0&&((l=a.beats[0]).leadingComments??(l.leadingComments=[]),a.beats[0].leadingComments.unshift({multiLine:!1,text:`Bar ${s.index+1} / Voice ${i+1} contents`}))}}s.index<s.staff.bars.length-1&&(a.pipe={nodeType:C.Pipe}),e.bars.push(a)}_beat(e){const s={nodeType:C.Beat,durationChange:void 0,notes:void 0,rest:void 0,beatEffects:void 0};return e.isRest?s.rest={nodeType:C.Ident,text:"r"}:s.notes=this._notes(e.notes),s.durationDot={nodeType:C.Dot},s.durationValue={nodeType:C.Number,value:e.duration},s.beatEffects=this._beatEffects(e),s}_beatEffects(e){const s=this._handler.buildBeatEffects(e);return s.length>0?{nodeType:C.Props,openBrace:{nodeType:C.LBrace},properties:s,closeBrace:{nodeType:C.RBrace}}:void 0}_notes(e){const s={nodeType:C.NoteList,openParenthesis:void 0,notes:[],closeParenthesis:void 0};(e.length===0||e.length>1)&&(s.openParenthesis={nodeType:C.LParen},s.closeParenthesis={nodeType:C.RParen});for(const i of e)s.notes.push(this._note(i));return s}_note(e){const s={nodeType:C.Note,noteValue:{nodeType:C.Ident,text:""}};if(e.isPercussion)s.noteValue={nodeType:C.String,text:jt.getArticulationName(e)};else if(e.isPiano)s.noteValue={nodeType:C.Ident,text:Vs.getTextForTuning(e.realValueWithoutHarmonic,!0)};else if(e.isStringed){s.noteValue={nodeType:C.Number,value:e.fret},s.noteStringDot={nodeType:C.Dot};const i=e.beat.voice.bar.staff.tuning.length-e.string+1;s.noteString={nodeType:C.Number,value:i}}else throw new Error("What kind of note");return s.noteEffects=this._noteEffects(e),s}_noteEffects(e){const s=this._handler.buildNoteEffects(e);return s.length>0?{nodeType:C.Props,openBrace:{nodeType:C.LBrace},properties:s,closeBrace:{nodeType:C.RBrace}}:void 0}}class O{constructor(t,e,s=null){o(this,"icon",I.Piano);o(this,"instrumentSetName");o(this,"instrumentSetType");if(this.icon=t,this.instrumentSetName=e,s)this.instrumentSetType=s;else{const i=e.split(" ");i[0]=i[0].substr(0,1).toLowerCase()+i[0].substr(1),this.instrumentSetType=i.join("")}}}var I;(function(n){n[n.SteelGuitar=1]="SteelGuitar",n[n.AcousticGuitar=2]="AcousticGuitar",n[n.TwelveStringGuitar=3]="TwelveStringGuitar",n[n.ElectricGuitar=4]="ElectricGuitar",n[n.Bass=5]="Bass",n[n.ClassicalGuitar=23]="ClassicalGuitar",n[n.UprightBass=6]="UprightBass",n[n.Ukulele=7]="Ukulele",n[n.Banjo=8]="Banjo",n[n.Mandolin=9]="Mandolin",n[n.Piano=10]="Piano",n[n.Synth=12]="Synth",n[n.Strings=11]="Strings",n[n.Brass=13]="Brass",n[n.Reed=14]="Reed",n[n.Woodwind=15]="Woodwind",n[n.Vocal=16]="Vocal",n[n.PitchedIdiophone=17]="PitchedIdiophone",n[n.Fx=21]="Fx",n[n.PercussionKit=18]="PercussionKit",n[n.Idiophone=19]="Idiophone",n[n.Membraphone=20]="Membraphone"})(I||(I={}));class Ca{constructor(){o(this,"lineCount",0);o(this,"name","");o(this,"type","");o(this,"elements",[])}static create(t,e,s,i){const r=new Ca;return r.name=t,r.type=e,r.lineCount=s,r.elements=i,r}}class Ce{constructor(t,e,s,i){o(this,"name");o(this,"type");o(this,"soundbankName");o(this,"articulations");this.name=t,this.type=e,this.soundbankName=s,this.articulations=i}}class K{constructor(t,e,s,i,r,a,l,h){o(this,"name");o(this,"staffLine");o(this,"noteHeads");o(this,"techniqueSymbol");o(this,"techniqueSymbolPlacement");o(this,"inputMidiNumbers");o(this,"outputMidiNumber");o(this,"outputRSESound");this.name=t,this.staffLine=e,this.noteHeads=s,this.techniqueSymbol=i,this.techniqueSymbolPlacement=r,this.inputMidiNumbers=a,this.outputMidiNumber=l,this.outputRSESound=h}static template(t,e,s){return new K(t,0,[],f.None,Je.Outside,e,0,s)}}const Dt=class Dt{static _initLookups(){const t=Dt._drumInstrumentSet,e=new Map,s=new Map;for(const i of t.elements)for(const r of i.articulations)for(const a of r.inputMidiNumbers){const l=`${i.name}.${a}`;e.set(l,i),s.set(l,r)}return Dt._elementByArticulation=e,Dt._articulationsById=s,e}static getIconId(t){return t.primaryChannel===9?I.PercussionKit:Dt._midiProgramInfoLookup.has(t.program)?Dt._midiProgramInfoLookup.get(t.program).icon:I.SteelGuitar}static buildInstrumentSet(t){return t.percussionArticulations.length>0||t.isPercussion?Dt._buildPercussionInstrumentSet(t):Dt._buildPitchedInstrumentSet(t)}static _buildPitchedInstrumentSet(t){const e=new Ca;e.lineCount=t.staves[0].standardNotationLineCount;const s=Dt._midiProgramInfoLookup.has(t.playbackInfo.program)?Dt._midiProgramInfoLookup.get(t.playbackInfo.program):Dt._midiProgramInfoLookup.get(0);e.name=s.instrumentSetName,e.type=s.instrumentSetType;const i=new Ce(Dt._pitchedElement.name,Dt._pitchedElement.type,Dt._pitchedElement.soundbankName,[Dt._pitchedElement.articulations[0]]);return e.elements.push(i),e}static _buildPercussionInstrumentSet(t){Dt._elementByArticulation||Dt._initLookups();const e=new Ca;e.lineCount=t.staves[0].standardNotationLineCount,e.name="Drums",e.type="drumKit";const s=t.percussionArticulations.length>0?t.percussionArticulations:Array.from(jt.instrumentArticulations.values());let i;for(const r of s){const a=new K(r.elementType,r.staffLine,[r.noteHeadDefault,r.noteHeadHalf,r.noteHeadWhole],r.techniqueSymbol,r.techniqueSymbolPlacement,[r.id],r.outputMidiNumber,""),l=r.uniqueId;if(Dt._articulationsById.has(l)){const h=Dt._articulationsById.get(l);a.inputMidiNumbers=h.inputMidiNumbers,a.name=h.name,a.outputRSESound=h.outputRSESound}if(Dt._elementByArticulation.has(l)){const h=Dt._elementByArticulation.get(l);(!i||i.name!==r.elementType)&&(i=new Ce(h.name,h.type,h.soundbankName,[]),e.elements.push(i))}else(!i||i.name!==r.elementType)&&(i=new Ce(r.elementType,r.elementType,"",[]),e.elements.push(i));i.articulations.push(a)}return e}};o(Dt,"_midiProgramInfoLookup",new Map([[0,new O(I.Piano,"Acoustic Piano")],[1,new O(I.Piano,"Acoustic Piano")],[2,new O(I.Piano,"Electric Piano")],[3,new O(I.Piano,"Acoustic Piano")],[4,new O(I.Piano,"Electric Piano")],[5,new O(I.Piano,"Electric Piano")],[6,new O(I.Piano,"Harpsichord")],[7,new O(I.Piano,"Harpsichord")],[8,new O(I.PitchedIdiophone,"Celesta")],[9,new O(I.PitchedIdiophone,"Vibraphone")],[10,new O(I.PitchedIdiophone,"Vibraphone")],[11,new O(I.PitchedIdiophone,"Vibraphone")],[12,new O(I.PitchedIdiophone,"Xylophone")],[13,new O(I.PitchedIdiophone,"Xylophone")],[14,new O(I.PitchedIdiophone,"Vibraphone")],[15,new O(I.Banjo,"Banjo")],[16,new O(I.Piano,"Electric Organ")],[17,new O(I.Piano,"Electric Organ")],[18,new O(I.Piano,"Electric Organ")],[19,new O(I.Piano,"Electric Organ")],[20,new O(I.Piano,"Electric Organ")],[21,new O(I.Piano,"Electric Organ")],[22,new O(I.Woodwind,"Recorder")],[23,new O(I.Piano,"Electric Organ")],[24,new O(I.ClassicalGuitar,"Nylon Guitar")],[25,new O(I.SteelGuitar,"Steel Guitar")],[26,new O(I.SteelGuitar,"Electric Guitar")],[27,new O(I.ElectricGuitar,"Electric Guitar")],[28,new O(I.ElectricGuitar,"Electric Guitar")],[29,new O(I.ElectricGuitar,"Electric Guitar")],[30,new O(I.SteelGuitar,"Electric Guitar")],[31,new O(I.SteelGuitar,"Electric Guitar")],[32,new O(I.Bass,"Acoustic Bass")],[33,new O(I.Bass,"Electric Bass")],[34,new O(I.Bass,"Electric Bass")],[35,new O(I.Bass,"Acoustic Bass")],[36,new O(I.Bass,"Electric Bass")],[37,new O(I.Bass,"Electric Bass")],[38,new O(I.Synth,"Synth Bass")],[39,new O(I.Synth,"Synth Bass")],[40,new O(I.Strings,"Violin")],[41,new O(I.Strings,"Viola")],[42,new O(I.Strings,"Cello")],[43,new O(I.Strings,"Contrabass")],[44,new O(I.Strings,"Violin")],[45,new O(I.Strings,"Violin")],[46,new O(I.Piano,"Harp")],[47,new O(I.Membraphone,"Timpani")],[48,new O(I.Strings,"Violin")],[49,new O(I.Strings,"Violin")],[50,new O(I.Strings,"Violin")],[51,new O(I.Strings,"Violin")],[52,new O(I.Vocal,"Voice")],[53,new O(I.Vocal,"Voice")],[54,new O(I.Vocal,"Voice")],[55,new O(I.Synth,"Pad Synthesizer")],[56,new O(I.Brass,"Trumpet")],[57,new O(I.Brass,"Trombone")],[58,new O(I.Brass,"Tuba")],[59,new O(I.Brass,"Trumpet")],[60,new O(I.Brass,"French Horn")],[61,new O(I.Brass,"Trumpet")],[62,new O(I.Brass,"Trumpet")],[63,new O(I.Brass,"Trumpet")],[64,new O(I.Reed,"Saxophone")],[65,new O(I.Reed,"Saxophone")],[66,new O(I.Reed,"Saxophone")],[67,new O(I.Reed,"Saxophone")],[68,new O(I.Reed,"Oboe")],[69,new O(I.Reed,"English Horn")],[70,new O(I.Reed,"Bassoon")],[71,new O(I.Reed,"Clarinet")],[72,new O(I.Reed,"Piccolo")],[73,new O(I.Woodwind,"Flute")],[74,new O(I.Woodwind,"Recorder")],[75,new O(I.Woodwind,"Flute")],[76,new O(I.Woodwind,"Recorder")],[77,new O(I.Woodwind,"Flute")],[78,new O(I.Woodwind,"Recorder")],[79,new O(I.Woodwind,"Flute")],[80,new O(I.Synth,"Lead Synthesizer")],[81,new O(I.Synth,"Lead Synthesizer")],[82,new O(I.Synth,"Lead Synthesizer")],[83,new O(I.Synth,"Lead Synthesizer")],[84,new O(I.Synth,"Lead Synthesizer")],[85,new O(I.Synth,"Lead Synthesizer")],[86,new O(I.Synth,"Lead Synthesizer")],[87,new O(I.Synth,"Lead Synthesizer")],[88,new O(I.Synth,"Pad Synthesizer")],[89,new O(I.Synth,"Pad Synthesizer")],[90,new O(I.Synth,"Pad Synthesizer")],[91,new O(I.Synth,"Pad Synthesizer")],[92,new O(I.Synth,"Pad Synthesizer")],[93,new O(I.Synth,"Pad Synthesizer")],[94,new O(I.Synth,"Pad Synthesizer")],[95,new O(I.Synth,"Pad Synthesizer")],[96,new O(I.Fx,"Pad Synthesizer")],[97,new O(I.Fx,"Pad Synthesizer")],[98,new O(I.Fx,"Pad Synthesizer")],[99,new O(I.Fx,"Pad Synthesizer")],[100,new O(I.Fx,"Lead Synthesizer")],[101,new O(I.Fx,"Lead Synthesizer")],[102,new O(I.Fx,"Lead Synthesizer")],[103,new O(I.Fx,"Trumpet")],[104,new O(I.ElectricGuitar,"Banjo")],[105,new O(I.Banjo,"Banjo")],[106,new O(I.Ukulele,"Ukulele")],[107,new O(I.Banjo,"Banjo")],[108,new O(I.PitchedIdiophone,"Xylophone")],[109,new O(I.Reed,"Bassoon")],[110,new O(I.Strings,"Violin")],[111,new O(I.Woodwind,"Flute")],[112,new O(I.PitchedIdiophone,"Xylophone")],[113,new O(I.Idiophone,"Celesta")],[114,new O(I.PitchedIdiophone,"Vibraphone")],[115,new O(I.Idiophone,"Xylophone")],[116,new O(I.Membraphone,"Xylophone")],[117,new O(I.Membraphone,"Xylophone")],[118,new O(I.Membraphone,"Xylophone")],[119,new O(I.Idiophone,"Celesta")],[120,new O(I.Fx,"Steel Guitar")],[121,new O(I.Fx,"Recorder")],[122,new O(I.Fx,"Recorder")],[123,new O(I.Fx,"Recorder")],[124,new O(I.Fx,"Recorder")],[125,new O(I.Fx,"Recorder")],[126,new O(I.Fx,"Recorder")],[127,new O(I.Fx,"Timpani")]])),o(Dt,"_drumInstrumentSet",Ca.create("Drums","drumKit",5,[new Ce("Snare","snare","Master-Snare",[K.template("Snare (hit)",[38],"stick.hit.hit"),K.template("Snare (side stick)",[37],"stick.hit.sidestick"),K.template("Snare (rim shot)",[91],"stick.hit.rimshot")]),new Ce("Charley","hiHat","Master-Hihat",[K.template("Hi-Hat (closed)",[42],"stick.hit.closed"),K.template("Hi-Hat (half)",[92],"stick.hit.half"),K.template("Hi-Hat (open)",[46],"stick.hit.open"),K.template("Pedal Hi-Hat (hit)",[44],"pedal.hit.pedal")]),new Ce("Acoustic Kick Drum","kickDrum","AcousticKick-Percu",[K.template("Kick (hit)",[35],"pedal.hit.hit")]),new Ce("Kick Drum","kickDrum","Master-Kick",[K.template("Kick (hit)",[36],"pedal.hit.hit")]),new Ce("Tom Very High","tom","Master-Tom05",[K.template("High Floor Tom (hit)",[50],"stick.hit.hit")]),new Ce("Tom High","tom","Master-Tom04",[K.template("High Tom (hit)",[48],"stick.hit.hit")]),new Ce("Tom Medium","tom","Master-Tom03",[K.template("Mid Tom (hit)",[47],"stick.hit.hit")]),new Ce("Tom Low","tom","Master-Tom02",[K.template("Low Tom (hit)",[45],"stick.hit.hit")]),new Ce("Tom Very Low","tom","Master-Tom01",[K.template("Very Low Tom (hit)",[43],"stick.hit.hit")]),new Ce("Ride","ride","Master-Ride",[K.template("Ride (edge)",[93],"stick.hit.edge"),K.template("Ride (middle)",[51],"stick.hit.mid"),K.template("Ride (bell)",[53],"stick.hit.bell"),K.template("Ride (choke)",[94],"stick.hit.choke")]),new Ce("Splash","splash","Master-Splash",[K.template("Splash (hit)",[55],"stick.hit.hit"),K.template("Splash (choke)",[95],"stick.hit.choke")]),new Ce("China","china","Master-China",[K.template("China (hit)",[52],"stick.hit.hit"),K.template("China (choke)",[96],"stick.hit.choke")]),new Ce("Crash High","crash","Master-Crash02",[K.template("Crash high (hit)",[49],"stick.hit.hit"),K.template("Crash high (choke)",[97],"stick.hit.choke")]),new Ce("Crash Medium","crash","Master-Crash01",[K.template("Crash medium (hit)",[57],"stick.hit.hit"),K.template("Crash medium (choke)",[98],"stick.hit.choke")]),new Ce("Cowbell Low","cowbell","CowbellBig-Percu",[K.template("Cowbell low (hit)",[99],"stick.hit.hit"),K.template("Cowbell low (tip)",[100],"stick.hit.tip")]),new Ce("Cowbell Medium","cowbell","CowbellMid-Percu",[K.template("Cowbell medium (hit)",[56],"stick.hit.hit"),K.template("Cowbell medium (tip)",[101],"stick.hit.tip")]),new Ce("Cowbell High","cowbell","CowbellSmall-Percu",[K.template("Cowbell high (hit)",[102],"stick.hit.hit"),K.template("Cowbell high (tip)",[103],"stick.hit.tip")]),new Ce("Woodblock Low","woodblock","WoodblockLow-Percu",[K.template("Woodblock low (hit)",[77],"stick.hit.hit")]),new Ce("Woodblock High","woodblock","WoodblockHigh-Percu",[K.template("Woodblock high (hit)",[76],"stick.hit.hit")]),new Ce("Bongo High","bongo","BongoHigh-Percu",[K.template("Bongo High (hit)",[60],"hand.hit.hit"),K.template("Bongo High (mute)",[104],"hand.hit.mute"),K.template("Bongo High (slap)",[105],"hand.hit.slap")]),new Ce("Bongo Low","bongo","BongoLow-Percu",[K.template("Bongo Low (hit)",[61],"hand.hit.hit"),K.template("Bongo Low (mute)",[106],"hand.hit.mute"),K.template("Bongo Low (slap)",[107],"hand.hit.slap")]),new Ce("Timbale Low","timbale","TimbaleLow-Percu",[K.template("Timbale low (hit)",[66],"stick.hit.hit")]),new Ce("Timbale High","timbale","TimbaleHigh-Percu",[K.template("Timbale high (hit)",[65],"stick.hit.hit")]),new Ce("Agogo Low","agogo","AgogoLow-Percu",[K.template("Agogo low (hit)",[68],"stick.hit.hit")]),new Ce("Agogo High","agogo","AgogoHigh-Percu",[K.template("Agogo high (hit)",[67],"stick.hit.hit")]),new Ce("Conga Low","conga","CongaLow-Percu",[K.template("Conga low (hit)",[64],"hand.hit.hit"),K.template("Conga low (slap)",[108],"hand.hit.slap"),K.template("Conga low (mute)",[109],"hand.hit.mute")]),new Ce("Conga High","conga","CongaHigh-Percu",[K.template("Conga high (hit)",[63],"hand.hit.hit"),K.template("Conga high (slap)",[110],"hand.hit.slap"),K.template("Conga high (mute)",[62],"hand.hit.mute")]),new Ce("Whistle Low","whistle","WhistleLow-Percu",[K.template("Whistle low (hit)",[72],"blow.hit.hit")]),new Ce("Whistle High","whistle","WhistleHigh-Percu",[K.template("Whistle high (hit)",[71],"blow.hit.hit")]),new Ce("Guiro","guiro","Guiro-Percu",[K.template("Guiro (hit)",[73],"stick.hit.hit"),K.template("Guiro (scrap-return)",[74],"stick.scrape.return")]),new Ce("Surdo","surdo","Surdo-Percu",[K.template("Surdo (hit)",[86],"brush.hit.hit"),K.template("Surdo (mute)",[87],"brush.hit.mute")]),new Ce("Tambourine","tambourine","Tambourine-Percu",[K.template("Tambourine (hit)",[54],"hand.hit.hit"),K.template("Tambourine (return)",[111],"hand.hit.return"),K.template("Tambourine (roll)",[112],"hand.hit.roll"),K.template("Tambourine (hand)",[113],"hand.hit.handhit")]),new Ce("Cuica","cuica","Cuica-Percu",[K.template("Cuica (open)",[79],"hand.hit.hit"),K.template("Cuica (mute)",[78],"hand.hit.mute")]),new Ce("Vibraslap","vibraslap","Vibraslap-Percu",[K.template("Vibraslap (hit)",[58],"hand.hit.hit")]),new Ce("Triangle","triangle","Triangle-Percu",[K.template("Triangle (hit)",[81],"stick.hit.hit"),K.template("Triangle (mute)",[80],"stick.hit.mute")]),new Ce("Grancassa","grancassa","Grancassa-Percu",[K.template("Grancassa (hit)",[114],"mallet.hit.hit")]),new Ce("Piatti","piatti","Piatti-Percu",[K.template("Piatti (hit)",[115],"hand.hit.hit"),K.template("Piatti (hand)",[116],"hand.hit.hit")]),new Ce("Cabasa","cabasa","Cabasa-Percu",[K.template("Cabasa (hit)",[69],"hand.hit.hit"),K.template("Cabasa (return)",[117],"hand.hit.return")]),new Ce("Castanets","castanets","Castanets-Percu",[K.template("Castanets (hit)",[85],"hand.hit.hit")]),new Ce("Claves","claves","Claves-Percu",[K.template("Claves (hit)",[75],"stick.hit.hit")]),new Ce("Left Maraca","maraca","Maracas-Percu",[K.template("Left Maraca (hit)",[70],"hand.hit.hit"),K.template("Left Maraca (return)",[118],"hand.hit.return")]),new Ce("Right Maraca","maraca","Maracas-Percu",[K.template("Right Maraca (hit)",[119],"hand.hit.hit"),K.template("Right Maraca (return)",[120],"hand.hit.return")]),new Ce("Shaker","shaker","ShakerStudio-Percu",[K.template("Shaker (hit)",[82],"hand.hit.hit"),K.template("Shaker (return)",[122],"hand.hit.return")]),new Ce("Bell Tree","bellTree","BellTree-Percu",[K.template("Bell Tree (hit)",[84],"stick.hit.hit"),K.template("Bell Tree (return)",[123],"stick.hit.return")]),new Ce("Jingle Bell","jingleBell","JingleBell-Percu",[K.template("Jingle Bell (hit)",[83],"stick.hit.hit")]),new Ce("Tinkle Bell","jingleBell","JingleBell-Percu",[K.template("Tinkle Bell (hit)",[83],"stick.hit.hit")]),new Ce("Golpe","unpitched","Golpe-Percu",[K.template("Golpe (thumb)",[124],"thumb.hit.body"),K.template("Golpe (finger)",[125],"finger4.hit.body")]),new Ce("Hand Clap","handClap","GroupHandClap-Percu",[K.template("Hand Clap (hit)",[39],"hand.hit.hit")]),new Ce("Electric Snare","snare","ElectricSnare-Percu",[K.template("Electric Snare (hit)",[40],"stick.hit.hit")]),new Ce("Sticks","snare","Stick-Percu",[K.template("Snare (side stick)",[31],"stick.hit.sidestick")]),new Ce("Very Low Floor Tom","tom","LowFloorTom-Percu",[K.template("Low Floor Tom (hit)",[41],"stick.hit.hit")]),new Ce("Ride Cymbal 2","ride","Ride-Percu",[K.template("Ride (edge)",[59],"stick.hit.edge"),K.template("Ride (middle)",[126],"stick.hit.mid"),K.template("Ride (bell)",[127],"stick.hit.bell"),K.template("Ride (choke)",[29],"stick.hit.choke")]),new Ce("Reverse Cymbal","crash","Reverse-Cymbal",[K.template("Reverse Cymbal (hit)",[30],"stick.hit.hit")]),new Ce("Metronome","snare","Metronome-Percu",[K.template("Metronome (hit)",[33],"stick.hit.sidestick"),K.template("Metronome (bell)",[34],"stick.hit.hit")])])),o(Dt,"_elementByArticulation"),o(Dt,"_articulationsById"),o(Dt,"_pitchedElement",new Ce("Pitched","pitched","",[new K("",0,[f.NoteheadBlack,f.NoteheadHalf,f.NoteheadWhole],f.None,Je.Outside,[],0,"")]));let ro=Dt;const _r=class _r{constructor(){o(this,"_rhythmIdLookup",new Map);o(this,"_backingTrackAssetId");o(this,"_backingTrackFramePadding");o(this,"backingTrackAssetFileName")}writeXml(t){const e=new za;return this._rhythmIdLookup=new Map,this._writeDom(e,t),e.toFormattedString("",!0)}_writeDom(t,e){const s=t.addElement("GPIF");s.addElement("GPVersion").innerText="8.1.3";const i=s.addElement("GPRevision");i.attributes.set("required","12024"),i.attributes.set("recommended","13000"),i.innerText="13007";const r=s.addElement("Encoding");r.addElement("EncodingDescription").innerText="GP8";const a=new ei;a.nodeType=gt.Comment,a.value=`Written by alphaTab ${Va.version} (${Va.commit})`,r.addChild(a),this._writeScoreNode(s,e),this._writeMasterTrackNode(s,e),this._writeBackingTrackNode(s,e),this._writeAudioTracksNode(s,e),this._writeTracksNode(s,e),this._writeMasterBarsNode(s,e),this._writeAssets(s,e);const l=s.addElement("Bars"),h=s.addElement("Voices"),c=s.addElement("Beats"),d=s.addElement("Notes"),u=s.addElement("Rhythms");for(const p of e.tracks)for(const g of p.staves)for(const m of g.bars){this._writeBarNode(l,m);for(const y of m.voices){this._writeVoiceNode(h,y);for(const S of y.beats){this._writeBeatNode(c,S,u);for(const k of S.notes)this._writeNoteNode(d,k)}}}}_writeAssets(t,e){var r;if(!((r=e.backingTrack)!=null&&r.rawAudioFile))return;const i=t.addElement("Assets").addElement("Asset");i.attributes.set("id",this._backingTrackAssetId),this.backingTrackAssetFileName="Content/Assets/backing-track",i.addElement("EmbeddedFilePath").setCData(this.backingTrackAssetFileName)}_writeBackingTrackNode(t,e){var l;if(!((l=e.backingTrack)!=null&&l.rawAudioFile))return;const s=t.addElement("BackingTrack"),i="0";this._backingTrackAssetId=i,s.addElement("IconId").innerText="21",s.addElement("Color").innerText="0 0 0",s.addElement("Name").setCData("Audio Track"),s.addElement("ShortName").setCData("a.track"),s.addElement("PlaybackState").innerText="Default",s.addElement("Enabled").innerText="true",s.addElement("Source").innerText="Local",s.addElement("AssetId").innerText=i;const r=s.addElement("ChannelStrip");r.addElement("Parameters").innerText="0.500000 0.500000 0.500000 0.500000 0.500000 0.500000 0.500000 0.500000 0.500000 0.000000 0.500000 0.500000 0.800000 0.500000 0.500000 0.500000",r.addElement("YouTubeVideoUrl").innerText="",r.addElement("Filter").innerText="6",r.addElement("FramesPerPixel").innerText="400";const a=this._backingTrackFramePadding!==void 0?this._backingTrackFramePadding:0;s.addElement("FramePadding").innerText=`${a}`,s.addElement("Semitones").innerText="0",s.addElement("Cents").innerText="0"}_writeNoteNode(t,e){const s=t.addElement("Note");s.attributes.set("id",e.id.toString()),this._writeNoteProperties(s,e),e.isGhost&&(s.addElement("AntiAccent").innerText="normal"),e.isLetRing&&s.addElement("LetRing"),e.isTrill&&(s.addElement("Trill").innerText=e.trillValue.toString());let i=0;switch(e.isStaccato&&(i|=1),e.accentuated){case mt.Normal:i|=8;break;case mt.Heavy:i|=4;break;case mt.Tenuto:i|=16;break}if(i>0&&(s.addElement("Accent").innerText=i.toString()),e.isTieOrigin||e.isTieDestination){const r=s.addElement("Tie");r.attributes.set("origin",e.isTieOrigin?"true":"false"),r.attributes.set("destination",e.isTieDestination?"true":"false")}switch(e.vibrato){case Ee.Slight:s.addElement("Vibrato").innerText="Slight";break;case Ee.Wide:s.addElement("Vibrato").innerText="Wide";break}if(e.isFingering){switch(e.leftHandFinger){case ae.Thumb:s.addElement("LeftFingering").innerText="P";break;case ae.IndexFinger:s.addElement("LeftFingering").innerText="I";break;case ae.MiddleFinger:s.addElement("LeftFingering").innerText="M";break;case ae.AnnularFinger:s.addElement("LeftFingering").innerText="A";break;case ae.LittleFinger:s.addElement("LeftFingering").innerText="C";break}switch(e.rightHandFinger){case ae.Thumb:s.addElement("RightFingering").innerText="P";break;case ae.IndexFinger:s.addElement("RightFingering").innerText="I";break;case ae.MiddleFinger:s.addElement("RightFingering").innerText="M";break;case ae.AnnularFinger:s.addElement("RightFingering").innerText="A";break;case ae.LittleFinger:s.addElement("RightFingering").innerText="C";break}}e.percussionArticulation>=0?s.addElement("InstrumentArticulation").innerText=e.percussionArticulation.toString():s.addElement("InstrumentArticulation").innerText="0",e.ornament!==ut.None&&(s.addElement("Ornament").innerText=ut[e.ornament])}_writeNoteProperties(t,e){const s=t.addElement("Properties");if(this._writeConcertPitch(s,e),this._writeTransposedPitch(s,e),e.isStringed&&(this._writeSimplePropertyNode(s,"String","String",(e.string-1).toString()),this._writeSimplePropertyNode(s,"Fret","Fret",e.fret.toString()),this._writeSimplePropertyNode(s,"Midi","Number",e.realValue.toString()),e.showStringNumber&&this._writeSimplePropertyNode(s,"ShowStringNumber","Enable",null)),e.isPiano&&(this._writeSimplePropertyNode(s,"Octave","Number",e.octave.toString()),this._writeSimplePropertyNode(s,"Tone","Step",e.tone.toString()),this._writeSimplePropertyNode(s,"Midi","Number",e.realValue.toString())),e.beat.tap&&this._writeSimplePropertyNode(s,"Tapped","Enable",null),e.harmonicType!==ie.None){switch(e.harmonicType){case ie.Natural:this._writeSimplePropertyNode(s,"HarmonicType","HType","Natural");break;case ie.Artificial:this._writeSimplePropertyNode(s,"HarmonicType","HType","Artificial");break;case ie.Pinch:this._writeSimplePropertyNode(s,"HarmonicType","HType","Pinch");break;case ie.Tap:this._writeSimplePropertyNode(s,"HarmonicType","HType","Tap");break;case ie.Semi:this._writeSimplePropertyNode(s,"HarmonicType","HType","Semi");break;case ie.Feedback:this._writeSimplePropertyNode(s,"HarmonicType","HType","Feedback");break}e.harmonicValue!==0&&this._writeSimplePropertyNode(s,"HarmonicFret","HFret",e.harmonicValue.toString())}e.isDead&&this._writeSimplePropertyNode(s,"Muted","Enable",null),e.isPalmMute&&this._writeSimplePropertyNode(s,"PalmMuted","Enable",null),e.hasBend&&this._writeBend(s,e),e.isHammerPullOrigin&&this._writeSimplePropertyNode(s,"HopoOrigin","Enable",null),e.isHammerPullDestination&&this._writeSimplePropertyNode(s,"HopoDestination","Enable",null),e.isLeftHandTapped&&this._writeSimplePropertyNode(s,"LeftHandTapped","Enable",null);let i=0;switch(e.slideInType){case Et.IntoFromAbove:i|=32;break;case Et.IntoFromBelow:i|=16;break}switch(e.slideOutType){case ge.Shift:i|=1;break;case ge.Legato:i|=2;break;case ge.OutDown:i|=4;break;case ge.OutUp:i|=8;break;case ge.PickSlideDown:i|=64;break;case ge.PickSlideUp:i|=128;break}i>0&&this._writeSimplePropertyNode(s,"Slide","Flags",i.toString())}_writeTransposedPitch(t,e){e.isPercussion?this._writePitch(t,"ConcertPitch","C","-1",""):this._writePitchForValue(t,"TransposedPitch",e.displayValueWithoutBend,e.accidentalMode,e.beat.voice.bar.keySignature)}_writeConcertPitch(t,e){e.isPercussion?this._writePitch(t,"ConcertPitch","C","-1",""):this._writePitchForValue(t,"ConcertPitch",e.realValueWithoutHarmonic,e.accidentalMode,e.beat.voice.bar.keySignature)}_writePitchForValue(t,e,s,i,r){let a=0,l=0,h="",c="";const d=()=>{switch(a=s%12,l=s/12|0,h=_r._defaultSteps[a],A.computeAccidental(r,de.Default,s,!1)){case he.None:case he.Natural:c="";break;case he.Sharp:c="#";break;case he.Flat:c="b";break;case he.DoubleSharp:c="x";break;case he.DoubleFlat:c="bb";break}};switch(d(),i){case de.Default:break;case de.ForceNone:c="";break;case de.ForceNatural:c="";break;case de.ForceSharp:c="#";break;case de.ForceDoubleSharp:c==="#"&&(s-=2,d()),c="x";break;case de.ForceFlat:c==="#"&&(s+=1,d()),c="b";break;case de.ForceDoubleFlat:c==="#"&&(s+=2,d()),c="bb";break}this._writePitch(t,e,h,l.toString(),c)}_writePitch(t,e,s,i,r){const a=t.addElement("Property");a.attributes.set("name",e);const l=a.addElement("Pitch");l.addElement("Step").innerText=s,l.addElement("Accidental").innerText=r,l.addElement("Octave").innerText=i}_writeBend(t,e){e.hasBend&&e.bendPoints.length<=4&&this._writeStandardBend(t,e.bendPoints)}_writeStandardBend(t,e){this._writeSimplePropertyNode(t,"Bended","Enable",null);const s=e[0],i=e[e.length-1];let r,a;switch(e.length){case 4:r=e[1],a=e[2];break;case 3:r=e[1],a=e[1];break;default:r=new H((s.offset+i.offset)/2,(s.value+i.value)/2),a=r;break}this._writeSimplePropertyNode(t,"BendDestinationOffset","Float",this._toBendOffset(i.offset).toString()),this._writeSimplePropertyNode(t,"BendDestinationValue","Float",this._toBendValue(i.value).toString()),this._writeSimplePropertyNode(t,"BendMiddleOffset1","Float",this._toBendOffset(r.offset).toString()),this._writeSimplePropertyNode(t,"BendMiddleOffset2","Float",this._toBendOffset(a.offset).toString()),this._writeSimplePropertyNode(t,"BendMiddleValue","Float",this._toBendValue(r.value).toString()),this._writeSimplePropertyNode(t,"BendOriginOffset","Float",this._toBendOffset(s.offset).toString()),this._writeSimplePropertyNode(t,"BendOriginValue","Float",this._toBendValue(s.value).toString())}_toBendValue(t){return t*25}_toBendOffset(t){return t/H.MaxPosition*100}_writeBeatNode(t,e,s){const i=t.addElement("Beat");if(i.attributes.set("id",e.id.toString()),i.addElement("Dynamic").innerText=re[e.dynamics],e.fade!==Nt.None&&(i.addElement("Fadding").innerText=Nt[e.fade]),e.isTremolo)switch(e.tremoloPicking.marks){case 1:i.addElement("Tremolo").innerText="1/2";break;case 2:i.addElement("Tremolo").innerText="1/4";break;case 3:i.addElement("Tremolo").innerText="1/8";break}switch(e.hasChord&&i.addElement("Chord").setCData(e.chordId),e.crescendo!==Jt.None&&(i.addElement("Hairpin").innerText=Jt[e.crescendo]),e.brushType){case Y.ArpeggioUp:i.addElement("Arpeggio").innerText="Up";break;case Y.ArpeggioDown:i.addElement("Arpeggio").innerText="Down";break}switch(e.text&&i.addElement("FreeText").setCData(e.text),e.graceType){case ee.OnBeat:case ee.BeforeBeat:i.addElement("GraceNotes").innerText=ee[e.graceType];break}if(e.ottava!==pe.Regular&&(i.addElement("Ottavia").innerText=pe[e.ottava].substr(1)),e.hasWhammyBar&&this._writeWhammyNode(i,e),e.isLegatoOrigin||e.isLegatoDestination){const r=i.addElement("Legato");r.attributes.set("origin",e.isLegatoOrigin?"true":"false"),r.attributes.set("destination",e.isLegatoDestination?"true":"false")}if(this._writeRhythm(i,e,s),e.preferredBeamDirection!==null)switch(e.preferredBeamDirection){case E.Up:i.addElement("TransposedPitchStemOrientation").innerText="Upward",i.addElement("UserTransposedPitchStemOrientation").innerText="Upward";break;case E.Down:i.addElement("TransposedPitchStemOrientation").innerText="Downward",i.addElement("UserTransposedPitchStemOrientation").innerText="Downward";break}i.addElement("ConcertPitchStemOrientation").innerText="Undefined",e.slashed&&i.addElement("Slashed"),e.deadSlapped&&i.addElement("DeadSlapped"),e.notes.length>0&&(i.addElement("Notes").innerText=e.notes.map(r=>r.id).join(" ")),e.golpe!==as.None&&(i.addElement("Golpe").innerText=as[e.golpe]),e.wahPedal!==ps.None&&(i.addElement("Wah").innerText=ps[e.wahPedal]),e.showTimer&&(i.addElement("Timer").innerText=(e.timer??0).toString()),this._writeBeatProperties(i,e),this._writeBeatXProperties(i,e),e.lyrics&&e.lyrics.length>0&&this._writeBeatLyrics(i,e.lyrics)}_writeBeatLyrics(t,e){const s=t.addElement("Lyrics");for(const i of e)s.addElement("Line").setCData(i)}_writeBeatXProperties(t,e){const s=t.addElement("XProperties");switch(e.brushDuration>0&&this._writeSimpleXPropertyNode(s,"687935489","Int",e.brushDuration.toString()),e.beamingMode){case ot.ForceSplitToNext:this._writeSimpleXPropertyNode(s,"1124204546","Int","2");break;case ot.ForceMergeWithNext:this._writeSimpleXPropertyNode(s,"1124204546","Int","1");break;case ot.ForceSplitOnSecondaryToNext:this._writeSimpleXPropertyNode(s,"1124204552","Int","1");break}}_writeBeatProperties(t,e){const s=t.addElement("Properties");switch(e.brushType){case Y.BrushUp:this._writeSimplePropertyNode(s,"Brush","Direction","Up");break;case Y.BrushDown:this._writeSimplePropertyNode(s,"Brush","Direction","Down");break}switch(e.pickStroke){case Ot.Up:this._writeSimplePropertyNode(s,"PickStroke","Direction","Up");break;case Ot.Down:this._writeSimplePropertyNode(s,"PickStroke","Direction","Down");break}switch(e.slap&&this._writeSimplePropertyNode(s,"Slapped","Enable",null),e.pop&&this._writeSimplePropertyNode(s,"Popped","Enable",null),e.vibrato){case Ee.Wide:this._writeSimplePropertyNode(s,"VibratoWTremBar","Strength","Wide");break;case Ee.Slight:this._writeSimplePropertyNode(s,"VibratoWTremBar","Strength","Slight");break}if(e.isBarre)switch(this._writeSimplePropertyNode(s,"BarreFret","Fret",e.barreFret.toString()),e.barreShape){case Hs.Full:this._writeSimplePropertyNode(s,"BarreString","String","0");break;case Hs.Half:this._writeSimplePropertyNode(s,"BarreString","String","1");break}if(e.rasgueado!==le.None){let i="";switch(e.rasgueado){case le.Ii:i="ii_1";break;case le.Mi:i="mi_1";break;case le.MiiTriplet:i="mii_1";break;case le.MiiAnapaest:i="mii_2";break;case le.PmpTriplet:i="pmp_1";break;case le.PmpAnapaest:i="pmp_2";break;case le.PeiTriplet:i="pei_1";break;case le.PeiAnapaest:i="pei_2";break;case le.PaiTriplet:i="pai_1";break;case le.PaiAnapaest:i="pai_2";break;case le.AmiTriplet:i="ami_1";break;case le.AmiAnapaest:i="ami_2";break;case le.Ppp:i="ppp_1";break;case le.Amii:i="amii_1";break;case le.Amip:i="amip_1";break;case le.Eami:i="eami_1";break;case le.Eamii:i="eamii_1";break;case le.Peami:i="peami_1";break}this._writeSimplePropertyNode(s,"Rasgueado","Rasgueado",i)}}_writeRhythm(t,e,s){const i=`${e.duration}_${e.dots}_${e.tupletNumerator}_${e.tupletDenominator}';`;let r;if(this._rhythmIdLookup.has(i))r=this._rhythmIdLookup.get(i);else{r=this._rhythmIdLookup.size.toString(),this._rhythmIdLookup.set(i,r);const a=s.addElement("Rhythm");if(a.attributes.set("id",r),e.hasTuplet){const h=a.addElement("PrimaryTuplet");h.attributes.set("num",e.tupletNumerator.toString()),h.attributes.set("den",e.tupletDenominator.toString())}e.dots>0&&a.addElement("AugmentationDot").attributes.set("count",e.dots.toString());let l="Quarter";switch(e.duration){case b.QuadrupleWhole:l="Long";break;case b.DoubleWhole:l="DoubleWhole";break;case b.Whole:l="Whole";break;case b.Half:l="Half";break;case b.Quarter:l="Quarter";break;case b.Eighth:l="Eighth";break;case b.Sixteenth:l="16th";break;case b.ThirtySecond:l="32nd";break;case b.SixtyFourth:l="64th";break;case b.OneHundredTwentyEighth:l="128th";break;case b.TwoHundredFiftySixth:l="256th";break}a.addElement("NoteValue").innerText=l}t.addElement("Rhythm").attributes.set("ref",r)}_writeWhammyNode(t,e){e.hasWhammyBar&&e.whammyBarPoints.length<=4&&this._writeStandardWhammy(t,e.whammyBarPoints)}_writeStandardWhammy(t,e){const s=t.addElement("Whammy"),i=e[0],r=e[e.length-1];let a,l;switch(e.length){case 4:a=e[1],l=e[2];break;case 3:a=e[1],l=e[1];break;default:a=new H((i.offset+r.offset)/2,(i.value+r.value)/2),l=a;break}s.attributes.set("destinationOffset",this._toBendOffset(r.offset).toString()),s.attributes.set("destinationValue",this._toBendValue(r.value).toString()),s.attributes.set("middleOffset1",this._toBendOffset(a.offset).toString()),s.attributes.set("middleOffset2",this._toBendOffset(l.offset).toString()),s.attributes.set("middleValue",this._toBendValue(a.value).toString()),s.attributes.set("originOffset",this._toBendOffset(i.offset).toString()),s.attributes.set("originValue",this._toBendValue(i.value).toString())}_writeScoreNode(t,e){const s=t.addElement("Score");s.addElement("Title").setCData(e.title),s.addElement("SubTitle").setCData(e.subTitle),s.addElement("Artist").setCData(e.artist),s.addElement("Album").setCData(e.album),s.addElement("Words").setCData(e.words),s.addElement("Music").setCData(e.music),s.addElement("WordsAndMusic").setCData(e.words===e.music?e.words:""),s.addElement("Copyright").setCData(e.copyright),s.addElement("Tabber").setCData(e.tab),s.addElement("Instructions").setCData(e.instructions),s.addElement("Notices").setCData(e.notices),s.addElement("FirstPageHeader").setCData(""),s.addElement("FirstPageFooter").setCData(""),s.addElement("PageHeader").setCData(""),s.addElement("PageFooter").setCData(""),s.addElement("ScoreSystemsDefaultLayout").setCData(e.defaultSystemsLayout.toString()),s.addElement("ScoreSystemsLayout").setCData(e.systemsLayout.join(" ")),s.addElement("ScoreZoomPolicy").innerText="Value",s.addElement("ScoreZoom").innerText="1",s.addElement("MultiVoice").innerText="1>"}_writeMasterTrackNode(t,e){const s=t.addElement("MasterTrack");s.addElement("Tracks").innerText=e.tracks.map(h=>h.index).join(" ");const i=s.addElement("Automations");if(e.masterBars.length>0&&e.masterBars[0].isAnacrusis&&s.addElement("Anacrusis"),e.masterBars[0].tempoAutomations.length===0){const h=i.addElement("Automation");h.addElement("Type").innerText="Tempo",h.addElement("Linear").innerText="false",h.addElement("Bar").innerText="0",h.addElement("Position").innerText="0",h.addElement("Visible").innerText="true",h.addElement("Value").innerText=`${e.tempo} 2`,e.tempoLabel&&(h.addElement("Text").innerText=e.tempoLabel)}const r=e.masterBars[0].syncPoints?e.masterBars[0].syncPoints.find(h=>h.ratioPosition===0&&h.syncPointValue.barOccurence===0):void 0,a=r?r.syncPointValue.millisecondOffset:0;this._backingTrackFramePadding=-1*(a/1e3*_r._sampleRate)|0;const l=new Kr(()=>Bi.buildModifiedTempoLookup(e));for(const h of e.masterBars){for(const c of h.tempoAutomations){const d=i.addElement("Automation");d.addElement("Type").innerText="Tempo",d.addElement("Linear").innerText=c.isLinear?"true":"false",d.addElement("Bar").innerText=h.index.toString(),d.addElement("Position").innerText=c.ratioPosition.toString(),d.addElement("Visible").innerText=c.isVisible?"true":"false",d.addElement("Value").innerText=`${c.value} 2`,c.text&&(d.addElement("Text").innerText=c.text)}if(h.syncPoints)for(const c of h.syncPoints){const d=i.addElement("Automation");d.addElement("Type").innerText="SyncPoint",d.addElement("Linear").innerText="false",d.addElement("Bar").innerText=h.index.toString(),d.addElement("Position").innerText=c.ratioPosition.toString(),d.addElement("Visible").innerText=c.isVisible?"true":"false";const u=d.addElement("Value");u.addElement("BarIndex").innerText=h.index.toString(),u.addElement("BarOccurrence").innerText=c.syncPointValue.barOccurence.toString(),u.addElement("ModifiedTempo").innerText=l.value.get(c).syncBpm.toString(),u.addElement("OriginalTempo").innerText=e.tempo.toString();let p=(c.syncPointValue.millisecondOffset-a)/1e3*_r._sampleRate;p=Math.floor(p+.5),u.addElement("FrameOffset").innerText=p.toString()}}}_writeAudioTracksNode(t,e){t.addElement("AudioTracks")}_writeTracksNode(t,e){const s=t.addElement("Tracks");for(const i of e.tracks)this._writeTrackNode(s,i)}_writeTrackNode(t,e){const s=t.addElement("Track");s.attributes.set("id",e.index.toString()),s.addElement("Name").setCData(e.name),s.addElement("ShortName").setCData(e.shortName),s.addElement("Color").innerText=`${e.color.r} ${e.color.g} ${e.color.b}`,s.addElement("SystemsDefautLayout").innerText=e.defaultSystemsLayout.toString(),s.addElement("SystemsLayout").innerText=e.systemsLayout.join(" "),s.addElement("AutoBrush"),s.addElement("PalmMute").innerText="0",s.addElement("PlayingStyle").innerText=ui.isGuitar(e.playbackInfo.program)?"StringedPick":"Default",s.addElement("UseOneChannelPerString"),s.addElement("IconId").innerText=ro.getIconId(e.playbackInfo).toString(),this._writeInstrumentSetNode(s,e),this._writeTransposeNode(s,e),this._writeRseNode(s,e),s.addElement("ForcedSound").innerText="-1",this._writeMidiConnectionNode(s,e),e.playbackInfo.isSolo?s.addElement("PlaybackState").innerText="Solo":e.playbackInfo.isMute?s.addElement("PlaybackState").innerText="Mute":s.addElement("PlaybackState").innerText="Default",s.addElement("AudioEngineState").innerText="MIDI",this._writeLyricsNode(s,e),this._writeStavesNode(s,e),this._writeSoundsAndAutomations(s,e)}_writeSoundAndAutomation(t,e,s,i,r,a,l,h,c=0){const d=t.addElement("Sound");d.addElement("Name").setCData(s),d.addElement("Label").setCData(s),d.addElement("Path").setCData(i),d.addElement("Role").setCData(r);const u=d.addElement("MIDI"),p=ui.bankToLsbMsb(h);u.addElement("LSB").innerText=p[0].toString(),u.addElement("MSB").innerText=p[1].toString(),u.addElement("Program").innerText=l.toString();const g=e.addElement("Automation");g.addElement("Type").innerText="Sound",g.addElement("Linear").innerText="false",g.addElement("Bar").innerText=a.toString(),g.addElement("Position").innerText=c.toString(),g.addElement("Visible").innerText="true",g.addElement("Value").setCData(`${i};${s};${r}`)}_writeSoundsAndAutomations(t,e){const s=t.addElement("Sounds"),i=t.addElement("Automations");if(e.staves.length>0&&e.staves[0].bars.length>0){const r=`Track_${e.index}_Initial`,a=`Midi/${e.playbackInfo.program}`,l="Factory";let h=!1,c=e.playbackInfo.bank;for(const d of e.staves)for(const u of d.bars)for(const p of u.voices)for(const g of p.beats){const m=g.getAutomation(Ve.Instrument),y=u.index===0&&g.index===0,S=g.getAutomation(Ve.Bank);if(S&&(c=S.value),m){const k=y?r:`ProgramChange_${g.id}`,T=y?a:`Midi/${m.value}`,N=y?l:"User";!y&&!h&&(this._writeSoundAndAutomation(s,i,r,a,l,e.staves[0].bars[0].index,e.playbackInfo.program,e.playbackInfo.bank),h=!0),this._writeSoundAndAutomation(s,i,k,T,N,u.index,m.value,c,m.ratioPosition),y&&(h=!0)}}}for(const r of e.staves)for(const a of r.bars)for(const l of a.sustainPedals)if(l.pedalType!==lt.Hold){const h=i.addElement("Automation");switch(h.addElement("Type").innerText="SustainPedal",h.addElement("Linear").innerText="false",h.addElement("Bar").innerText=a.index.toString(),h.addElement("Position").innerText=l.ratioPosition.toString(),h.addElement("Visible").innerText="true",l.pedalType){case lt.Down:h.addElement("Value").innerText="0 1";break;case lt.Up:h.addElement("Value").innerText="0 3";break}}}_writeMidiConnectionNode(t,e){const s=t.addElement("MidiConnection");s.addElement("Port").innerText=e.playbackInfo.port.toString(),s.addElement("PrimaryChannel").innerText=e.playbackInfo.primaryChannel.toString(),s.addElement("SecondaryChannel").innerText=e.playbackInfo.secondaryChannel.toString(),s.addElement("ForeOneChannelPerString").innerText="false"}_writeRseNode(t,e){const i=t.addElement("RSE").addElement("ChannelStrip");i.attributes.set("version","E56");const r=i.addElement("Parameters");r.innerText=`0.5 0.5 0.5 0.5 0.5 0.5 0.5 0.5 0.5 1 0.5 ${e.playbackInfo.balance/16} ${e.playbackInfo.volume/16} 0.5 0.5 0.5`}_writeStavesNode(t,e){const s=t.addElement("Staves");for(const i of e.staves)this._writeStaffNode(s,i)}_writeStaffNode(t,e){const i=t.addElement("Staff").addElement("Properties");if(this._writeSimplePropertyNode(i,"CapoFret","Fret",e.capo.toString()),this._writeSimplePropertyNode(i,"FretCount","Fret","24"),e.tuning.length>0){const r=i.addElement("Property");switch(r.attributes.set("name","Tuning"),r.addElement("Pitches").innerText=e.tuning.slice().reverse().join(" "),r.addElement("Label").setCData(e.tuningName),r.addElement("LabelVisible").innerText=e.tuningName?"true":"false",r.addElement("Flat"),e.tuning.length){case 3:r.addElement("Instrument").innerText="Shamisen";break;case 4:e.track.playbackInfo.program===105?r.addElement("Instrument").innerText="Banjo":e.track.playbackInfo.program===42?r.addElement("Instrument").innerText="Cello":e.track.playbackInfo.program===43?r.addElement("Instrument").innerText="Contrabass":e.track.playbackInfo.program===40?r.addElement("Instrument").innerText="Violin":e.track.playbackInfo.program===41?r.addElement("Instrument").innerText="Viola":r.addElement("Instrument").innerText="Bass";break;case 5:e.track.playbackInfo.program===105?r.addElement("Instrument").innerText="Banjo":r.addElement("Instrument").innerText="Bass";break;case 6:e.track.playbackInfo.program===105?r.addElement("Instrument").innerText="Banjo":e.track.playbackInfo.program<=39?r.addElement("Instrument").innerText="Bass":r.addElement("Instrument").innerText="Guitar";break;case 7:e.track.playbackInfo.program<=39?r.addElement("Instrument").innerText="Bass":r.addElement("Instrument").innerText="Guitar";break;default:r.addElement("Instrument").innerText="Guitar";break}}this._writeSimplePropertyNode(i,"PartialCapoFret","Fret","0"),this._writeSimplePropertyNode(i,"PartialCapoStringFlags","Bitset",e.tuning.map(r=>"0").join("")),this._writeSimplePropertyNode(i,"TuningFlat","Enable",null),this._writeDiagramCollection(i,e,"DiagramCollection"),this._writeDiagramCollection(i,e,"DiagramWorkingSet")}_writeDiagramCollection(t,e,s){const i=t.addElement("Property");i.attributes.set("name",s);const r=i.addElement("Items"),a=e.chords;if(a)for(const[l,h]of a){const c=r.addElement("Item");c.attributes.set("id",l),c.attributes.set("name",h.name);const d=c.addElement("Diagram");d.attributes.set("stringCount",h.strings.length.toString()),d.attributes.set("fretCount","5"),d.attributes.set("baseFret",(h.firstFret-1).toString()),d.attributes.set("barStates",h.strings.map(U=>"1").join(" "));const u=[],p=new Map;for(let U=0;U<h.strings.length;U++){const x=h.strings[U];if(x!==-1){const j=d.addElement("Fret"),Q=h.strings.length-1-U;j.attributes.set("string",Q.toString()),j.attributes.set("fret",(x-h.firstFret+1).toString()),p.has(x)||(p.set(x,[]),u.push(x)),p.get(x).push(Q)}}u.sort();const g=d.addElement("Fingering");if(h.barreFrets.length>0){const U=[ae.LittleFinger,ae.AnnularFinger,ae.MiddleFinger,ae.IndexFinger];for(const x of u){const j=p.get(x);if(j.length>1&&h.barreFrets.indexOf(x)>=0){const Q=U.length>0?U.pop():ae.IndexFinger;for(const Te of j){const te=g.addElement("Position");switch(Q){case ae.LittleFinger:te.attributes.set("finger","Pinky");break;case ae.AnnularFinger:te.attributes.set("finger","Ring");break;case ae.MiddleFinger:te.attributes.set("finger","Middle");break;case ae.IndexFinger:te.attributes.set("finger","Index");break}te.attributes.set("fret",(x-h.firstFret+1).toString()),te.attributes.set("string",Te.toString())}}}}const m=d.addElement("Property");m.attributes.set("name","ShowName"),m.attributes.set("type","bool"),m.attributes.set("value",h.showName?"true":"false");const y=d.addElement("Property");y.attributes.set("name","ShowDiagram"),y.attributes.set("type","bool"),y.attributes.set("value",h.showDiagram?"true":"false");const S=d.addElement("Property");S.attributes.set("name","ShowFingering"),S.attributes.set("type","bool"),S.attributes.set("value",h.showFingering?"true":"false");const k=d.addElement("Chord"),T=k.addElement("KeyNote");T.attributes.set("step","C"),T.attributes.set("accidental","Natural");const N=k.addElement("BassNote");N.attributes.set("step","C"),N.attributes.set("accidental","Natural");const F=k.addElement("Degree");F.attributes.set("interval","Third"),F.attributes.set("alteration","Major"),F.attributes.set("omitted","false");const q=k.addElement("Degree");q.attributes.set("interval","Fifth"),q.attributes.set("alteration","Perfect"),q.attributes.set("omitted","false")}}_writeSimplePropertyNode(t,e,s,i){const r=t.addElement("Property");r.attributes.set("name",e);const a=r.addElement(s);return i!==null&&(a.innerText=i),r}_writeSimpleXPropertyNode(t,e,s,i){const r=t.addElement("XProperty");r.attributes.set("id",e);const a=r.addElement(s);return i!==null&&(a.innerText=i),r}_writeLyricsNode(t,e){const s=t.addElement("Lyrics");s.attributes.set("dispatched","true");const i=[];for(const r of e.staves[0].bars)for(const a of r.voices)if(!a.isEmpty){for(const l of a.beats)if(l.lyrics)for(let h=0;h<l.lyrics.length;h++){for(;h>=i.length;){const d=new hr;d.startBar=r.index,d.text="[Empty]",i.push(d)}const c=i[h];c.text=c.text==="[Empty]"?l.lyrics[h]:`${c.text} ${l.lyrics[h].split(" ").join("+")}`}}for(let r=0;r<i.length;r++){const a=s.addElement("Line");a.addElement("Text").setCData(i[r].text),a.addElement("Offset").innerText=i[r].startBar.toString()}}_writeTransposeNode(t,e){const s=t.addElement("Transpose"),i=Math.floor(e.staves[0].displayTranspositionPitch/12),r=e.staves[0].displayTranspositionPitch-i*12;s.addElement("Chromatic").innerText=r.toString(),s.addElement("Octave").innerText=i.toString()}_writeInstrumentSetNode(t,e){const s=ro.buildInstrumentSet(e),i=t.addElement("InstrumentSet");i.addElement("Name").innerText=s.name,i.addElement("Type").innerText=s.type,i.addElement("LineCount").innerText=s.lineCount.toString();const r=i.addElement("Elements");for(const a of s.elements){const l=r.addElement("Element");l.addElement("Name").innerText=a.name,l.addElement("Type").innerText=a.type,l.addElement("SoundbankName").innerText=a.soundbankName;const h=l.addElement("Articulations");for(const c of a.articulations){const d=h.addElement("Articulation");switch(d.addElement("Name").innerText=c.name,d.addElement("StaffLine").innerText=c.staffLine.toString(),d.addElement("Noteheads").innerText=[this._mapMusicSymbol(c.noteHeads[0]),this._mapMusicSymbol(c.noteHeads[1]),this._mapMusicSymbol(c.noteHeads[2])].join(" "),c.techniqueSymbolPlacement){case Je.Below:d.addElement("TechniquePlacement").innerText="below";break;case Je.Outside:d.addElement("TechniquePlacement").innerText="outside";break;case Je.Inside:d.addElement("TechniquePlacement").innerText="inside";break;case Je.Above:d.addElement("TechniquePlacement").innerText="above";break}d.addElement("TechniqueSymbol").innerText=this._mapMusicSymbol(c.techniqueSymbol),d.addElement("InputMidiNumbers").innerText=c.inputMidiNumbers.map(u=>u.toString()).join(" "),d.addElement("OutputRSESound").innerText=c.outputRSESound,d.addElement("OutputMidiNumber").innerText=c.outputMidiNumber.toString()}}}_mapMusicSymbol(t){if(t===f.None)return"";const e=f[t];return e.substring(0,1).toLowerCase()+e.substring(1)}_writeMasterBarsNode(t,e){const s=t.addElement("MasterBars");for(const i of e.masterBars)this._writeMasterBarNode(s,i)}_writeMasterBarNode(t,e){const s=t.addElement("MasterBar"),i=s.addElement("Key");let r=e.score.tracks[0].staves[0].bars[e.index].keySignature;const a=e.score.tracks[0].staves[0].bars[e.index].keySignatureType,l=A.flooredDivision(e.score.tracks[0].staves[0].displayTranspositionPitch,12);r=A.transposeKey(r,-l),i.addElement("AccidentalCount").innerText=r.toString(),i.addElement("Mode").innerText=cs[a],i.addElement("Sharps").innerText="Sharps",s.addElement("Time").innerText=`${e.timeSignatureNumerator}/${e.timeSignatureDenominator}`,e.actualBeamingRules&&this._writeBarXProperties(s,e),e.isFreeTime&&s.addElement("FreeTime");const h=[];for(const c of e.score.tracks)for(const d of c.staves)h.push(d.bars[e.index].id.toString());if(s.addElement("Bars").innerText=h.join(" "),e.isDoubleBar&&s.addElement("DoubleBar"),e.isSectionStart){const c=s.addElement("Section");c.addElement("Letter").setCData(e.section.marker),c.addElement("Text").setCData(e.section.text)}if(e.isRepeatStart||e.isRepeatEnd){const c=s.addElement("Repeat");c.attributes.set("start",e.isRepeatStart?"true":"false"),c.attributes.set("end",e.isRepeatEnd?"true":"false"),e.isRepeatEnd&&c.attributes.set("count",e.repeatCount.toString())}if(e.alternateEndings>0){let c=e.alternateEndings;const d=[];let u=0;for(;c>0;)(c>>u&1)===1&&(d.push(u+1),c&=~(1<<u)),u++;s.addElement("AlternateEndings").innerText=d.join(" ")}if(e.tripletFeel!==Me.NoTripletFeel&&(s.addElement("TripletFeel").innerText=Me[e.tripletFeel]),e.directions&&e.directions.size>0){const c=s.addElement("Directions");for(const d of e.directions)switch(d){case G.TargetFine:c.addElement("Target").innerText="Fine";break;case G.TargetSegno:c.addElement("Target").innerText="Segno";break;case G.TargetSegnoSegno:c.addElement("Target").innerText="SegnoSegno";break;case G.TargetCoda:c.addElement("Target").innerText="Coda";break;case G.TargetDoubleCoda:c.addElement("Target").innerText="DoubleCoda";break;case G.JumpDaCapo:c.addElement("Jump").innerText="DaCapo";break;case G.JumpDaCapoAlCoda:c.addElement("Jump").innerText="DaCapoAlCoda";break;case G.JumpDaCapoAlDoubleCoda:c.addElement("Jump").innerText="DaCapoAlDoubleCoda";break;case G.JumpDaCapoAlFine:c.addElement("Jump").innerText="DaCapoAlFine";break;case G.JumpDalSegno:c.addElement("Jump").innerText="DaSegno";break;case G.JumpDalSegnoAlCoda:c.addElement("Jump").innerText="DaSegnoAlCoda";break;case G.JumpDalSegnoAlDoubleCoda:c.addElement("Jump").innerText="DaSegnoAlDoubleCoda";break;case G.JumpDalSegnoAlFine:c.addElement("Jump").innerText="DaSegnoAlFine";break;case G.JumpDalSegnoSegno:c.addElement("Jump").innerText="DaSegnoSegno";break;case G.JumpDalSegnoSegnoAlCoda:c.addElement("Jump").innerText="DaSegnoSegnoAlCoda";break;case G.JumpDalSegnoSegnoAlDoubleCoda:c.addElement("Jump").innerText="DaSegnoSegnoAlDoubleCoda";break;case G.JumpDalSegnoSegnoAlFine:c.addElement("Jump").innerText="DaSegnoSegnoAlFine";break;case G.JumpDaCoda:c.addElement("Jump").innerText="DaCoda";break;case G.JumpDaDoubleCoda:c.addElement("Jump").innerText="DaDoubleCoda";break}}this._writeFermatas(s,e)}_writeBarXProperties(t,e){const s=t.addElement("XProperties"),i=e.actualBeamingRules;if(i){const r=i.findRule(b.Eighth);let a=r[0],l=1;r[0]===b.Quarter&&(a=8,l=2),this._writeSimpleXPropertyNode(s,"1124139010","Int",a.toString());const h=1124139264;let c=0;for(;c<r[1].length;)this._writeSimpleXPropertyNode(s,(h+c).toString(),"Int",(r[1][c]*l).toString()),c++}}_writeFermatas(t,e){var i;const s=((i=e.fermata)==null?void 0:i.size)??0;if(s!==0&&s>0){const r=t.addElement("Fermatas");for(const[a,l]of e.fermata)this._writeFermata(r,a,l)}}_writeFermata(t,e,s){let i=-1,r=1;if(e>0)for(;r<10&&(i=e/D.QuarterTime*r,i!==Math.floor(i));)i=-1,r++;else i=0,r=1;if(i===-1)return;const a=t.addElement("Fermata");a.addElement("Type").innerText=Ss[s.type],a.addElement("Length").innerText=s.length.toString(),a.addElement("Offset").innerText=`${i}/${r}`}_writeBarNode(t,e){const s=t.addElement("Bar");s.attributes.set("id",e.id.toString()),s.addElement("Voices").innerText=e.voices.map(i=>i.isEmpty?"-1":i.id.toString()).join(" "),s.addElement("Clef").innerText=Fe[e.clef],e.clefOttava!==pe.Regular&&(s.addElement("Ottavia").innerText=pe[e.clefOttava].substr(1)),e.simileMark!==At.None&&(s.addElement("SimileMark").innerText=At[e.simileMark])}_writeVoiceNode(t,e){if(e.isEmpty)return;const s=t.addElement("Voice");s.attributes.set("id",e.id.toString()),s.addElement("Beats").innerText=e.beats.map(i=>i.id).join(" ")}};o(_r,"_sampleRate",44100),o(_r,"_defaultSteps",["C","C","D","D","E","F","F","G","G","A","A","B"]);let Dl=_r;const tr=class tr{constructor(){o(this,"_checkValue",tr._crcInit);this.reset()}static _buildCrc32Lookup(){const e=new Uint32Array(256);for(let s=0;s<e.length;s++){let i=s;for(let r=0;r<8;r++)i=(i&1)===1?i>>>1^3988292384:i>>>1;e[s]=i}return e}get value(){return~this._checkValue}update(t,e,s){for(let i=0;i<s;i++)this._checkValue=tr._crc32Lookup[(this._checkValue^t[e+i])&255]^this._checkValue>>>8}reset(){this._checkValue=tr._crcInit}};o(tr,"_crc32Lookup",tr._buildCrc32Lookup()),o(tr,"_crcInit",4294967295);let ao=tr;const xt=class xt{};o(xt,"maxWbits",15),o(xt,"wsize",1<<xt.maxWbits),o(xt,"wmask",xt.wsize-1),o(xt,"minMatch",3),o(xt,"maxMatch",258),o(xt,"defaultMemLevel",8),o(xt,"pendingBufSize",1<<xt.defaultMemLevel+8),o(xt,"hashBits",xt.defaultMemLevel+7),o(xt,"hashSize",1<<xt.hashBits),o(xt,"hashShift",(xt.hashBits+xt.minMatch-1)/xt.minMatch),o(xt,"hashMask",xt.hashSize-1),o(xt,"minLookahead",xt.maxMatch+xt.minMatch+1),o(xt,"maxDist",xt.wsize-xt.minLookahead);let Ge=xt;const ni=class ni{constructor(t,e,s,i){o(this,"freqs");o(this,"length",null);o(this,"minNumCodes");o(this,"numCodes",0);o(this,"_codes",null);o(this,"_bitLengthCounts");o(this,"_maxLength");o(this,"_huffman");this._huffman=t,this.minNumCodes=s,this._maxLength=i,this.freqs=new Int16Array(e),this._bitLengthCounts=new Int32Array(i)}reset(){for(let t=0;t<this.freqs.length;t++)this.freqs[t]=0;this._codes=null,this.length=null}buildTree(){const t=this.freqs.length,e=new Int32Array(t);let s=0,i=0;for(let c=0;c<t;c++){const d=this.freqs[c];if(d!==0){let u=s++;for(;u>0;){const p=Math.floor((u-1)/2);if(this.freqs[e[p]]>d)e[u]=e[p],u=p;else break}e[u]=c,i=c}}for(;s<2;){const c=i<2?++i:0;e[s++]=c}this.numCodes=Math.max(i+1,this.minNumCodes);const r=s,a=new Int32Array(4*s-2),l=new Int32Array(2*s-1);let h=r;for(let c=0;c<s;c++){const d=e[c];a[2*c]=d,a[2*c+1]=-1,l[c]=this.freqs[d]<<8,e[c]=c}do{const c=e[0];let d=e[--s],u=0,p=1;for(;p<s;)p+1<s&&l[e[p]]>l[e[p+1]]&&p++,e[u]=e[p],u=p,p=p*2+1;let g=l[d];for(;p=u,u>0;)if(u=Math.floor((p-1)/2),l[e[u]]>g)e[p]=e[u];else break;e[p]=d;const m=e[0];d=h++,a[2*d]=c,a[2*d+1]=m;const y=Math.min(l[c]&255,l[m]&255);for(g=l[c]+l[m]-y+1,l[d]=g,u=0,p=1;p<s;)p+1<s&&l[e[p]]>l[e[p+1]]&&p++,e[u]=e[p],u=p,p=u*2+1;for(;p=u,p>0;)if(u=Math.floor((p-1)/2),l[e[u]]>g)e[p]=e[u];else break;e[p]=d}while(s>1);this._buildLength(a)}_buildLength(t){this.length=new Uint8Array(this.freqs.length);const e=Math.floor(t.length/2),s=Math.floor((e+1)/2);let i=0;for(let h=0;h<this._maxLength;h++)this._bitLengthCounts[h]=0;const r=new Int32Array(e);r[e-1]=0;for(let h=e-1;h>=0;h--)if(t[2*h+1]!==-1){let c=r[h]+1;c>this._maxLength&&(c=this._maxLength,i++),r[t[2*h]]=c,r[t[2*h+1]]=c}else{const c=r[h];this._bitLengthCounts[c-1]++,this.length[t[2*h]]=r[h]}if(i===0)return;let a=this._maxLength-1;do{for(;this._bitLengthCounts[--a]===0;);do this._bitLengthCounts[a]--,this._bitLengthCounts[++a]++,i-=1<<this._maxLength-1-a;while(i>0&&a<this._maxLength-1)}while(i>0);this._bitLengthCounts[this._maxLength-1]+=i,this._bitLengthCounts[this._maxLength-2]-=i;let l=2*s;for(let h=this._maxLength;h!==0;h--){let c=this._bitLengthCounts[h-1];for(;c>0;){const d=2*t[l++];t[d+1]===-1&&(this.length[t[d]]=h,c--)}}}getEncodedLength(){let t=0;for(let e=0;e<this.freqs.length;e++)t+=this.freqs[e]*this.length[e];return t}calcBLFreq(t){let e,s,i,r=-1,a=0;for(;a<this.numCodes;){i=1;const l=this.length[a];for(l===0?(e=138,s=3):(e=6,s=3,r!==l&&(t.freqs[l]++,i=0)),r=l,a++;a<this.numCodes&&r===this.length[a]&&(a++,!(++i>=e)););i<s?t.freqs[r]+=i:r!==0?t.freqs[ni._repeat3To6]++:i<=10?t.freqs[ni._repeat3To10]++:t.freqs[ni._repeat11To138]++}}setStaticCodes(t,e){this._codes=t,this.length=e}buildCodes(){const t=new Int32Array(this._maxLength);let e=0;this._codes=new Int16Array(this.freqs.length);for(let s=0;s<this._maxLength;s++)t[s]=e,e+=this._bitLengthCounts[s]<<15-s;for(let s=0;s<this.numCodes;s++){const i=this.length[s];i>0&&(this._codes[s]=Za.bitReverse(t[i-1]),t[i-1]+=1<<16-i)}}writeTree(t){let e,s,i,r=-1,a=0;for(;a<this.numCodes;){i=1;const l=this.length[a];for(l===0?(e=138,s=3):(e=6,s=3,r!==l&&(t.writeSymbol(l),i=0)),r=l,a++;a<this.numCodes&&r===this.length[a]&&(a++,!(++i>=e)););if(i<s)for(;i-- >0;)t.writeSymbol(r);else r!==0?(t.writeSymbol(ni._repeat3To6),this._huffman.pending.writeBits(i-3,2)):i<=10?(t.writeSymbol(ni._repeat3To10),this._huffman.pending.writeBits(i-3,3)):(t.writeSymbol(ni._repeat11To138),this._huffman.pending.writeBits(i-11,7))}}writeSymbol(t){this._huffman.pending.writeBits(this._codes[t]&65535,this.length[t])}};o(ni,"_repeat3To6",16),o(ni,"_repeat3To10",17),o(ni,"_repeat11To138",18);let Ea=ni;const be=class be{constructor(t){o(this,"pending");o(this,"_literalTree");o(this,"_distTree");o(this,"_blTree");o(this,"_dBuf");o(this,"_lBuf");o(this,"_lastLit",0);o(this,"_extraBits",0);this.pending=t,this._literalTree=new Ea(this,be._literalNum,257,15),this._distTree=new Ea(this,be._distNum,1,15),this._blTree=new Ea(this,be._bitLenNum,4,7),this._dBuf=new Int16Array(be._bufSize),this._lBuf=new Uint8Array(be._bufSize)}static staticInit(){let t=0;for(;t<144;)be._staticLCodes[t]=be.bitReverse(48+t<<8),be._staticLLength[t++]=8;for(;t<256;)be._staticLCodes[t]=be.bitReverse(256+t<<7),be._staticLLength[t++]=9;for(;t<280;)be._staticLCodes[t]=be.bitReverse(-256+t<<9),be._staticLLength[t++]=7;for(;t<be._literalNum;)be._staticLCodes[t]=be.bitReverse(-88+t<<8),be._staticLLength[t++]=8;for(t=0;t<be._distNum;t++)be._staticDCodes[t]=be.bitReverse(t<<11),be._staticDLength[t]=5}static bitReverse(t){return be._bit4Reverse[t&15]<<12|be._bit4Reverse[t>>4&15]<<8|be._bit4Reverse[t>>8&15]<<4|be._bit4Reverse[t>>12]}isFull(){return this._lastLit>=be._bufSize}reset(){this._lastLit=0,this._extraBits=0,this._literalTree.reset(),this._distTree.reset(),this._blTree.reset()}flushStoredBlock(t,e,s,i){this.pending.writeBits((be.storedBlock<<1)+(i?1:0),3),this.pending.alignToByte(),this.pending.writeShort(s),this.pending.writeShort(~s),this.pending.writeBlock(t,e,s),this.reset()}flushBlock(t,e,s,i){this._literalTree.freqs[be._eofSymbol]++,this._literalTree.buildTree(),this._distTree.buildTree(),this._literalTree.calcBLFreq(this._blTree),this._distTree.calcBLFreq(this._blTree),this._blTree.buildTree();let r=4;for(let h=18;h>r;h--)this._blTree.length[be._blOrder[h]]>0&&(r=h+1);let a=14+r*3+this._blTree.getEncodedLength()+this._literalTree.getEncodedLength()+this._distTree.getEncodedLength()+this._extraBits,l=this._extraBits;for(let h=0;h<be._literalNum;h++)l+=this._literalTree.freqs[h]*be._staticLLength[h];for(let h=0;h<be._distNum;h++)l+=this._distTree.freqs[h]*be._staticDLength[h];a>=l&&(a=l),e>=0&&s+4<a>>3?this.flushStoredBlock(t,e,s,i):a===l?(this.pending.writeBits((be.staticTrees<<1)+(i?1:0),3),this._literalTree.setStaticCodes(be._staticLCodes,be._staticLLength),this._distTree.setStaticCodes(be._staticDCodes,be._staticDLength),this.compressBlock(),this.reset()):(this.pending.writeBits((be.dynTrees<<1)+(i?1:0),3),this.sendAllTrees(r),this.compressBlock(),this.reset())}sendAllTrees(t){this._blTree.buildCodes(),this._literalTree.buildCodes(),this._distTree.buildCodes(),this.pending.writeBits(this._literalTree.numCodes-257,5),this.pending.writeBits(this._distTree.numCodes-1,5),this.pending.writeBits(t-4,4);for(let e=0;e<t;e++)this.pending.writeBits(this._blTree.length[be._blOrder[e]],3);this._literalTree.writeTree(this._blTree),this._distTree.writeTree(this._blTree)}compressBlock(){for(let t=0;t<this._lastLit;t++){const e=this._lBuf[t]&255;let s=this._dBuf[t];if(s--!==0){const i=be._lCode(e);this._literalTree.writeSymbol(i);let r=Math.floor((i-261)/4);r>0&&r<=5&&this.pending.writeBits(e&(1<<r)-1,r);const a=be._dCode(s);this._distTree.writeSymbol(a),r=Math.floor(a/2)-1,r>0&&this.pending.writeBits(s&(1<<r)-1,r)}else this._literalTree.writeSymbol(e)}this._literalTree.writeSymbol(be._eofSymbol)}tallyDist(t,e){this._dBuf[this._lastLit]=t,this._lBuf[this._lastLit++]=e-3;const s=be._lCode(e-3);this._literalTree.freqs[s]++,s>=265&&s<285&&(this._extraBits+=Math.floor((s-261)/4));const i=be._dCode(t-1);return this._distTree.freqs[i]++,i>=4&&(this._extraBits+=Math.floor(i/2)-1),this.isFull()}tallyLit(t){return this._dBuf[this._lastLit]=0,this._lBuf[this._lastLit++]=t,this._literalTree.freqs[t]++,this.isFull()}static _lCode(t){if(t===255)return 285;let e=257;for(;t>=8;)e+=4,t=t>>1;return e+t}static _dCode(t){let e=0;for(;t>=4;)e+=2,t=t>>1;return e+t}};o(be,"_bufSize",1<<Ge.defaultMemLevel+6),o(be,"_literalNum",286),o(be,"storedBlock",0),o(be,"staticTrees",1),o(be,"dynTrees",2),o(be,"_distNum",30),o(be,"_staticLCodes",new Int16Array(be._literalNum)),o(be,"_staticLLength",new Uint8Array(be._literalNum)),o(be,"_staticDCodes",new Int16Array(be._distNum)),o(be,"_staticDLength",new Uint8Array(be._distNum)),o(be,"_blOrder",[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),o(be,"_bit4Reverse",new Uint8Array([0,8,4,12,2,10,6,14,1,9,5,13,3,11,7,15])),o(be,"_bitLenNum",19),o(be,"_eofSymbol",256);let Za=be;Za.staticInit();const mo=class mo{constructor(t){o(this,"_blockStart");o(this,"_maxChain",128);o(this,"_niceLength",128);o(this,"_goodLength",8);o(this,"_insertHashIndex",0);o(this,"_strstart");o(this,"_window");o(this,"_head");o(this,"_prev");o(this,"_lookahead",0);o(this,"_inputBuf",null);o(this,"_inputOff",0);o(this,"_inputEnd",0);o(this,"_prevAvailable",!1);o(this,"_matchStart",0);o(this,"_matchLen",0);o(this,"_pending");o(this,"_huffman");o(this,"inputCrc");this._pending=t,this._huffman=new Za(t),this.inputCrc=new ao,this._window=new Uint8Array(2*Ge.wsize),this._head=new Int16Array(Ge.hashSize),this._prev=new Int16Array(Ge.wsize),this._blockStart=1,this._strstart=1}reset(){this._huffman.reset(),this.inputCrc.reset(),this._blockStart=1,this._strstart=1,this._lookahead=0,this._prevAvailable=!1,this._matchLen=Ge.minMatch-1;for(let t=0;t<Ge.hashSize;t++)this._head[t]=0;for(let t=0;t<Ge.wsize;t++)this._prev[t]=0}_updateHash(){this._insertHashIndex=this._window[this._strstart]<<Ge.hashShift^this._window[this._strstart+1]}needsInput(){return this._inputEnd===this._inputOff}setInput(t,e,s){const i=e+s;this._inputBuf=t,this._inputOff=e,this._inputEnd=i}deflate(t,e){let s;do{this.fillWindow();const i=t&&this._inputOff===this._inputEnd;s=this._deflateSlow(i,e)}while(this._pending.isFlushed&&s);return s}_deflateSlow(t,e){if(this._lookahead<Ge.minLookahead&&!t)return!1;for(;this._lookahead>=Ge.minLookahead||t;){if(this._lookahead===0)return this._prevAvailable&&this._huffman.tallyLit(this._window[this._strstart-1]&255),this._prevAvailable=!1,this._huffman.flushBlock(this._window,this._blockStart,this._strstart-this._blockStart,e),this._blockStart=this._strstart,!1;this._strstart>=2*Ge.wsize-Ge.minLookahead&&this._slideWindow();const s=this._matchStart;let i=this._matchLen;if(this._lookahead>=Ge.minMatch){const r=this._insertString();r!==0&&this._strstart-r<=Ge.maxDist&&this._findLongestMatch(r)&&this._matchLen===Ge.minMatch&&this._strstart-this._matchStart>mo._tooFar&&(this._matchLen=Ge.minMatch-1)}if(i>=Ge.minMatch&&this._matchLen<=i){this._huffman.tallyDist(this._strstart-1-s,i),i-=2;do this._strstart++,this._lookahead--,this._lookahead>=Ge.minMatch&&this._insertString();while(--i>0);this._strstart++,this._lookahead--,this._prevAvailable=!1,this._matchLen=Ge.minMatch-1}else this._prevAvailable&&this._huffman.tallyLit(this._window[this._strstart-1]&255),this._prevAvailable=!0,this._strstart++,this._lookahead--;if(this._huffman.isFull()){let r=this._strstart-this._blockStart;this._prevAvailable&&r--;const a=e&&this._lookahead===0&&!this._prevAvailable;return this._huffman.flushBlock(this._window,this._blockStart,r,a),this._blockStart+=r,!a}}return!0}_findLongestMatch(t){let e,s=this._strstart;const i=s+Math.min(Ge.maxMatch,this._lookahead)-1,r=Math.max(s-Ge.maxDist,0),a=this._window,l=this._prev;let h=this._maxChain;const c=Math.min(this._niceLength,this._lookahead);if(this._matchLen=Math.max(this._matchLen,Ge.minMatch-1),s+this._matchLen>i)return!1;let d=a[s+this._matchLen-1],u=a[s+this._matchLen];this._matchLen>=this._goodLength&&(h>>=2);do if(e=t,s=this._strstart,!(a[e+this._matchLen]!==u||a[e+this._matchLen-1]!==d||a[e]!==a[s]||a[++e]!==a[++s])){switch((i-s)%8){case 1:if(a[++s]===a[++e])break;break;case 2:if(a[++s]===a[++e]&&a[++s]===a[++e])break;break;case 3:if(a[++s]===a[++e]&&a[++s]===a[++e]&&a[++s]===a[++e])break;break;case 4:if(a[++s]===a[++e]&&a[++s]===a[++e]&&a[++s]===a[++e]&&a[++s]===a[++e])break;break;case 5:if(a[++s]===a[++e]&&a[++s]===a[++e]&&a[++s]===a[++e]&&a[++s]===a[++e]&&a[++s]===a[++e])break;break;case 6:if(a[++s]===a[++e]&&a[++s]===a[++e]&&a[++s]===a[++e]&&a[++s]===a[++e]&&a[++s]===a[++e]&&a[++s]===a[++e])break;break;case 7:if(a[++s]===a[++e]&&a[++s]===a[++e]&&a[++s]===a[++e]&&a[++s]===a[++e]&&a[++s]===a[++e]&&a[++s]===a[++e]&&a[++s]===a[++e])break;break}if(a[s]===a[e])do if(s===i){++s,++e;break}while(a[++s]===a[++e]&&a[++s]===a[++e]&&a[++s]===a[++e]&&a[++s]===a[++e]&&a[++s]===a[++e]&&a[++s]===a[++e]&&a[++s]===a[++e]&&a[++s]===a[++e]);if(s-this._strstart>this._matchLen){if(this._matchStart=t,this._matchLen=s-this._strstart,this._matchLen>=c)break;d=a[s-1],u=a[s]}t=l[t&Ge.wmask]&65535}while(t>r&&--h!==0);return this._matchLen>=Ge.minMatch}_insertString(){const t=(this._insertHashIndex<<Ge.hashShift^this._window[this._strstart+(Ge.minMatch-1)])&Ge.hashMask,e=this._head[t];return this._prev[this._strstart&Ge.wmask]=e,this._head[t]=this._strstart,this._insertHashIndex=t,e&65535}fillWindow(){if(this._strstart>=Ge.wsize+Ge.maxDist&&this._slideWindow(),this._lookahead<Ge.minLookahead&&this._inputOff<this._inputEnd){let t=2*Ge.wsize-this._lookahead-this._strstart;t>this._inputEnd-this._inputOff&&(t=this._inputEnd-this._inputOff),this._window.set(this._inputBuf.subarray(this._inputOff,this._inputOff+t),this._strstart+this._lookahead),this.inputCrc.update(this._inputBuf,this._inputOff,t),this._inputOff+=t,this._lookahead+=t}this._lookahead>=Ge.minMatch&&this._updateHash()}_slideWindow(){this._window.set(this._window.subarray(Ge.wsize,Ge.wsize+Ge.wsize),0),this._matchStart-=Ge.wsize,this._strstart-=Ge.wsize,this._blockStart-=Ge.wsize;for(let t=0;t<Ge.hashSize;++t){const e=this._head[t]&65535;this._head[t]=e>=Ge.wsize?e-Ge.wsize:0}for(let t=0;t<Ge.wsize;t++){const e=this._prev[t]&65535;this._prev[t]=e>=Ge.wsize?e-Ge.wsize:0}}};o(mo,"_tooFar",4096);let Ll=mo;class Np{constructor(t){o(this,"_buffer");o(this,"_start",0);o(this,"_end",0);o(this,"_bits",0);o(this,"bitCount",0);this._buffer=new Uint8Array(t)}get isFlushed(){return this._end===0}reset(){this._start=0,this._end=0,this.bitCount=0}writeShortMSB(t){this._buffer[this._end++]=t>>8&255,this._buffer[this._end++]=t&255}writeShort(t){this._buffer[this._end++]=t,this._buffer[this._end++]=t>>8}writeBlock(t,e,s){this._buffer.set(t.subarray(e,e+s),this._end),this._end+=s}flush(t,e,s){return this.bitCount>=8&&(this._buffer[this._end++]=this._bits&255,this._bits>>=8,this.bitCount-=8),s>this._end-this._start?(s=this._end-this._start,t.set(this._buffer.subarray(this._start,this._start+s),e),this._start=0,this._end=0):(t.set(this._buffer.subarray(this._start,this._start+s),e),this._start+=s),s}writeBits(t,e){this._bits|=t<<this.bitCount,this.bitCount+=e,this.bitCount>=16&&(this._buffer[this._end++]=this._bits&255,this._buffer[this._end++]=this._bits>>8&255,this._bits>>=16,this.bitCount-=16)}alignToByte(){this.bitCount>0&&(this._buffer[this._end++]=this._bits&255,this.bitCount>8&&(this._buffer[this._end++]=this._bits>>8&255)),this._bits=0,this.bitCount=0}}const is=class is{constructor(){o(this,"_state",0);o(this,"_pending");o(this,"_engine");this._pending=new Np(Ge.pendingBufSize),this._engine=new Ll(this._pending),this.reset()}get inputCrc(){return this._engine.inputCrc.value}get isNeedingInput(){return this._engine.needsInput()}get isFinished(){return this._state===is._finishedState&&this._pending.isFlushed}reset(){this._state=is._busyState,this._pending.reset(),this._engine.reset()}setInput(t,e,s){this._engine.setInput(t,e,s)}deflate(t,e,s){const i=s;for(;;){const r=this._pending.flush(t,e,s);if(e+=r,s-=r,s===0||this._state===is._finishedState)break;if(!this._engine.deflate((this._state&is._isFlushing)!==0,(this._state&is.isFinishing)!==0))switch(this._state){case is._busyState:return i-s;case is._flushingState:let a=8+(-this._pending.bitCount&7);for(;a>0;)this._pending.writeBits(2,10),a-=10;this._state=is._busyState;break;case is._finishingState:this._pending.alignToByte(),this._state=is._finishedState;break}}return i-s}finish(){this._state|=is._isFlushing|is.isFinishing}};o(is,"_isFlushing",4),o(is,"isFinishing",8),o(is,"_busyState",16),o(is,"_flushingState",20),o(is,"_finishingState",28),o(is,"_finishedState",30);let Ml=is;class Pp{constructor(t,e,s,i,r){o(this,"entry");o(this,"localHeaderOffset");o(this,"compressedSize");o(this,"crc32");o(this,"compressionMode");this.entry=t,this.crc32=e,this.localHeaderOffset=s,this.compressionMode=i,this.compressedSize=r}}class Cp{constructor(t){o(this,"_data");o(this,"_centralDirectoryHeaders",[]);o(this,"_deflater",new Ml);this._data=t}writeEntry(t){const e=Zt.CompressionMethodDeflate,s=wt.empty(),i=this._compress(s,t.data,e),r=s.toArray(),a=new Pp(t,i,this._data.bytesWritten,e,s.length);this._centralDirectoryHeaders.push(a),w.writeInt32LE(this._data,Zt.LocalFileHeaderSignature),w.writeUInt16LE(this._data,10),w.writeUInt16LE(this._data,2048),w.writeUInt16LE(this._data,e),w.writeInt16LE(this._data,0),w.writeInt16LE(this._data,0),w.writeInt32LE(this._data,i),w.writeInt32LE(this._data,r.length),w.writeInt32LE(this._data,t.data.length),w.writeInt16LE(this._data,t.fullName.length),w.writeInt16LE(this._data,0);const l=w.stringToBytes(t.fullName);this._data.write(l,0,l.length),this._data.write(r,0,r.length)}_compress(t,e,s){if(s!==Zt.CompressionMethodDeflate){const r=new ao;return r.update(e,0,e.length),t.write(e,0,e.length),r.value}const i=new Uint8Array(512);for(this._deflater.reset(),this._deflater.setInput(e,0,e.length);!this._deflater.isNeedingInput;){const r=this._deflater.deflate(i,0,i.length);if(r<=0)break;t.write(i,0,r)}for(this._deflater.finish();!this._deflater.isFinished;){const r=this._deflater.deflate(i,0,i.length);if(r<=0)break;t.write(i,0,r)}return this._deflater.inputCrc}end(){const t=this._data.bytesWritten;for(const s of this._centralDirectoryHeaders)this._writeCentralDirectoryHeader(s);const e=this._data.bytesWritten;this._writeEndOfCentralDirectoryRecord(t,e)}_writeEndOfCentralDirectoryRecord(t,e){w.writeInt32LE(this._data,Zt.EndOfCentralDirSignature),w.writeInt16LE(this._data,0),w.writeInt16LE(this._data,0),w.writeInt16LE(this._data,this._centralDirectoryHeaders.length),w.writeInt16LE(this._data,this._centralDirectoryHeaders.length),w.writeInt32LE(this._data,e-t),w.writeInt32LE(this._data,t),w.writeInt16LE(this._data,0)}_writeCentralDirectoryHeader(t){w.writeInt32LE(this._data,Zt.CentralFileHeaderSignature),w.writeUInt16LE(this._data,10),w.writeUInt16LE(this._data,10),w.writeUInt16LE(this._data,2048),w.writeUInt16LE(this._data,t.compressionMode),w.writeInt16LE(this._data,0),w.writeInt16LE(this._data,0),w.writeInt32LE(this._data,t.crc32),w.writeInt32LE(this._data,t.compressedSize),w.writeInt32LE(this._data,t.entry.data.length),w.writeInt16LE(this._data,t.entry.fullName.length),w.writeInt16LE(this._data,0),w.writeInt16LE(this._data,0),w.writeInt16LE(this._data,0),w.writeInt16LE(this._data,0),w.writeInt32LE(this._data,0),w.writeInt32LE(this._data,t.localHeaderOffset);const e=w.stringToBytes(t.entry.fullName);this._data.write(e,0,e.length)}}class Ep extends Nh{get name(){return"Guitar Pro 7-8"}writeScore(t){L.debug(this.name,"Writing data entries");const e=new Dl,s=e.writeXml(t),i=Ls.writeForScore(t),r=Ul.writeForScore(t),a=zl.writeForScore(t);L.debug(this.name,"Writing ZIP entries");const l=new Cp(this.data);l.writeEntry(new Zt("VERSION",w.stringToBytes("7.0"))),l.writeEntry(new Zt("Content/",new Uint8Array(0))),l.writeEntry(new Zt("Content/BinaryStylesheet",i)),l.writeEntry(new Zt("Content/PartConfiguration",r)),l.writeEntry(new Zt("Content/LayoutConfiguration",a)),l.writeEntry(new Zt("Content/score.gpif",w.stringToBytes(s))),e.backingTrackAssetFileName&&l.writeEntry(new Zt(e.backingTrackAssetFileName,t.backingTrack.rawAudioFile)),l.end()}}const Rp=Object.freeze(Object.defineProperty({__proto__:null,AlphaTexExporter:xp,Gp7Exporter:Ep,ScoreExporter:Nh},Symbol.toStringTag,{value:"Module"}));class vo extends yi{constructor(){super(0,0,We.EndOfTrack)}writeTo(t){throw new Xe(ze.General,"Deprecated event, serialization not supported")}}var no;(function(n){n[n.SequenceNumber=0]="SequenceNumber",n[n.TextEvent=1]="TextEvent",n[n.CopyrightNotice=2]="CopyrightNotice",n[n.SequenceOrTrackName=3]="SequenceOrTrackName",n[n.InstrumentName=4]="InstrumentName",n[n.LyricText=5]="LyricText",n[n.MarkerText=6]="MarkerText",n[n.CuePoint=7]="CuePoint",n[n.PatchName=8]="PatchName",n[n.PortName=9]="PortName",n[n.MidiChannel=32]="MidiChannel",n[n.MidiPort=33]="MidiPort",n[n.EndOfTrack=47]="EndOfTrack",n[n.Tempo=81]="Tempo",n[n.SmpteOffset=84]="SmpteOffset",n[n.TimeSignature=88]="TimeSignature",n[n.KeySignature=89]="KeySignature",n[n.SequencerSpecific=127]="SequencerSpecific"})(no||(no={}));class Ph extends vo{get metaStatus(){return no.EndOfTrack}}class vp extends Ph{constructor(){super(...arguments);o(this,"data",new Uint8Array)}}class Dp extends Ph{constructor(){super(...arguments);o(this,"value",0)}}class Lp extends vo{constructor(){super(...arguments);o(this,"noteKey",0);o(this,"pitch",0)}}var Fl;(function(n){n[n.SystemExclusive=240]="SystemExclusive",n[n.MtcQuarterFrame=241]="MtcQuarterFrame",n[n.SongPosition=242]="SongPosition",n[n.SongSelect=243]="SongSelect",n[n.TuneRequest=246]="TuneRequest",n[n.SystemExclusive2=247]="SystemExclusive2"})(Fl||(Fl={}));class Xc extends vo{}var Al;(function(n){n[n.MetronomeTick=0]="MetronomeTick",n[n.Rest=1]="Rest"})(Al||(Al={}));class $c extends Xc{constructor(){super(...arguments);o(this,"data",new Uint8Array)}get isMetronome(){return!1}get metronomeNumerator(){return-1}get metronomeDurationInTicks(){return-1}get metronomeDurationInMilliseconds(){return-1}get isRest(){return!1}get manufacturerId(){return 0}}o($c,"AlphaTabManufacturerId",125);const Op=Object.freeze(Object.defineProperty({__proto__:null,AlphaSynthMidiFileHandler:si,AlphaTabMetronomeEvent:Jl,AlphaTabRestEvent:ql,AlphaTabSysExEvent:Dr,get AlphaTabSystemExclusiveEvents(){return Al},BeatTickLookup:zs,BeatTickLookupItem:Cc,ControlChangeEvent:jl,get ControllerType(){return at},DeprecatedMidiEvent:vo,EndOfTrackEvent:rh,MasterBarTickLookup:gh,MasterBarTickLookupTempoChange:da,MetaDataEvent:vp,MetaEvent:Ph,get MetaEventType(){return no},MetaNumberEvent:Dp,Midi20PerNotePitchBendEvent:Lp,MidiEvent:yi,get MidiEventType(){return We},MidiFile:xi,get MidiFileFormat(){return vr},MidiFileGenerator:Bi,MidiTickLookup:vc,MidiTickLookupFindBeatResult:Ec,get MidiTickLookupFindBeatResultCursorMode(){return Ts},MidiTrack:Xl,NoteBendEvent:ih,NoteEvent:Ql,NoteOffEvent:Zl,NoteOnEvent:Kl,PitchBendEvent:sh,ProgramChangeEvent:eh,SystemCommonEvent:Xc,get SystemCommonType(){return Fl},SystemExclusiveEvent:$c,TempoChangeEvent:th,TimeSignatureEvent:$l},Symbol.toStringTag,{value:"Module"})),Wp=Object.freeze(Object.defineProperty({__proto__:null,get AccentuationType(){return mt},get AccidentalType(){return he},Automation:nt,get AutomationType(){return Ve},BackingTrack:Gl,Bar:qs,get BarLineStyle(){return Be},get BarNumberDisplay(){return Vt},BarStyle:fc,get BarSubElement(){return Ae},get BarreShape(){return Hs},BeamingRules:dt,Beat:qt,get BeatBeamingMode(){return ot},BeatStyle:yc,get BeatSubElement(){return ht},BendPoint:H,get BendStyle(){return tt},get BendType(){return J},get BracketExtendMode(){return nr},get BrushType(){return Y},Chord:Yi,get Clef(){return Fe},Color:qe,get CrescendoType(){return Jt},get Direction(){return G},get Duration(){return b},get DynamicValue(){return re},ElementStyle:Mr,get FadeType(){return Nt},Fermata:ra,get FermataType(){return Ss},get Fingers(){return ae},Font:Ye,get FontStyle(){return st},get FontWeight(){return bs},get GolpeType(){return as},GraceGroup:fn,get GraceType(){return ee},get HarmonicType(){return ie},HeaderFooterStyle:Bs,InstrumentArticulation:$,JsonConverter:Lt,get KeySignature(){return Ke},get KeySignatureType(){return cs},Lyrics:hr,MasterBar:ii,get MusicFontSymbol(){return f},Note:Ps,get NoteAccidentalMode(){return de},get NoteOrnament(){return ut},NoteStyle:Il,get NoteSubElement(){return ns},get Ottavia(){return pe},get PickStroke(){return Ot},PlaybackInformation:Ol,get Rasgueado(){return le},RenderStylesheet:pc,RepeatGroup:Ho,Score:gi,ScoreStyle:Ui,get ScoreSubElement(){return V},Section:aa,get SimileMark(){return At},get SlideInType(){return Et},get SlideOutType(){return ge},Staff:cr,SustainPedalMarker:Vi,get SustainPedalMarkerType(){return lt},SyncPointData:ja,get TechniqueSymbolPlacement(){return Je},Track:Ei,get TrackNameMode(){return ls},get TrackNameOrientation(){return hs},get TrackNamePolicy(){return Tt},TrackStyle:_c,get TrackSubElement(){return fi},TremoloPickingEffect:Ns,get TremoloPickingStyle(){return zi},get TripletFeel(){return Me},Tuning:Vs,TupletGroup:pn,get VibratoType(){return Ee},Voice:Fs,VoiceStyle:gc,get VoiceSubElement(){return Zr},get WahPedal(){return ps},get WhammyType(){return De}},Symbol.toStringTag,{value:"Module"})),Vp=Object.freeze(Object.defineProperty({__proto__:null,BarBounds:ch,get BeamDirection(){return E},BeatBounds:dh,Bounds:Pt,BoundsLookup:ws,MasterBarBounds:uh,NoteBounds:na,RenderFinishedEventArgs:Hi,ScoreRenderer:Gr,StaffSystemBounds:fh},Symbol.toStringTag,{value:"Module"})),Hp=Object.freeze(Object.defineProperty({__proto__:null,CssFontSvgCanvas:Mc,Cursors:Zn,FontSizeDefinition:ml,FontSizes:Lr,MeasuredText:en,SvgCanvas:ko,get TextAlign(){return X},get TextBaseline(){return Ue}},Symbol.toStringTag,{value:"Module"})),Gp=Object.freeze(Object.defineProperty({__proto__:null,ActiveBeatsChangedEventArgs:yl,AlphaSynth:Pc,AlphaSynthAudioWorkletOutput:kc,AlphaSynthBase:lh,AlphaSynthScriptProcessorOutput:Lc,AlphaSynthWebAudioOutputBase:Ri,AlphaSynthWebWorkerApi:un,AudioExportChunk:Nc,AudioExportOptions:xc,BackingTrackSyncPoint:Wr,CircularSampleBuffer:Yl,MidiEventsPlayedEventArgs:oh,PlaybackRange:Kn,PlaybackRangeChangedEventArgs:jr,get PlayerState(){return Ut},PlayerStateChangedEventArgs:Br,PositionChangedEventArgs:ci},Symbol.toStringTag,{value:"Module"})),Up=Object.freeze(Object.defineProperty({__proto__:null},Symbol.toStringTag,{value:"Module"}));/*!
 * alphaTab v1.8.1 (, build 30)
 *
 * Copyright © 2026, Daniel Kuschny and Contributors, All rights reserved.
 *
 * This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at http://mozilla.org/MPL/2.0/.
 *
 * Integrated Libraries:
 *
 * Library: TinySoundFont
 * License: MIT
 * Copyright: Copyright (C) 2017, 2018 Bernhard Schelling
 * URL: https://github.com/schellingb/TinySoundFont
 * Purpose: SoundFont loading and Audio Synthesis
 *
 * Library: SFZero
 * License: MIT
 * Copyright: Copyright (C) 2012 Steve Folta ()
 * URL: https://github.com/stevefolta/SFZero
 * Purpose: TinySoundFont is based on SFZEro
 *
 * Library: Haxe Standard Library
 * License: MIT
 * Copyright: Copyright (C)2005-2025 Haxe Foundation
 * URL: https://github.com/HaxeFoundation/haxe/tree/development/std
 * Purpose: XML Parser & Zip Inflate Algorithm
 *
 * Library: SharpZipLib
 * License: MIT
 * Copyright: Copyright © 2000-2018 SharpZipLib Contributors
 * URL: https://github.com/icsharpcode/SharpZipLib
 * Purpose: Zip Deflate Algorithm for writing compressed Zips
 *
 * Library: NVorbis
 * License: MIT
 * Copyright: Copyright (c) 2020 Andrew Ward
 * URL: https://github.com/NVorbis/NVorbis
 * Purpose: Vorbis Stream Decoding
 *
 * Library: libvorbis
 * License: BSD-3-Clause
 * Copyright: Copyright (c) 2002-2020 Xiph.org Foundation
 * URL: https://github.com/xiph/vorbis
 * Purpose: NVorbis adopted some code from libvorbis.
 *
 * @preserve
 * @license
 */fe.isRunningInWorker?fe.initializeWorker():fe.isRunningInAudioWorklet?fe.initializeAudioWorklet():fe.initializeMain(n=>{if(fe.webPlatform===xs.NodeJs)throw new Xe(ze.General,"Workers not yet supported in Node.js");if(fe.webPlatform===xs.BrowserModule||fe.isWebPackBundled||fe.isViteBundled){L.debug("AlphaTab","Creating webworker");try{return new fe.alphaTabWorker(new fe.alphaTabUrl("./alphaTab.worker.mjs",import.meta.url),{type:"module"})}catch(e){L.debug("AlphaTab","ESM webworker construction with direct URL failed",e)}let t="";try{t=new fe.alphaTabUrl("./alphaTab.worker.mjs",import.meta.url);const e=`import ${JSON.stringify(t)}`,s=new Blob([e],{type:"application/javascript"});return new Worker(URL.createObjectURL(s),{type:"module"})}catch(e){L.debug("AlphaTab","ESM webworker construction with blob import failed",t,e)}try{if(!n.core.scriptFile)throw new Error("Could not detect alphaTab script file");t=n.core.scriptFile;const e=`import ${JSON.stringify(n.core.scriptFile)}`,s=new Blob([e],{type:"application/javascript"});return new Worker(URL.createObjectURL(s),{type:"module"})}catch(e){L.debug("AlphaTab","ESM webworker construction with blob import failed",n.core.scriptFile,e)}}if(!n.core.scriptFile)throw new Xe(ze.General,"Could not detect alphaTab script file, cannot initialize renderer");try{L.debug("AlphaTab","Creating Blob worker");const t=`importScripts('${n.core.scriptFile}')`,e=new Blob([t],{type:"application/javascript"});return new Worker(URL.createObjectURL(e))}catch{return L.warning("Rendering","Could not create inline worker, fallback to normal worker"),new Worker(n.core.scriptFile)}},(n,t)=>{if(fe.webPlatform===xs.NodeJs)throw new Xe(ze.General,"Audio Worklets not yet supported in Node.js");return fe.webPlatform===xs.BrowserModule||fe.isWebPackBundled||fe.isViteBundled?(L.debug("AlphaTab","Creating Module worklet"),n.audioWorklet.addModule(new fe.alphaTabUrl("./alphaTab.worklet.mjs",import.meta.url))):(L.debug("AlphaTab","Creating Script worklet"),n.audioWorklet.addModule(t.core.scriptFile))});export{yh as AlphaTabApi,Bu as AlphaTabApiBase,Xe as AlphaTabError,ze as AlphaTabErrorType,Vo as ConsoleLogger,Yc as CoreSettings,qd as DisplaySettings,Ze as EngravingSettings,qn as EngravingStemInfo,fe as Environment,eu as ExporterSettings,pr as FileLoadError,di as FingeringMode,ti as FontFileFormat,Kt as FormatError,jd as ImporterSettings,Ti as LayoutMode,oi as LogLevel,L as Logger,v as NotationElement,Xt as NotationMode,Wo as NotationSettings,fs as PlayerMode,Ya as PlayerOutputMode,Zd as PlayerSettings,Pu as ProgressEventArgs,Oo as RenderEngineFactory,gl as RenderingResources,Gh as ResizeEventArgs,hi as ScrollMode,vi as Settings,Kd as SlidePlaybackSettings,Wi as StaveProfile,ta as SystemsLayoutMode,Xs as TabRhythmMode,Qd as VibratoPlaybackSettings,xs as WebPlatform,Rp as exporter,Ap as importer,Ip as io,Up as json,Va as meta,Op as midi,Wp as model,Hp as platform,Vp as rendering,Gp as synth};
